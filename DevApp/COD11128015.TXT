OBJECT Codeunit 11128015 LB Management
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVSE6.00.01,4PSSE.PE6;
  }
  PROPERTIES
  {
    Permissions=TableData 25=rimd;
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      Vendor@1070000 : Record 23;
      BA006@1070004 : TextConst 'ENU=Code for Bank of Sweden is missing for line item %1, Vendor %2, %3, %4';
      BA007@1070003 : TextConst 'ENU=%1 for Vendor Ledger Entry and %2 in journal for outgoing Payment Journal \must be the  same for %3 %4. The amount should be %5.';
      BA008@1070002 : TextConst 'ENU=%1 %2 already exist in %3 %4';
      BA009@1070005 : TextConst 'ENU=Only 9 files per day can be sent to PG';
      CompanyInfo@1070006 : Record 79;
      BA011@1070012 : TextConst 'ENU=The value for the parameter is too long for the function %1. The value is %2.';
      PPS@1070021 : Record 312;
      Currency@1070023 : Record 4;
      CurrencyExchangeRate@1070073 : Record 330;
      f@1070013 : File;
      BA017@1070014 : TextConst 'ENU=The length for %1 is %2 long, %3 characters are maximum';
      PostGiroNo@1070040 : Code[20];
      PostGiroCustNo@1070041 : Code[20];
      RegNo@1070047 : Code[20];
      TotalAmount@1070017 : Decimal;
      NoOfLines@1070018 : Integer;
      FirstTime@1070020 : Boolean;
      BA018@1070022 : TextConst 'ENU=Due Date for information can not be\Blank or Before today''s date';
      BA019@1070026 : TextConst 'ENU=It is only possible to have 9999 vendors for payments in foreign currency.';
      BA020@1070025 : TextConst 'ENU=For Payments in EUR use Bank Giro No. not blank for Vendor %1';
      BA021@1070027 : TextConst 'ENU="%1 must be 16 digits when Payments by Account "';
      BA022@1070028 : TextConst 'ENU=%1 is not correct for Vendor %2 %3.';
      PrintOutAddress@1070030 : Boolean;
      TypeOfLine@1070031 : Code[2];
      AmountToPay@1070032 : Decimal;
      AmountToPayLCY@1070033 : Decimal;
      TotalAmountLCY@1070035 : Decimal;
      BA023@1070029 : TextConst 'ENU=Too many different currencies are registered in the system';
      BA024@1070036 : TextConst 'ENU=Only currency SEK or EUR is valid';
      BA025@1070037 : TextConst 'ENU=Bank Giro No. for the Company is not correct!';
      BA026@1070038 : TextConst 'ENU=Code for Bank of Sweden  is missing for %1 %2, Document No. %3 Vendor %4 %5';
      BA027@1070039 : TextConst 'ENU=For payment in foreign currency, only 99 different currencies in the %1 table are possible';
      BA028@1070042 : TextConst 'ENU=%1 is not correct in %2.';
      BA029@1070043 : TextConst 'ENU=For payment in EUR use Plus Giro No. not blank for Vendor %1';
      BA030@1070045 : TextConst 'ENU=%1 too long for vendor %2 %3, max 16 char.';
      BA031@1070044 : TextConst 'ENU=When %1 is used, it is not possible to make a Credit Memo, the problem is with Vendor %2 %3 and Document No. %4';
      BA033@1070001 : TextConst 'ENU=%1 is not supported';
      BA034@1070048 : TextConst 'ENU=VAT Reg. No. is not correct!';
      BA035@1070074 : TextConst 'ENU=%1 must not be %2 for %3 %4 at Vendor %5';
      BA037@1070075 : TextConst 'ENU=Create %1 with File Name:\%2';
      BA038@1070076 : TextConst 'ENU=Description Created from %1 too long\%2\50 char. is maximum.';
      BA039@1070077 : TextConst 'ENU=%1 %2 will be partly paid. Then "%3" must not be blank.';
      BA040@1070078 : TextConst 'ENU="File %1 created with:\Name=%2\Amount=%3"';
      BA041@1070079 : TextConst 'ENU=\\Remaining amount for partly payment is posted with Document No.:\From %4\To %5.';
      BA042@1070080 : TextConst 'ENU=%1 for %2 %3, can not be more than %4.';
      BA043@1070081 : TextConst 'ENU=For payments to LB the lines must be created by the batch job %1.';
      Window@1070085 : Dialog;
      NoOfRec@1070086 : Integer;
      i@1070087 : Integer;
      BA044@1070082 : TextConst 'ENU=Credit Memo is not allowed for Plus Giro';
      BA045@1070083 : TextConst 'ENU=Maximum lenght for %1 is 30 characters.';
      Adr1@1070070 : Text[50];
      Adr2@1070071 : Text[50];
      BA046@1070084 : TextConst 'ENU=An Address field on Vendor %1 must be filled in';
      RBMgt@1070089 : Codeunit 419;
      FromFile@1070090 : Text[250];
      gStreamWriter@1100285001 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StreamWriter";
      gUseStreamWriter@1100285000 : Boolean;
      GLSetup@1100285100 : Record 98;

    PROCEDURE TransferToGiroJournal@1070004(VAR GenJournalLine@1070000 : Record 81);
    VAR
      GenJournalLine2@1070001 : Record 81;
      GenJournalLine3@1070004 : Record 81;
      VendLedgerEntry@1070002 : Record 25;
      Currency@1070003 : Record 4;
      Pack2@1070007 : Record 11128016;
      NoSeriesMgt@1070008 : Codeunit 396;
      GenJnlPostLine@1070009 : Codeunit 12;
      DimMgt@1070010 : Codeunit 408;
      AmountToPay@1070011 : Decimal;
      DocNo@1070012 : Code[20];
      Desc@1070013 : Text[250];
      FromDocNo@1070014 : Code[20];
      ToDocNo@1070015 : Code[20];
      CurrFactor@1070016 : Decimal;
      Pack@1070017 : Record 11128016;
      VPPackEntry@1100285100 : Record 11128063;
      VendorBankAccount@1100285101 : Record 288;
    BEGIN
      CLEARALL;
      GenJournalLine.FIND('-');
      IF GenJournalLine."LB Giro Type" = GenJournalLine."LB Giro Type"::" " THEN
        ERROR(BA043);

      IF NOT CONFIRM(BA037,FALSE,GenJournalLine."LB Giro Type",GetFileName(GenJournalLine."LB Giro Type")) THEN
        ERROR('');

      GetSetup;

      Pack.RESET;
      Pack.LOCKTABLE;
      IF NOT Pack.FIND('+') THEN
        CLEAR(Pack."Entry No.");
      Pack."Entry No." += 1;
      Pack.INIT;
      Pack."Giro Type" := GenJournalLine."LB Giro Type";
      //>>RFC114
      Pack.Date := GenJournalLine."Posting Date";
      IF Pack."Giro Type" = Pack."Giro Type"::"SEPA pain.001" THEN
        Pack."Giro Type Code" := 'PAIN001';
      //<<RFC114
      IF Pack."Giro Type" IN [Pack."Giro Type"::"PG Sweden",Pack."Giro Type"::"PG Foreign"] THEN BEGIN
        Pack2.RESET;
        Pack2.SETFILTER("Giro Type",'%1|%2',Pack2."Giro Type"::"PG Sweden",Pack2."Giro Type"::"PG Foreign");
        Pack2.SETRANGE("File Created",TODAY);
        Pack."No. per Date" := Pack2.COUNT+1;
        IF Pack."No. per Date" > 9 THEN
          ERROR(BA009);
      END;

      GenJournalLine2.COPYFILTERS(GenJournalLine);
      Window.OPEN('@1@@@@@@@@@@@@@@@@@@@@@@@@@');
      NoOfRec := GenJournalLine2.COUNT;
      WITH GenJournalLine2 DO BEGIN
        SETFILTER("Account No.", '<>%1', '');
        IF FIND('-') THEN REPEAT
          i += 1;
          Window.UPDATE(1,ROUND((i/NoOfRec*10000),1.0));
          TESTFIELD("LB Giro Type",GenJournalLine."LB Giro Type");
          TESTFIELD("LB Ledger Entry No.");
          VendLedgerEntry.GET("LB Ledger Entry No.");
          TESTFIELD("Currency Code",VendLedgerEntry."Currency Code");
          IF ("LB Giro Type" IN ["LB Giro Type"::"BG Sweden","LB Giro Type"::"PG Sweden"]) THEN BEGIN
            Currency.RESET;
            IF Currency.FIND('-') THEN BEGIN
              IF PPS."EUR Currency" = VendLedgerEntry."Currency Code" THEN BEGIN
                Vendor.GET(VendLedgerEntry."Vendor No.");
                IF "LB Giro Type" = "LB Giro Type"::"BG Sweden" THEN BEGIN
                  IF Vendor."Bank Giro No." = '' THEN
                    ERROR(BA020,VendLedgerEntry."Vendor No.");
                END ELSE
                  IF Vendor."Plus Giro No." = '' THEN
                    ERROR(BA029,VendLedgerEntry."Vendor No.");
              END ELSE
                // LRS 051211
                //IF VendLedgerEntry."Currency Code" <> '' THEN
                IF NOT LocalCurr(VendLedgerEntry."Currency Code") THEN
                // LRS
                  ERROR(BA024);
            END ELSE
              VendLedgerEntry.TESTFIELD("Currency Code",'');
          END ELSE
            IF "Code for Bank of Sweden" = '' THEN
              ERROR(BA006,"Line No.","Account No.",
                    "Applies-to Doc. Type","Applies-to Doc. No.");
          AmountToPay := 0;
          VendLedgerEntry.CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)",Amount);
          AmountToPay := -CalcAmountToPayGJLrec(GenJournalLine2);
          IF AmountToPay <> -Amount THEN BEGIN // Part.Payment
            IF ABS(AmountToPay) < ABS(Amount) THEN
              ERROR(BA042,GenJournalLine.FIELDCAPTION(Amount),VendLedgerEntry."Document Type",
                    VendLedgerEntry."Document No.",VendLedgerEntry.FIELDCAPTION("Remaining Amount"));
            IF "Due Date Next Payment" = 0D THEN
              ERROR(BA039,VendLedgerEntry."Document Type",VendLedgerEntry."Document No.",FIELDCAPTION("Due Date Next Payment"));
            PPS.TESTFIELD("Part. Pay. Nos.");
            DocNo := NoSeriesMgt.GetNextNo(PPS."Part. Pay. Nos.",WORKDATE,TRUE);
            FromDocNo := DocNo;
            PPS.TESTFIELD("Part. Pay. Bal- Account No");
            Desc := STRSUBSTNO(PPS."Description Part. Payment"
                       ,VendLedgerEntry."Document Type",VendLedgerEntry."Document No.");
            IF STRLEN(Desc) > 50 THEN
              ERROR(BA038,PPS.FIELDCAPTION("Description Part. Payment"));
            IF VendLedgerEntry."Currency Code" <> '' THEN
              IF VendLedgerEntry.Amount <> 0 THEN
                CurrFactor := (VendLedgerEntry."Remaining Amt. (LCY)" / VendLedgerEntry.Amount)
              ELSE
                CLEAR(CurrFactor);
            GenJournalLine3.INIT;
            GenJournalLine3."Document No." := DocNo;
            GenJournalLine3.VALIDATE("Posting Date",TODAY);
            GenJournalLine3.VALIDATE("Account Type",GenJournalLine3."Account Type"::Vendor);
            GenJournalLine3.VALIDATE("Account No.",VendLedgerEntry."Vendor No.");
            GenJournalLine3.VALIDATE("Currency Code",VendLedgerEntry."Currency Code");
            GenJournalLine3.VALIDATE(Amount,-VendLedgerEntry."Remaining Amount");
            GenJournalLine3."Applies-to Doc. Type" := VendLedgerEntry."Document Type";
            GenJournalLine3."Applies-to Doc. No." := VendLedgerEntry."Document No.";
            GenJournalLine3."Applies-to ID" := '';
            GenJournalLine3."External Document No." := VendLedgerEntry."External Document No.";
            GenJournalLine3."Payment Reference" := VendLedgerEntry."Payment Reference";  //RFC148
            GenJournalLine3."Document Type" := GenJournalLine3."Document Type"::Payment;
            GenJournalLine3.VALIDATE("Bal. Account No.",PPS."Part. Pay. Bal- Account No");
            GenJournalLine3.Description := Desc;
            GenJournalLine3."Code for Bank of Sweden" := "Code for Bank of Sweden";
            GenJournalLine3."Source Code" := "Source Code";
            GenJournalLine3."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
            GenJournalLine3."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
            GenJournalLine3."Dimension Set ID" := "Dimension Set ID";
            GenJnlPostLine.RunWithCheck(GenJournalLine3);

            GenJournalLine3.INIT;
            GenJournalLine3."Document No." := DocNo;
            GenJournalLine3.VALIDATE("Posting Date",TODAY);
            GenJournalLine3.VALIDATE("Account Type",GenJournalLine3."Account Type"::Vendor);
            GenJournalLine3.VALIDATE("Account No.",VendLedgerEntry."Vendor No.");
            GenJournalLine3.VALIDATE("Currency Code",VendLedgerEntry."Currency Code");
            GenJournalLine3.VALIDATE(Amount,-Amount);
            IF VendLedgerEntry."Currency Code" <> '' THEN
              GenJournalLine3.VALIDATE("Amount (LCY)",GenJournalLine3.Amount *  CurrFactor);
            GenJournalLine3."External Document No." := VendLedgerEntry."External Document No.";
            GenJournalLine3."Payment Reference" := VendLedgerEntry."Payment Reference";  //RFC148
            GenJournalLine3."Document Type" := GenJournalLine3."Document Type"::" ";
            GenJournalLine3.VALIDATE("Bal. Account No.",PPS."Part. Pay. Bal- Account No");
            GenJournalLine3.VALIDATE("Due Date",GenJournalLine2."Due Date");
            GenJournalLine3."LB Giro Journal No." := Pack."Entry No.";
            GenJournalLine3.Description := Desc;
            GenJournalLine3."Code for Bank of Sweden" := "Code for Bank of Sweden";
            GenJournalLine3."Ext. Doc. No. not Mandatory" := TRUE;
            GenJournalLine3."Source Code" := "Source Code";
            GenJournalLine3."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
            GenJournalLine3."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
            GenJournalLine3."Dimension Set ID" := "Dimension Set ID";
            GenJnlPostLine.RunWithCheck(GenJournalLine3);

            GenJournalLine3.INIT;
            DocNo := NoSeriesMgt.GetNextNo(PPS."Part. Pay. Nos.",WORKDATE,TRUE);
            GenJournalLine3."Document No." := DocNo;
            GenJournalLine3.VALIDATE("Posting Date",TODAY);
            GenJournalLine3.VALIDATE("Account Type",GenJournalLine3."Account Type"::Vendor);
            GenJournalLine3.VALIDATE("Account No.",VendLedgerEntry."Vendor No.");
            GenJournalLine3.VALIDATE("Currency Code",VendLedgerEntry."Currency Code");
            GenJournalLine3.VALIDATE(Amount,AmountToPay + Amount);
            IF VendLedgerEntry."Currency Code" <> '' THEN
              GenJournalLine3.VALIDATE("Amount (LCY)",GenJournalLine3.Amount *  CurrFactor);
            GenJournalLine3."External Document No." := VendLedgerEntry."External Document No.";
            GenJournalLine3."Payment Reference" := VendLedgerEntry."Payment Reference";  //RFC148
            GenJournalLine3."Document Type" := GenJournalLine3."Document Type"::" ";
            GenJournalLine3.VALIDATE("Bal. Account No.",PPS."Part. Pay. Bal- Account No");
            GenJournalLine3.VALIDATE("Due Date",GenJournalLine2."Due Date Next Payment");
            GenJournalLine3.Description := Desc;
            GenJournalLine3."Code for Bank of Sweden" := "Code for Bank of Sweden";
            GenJournalLine3."Ext. Doc. No. not Mandatory" := TRUE;
            GenJournalLine3."Source Code" := "Source Code";
            GenJournalLine3."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
            GenJournalLine3."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
            GenJournalLine3."Dimension Set ID" := "Dimension Set ID";
            GenJnlPostLine.RunWithCheck(GenJournalLine3);
            ToDocNo := DocNo;
          END ELSE BEGIN
            IF VendLedgerEntry."LB Giro Journal No." <> 0 THEN
              ERROR(BA008,FORMAT("Applies-to Doc. Type"),"Applies-to Doc. No.",
                    VendLedgerEntry.FIELDCAPTION("LB Giro Journal No."), VendLedgerEntry."LB Giro Journal No.");
            VendLedgerEntry."Due Date" := "Due Date";
            CODEUNIT.RUN(CODEUNIT::"Vend. Entry-Edit",VendLedgerEntry);
            VendLedgerEntry."LB Giro Journal No." := Pack."Entry No.";
            VendLedgerEntry."Code for Bank of Sweden" := "Code for Bank of Sweden";
            VendLedgerEntry.MODIFY;
          END;

      //>>RFC114
          VPPackEntry.INIT;
          VPPackEntry."Pack Entry No." := Pack."Entry No.";
          VPPackEntry."Ledger Entry No." := VendLedgerEntry."Entry No.";
          VPPackEntry.Type := VPPackEntry.Type::Vendor;
          VPPackEntry."No." := VendLedgerEntry."Vendor No.";
      //    VPPackEntry."Bank Account Code" := "Source Bank Account Code";
          VPPackEntry."Bank Account Code" := 'PAIN001';
          VPPackEntry."Code for Bank of Sweden" := "Code for Bank of Sweden";
      //    VPPackEntry."Currency Account" := "Currency Account";

      //>>RFC155
          IF GLSetup."Norwegian Localization Active" THEN
            VPPackEntry."Code for Bank of Sweden" := "Payment Type Code Abroad";
      //<<RFC155

      //    VPPackEntry."Payment to Currency Code" := GetPayToCurrencyCode(VendLedgerEntry."Currency Code");
          VPPackEntry."Payment to Currency Code" := VendLedgerEntry."Currency Code";
          IF VendLedgerEntry."Currency Code" = '' THEN
            VPPackEntry."Payment to Currency Code" := GLSetup."LCY Code";

      //    VPPackEntry."Payment Relation" := VendorBankAccount."Payment Relation";
      //    VPPackEntry."Merging No." := "Merging No.";
          VPPackEntry.INSERT;
      //<<RFC114
        UNTIL NEXT = 0;
        DELETEALL(TRUE);
      END;
      Window.CLOSE;
      VendLedgerEntry.RESET;
      VendLedgerEntry.SETCURRENTKEY("LB Giro Journal No.");
      VendLedgerEntry.SETRANGE("LB Giro Journal No.",Pack."Entry No.");
      IF VendLedgerEntry.FIND('-') THEN
        Pack.INSERT;

      CleanUpPack;

      CreateFileFromPack(Pack);

      COMMIT;
      //>>RFC114
      IF Pack."Giro Type" = Pack."Giro Type"::"SEPA pain.001" THEN BEGIN
        Pack.GET(Pack."Entry No.");
        TotalAmountLCY := -Pack."Total Amount (LCY)";
      END;
      //<<RFC114

      IF FromDocNo = '' THEN
        MESSAGE(BA040,Pack."Giro Type",GetFileName(Pack."Giro Type"),-TotalAmountLCY)
      ELSE
        MESSAGE(BA040+BA041,Pack."Giro Type",GetFileName(Pack."Giro Type"),-TotalAmountLCY,FromDocNo,ToDocNo);
    END;

    PROCEDURE CleanUpPack@1070000();
    VAR
      VendLedgerEntry@1070001 : Record 25;
      Pack@1070002 : Record 11128016;
    BEGIN
      Pack.RESET;
      VendLedgerEntry.RESET;
      VendLedgerEntry.SETCURRENTKEY("LB Giro Journal No.");
      IF Pack.FIND('-') THEN REPEAT
        VendLedgerEntry.SETRANGE("LB Giro Journal No.",Pack."Entry No.");
        IF NOT VendLedgerEntry.FIND('-') THEN
          Pack.DELETE;
      UNTIL Pack.NEXT = 0;
    END;

    PROCEDURE Date2Text@1070025(Date@1070000 : Date;Length@1070001 : Integer) @1070002 : Text[8];
    BEGIN
      IF (Length < 1) AND (Length > 8) THEN
        ERROR(BA011,Length);
      IF Date <> 0D THEN
        EXIT(COPYSTR(FORMAT(Date,0,'<Year4,4><Month,2><Day,2>'),8-Length+1))
      ELSE
        EXIT(PADSTR('',Length));
    END;

    PROCEDURE Dec2TextBGForeign@1070024(Amount@1070000 : Decimal) @1070001 : Text[30];
    VAR
      DecText@1070002 : Text[30];
    BEGIN
      DecText := FORMAT(ROUND(Amount) * 100);
      DecText := DELCHR(DecText,'=',DELCHR(DecText,'=','0123456789'));
      IF Amount < 0 THEN
        EXIT(COPYSTR(DecText,1,STRLEN(DecText) - 1) +
             CONVERTSTR(COPYSTR(DecText,STRLEN(DecText), 1),'0123456789','-JKLMNOPQR'));
      EXIT(DecText);
    END;

    PROCEDURE ClearText@1070026(Text@1070000 : Text[250]) @1070001 : Text[250];
    VAR
      TextTmp@1070002 : Text[30];
    BEGIN
      EXIT(DELCHR(Text,'=',DELCHR(Text,'=','0123456789')));
    END;

    PROCEDURE NFL@1070027(Text@1070000 : Text[250];Length@1070001 : Integer) : Text[250];
    BEGIN
      Text := DELCHR(Text,'<>');
      IF (Length < 1) AND (Length > 250) THEN
        ERROR(BA011,'NFL',Length);
      IF STRLEN(Text) > Length THEN
        Text := COPYSTR(Text,STRLEN(Text)-Length+1);
      EXIT(PADSTR('', Length - STRLEN(Text),'0') + Text);
    END;

    PROCEDURE NFR@1070028(Text@1070000 : Text[250];Length@1070001 : Integer) : Text[250];
    BEGIN
      Text := DELCHR(Text,'<>');
      IF (Length < 1) AND (Length > 250) THEN
        ERROR(BA011,'NFR',Length);
      EXIT(PADSTR(Text,Length,'0'));
    END;

    PROCEDURE TFL@1070029(Text@1070000 : Text[250];Length@1070001 : Integer) : Text[250];
    VAR
      TextUt@1070002 : Text[40];
    BEGIN
      Text := DELCHR(Text,'<>');
      IF (Length < 1) AND (Length > 250) THEN
        ERROR(BA011,'TFL',Length);
      Text := COPYSTR(Text,1,Length);
      EXIT(PADSTR('', Length - STRLEN(Text),' ') + Text);
    END;

    PROCEDURE TFR@1070030(Text@1070000 : Text[250];Length@1070001 : Integer) : Text[250];
    VAR
      TextUt@1070002 : Text[40];
    BEGIN
      Text := DELCHR(Text,'<>');
      IF (Length < 1) AND (Length > 250) THEN
        ERROR(BA011,'TFR',Length);
      EXIT(UPPERCASE(PADSTR(Text,Length)));
    END;

    PROCEDURE BLK@1070031(Length@1070000 : Integer) : Text[250];
    VAR
      TextUt@1070001 : Text[40];
    BEGIN
      IF (Length < 1) AND (Length > 250) THEN
        ERROR(BA011,'BLK',Length);
      EXIT(PADSTR('',Length));
    END;

    PROCEDURE SumCheck10@1070032(Code@1070000 : Code[20]) : Code[1];
    VAR
      ChSum@1070001 : Decimal;
      C@1070002 : Decimal;
      i@1070003 : Integer;
    BEGIN
      Code := COPYSTR(NFL(ClearText(Code),20), 1, 19);
      CLEAR(ChSum);
      FOR i := 1 TO 19 DO BEGIN
        EVALUATE(C, COPYSTR(Code, i, 1));
        ChSum := ChSum + ((C * (( i MOD 2) + 1)) MOD 10);
        ChSum := ChSum + ((C * (( i MOD 2) + 1)) DIV 10);
      END;
      ChSum := (10 - (ChSum MOD 10)) MOD 10;
      EXIT(FORMAT(ChSum));
    END;

    PROCEDURE SumCheck10Control@1070033(Code@1070000 : Code[20]) : Boolean;
    BEGIN
      EXIT(COPYSTR(Code,STRLEN(Code),1) = SumCheck10(Code));
    END;

    PROCEDURE Value1@1070002(Dec@1070000 : Decimal;Length@1070001 : Integer) : Text[250];
    BEGIN
      EXIT(NFL(ClearText(FORMAT(ROUND(Dec,1.0))),Length));
    END;

    PROCEDURE Value100@1070034(Dec@1070000 : Decimal;Length@1070001 : Integer) : Text[250];
    BEGIN
      IF Dec = 0 THEN
        EXIT(NFL('000',Length));
      EXIT(NFL(ClearText(FORMAT(ROUND(Dec)*100)),Length));
    END;

    PROCEDURE FillField@1070035(Field1@1070000 : Text[250];Field2@1070001 : Text[250]) : Text[250];
    BEGIN
      IF Field1 <> '' THEN
        EXIT(Field1);
      EXIT(Field2);
    END;

    PROCEDURE NegativeSign@1070036(Dec@1070000 : Decimal) : Text[1];
    BEGIN
      IF Dec < 0 THEN
        EXIT('-')
      ELSE
        EXIT(' ');
    END;

    PROCEDURE GetSetup@1070037();
    BEGIN
      CompanyInfo.GET;
      PPS.GET;
      IF Currency.FIND('-') THEN
        PPS.TESTFIELD("EUR Currency");

      PPS.TESTFIELD("Description Part. Payment");

      GLSetup.GET;
    END;

    PROCEDURE CreateGiroNo@1070006(VAR InVendor@1070000 : Record 23;VAR InCurrency@1070003 : Record 4) NewVendGiroNo : Code[10];
    VAR
      Vend2@1070002 : Record 23;
      Currency2@1070001 : Record 4;
      PurchPayablesSetup@1070004 : Record 312;
      SavePaymentNo@1070005 : Code[5];
    BEGIN
      IF InCurrency.Code = '' THEN
        NewVendGiroNo := '00'
      ELSE BEGIN
        IF InCurrency."Payment No." = '' THEN BEGIN
          IF Currency2.COUNT >= 99 THEN
            ERROR(BA027,Currency2.TABLECAPTION);
          Currency2.SETCURRENTKEY("Payment No.");
          Currency2.SETFILTER("Payment No.",'<>%1','');
          IF Currency2.FIND('+') THEN
            InCurrency."Payment No." := INCSTR(Currency2."Payment No.")
          ELSE
            InCurrency."Payment No." := '01';
          InCurrency.MODIFY;
        END;
        NewVendGiroNo := InCurrency."Payment No."
      END;
      IF InVendor."Payment No." = '' THEN BEGIN
        PurchPayablesSetup.LOCKTABLE;
        PurchPayablesSetup.GET;
        IF PurchPayablesSetup."Payment No." = '' THEN BEGIN
          Vend2.RESET;
          Vend2.SETCURRENTKEY("Payment No.");
          Vend2.SETFILTER("Payment No.",'<>%1','');
          IF Vend2.FIND('+') THEN
            PurchPayablesSetup."Payment No." := Vend2."Payment No."
          ELSE
            PurchPayablesSetup."Payment No." := '0001';
        END ELSE
          PurchPayablesSetup."Payment No." := INCSTR(PurchPayablesSetup."Payment No.");
        SavePaymentNo := PurchPayablesSetup."Payment No.";
        WHILE NOT GetNextPaymentNo(PurchPayablesSetup."Payment No.") DO
          IF PurchPayablesSetup."Payment No." = SavePaymentNo THEN
            ERROR(BA019);

        PurchPayablesSetup.MODIFY;
        InVendor.FIND;
        InVendor.LOCKTABLE;
        InVendor."Payment No." := PurchPayablesSetup."Payment No.";
        InVendor.MODIFY;
        InVendor.CALCFIELDS(IBAN); //IME297
      END;
      NewVendGiroNo := NewVendGiroNo + InVendor."Payment No.";
      NewVendGiroNo := NewVendGiroNo + SumCheck10(NewVendGiroNo + '0');
    END;

    PROCEDURE GetNextPaymentNo@1070038(VAR PaymentNo@1070002 : Code[5]) : Boolean;
    VAR
      VendorLedgerEntry@1070000 : Record 25;
      Vend2@1070001 : Record 23;
    BEGIN
      IF PaymentNo = '10000' THEN BEGIN
        PaymentNo := '0001';
        EXIT(FALSE);
      END;

      Vend2.RESET;
      Vend2.SETCURRENTKEY("Payment No.");
      Vend2.SETRANGE("Payment No.",PaymentNo);
      IF NOT Vend2.FIND('-') THEN
        EXIT(TRUE);

      VendorLedgerEntry.RESET;
      VendorLedgerEntry.SETCURRENTKEY("Vendor No.",Open);
      VendorLedgerEntry.SETRANGE("Vendor No.",Vend2."No.");
      VendorLedgerEntry.SETRANGE(Open,TRUE);
      VendorLedgerEntry.SETFILTER("LB Giro Journal No.",'<>0');
      IF VendorLedgerEntry.FIND('-') THEN BEGIN
        PaymentNo := INCSTR(PaymentNo);
        EXIT(FALSE);
      END ELSE BEGIN
        Vend2.FIND;
        Vend2.LOCKTABLE;
        CLEAR(Vend2."Payment No.");
        Vend2.MODIFY;
        EXIT(TRUE);
      END;
    END;

    PROCEDURE GetFileName@1070039(GiroType@1070000 : ' ,BG Sweden,PG Sweden,BG Foreign,PG Foreign,SEPA,SEPA pain') FileName : Text[250];
    VAR
      VPGiroType@1100285100 : Record 11128061;
    BEGIN
      GetSetup;
      CASE GiroType OF
        GiroType::"BG Sweden":
          BEGIN
            PPS.TESTFIELD("File Path and Name BG Sweden");
            FileName := PPS."File Path and Name BG Sweden";
          END;
        GiroType::"BG Foreign":
          BEGIN
            PPS.TESTFIELD("File Path and Name BG Foreign");
            FileName := PPS."File Path and Name BG Foreign";
          END;
        GiroType::"PG Sweden":
          BEGIN
            PPS.TESTFIELD("File Path and Name PG Sweden");
            FileName :=  PPS."File Path and Name PG Sweden";
          END;
        GiroType::"PG Foreign":
          BEGIN
            PPS.TESTFIELD("File Path and Name PG Foreign");
            FileName :=  PPS."File Path and Name PG Foreign";
          END;
      // I016 *** 131022 <<
        GiroType::SEPA:
           BEGIN
            PPS.TESTFIELD("File Path and Name SEPA");
            FileName :=  PPS."File Path and Name SEPA";
           END;
      // I016 *** 131022 >>
      //>>RFC114
        GiroType::"SEPA pain":
          BEGIN
            VPGiroType.GET('PAIN001');
            VPGiroType.TESTFIELD(Filename);
            FileName :=  VPGiroType.Filename;
          END;
      //<<RFC114
        ELSE
          ERROR(BA033,GiroType);
      END;
    END;

    PROCEDURE OpenFile@1070005(FileName@1070000 : Text[250];useEncoding@1100285002 : Boolean);
    VAR
      EncodingDotNet@1100285000 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Text.Encoding";
      outStream@1100285001 : OutStream;
      EncodingVal@1100285300 : Integer;
    BEGIN
      f.TEXTMODE(TRUE);
      f.WRITEMODE(TRUE);
      IF ISSERVICETIER THEN BEGIN
        FromFile := RBMgt.ServerTempFileName('.txt');
        f.CREATE(FromFile);
      END ELSE BEGIN
        IF EXISTS(FileName) THEN
          ERASE(FileName);
        f.CREATE(FileName);
        f.OPEN(FileName);
      END;

      //>>160310, swedbank don't accept ANSI
      GetSetup;
      IF useEncoding AND (PPS."Fileformat BG/PG export"=0) THEN
        useEncoding := FALSE;
      //<<160310

      //>>150303 ITERO.DL IME297
      gUseStreamWriter := FALSE;
      IF useEncoding THEN BEGIN

      //>>160310, swedbank don't accept ANSI
        CASE PPS."Fileformat BG/PG export" OF
          PPS."Fileformat BG/PG export"::"850 (DOS EU)": EncodingVal :=850;
          PPS."Fileformat BG/PG export"::"437 (DOS US)": EncodingVal :=437;
          PPS."Fileformat BG/PG export"::"1252 (Windows)": EncodingVal :=1252;
        ELSE
          EncodingVal :=437;
        END;
      //<<160310

        f.CREATEOUTSTREAM(outStream);
      // Here on this link you can find Encodings like, 1252=ANSI, 437=OEM, 65000=UTF7, 65001=UTF8
      //http://msdn.microsoft.com/en-us/library/system.text.encodinginfo.codepage.aspx
      //http://blogs.msdn.com/b/nav/archive/2012/12/05/unicode-and-microsoft-dynamics-nav-2013.aspx
        //gStreamWriter := gStreamWriter.StreamWriter(outStream, EncodingDotNet.GetEncoding(1252)); // Ansi
        gStreamWriter := gStreamWriter.StreamWriter(outStream, EncodingDotNet.GetEncoding(EncodingVal)); // Ansi
        gUseStreamWriter := TRUE;
      END;
      //<<150303

      CLEAR(TotalAmount);
      CLEAR(NoOfLines);
      CLEAR(TotalAmountLCY);
    END;

    PROCEDURE WriteFile@1070040(Length@1070000 : Integer;Text@1070001 : Text[250]);
    BEGIN
      IF STRLEN(Text) > Length THEN
        ERROR(BA017,Text,STRLEN(Text),Length);
      //>>150303 ITERO.DL IME297
      IF gUseStreamWriter THEN
        gStreamWriter.WriteLine(Text)
      ELSE
      //<<150303
        f.WRITE(PADSTR(Text,Length));
    END;

    PROCEDURE CloseFile@1070009(Pack@1070000 : Record 11128016);
    BEGIN
      Pack.LOCKTABLE;
      Pack.FIND;
      Pack."Total Amount (LCY)" := -TotalAmountLCY;
      Pack."File Created" := TODAY;
      Pack.Time := TIME;
      Pack.MODIFY;

      //150303
      IF gUseStreamWriter THEN gStreamWriter.Close();

      f.CLOSE;
      IF ISSERVICETIER THEN
        RBMgt.DownloadToFile(FromFile,GetFileName(Pack."Giro Type"));
        //RBMgt.DownloadFileFromServerToRTC(FromFile,GetFileName(Pack."Giro Type"),FALSE);
    END;

    PROCEDURE CreateFileFromPack@1070022(VAR Pack@1070000 : Record 11128016);
    VAR
      GeneralLedgerSetup@1070001 : Record 98;
      HandleSEPAPayments@1100285000 : XMLport 11128020;
      SEPAostream@1100285001 : OutStream;
      VPGiroType@1100285100 : Record 11128061;
      VPPack@1100285300 : Record 11128079;
    BEGIN
      GetSetup;

      FirstTime := TRUE;
      CASE Pack."Giro Type" OF
        Pack."Giro Type"::"BG Sweden":
          BEGIN
            CompanyInfo.TESTFIELD("Giro No.");

            IF NOT SumCheck10Control(CompanyInfo."Giro No.") THEN
              ERROR(BA025);

            OpenFile(GetFileName(Pack."Giro Type"),TRUE);

            // Get all invoices for Currency SEK
            GeneralLedgerSetup.GET;
            CreateFileBGSweden(Pack,'SEK',''''''+'|'+GeneralLedgerSetup."LCY Code");

            // Get all invoices for Currency EUR
            IF Currency.FIND('-') THEN
              CreateFileBGSweden(Pack,'EUR',PPS."EUR Currency");

            CloseFile(Pack);
          END;
        Pack."Giro Type"::"BG Foreign":
          BEGIN
            PPS.TESTFIELD("BG Foreign File Format");
            CASE PPS."BG Foreign File Format" OF
              PPS."BG Foreign File Format"::"Nordea Axess":
                CompanyInfo.TESTFIELD("Interpay-ID");
              ELSE BEGIN
                CompanyInfo.TESTFIELD("Giro No.");
                IF NOT SumCheck10Control(CompanyInfo."Giro No.") THEN
                  ERROR(BA025);
              END;
            END;

            OpenFile(GetFileName(Pack."Giro Type"),TRUE);

            CreateFileBGForeign(Pack);
            CloseFile(Pack);
          END;
        Pack."Giro Type"::"PG Sweden":
          BEGIN
            CompanyInfo.TESTFIELD("Plus Giro Customer No.");
            CompanyInfo.TESTFIELD("Plus Giro No.");

            PostGiroNo := ClearText(CompanyInfo."Plus Giro No.");
            PostGiroCustNo := CompanyInfo."Plus Giro Customer No.";

            IF NOT SumCheck10Control(PostGiroNo) THEN
              ERROR(STRSUBSTNO(BA028, CompanyInfo.FIELDCAPTION("Plus Giro No."),CompanyInfo.TABLECAPTION));

            OpenFile(GetFileName(Pack."Giro Type"),TRUE);

            // Get all invoices for Currency SEK
            GeneralLedgerSetup.GET;
            CreateFilePGSweden(Pack,'SEK',''''''+'|'+GeneralLedgerSetup."LCY Code");

            // Get all invoices for Currency EUR
            IF Currency.FIND('-') THEN
              CreateFilePGSweden(Pack,'EUR',PPS."EUR Currency");

            CloseFile(Pack);
          END;
        Pack."Giro Type"::"PG Foreign":
          BEGIN
            CompanyInfo.TESTFIELD("Plus Giro Customer No.");
            CompanyInfo.TESTFIELD("Plus Giro No.");
            CompanyInfo.TESTFIELD("Registration No.");

            PostGiroNo := CompanyInfo."Plus Giro No.";
            PostGiroCustNo := CompanyInfo."Plus Giro Customer No.";
            RegNo := CompanyInfo."Registration No.";

            IF NOT SumCheck10Control(PostGiroNo) THEN
              ERROR(STRSUBSTNO(BA028, CompanyInfo.FIELDCAPTION("Plus Giro No."),CompanyInfo.TABLECAPTION));

            IF NOT SumCheck10Control(RegNo) THEN
              ERROR(BA034);

            OpenFile(GetFileName(Pack."Giro Type"),TRUE);

            CreateFilePGForeign(Pack);
            CloseFile(Pack);
          END;
        // *** I016 *** 1131022 <<
        Pack."Giro Type"::SEPA:
          BEGIN
            OpenFile(GetFileName(Pack."Giro Type"),FALSE);

            f.CREATEOUTSTREAM(SEPAostream);

            HandleSEPAPayments.SetLBGiro(Pack."Entry No.");
            HandleSEPAPayments.SETDESTINATION(SEPAostream);
            HandleSEPAPayments.EXPORT;

            CloseFile(Pack);

          END;
        // *** I016 *** 1131022 >>
      //>>RFC114
        Pack."Giro Type"::"SEPA pain.001":
          BEGIN
            VPGiroType.GET('PAIN001');

            VPPack.INIT;
            VPPack."Entry No." := Pack."Entry No.";
            VPPack."Giro Type Code" := Pack."Giro Type Code";
            VPPack."Total Amount (LCY)" := Pack."Total Amount (LCY)";
            VPPack."No. per Date" := Pack."No. per Date";
            VPPack.Date := Pack.Date;
            VPPack.Time := Pack.Time;
            VPPack."Plus Giro" := Pack."Plus Giro";
            VPPack."SEPA Reference" := Pack."SEPA Reference";
            VPPack.Status := Pack.Status;
            VPPack.INSERT;

            CODEUNIT.RUN(VPGiroType."Codeunit No.",VPPack);

            Pack.GET(VPPack."Entry No.");
            Pack."Giro Type Code" := VPPack."Giro Type Code";
            Pack."Giro Type Code" := VPPack."Giro Type Code";
            Pack."Total Amount (LCY)" := VPPack."Total Amount (LCY)";
            Pack."No. per Date" := VPPack."No. per Date";
            Pack.Date := VPPack.Date;
            Pack.Time := VPPack.Time;
            Pack."Plus Giro" := VPPack."Plus Giro";
            Pack."SEPA Reference" := VPPack."SEPA Reference";
            Pack.Status := VPPack.Status;
            Pack.MODIFY;

          END;
      //<<RFC114
        ELSE
          ERROR(BA033,Pack."Giro Type");
      END;
    END;

    PROCEDURE CreateFileBGSweden@1070001(Pack@1070001 : Record 11128016;CurrencyCode@1070005 : Code[10];CurrencyFilter@1070006 : Text[260]);
    VAR
      VendLedgerEntry@1070000 : Record 25;
      VendNo@1070002 : Code[20];
      DueDate@1070003 : Date;
      PostalGiro@1070004 : Boolean;
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        RESET;
        SETCURRENTKEY("LB Giro Journal No.","Currency Code");
        SETRANGE("LB Giro Journal No.",Pack."Entry No.");
        SETFILTER("Currency Code",CurrencyFilter);
        IF NOT FIND('-') THEN
          EXIT;

        CLEAR(TotalAmount);
        CLEAR(NoOfLines);

        WriteFile(80,'11' +
           NFL(ClearText(CompanyInfo."Giro No."),10) +
           Date2Text(TODAY,6) +
           TFR('LEVERANT™RSBETALNINGAR',41) +
           CurrencyCode);

        IF FirstTime THEN BEGIN
          IF PPS."Information Line BG Sweden" <> '' THEN BEGIN
            IF PPS."Due Date for Information Line" < TODAY THEN
              ERROR(BA018);
            WriteFile(80,'12' +
               TFR(PPS."Information Line BG Sweden",50) +
               Date2Text(PPS."Due Date for Information Line",6));
          END;
          WriteFile(80,'13' +
             TFR('FAKTURA',32) +
             'NETTO');
          FirstTime := FALSE
        END;

        // Get all Vendor Invoices for one Currency
        REPEAT
          CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)");
          Vendor.GET("Vendor No.");
      //ITERO.DL 140729
          Vendor.CALCFIELDS(IBAN);

          CLEAR(Currency);
          IF (PPS."EUR Currency" = "Currency Code") AND ("Currency Code" <> '') THEN
            IF Vendor."Bank Giro No." = '' THEN
              ERROR(BA020,"Vendor No.");
          PostalGiro := FALSE;
          IF Vendor."Bank Giro No." <> '' THEN BEGIN
            VendNo := ClearText(Vendor."Bank Giro No.");
            IF VendNo = '' THEN
              ERROR(BA022,Vendor.FIELDCAPTION("Bank Giro No."), Vendor."No.", Vendor.Name);
            IF NOT SumCheck10Control(VendNo) THEN
              ERROR(BA022,Vendor.FIELDCAPTION("Bank Giro No."), Vendor."No.", Vendor.Name);
          END ELSE BEGIN
            IF Vendor."Plus Giro No." <> '' THEN BEGIN
              IF "Remaining Amount" > 0 THEN
                ERROR(BA044);
              VendNo := ClearText(Vendor."Plus Giro No.");
              IF VendNo = '' THEN
                ERROR(BA022,Vendor.FIELDCAPTION("Plus Giro No."),Vendor."No.", Vendor.Name);
              IF NOT SumCheck10Control(VendNo) THEN
                ERROR(BA022,Vendor.FIELDCAPTION("Plus Giro No."),Vendor."No.", Vendor.Name);
              PostalGiro := TRUE;
            END ELSE BEGIN
              VendNo := CreateGiroNo(Vendor,Currency);

              IF Vendor.IBAN = '' THEN
                PrintOutAddress := TRUE
              ELSE BEGIN
                IF STRLEN(ClearText(Vendor.IBAN)) <> 16  THEN
                  ERROR(BA021,Vendor.FIELDCAPTION(IBAN));
                WriteFile(80,'40' +
                   NFL(ClearText(VendNo),10) +
                   TFR(ClearText(Vendor.IBAN),16) +
                   //>>RFC148
                   //TFR("External Document No.",12));
                   ExtDocNoOrPayRef("External Document No.","Payment Reference",12));
                   //<<RFC148
                PrintOutAddress := Vendor."Account Payment with Advising";
              END;

              IF PrintOutAddress THEN BEGIN
                Vendor.TESTFIELD(Name);
                Vendor.TESTFIELD("Post Code");
                Vendor.TESTFIELD(City);

                IF Vendor.Address <> '' THEN BEGIN
                  IF Vendor."Address 2" <> '' THEN BEGIN
                    Adr1 := Vendor.Address;
                    Adr2 := Vendor."Address 2";
                  END ELSE BEGIN
                    Adr1 := '';
                    Adr2 := Vendor.Address;
                  END;
                END ELSE BEGIN
                  IF Vendor."Address 2" = '' THEN
                    ERROR(BA046,Vendor."No.");
                  Adr1 := '';
                  Adr2 := Vendor."Address 2";
                END;

                WriteFile(80,'26' +
                   NFL(ClearText(VendNo),10) +
                   TFR(Vendor.Name,35) +
                   TFR(Adr1,30));
                WriteFile(80,'27' +
                   NFL(ClearText(VendNo),10) +
                   TFR(Adr2,35) +
                   TFR(ClearText(Vendor."Post Code"),5) +
                   TFR(Vendor.City,25));
              END;
            END;
          END;
          IF "Remaining Amount" > 0  THEN // Credit Memo
            TypeOfLine := '16'
          ELSE                            // Invoice
            TypeOfLine := '14';


          //+++4PSSE
          IF "Document Type" ="Document Type"::"Credit Memo" THEN BEGIN
            DueDate := CALCDATE('<+1Y>',"Due Date");
          END ELSE IF "Due Date" < TODAY THEN BEGIN
          //IF "Due Date" < TODAY THEN BEGIN
          //---4PSSE
            DueDate := TODAY;
            "Due Date" := TODAY;
          END ELSE
            DueDate := "Due Date";

          AmountToPay := CalcAmountToPay(VendLedgerEntry);
          AmountToPayLCY := CalcAmountToPayLCY(VendLedgerEntry);


          TotalAmount += AmountToPay;
          TotalAmountLCY += AmountToPayLCY;
          NoOfLines += 1;

          IF PostalGiro THEN BEGIN
            WriteFile(80,'54' +
               NFL(ClearText(VendNo),10) +
               //>>RFC148
               //TFR("External Document No.",25) +
               ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
               //>>RFC148
               NFL(Value100(AmountToPay,12),12) +
               Date2Text("Due Date",6) +
               BLK(5) +
              TFR('Vernr: '+"Document No.",20));
          END ELSE BEGIN
            WriteFile(80,TypeOfLine +
               NFL(ClearText(VendNo),10) +
               //>>RFC148
               //TFR("External Document No.",20) +
               ExtDocNoOrPayRef("External Document No.","Payment Reference",20) +
               //>>RFC148
               BLK(5) +
               NFL(Value100(AmountToPay,12),12) +
               Date2Text(DueDate,6) +
               BLK(5) +
               TFR('Vernr: '+"Document No.",20));
          END;
        UNTIL NEXT = 0;

        WriteFile(80,'29' +
           NFL(ClearText(CompanyInfo."Giro No."),10) +
           NFL(Value1(NoOfLines,8),8) +
           NFL(Value100(TotalAmount,12),12) +
           NegativeSign(-TotalAmount));
      END;
    END;

    PROCEDURE CreateFileBGForeign@1070012(Pack@1070000 : Record 11128016);
    VAR
      VendLedgerEntry@1070001 : Record 25;
      VendNo@1070002 : Code[20];
      AmountCurrAccount@1070003 : Text[1];
      PmtChargePayedBy@1070004 : Integer;
      DueDate@1070007 : Date;
      CurrencyCode@1070008 : Code[10];
      PaymMethodTxt@1070009 : Text[1];
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        RESET;
        SETCURRENTKEY("LB Giro Journal No.","Currency Code");
        SETRANGE("LB Giro Journal No.",Pack."Entry No.");
        IF NOT FIND('-') THEN
          EXIT;

        CASE PPS."BG Foreign File Format" OF
          PPS."BG Foreign File Format"::"SE Banken SISU":
            WriteFile(80,'0' +
               NFL(ClearText(CompanyInfo."Giro No."),8) +
               Date2Text(TODAY,6) +
               TFR(CompanyInfo.Name,22) +
               TFR(FillField(CompanyInfo."Address 2",CompanyInfo.Address),35) +
               BLK(6) +
               '20');
          PPS."BG Foreign File Format"::"Swedbank SPISU",
          PPS."BG Foreign File Format"::"Nordea BGC":
            WriteFile(80,'0' +
               NFL(ClearText(CompanyInfo."Giro No."),8) +
               Date2Text(TODAY,6) +
               TFR(CompanyInfo.Name,22) +
               TFR(FillField(CompanyInfo."Address 2",CompanyInfo.Address),35) +
               BLK(6) +
               '2');
          PPS."BG Foreign File Format"::"Handelsbanken UTLI":
            WriteFile(80,'0' +
               NFL(ClearText(CompanyInfo."Giro No."),8) +
               Date2Text(TODAY,6) +
               BLK(63) +
               '2');
          PPS."BG Foreign File Format"::"Nordea Axess":
            WriteFile(80,'1' +
               BLK(7) +
               NFL(ClearText(CompanyInfo."Interpay-ID"),16) +
               TFR(CompanyInfo.Name,25) +
               TFR(FillField(CompanyInfo."Address 2",CompanyInfo.Address),22) +
               BLK(1) +
               BLK(6) +
               BLK(1) +
               BLK(1));
        END;

        REPEAT
          CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)");

          Vendor.GET("Vendor No.");
      //ITERO.DL 140729
          Vendor.CALCFIELDS(IBAN);

          // LRS 051211
          //IF "Currency Code" = '' THEN BEGIN
          IF LocalCurr("Currency Code") THEN BEGIN
          // LRS
            CLEAR(Currency);
            CurrencyCode := 'SEK'
          END ELSE BEGIN
            Currency.GET("Currency Code");
            CurrencyCode := "Currency Code";
          END;

          IF "Code for Bank of Sweden" = '' THEN
            ERROR(BA026,
                  "Document Type","External Document No.","Document No.",Vendor."No.",Vendor.Name);

          VendNo := CreateGiroNo(Vendor,Currency);

          IF Vendor."Currency Account" THEN
            AmountCurrAccount := '1'
          ELSE
            AmountCurrAccount := '0';

          CASE PPS."BG Foreign File Format" OF
            PPS."BG Foreign File Format"::"SE Banken SISU":
                  PmtChargePayedBy := Vendor."Payment Charge Paid by";
            PPS."BG Foreign File Format"::"Swedbank SPISU":
              BEGIN
                CASE Vendor."Payment Charge Paid by" OF
                  0,3: PmtChargePayedBy := 0;
                  1,2: PmtChargePayedBy := 2;
                END;
              END;
            PPS."BG Foreign File Format"::"Handelsbanken UTLI":
              BEGIN
                CASE Vendor."Payment Charge Paid by" OF
                  0: PmtChargePayedBy := 0;
                  3: PmtChargePayedBy := 9;
                  1,2: PmtChargePayedBy := 1;
                END;
                CASE Vendor."Payment Method" OF
                  Vendor."Payment Method"::Normal: PaymMethodTxt := 'B';
                  Vendor."Payment Method"::Express: PaymMethodTxt := 'T';
                END;
                  IF Vendor."Currency Account" THEN
                    AmountCurrAccount := 'V'
                  ELSE
                    AmountCurrAccount := 'I';
              END;
            PPS."BG Foreign File Format"::"Nordea BGC",
            PPS."BG Foreign File Format"::"Nordea Axess":
              BEGIN
                CASE Vendor."Payment Charge Paid by" OF
                  0,1,2: PmtChargePayedBy := 1;
                  3: PmtChargePayedBy := 0;
                END;
              END;
          END;

          //+++4PSSE
          IF "Document Type" ="Document Type"::"Credit Memo" THEN BEGIN
            DueDate := CALCDATE('<+1Y>',"Due Date");
          END ELSE IF "Due Date" < TODAY THEN BEGIN
          //IF "Due Date" < TODAY THEN BEGIN
          //---4PSSE
            DueDate := TODAY;
            "Due Date" := TODAY;
          END ELSE
            DueDate := "Due Date";

          AmountToPay := CalcAmountToPay(VendLedgerEntry);
          AmountToPayLCY := CalcAmountToPayLCY(VendLedgerEntry);

          IF NOT (Vendor."Payment Type" IN [Vendor."Payment Type"::Check,Vendor."Payment Type"::Account]) THEN
            ERROR(BA035,Vendor.FIELDCAPTION("Payment Type"),Vendor."Payment Type",Pack.FIELDCAPTION("Giro Type"),
                         Pack."Giro Type",Vendor."No.");

          IF "Remaining Amount" > 0 THEN // Credit Memo
            TypeOfLine := '5'
          ELSE                           // Invoice
            TypeOfLine := '6';

          TotalAmount +=  AmountToPay;
          TotalAmountLCY += AmountToPayLCY;

          WriteFile(80,'2' +
             NFL(VendNo,7) +
             TFR(Vendor.Name,30) +
             TFR(Vendor.Address,33));

          CASE PPS."BG Foreign File Format" OF
            PPS."BG Foreign File Format"::"SE Banken SISU",
            PPS."BG Foreign File Format"::"Nordea BGC",
            PPS."BG Foreign File Format"::"Nordea Axess":
              WriteFile(80,'3' +
                 NFL(VendNo,7) +
                 TFR(Vendor."Address 2",30) +
                 TFR(Vendor."Post Code" + BLK(1) + Vendor.City,33) +
                 BLK(2) +
                 TFR(AmountCurrAccount,1) +
                 TFR(Vendor."Country/Region Code",2) +
                 BLK(1) +
                 NFL(FORMAT(PmtChargePayedBy),1) +
                 NFL(FORMAT(Vendor."Payment Type",0,2),1) +
                 NFL(FORMAT(Vendor."Payment Method",0,2),1));
            PPS."BG Foreign File Format"::"Swedbank SPISU":
              WriteFile(80,'3' +
                 NFL(VendNo,7) +
                 TFR(Vendor."Address 2",30) +
                 TFR(Vendor."Post Code" + BLK(1) + Vendor.City,35) +
                 TFR(AmountCurrAccount,1) +
                 TFR(Vendor."Country/Region Code",2) +
                 BLK(1)+
                 NFL(FORMAT(PmtChargePayedBy),1) +
                 BLK(1) +
                 NFL(FORMAT(Vendor."Payment Method",0,2),1));
            PPS."BG Foreign File Format"::"Handelsbanken UTLI":
              WriteFile(80,'3' +
                 NFL(VendNo,7) +
                 TFR(Vendor."Address 2",30) +
                 TFR(Vendor."Post Code" + BLK(1) + Vendor.City,35) +
                 BLK(1) +
                 TFR(Vendor."Country/Region Code",2) +
                 BLK(1) +
                 NFL(FORMAT(PmtChargePayedBy),1) +
                 NFL(PaymMethodTxt,1));
          END;
          CASE PPS."BG Foreign File Format" OF
            PPS."BG Foreign File Format"::"SE Banken SISU",
            PPS."BG Foreign File Format"::"Swedbank SPISU":
              BEGIN
                IF STRLEN(Vendor.IBAN) > 30 THEN
                  ERROR(BA045,Vendor.IBAN);
                WriteFile(80,'4' +
                   NFL(VendNo,7) +
                   TFR(Vendor."SWIFT Address/BIC Code",12) +
                   TFR(Vendor.IBAN,30) +
                   TFR(Vendor.Bank,30));
              END;
            PPS."BG Foreign File Format"::"Handelsbanken UTLI":
              WriteFile(80,'4' +
                 NFL(VendNo,7) +
                 TFR(Vendor.IBAN,35) +
                 TFR(Vendor.Bank,24) +
                 TFR(Vendor."SWIFT Address/BIC Code",11) +
                 BLK(2));
            PPS."BG Foreign File Format"::"Nordea BGC",
            PPS."BG Foreign File Format"::"Nordea Axess":
              WriteFile(80,'4' +
                 NFL(VendNo,7) +
                 TFR(Vendor."SWIFT Address/BIC Code",14) +
                 TFR(Vendor.IBAN,34) +
                 TFR(Vendor.Bank,24));
          END;

          // Invoice and Credit Memo
          CASE PPS."BG Foreign File Format" OF
            PPS."BG Foreign File Format"::"SE Banken SISU":
              WriteFile(80,TFR(TypeOfLine,1) +
                 NFL(VendNo,7) +
                 //>>RFC148
                 //TFR("External Document No.",25) +
                 ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
                 //>>RFC148
                 NFL(Dec2TextBGForeign(-AmountToPayLCY),11) +
                 BLK(10) +
                 TFR(CurrencyCode,3) +
                 Date2Text(DueDate,6) +
                 BLK(2) +
                 NFL(Dec2TextBGForeign(-AmountToPay),13) +
                 BLK(1) +
                 '0');
            PPS."BG Foreign File Format"::"Swedbank SPISU":
              WriteFile(80,TFR(TypeOfLine,1) +
                 NFL(VendNo,7) +
                 //>>RFC148
                 //TFR("External Document No.",25) +
                 ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
                 //>>RFC148
                 NFL(Dec2TextBGForeign(-AmountToPayLCY),11) +
                 BLK(10) +
                 TFR(CurrencyCode,3) +
                 Date2Text(DueDate,6) +
                 BLK(2) +
                 NFL(Dec2TextBGForeign(-AmountToPay),13));
            PPS."BG Foreign File Format"::"Handelsbanken UTLI":
              BEGIN
                IF TypeOfLine = '5' THEN
                  WriteFile(80,'5' +
                     NFL(VendNo,7) +
                     //>>RFC148
                     //TFR("External Document No.",25) +
                     ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
                     //>>RFC148
                     NFL(Dec2TextBGForeign(-AmountToPayLCY),11) +
                     BLK(10) +
                     TFR(CurrencyCode,3) +
                     Date2Text(DueDate,6) +
                     BLK(2) +
                     NFL(Dec2TextBGForeign(-AmountToPay),13))
                ELSE
                  WriteFile(80,'6' +
                     NFL(VendNo,7) +
                     //>>RFC148
                     //TFR("External Document No.",25) +
                     ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
                     //>>RFC148
                     NFL(Dec2TextBGForeign(-AmountToPayLCY),11) +
                     BLK(10) +
                     TFR(CurrencyCode,3) +
                     Date2Text(DueDate,6) +
                     BLK(1) +
                     '0' +
                     NFL(Dec2TextBGForeign(-AmountToPay),13) +
                     BLK(1) +
                     TFR(AmountCurrAccount,1));
              END;
            PPS."BG Foreign File Format"::"Nordea BGC",
            PPS."BG Foreign File Format"::"Nordea Axess":
              WriteFile(80,TFR(TypeOfLine,1) +
                 NFL(VendNo,7) +
                 //>>RFC148
                 //TFR("External Document No.",25) +
                 ExtDocNoOrPayRef("External Document No.","Payment Reference",25) +
                 //>>RFC148
                 NFL(Dec2TextBGForeign(-AmountToPayLCY),11) +
                 NFL('0',10) +
                 TFR(CurrencyCode,3) +
                 Date2Text(DueDate,6) +
                 BLK(2) +
                 NFL(Dec2TextBGForeign(-AmountToPay),13));
          END;

          WriteFile(80,'7' +
             NFL(VendNo,7) +
             TFR("Code for Bank of Sweden",3));
        UNTIL NEXT = 0;

        CASE PPS."BG Foreign File Format" OF
          PPS."BG Foreign File Format"::"Nordea Axess":
            WriteFile(80,'9' +
               BLK(7)+
               NFL(Dec2TextBGForeign(-TotalAmountLCY),12) +
               BLK(43) +
               NFL(Dec2TextBGForeign(-TotalAmount),15));
          ELSE
            WriteFile(80,'9' +
               NFL(ClearText(CompanyInfo."Giro No."),8)+
               NFL(Dec2TextBGForeign(-TotalAmountLCY),12) +
               BLK(42) +
               NFL(Dec2TextBGForeign(-TotalAmount),15));
        END;
      END;
    END;

    PROCEDURE CreateFilePGSweden@1070008(Pack@1070000 : Record 11128016;CurrencyCode@1070007 : Code[10];CurrencyFilter@1070008 : Text[260]);
    VAR
      VendLedgerEntry@1070001 : Record 25;
      PmtType@1070002 : Text[1];
      VendNo@1070003 : Code[20];
      PayByAccountNo@1070004 : Code[20];
      DueDate@1070005 : Date;
      CreditMemoDueDate@1070006 : Date;
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        RESET;
        SETCURRENTKEY("LB Giro Journal No.","Currency Code");
        SETRANGE("LB Giro Journal No.",Pack."Entry No.");
        SETFILTER("Currency Code",CurrencyFilter);
        IF NOT FIND('-') THEN
          EXIT;

        CLEAR(TotalAmount);
        CLEAR(NoOfLines);

        WriteFile(100,'0'+
          TFR(PostGiroCustNo,5)+
          Date2Text(TODAY,6)+
          Value1(Pack."No. per Date",1));

        WriteFile(100,'2'+
          TFR(PostGiroCustNo,5)+
          TFL(PostGiroNo,10)+
          BLK(2)+
          TFR(CompanyInfo.Name,27)+
          TFR(CompanyInfo."Phone No.",27)+
          TFR(CurrencyCode,3)+
          TFR(CurrencyCode,3));

        REPEAT
          CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)");
          Vendor.GET("Vendor No.");
      //ITERO.DL 140729
          Vendor.CALCFIELDS(IBAN);


          IF Currency.FIND('-') THEN BEGIN
            IF PPS."EUR Currency" = "Currency Code" THEN
              IF Vendor."Plus Giro No." = '' THEN
                ERROR(BA029,"Vendor No.");
          END ELSE
            TESTFIELD("Currency Code",'');
          CLEAR(Currency);

          PmtType := '3';
          IF Vendor."Plus Giro No." <> '' THEN BEGIN
            VendNo := ClearText(Vendor."Plus Giro No.");
            IF VendNo = '' THEN
              ERROR(BA022,Vendor.FIELDCAPTION("Plus Giro No."),Vendor."No.", Vendor.Name);
            IF NOT SumCheck10Control(VendNo) THEN
              ERROR(BA022,Vendor.FIELDCAPTION("Plus Giro No."),Vendor."No.", Vendor.Name);
          END ELSE BEGIN
            VendNo := CreateGiroNo(Vendor,Currency);
            IF (Vendor."Bank Giro No." = '') AND
               (Vendor.IBAN = '') THEN BEGIN
              PmtType := '5';
              WriteFile(100,'3'+
                TFR(PmtType,1)+
                BLK(5)+
                TFL(VendNo,10)+
                TFR(ClearText(Vendor."Post Code"),5)+
                TFR(Vendor.Name,33)+
                TFR(FillField(Vendor."Address 2",Vendor.Address),27)+
                TFR(Vendor.City,13));
            END ELSE BEGIN
              IF Vendor."Bank Giro No." <> '' THEN BEGIN
                PayByAccountNo := ClearText(Vendor."Bank Giro No.");
                IF NOT SumCheck10Control(PayByAccountNo) THEN
                  ERROR(BA022,Vendor."No.", Vendor.Name);
              END ELSE BEGIN
                PayByAccountNo := ClearText(Vendor.IBAN);
                IF "Remaining Amount" > 0 THEN
                  ERROR(BA031,Vendor.FIELDCAPTION(IBAN),Vendor."No.",Vendor.Name,"Document No.");
                IF STRLEN(PayByAccountNo) > 16 THEN
                  ERROR(BA030,Vendor.FIELDCAPTION(IBAN),Vendor."No.",Vendor.Name);
              END;
              PmtType := '4';
              WriteFile(100,'3'+
                TFR(PmtType,1)+
                BLK(5)+
                TFL(VendNo,10)+
                TFR(ClearText(Vendor."Post Code"),5)+
                TFR(Vendor.Name,33)+
                TFL(PayByAccountNo,16));
            END;
          END;

          //+++4PSSE
          IF "Document Type" ="Document Type"::"Credit Memo" THEN BEGIN
            DueDate := CALCDATE('<+1Y>',"Due Date");
          END ELSE IF "Due Date" < TODAY THEN BEGIN
          //IF "Due Date" < TODAY THEN BEGIN
          //---4PSSE
            DueDate := TODAY;
            "Due Date" := TODAY;
          END ELSE
            DueDate := "Due Date";

          AmountToPay := CalcAmountToPay(VendLedgerEntry);
          AmountToPayLCY := CalcAmountToPayLCY(VendLedgerEntry);

          TotalAmount := TotalAmount + AmountToPay;
          TotalAmountLCY := TotalAmountLCY + AmountToPayLCY;
          NoOfLines := NoOfLines + 1;

          IF "Remaining Amount" < 0  THEN // Invoice
            WriteFile(100,'5'+
              TFR(PmtType,1)+
              BLK(1)+
              TFR(CurrencyCode,3)+
              BLK(1)+
              TFL(VendNo,10)+
              //>>RFC148
              //TFR("External Document No.",27)+
              ExtDocNoOrPayRef("External Document No.","Payment Reference",27) +
              //>>RFC148
              NFL(Value100(AmountToPay,11),11)+
              Date2Text(DueDate,6)+
              TFR('Vernr: '+"Document No.",30))
          ELSE BEGIN                      // Credit Memo
            CreditMemoDueDate := DueDate;
            DueDate := TODAY;
            WriteFile(100,'6'+
              TFR(PmtType,1)+
              BLK(1)+
              TFR(CurrencyCode,3)+
              BLK(1)+
              TFL(VendNo,10)+
              //>>RFC148
              //TFR("External Document No.",27)+
              ExtDocNoOrPayRef("External Document No.","Payment Reference",27) +
              //>>RFC148
              NFL(Value100(AmountToPay,11),11)+
              Date2Text(DueDate,6)+
              Date2Text(CreditMemoDueDate,6)+
              TFR('Vernr: '+"Document No.",30));
          END;
        UNTIL NEXT = 0;

        WriteFile(100,'7'+
          TFR(PostGiroCustNo,5)+
          TFL(PostGiroNo,10)+
          BLK(2)+
          NFL(Value100(TotalAmount,12) + NegativeSign(-TotalAmount),13)+
          BLK(32)+
          TFR(CurrencyCode,3)+
          TFR(CurrencyCode,3));
      END;
    END;

    PROCEDURE CreateFilePGForeign@1070003(Pack@1070000 : Record 11128016);
    VAR
      VendLedgerEntry@1070001 : Record 25;
      PmtType@1070002 : Text[1];
      VendNo@1070003 : Code[20];
      ReceiverCode@1070004 : Text[33];
      ReceiverLine1@1070005 : Text[33];
      ReceiverLine2@1070006 : Text[33];
      ContractNo@1070007 : Text[6];
      TransferCode@1070008 : Text[1];
      DueDate@1070010 : Date;
      CreditMemoDueDate@1070011 : Date;
      CurrencyCode@1070012 : Code[10];
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        RESET;
        SETCURRENTKEY("LB Giro Journal No.","Currency Code");
        SETRANGE("LB Giro Journal No.",Pack."Entry No.");
        IF NOT FIND('-') THEN
          EXIT;

        WriteFile(100,'0'+
          TFR(PostGiroCustNo,5)+
          Date2Text(TODAY,6)+
          Value1(Pack."No. per Date",1));

        WriteFile(100,'1'+
          TFR(PostGiroCustNo,5)+
          TFL(ClearText(PostGiroNo),10)+
          BLK(2)+
          TFR(CompanyInfo.Name,27)+
          TFR(CompanyInfo."Phone No.",27)+
          TFR(CompanyInfo.City,15)+
          '22S'+
          TFL(ClearText(RegNo),10));

        REPEAT
          CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)");

          CLEAR(PmtType);
          CLEAR(VendNo);
          ReceiverCode := '1';
          CLEAR(ReceiverLine1);
          CLEAR(ReceiverLine2);
          CLEAR(ContractNo);
          TransferCode := '1';

          Vendor.GET("Vendor No.");
      //ITERO.DL 140729
          Vendor.CALCFIELDS(IBAN);

          // LRS 051211
          //IF "Currency Code" = '' THEN BEGIN
          IF LocalCurr("Currency Code") THEN BEGIN
          // LRS
            CLEAR(Currency);
            CurrencyCode := 'SEK'
          END ELSE BEGIN
            Currency.GET("Currency Code");
            CurrencyCode := "Currency Code";
          END;

          VendNo := CreateGiroNo(Vendor,Currency);

          IF "Code for Bank of Sweden" = '' THEN
            ERROR(BA026,
                  "Document Type","External Document No.","Document No.",Vendor."No.",Vendor.Name);

          CASE Vendor."Payment Type" OF
            Vendor."Payment Type"::Account: PmtType := '0';
            Vendor."Payment Type"::"Postal Check": PmtType := '7';
            Vendor."Payment Type"::Check: PmtType := '9';
          END;

          IF Vendor."Payment Type" = Vendor."Payment Type"::Account THEN BEGIN     // SWIFT, Account
            ReceiverLine1 := Vendor.IBAN;
            Vendor.TESTFIELD(Name);
            ReceiverLine2 := Vendor.Name;
            IF Vendor."Payment Method" = Vendor."Payment Method"::Express THEN
              ReceiverCode := '2';
          END ELSE
            ReceiverLine1 := Vendor.Name;

          IF Vendor."Currency Account" THEN BEGIN
            Currency.TESTFIELD("No. of Forward Agreement");
            ContractNo := Currency."No. of Forward Agreement";
          END;

          WriteFile(100,'2'+
            TFR(PmtType,1)+
            TFR(VendNo,15)+
            BLK(5)+
            TFR(ReceiverCode,1)+
            TFR(ReceiverLine1,33)+
            TFR(ReceiverLine2,33)+
            BLK(3)+
            TFR(ContractNo,6));

          IF Vendor."Payment Type" = Vendor."Payment Type"::Account THEN  //SWIFT, Account
            WriteFile(100,'3'+
              TFR(PmtType,1)+
              TFR(VendNo,15)+
              TFR(Vendor.Bank,33)+
              TFR(Vendor."Bank Addr. (Post Code + City)",22)+
              BLK(10)+
              TFR(Vendor."Country/Region Code",2)+
              TFR("Document No.",13))
          ELSE
            WriteFile(100,'3'+
              TFR(PmtType,1)+
              TFR(VendNo,15)+
              TFR(FillField(Vendor."Address 2",Vendor.Address),33)+
              TFR((Vendor."Post Code"+' '+Vendor.City),22)+
              BLK(10)+
              TFR(Vendor."Country/Region Code",2)+
              TFR("Document No.",13));

          //+++4PSSE
          IF "Document Type" ="Document Type"::"Credit Memo" THEN BEGIN
            DueDate := CALCDATE('<+1Y>',"Due Date");
          END ELSE IF "Due Date" < TODAY THEN BEGIN
          //IF "Due Date" < TODAY THEN BEGIN
          //---4PSSE
            DueDate := TODAY;
            "Due Date" := TODAY;
          END ELSE
            DueDate := "Due Date";

          AmountToPay := CalcAmountToPay(VendLedgerEntry);
          AmountToPayLCY := CalcAmountToPayLCY(VendLedgerEntry);

          IF CurrencyCode = 'SEK' THEN BEGIN
            AmountToPay := 0;
            TransferCode := '2';
          END;

          TotalAmount += AmountToPay;
          TotalAmountLCY += AmountToPayLCY;
          NoOfLines += 1;

          IF "Remaining Amount" < 0  THEN BEGIN // Invoice
            IF Vendor."Payment Type" = Vendor."Payment Type"::Account THEN  //SWIFT, Account
              WriteFile(100,'5'+
                TFR(PmtType,1)+
                TFR(VendNo,15)+
                TFR(Vendor."SWIFT Address/BIC Code",33));

            WriteFile(100,'5'+
              TFR(PmtType,1)+
              TFR(VendNo,15)+
              //>>RFC148
              //TFR("External Document No.",33)+
              ExtDocNoOrPayRef("External Document No.","Payment Reference",33) +
              //>>RFC148
              BLK(2)+
              NFL(Value100(AmountToPayLCY,11),11)+
              Date2Text(DueDate,6)+
              BLK(2)+
              NFL(Value100(AmountToPay,15),15)+
              TFR(CurrencyCode,3)+
              TFR(TransferCode,1)+
              '2'+
              TFR("Code for Bank of Sweden",3));
          END ELSE BEGIN                        // Credit Memo
            CreditMemoDueDate := DueDate;
            DueDate := TODAY;
            WriteFile(100,'6'+
              TFR(PmtType,1)+
              TFR(VendNo,15)+
              //>>RFC148
              //TFR("External Document No.",33)+
              ExtDocNoOrPayRef("External Document No.","Payment Reference",33) +
              //>>RFC148
              BLK(2)+
              NFL(Value100(AmountToPayLCY,11),11)+
              Date2Text(DueDate,6)+
              Date2Text(CreditMemoDueDate,6)+
              BLK(2)+
              NFL(Value100(AmountToPay,15),15)+
              TFR(CurrencyCode,3)+
              TFR(TransferCode,1)+
              TFR("Code for Bank of Sweden",3));
          END;
        UNTIL NEXT = 0;
        WriteFile(100,'7'+
          TFR(PostGiroCustNo,5)+
          TFL(ClearText(PostGiroNo),10)+
          BLK(2)+'S'+BLK(1)+
          NFL(Value100(TotalAmountLCY,12) + NegativeSign(-TotalAmountLCY),13)+
          BLK(2)+
          NFL(Value100(TotalAmount,16) + NegativeSign(-TotalAmount),17)+
          BLK(27)+
          '1'+
          BLK(7)+
          '2');
      END;
    END;

    PROCEDURE CalcAmountToPay@1070041(VendLedgerEntry@1070000 : Record 25) : Decimal;
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        CALCFIELDS("Remaining Amount");
        IF ("Document Type" = "Document Type"::Invoice) AND
           ("Due Date" <= "Pmt. Discount Date") THEN
          EXIT("Remaining Amount" - "Remaining Pmt. Disc. Possible")
        ELSE
          EXIT("Remaining Amount");
      END;
    END;

    PROCEDURE CalcAmountToPayLCY@1070042(VendLedgerEntry@1070000 : Record 25) : Decimal;
    BEGIN
      WITH VendLedgerEntry DO BEGIN
        CALCFIELDS("Remaining Amount","Remaining Amt. (LCY)");
        IF ("Document Type" = "Document Type"::Invoice) AND
           ("Due Date" <= "Pmt. Discount Date") THEN
        BEGIN
          IF "Remaining Amount" <> "Remaining Amt. (LCY)" THEN
            EXIT("Remaining Amt. (LCY)" - ROUND(
                    CurrencyExchangeRate.ExchangeAmtFCYToLCY(
      //**4PSSE
      //              TODAY,"Currency Code",
      //              "Remaining Pmt. Disc. Possible",CurrencyExchangeRate.ExchangeRate(TODAY,"Currency Code"))))
                    0,'',TODAY,"Currency Code",
                    "Remaining Pmt. Disc. Possible",CurrencyExchangeRate.ExchangeRate(0,'',TODAY,"Currency Code",TRUE),TRUE)))
      //**4PSSE
          ELSE
            EXIT("Remaining Amount" - "Remaining Pmt. Disc. Possible");
        END ELSE
          EXIT("Remaining Amt. (LCY)");
      END;
    END;

    PROCEDURE CalcAmountToPayGJLrec@1070043(GenJournalLine@1070000 : Record 81) : Decimal;
    VAR
      VendLedgerEntry@1070001 : Record 25;
    BEGIN
      GenJournalLine.TESTFIELD("LB Ledger Entry No.");
      VendLedgerEntry.GET(GenJournalLine."LB Ledger Entry No.");
      VendLedgerEntry."Due Date" := GenJournalLine."Due Date";
      EXIT(-CalcAmountToPay(VendLedgerEntry));
    END;

    PROCEDURE LocalCurr@1070044(CurrencyCode@1070000 : Code[10]) : Boolean;
    VAR
      GeneralLedgerSetup@1070001 : Record 98;
    BEGIN
      IF CurrencyCode = '' THEN
        EXIT(TRUE);

      GeneralLedgerSetup.GET;
      GeneralLedgerSetup.TESTFIELD("LCY Code");
      EXIT(CurrencyCode =  GeneralLedgerSetup."LCY Code");
    END;

    LOCAL PROCEDURE ExtDocNoOrPayRef@1000000000(ExtDocNo@1000000000 : Code[35];PayRef@1000000001 : Code[50];TFRlen@1000000002 : Integer) : Text;
    VAR
      Text@1100285300 : Text;
    BEGIN
      //RFC148
      IF PayRef <> '' THEN
        Text := TFR(PayRef,TFRlen)
      ELSE
        Text := TFR(ExtDocNo,TFRlen);

      EXIT(Text);
    END;

    BEGIN
    {
      4PSSE
      Adjusted call to function ExchangeRate in table CurrencyExchangeRate.

      *** I016 ***
      131023 Added code for new LB Girotype "SEPA" to export from XML port instead of file.
      4PSSE.MK 131018 When creating a credit memo the due date in the file is moved 1 year forward

      140729 ITERO.DL found an issue that "Bank Account No./IBAN" has to be retreived from other table
      150303 ITERO.DL IME297 export files as ASCII instead of defalut ANSI, gStreamWriter
      150320 ITERO.DL IME297 IBAN not exported first time for each vendor, CreateGiroNo() resets FlowField
      160726 ITERO.DL RFC114 SEPA payments from SweBase 6.03
      160929 ITERO.DL RFC148 handle Payment Reference for more countries
                      RFC155 The new file format (pain001) for supplier payments does not support Norwegian requirements
    }
    END.
  }
}

