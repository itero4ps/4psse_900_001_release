OBJECT Codeunit 12013601 ExFlow
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=EXF350003,NAV2013,4PS;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      AppSetUp@1100285004 : Record 12013601;
      GLSetup@1100285012 : Record 98;
      EXPurchImpHeaderArchive@1100285027 : Record 12013650;
      PurchInvHeader@1100285026 : Record 122;
      PurchCrMemoHeader@1100285024 : Record 124;
      ExFlowBLOB@1100285023 : Record 12013591;
      ExFlowDimMgt@1100285008 : Codeunit 12013605;
      Txt03@1000000009 : TextConst 'ENU=Only superior users can complete the invoice.';
      EXF41@1100285002 : TextConst 'ENU=Warning! The line has been approved!\\Do you still want to update line?';
      EXF43@1100285014 : TextConst 'ENU=Type is not allowed!';
      EXF44@1100285015 : TextConst 'ENU=Approver %1 can not be restarted!';
      EXF50@1100285017 : TextConst 'ENU=Failed to create folder %1 while moving attached file %2.';
      EXF51@1100285018 : TextConst 'ENU=Failed to create folder %1.';
      EXF55@1100285020 : TextConst 'ENU=%1';
      EXF56@1100285001 : TextConst 'ENU=The amount on an approved line cannot be changed! The line has to be restarted first.';
      EXF57@1100285025 : TextConst 'ENU=Copying transactions   @1@@@@@@@@@@@@@@@@@@@@@@@';
      EXF60@1100285028 : TextConst 'ENU=No G/L Account No. could be found for line %1 %2 %3.';
      EXF61@1100285029 : TextConst 'ENU=Document Type: %1. Document No: %2.';
      EXF62@1100285031 : TextConst 'ENU=Warning! Invoice has been approved.\\Do you want to delete all approvers?';
      EXF63@1100285030 : TextConst 'ENU=You do not have permisson to remove the approval flow.';
      EXF64@1100285009 : TextConst 'ENU=The document can not be sent for approval because image is missing.';
      EXF65@1100285033 : TextConst 'ENU=Line cannot be set for Approval!';
      EXF66@1100285032 : TextConst 'ENU=User %1 does not have permission to make this change!';
      EXF67@1100285003 : TextConst 'ENU=Warning! The row is approved. \\Do you still want to delete this lines approvers?';
      EXF68@1100285006 : TextConst 'ENU=Approval Group %1 does no exist!';
      EXF69@1100285005 : TextConst 'ENU=Approval Group %1 is blocked!';
      EXF70@1100285007 : TextConst 'ENU=Line Type %1 is not setup for ExFlow.';
      GLSetupRetrieved@1100285011 : Boolean;
      EXF71@1100285010 : TextConst 'ENU=User %1 has an invalid coding rule!';
      EXF72@1100285016 : TextConst 'ENU=System error, can not insert Ex Document record.';
      EXF73@1100285019 : TextConst 'ENU=Operation aborted.';
      EXF74@1100285021 : TextConst 'ENU=Can not find ExFlow document for order %1.';
      EXF75@1100285000 : TextConst 'ENU=Warning! The row is approved. \\Do you still want to delete this lines approvers?';
      EXF76@1100285013 : TextConst 'ENU=Line not deleted.';
      EXF77@1100285022 : TextConst 'ENU=Are you sure you want to remove the approval flag?';

    PROCEDURE FinishApprover@1000000007(VAR DocLine@1000000003 : Record 12013609;NewComment@1100285002 : Text[180]);
    VAR
      DocLineApp@1100285000 : Record 12013610;
    BEGIN
      IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
        ERROR(Txt03);

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document Line ID");
      DocLineApp.SETRANGE("Document Line ID", DocLine.ID);
      IF DocLineApp.FINDSET(TRUE) THEN
        REPEAT
          IF DocLineApp."Approved By" = '' THEN
            BEGIN
              DocLineApp."Approval Date" := CREATEDATETIME(WORKDATE,TIME);
              DocLineApp."Approved By" := USERID;
              DocLineApp.Flowstatus := DocLineApp.Flowstatus::Approved;
              DocLineApp.Comment := NewComment;
              DocLineApp.MODIFY(FALSE);
            END;

          IF DocLineApp.Flowstatus = DocLineApp.Flowstatus::Rejected THEN
            BEGIN
              DocLineApp.Flowstatus := DocLineApp.Flowstatus::Approved;
              DocLineApp.MODIFY(FALSE);
            END;
        UNTIL DocLineApp.NEXT = 0
      ELSE
        BEGIN
          DocLineApp.INIT;
          DocLineApp."Company Name" := DocLine."Company Name";
          DocLineApp."Document Type" := DocLine."Document Type";
          DocLineApp."Document No." := DocLine."Document No.";
          DocLineApp."Line No." := DocLine."Line No.";
          DocLineApp."Approver Order" := 10000;
          DocLineApp.Approver := USERID;
          DocLineApp."Approval Date" := CREATEDATETIME(WORKDATE,TIME);
          DocLineApp."Approved By" := USERID;
          DocLineApp.Flowstatus := DocLineApp.Flowstatus::Approved;
          DocLineApp.Comment := NewComment;
          DocLineApp."Document Line ID" := DocLine.ID;
          DocLineApp."Document ID" := DocLine."Document ID";
          DocLineApp.ID := 0;
          DocLineApp.INSERT;
        END;

      DocLine.Flowstatus := DocLine.Flowstatus::Approved;
      DocLine.MODIFY(FALSE);
    END;

    PROCEDURE RestartApprover@1100285000(DocLine@1100285000 : Record 12013609;ApproverOrder@1100285001 : Integer;OnlyOneApprover@1100285004 : Boolean);
    VAR
      DocLineApprover@1100285002 : Record 12013610;
      First@1100285003 : Boolean;
      AppGroup@1100285005 : Record 12013606;
      ExflowToInvoice@1100285006 : Codeunit 12013592;
    BEGIN
      DocLineApprover.RESET;
      DocLineApprover.SETCURRENTKEY("Company Name","Document Type","Document No.","Line No.","Approver Order");
      DocLineApprover.SETRANGE("Company Name",DocLine."Company Name");
      DocLineApprover.SETRANGE("Document Type",DocLine."Document Type");
      DocLineApprover.SETRANGE("Document No.",DocLine."Document No.");
      DocLineApprover.SETRANGE("Line No.",DocLine."Line No.");
      IF OnlyOneApprover THEN
        BEGIN
          DocLineApprover.SETFILTER("Approver Order",'>%1', ApproverOrder);
          DocLineApprover.SETFILTER("Approved By", '<>%1','');
          IF DocLineApprover.FIND('-') THEN
            ERROR(STRSUBSTNO(EXF44,DocLineApprover.Approver));
        END;

      DocLineApprover.RESET;
      DocLineApprover.SETCURRENTKEY("Company Name","Document Type","Document No.","Line No.","Approver Order");
      DocLineApprover.SETRANGE("Company Name",DocLine."Company Name");
      DocLineApprover.SETRANGE("Document Type",DocLine."Document Type");
      DocLineApprover.SETRANGE("Document No.",DocLine."Document No.");
      DocLineApprover.SETRANGE("Line No.",DocLine."Line No.");
      IF ApproverOrder <> 0 THEN
        DocLineApprover.SETFILTER("Approver Order",'%1..', ApproverOrder);

      First := TRUE;

      DocLineApprover.LOCKTABLE;
      IF DocLineApprover.FIND('-') THEN
        REPEAT
          DocLineApprover."Approval Date" := CREATEDATETIME(0D,0T);
          DocLineApprover."Approved By" := '';
          DocLineApprover."Reminder Sent Date" := CREATEDATETIME(0D, 0T);
          DocLineApprover."Reminder Status" := 0;
          DocLineApprover."No. of Reminders" := 0;
          DocLineApprover.Flowstatus := DocLineApprover.Flowstatus::"Not processed";

          AppGroup.GET(COMPANYNAME,DocLineApprover.Approver);

          IF AppGroup.Blocked THEN
            ERROR(STRSUBSTNO(EXF44,DocLineApprover.Approver));

          IF AppGroup."Auto Approve" THEN
            ExflowToInvoice.AutoApproveGrp(DocLineApprover,AppGroup.Code, AppGroup."Auto Approve Comment")
          ELSE IF First THEN
            BEGIN
              First := FALSE;
              DocLineApprover.VALIDATE(Flowstatus,DocLineApprover.Flowstatus::Current);
              AppSetUp.GET(COMPANYNAME,0);
              IF DocLineApprover.Comment = AppSetUp."Escalation Text" THEN
                DocLineApprover.Comment := '';
            END;

          DocLineApprover.MODIFY(FALSE);
        UNTIL DocLineApprover.NEXT =0;

      DocLineApprover.ApprovalStatus(DocLineApprover,'Update');
    END;

    PROCEDURE UpdateLine@1000000002(VAR PurchLine@1000000000 : Record 39;xPurchLine@1100285002 : Record 39;SilentMode@1100285008 : Boolean);
    VAR
      PurchHeader@1100285009 : Record 38;
      DocLine@1100285001 : Record 12013609;
      Show@1100285000 : Boolean;
    BEGIN
      Show := FALSE;
      AppSetUp.GET(COMPANYNAME,0);

      IF PurchLine."Document Type" = PurchLine."Document Type"::"Blanket Order" THEN
        EXIT;

      IF (NOT PurchLine.Approve) OR (PurchLine.Type = 0) THEN
        BEGIN
          IF DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
            DocLine.DELETE(TRUE);
          EXIT;
        END;

      PurchHeader.GET(PurchLine."Document Type",PurchLine."Document No.");
      IF NOT PurchHeader.Approve THEN
        EXIT;

      IF PurchHeader."New Line" THEN
        SilentMode := TRUE;

      IF NOT DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
        BEGIN
          CreateDocumentLine(PurchLine,FALSE,TRUE);
          Show := TRUE;
        END;

      DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");

      // Test if Approved
      TestifApproved(PurchLine,xPurchLine,DocLine,AppSetUp,SilentMode);

      IF NOT CheckMinAppAmount(PurchLine,PurchHeader) THEN
        EXIT;

      // Update all Approvalfields
      DocLine."Company Name" := COMPANYNAME;
      DocLine."Document Type" := PurchLine."Document Type";
      DocLine."Document No." := PurchLine."Document No.";
      DocLine."Line No." := PurchLine."Line No.";

      DocLine."Line Type" := PurchLine.Type;
      DocLine."No." := PurchLine."No.";
      IF PurchLine.Description <> DocLine.GetName THEN
        DocLine.Description := PurchLine.Description + PurchLine."Description 2"
      ELSE
        DocLine.Description := '';
      DocLine.Quantity := PurchLine.Quantity;
      DocLine."Direct Unit Cost" := PurchLine."Direct Unit Cost";
      DocLine.Amount := PurchLine."Line Amount";
      DocLine."Line Discount %" := PurchLine."Line Discount %";

      DocLine."Job No." := PurchLine."Job No.";
      DocLine."Periodic Template Code" := PurchLine."Periodic Template Code";
      DocLine."Periodic Starting Date" := PurchLine."Periodic Starting Date";

      //348893
      // IF PurchLine."Order No." <> '' THEN BEGIN
      //   DocLine."Order No." := PurchLine."Order No.";
      //   IF PurchOrderLine.GET(PurchOrderLine."Document Type"::Order,PurchLine."Order No.",PurchLine."Order Line No.") THEN
      //     DocLine."Order Unit Cost" := PurchOrderLine."Direct Unit Cost"
      // END
      // ELSE BEGIN
      //   IF PurchLine."Receipt No." <> '' THEN
      //     IF ReceiptLine.GET(PurchLine."Receipt No.",PurchLine."Receipt Line No.") THEN BEGIN
      //       DocLine."Order No." := ReceiptLine."Order No.";
      //       DocLine."Order Unit Cost" := ReceiptLine."Direct Unit Cost";
      //       PurchLine."Order No." := ReceiptLine."Order No.";
      //       PurchLine."Order Line No." := ReceiptLine."Order Line No.";
      //     END;
      // END;
      //348893

      // BASE
      // DocLine.Base_StartingDate :=
      // DocLine.Base_TemporaryAccountNo :=
      // DocLine.Base_Periods :=

      DocLine.MODIFY(TRUE);

      CreateApprovers(DocLine, PurchLine,'',TRUE,'','',Show);
      DocLine.SetDocumentStatus(DocLine);
      UpdateDocLineDim(DocLine,PurchLine);

      IF GUIALLOWED AND (NOT SilentMode) THEN
        IF AppSetUp."Show Approvers Automatically" AND Show THEN
          BEGIN
            COMMIT;
            DocLine.RESET;
            DocLine.SETRANGE("Company Name", COMPANYNAME);
            DocLine.SETRANGE("Document Type",PurchLine."Document Type");
            DocLine.SETRANGE("Document No.",PurchLine."Document No.");
            DocLine.SETRANGE("Line No.",PurchLine."Line No.");
            PAGE.RUNMODAL(12013609,DocLine);
          END;
    END;

    PROCEDURE CreateDocument@1100285001(VAR PurchHeader@1100285000 : Record 38);
    VAR
      DocHead@1100285001 : Record 12013608;
      DocHead2@1100285002 : Record 12013608;
      ExDocHead2@1100285004 : Record 12013612;
      ExFlowSEMgt@1100285003 : Codeunit 12013598;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      DocHead2.RESET;
      DocHead2.SETCURRENTKEY("Document No.");
      DocHead2.SETRANGE("Company Name",COMPANYNAME);
      DocHead2.SETRANGE("Document Type",PurchHeader."Document Type");
      DocHead2.SETRANGE("Document No.",PurchHeader."No.");
      IF NOT DocHead2.FINDFIRST THEN BEGIN
        DocHead.INIT;
        DocHead.ID := 0;
        DocHead."Company Name" := COMPANYNAME;
        DocHead."Document Type" := PurchHeader."Document Type";
        DocHead."Document No." := PurchHeader."No.";
        DocHead.INSERT;
      END ELSE
        ERROR(EXF72);

      DocHead.RetrieveRecord(DocHead,COMPANYNAME,PurchHeader."Document Type",PurchHeader."No.");
      DocHead.Initiator := USERID;
      DocHead."Vendor No." := PurchHeader."Buy-from Vendor No.";
      DocHead."Vendor Name" := PurchHeader."Buy-from Vendor Name";
      DocHead."Admin Comment" := '';
      DocHead."Create Date" := WORKDATE;
      DocHead."Due Date" := PurchHeader."Due Date";
      DocHead."Posting Date" := PurchHeader."Posting Date";
      DocHead."Document Date" := PurchHeader."Document Date";
      DocHead."Expected Receipt Date" := PurchHeader."Expected Receipt Date";
      DocHead.Status := 0;
      DocHead."Predefind Posting No." := '';
      IF PurchHeader."Currency Code" <> '' THEN
        DocHead."Currency Code" := PurchHeader."Currency Code"
      ELSE
        IF AppSetUp."Show LCY Curr Web" THEN BEGIN
          GetGLSetup;
          DocHead."Currency Code" := GLSetup."LCY Code";
        END
        ELSE
          DocHead."Currency Code" := '';

      IF PurchHeader."Document Type" = PurchHeader."Document Type"::"Credit Memo" THEN
        DocHead."Vendor Document No." := PurchHeader."Vendor Cr. Memo No."
      ELSE
        DocHead."Vendor Document No." := PurchHeader."Vendor Invoice No.";

      DocHead."Image Name" := GetPurchHeaderImageName(COMPANYNAME,PurchHeader."Document Type",PurchHeader."No.");

      IF (DocHead."Document Type" = DocHead."Document Type"::Invoice) OR
         (DocHead."Document Type" = DocHead."Document Type"::"Credit Memo") THEN
        BEGIN
          DocHead."Net Amount" := ABS(PurchHeader."Gross Invoice Amount ExFlow") - ABS(PurchHeader."Import VAT Amount");
          DocHead."VAT Amount" := ABS(PurchHeader."Import VAT Amount");
          DocHead."Gross Amount" := DocHead."Net Amount" + DocHead."VAT Amount";
        END;

      DocHead.MODIFY(TRUE);

      ExFlowSEMgt.UpdateSWEBASE(PurchHeader);

      ExDocHead2.RESET;
      ExDocHead2.SETCURRENTKEY("Document No.");
      ExDocHead2.SETRANGE("Company Name",DocHead."Company Name");
      ExDocHead2.SETRANGE("Document Type",DocHead."Document Type");
      ExDocHead2.SETRANGE("Document No.",DocHead."Document No.");
      IF NOT ExDocHead2.FINDFIRST THEN BEGIN
        ExDocHead2.INIT;
        ExDocHead2."Entry No." := 0;
        ExDocHead2."Company Name" := DocHead."Company Name";
        ExDocHead2."Document Type" := DocHead."Document Type";
        ExDocHead2."Document No." := DocHead."Document No.";
        ExDocHead2."Image Name" := DocHead."Image Name";
        ExDocHead2.INSERT;
      END
      ELSE BEGIN
        ExDocHead2."Image Name" := DocHead."Image Name";
        ExDocHead2.MODIFY;
      END;
    END;

    PROCEDURE UpdateDocument@1000000003(VAR PurchHeader@1000000000 : Record 38);
    VAR
      DocHead@1100285001 : Record 12013608;
      ExflowSetup@1100285002 : Record 12013601;
      ExDocPurchMapping@1100285000 : Record 12013617;
      ExFlowSEMgt@1100285007 : Codeunit 12013598;
      FldRef@1100285006 : FieldRef;
      RecRef@1100285003 : RecordRef;
      MapToFldRef@1100285005 : FieldRef;
      MapToRecRef@1100285004 : RecordRef;
    BEGIN
      IF NOT DocHead.RetrieveRecord(DocHead,COMPANYNAME,PurchHeader."Document Type",PurchHeader."No.") THEN
        BEGIN
          IF PurchHeader.Approve THEN
            CreateDocument(PurchHeader);

          EXIT;
        END
      ELSE
        IF NOT PurchHeader.Approve THEN
          BEGIN
            DocHead.DELETE(TRUE);
            EXIT;
          END;

      ExflowSetup.GET(COMPANYNAME,0);

      DocHead."Company Name" := COMPANYNAME;
      DocHead."Document Type" := PurchHeader."Document Type";
      DocHead."Document No." := PurchHeader."No.";

      IF DocHead.Initiator = '' THEN
        DocHead.Initiator := USERID;

      DocHead."Vendor No." := PurchHeader."Buy-from Vendor No.";
      DocHead."Vendor Name" := PurchHeader."Buy-from Vendor Name";

      DocHead."Due Date" := PurchHeader."Due Date";
      DocHead."Posting Date" := PurchHeader."Posting Date";
      DocHead."Document Date" := PurchHeader."Document Date";
      DocHead."Expected Receipt Date" := PurchHeader."Expected Receipt Date";

      IF PurchHeader."Currency Code" <> '' THEN
        DocHead."Currency Code" := PurchHeader."Currency Code"
      ELSE
        IF ExflowSetup."Show LCY Curr Web" THEN BEGIN
          GetGLSetup;
          DocHead."Currency Code" := GLSetup."LCY Code";
        END
        //348860
        ELSE
          DocHead."Currency Code" := '';
        //348860

      IF PurchHeader."Document Type" = PurchHeader."Document Type"::"Credit Memo" THEN
        DocHead."Vendor Document No." := PurchHeader."Vendor Cr. Memo No."
      ELSE
        DocHead."Vendor Document No." := PurchHeader."Vendor Invoice No.";

      ExFlowSEMgt.UpdateSWEBASEOrExF(PurchHeader,DocHead);

      DocHead."Net Amount" := PurchHeader."Gross Invoice Amount ExFlow" - PurchHeader."Import VAT Amount";
      DocHead."VAT Amount" := PurchHeader."Import VAT Amount";
      DocHead."Gross Amount" := DocHead."Net Amount" + DocHead."VAT Amount";
      DocHead.MODIFY(TRUE);

      ExDocPurchMapping.RESET;
      IF ExDocPurchMapping.FINDSET THEN BEGIN
        PurchHeader.MODIFY;
        RecRef.GETTABLE(PurchHeader);
        MapToRecRef.GETTABLE(DocHead);
        REPEAT
          FldRef := RecRef.FIELD(ExDocPurchMapping."Map to Field No.");
          MapToFldRef := MapToRecRef.FIELD(ExDocPurchMapping."Field No.");
          MapToFldRef.VALUE := FldRef.VALUE;
        UNTIL ExDocPurchMapping.NEXT = 0;
        MapToRecRef.MODIFY;
        MapToRecRef.CLOSE;
        RecRef.CLOSE;
        PurchHeader.GET(PurchHeader."Document Type",PurchHeader."No.");
      END;
    END;

    PROCEDURE GetDimIndex@1000000013(Dim@1000000000 : Code[20];VAR Index@1000000001 : Integer);
    VAR
      GeneralLedgerSetup@1100285000 : Record 98;
    BEGIN
      GeneralLedgerSetup.GET;
      Index := 0;

      IF Dim = '' THEN
        EXIT;

      IF Dim = GeneralLedgerSetup."Shortcut Dimension 1 Code" THEN
        Index := 1;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 2 Code" THEN
        Index := 2;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 3 Code" THEN
        Index := 3;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 4 Code" THEN
        Index := 4;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 5 Code" THEN
        Index := 5;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 6 Code" THEN
        Index := 6;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 7 Code" THEN
        Index := 7;
      IF Dim = GeneralLedgerSetup."Shortcut Dimension 8 Code" THEN
        Index := 8;
    END;

    PROCEDURE DayMap@1000000018(InDate@1000000000 : Date) : Text[128];
    VAR
      Year@1000000003 : Integer;
      Week@1000000009 : Integer;
      Temp@1000000008 : Text[30];
      TxtYear@1000000011 : Text[4];
      TxtWeek@1000000012 : Text[2];
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      Week := DATE2DWY(InDate, 2);
      Year := DATE2DWY(InDate, 3);
      TxtYear := FORMAT(Year);

      IF STRLEN(TxtYear) = 2 THEN
        TxtYear := '20' + TxtYear;

      TxtWeek := FORMAT(Week);

      IF STRLEN(TxtWeek) = 1 THEN
        TxtWeek := '0' + TxtWeek;

      Temp := TxtYear + '\' + TxtWeek + '\';
      EXIT(Temp);
    END;

    PROCEDURE ShowDocument@1000000021(Eage@1000000000 : Code[6];ImageName@1000000001 : Text[250]);
    VAR
      Argument@1000000003 : Text[250];
      ExFlowFileMgt@1100285000 : Codeunit 12013602;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      CASE Eage OF
        'NEW' :
          Argument := AppSetUp."Path to New Invoices" + ImageName;

        'OCR' :
          Argument := AppSetUp."Path to New OCR-files" + ImageName;

        'ATT' :
          Argument := AppSetUp."Path to Attached Files" + ImageName;

        'OLDATT' :
          Argument := AppSetUp."Path to connected Att. Files" + ImageName;
        ELSE
          Argument := AppSetUp."Path to Used Invoices" + ImageName;
      END;

      ExFlowFileMgt.ShowDoc(Argument);
    END;

    PROCEDURE ShowImageDocument@1100285073(CompName@1100285003 : Text[50];DocType@1100285002 : Integer;DocNo@1100285001 : Code[20]);
    VAR
      TempImageName@1100285000 : Text[1024];
    BEGIN
      TempImageName := GetPurchHeaderImageName(CompName,DocType,DocNo);
      IF TempImageName <> '' THEN
        ShowDocument('OLD',TempImageName);
    END;

    PROCEDURE ShowImagePostedDoc@1100285075(CompName@1100285003 : Text[50];DocType@1100285002 : Integer;DocNo@1100285001 : Code[20]);
    VAR
      TempImageName@1100285000 : Text[1024];
    BEGIN
      TempImageName := GetPostedImageName(CompName,DocType,DocNo);
      IF TempImageName <> '' THEN
        ShowDocument('OLD',TempImageName);
    END;

    PROCEDURE Approve@1000000011(PurchLine@1000000000 : Record 39);
    VAR
      DocLine@1100285000 : Record 12013609;
    BEGIN
      WITH PurchLine DO
        BEGIN
          IF Approve THEN BEGIN
            IF NOT DocLine.RetrieveRecord(DocLine,COMPANYNAME,"Document Type","Document No.","Line No.") THEN BEGIN
              CreateDocumentLine(PurchLine,FALSE,TRUE);
              COMMIT;
            END;

            DocLine.RESET;
            DocLine.SETRANGE("Company Name",COMPANYNAME);
            DocLine.SETRANGE("Document Type",PurchLine."Document Type");
            DocLine.SETRANGE("Document No.",PurchLine."Document No.");
            DocLine.SETRANGE("Line No.",PurchLine."Line No.");
            PAGE.RUNMODAL(12013609,DocLine);
          END;
        END;
    END;

    PROCEDURE ApprovePostedInvoice@1100285009(PostedInvoiceLine@1000000000 : Record 123);
    VAR
      DocLine@1100285000 : Record 12013609;
    BEGIN
      WITH PostedInvoiceLine DO
        BEGIN
          IF Approve THEN BEGIN
            DocLine.RetrieveRecord(DocLine,COMPANYNAME,DocLine."Document Type"::"Posted Invoice","Document No.","Line No.");

            DocLine.RESET;
            DocLine.SETRANGE("Company Name",COMPANYNAME);
            DocLine.SETRANGE("Document Type",DocLine."Document Type"::"Posted Invoice");
            DocLine.SETRANGE("Document No.","Document No.");
            DocLine.SETRANGE("Line No.","Line No.");
            PAGE.RUNMODAL(12013658,DocLine);
          END;
        END;
    END;

    PROCEDURE ApprovePostedCM@1100285011(PostedCMLine@1000000000 : Record 125);
    VAR
      DocLine@1100285000 : Record 12013609;
    BEGIN
      WITH PostedCMLine DO
        BEGIN
          IF Approve THEN BEGIN
            DocLine.RetrieveRecord(DocLine,COMPANYNAME,DocLine."Document Type"::"Posted Credit Memo","Document No.","Line No.");

            DocLine.RESET;
            DocLine.SETRANGE("Company Name",COMPANYNAME);
            DocLine.SETRANGE("Document Type",DocLine."Document Type"::"Posted Credit Memo");
            DocLine.SETRANGE("Document No.","Document No.");
            DocLine.SETRANGE("Line No.","Line No.");
            PAGE.RUNMODAL(12013658,DocLine);
          END;
        END;
    END;

    PROCEDURE CreateDocumentLine@1100285005(VAR PurchLine@1100285000 : Record 39;Show@1100285008 : Boolean;CreateApproverLines@1100285011 : Boolean);
    VAR
      DocHead@1100285001 : Record 12013608;
      DocLine@1100285002 : Record 12013609;
      DocLine2@1100285006 : Record 12013609;
      DocLine3@1100285007 : Record 12013609;
      PurchHeader@1100285004 : Record 38;
      PurchOrderLine@1100285010 : Record 39;
      FreeLine@1100285005 : Integer;
      ReceiptLine@1100285003 : Record 121;
      cuUpdatePurchaseLine@1100285009 : Codeunit 12013609;
    BEGIN
      IF NOT PurchLine.Approve THEN
        EXIT;

      IF PurchLine."Document Type" = PurchLine."Document Type"::"Blanket Order" THEN
        EXIT;

      AppSetUp.GET(COMPANYNAME,0);
      PurchHeader.GET(PurchLine."Document Type",PurchLine."Document No.");

      IF NOT DocHead.RetrieveRecord(DocHead,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.") THEN
        BEGIN
          CreateDocument(PurchHeader);
          DocHead.RetrieveRecord(DocHead,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.");
        END;

      IF DocLine3.RetrieveRecord(DocLine3,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",
                         PurchLine."Line No.") THEN
        BEGIN // Renumber web line
          DocLine2.RESET;
          DocLine2.SETCURRENTKEY("Document No.","Line No.");
          DocLine2.SETRANGE("Company Name",COMPANYNAME);
          DocLine2.SETRANGE("Document Type",PurchLine."Document Type");
          DocLine2.SETRANGE("Document No.",PurchLine."Document No.");
          IF DocLine2.FIND('+') THEN
            FreeLine := DocLine2."Line No." + 10000
          ELSE
            FreeLine := 10000;

          cuUpdatePurchaseLine.RenumberDocLine(DocLine3,FreeLine);
        END;

      DocLine.INIT;
      DocLine.ID := 0;
      DocLine."Company Name" := COMPANYNAME;
      DocLine."Document Type" := PurchLine."Document Type";
      DocLine."Document No." := PurchLine."Document No.";
      DocLine."Line No." := PurchLine."Line No.";
      DocLine."Document ID" := DocHead.ID;
      DocLine.INSERT(FALSE);

      DocLine.Flowstatus := 0;

      DocLine."Line Type" := PurchLine.Type;
      DocLine."No." := PurchLine."No.";
      IF PurchLine.Description <> DocLine.GetName THEN
        DocLine.Description := PurchLine.Description + PurchLine."Description 2"
      ELSE
        DocLine.Description := '';

      DocLine.Quantity := PurchLine.Quantity;
      DocLine."Direct Unit Cost" := PurchLine."Direct Unit Cost";
      DocLine.Amount := PurchLine."Line Amount";
      DocLine."Line Discount %" := PurchLine."Line Discount %";

      DocLine."Job No." := PurchLine."Job No.";
      DocLine."Periodic Template Code" := PurchLine."Periodic Template Code";
      DocLine."Periodic Starting Date" := PurchLine."Periodic Starting Date";

      IF PurchLine."ExFlow Order No." <> '' THEN
        IF PurchOrderLine.GET(PurchOrderLine."Document Type"::Order,
                              PurchLine."ExFlow Order No.", PurchLine."ExFlow Order Line No.") THEN BEGIN
        DocLine."Order No." := PurchLine."ExFlow Order No.";
          DocLine."Order Unit Cost" := PurchOrderLine."Direct Unit Cost";
        END;

      IF (PurchLine."Receipt No." <> '') AND (DocLine."Order No." = '')   THEN
          IF ReceiptLine.GET(PurchLine."Receipt No.",PurchLine."Receipt Line No.") THEN BEGIN
            DocLine."Order No." := ReceiptLine."Order No.";
            IF PurchOrderLine.GET(PurchOrderLine."Document Type"::Order,ReceiptLine."Order No.",ReceiptLine."Order Line No.") THEN
              DocLine."Order Unit Cost" := PurchOrderLine."Direct Unit Cost"
            ELSE
              DocLine."Order Unit Cost" := ReceiptLine."Direct Unit Cost";
          END;

      DocLine.MODIFY(TRUE);

      IF CreateApproverLines THEN
        CreateApprovers(DocLine, PurchLine,'',TRUE, '', '',Show);

      UpdateDocLineDim(DocLine,PurchLine);

      IF AppSetUp."Show Approvers Automatically" AND Show THEN
        BEGIN
          COMMIT;
          DocLine.RESET;
          DocLine.SETCURRENTKEY("Document No.","Line No.");
          DocLine.SETRANGE("Company Name",COMPANYNAME);
          DocLine.SETRANGE("Document Type",PurchLine."Document Type");
          DocLine.SETRANGE("Document No.",PurchLine."Document No.");
          DocLine.SETRANGE("Line No.",PurchLine."Line No.");
          PAGE.RUNMODAL(12013609,DocLine);
        END;
    END;

    PROCEDURE CheckMinAppAmount@1100285004(VAR PurchLine@1000000000 : Record 39;PurchHeader@1100285000 : Record 38) : Boolean;
    VAR
      DocLine@1000000002 : Record 12013609;
      CurrExchRate@1100285001 : Record 330;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      IF AppSetUp."Min. Approval Amount (LCY)" = 0 THEN
        EXIT(TRUE);

      //348864
      IF PurchHeader."Currency Code" <> '' THEN
        PurchLine."Line Amount" := CurrExchRate.ExchangeAmtFCYToLCY(0,PurchHeader."Job No.", // 4PS
          PurchHeader."Posting Date",PurchHeader."Currency Code",
          PurchLine."Line Amount",PurchHeader."Currency Factor",FALSE); // 4PS
      //348864

      IF ABS(PurchLine."Line Amount") < AppSetUp."Min. Approval Amount (LCY)" THEN BEGIN
          PurchLine.Approve := FALSE;

          IF DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
            DocLine.DELETE(TRUE);

          EXIT(FALSE);
      END;

      EXIT(TRUE);
    END;

    PROCEDURE CreateApprovers@1100285002(DocLine@1100285005 : Record 12013609;VAR PurchLine@1100285009 : Record 39;TemplateRuleCode@1100285011 : Code[20];CalledFromUpdateMode@1100285022 : Boolean;CurrentDocDimCode@1100285029 : Code[20];CurrentDocDimValue@1100285028 : Code[20];Show@1100285007 : Boolean);
    VAR
      DocLineApp@1100285004 : Record 12013610;
      PurchaseHeader@1100285016 : Record 38;
      TemplateRule@1100285000 : Record 12013645;
      TemplateRuleLines@1100285001 : Record 12013603;
      NumberOfApprovers@1100285006 : Integer;
      NextLine@1100285003 : Integer;
      RuleFor@1100285002 : Integer;
      MaxAmount@1100285010 : Decimal;
      ApproverExist@1100285012 : Boolean;
      CurrentDocDimFound@1100285024 : Boolean;
      DimCodeTab@1100285027 : ARRAY [8] OF Code[20];
      DimValueTab@1100285026 : ARRAY [8] OF Code[20];
      First@1100285013 : Boolean;
      CreateLine@1100285021 : Boolean;
      FirstApprover@1100285020 : Code[50];
      Found@1100285025 : Boolean;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document No.");
      DocLineApp.SETRANGE("Company Name",COMPANYNAME);
      DocLineApp.SETRANGE("Document Type",PurchLine."Document Type");
      DocLineApp.SETRANGE("Document No.",PurchLine."Document No.");
      DocLineApp.SETRANGE("Line No.",PurchLine."Line No.");
      DocLineApp.SETFILTER("Approved By",'<>%1','');
      DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
      IF DocLineApp.FIND('-') THEN
        EXIT;

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document No.");
      DocLineApp.SETRANGE("Company Name",COMPANYNAME);
      DocLineApp.SETRANGE("Document Type",PurchLine."Document Type");
      DocLineApp.SETRANGE("Document No.",PurchLine."Document No.");
      DocLineApp.SETRANGE("Line No.",PurchLine."Line No.");
      DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
      ApproverExist := DocLineApp.FIND('-');

      IF NOT PurchLine."Approval Flow Modified" THEN BEGIN
        IF ApproverExist THEN
          DocLineApp.DELETEALL;

        ApproverExist := FALSE;
      END;

      IF (TemplateRuleCode = '') AND (PurchLine."Template Rule" <> '') THEN
        TemplateRuleCode := PurchLine."Template Rule";

      IF AppSetUp."Propose always new Approvers" AND ApproverExist THEN
        DocLineApp.DELETEALL;

      Found := TRUE;

      IF AppSetUp."Propose always new Approvers" OR (NOT ApproverExist) THEN
        IF NOT TemplateRule.GET(COMPANYNAME,TemplateRuleCode) THEN
          BEGIN
            DocLineApp.RESET;
            DocLineApp.SETCURRENTKEY("Document No.");
            DocLineApp.SETRANGE("Company Name", COMPANYNAME);
            DocLineApp.SETRANGE("Document Type", DocLine."Document Type");
            DocLineApp.SETRANGE("Document No.", DocLine."Document No.");
            DocLineApp.SETRANGE("Line No.", DocLine."Line No.");
            DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
            IF NOT DocLineApp.FIND('-') THEN BEGIN
              CLEAR(DimCodeTab);
              CLEAR(DimValueTab);
              CurrentDocDimFound := FALSE;

              ExFlowDimMgt.GetDimFromPurchLine(PurchLine,DimCodeTab,DimValueTab,CurrentDocDimFound,
                                               CurrentDocDimCode,CurrentDocDimValue);

              RuleFor := 0;
              CASE PurchLine."Document Type" OF
                PurchLine."Document Type"::Quote: RuleFor := 3;
                PurchLine."Document Type"::Order: RuleFor := 1;
                PurchLine."Document Type"::Invoice: RuleFor := 2;
                PurchLine."Document Type"::"Credit Memo": RuleFor := 2;
              END;

              CLEAR(PurchaseHeader);
              IF PurchLine."ExFlow Order No." <> '' THEN BEGIN
                IF PurchLine."Document Type" = PurchLine."Document Type"::Invoice THEN BEGIN
                  IF PurchaseHeader.GET(PurchaseHeader."Document Type"::Order,PurchLine."ExFlow Order No.") THEN;
                END
                ELSE
                  IF PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo" THEN BEGIN
                    IF PurchaseHeader.GET(PurchaseHeader."Document Type"::"Return Order",PurchLine."ExFlow Order No.") THEN;
                  END;
              END;

              IF PurchaseHeader."No." = '' THEN
                PurchaseHeader.GET(PurchLine."Document Type",PurchLine."Document No.");

              Found := TemplateRule.FindTemplate(PurchLine, TemplateRule, DimCodeTab, DimValueTab, RuleFor,
                                                 PurchaseHeader."Purchaser Code");
            END;
          END;

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document No.","Line No.");
      DocLineApp.SETRANGE("Company Name",COMPANYNAME);
      DocLineApp.SETRANGE("Document Type",PurchLine."Document Type");
      DocLineApp.SETRANGE("Document No.",PurchLine."Document No.");
      DocLineApp.SETRANGE("Line No.",PurchLine."Line No.");
      IF DocLineApp.FIND('+') THEN
        NextLine := DocLineApp."Approver Order" + 10000
      ELSE
        NextLine := 10000;

      NumberOfApprovers := 0;
      MaxAmount := PurchLine."Line Amount";

      PurchaseHeader.GET(PurchLine."Document Type", PurchLine."Document No.");

      IF Found THEN BEGIN
        IF TemplateRule."Total Invoice Amount" THEN
          BEGIN
            //348846
            MaxAmount := PurchaseHeader."Gross Invoice Amount ExFlow" - PurchaseHeader."Import VAT Amount";
            IF MaxAmount = 0 THEN
              MakeTotals(PurchLine,MaxAmount);

            MaxAmount := ABS(MaxAmount);
            //348846
          END;

        IF (PurchaseHeader."Currency Factor" <> 1) AND (PurchaseHeader."Currency Factor" <> 0) THEN
          MaxAmount := MaxAmount / PurchaseHeader."Currency Factor";
      END;

      First := TRUE;

      FirstApprover := '';
      IF PurchLine."First Approver" <> '' THEN BEGIN
        IF AppSetUp."Copy First Approver to Flow" <> AppSetUp."Copy First Approver to Flow"::Never THEN BEGIN
          IF (AppSetUp."Copy First Approver to Flow" = AppSetUp."Copy First Approver to Flow"::"All Documents") THEN BEGIN
            InsertApprover(DocLine,PurchLine."First Approver",NextLine,First);

            NextLine := NextLine + 10000;
            NumberOfApprovers := NumberOfApprovers + 1;

            Show := TRUE;

            FirstApprover := PurchLine."First Approver";
          END;

          IF (AppSetUp."Copy First Approver to Flow" = AppSetUp."Copy First Approver to Flow"::"Invoices Only") AND
             (PurchLine."Document Type" IN [PurchLine."Document Type"::Invoice,PurchLine."Document Type"::"Credit Memo"]) THEN BEGIN
            InsertApprover(DocLine,PurchLine."First Approver",NextLine,First);

            NextLine := NextLine + 10000;
            NumberOfApprovers := NumberOfApprovers + 1;

            Show := TRUE;

            FirstApprover := PurchLine."First Approver";
          END;

          IF (AppSetUp."Copy First Approver to Flow" = AppSetUp."Copy First Approver to Flow"::"Orders & Requisitions Only") AND
             (PurchLine."Document Type" IN [PurchLine."Document Type"::Quote,PurchLine."Document Type"::Order]) THEN BEGIN
            InsertApprover(DocLine,PurchLine."First Approver",NextLine,First);

            NextLine := NextLine + 10000;
            NumberOfApprovers := NumberOfApprovers + 1;

            Show := TRUE;

            FirstApprover := PurchLine."First Approver";
          END;
        END;
      END;

      MaxAmount := ABS(MaxAmount);

      IF Found THEN BEGIN
        TemplateRuleLines.RESET;
        TemplateRuleLines.SETRANGE("Company Name",DocLine."Company Name");
        TemplateRuleLines.SETRANGE(Code,TemplateRule.Code);
        IF MaxAmount >= 0 THEN
          TemplateRuleLines.SETFILTER("Over Amount",'<=%1', MaxAmount);
        IF AppSetUp."Activate Not Over" THEN
          TemplateRuleLines.SETFILTER("Not Over Amount",'>%1|0', MaxAmount);
        TemplateRuleLines.SETFILTER("Approver Group", '<>%1', '');
        IF TemplateRuleLines.FINDSET THEN
          REPEAT
            CreateLine := TRUE;
            IF FirstApprover <> '' THEN BEGIN
              IF FirstApprover = TemplateRuleLines."Approver Group" THEN
                CreateLine := FALSE;
              FirstApprover := '';
            END;

            IF CreateLine THEN BEGIN
              InsertApprover(DocLine,TemplateRuleLines."Approver Group",NextLine,First);

              NextLine := NextLine + 10000;
              NumberOfApprovers := NumberOfApprovers + 1;

              Show := TRUE;
            END;
          UNTIL (TemplateRuleLines.NEXT = 0);
      END;

      IF Found THEN
        PurchLine."Applied Template Rule" := TemplateRule.Code
      ELSE
        PurchLine."Applied Template Rule" := '';

      IF NOT CalledFromUpdateMode THEN
        PurchLine.MODIFY;

      DocLineApp.RESET;
      DocLineApp.SETRANGE("Company Name", COMPANYNAME);
      DocLineApp.SETRANGE("Document Type", DocLine."Document Type");
      DocLineApp.SETRANGE("Document No.", DocLine."Document No.");
      DocLineApp.SETRANGE("Line No.", DocLine."Line No.");
      DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
      IF DocLineApp.FIND('-') THEN
        DocLineApp.ApprovalStatus(DocLineApp,'Update')
      ELSE
        DocLineApp.ApprovalStatus(DocLineApp,'Delete');
    END;

    PROCEDURE InsertApprover@1100285053(DocLine@1100285001 : Record 12013609;ApproverGroup@1100285002 : Code[50];NextLine@1100285003 : Integer;VAR First@1100285006 : Boolean);
    VAR
      AppGroup@1100285000 : Record 12013606;
      DocLineApp@1100285004 : Record 12013610;
      ExflowToInvoice@1100285005 : Codeunit 12013592;
    BEGIN
      DocLineApp.INIT;
      DocLineApp."Company Name" := DocLine."Company Name";
      DocLineApp."Document Type" := DocLine."Document Type";
      DocLineApp."Document No." := DocLine."Document No.";
      DocLineApp."Line No." := DocLine."Line No.";
      DocLineApp."Approver Order" := NextLine;
      DocLineApp.VALIDATE(Approver,ApproverGroup);
      DocLineApp."Document Line ID" := DocLine.ID;
      DocLineApp."Document ID" := DocLine."Document ID";

      AppGroup.GET(DocLine."Company Name",ApproverGroup);
      IF AppGroup."Auto Approve" THEN
        ExflowToInvoice.AutoApproveGrp(DocLineApp,AppGroup.Code, AppGroup."Auto Approve Comment")
      ELSE
        IF First THEN
          BEGIN
            First := FALSE;
            DocLineApp.VALIDATE(Flowstatus,DocLineApp.Flowstatus::Current);
          END;

      DocLineApp.ID := 0;
      DocLineApp.INSERT(FALSE);
    END;

    PROCEDURE AlreadyApproved@1100285007(PurchLine@1100285000 : Record 39) : Boolean;
    VAR
      DocLineApp@1100285001 : Record 12013610;
      DocLine@1100285002 : Record 12013609;
    BEGIN
      IF NOT DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",
                                    PurchLine."Document No.",PurchLine."Line No.") THEN
        EXIT(FALSE);

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document Line ID");
      DocLineApp.SETRANGE("Document Line ID", DocLine.ID);
      DocLineApp.SETFILTER("Approved By",'<>%1','');
      DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
      IF DocLineApp.FINDFIRST THEN
        EXIT(TRUE);
    END;

    PROCEDURE DeleteDocument@1100285013(Purchheader@1100285000 : Record 38);
    VAR
      DocHead@1100285001 : Record 12013608;
    BEGIN
      IF NOT DocHead.RetrieveRecord(DocHead,COMPANYNAME,Purchheader."Document Type",Purchheader."No.") THEN
        EXIT;

      DocHead.DELETE(TRUE);
    END;

    PROCEDURE AnyApproved@1100285014(PurchHeader@1100285000 : Record 38) : Boolean;
    VAR
      DocLineApp@1100285001 : Record 12013610;
    BEGIN
      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document No.");
      DocLineApp.SETRANGE("Company Name",COMPANYNAME);
      DocLineApp.SETRANGE("Document Type",PurchHeader."Document Type");
      DocLineApp.SETRANGE("Document No.",PurchHeader."No.");
      DocLineApp.SETFILTER("Approved By",'<>%1','');
      IF DocLineApp.FIND('-') THEN
        EXIT(TRUE)
      ELSE
        EXIT(FALSE);
    END;

    PROCEDURE AnyApprovedLine@1100285015(PurchLine@1100285000 : Record 39) : Boolean;
    VAR
      DocLineApp@1100285001 : Record 12013610;
    BEGIN
      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document No.");
      DocLineApp.SETRANGE("Company Name",COMPANYNAME);
      DocLineApp.SETRANGE("Document Type",PurchLine."Document Type");
      DocLineApp.SETRANGE("Document No.",PurchLine."Document No.");
      DocLineApp.SETRANGE("Line No.",PurchLine."Line No.");
      DocLineApp.SETFILTER("Approved By",'<>%1','');

      IF DocLineApp.FIND('-') THEN
        EXIT(TRUE)
      ELSE
        EXIT(FALSE);
    END;

    PROCEDURE UpdateDocLineDim@1100285003(DocLine@1100285004 : Record 12013609;VAR PurchLine@1100285000 : Record 39);
    VAR
      DocLineDim@1100285002 : Record 12013611;
      Column@1100285005 : Record 12013661;
    BEGIN
      DocLineDim.RESET;
      DocLineDim.SETCURRENTKEY("Document Line ID");
      DocLineDim.SETRANGE("Document Line ID", DocLine.ID);
      DocLineDim.DELETEALL;

      ExFlowDimMgt.InsertExDocDim(PurchLine,DocLine);

      CASE PurchLine.Type OF
        PurchLine.Type::"G/L Account":
          AddExtraToExFlowDim('G_LACCOUNT', PurchLine);
        PurchLine.Type::Item:
          AddExtraToExFlowDim('ITEM', PurchLine);
        PurchLine.Type::"Fixed Asset":
          AddExtraToExFlowDim('FIXEDASSET', PurchLine);
        PurchLine.Type::"Charge (Item)":
          AddExtraToExFlowDim('CHARGE', PurchLine);
      END;

      Column.RESET;
      Column.SETRANGE("Company Name", COMPANYNAME);
      Column.SETRANGE(Dimension, FALSE);
      IF Column.FINDSET THEN
        REPEAT
          IF (Column.Code <> 'G_LACCOUNT') AND (Column.Code <> 'ITEM') AND
             (Column.Code <> 'FIXEDASSET') AND (Column.Code <> 'CHARGE') THEN
            AddExtraToExFlowDim(Column.Code, PurchLine);
        UNTIL Column.NEXT = 0;
    END;

    PROCEDURE AddExtraToExFlowDim@1100285018(InCode@1100285001 : Code[20];PurchLine@1100285000 : Record 39);
    VAR
      DocLine@1100285008 : Record 12013609;
      Column@1100285003 : Record 12013661;
      Column2@1100285009 : Record 12013661;
      DocLineDim@1100285002 : Record 12013611;
      DocLineDim2@1100285004 : Record 12013611;
      NewDocLineDim@1100285010 : Record 12013611;
      Job@1100285011 : Record 11072003;
      ExFWorkFlowMgt@1100285005 : Codeunit 12013593;
      RecRef@1100285007 : RecordRef;
      FldRef@1100285006 : FieldRef;
    BEGIN
      // Source changed to InCode
      Column.RESET;
      Column.SETCURRENTKEY("Company Name", Code);
      Column.SETRANGE("Company Name", COMPANYNAME);
      Column.SETRANGE(Code, InCode);
      IF NOT Column.FINDFIRST THEN
        EXIT;

      DocLineDim.INIT;
      DocLineDim.ID := 0;
      DocLineDim."Company Name" := COMPANYNAME;
      DocLineDim."Document Type" := PurchLine."Document Type";
      DocLineDim."Document No." := PurchLine."Document No.";
      DocLineDim."Line No." := PurchLine."Line No.";
      DocLineDim."Dimension Code" := InCode;
      DocLineDim."Column ID" := Column.ID;

      IF (Column.Code = 'G_LACCOUNT') OR (Column.Code = 'ITEM') OR
         (Column.Code = 'FIXEDASSET') OR (Column.Code = 'CHARGE') THEN
        DocLineDim."Dimension Value" := PurchLine."No.";

      IF InCode = 'PERCODE' THEN
        IF PurchLine."Periodic Template Code" <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Periodic Template Code"
        ELSE
          EXIT;

      IF InCode = 'PERDATE' THEN
        IF PurchLine."Periodic Starting Date" <> 0D THEN
          DocLineDim."Dimension Value" := ExFWorkFlowMgt.TransformDateToText(PurchLine."Periodic Starting Date")
        ELSE
          EXIT;

      IF InCode = 'JOB' THEN
        IF PurchLine."Job No." <> '' THEN BEGIN
          DocLineDim."Dimension Value" := PurchLine."Job No.";

          Column2.SETRANGE("Company Name", COMPANYNAME);
          Column2.SETRANGE(Code,'CUSTOMER');
          IF Column2.FINDFIRST THEN BEGIN
            NewDocLineDim.INIT;
            NewDocLineDim.TRANSFERFIELDS(DocLineDim);
            NewDocLineDim."Dimension Code" := 'CUSTOMER';
            NewDocLineDim."Column ID" := Column2.ID;
            IF Job.GET(PurchLine."Job No.") THEN
              NewDocLineDim."Dimension Value" := Job."Bill-to Customer No.";

            IF NewDocLineDim."Dimension Value" <> '' THEN BEGIN
              DocLineDim2.RESET;
              DocLineDim2.SETCURRENTKEY("Document No.");
              DocLineDim2.SETRANGE("Company Name", NewDocLineDim."Company Name");
              DocLineDim2.SETRANGE("Document Type", NewDocLineDim."Document Type");
              DocLineDim2.SETRANGE("Document No.", NewDocLineDim."Document No.");
              DocLineDim2.SETRANGE("Line No.", NewDocLineDim."Line No.");
              DocLineDim2.SETRANGE("Dimension Code", NewDocLineDim."Dimension Code");
              IF DocLineDim2.ISEMPTY THEN BEGIN
                DocLine.RetrieveRecord(DocLine,COMPANYNAME, PurchLine."Document Type", PurchLine."Document No.", PurchLine."Line No.");
                NewDocLineDim."Document Line ID" := DocLine.ID;
                NewDocLineDim."Document ID" := DocLine."Document ID";
                NewDocLineDim.INSERT;
              END;
            END;
          END;
        END
        ELSE
          EXIT;

      IF InCode = 'CUSTOMER' THEN
        EXIT;

      IF InCode = 'INV_CODE' THEN
        IF PurchLine."Invoicing Code" <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Invoicing Code"
        ELSE
          EXIT;

      IF InCode = 'JOBTASK' THEN
        IF PurchLine."Job Task No." <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Job Task No."
        ELSE
          EXIT;

      IF InCode = 'CUSTOMERINV' THEN
        IF PurchLine."Invoice to Customer" <> FALSE THEN
          DocLineDim."Dimension Value" := FORMAT(PurchLine."Invoice to Customer",0,'<Number>')
        ELSE
          EXIT;

      IF InCode = 'AMOUNTINV' THEN
        IF PurchLine."Invoicing Amount" <> 0 THEN
          DocLineDim."Dimension Value" := FORMAT(PurchLine."Invoicing Amount",0,9)
        ELSE
          EXIT;

      IF InCode = 'INVDATE' THEN
        IF PurchLine."Start Date for Invoicing" <> 0D THEN
          DocLineDim."Dimension Value" := ExFWorkFlowMgt.TransformDateToText(PurchLine."Start Date for Invoicing")
        ELSE
          EXIT;
      //>> 4PS
      IF InCode = 'EXTCONTR_4PS' THEN // ŽTA No.
        IF PurchLine."Extension Contract" <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Extension Contract"
        ELSE
          EXIT;
      IF InCode = 'ELEMENT_4PS' THEN
        IF PurchLine.Element <> '' THEN
          DocLineDim."Dimension Value" := PurchLine.Element
        ELSE
          EXIT;
      IF InCode = 'PLOT_4PS' THEN
        IF PurchLine."Plot No." <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Plot No."
        ELSE
          EXIT;
      IF InCode = 'COSTCOMP_4PS' THEN
        IF PurchLine."Cost Component" <> '' THEN
          DocLineDim."Dimension Value" := PurchLine."Cost Component"
        ELSE
          EXIT;
      //<< 4PS

      IF Column."Purchase Line Field ID" <> 0 THEN BEGIN
        RecRef.GETTABLE(PurchLine);
        FldRef := RecRef.FIELD(Column."Purchase Line Field ID");
        DocLineDim."Dimension Value" := FORMAT(FldRef.VALUE);
        IF DocLineDim."Dimension Value" <> '' THEN
          DocLineDim."Dimension Code" := InCode;
      END;

      IF DocLineDim."Dimension Value" <> '' THEN BEGIN
        DocLineDim2.RESET;
        DocLineDim2.SETCURRENTKEY("Document No.");
        DocLineDim2.SETRANGE("Company Name", DocLineDim."Company Name");
        DocLineDim2.SETRANGE("Document Type", DocLineDim."Document Type");
        DocLineDim2.SETRANGE("Document No.", DocLineDim."Document No.");
        DocLineDim2.SETRANGE("Line No.", DocLineDim."Line No.");
        DocLineDim2.SETRANGE("Dimension Code", DocLineDim."Dimension Code");
        IF DocLineDim2.ISEMPTY THEN BEGIN
          DocLine.RetrieveRecord(DocLine,COMPANYNAME, PurchLine."Document Type", PurchLine."Document No.", PurchLine."Line No.");
          DocLineDim."Document Line ID" := DocLine.ID;
          DocLineDim."Document ID" := DocLine."Document ID";
          DocLineDim.INSERT;
        END;
      END;
    END;

    PROCEDURE RuleLines@1100285010(Rule@1100285000 : Record 12013660);
    VAR
      NextNumber@1100285001 : Integer;
      Column@1100285003 : Record 12013661;
      CodingLines@1100285002 : Record 12013663;
    BEGIN
      NextNumber := 10000;

      Column.RESET;
      Column.SETCURRENTKEY("Company Name", ID);
      Column.SETRANGE("Company Name",COMPANYNAME);

      IF Column.FIND('-') THEN
        REPEAT
          CodingLines.INIT;
          CodingLines."Company Name" := COMPANYNAME;
          CodingLines.ID := Rule.ID;
          CodingLines."Line No." := NextNumber;
          NextNumber := NextNumber + 10000;
          CodingLines."Column Code" := Column.Code;
          CodingLines."Column ID" := Column.ID;
          CodingLines."Column Source":= Column.Source;
          CodingLines.INSERT(FALSE);
        UNTIL Column.NEXT = 0;
    END;

    PROCEDURE AmountToDocHead@1100285016(PurchLine@1100285000 : Record 39;Del@1100285002 : Boolean);
    VAR
      DocHead@1100285001 : Record 12013608;
      PurchLine2@1100285009 : Record 39;
      PurchHead@1100285003 : Record 38;
      ExFlowSEMgt@1100285004 : Codeunit 12013598;
    BEGIN
      // Update DocHead Net and VAT
      IF (PurchLine."Document Type" = PurchLine."Document Type"::Invoice) OR
         (PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo") THEN
        EXIT;

      IF NOT DocHead.RetrieveRecord(DocHead,COMPANYNAME, PurchLine."Document Type",PurchLine."Document No.") THEN
        EXIT;

      DocHead."Net Amount" := 0;
      DocHead."VAT Amount" := 0;
      DocHead."Gross Amount" := 0;

      PurchLine2.RESET;
      PurchLine2.SETRANGE("Document Type",PurchLine."Document Type");
      PurchLine2.SETRANGE("Document No.",PurchLine."Document No.");
      IF PurchLine2.FINDSET THEN
        REPEAT
          IF PurchLine2."Line No." = PurchLine."Line No." THEN
            BEGIN
              IF NOT Del THEN
                BEGIN
                  IF PurchLine."VAT Calculation Type" <> PurchLine."VAT Calculation Type"::"Full VAT" THEN
                    BEGIN
                      DocHead."Net Amount" := DocHead."Net Amount" + PurchLine."Line Amount";
                      DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine."Line Amount" * PurchLine."VAT %" / 100;
                    END
                  ELSE
                    DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine."Line Amount";
                END;
            END
          ELSE
            BEGIN
              IF PurchLine2."VAT Calculation Type" <> PurchLine2."VAT Calculation Type"::"Full VAT" THEN
                BEGIN
                  DocHead."Net Amount" := DocHead."Net Amount" + PurchLine2."Line Amount";
                  DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine2."Line Amount" * PurchLine2."VAT %" / 100;
                END
              ELSE
                DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine2."Line Amount";
            END;
        UNTIL PurchLine2.NEXT = 0;

      PurchLine2.SETRANGE("Line No.",PurchLine."Line No.");
      IF NOT PurchLine2.FINDFIRST THEN
        BEGIN
          IF PurchLine2."VAT Calculation Type" <> PurchLine2."VAT Calculation Type"::"Full VAT" THEN
            BEGIN
              DocHead."Net Amount" := DocHead."Net Amount" + PurchLine."Line Amount";
              DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine."Line Amount" * PurchLine."VAT %" / 100;
            END
          ELSE
            DocHead."VAT Amount" := DocHead."VAT Amount" + PurchLine."Line Amount";
        END;

      DocHead."Gross Amount" := DocHead."Net Amount" + DocHead."VAT Amount";
      DocHead.MODIFY(TRUE);

      IF PurchHead.GET(PurchLine."Document Type",PurchLine."Document No.") THEN
        IF PurchHead.Status = PurchHead.Status::Released THEN BEGIN
          PurchHead."Gross Invoice Amount ExFlow" := DocHead."Gross Amount";
          PurchHead."Import VAT Amount" := DocHead."VAT Amount";
          PurchHead.MODIFY;

          ExFlowSEMgt.UpdateSWEBASE(PurchHead);
        END;
    END;

    PROCEDURE GetColumnID@1100285019(DimCode@1100285000 : Code[20]) : Integer;
    VAR
      Column@1100285001 : Record 12013661;
    BEGIN
      Column.RESET;
      Column.SETCURRENTKEY("Company Name", Code);
      Column.SETRANGE("Company Name",COMPANYNAME);
      Column.SETRANGE(Code, DimCode);

      IF Column.FIND('-') THEN
        EXIT(Column.ID)
      ELSE
        EXIT(0);
    END;

    PROCEDURE ShortCutDim@1100285020(FieldNo@1100285000 : Integer;DimValue@1100285001 : Code[20];VAR PurchLine@1100285004 : Record 39);
    VAR
      DocLine@1100285008 : Record 12013609;
      DimCode@1100285002 : Code[20];
      Column@1100285003 : Record 12013661;
      DocLineDim@1100285005 : Record 12013611;
      GeneralLedgerSetup@1100285006 : Record 98;
      ColumnID@1100285007 : Integer;
    BEGIN
      IF PurchLine."Line No." = 0 THEN
        EXIT;

      GeneralLedgerSetup.GET;

      CASE FieldNo OF
        3 : DimCode := GeneralLedgerSetup."Shortcut Dimension 3 Code";
        4 : DimCode := GeneralLedgerSetup."Shortcut Dimension 4 Code";
        5 : DimCode := GeneralLedgerSetup."Shortcut Dimension 5 Code";
        6 : DimCode := GeneralLedgerSetup."Shortcut Dimension 6 Code";
        7 : DimCode := GeneralLedgerSetup."Shortcut Dimension 7 Code";
        8 : DimCode := GeneralLedgerSetup."Shortcut Dimension 8 Code"
        ELSE
          EXIT;
      END;

      ColumnID := GetColumnID(DimCode);
      IF ColumnID <> 0 THEN
        IF Column.GET(COMPANYNAME,ColumnID) THEN
          BEGIN
            IF DocLineDim.RetrieveRecord(DocLineDim,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",
                              PurchLine."Line No.",DimCode) THEN
              BEGIN
                IF DimValue = '' THEN BEGIN
                  DocLineDim.DELETE(FALSE);
                END
                ELSE
                  BEGIN
                    DocLineDim."Dimension Value" := DimValue;
                    DocLineDim.MODIFY(FALSE);
                  END;
              END
            ELSE
              BEGIN
                DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");

                DocLineDim.INIT;
                DocLineDim.ID := 0;
                DocLineDim."Company Name" := COMPANYNAME;
                DocLineDim."Document Type" := PurchLine."Document Type";
                DocLineDim."Document No." := PurchLine."Document No.";
                DocLineDim."Line No." := PurchLine."Line No.";
                DocLineDim."Dimension Code" := DimCode;
                DocLineDim."Dimension Value" := DimValue;
                DocLineDim."Column ID" := Column.ID;
                DocLineDim."Document Line ID" := DocLine.ID;
                DocLineDim."Document ID" := DocLine."Document ID";
                IF DimValue <> '' THEN BEGIN
                  DocLineDim.INSERT;
                END;
              END;
          END;

      ExFlowPropose(PurchLine,DimCode,DimValue);
    END;

    PROCEDURE AllInvoiced@1100285021(PurchHead@1100285000 : Record 38);
    VAR
      PurchLine2@1100285001 : Record 39;
      RcptHeader@1100285004 : Record 120;
      OrderHead@1100285008 : Record 38;
      DocHead@1100285005 : Record 12013608;
    BEGIN
      PurchLine2.RESET;
      PurchLine2.SETRANGE("Document Type",PurchHead."Document Type");
      PurchLine2.SETRANGE("Document No.",PurchHead."No.");
      PurchLine2.SETFILTER("Receipt No.",'<>%1','');
      IF PurchLine2.FINDSET THEN
        REPEAT
          RcptHeader.GET(PurchLine2."Receipt No.");
          OrderHead.GET(OrderHead."Document Type"::Order,RcptHeader."Order No.");

          IF OrderHead.Approve THEN BEGIN
            IF DocHead.RetrieveRecord(DocHead,COMPANYNAME,OrderHead."Document Type",OrderHead."No.") THEN BEGIN
              IF DocHead.Status <> DocHead.Status::Invoiced THEN BEGIN
                IF OrderAllInvoiced(OrderHead) THEN
                  BEGIN
                    DocHead.Status := DocHead.Status::Invoiced;
                    DocHead.MODIFY(TRUE);
                  END;
              END;
            END
            ELSE
              MESSAGE(STRSUBSTNO(EXF74,OrderHead."No."));
          END;
        UNTIL PurchLine2.NEXT = 0
      ELSE
        EXIT;
    END;

    PROCEDURE AllReceived@1100285022(PurchHead@1100285000 : Record 38) : Boolean;
    VAR
      PurchLine2@1100285001 : Record 39;
      EverythingReceived@1100285002 : Boolean;
    BEGIN
      EverythingReceived := TRUE;

      PurchLine2.RESET;
      PurchLine2.SETRANGE("Document Type",PurchHead."Document Type");
      PurchLine2.SETRANGE("Document No.",PurchHead."No.");
      PurchLine2.SETFILTER(Quantity,'<>%1', 0);
      IF PurchLine2.FINDSET THEN
        REPEAT
          IF (PurchLine2.Quantity - PurchLine2."Quantity Received") <> 0 THEN
            EverythingReceived := FALSE;
        UNTIL (PurchLine2.NEXT = 0) OR (NOT EverythingReceived);

      EXIT(EverythingReceived);
    END;

    PROCEDURE OrderAllInvoiced@1100285023(PurchHead@1100285000 : Record 38) : Boolean;
    VAR
      PurchLine2@1100285001 : Record 39;
      EverythingInvoiced@1100285003 : Boolean;
    BEGIN
      EverythingInvoiced := TRUE;

      PurchLine2.RESET;
      PurchLine2.SETRANGE("Document Type",PurchHead."Document Type");
      PurchLine2.SETRANGE("Document No.",PurchHead."No.");
      PurchLine2.SETFILTER(Quantity,'<>0');
      IF PurchLine2.FINDSET THEN
        REPEAT
         IF ((PurchLine2.Quantity - PurchLine2."Quantity Invoiced") > 0) OR
            (PurchLine2."Qty. to Invoice" > 0) THEN
           EverythingInvoiced := FALSE;
        UNTIL (PurchLine2.NEXT = 0) OR (NOT EverythingInvoiced);

      EXIT(EverythingInvoiced);
    END;

    PROCEDURE MoveAttachedFile@1100285026(AttachedFile@1100285000 : Record 12013643);
    VAR
      ExFlowFileMgt@1100285005 : Codeunit 12013602;
      FolderPath@1100285001 : Text[250];
      ErrorText@1100285002 : Text[250];
      FromFolder@1100285003 : Text[250];
      NewFileName@1100285004 : Text[128];
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      FolderPath := AppSetUp."Path to connected Att. Files" + FORMAT(AttachedFile."Document ID");
      IF NOT ExFlowFileMgt.NewFolder(FolderPath,AppSetUp."Path to connected Att. Files") THEN
        ErrorText := STRSUBSTNO(EXF50,FolderPath,FORMAT(AttachedFile."Document ID"))
      ELSE
        ErrorText := '';

      IF STRLEN(ErrorText) <> 0 THEN
        ERROR(EXF55,ErrorText);

      NewFileName := FORMAT(AttachedFile."Document ID") + '-' + AttachedFile."Attached File";
      FromFolder := AttachedFile.Path;

      IF FromFolder = '' THEN
        FromFolder := AppSetUp."Path to Attached Files";

      ErrorText := ExFlowFileMgt.Move(AttachedFile."Attached File",NewFileName,FromFolder,FolderPath,
                                      AppSetUp."Path to connected Att. Files");

      IF STRLEN(ErrorText) <> 0 THEN
        ERROR(EXF55,ErrorText);
    END;

    PROCEDURE CopyAttachedFile@1100285027(OldFileName@1100285008 : Text[128];NewFileName@1100285009 : Text[128];FromFolder@1100285001 : Text[250];ToFolder@1100285004 : Text[250];RootFolder@1100285000 : Text[250]);
    VAR
      ErrorText@1100285002 : Text[250];
      ExFlowFileMgt@1100285003 : Codeunit 12013602;
    BEGIN
      IF NOT ExFlowFileMgt.FolderExist(ToFolder) THEN
        BEGIN
          IF NOT ExFlowFileMgt.NewFolder(ToFolder,RootFolder) THEN
            ErrorText := STRSUBSTNO(EXF51,ToFolder);

          IF STRLEN(ErrorText) <> 0 THEN
            ERROR(EXF55,ErrorText);
        END;

      ErrorText := ExFlowFileMgt.Copy(OldFileName, NewFileName, FromFolder, ToFolder, RootFolder);

      IF STRLEN(ErrorText) <> 0 THEN
        ERROR(EXF55,ErrorText);
    END;

    PROCEDURE LineTypeAllowed@1100285029(LineType@1100285000 : ' ,G/L Account,Item,,Fixed Asset,Charge (Item)';ShowError@1100285001 : Boolean) : Boolean;
    VAR
      Col@1100285002 : Integer;
    BEGIN
      CASE LineType OF
        LineType::"G/L Account":
          Col := GetColumnID('G_LACCOUNT');

        LineType::Item:
          Col := GetColumnID('ITEM');

        LineType::"Fixed Asset":
          Col := GetColumnID('FIXEDASSET');

        LineType::"Charge (Item)":
          Col := GetColumnID('CHARGE');
      END;

      IF Col = 0 THEN
        BEGIN
          IF ShowError THEN
            MESSAGE(EXF43);

          EXIT(FALSE);
        END
      ELSE
        EXIT(TRUE);
    END;

    PROCEDURE CopyExFlowSetup@1100285030(Comp@1100285042 : Text[50];Action@1100285001 : Code[20]);
    VAR
      AppSetup@1100285021 : Record 12013601;
      AppSetupNew@1100285020 : Record 12013601;
      UserComp@1100285019 : Record 12013641;
      UserCompNew@1100285018 : Record 12013641;
      TemplateRule@1100285017 : Record 12013645;
      TemplateRuleLine@1100285016 : Record 12013603;
      TemplateRuleNew@1100285015 : Record 12013645;
      TemplateRuleLineNew@1100285014 : Record 12013603;
      CodingRule@1100285013 : Record 12013660;
      CodingRuleLine@1100285012 : Record 12013663;
      CodingRuleNew@1100285011 : Record 12013660;
      CodingRuleLineNew@1100285010 : Record 12013663;
      Column@1100285009 : Record 12013661;
      ColumnNew@1100285008 : Record 12013661;
      VendorID@1100285002 : Record 12013668;
      VendorIDNew@1100285003 : Record 12013668;
      VendorIDMgt@1100285005 : Codeunit 12013667;
      ExFStdPurchCode@1100285006 : Record 12013682;
      ExStdPurchCodeLine@1100285022 : Record 12013683;
      ExFStdPurchCodeNew@1100285027 : Record 12013682;
      ExStdPurchCodeLineNew@1100285026 : Record 12013683;
      ExUserGroup@1100285028 : Record 12013606;
      ExUserGroupNew@1100285029 : Record 12013606;
      ExUserGroupLine@1100285030 : Record 12013607;
      ExUserGroupLineNew@1100285031 : Record 12013607;
      ExDoc@1100285032 : Record 12013608;
      ExDocNew@1100285033 : Record 12013608;
      ExDocLine@1100285034 : Record 12013609;
      ExDocLineNew@1100285035 : Record 12013609;
      ExDocLineApp@1100285036 : Record 12013610;
      ExDocLineAppNew@1100285037 : Record 12013610;
      ExDocLineDim@1100285039 : Record 12013611;
      ExDocLineDimNew@1100285038 : Record 12013611;
      Window@1100285040 : Dialog;
      TotCount@1100285041 : Integer;
      TempCount@1100285004 : Integer;
      NextID@1100285000 : Integer;
      ExAdvVend@1100285050 : Record 12013595;
      ExAdvVendNew@1100285052 : Record 12013595;
      ExLineAdv@1100285049 : Record 12013596;
      ExLineAdvNew@1100285053 : Record 12013596;
      ExHeaderMap@1100285048 : Record 12013617;
      ExHeaderMapNew@1100285054 : Record 12013617;
      ExEmailHead@1100285047 : Record 12013619;
      ExEmailHeadNew@1100285055 : Record 12013619;
      ExDimGLMap@1100285046 : Record 12013646;
      ExDimGLMapNew@1100285056 : Record 12013646;
      ExReqRule@1100285045 : Record 12013621;
      ExReqRuleNew@1100285057 : Record 12013621;
      ExInvCode@1100285044 : Record 12013597;
      ExInvCodeNew@1100285058 : Record 12013597;
      ExWebCode@1100285043 : Record 12013600;
      ExWebCodeNew@1100285059 : Record 12013600;
      ExLoc@1100285007 : Record 12013613;
      ExLocNew@1100285060 : Record 12013613;
      ExRsOnline@1100285051 : Record 12013653;
      ExRsOnlineNew@1100285061 : Record 12013653;
      ExLocAdv@1100285023 : Record 12013602;
      ExLocAdvNew@1100285024 : Record 12013602;
      Location@1100285025 : Record 14;
      FraudVendID@1100285062 : Record 12013681;
      FraudVendIDNew@1100285063 : Record 12013681;
      OCRFormat@1100285064 : Record 12013614;
      OCRFormatNew@1100285065 : Record 12013614;
      OCRUnit@1100285066 : Record 12013672;
      OCRUnitNew@1100285067 : Record 12013672;
      ExContract@1100285068 : Record 12013633;
      ExContractNew@1100285069 : Record 12013633;
      TempCodingRuleID@1100285070 : Integer;
    BEGIN
      CASE Action OF
        'COLUMNS' :
          BEGIN
            Column.RESET;
            Column.SETCURRENTKEY(ID);
            IF Column.FIND('+') THEN
              NextID := Column.ID + 1
            ELSE
              NextID := 1;

            Column.RESET;
            Column.SETRANGE("Company Name", Comp);
            IF Column.FIND('-') THEN
              REPEAT
                ColumnNew.COPY(Column);
                ColumnNew."Company Name" := COMPANYNAME;
                ColumnNew.ID := NextID;
                NextID := NextID + 1;
                ColumnNew.INSERT;
              UNTIL Column.NEXT = 0;
          END;

        'SETUP':
          BEGIN
            AppSetup.GET(Comp, 0);

            IF AppSetupNew.GET(COMPANYNAME, 0) THEN
              BEGIN
                AppSetupNew.TRANSFERFIELDS(AppSetup, FALSE);
                AppSetupNew.MODIFY;
              END
            ELSE
              BEGIN
                AppSetupNew.COPY(AppSetup);
                AppSetupNew."Company Name" := COMPANYNAME;
                AppSetupNew.INSERT;
              END;
          END;

        'CODING':
          BEGIN
            CodingRule.RESET;
            CodingRule.SETRANGE("Company Name", Comp);
            IF CodingRule.FIND('-') THEN
              REPEAT
                IF CodingRuleNew.GET(COMPANYNAME, CodingRule.ID) THEN
                  BEGIN
                    CodingRuleNew.COPY(CodingRule);
                    CodingRuleNew."Company Name" := COMPANYNAME;
                    CodingRuleNew.Expression := '';
                    CodingRuleNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    CodingRuleNew.COPY(CodingRule);
                    CodingRuleNew."Company Name" := COMPANYNAME;
                    CodingRuleNew.Expression := '';
                    CodingRuleNew.INSERT(TRUE);
                  END;

                CodingRuleLineNew.RESET;
                CodingRuleLineNew.SETRANGE("Company Name", COMPANYNAME);
                CodingRuleLineNew.SETRANGE(ID, CodingRuleNew.ID);
                IF CodingRuleLineNew.FIND('-') THEN
                  REPEAT
                    CodingRuleLine.RESET;
                    CodingRuleLine.SETRANGE("Company Name", Comp);
                    CodingRuleLine.SETRANGE(ID, CodingRule.ID);
                    CodingRuleLine.SETRANGE("Column Code", CodingRuleLineNew."Column Code");
                    IF CodingRuleLine.FIND('-') THEN BEGIN
                      CodingRuleLineNew.All := CodingRuleLine.All;
                      CodingRuleLineNew.Empty := CodingRuleLine.Empty;
                      CodingRuleLineNew."Text Range" := CodingRuleLine."Text Range";
                    END
                    ELSE BEGIN
                      CodingRuleLineNew.All := TRUE;
                      IF NOT CodingRuleNew."Is Subset" THEN
                        CodingRuleLineNew.Empty := TRUE;
                    END;

                    CodingRuleLineNew.MODIFY(TRUE);
                    CodingRuleLineNew.UpdateExpression;
                  UNTIL CodingRuleLineNew.NEXT = 0;
              UNTIL CodingRule.NEXT = 0;
          END;

        'USER':
          BEGIN
            UserComp.RESET;
            UserComp.SETRANGE("Company Name", Comp);
            IF UserComp.FIND('-') THEN
              REPEAT
                IF UserCompNew."Coding Rule ID" <> 0 THEN BEGIN
                  CodingRule.RESET;
                  CodingRule.SETRANGE(ID, UserCompNew."Coding Rule ID");
                  CodingRule.SETRANGE("Company Name", Comp);
                  CodingRule.SETRANGE("Is Subset", TRUE);
                  IF NOT CodingRule.FINDFIRST THEN
                    ERROR(STRSUBSTNO(EXF71,UserComp."User ID"));
                END;

                IF UserCompNew.GET(COMPANYNAME, UserComp."User ID") THEN
                  BEGIN
                    TempCodingRuleID := UserCompNew."Coding Rule ID";
                    UserCompNew.TRANSFERFIELDS(UserComp, FALSE);
                    UserCompNew."Coding Rule ID" := TempCodingRuleID;
                    UserCompNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    UserCompNew.INIT;
                    UserCompNew.TRANSFERFIELDS(UserComp);
                    UserCompNew."Company Name" := COMPANYNAME;

                    CodingRuleNew.RESET;
                    CodingRuleNew.SETRANGE("Company Name", COMPANYNAME);
                    CodingRuleNew.SETRANGE("Is Subset", TRUE);
                    CodingRuleNew.SETRANGE(Name, CodingRule.Name);
                    IF CodingRuleNew.FINDFIRST THEN
                      UserCompNew."Coding Rule ID" := CodingRuleNew.ID
                    ELSE
                      UserCompNew."Coding Rule ID" := 0;

                    UserCompNew.INSERT(TRUE);
                  END;
              UNTIL UserComp.NEXT = 0;
          END;

        'USERGROUP':
          BEGIN
            ExUserGroup.RESET;
            ExUserGroup.SETRANGE("Company Name", Comp);
            IF ExUserGroup.FIND('-') THEN
              REPEAT
                IF ExUserGroupNew.GET(COMPANYNAME, ExUserGroup.Code) THEN BEGIN
                  ExUserGroupNew.TRANSFERFIELDS(ExUserGroup, FALSE);
                  ExUserGroupNew.MODIFY(TRUE);
                END
                ELSE BEGIN
                  ExUserGroupNew.INIT;
                  ExUserGroupNew.TRANSFERFIELDS(ExUserGroup);
                  ExUserGroupNew."Company Name" := COMPANYNAME;
                  ExUserGroupNew.INSERT(TRUE);
                END;

                ExUserGroupLine.RESET;
                ExUserGroupLine.SETRANGE("Company Name", ExUserGroup."Company Name");
                ExUserGroupLine.SETRANGE(Code, ExUserGroup.Code);
                IF ExUserGroupLine.FIND('-') THEN
                  REPEAT
                    IF ExUserGroupLineNew.GET(COMPANYNAME,ExUserGroupNew.Code,ExUserGroupLine."Line No.") THEN BEGIN
                      ExUserGroupLineNew.TRANSFERFIELDS(ExUserGroupLine);
                      ExUserGroupLineNew.MODIFY(TRUE);
                    END
                    ELSE BEGIN
                      ExUserGroupLineNew.INIT;
                      ExUserGroupLineNew.TRANSFERFIELDS(ExUserGroupLine);
                      ExUserGroupLineNew."Company Name" := ExUserGroupNew."Company Name";
                      ExUserGroupLineNew.INSERT(TRUE);
                    END;
                  UNTIL ExUserGroupLine.NEXT = 0;
              UNTIL ExUserGroup.NEXT = 0;
          END;
        'TEMPLATES':
          BEGIN
            TemplateRule.RESET;
            TemplateRule.SETRANGE("Company Name", Comp);
            IF TemplateRule.FIND('-') THEN
              REPEAT
                IF TemplateRuleNew.GET(COMPANYNAME, TemplateRule.Code) THEN
                  BEGIN
                    TemplateRuleNew.TRANSFERFIELDS(TemplateRule, FALSE);
                    TemplateRuleNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    TemplateRuleNew.COPY(TemplateRule);
                    TemplateRuleNew."Company Name" := COMPANYNAME;
                    TemplateRuleNew.INSERT(TRUE);
                  END;

                TemplateRuleLine.RESET;
                TemplateRuleLine.SETRANGE("Company Name", Comp);
                TemplateRuleLine.SETRANGE(Code, TemplateRule.Code);
                IF TemplateRuleLine.FIND('-') THEN
                  REPEAT
                    IF TemplateRuleLineNew.GET(COMPANYNAME, TemplateRule.Code, TemplateRuleLine."Line No.") THEN
                      BEGIN
                        TemplateRuleLineNew.TRANSFERFIELDS(TemplateRuleLine, FALSE);
                        TemplateRuleLineNew.MODIFY(TRUE);
                      END
                    ELSE
                      BEGIN
                        TemplateRuleLineNew.COPY(TemplateRuleLine);
                        TemplateRuleLineNew."Company Name" := COMPANYNAME;
                        TemplateRuleLineNew.INSERT(TRUE);
                      END;
                  UNTIL TemplateRuleLine.NEXT = 0;
              UNTIL TemplateRule.NEXT = 0;
          END;
        'VENDORID':
          BEGIN
            VendorID.RESET;
            VendorID.CHANGECOMPANY(Comp);
            IF VendorID.FIND('-') THEN BEGIN
              REPEAT
                IF NOT VendorIDNew.GET(VendorID."Table No.",VendorID."Field No.") THEN BEGIN
                  VendorIDNew.INIT;
                  VendorIDNew.TRANSFERFIELDS(VendorID);
                  VendorIDNew.INSERT;
                END;
              UNTIL VendorID.NEXT = 0;

              VendorIDMgt.UpdateAllFieldIDs(TRUE);
            END;
          END;
        'EXFSTDPURCHCODE':
          BEGIN
            ExFStdPurchCode.RESET;
            ExFStdPurchCode.CHANGECOMPANY(Comp);
            IF ExFStdPurchCode.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExFStdPurchCodeNew.GET(ExFStdPurchCode.Code) THEN BEGIN
                  ExFStdPurchCodeNew.INIT;
                  ExFStdPurchCodeNew.TRANSFERFIELDS(ExFStdPurchCode);
                  ExFStdPurchCodeNew.INSERT;
                END;
              UNTIL ExFStdPurchCode.NEXT = 0;

              ExStdPurchCodeLine.RESET;
              ExStdPurchCodeLine.CHANGECOMPANY(Comp);
              IF ExStdPurchCodeLine.FIND('-') THEN BEGIN
                REPEAT
                  IF NOT ExStdPurchCodeLineNew.GET(ExStdPurchCodeLine."EX Standard Purchase Code",
                                                   ExStdPurchCodeLine."Line No.") THEN BEGIN
                    ExStdPurchCodeLineNew.INIT;
                    ExStdPurchCodeLineNew.TRANSFERFIELDS(ExStdPurchCodeLine);
                    ExStdPurchCodeLineNew.INSERT;
                  END;
                UNTIL ExStdPurchCodeLine.NEXT = 0;
              END;
            END;
          END;
        'ADVVEND':
          BEGIN
            ExAdvVend.RESET;
            ExAdvVend.CHANGECOMPANY(Comp);
            IF ExAdvVend.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExAdvVendNew.GET(ExAdvVend."Vendor No.") THEN BEGIN
                  ExAdvVendNew.INIT;
                  ExAdvVendNew.TRANSFERFIELDS(ExAdvVend);
                  ExAdvVendNew.INSERT;
                END ELSE BEGIN
                  ExAdvVendNew.TRANSFERFIELDS(ExAdvVend);
                  ExAdvVendNew.MODIFY;
                END;
              UNTIL ExAdvVend.NEXT = 0;
            END;
          END;
        'LINEADV':
          BEGIN
            ExLineAdv.RESET;
            ExLineAdv.CHANGECOMPANY(Comp);
            IF ExLineAdv.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExLineAdvNew.GET(ExLineAdv.Type,ExLineAdv."No.") THEN BEGIN
                  ExLineAdvNew.INIT;
                  ExLineAdvNew.TRANSFERFIELDS(ExLineAdv);
                  ExLineAdvNew.INSERT;
                END ELSE BEGIN
                  ExLineAdvNew.TRANSFERFIELDS(ExLineAdv);
                  ExLineAdvNew.MODIFY;
                END;
              UNTIL ExLineAdv.NEXT = 0;
            END;
          END;
        'HEADERMAP':
          BEGIN
            ExHeaderMap.RESET;
            ExHeaderMap.CHANGECOMPANY(Comp);
            IF ExHeaderMap.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExHeaderMapNew.GET(ExHeaderMap."Field No.") THEN BEGIN
                  ExHeaderMapNew.INIT;
                  ExHeaderMapNew.TRANSFERFIELDS(ExHeaderMap);
                  ExHeaderMapNew.INSERT;
                END ELSE BEGIN
                  ExHeaderMapNew.TRANSFERFIELDS(ExHeaderMap);
                  ExHeaderMapNew.MODIFY;
                END;
              UNTIL ExHeaderMap.NEXT = 0;
            END;
          END;
        'EMAILHEAD':
          BEGIN
            ExEmailHead.RESET;
            ExEmailHead.CHANGECOMPANY(Comp);
            IF ExEmailHead.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExEmailHeadNew.GET(ExEmailHead.Type) THEN BEGIN
                  ExEmailHeadNew.INIT;
                  ExEmailHeadNew.TRANSFERFIELDS(ExEmailHead);
                  ExEmailHeadNew.INSERT;
                END ELSE BEGIN
                  ExEmailHeadNew.TRANSFERFIELDS(ExEmailHead);
                  ExEmailHeadNew.MODIFY;
                END;
              UNTIL ExEmailHead.NEXT = 0;
            END;
          END;
        'DIMGLMAP':
          BEGIN
            ExDimGLMap.RESET;
            ExDimGLMap.CHANGECOMPANY(Comp);
            IF ExDimGLMap.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExDimGLMapNew.GET(ExDimGLMap."Dimension Code",ExDimGLMap."Dimension Value Code") THEN BEGIN
                  ExDimGLMapNew.INIT;
                  ExDimGLMapNew.TRANSFERFIELDS(ExDimGLMap);
                  ExDimGLMapNew.INSERT;
                END ELSE BEGIN
                  ExDimGLMapNew.TRANSFERFIELDS(ExDimGLMap);
                  ExDimGLMapNew.MODIFY;
                END;
              UNTIL ExDimGLMap.NEXT = 0;
            END;
          END;
        'REQRULE':
          BEGIN
            ExReqRule.RESET;
            ExReqRule.SETRANGE("Company Name", Comp);
            IF ExReqRule.FIND('-') THEN
              REPEAT
                IF ExReqRuleNew.GET(COMPANYNAME, ExReqRule.Code) THEN
                  BEGIN
                    ExReqRuleNew.TRANSFERFIELDS(ExReqRule, FALSE);
                    ExReqRuleNew."Company Name" := COMPANYNAME;
                    ExReqRuleNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    ExReqRuleNew.COPY(ExReqRule);
                    ExReqRuleNew."Company Name" := COMPANYNAME;
                    ExReqRuleNew.INSERT(TRUE);
                  END;
              UNTIL ExReqRule.NEXT = 0;
          END;
        'INVCODE':
          BEGIN
            ExInvCode.RESET;
            ExInvCode.SETRANGE("Company Name", Comp);
            IF ExInvCode.FIND('-') THEN
              REPEAT
                ExInvCodeNew.RESET;
                ExInvCodeNew.SETRANGE("Company Name", COMPANYNAME);
                ExInvCodeNew.SETRANGE("Invoicing Code",ExInvCode."Invoicing Code");
                IF ExInvCodeNew.FINDFIRST THEN
                  BEGIN
                    ExInvCodeNew.TRANSFERFIELDS(ExInvCode, FALSE);
                    ExInvCodeNew."Company Name" := COMPANYNAME;
                    ExInvCodeNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    ExInvCodeNew.COPY(ExInvCode);
                    ExInvCodeNew.ID := 0;
                    ExInvCodeNew."Company Name" := COMPANYNAME;
                    ExInvCodeNew.INSERT(TRUE);
                  END;
              UNTIL ExInvCode.NEXT = 0;
          END;
        'EXWEBCODE':
          BEGIN
            ExWebCode.RESET;
            ExWebCode.SETRANGE("Company Name", Comp);
            IF ExWebCode.FIND('-') THEN
              REPEAT
                ExWebCodeNew.RESET;
                ExWebCodeNew.SETRANGE("Company Name", COMPANYNAME);
                ExWebCodeNew.SETRANGE("Field No",ExWebCode."Field No");
                IF ExWebCodeNew.FINDFIRST THEN
                  BEGIN
                    ExWebCodeNew.TRANSFERFIELDS(ExWebCode, FALSE);
                    ExWebCodeNew."Company Name" := COMPANYNAME;
                    ExWebCodeNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    ExWebCodeNew.COPY(ExWebCode);
                    ExWebCodeNew.ID := 0;
                    ExWebCodeNew."Company Name" := COMPANYNAME;
                    ExWebCodeNew.INSERT(TRUE);
                  END;
              UNTIL ExWebCode.NEXT = 0;
          END;
        'EXLOC':
          BEGIN
            ExLoc.RESET;
            ExLoc.SETRANGE("Company Name", Comp);
            IF ExLoc.FIND('-') THEN
              REPEAT
                ExLocNew.RESET;
                ExLocNew.SETRANGE("Company Name", COMPANYNAME);
                ExLocNew.SETRANGE(Code,ExLoc.Code);
                IF ExLocNew.FINDFIRST THEN
                  BEGIN
                    ExLocNew.TRANSFERFIELDS(ExLoc, FALSE);
                    ExLocNew."Company Name" := COMPANYNAME;
                    ExLocNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    ExLocNew.COPY(ExLoc);
                    ExLocNew.ID := 0;
                    ExLocNew."Company Name" := COMPANYNAME;
                    ExLocNew.INSERT(TRUE);
                  END;
              UNTIL ExLoc.NEXT = 0;
          END;
        'RSONLINE':
          BEGIN
            ExRsOnline.RESET;
            ExRsOnline.SETRANGE("Ex Company", Comp);
            IF ExRsOnline.FIND('-') THEN
              REPEAT
                IF ExRsOnlineNew.GET(COMPANYNAME, ExRsOnline.Type,ExRsOnline."Sub Type") THEN
                  BEGIN
                    ExRsOnlineNew.TRANSFERFIELDS(ExRsOnline, FALSE);
                    ExRsOnlineNew."Ex Company" := COMPANYNAME;
                    ExRsOnlineNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    ExRsOnlineNew.COPY(ExRsOnline);
                    ExRsOnlineNew."Ex Company" := COMPANYNAME;
                    ExRsOnlineNew.INSERT(TRUE);
                  END;
              UNTIL ExRsOnline.NEXT = 0;
          END;
        'LOCADV':
          BEGIN
            ExLocAdv.RESET;
            ExLocAdv.CHANGECOMPANY(Comp);
            IF ExLocAdv.FIND('-') THEN BEGIN
              REPEAT
                IF Location.GET(ExLocAdv."Location Code") THEN BEGIN
                  IF NOT ExLocAdvNew.GET(ExLocAdv."Location Code",ExLocAdv.Type) THEN BEGIN
                    ExLocAdvNew.INIT;
                    ExLocAdvNew.TRANSFERFIELDS(ExLocAdv);
                    ExLocAdvNew.INSERT;
                  END ELSE BEGIN
                    ExLocAdvNew.TRANSFERFIELDS(ExLocAdv);
                    ExLocAdvNew.MODIFY;
                  END
                END;
              UNTIL ExLocAdv.NEXT = 0;
            END;
          END;
        'FRAUDVEND':
          BEGIN
            FraudVendID.RESET;
            FraudVendID.SETRANGE("Ex Company", Comp);
            IF FraudVendID.FIND('-') THEN
              REPEAT
                IF FraudVendIDNew.GET(COMPANYNAME) THEN
                  BEGIN
                    FraudVendIDNew.TRANSFERFIELDS(FraudVendID, FALSE);
                    FraudVendIDNew."Ex Company" := COMPANYNAME;
                    FraudVendIDNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    FraudVendIDNew.COPY(FraudVendID);
                    FraudVendIDNew."Ex Company" := COMPANYNAME;
                    FraudVendIDNew.INSERT(TRUE);
                  END;
              UNTIL FraudVendID.NEXT = 0;
          END;
        'OCRFORMAT':
          BEGIN
            OCRFormat.RESET;
            OCRFormat.SETRANGE("Company Name", Comp);
            IF OCRFormat.FIND('-') THEN
              REPEAT
                IF OCRFormatNew.GET(COMPANYNAME, OCRFormat."Entry No.") THEN
                  BEGIN
                    OCRFormatNew.TRANSFERFIELDS(OCRFormat, FALSE);
                    OCRFormatNew."Company Name" := COMPANYNAME;
                    OCRFormatNew.MODIFY(TRUE);
                  END
                ELSE
                  BEGIN
                    OCRFormatNew.COPY(OCRFormat);
                    OCRFormatNew."Company Name" := COMPANYNAME;
                    OCRFormatNew.INSERT(TRUE);
                  END;
              UNTIL OCRFormat.NEXT = 0;
          END;
        'OCRUNIT':
          BEGIN
            OCRUnit.RESET;
            OCRUnit.CHANGECOMPANY(Comp);
            OCRUnit.SETFILTER("Vendor No.",'%1','');
            IF OCRUnit.FIND('-') THEN BEGIN
              REPEAT
                IF NOT OCRUnitNew.GET(OCRUnit."Vendor No.",OCRUnit."Invoice Unit") THEN BEGIN
                  OCRUnitNew.INIT;
                  OCRUnitNew.TRANSFERFIELDS(OCRUnit);
                  OCRUnitNew.INSERT;
                END ELSE BEGIN
                  OCRUnitNew.TRANSFERFIELDS(OCRUnit);
                  OCRUnitNew.MODIFY;
                END;
              UNTIL OCRUnit.NEXT = 0;
            END;
          END;

        'EXCONTRACT':
          BEGIN
            ExContract.RESET;
            ExContract.CHANGECOMPANY(Comp);
            IF ExContract.FIND('-') THEN BEGIN
              REPEAT
                IF NOT ExContractNew.GET(ExContract."Contract No.") THEN BEGIN
                  ExContractNew.INIT;
                  ExContractNew.TRANSFERFIELDS(ExContract);
                  ExContractNew.INSERT;
                END ELSE BEGIN
                  ExContractNew.TRANSFERFIELDS(ExContract);
                  ExContractNew.MODIFY;
                END;
              UNTIL ExContract.NEXT = 0;
            END;
          END;

        'TRANSACTIONS':
          BEGIN
            ExDoc.RESET;
            ExDoc.SETRANGE("Company Name", Comp);
            IF ExDoc.FINDSET THEN BEGIN
              TotCount := ExDoc.COUNT;
              Window.OPEN(EXF57);
              REPEAT
                Window.UPDATE(1,10000 * ROUND(TempCount/TotCount));
                TempCount += 1;

                ExDocNew.INIT;
                ExDocNew.TRANSFERFIELDS(ExDoc);
                ExDocNew."Company Name" := COMPANYNAME;
                ExDocNew.ID := 0;
                ExDocNew.INSERT;

                ExDocLine.RESET;
                ExDocLine.SETCURRENTKEY("Document ID");
                ExDocLine.SETRANGE("Company Name", Comp);
                ExDocLine.SETRANGE("Document ID", ExDoc.ID);
                IF ExDocLine.FINDSET THEN
                  REPEAT
                    ExDocLineNew.INIT;
                    ExDocLineNew.TRANSFERFIELDS(ExDocLine);
                    ExDocLineNew."Company Name" := COMPANYNAME;
                    ExDocLineNew.ID := 0;
                    ExDocLineNew."Document ID" := ExDocNew.ID;
                    ExDocLineNew.INSERT;

                    ExDocLineApp.RESET;
                    ExDocLineApp.SETRANGE("Company Name", Comp);
                    ExDocLineApp.SETRANGE("Document Line ID", ExDocLine.ID);
                    IF ExDocLineApp.FINDSET THEN
                      REPEAT
                        ExDocLineAppNew.INIT;
                        ExDocLineAppNew.TRANSFERFIELDS(ExDocLineApp);
                        ExDocLineAppNew."Company Name" := COMPANYNAME;
                        ExDocLineAppNew.ID := 0;
                        ExDocLineAppNew."Document Line ID" := ExDocLineNew.ID;
                        ExDocLineAppNew."Document ID" := ExDocLineNew."Document ID";
                        ExDocLineAppNew.INSERT;
                      UNTIL ExDocLineApp.NEXT = 0;

                    ExDocLineDim.RESET;
                    ExDocLineDim.SETRANGE("Company Name", Comp);
                    ExDocLineDim.SETRANGE("Document Line ID", ExDocLine.ID);
                    IF ExDocLineDim.FINDSET THEN
                      REPEAT
                        ExDocLineDimNew.INIT;
                        ExDocLineDimNew.TRANSFERFIELDS(ExDocLineDim);
                        ExDocLineDimNew."Company Name" := COMPANYNAME;
                        ExDocLineDimNew.ID := 0;
                        ExDocLineDimNew."Document Line ID" := ExDocLineNew.ID;
                        ExDocLineDimNew."Document ID" := ExDocLineNew."Document ID";

                        ColumnNew.GET(ExDocLineDimNew."Company Name",ExDocLineDimNew."Dimension Code");
                        ExDocLineDimNew."Column ID" := ColumnNew.ID;

                        ExDocLineDimNew.INSERT;
                      UNTIL ExDocLineDim.NEXT = 0;
                  UNTIL ExDocLine.NEXT = 0;
              UNTIL ExDoc.NEXT = 0;
            END;
          END;
      END;
    END;

    PROCEDURE MakeTotals@1100285033(PurchLine@1100285000 : Record 39;VAR TotPurchAmt@1100285002 : Decimal);
    VAR
      PurchLine2@1100285001 : Record 39;
    BEGIN
      TotPurchAmt := 0;

      PurchLine2.RESET;
      IF PurchLine2.SETCURRENTKEY("Document No.") THEN;
      PurchLine2.SETRANGE("Document Type",PurchLine."Document Type");
      PurchLine2.SETRANGE("Document No.",PurchLine."Document No.");
      IF PurchLine2.FINDSET THEN
        REPEAT
          IF PurchLine2."Line No." <> PurchLine."Line No." THEN
            TotPurchAmt += PurchLine2."Line Amount";
        UNTIL PurchLine2.NEXT = 0;

      TotPurchAmt += PurchLine."Line Amount";
    END;

    PROCEDURE GetPurchHeaderImageName@1100285031(CompName@1100285000 : Text[50];DocType@1100285002 : Integer;DocNo@1100285003 : Code[20]) : Text[250];
    VAR
      ExDoc2@1100285001 : Record 12013612;
    BEGIN
      ExDoc2.RESET;
      ExDoc2.SETCURRENTKEY("Document No.");
      ExDoc2.SETRANGE("Company Name", CompName);
      CASE DocType OF
        0: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::Quote);
        1: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::Order);
        2: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::Invoice);
        3: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Credit Memo");
        4: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Blanket Order");
        5: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Return Order");
        7: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Posted Invoice"); // Copy Doc Function
        9: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Posted Credit Memo"); // Copy Doc Function
      END;

      ExDoc2.SETRANGE("Document No.", DocNo);
      IF ExDoc2.FINDFIRST THEN
        EXIT(ExDoc2."Image Name")
      ELSE
        EXIT('');
    END;

    PROCEDURE GetPostedImageName@1100285040(CompName@1100285003 : Text[50];DocType@1100285002 : Integer;DocNo@1100285000 : Code[20]) : Text[250];
    VAR
      ExDoc2@1100285001 : Record 12013612;
    BEGIN
      ExDoc2.RESET;
      ExDoc2.SETCURRENTKEY("Document No.");
      ExDoc2.SETRANGE("Company Name", CompName);
      CASE DocType OF
        2: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Posted Invoice");
        3: ExDoc2.SETRANGE("Document Type", ExDoc2."Document Type"::"Posted Credit Memo");
      END;
      ExDoc2.SETRANGE("Document No.", DocNo);
      IF ExDoc2.FINDFIRST THEN
        EXIT(ExDoc2."Image Name")
      ELSE
        EXIT('');
    END;

    PROCEDURE HasAttachmentPostedDoc@1100285035(DocType@1100285000 : ' ,Payment,Invoice,Credit Memo,Finance Charge Memo,Reminder,Refund';DocNo@1100285001 : Code[20]) : Boolean;
    VAR
      ExAttachment@1100285002 : Record 12013643;
    BEGIN
      IF NOT ExAttachment.READPERMISSION THEN
        EXIT(FALSE);

      ExAttachment.RESET;
      ExAttachment.SETRANGE("Company Name", COMPANYNAME);
      CASE DocType OF
        DocType::Invoice:
          ExAttachment.SETRANGE("Document Type", ExAttachment."Document Type"::"Posted Invoice");
        DocType::"Credit Memo":
          ExAttachment.SETRANGE("Document Type", ExAttachment."Document Type"::"Posted Credit Memo");
        ELSE
          EXIT(FALSE);
      END;

      ExAttachment.SETRANGE("Document No.", DocNo);
      EXIT(NOT ExAttachment.ISEMPTY);
    END;

    PROCEDURE ShowAttachmentPostedDoc@1100285037(DocType@1100285002 : ' ,Payment,Invoice,Credit Memo,Finance Charge Memo,Reminder,Refund';DocNo@1100285001 : Code[20]) : Boolean;
    VAR
      ExAttachment@1100285000 : Record 12013643;
      ShowAttachedFiles@1100285003 : Page 12013644;
    BEGIN
      ExAttachment.RESET;
      ExAttachment.SETCURRENTKEY("Document No.");

      ExAttachment.FILTERGROUP := 2;

      ExAttachment.SETRANGE("Company Name", COMPANYNAME);
      CASE DocType OF
        DocType::Invoice:
          ExAttachment.SETRANGE("Document Type", ExAttachment."Document Type"::"Posted Invoice");
        DocType::"Credit Memo":
          ExAttachment.SETRANGE("Document Type", ExAttachment."Document Type"::"Posted Credit Memo");
        ELSE
          EXIT(FALSE);
      END;
      ExAttachment.SETRANGE("Document No.", DocNo);

      ExAttachment.FILTERGROUP := 0;

      CLEAR(ShowAttachedFiles);
      ShowAttachedFiles.EDITABLE := FALSE;
      ShowAttachedFiles.SETTABLEVIEW(ExAttachment);
      ShowAttachedFiles.RUNMODAL;
    END;

    PROCEDURE ShowAttachmentDoc@1100285034(CompName@1100285003 : Text[50];DocType@1100285002 : ' ,Payment,Invoice,Credit Memo,Finance Charge Memo,Reminder,Refund';DocNo@1100285001 : Code[20]) : Boolean;
    VAR
      ExAttachment@1100285000 : Record 12013643;
    BEGIN
      ExAttachment.RESET;
      ExAttachment.SETCURRENTKEY("Document No.");

      ExAttachment.FILTERGROUP := 2;

      ExAttachment.SETRANGE("Company Name", CompName);
      ExAttachment.SETRANGE("Document Type", DocType);
      ExAttachment.SETRANGE("Document No.", DocNo);

      ExAttachment.FILTERGROUP := 0;

      PAGE.RUNMODAL(12013644,ExAttachment);
    END;

    PROCEDURE ChangeImageDoc@1100285036(VAR ExDocument@1100285000 : Record 12013608);
    VAR
      ExDocHead2@1100285001 : Record 12013612;
      PurchHeader@1100285008 : Record 38;
      ExFlowBlob@1100285005 : Record 12013591;
      ExFPurchaseHeader@1100285009 : Record 12013587;
      ExFlowWorkFlowMgt@1100285007 : Codeunit 12013593;
      NewImageName@1100285002 : Text[250];
      RetBlobNo@1100285006 : Integer;
    BEGIN
      WITH ExDocument DO BEGIN
        NewImageName := '';
        ExFlowBlob.ImportBLOB(NewImageName,RetBlobNo,NewImageName);

        IF NewImageName = '' THEN
          EXIT;

        PurchHeader."Pay-to Vendor No." := "Vendor No.";
        PurchHeader."No." := "Document No.";
        ExFPurchaseHeader."Image File Name" := NewImageName;
        ExFlowWorkFlowMgt.SaveImageToFileSys(RetBlobNo,PurchHeader,ExFPurchaseHeader,NewImageName);

        "Image Name" := NewImageName;
        MODIFY;

        ExDocHead2.RESET;
        ExDocHead2.SETCURRENTKEY("Document No.");
        ExDocHead2.SETRANGE("Company Name");
        ExDocHead2.SETRANGE("Document Type");
        ExDocHead2.SETRANGE("Document No.");
        ExDocHead2.FIND('-');
        ExDocHead2."Image Name" := NewImageName;
        ExDocHead2.MODIFY;
      END;
    END;

    PROCEDURE ExFlowPropose@1100285045(VAR PurchLine@1100285009 : Record 39;CurrentDocDimCode@1100285002 : Code[20];CurrentDocDimValue@1100285004 : Code[20]);
    VAR
      AppSetup@1100285000 : Record 12013601;
      DocLine@1100285005 : Record 12013609;
    BEGIN
      IF NOT AppSetup.GET(COMPANYNAME,0) THEN
        EXIT;

      IF DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
        CreateApprovers(DocLine,PurchLine,PurchLine."Template Rule",FALSE,CurrentDocDimCode,CurrentDocDimValue,FALSE);
    END;

    PROCEDURE ExFlowUpdateDim@1100285049(Action@1100285000 : Integer;VAR PurchLine@1100285007 : Record 39;DimCode@1100285001 : Code[20];DimValue@1100285011 : Code[20];SilentMode@1100285012 : Boolean);
    VAR
      DocLineDim@1100285002 : Record 12013611;
      Column@1100285003 : Record 12013661;
      DocLine@1100285004 : Record 12013609;
      ColumnID@1100285006 : Integer;
    BEGIN
      IF NOT DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
        EXIT;

      AppSetUp.GET(COMPANYNAME,0);

      TestifApprovedDim(PurchLine,DocLine,AppSetUp,SilentMode);

      CASE Action OF
        1      :
          BEGIN
            IF DocLineDim.RetrieveRecord(DocLineDim,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.",
                                         DimCode) THEN
              DocLineDim.DELETE(FALSE);

            ColumnID := GetColumnID(DimCode);

            IF ColumnID <> 0 THEN
              IF Column.GET(COMPANYNAME,ColumnID) THEN
                BEGIN
                  DocLineDim.INIT;
                  DocLineDim.ID := 0;
                  DocLineDim."Company Name" := COMPANYNAME;
                  DocLineDim."Document Type" := PurchLine."Document Type";
                  DocLineDim."Document No." := PurchLine."Document No.";
                  DocLineDim."Line No." := PurchLine."Line No.";
                  DocLineDim."Dimension Code" := DimCode;
                  DocLineDim."Dimension Value" := DimValue;
                  DocLineDim."Column ID" := Column.ID;
                  DocLineDim."Document Line ID" := DocLine.ID;
                  DocLineDim."Document ID" := DocLine."Document ID";
                  IF DimValue <> '' THEN
                    DocLineDim.INSERT;
                END;
          END;

        2   :
          BEGIN
            IF DocLineDim.RetrieveRecord(DocLineDim,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.",
                                         DimCode) THEN
              BEGIN
                DocLineDim."Dimension Value" := DimValue;
                DocLineDim.MODIFY;
              END
            ELSE
              BEGIN
                ColumnID := GetColumnID(DimCode);

                IF ColumnID <> 0 THEN
                  IF Column.GET(COMPANYNAME,ColumnID) THEN
                    BEGIN
                      DocLineDim.INIT;
                      DocLineDim.ID := 0;
                      DocLineDim."Company Name" := COMPANYNAME;
                      DocLineDim."Document Type" := PurchLine."Document Type";
                      DocLineDim."Document No." := PurchLine."Document No.";
                      DocLineDim."Line No." := PurchLine."Line No.";
                      DocLineDim."Dimension Code" := DimCode;
                      DocLineDim."Dimension Value" := DimValue;
                      DocLineDim."Column ID" := Column.ID;
                      DocLineDim."Document Line ID" := DocLine.ID;
                      DocLineDim."Document ID" := DocLine."Document ID";
                      IF DimValue <> '' THEN
                        DocLineDim.INSERT;
                    END;
              END;
          END;

        3   :
          BEGIN
            IF DocLineDim.RetrieveRecord(DocLineDim,COMPANYNAME,PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.",
                                         DimCode) THEN
              DocLineDim.DELETE;
          END;
      END;
    END;

    PROCEDURE AlreadyApprovedByActualUser@1100285042(PurchLine@1100285000 : Record 39) : Boolean;
    VAR
      DocLineApp@1100285001 : Record 12013610;
      DocLine@1100285002 : Record 12013609;
    BEGIN
      IF NOT DocLine.RetrieveRecord(DocLine,COMPANYNAME,PurchLine."Document Type",
                                    PurchLine."Document No.",PurchLine."Line No.") THEN
        EXIT(FALSE);

      DocLineApp.RESET;
      DocLineApp.SETCURRENTKEY("Document Line ID");
      DocLineApp.SETRANGE("Document Line ID", DocLine.ID);
      DocLineApp.SETFILTER("Approved By",'<>%1','');
      DocLineApp.SETFILTER(Flowstatus, '<>%1', DocLineApp.Flowstatus::Rejected);
      DocLineApp.SETRANGE("Auto Approved", FALSE);
      EXIT(DocLineApp.FINDFIRST);
    END;

    PROCEDURE MatchedQtyStillMatchedInv@1100285046(RcptNo@1100285002 : Code[20];LineNo@1100285001 : Integer;DocType@1100285004 : 'Receipt,Return Shipment,Purchase Order';VAR MatchedAmt@1100285005 : Decimal;VAR MatchedAmtLCY@1100285008 : Decimal) MatchedQty : Decimal;
    VAR
      PurchLine@1100285000 : Record 39;
      PurchHeader@1100285007 : Record 38;
      CurrExchRate@1100285006 : Record 330;
      RcptFound@1100285003 : Boolean;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      RcptFound := TRUE;
      IF DocType = DocType::"Purchase Order" THEN
        RcptFound := GetReceiptNo(RcptNo,LineNo);

      MatchedQty := 0;
      MatchedAmt := 0;

      PurchLine.RESET;
      IF RcptFound THEN BEGIN
        IF DocType IN [DocType::Receipt,DocType::"Purchase Order"] THEN BEGIN
          PurchLine.SETCURRENTKEY("Document Type","Receipt No.","Receipt Line No.");
          PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::Invoice);
          PurchLine.SETRANGE("Receipt No.", RcptNo);
          PurchLine.SETRANGE("Receipt Line No.", LineNo);
        END
        ELSE BEGIN
          PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::"Credit Memo");
          PurchLine.SETRANGE("Return Shipment No.", RcptNo);
          PurchLine.SETRANGE("Return Shipment Line No.", LineNo);
        END
      END
      ELSE BEGIN // Receipt not found i.e connected to a PO
        PurchLine.SETRANGE("ExFlow Order No.", RcptNo);
        PurchLine.SETRANGE("ExFlow Order Line No.", LineNo);
      END;

      IF PurchLine.FINDSET THEN
        REPEAT
          IF PurchLine."Currency Code" <> '' THEN BEGIN
            IF (PurchHeader."Document Type" <> PurchLine."Document Type") OR
               (PurchHeader."No." <> PurchLine."Document No.") THEN
              PurchHeader.GET(PurchLine."Document Type",PurchLine."Document No.");

              MatchedAmtLCY := MatchedAmtLCY + CurrExchRate.ExchangeAmtFCYToLCY(0,PurchHeader."Job No.", // 4PS
              TODAY,PurchHeader."Currency Code",
              PurchLine."Line Amount",PurchHeader."Currency Factor",FALSE); // 4PS
          END ELSE
            MatchedAmtLCY := MatchedAmt + PurchLine."Line Amount";

          MatchedAmt := MatchedAmt + PurchLine."Line Amount";
          MatchedQty := MatchedQty + PurchLine.Quantity;
        UNTIL PurchLine.NEXT = 0;

      EXIT(MatchedQty);
    END;

    PROCEDURE DrillDownMatchedQtyInv@1100285044(RcptNo@1100285002 : Code[20];LineNo@1100285001 : Integer;DocType@1100285004 : 'Receipt,Return Shipment,Purchase Order');
    VAR
      PurchLine@1100285000 : Record 39;
      RcptFound@1100285003 : Boolean;
    BEGIN
      RcptFound := TRUE;
      IF DocType = DocType::"Purchase Order" THEN
        RcptFound := GetReceiptNo(RcptNo,LineNo);

      PurchLine.RESET;
      IF RcptFound THEN BEGIN
        IF DocType IN [DocType::Receipt,DocType::"Purchase Order"] THEN BEGIN
          PurchLine.SETCURRENTKEY("Document Type","Receipt No.","Receipt Line No.");
          PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::Invoice);
          PurchLine.SETRANGE("Receipt No.", RcptNo);
          PurchLine.SETRANGE("Receipt Line No.", LineNo);
        END
        ELSE BEGIN
          PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::"Credit Memo");
          PurchLine.SETRANGE("Return Shipment No.", RcptNo);
          PurchLine.SETRANGE("Return Shipment Line No.", LineNo);
        END
      END
      ELSE BEGIN // Receipt not found i.e connected to a PO
        PurchLine.SETRANGE("ExFlow Order No.", RcptNo);
        PurchLine.SETRANGE("ExFlow Order Line No.", LineNo);
      END;

      PAGE.RUN(0,PurchLine);
    END;

    PROCEDURE MatchedQtyStillMatchedExWork@1100285043(RcptNo@1100285002 : Code[20];LineNo@1100285000 : Integer;DocType@1100285004 : 'Receipt,Return Shipment,Purchase Order';VAR MatchedAmt@1100285005 : Decimal;VAR MatchedAmtLCY@1100285008 : Decimal) MatchedQty : Decimal;
    VAR
      EXPurchDocLine@1100285001 : Record 12013588;
      EXPurchDocLHeader@1100285006 : Record 12013587;
      CurrExchRate@1100285007 : Record 330;
      RcptFound@1100285003 : Boolean;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      RcptFound := TRUE;
      IF DocType = DocType::"Purchase Order" THEN
        RcptFound := GetReceiptNo(RcptNo,LineNo);

      MatchedQty := 0;
      MatchedAmt := 0;
      MatchedAmtLCY := 0;

      EXPurchDocLine.RESET;
      IF RcptFound THEN BEGIN
        IF DocType IN [DocType::Receipt,DocType::"Purchase Order"] THEN BEGIN
          EXPurchDocLine.SETCURRENTKEY("Receipt No.","Receipt Line No.");
          EXPurchDocLine.SETRANGE("Receipt No.", RcptNo);
          EXPurchDocLine.SETRANGE("Receipt Line No.", LineNo);
        END
        ELSE BEGIN
          EXPurchDocLine.SETRANGE("Return Shipment No.", RcptNo);
          EXPurchDocLine.SETRANGE("Return Shipment Line No.", LineNo);
        END
      END
      ELSE BEGIN // Receipt not found i.e connected to a PO
        EXPurchDocLine.SETRANGE("Order No.", RcptNo);
        EXPurchDocLine.SETRANGE("Order Line No.", LineNo);
      END;

      IF EXPurchDocLine.FINDSET THEN
        REPEAT
          IF EXPurchDocLine."Currency Code" <> '' THEN BEGIN
            IF EXPurchDocLHeader."Inbound Document No." <> EXPurchDocLine."Inbound Document No." THEN
              EXPurchDocLHeader.GET(EXPurchDocLine."Inbound Document No.");

              MatchedAmtLCY := CurrExchRate.ExchangeAmtFCYToLCY(0,EXPurchDocLHeader."Job No.", // 4PS
              TODAY,EXPurchDocLHeader."Currency Code",
              EXPurchDocLine.Amount,EXPurchDocLHeader."Currency Factor",FALSE); // 4PS
          END ELSE
            MatchedAmtLCY := MatchedAmtLCY + EXPurchDocLine.Amount;

          MatchedAmt := MatchedAmt + EXPurchDocLine.Amount;
          MatchedQty := MatchedQty + EXPurchDocLine.Quantity;
        UNTIL EXPurchDocLine.NEXT = 0;

      EXIT(MatchedQty);
    END;

    PROCEDURE DrillDownMatchedQtyExWork@1100285012(RcptNo@1100285000 : Code[20];LineNo@1100285002 : Integer;DocType@1100285003 : 'Receipt,Return Shipment,Purchase Order');
    VAR
      EXPurchDocLine@1100285001 : Record 12013588;
      RcptFound@1100285004 : Boolean;
    BEGIN
      RcptFound := TRUE;
      IF DocType = DocType::"Purchase Order" THEN
        RcptFound := GetReceiptNo(RcptNo,LineNo);

      IF RcptFound THEN BEGIN
        EXPurchDocLine.RESET;
        IF DocType IN [DocType::Receipt,DocType::"Purchase Order"] THEN BEGIN
          EXPurchDocLine.SETCURRENTKEY("Receipt No.","Receipt Line No.");
          EXPurchDocLine.SETRANGE("Receipt No.", RcptNo);
          EXPurchDocLine.SETRANGE("Receipt Line No.", LineNo);
        END
        ELSE BEGIN
          EXPurchDocLine.SETRANGE("Return Shipment No.", RcptNo);
          EXPurchDocLine.SETRANGE("Return Shipment Line No.", LineNo);
        END;
      END
      ELSE BEGIN // Receipt not found i.e connected to a PO
        EXPurchDocLine.SETRANGE("Order No.", RcptNo);
        EXPurchDocLine.SETRANGE("Order Line No.", LineNo);
      END;

      PAGE.RUN(0,EXPurchDocLine);
    END;

    PROCEDURE MatchedQtyStillMatchedPostInv@1100285052(RcptNo@1100285002 : Code[20];LineNo@1100285001 : Integer;VAR MatchedAmt@1100285003 : Decimal;VAR MatchedAmtLCY@1100285004 : Decimal) MatchedQty : Decimal;
    VAR
      ExDocEntry@1100285000 : Record 12013620;
    BEGIN
      // This function requires the invoices to be posted through ExFlow since the field Order No is then updated
      MatchedQty := 0;
      MatchedAmt := 0;
      MatchedAmtLCY := 0;

      ExDocEntry.RESET;
      ExDocEntry.SETCURRENTKEY("Order No.");
      ExDocEntry.SETRANGE("Order No.", RcptNo);
      ExDocEntry.SETRANGE("Order Line No.", LineNo);
      IF ExDocEntry.FINDSET THEN
        REPEAT
          MatchedQty := MatchedQty + ExDocEntry.Quantity;
          MatchedAmt := MatchedAmt + ExDocEntry.Amount;
          MatchedAmtLCY := MatchedAmtLCY + ExDocEntry."Amount (LCY)";
        UNTIL ExDocEntry.NEXT = 0;

      EXIT(MatchedQty);
    END;

    PROCEDURE DrillDownMatchedQtyPostInv@1100285051(RcptNo@1100285002 : Code[20];LineNo@1100285001 : Integer);
    VAR
      ExFlowDocEntry@1100285000 : Record 12013620;
    BEGIN
      // This function requires the invoices to be posted through ExFlow since the field Order No is then updated
      ExFlowDocEntry.RESET;
      ExFlowDocEntry.SETCURRENTKEY("Order No.");
      ExFlowDocEntry.SETRANGE("Order No.",RcptNo);
      ExFlowDocEntry.SETRANGE("Order Line No.", LineNo);
      PAGE.RUN(0,ExFlowDocEntry);
    END;

    PROCEDURE CalcMatchedTotalsPurchLine@1100285006(PurchLine@1100285003 : Record 39;VAR TotalQtyAlreadyMatched@1100285002 : Decimal;VAR TotalAmtAlreadyMatched@1100285001 : Decimal;VAR TotalAmtAlreadyMatchedLCY@1100285004 : Decimal);
    VAR
      AmtAlreadyMatched@1100285000 : Decimal;
      AmtAlreadyMatchedLCY@1100285005 : Decimal;
    BEGIN
      TotalQtyAlreadyMatched := 0;
      TotalAmtAlreadyMatched := 0;
      TotalAmtAlreadyMatchedLCY :=0;
      AmtAlreadyMatched := 0;
      AmtAlreadyMatchedLCY := 0;
      TotalQtyAlreadyMatched += MatchedQtyStillMatchedInv(PurchLine."Document No.",PurchLine."Line No.",
                                                          2,AmtAlreadyMatched,AmtAlreadyMatchedLCY);
      TotalAmtAlreadyMatched += AmtAlreadyMatched;
      TotalAmtAlreadyMatchedLCY += AmtAlreadyMatchedLCY;
      TotalQtyAlreadyMatched += MatchedQtyStillMatchedExWork(PurchLine."Document No.",PurchLine."Line No.",
                                                             2,AmtAlreadyMatched,AmtAlreadyMatchedLCY);
      TotalAmtAlreadyMatched += AmtAlreadyMatched;
      TotalAmtAlreadyMatchedLCY += AmtAlreadyMatchedLCY;
      TotalQtyAlreadyMatched += MatchedQtyStillMatchedPostInv(PurchLine."Document No.",PurchLine."Line No.",
                                                              AmtAlreadyMatched,AmtAlreadyMatchedLCY);
      TotalAmtAlreadyMatched += AmtAlreadyMatched;
      TotalAmtAlreadyMatchedLCY += AmtAlreadyMatchedLCY;
    END;

    PROCEDURE CalcPostedMatchedPurchLine@1100285067(PurchLine@1100285003 : Record 39;VAR TotalQtyAlreadyMatched@1100285002 : Decimal;VAR TotalAmtAlreadyMatched@1100285001 : Decimal;VAR TotalAmtAlreadyMatchedLCY@1100285005 : Decimal);
    VAR
      AmtAlreadyMatched@1100285000 : Decimal;
      AmtAlreadyMatchedLCY@1100285004 : Decimal;
    BEGIN
      TotalQtyAlreadyMatched := 0;
      TotalAmtAlreadyMatched := 0;
      TotalAmtAlreadyMatchedLCY := 0;
      AmtAlreadyMatchedLCY := 0;
      AmtAlreadyMatched := 0;
      TotalQtyAlreadyMatched += MatchedQtyStillMatchedPostInv(PurchLine."Document No.",PurchLine."Line No.",
                                                              AmtAlreadyMatched,AmtAlreadyMatchedLCY);
      TotalAmtAlreadyMatched += AmtAlreadyMatched;
      TotalAmtAlreadyMatchedLCY += AmtAlreadyMatchedLCY;
    END;

    PROCEDURE GetReceiptNo@1100285047(VAR RcptNo@1100285001 : Code[20];VAR LineNo@1100285000 : Integer) : Boolean;
    VAR
      PurchRcptLine@1100285002 : Record 121;
    BEGIN
      PurchRcptLine.SETCURRENTKEY("Order No.");
      PurchRcptLine.SETRANGE("Order No.", RcptNo);
      IF LineNo <> 0 THEN
        PurchRcptLine.SETRANGE("Order Line No.", LineNo);
      PurchRcptLine.SETFILTER(Quantity, '<>%1', 0);
      IF PurchRcptLine.FINDLAST THEN BEGIN
        RcptNo := PurchRcptLine."Document No.";
        LineNo := PurchRcptLine."Line No.";
        EXIT(TRUE);
      END;
    END;

    PROCEDURE MatchedInvoiceExists@1100285048(OrderNo@1100285000 : Code[20];DocType@1100285004 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order') : Boolean;
    VAR
      PurchLine@1100285003 : Record 39;
      EXPurchDocLine@1100285002 : Record 12013588;
      ExDocEntry@1100285006 : Record 12013620;
      TempLineNo@1100285001 : Integer;
      RcptFound@1100285005 : Boolean;
      OrgOrderNo@1100285007 : Code[20];
    BEGIN
      OrgOrderNo := OrderNo;
      RcptFound := GetReceiptNo(OrderNo,TempLineNo);

      IF RcptFound THEN BEGIN
        PurchLine.RESET;
        PurchLine.SETCURRENTKEY("Document Type","Receipt No.","Receipt Line No.");
        CASE DocType OF
          DocType::Order:
            BEGIN
              PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::Invoice);
              PurchLine.SETRANGE("Receipt No.", OrderNo);
            END;
          DocType::"Return Order":
            BEGIN
              PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::"Credit Memo");
              PurchLine.SETRANGE("Return Shipment No.", OrderNo);
            END;
        END;

        IF PurchLine.FINDLAST THEN
          EXIT(TRUE);

        EXPurchDocLine.SETCURRENTKEY("Receipt No.","Receipt Line No.");
        EXPurchDocLine.SETRANGE("Receipt No.", OrderNo);
        IF EXPurchDocLine.FINDLAST THEN
          EXIT(TRUE);
      END
      ELSE BEGIN // Receipt not found i.e connected to a PO
        PurchLine.RESET;
        PurchLine.SETCURRENTKEY("ExFlow Order No.");
        CASE DocType OF
          DocType::Order:
            PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::Invoice);
          DocType::"Return Order":
            PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::"Credit Memo");
        END;

        PurchLine.SETRANGE("ExFlow Order No.", OrderNo);
        IF PurchLine.FINDLAST THEN
          EXIT(TRUE);

        EXPurchDocLine.SETCURRENTKEY("Order No.");
        EXPurchDocLine.SETRANGE("Order No.", OrderNo);
        IF EXPurchDocLine.FINDLAST THEN
          EXIT(TRUE);
      END;

      ExDocEntry.RESET;
      ExDocEntry.SETCURRENTKEY("Order No.");
      ExDocEntry.SETRANGE("Order No.", OrgOrderNo);
      IF ExDocEntry.FINDLAST THEN
        EXIT(TRUE)
      ELSE
        EXIT(FALSE)
    END;

    PROCEDURE OrderIsReceived@1100285038(OrderNo@1100285000 : Code[20];DocType@1100285004 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order') : Boolean;
    VAR
      PurchLine@1100285003 : Record 39;
    BEGIN
      PurchLine.RESET;
      PurchLine.SETRANGE("Document Type", DocType);
      PurchLine.SETRANGE("Document No.", OrderNo);
      PurchLine.SETFILTER(Quantity,'<>%1', 0);
      PurchLine.SETFILTER("Quantity Received",'<>%1', 0);
      EXIT(PurchLine.FINDFIRST);
    END;

    PROCEDURE IsAccountPredefinedAcc@1100285050(TempNo@1100285000 : Code[20]) : Boolean;
    VAR
      ExFlowSetup@1100285001 : Record 12013601;
      ExStdPurchCodeLine@1100285002 : Record 12013683;
    BEGIN
      ExFlowSetup.GET(COMPANYNAME,0);
      IF ExFlowSetup."Predefined Account" = TempNo THEN
        EXIT(TRUE);

      IF ExFlowSetup."Predefined Purch. Code" <> '' THEN BEGIN
        ExStdPurchCodeLine.SETRANGE("EX Standard Purchase Code", ExFlowSetup."Predefined Purch. Code");
        ExStdPurchCodeLine.SETRANGE(Type, ExStdPurchCodeLine.Type::"G/L Account");
        ExStdPurchCodeLine.SETRANGE("No.", TempNo);
        IF ExStdPurchCodeLine.FINDFIRST THEN
          EXIT(TRUE);
      END;

      EXIT(FALSE);
    END;

    PROCEDURE CreateJournalLine@1100285054(PurchaseLine@1100285000 : Record 39;TempAmountLCY@1100285010 : Decimal;TempNo@1100285005 : Code[20];OverrideGLAcc@1100285003 : ' ,Always,When Line has Predefined Account';GLAccToUse@1100285004 : Code[20];PostingDate@1100285006 : Date;PostRemPeriodBal@1100285011 : Boolean;PostRemPeriodBalToGLAcc@1100285009 : Code[20];CopyDimensions@1100285012 : 'Never,Always,For the non-balancing records only,Fixed,Fixed for the non-balancing records only,Fixed when blank,Fixed when blank for the non-balancing records only';BalanceAccount@1100285013 : Code[20];ReversalDate@1100285014 : Date;JnlTemplateName@1100285016 : Code[10];JnlBatchName@1100285015 : Code[10];VAR TempLineNo@1100285018 : Integer;TempDocNo@1100285017 : Code[20];DescriptionToUse@1100285019 : 'PurchaseLine,OrderNoRef';FixedDimCode@1100285023 : ARRAY [8] OF Code[20];FixedDimValue@1100285022 : ARRAY [8] OF Code[20];RetrieveLinesFrom@1100285008 : 'Purchase Line,Ex Document Line');
    VAR
      ExFlowSEMgt@1100285020 : Codeunit 12013598;
      RemPeriodicBalance@1100285001 : Decimal;
      OriginalAmtLCY@1100285002 : Decimal;
      NoOfPeriods@1100285007 : Integer;
    BEGIN
      GetGLSetup;

      IF OverrideGLAcc = OverrideGLAcc::Always THEN
        TempNo := GLAccToUse
      ELSE
        IF OverrideGLAcc = OverrideGLAcc::"When Line has Predefined Account" THEN
          IF IsAccountPredefinedAcc(TempNo) THEN
            TempNo := GLAccToUse;

      IF TempNo = '' THEN
        ERROR(STRSUBSTNO(EXF60,PurchaseLine."Document Type",PurchaseLine."Document No.",PurchaseLine."Line No."));

      RemPeriodicBalance := 0;

      IF PurchaseLine."Periodic Template Code" <> '' THEN BEGIN
        NoOfPeriods := ExFlowSEMgt.GetNoPeriods(PurchaseLine."Periodic Template Code");
        OriginalAmtLCY := TempAmountLCY;
        IF (PurchaseLine."Periodic Starting Date" <= PostingDate) AND (NoOfPeriods <> 0) THEN
          TempAmountLCY := ROUND(TempAmountLCY / NoOfPeriods, GLSetup."Amount Rounding Precision")
        ELSE
          TempAmountLCY := 0;

        IF PostRemPeriodBal THEN
          RemPeriodicBalance := OriginalAmtLCY - TempAmountLCY;
      END;

      IF (TempAmountLCY = 0) AND (RemPeriodicBalance = 0) THEN
        EXIT;

      IF TempAmountLCY <> 0 THEN
        CreateGLLines(PurchaseLine,TempAmountLCY,TempNo,PostingDate,CopyDimensions,BalanceAccount,ReversalDate,
                      JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                      FixedDimCode,FixedDimValue,RetrieveLinesFrom);

      IF RemPeriodicBalance <> 0 THEN
        CreateGLLines(PurchaseLine,RemPeriodicBalance,PostRemPeriodBalToGLAcc,PostingDate,CopyDimensions,BalanceAccount,ReversalDate,
                      JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                      FixedDimCode,FixedDimValue,RetrieveLinesFrom);
    END;

    PROCEDURE CreateGLLines@1100285028(PurchaseLine@1100285007 : Record 39;TempAmountLCY@1100285006 : Decimal;TempNo@1100285005 : Code[20];PostingDate@1100285000 : Date;CopyDimensions@1100285001 : 'Never,Always,For the non-balancing records only,Fixed,Fixed for the non-balancing records only,Fixed when blank,Fixed when blank for the non-balancing records only';BalanceAccount@1100285002 : Code[20];ReversalDate@1100285003 : Date;JnlTemplateName@1100285008 : Code[10];JnlBatchName@1100285004 : Code[10];VAR TempLineNo@1100285010 : Integer;TempDocNo@1100285009 : Code[20];DescriptionToUse@1100285011 : 'PurchaseLine,OrderNoRef';FixedDimCode@1100285017 : ARRAY [8] OF Code[20];FixedDimValue@1100285016 : ARRAY [8] OF Code[20];RetrieveLinesFrom@1100285012 : 'Purchase Line,Ex Document Line');
    VAR
      ExDocLineDim@1100285014 : Record 12013611;
      i@1100285015 : Integer;
    BEGIN
      IF (CopyDimensions = CopyDimensions::"Fixed when blank") OR
         (CopyDimensions = CopyDimensions::"Fixed when blank for the non-balancing records only") THEN BEGIN

        IF RetrieveLinesFrom = RetrieveLinesFrom::"Purchase Line" THEN BEGIN
          FOR i:=1 TO 8 DO BEGIN
            IF FixedDimCode[i] <> '' THEN BEGIN
              ExFlowDimMgt.ClearFixedDimCode(PurchaseLine,FixedDimCode,FixedDimValue,i);
            END;
          END;
        END
        ELSE BEGIN // ex doc line
          FOR i:=1 TO 8 DO BEGIN
            IF FixedDimCode[i] <> '' THEN BEGIN
              ExDocLineDim.RESET;
              ExDocLineDim.SETCURRENTKEY("Document No.");
              ExDocLineDim.SETRANGE("Company Name", COMPANYNAME);
              ExDocLineDim.SETRANGE("Document Type", PurchaseLine."Document Type");
              ExDocLineDim.SETRANGE("Document No.", PurchaseLine."Document No.");
              ExDocLineDim.SETRANGE("Line No.", PurchaseLine."Line No.");
              ExDocLineDim.SETRANGE("Dimension Code",FixedDimCode[i]);
              IF ExDocLineDim.FINDFIRST THEN BEGIN
                CLEAR(FixedDimCode);
                CLEAR(FixedDimValue);
                i := 8;
              END;
            END;
          END;
        END;
      END;

      // Net entry
      AddJnlLine(PurchaseLine,TempAmountLCY,TempNo,PostingDate,
                 CopyDimensions>0,
                 JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                 FixedDimCode,FixedDimValue,RetrieveLinesFrom,FALSE);

      // Balancing Entry
      AddJnlLine(PurchaseLine,-TempAmountLCY,BalanceAccount,PostingDate,
                 (CopyDimensions=CopyDimensions::Always) OR (CopyDimensions=CopyDimensions::Fixed) OR
                 (CopyDimensions=CopyDimensions::"Fixed when blank"),
                 JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                 FixedDimCode,FixedDimValue,RetrieveLinesFrom,TRUE);

      // Reversal entry
      AddJnlLine(PurchaseLine,-TempAmountLCY,TempNo,ReversalDate,
                 CopyDimensions>0,
                 JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                 FixedDimCode,FixedDimValue,RetrieveLinesFrom,FALSE);

      // Balancing entry
      AddJnlLine(PurchaseLine,TempAmountLCY,BalanceAccount,ReversalDate,
                 (CopyDimensions=CopyDimensions::Always) OR (CopyDimensions=CopyDimensions::Fixed) OR
                 (CopyDimensions=CopyDimensions::"Fixed when blank"),
                 JnlTemplateName,JnlBatchName,TempLineNo,TempDocNo,DescriptionToUse,
                 FixedDimCode,FixedDimValue,RetrieveLinesFrom,TRUE);
    END;

    PROCEDURE AddJnlLine@1100285025(_PurchaseLine@1100285002 : Record 39;_TempAmountLCY@1100285001 : Decimal;_TempNo@1100285000 : Code[20];_PostDate@1100285004 : Date;_AddDimensions@1100285003 : Boolean;_JnlTemplateName@1100285011 : Code[10];_JnlBatchName@1100285010 : Code[10];VAR _TempLineNo@1100285013 : Integer;_TempDocNo@1100285014 : Code[20];_DescriptionToUse@1100285015 : 'PurchaseLine,OrderNoRef';_FixedDimCode@1100285019 : ARRAY [8] OF Code[20];_FixedDimValue@1100285018 : ARRAY [8] OF Code[20];RetrieveLinesFrom@1100285017 : 'Purchase Line,Ex Document Line';IsBalancingRec@1100285020 : Boolean);
    VAR
      GenJnlLine@1100285012 : Record 81;
      GenJnlTemplate@1100285006 : Record 80;
      GenJnlBatch@1100285005 : Record 232;
      TempDescription@1100285007 : Text[1024];
      UseFixed@1100285009 : Boolean;
      i@1100285016 : Integer;
      Index@1100285008 : Integer;
    BEGIN
      GenJnlLine.INIT;
      GenJnlLine."Journal Template Name" := _JnlTemplateName;
      GenJnlLine."Journal Batch Name" := _JnlBatchName;
      GenJnlLine."Line No." := _TempLineNo;
      GenJnlLine."Document No." := _TempDocNo;
      GenJnlLine.INSERT(TRUE);
      _TempLineNo += 10000;

      GenJnlTemplate.GET(_JnlTemplateName);
      GenJnlBatch.GET(GenJnlLine."Journal Template Name",GenJnlLine."Journal Batch Name");
      GenJnlLine."Source Code" := GenJnlTemplate."Source Code";
      GenJnlLine."Reason Code" := GenJnlBatch."Reason Code";
      GenJnlLine."Posting No. Series" := GenJnlBatch."Posting No. Series";

      GenJnlLine.VALIDATE("Account Type", GenJnlLine."Account Type"::"G/L Account");
      //>> 4PS
      IF IsBalancingRec THEN BEGIN
        //GenJnlLine.VALIDATE(GenJnlLine."Job No.",_PurchaseLine."Job No.");
        //GenJnlLine.VALIDATE("Shortcut Dimension 2 Code",_PurchaseLine."Shortcut Dimension 2 Code");
        GenJnlLine.VALIDATE("Account No.", _TempNo);
      END ELSE BEGIN
        GenJnlLine.VALIDATE(GenJnlLine."Job No.",_PurchaseLine."Job No.");
        GenJnlLine.VALIDATE("Shortcut Dimension 2 Code",_PurchaseLine."Shortcut Dimension 2 Code");
        IF ((_PurchaseLine."Shortcut Dimension 2 Code" <> '') AND (_PurchaseLine."Job No." <> '')) THEN
          GenJnlLine.VALIDATE("Account No.", _TempNo);
      END;
      //<< 4PS


      GenJnlLine.VALIDATE("Gen. Posting Type", 0);
      GenJnlLine.VALIDATE("Gen. Posting Type", 0);
      GenJnlLine.VALIDATE("Gen. Bus. Posting Group", '');
      GenJnlLine.VALIDATE("Gen. Prod. Posting Group", '');
      GenJnlLine.VALIDATE("VAT Bus. Posting Group", '');
      GenJnlLine.VALIDATE("VAT Prod. Posting Group", '');
      GenJnlLine.VALIDATE("Posting Date", _PostDate);
      GenJnlLine.VALIDATE("Currency Code", '');

      GenJnlLine.VALIDATE("Bal. Account Type", 0);
      GenJnlLine.VALIDATE("Bal. Account No.", '');
      GenJnlLine.VALIDATE("Bal. Gen. Posting Type", 0);
      GenJnlLine.VALIDATE("Bal. Gen. Bus. Posting Group", '');
      GenJnlLine.VALIDATE("Bal. Gen. Prod. Posting Group", '');
      GenJnlLine.VALIDATE("Bal. VAT Calculation Type", 0);
      GenJnlLine.VALIDATE("Bal. VAT Bus. Posting Group", '');
      GenJnlLine.VALIDATE("Bal. VAT Prod. Posting Group", '');
      GenJnlLine.VALIDATE(Amount, _TempAmountLCY);
      //>> 4PS
      GenJnlLine.VALIDATE(Element,_PurchaseLine.Element);
      IF _PurchaseLine."Extension Contract" <> '' THEN
      GenJnlLine.VALIDATE("Extension Contract",_PurchaseLine."Extension Contract");
      GenJnlLine.VALIDATE("Plot No.",_PurchaseLine."Plot No.");
      GenJnlLine.VALIDATE("Cost Component",_PurchaseLine."Cost Component");
      //<< 4PS

      CASE _DescriptionToUse OF
        _DescriptionToUse::PurchaseLine:
          GenJnlLine.VALIDATE(Description, _PurchaseLine.Description);
        _DescriptionToUse::OrderNoRef:
          BEGIN
            TempDescription := STRSUBSTNO(EXF61,_PurchaseLine."Document Type", _PurchaseLine."Document No.");
            GenJnlLine.VALIDATE(Description, COPYSTR(TempDescription,1,MAXSTRLEN(GenJnlLine.Description)));
          END;
      END;

      IF _AddDimensions THEN BEGIN
        UseFixed := FALSE;
        FOR i:=1 TO 8 DO
          IF _FixedDimCode[i] <> '' THEN
            UseFixed := TRUE;

        IF UseFixed THEN BEGIN
          FOR i:=1 TO 8 DO BEGIN
            IF _FixedDimCode[i] <> '' THEN BEGIN
              GetDimIndex(_FixedDimCode[i],Index);
              IF Index = 1 THEN
                GenJnlLine.VALIDATE("Shortcut Dimension 1 Code", _FixedDimValue[i]);
              IF Index = 2 THEN
                GenJnlLine.VALIDATE("Shortcut Dimension 2 Code", _FixedDimValue[i]);
            END;
          END;
        END
        ELSE BEGIN
          GenJnlLine.VALIDATE("Shortcut Dimension 1 Code", _PurchaseLine."Shortcut Dimension 1 Code");
          GenJnlLine.VALIDATE("Shortcut Dimension 2 Code", _PurchaseLine."Shortcut Dimension 2 Code");
        END;
      END
      ELSE BEGIN
        GenJnlLine.VALIDATE("Shortcut Dimension 1 Code", '');
        GenJnlLine.VALIDATE("Shortcut Dimension 2 Code", '');
      END;

      GenJnlLine.MODIFY(TRUE);

      IF _AddDimensions THEN
        IF UseFixed THEN BEGIN
          FOR i:=1 TO 8 DO BEGIN
            IF _FixedDimCode[i] <> '' THEN
              ExFlowDimMgt.AddDocDimToJnlLineDim(GenJnlLine,_FixedDimCode[i],_FixedDimValue[i]);
          END;
        END
        ELSE
          ExFlowDimMgt.CopyDocDimToJnlLineDim(_PurchaseLine,GenJnlLine,RetrieveLinesFrom)
      ELSE
        ExFlowDimMgt.DeleteJnlDim(GenJnlLine);
    END;

    PROCEDURE ValidateApprovePurchHeader@1100285055(xPurchHeader@1100285000 : Record 38;VAR PurchHeader@1100285002 : Record 38);
    VAR
      PurchHeader2@1100285006 : Record 38;
      lPurchLine@1100285001 : Record 39;
      ReceiptLine@1100285007 : Record 121;
      RecModified@1100285010 : Boolean;
    BEGIN
      AppSetUp.GET(COMPANYNAME,0);

      IF PurchHeader2.GET(PurchHeader."Document Type",PurchHeader."No.") THEN BEGIN
        PurchHeader.MODIFY;
      END;

      IF PurchHeader."Document Type" IN [PurchHeader."Document Type"::Invoice,PurchHeader."Document Type"::"Credit Memo"] THEN
        IF (NOT xPurchHeader.Approve) AND PurchHeader.Approve AND
           (GetPurchHeaderImageName(COMPANYNAME,PurchHeader."Document Type",PurchHeader."No.") = '') THEN BEGIN
          GetImage(PurchHeader);

          IF (GetPurchHeaderImageName(COMPANYNAME,PurchHeader."Document Type",PurchHeader."No.") = '') THEN
            ERROR(EXF64);
        END;

      IF xPurchHeader.Approve AND (NOT PurchHeader.Approve) THEN
        BEGIN
          IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
            ERROR(EXF63);

          IF NOT CONFIRM(EXF77) THEN
            ERROR(EXF73);

          IF AnyApproved(PurchHeader) THEN BEGIN
            IF CONFIRM(EXF62,FALSE) THEN
              DeleteDocument(PurchHeader)
            ELSE
              ERROR(EXF73);
          END
          ELSE
            DeleteDocument(PurchHeader);
        END
      ELSE
        BEGIN
          IF IsUserSuperior(COMPANYNAME, USERID) THEN BEGIN
            lPurchLine.RESET;
            IF lPurchLine.SETCURRENTKEY("Document No.") THEN;
            lPurchLine.SETRANGE("Document Type", PurchHeader."Document Type");
            lPurchLine.SETRANGE("Document No.", PurchHeader."No.");
            lPurchLine.SETFILTER(Type, '>%1', 0);
            IF NOT AppSetUp."Approve VAT lines" THEN
              lPurchLine.SETFILTER("VAT Calculation Type",'<>%1',lPurchLine."VAT Calculation Type"::"Full VAT");
            IF lPurchLine.FINDSET THEN
              REPEAT
                RecModified := FALSE;

                IF NOT lPurchLine.Approve THEN BEGIN
                  lPurchLine.VALIDATE(Approve,TRUE);
                  RecModified := TRUE;
                END;

                IF lPurchLine."Receipt No." <> '' THEN
                  IF ReceiptLine.GET(lPurchLine."Receipt No.",lPurchLine."Receipt Line No.") THEN BEGIN
                    IF (lPurchLine."ExFlow Order No." <> ReceiptLine."Order No.") OR
                       (lPurchLine."ExFlow Order Line No." <> ReceiptLine."Order Line No.") THEN BEGIN
                      lPurchLine."ExFlow Order No." := ReceiptLine."Order No.";
                      lPurchLine."ExFlow Order Line No." := ReceiptLine."Order Line No.";
                      RecModified := TRUE;
                    END;
                  END;

                IF RecModified THEN
                  lPurchLine.MODIFY(TRUE);
              UNTIL lPurchLine.NEXT = 0;
          END;
        END;
    END;

    PROCEDURE GetImage@1100285056(PurchHeader@1100285000 : Record 38);
    VAR
      ExDoc2@1100285001 : Record 12013612;
      ExFlowSetup@1100285004 : Record 12013601;
      ExFlowFileMgt@1100285002 : Codeunit 12013602;
      FileName@1100285003 : Text[1024];
      Folder@1100285008 : Text[170];
      SubFolder@1100285007 : Text[30];
      ImageName@1100285006 : Text[240];
    BEGIN
      ExFlowFileMgt.FileNameFromDialog(FileName,'',0,'',0);
      IF FileName <> '' THEN BEGIN
        ExFlowSetup.GET(COMPANYNAME,0);

        Folder := ExFlowSetup."Path to Used Invoices";
        SubFolder := DayMap(WORKDATE);
        IF NOT ExFlowFileMgt.FolderExist(Folder + SubFolder) THEN
          ExFlowFileMgt.NewFolder(Folder + SubFolder,Folder);

        ImageName := DELCHR(PurchHeader."Pay-to Vendor No." + '-' + PurchHeader."No." + '-' + ExFlowFileMgt.GetFileName(FileName),
                            '=','@$%&<>/?');

        ExFlowFileMgt.Copy(ExFlowFileMgt.GetFileName(FileName),ImageName,ExFlowFileMgt.Path(FileName),Folder+SubFolder,
                                                                         Folder+SubFolder);

        ExDoc2.INIT;
        ExDoc2."Entry No." := 0;
        ExDoc2."Company Name" := COMPANYNAME;
        ExDoc2."Document Type" := PurchHeader."Document Type";
        ExDoc2."Document No." := PurchHeader."No.";
        ExDoc2."Image Name" := SubFolder + ImageName;
        ExDoc2.INSERT;
      END;
    END;

    PROCEDURE SetApproveForPurchLine@1100285057(PurchHeader@1100285000 : Record 38;VAR PurchLine@1100285001 : Record 39);
    BEGIN
      WITH PurchLine DO BEGIN
        IF Type <> 0 THEN
          Approve := PurchHeader.Approve;

        IF Approve THEN
          IF "VAT Calculation Type" = "VAT Calculation Type"::"Full VAT" THEN BEGIN
            AppSetUp.GET(COMPANYNAME,0);
            Approve := AppSetUp."Approve VAT lines";
          END;

        IF Approve THEN
          IF NOT LineTypeAllowed(Type, FALSE) THEN
            Approve := FALSE;
      END;
    END;

    PROCEDURE SetApproveForExFPurchLine@1100285059(ExFPurchHeader@1100285000 : Record 12013587;VAR ExFPurchLine@1100285001 : Record 12013588);
    BEGIN
      WITH ExFPurchLine DO BEGIN
        IF Type <> 0 THEN
          Approval := ExFPurchHeader.Approval;

        IF Approval THEN BEGIN
          AppSetUp.GET(COMPANYNAME,0);
          IF NOT AppSetUp."Approve VAT lines" THEN
            IF IsLineVATLine(ExFPurchLine) THEN
              Approval := FALSE;
        END;

        IF Approval THEN
          IF NOT LineTypeAllowed(Type, FALSE) THEN
            Approval := FALSE;
      END;
    END;

    PROCEDURE SetReceiptNoMand@1100285058(PurchHeader@1100285001 : Record 38;VAR PurchLine@1100285000 : Record 39);
    BEGIN
      WITH PurchLine DO BEGIN
        IF AppSetUp.GET(COMPANYNAME, 0) THEN BEGIN
          IF AppSetUp."Receipt No. Mand. Item" AND (Type = Type::Item) THEN
            "Receipt No. Mandatory" := PurchHeader."Receipt No. Mandatory";
          IF AppSetUp."Receipt No. Mand. G/L" AND (Type = Type::"G/L Account") THEN
            "Receipt No. Mandatory" := PurchHeader."Receipt No. Mandatory";
          IF AppSetUp."Receipt No. Mand. Fixed Asset" AND (Type = Type::"Fixed Asset") THEN
            "Receipt No. Mandatory" := PurchHeader."Receipt No. Mandatory";
          IF AppSetUp."Receipt No. Mand. Charge Item" AND (Type = Type::"Charge (Item)") THEN
            "Receipt No. Mandatory" := PurchHeader."Receipt No. Mandatory";
        END;

        IF "Receipt No." <> '' THEN
          "Receipt No. Mandatory" := TRUE;
      END;
    END;

    PROCEDURE ValidateApprovalPurchLine@1100285008(VAR xPurchLine@1100285000 : Record 39;VAR PurchLine@1100285001 : Record 39);
    VAR
      PurchHeader@1100285002 : Record 38;
    BEGIN
      IF PurchLine.Type = 0 THEN
        ERROR(EXF65);

      IF NOT LineTypeAllowed(PurchLine.Type, FALSE) THEN
        ERROR(STRSUBSTNO(EXF70,PurchLine.Type));

      PurchHeader.GET(PurchLine."Document Type",PurchLine."Document No.");
      IF NOT PurchHeader.Approve THEN
        ERROR(EXF65);

      IF xPurchLine.Approve AND (NOT PurchLine.Approve) AND (NOT PurchHeader."New Line") THEN
        BEGIN
          IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
            ERROR(STRSUBSTNO(EXF66,USERID));

          IF NOT CONFIRM(EXF77) THEN
            ERROR(EXF73);

          IF AnyApprovedLine(PurchLine) THEN
            IF NOT CONFIRM(EXF67,FALSE) THEN
              ERROR(EXF73)
        END;
    END;

    PROCEDURE ValidateApprovalExFPurchLine@1100285060(VAR xExFPurchLine@1100285000 : Record 12013588;VAR ExFPurchLine@1100285001 : Record 12013588);
    VAR
      ExFPurchHeader@1100285002 : Record 12013587;
    BEGIN
      IF ExFPurchLine.Type = 0 THEN
        ERROR(EXF65);

      IF NOT LineTypeAllowed(ExFPurchLine.Type, FALSE) THEN
        ERROR(STRSUBSTNO(EXF70,ExFPurchLine.Type));

      ExFPurchHeader.GET(ExFPurchLine."Inbound Document No.");
      IF NOT ExFPurchHeader.Approval THEN
        ERROR(EXF65);

      IF xExFPurchLine.Approval AND (NOT ExFPurchLine.Approval) THEN
        BEGIN
          IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
            ERROR(STRSUBSTNO(EXF66,USERID));

          IF NOT CONFIRM(EXF77) THEN
            ERROR(EXF73);
        END;
    END;

    PROCEDURE FindUserGroup@1100285017(_InCode@1100285000 : Code[100];VAR _UserGroupName@1100285002 : Text[100];SuspendErrors@1100285003 : Boolean) : Code[100];
    VAR
      ExUserGroup@1100285001 : Record 12013606;
    BEGIN
      IF _InCode = '' THEN
        EXIT('');

      IF NOT ExUserGroup.GET(COMPANYNAME,_InCode) THEN
        BEGIN
          ExUserGroup.RESET;
          ExUserGroup.SETRANGE("Company Name",COMPANYNAME);
          ExUserGroup.SETFILTER(Code, _InCode + '*');
          ExUserGroup.SETRANGE(Blocked,FALSE);
          IF NOT ExUserGroup.FINDFIRST THEN BEGIN
            ExUserGroup.SETRANGE(Code);
            ExUserGroup.SETFILTER("Search Name", _InCode + '*');
            IF NOT ExUserGroup.FINDFIRST THEN BEGIN
              IF NOT SuspendErrors THEN
                ERROR(EXF68,_InCode)
              ELSE
                EXIT('');
            END;
          END;
        END;

      IF NOT SuspendErrors THEN
        IF ExUserGroup.Blocked THEN
          ERROR(EXF69,ExUserGroup.Code);

      _UserGroupName := ExUserGroup.Name;

      EXIT(ExUserGroup.Code);
    END;

    PROCEDURE LookUpUserGroup@1100285024(_InCode@1100285000 : Code[100];VAR _UserGroupName@1100285003 : Text[100]) : Code[100];
    VAR
      ExUserGroupListForm@1100285001 : Page 12013618;
      ExUserGroup@1100285002 : Record 12013606;
    BEGIN
      CLEAR(ExUserGroupListForm);
      ExUserGroupListForm.EDITABLE(FALSE);
      ExUserGroupListForm.LOOKUPMODE(TRUE);

      ExUserGroup.RESET;
      ExUserGroup.FILTERGROUP := 2;
      ExUserGroup.SETRANGE("Company Name",COMPANYNAME);
      ExUserGroup.FILTERGROUP := 0;
      IF _InCode <> '' THEN
        ExUserGroup.SETRANGE(Code, _InCode);

      IF ExUserGroup.FINDFIRST THEN
        ExUserGroupListForm.SETRECORD(ExUserGroup);

      ExUserGroup.SETRANGE(Code);

      ExUserGroupListForm.SETTABLEVIEW(ExUserGroup);
      IF ExUserGroupListForm.RUNMODAL = ACTION::LookupOK THEN BEGIN
        ExUserGroupListForm.GETRECORD(ExUserGroup);
        _UserGroupName := ExUserGroup.Name;
        EXIT(ExUserGroup.Code);
      END
      ELSE
        EXIT(_InCode);
    END;

    PROCEDURE GetGLSetup@1100285061();
    BEGIN
      IF NOT GLSetupRetrieved THEN BEGIN
        GLSetupRetrieved := TRUE;
        GLSetup.GET;
      END;
    END;

    PROCEDURE IsUserSuperior@1100285062(_CompName@1100285000 : Text[100];_UserID@1100285001 : Code[100]) : Boolean;
    VAR
      ExUserComp@1100285002 : Record 12013641;
    BEGIN
      IF GetUserComp(ExUserComp,_CompName,_UserID) THEN
        EXIT(ExUserComp.Superior)
      ELSE
        EXIT(FALSE);
    END;

    PROCEDURE GetUserComp@1100285041(VAR _ExUserComp@1100285002 : Record 12013641;_CompName@1100285001 : Text[100];_UserID@1100285000 : Code[100]) : Boolean;
    VAR
      TmpUserID@1100285004 : Code[100];
      TmpPos@1100285003 : Integer;
    BEGIN
      IF _ExUserComp.GET(_CompName,_UserID) THEN
        EXIT(TRUE);

      TmpPos := STRPOS(_UserID,'\');
      IF TmpPos <> 0 THEN BEGIN
        TmpUserID := COPYSTR(_UserID,TmpPos + 1);
        IF _ExUserComp.GET(_CompName,TmpUserID) THEN
          EXIT(TRUE);
      END;

      EXIT(FALSE);
    END;

    PROCEDURE GetUserGroup@1100285032(_CompName@1100285000 : Text[100];VAR _UserID@1100285001 : Code[100]) : Code[100];
    VAR
      ExUserGroup@1100285002 : Record 12013606;
      TmpUserID@1100285003 : Code[100];
      TmpPos@1100285004 : Integer;
    BEGIN
      IF ExUserGroup.GET(_CompName,_UserID) THEN
        EXIT(_UserID);

      TmpPos := STRPOS(_UserID,'\');
      IF TmpPos <> 0 THEN BEGIN
        TmpUserID := COPYSTR(_UserID,TmpPos + 1);
        IF ExUserGroup.GET(_CompName,TmpUserID) THEN
          EXIT(ExUserGroup.Code);
      END;

      EXIT('');
    END;

    PROCEDURE TestifApproved@1100285063(_PurchLine@1100285002 : Record 39;_xPurchLine@1100285001 : Record 39;_DocLine@1100285004 : Record 12013609;_AppSetup@1100285005 : Record 12013601;_SilentMode@1100285000 : Boolean);
    VAR
      AmountChanged@1100285003 : Boolean;
    BEGIN
      // Test if Approved
      IF NOT _SilentMode THEN BEGIN
        //348861
        AmountChanged := _PurchLine."Line Amount" <> _xPurchLine."Line Amount";
        IF AmountChanged AND _AppSetup."Block Amt change Approved Line" THEN
          IF AlreadyApproved(_PurchLine) THEN
            ERROR(EXF56);
        //348861

        IF AlreadyApprovedByActualUser(_PurchLine) THEN
          IF IsLineModified(_PurchLine,_xPurchLine) THEN BEGIN
            IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
              ERROR(STRSUBSTNO(EXF66,USERID));

            IF _DocLine.Flowstatus <> _DocLine.Flowstatus::Rejected THEN
              IF NOT _AppSetup."Suppress Approved Message" THEN
                IF NOT CONFIRM(EXF41) THEN
                  ERROR(EXF73);
          END;
      END;
    END;

    PROCEDURE IsLineModified@1100285064(PurchLine@1100285001 : Record 39;xPurchLine@1100285000 : Record 39) : Boolean;
    VAR
      RecRef@1100285002 : RecordRef;
      FldRef@1100285003 : FieldRef;
      xRecRef@1100285005 : RecordRef;
      xFldRef@1100285004 : FieldRef;
      TempValue@1100285006 : Decimal;
      xTempValue@1100285007 : Decimal;
    BEGIN
      RecRef.GETTABLE(PurchLine);
      xRecRef.GETTABLE(xPurchLine);

      // Type
      FldRef := RecRef.FIELD(5);
      xFldRef := xRecRef.FIELD(5);
      IF FldRef.VALUE <> xFldRef.VALUE THEN
        EXIT(TRUE);

      // No.
      FldRef := RecRef.FIELD(6);
      xFldRef := xRecRef.FIELD(6);
      IF FldRef.VALUE <> xFldRef.VALUE THEN
        EXIT(TRUE);

      // Description
      FldRef := RecRef.FIELD(11);
      xFldRef := xRecRef.FIELD(11);
      IF FldRef.VALUE <> xFldRef.VALUE THEN
        EXIT(TRUE);

      // Description 2
      FldRef := RecRef.FIELD(12);
      xFldRef := xRecRef.FIELD(12);
      IF FldRef.VALUE <> xFldRef.VALUE THEN
        EXIT(TRUE);

      // Quantity
      FldRef := RecRef.FIELD(15);
      xFldRef := xRecRef.FIELD(15);
      //348839
      IF PurchLine."Document Type" IN [PurchLine."Document Type"::Quote,
                                       PurchLine."Document Type"::Order] THEN BEGIN
        TempValue := 0;
        xTempValue := 0;
        IF EVALUATE(TempValue,FORMAT(FldRef.VALUE)) THEN;
        IF EVALUATE(xTempValue,FORMAT(xFldRef.VALUE)) THEN;

        IF TempValue > xTempValue THEN
          EXIT(TRUE);
      END
      ELSE
      //348839
        IF FldRef.VALUE <> xFldRef.VALUE THEN
          EXIT(TRUE);

      // Line Amount
      FldRef := RecRef.FIELD(103);
      xFldRef := xRecRef.FIELD(103);
      //348839
      IF PurchLine."Document Type" IN [PurchLine."Document Type"::Quote,
                                       PurchLine."Document Type"::Order] THEN BEGIN
        TempValue := 0;
        xTempValue := 0;
        IF EVALUATE(TempValue,FORMAT(FldRef.VALUE)) THEN;
        IF EVALUATE(xTempValue,FORMAT(xFldRef.VALUE)) THEN;

        IF TempValue > xTempValue THEN
          EXIT(TRUE);
      END
      ELSE
      //348839
        IF FldRef.VALUE <> xFldRef.VALUE THEN
          EXIT(TRUE);
    END;

    PROCEDURE TestifApprovedDim@1100285066(_PurchLine@1100285002 : Record 39;_DocLine@1100285004 : Record 12013609;_AppSetup@1100285001 : Record 12013601;_SilentMode@1100285000 : Boolean);
    BEGIN
      // Test if Approved from Document dimension table
      IF NOT _SilentMode THEN
        IF AlreadyApprovedByActualUser(_PurchLine) THEN BEGIN
          IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
            ERROR(STRSUBSTNO(EXF66,USERID));

          IF _DocLine.Flowstatus <> _DocLine.Flowstatus::Rejected THEN
            IF NOT _AppSetup."Suppress Approved Message" THEN
              IF NOT CONFIRM(EXF41) THEN
                ERROR(EXF73);
        END;
    END;

    PROCEDURE TestifApprovedPurchLineDim@1100285065(_PurchLine@1100285002 : Record 39);
    VAR
      _DocLine@1100285001 : Record 12013609;
      _AppSetup@1100285000 : Record 12013601;
    BEGIN
      // Test if Approved from Purchase Line Dim Update
      IF AlreadyApprovedByActualUser(_PurchLine) THEN BEGIN
        IF NOT IsUserSuperior(COMPANYNAME, USERID) THEN
          ERROR(STRSUBSTNO(EXF66,USERID));

        _DocLine.RetrieveRecord(_DocLine,COMPANYNAME,_PurchLine."Document Type",_PurchLine."Document No.",_PurchLine."Line No.");
        IF _DocLine.Flowstatus <> _DocLine.Flowstatus::Rejected THEN BEGIN
          _AppSetup.GET(COMPANYNAME,0);
          IF NOT _AppSetup."Suppress Approved Message" THEN
            IF NOT CONFIRM(EXF41) THEN
              ERROR(EXF73);
        END;
      END;
    END;

    PROCEDURE CallGetReceipt@1100285068(PurchLine@1100285001 : Record 39) : Boolean;
    VAR
      ExFlowSetup@1100285000 : Record 12013601;
    BEGIN
      IF NOT ExFlowSetup.GET(COMPANYNAME,0) THEN
        EXIT(FALSE);
      IF ExFlowSetup."Order Applies-to" = ExFlowSetup."Order Applies-to"::"Receipts Lines" THEN
        EXIT(FALSE);

      IF (ExFlowSetup."Order Applies-to" = ExFlowSetup."Order Applies-to"::"Purch Order Lines") OR
         (ExFlowSetup."Order Applies-to" = ExFlowSetup."Order Applies-to"::"First Order then Receipt") THEN
        CODEUNIT.RUN(CODEUNIT::"ExFlow-Get PO from Purchase",PurchLine);

      EXIT(TRUE);
    END;

    PROCEDURE OrderNoLookup@1100285069(VAR PurchLine@1100285002 : Record 39);
    VAR
      PurchHeader@1100285001 : Record 38;
      PurchaseList@1100285000 : Page 53;
    BEGIN
      WITH PurchLine DO BEGIN
        PurchHeader.RESET;
        IF PurchHeader.SETCURRENTKEY("Pay-to Vendor No.") THEN;
        CASE "Document Type" OF
          "Document Type"::Invoice:
            PurchHeader.SETRANGE("Document Type", PurchHeader."Document Type"::Order);
          "Document Type"::"Credit Memo":
            PurchHeader.SETRANGE("Document Type", PurchHeader."Document Type"::"Return Order");
        END;

        PurchHeader.SETRANGE("Currency Code", "Currency Code");
        PurchHeader.SETRANGE("Pay-to Vendor No.", "Pay-to Vendor No.");
        IF "ExFlow Order No." <> '' THEN BEGIN
          PurchHeader.SETRANGE("No.","ExFlow Order No.");
          IF PurchHeader.FINDFIRST THEN
            PurchaseList.SETRECORD(PurchHeader);
          PurchHeader.SETRANGE("No.");
        END;

        PurchaseList.SETTABLEVIEW(PurchHeader);
        PurchaseList.LOOKUPMODE := TRUE;
        IF PurchaseList.RUNMODAL = ACTION::LookupOK THEN BEGIN
          PurchaseList.GETRECORD(PurchHeader);

          IF "ExFlow Order No." <> PurchHeader."No." THEN BEGIN
            "ExFlow Order No." := PurchHeader."No.";
            "ExFlow Order Line No." := 0;
          END;
        END;
      END;
    END;

    PROCEDURE OrderNoValidate@1100285071(VAR PurchLine@1100285002 : Record 39;xPurchLine@1100285003 : Record 39);
    VAR
      PurchHeader@1100285001 : Record 38;
    BEGIN
      WITH PurchLine DO BEGIN
        IF "ExFlow Order No." = '' THEN
          "ExFlow Order Line No." := 0
        ELSE BEGIN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              PurchHeader.GET(PurchHeader."Document Type"::Order, "ExFlow Order No.");
            "Document Type"::"Credit Memo":
              PurchHeader.GET(PurchHeader."Document Type"::"Return Order", "ExFlow Order No.");
          END;

          IF "ExFlow Order No." <> xPurchLine."ExFlow Order No." THEN BEGIN
            "ExFlow Order No." := PurchHeader."No.";
            "ExFlow Order Line No." := 0;
          END;
        END;
      END;
    END;

    PROCEDURE OrderLineNoLookup@1100285072(VAR PurchLine@1100285002 : Record 39);
    VAR
      PurchLine2@1100285001 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        IF "ExFlow Order No." = '' THEN
          EXIT;

        PurchLine2.RESET;
        CASE "Document Type" OF
          "Document Type"::Invoice:
            PurchLine2.SETRANGE("Document Type", PurchLine2."Document Type"::Order);
          "Document Type"::"Credit Memo":
            PurchLine2.SETRANGE("Document Type", PurchLine2."Document Type"::"Return Order");
        END;

        PurchLine2.SETRANGE("Document No.", "ExFlow Order No.");
        IF "ExFlow Order Line No." <> 0 THEN BEGIN
          PurchLine2.SETRANGE("Line No.","ExFlow Order Line No.");
          IF PurchLine2.FINDFIRST THEN;
          PurchLine2.SETRANGE("Line No.");
        END;

        IF PAGE.RUNMODAL(0,PurchLine2) = ACTION::LookupOK THEN BEGIN
          IF "ExFlow Order Line No." <> PurchLine2."Line No." THEN
            "ExFlow Order Line No." := PurchLine2."Line No.";
        END;
      END;
    END;

    PROCEDURE OrderLineNoValidate@1100285070(VAR PurchLine@1100285002 : Record 39;xPurchLine@1100285003 : Record 39);
    VAR
      PurchLine2@1100285000 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        IF ("ExFlow Order No." = '') OR ("ExFlow Order Line No." = 0) THEN
          EXIT;

        CASE "Document Type" OF
          "Document Type"::Invoice:
            PurchLine2.GET(PurchLine2."Document Type"::Order, "ExFlow Order No.", "ExFlow Order Line No.");
          "Document Type"::"Credit Memo":
            PurchLine2.GET(PurchLine2."Document Type"::"Return Order","ExFlow Order No.", "ExFlow Order Line No.");
        END;

        IF "ExFlow Order Line No." <> xPurchLine."Line No." THEN
          "ExFlow Order Line No." := PurchLine2."Line No.";
      END;
    END;

    PROCEDURE DeletePurchaseLine@1100285039(VAR PurchLine@1100285000 : Record 39;StatusCheckSuspended@1100285001 : Boolean);
    VAR
      DocLine@1100285002 : Record 12013609;
      DocHead@1100285003 : Record 12013608;
    BEGIN
      WITH PurchLine DO BEGIN
        DocLine.LOCKTABLE;
        IF DocLine.RetrieveRecord(DocLine,COMPANYNAME,"Document Type","Document No.","Line No.") THEN
          BEGIN
            IF (DocLine.Flowstatus = DocLine.Flowstatus::Approved) THEN
              BEGIN
                IF NOT StatusCheckSuspended THEN BEGIN
                  IF CONFIRM(EXF75,TRUE) THEN
                    DocLine.DELETE(TRUE)
                  ELSE
                    ERROR(EXF76);
                END
                ELSE
                  DocLine.DELETE(TRUE);
              END
            ELSE
              DocLine.DELETE(TRUE);
          END;

        IF DocHead.RetrieveRecord(DocHead,COMPANYNAME, "Document Type","Document No.") THEN
          AmountToDocHead(PurchLine,TRUE);
      END;
    END;

    BEGIN
    {
      4PS x4 Dims
    }
    END.
  }
}

