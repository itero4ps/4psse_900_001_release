OBJECT Codeunit 6085702 Purch. Doc. - Identification
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=DCW13.70.00.4.04,4PS9.00;
  }
  PROPERTIES
  {
    TableNo=6085590;
    OnRun=VAR
            Template@1000000000 : Record 6085579;
            Field@1000000001 : Record 6085580;
            Vendor@1000000002 : Record 23;
            SourceExcl@161024012 : Record 6085598;
            DocCat@161024015 : Record 6085575;
            CaptureEngine@1000000004 : Codeunit 6085575;
            RecIDMgt@161024014 : Codeunit 6085604;
            VATRegNo@1000000003 : Code[20];
            Found@161024013 : Boolean;
            RecIDTreeID@161024016 : Integer;
            RecRef@1160040000 : RecordRef;
            CoCRegNo@1100528200 : Code[20];
          BEGIN
            // *********************************************************************************************************************************
            // SOURCE NO ALREADY IDENTIFIED. VALIDATING THE NO. WILL MAKE THE SYSTEM INSERT THE DEFAULT TEMPLATE
            // *********************************************************************************************************************************
            IF "Source Record ID Tree ID" <> 0 THEN BEGIN
              VALIDATE("Source Record ID Tree ID","Source Record ID Tree ID");
              MODIFY(TRUE);
              EXIT;
            END;

            // *********************************************************************************************************************************
            // FIND THE IDENTIFICATION TEMPLATE
            // *********************************************************************************************************************************
            Template.RESET;
            Template.SETCURRENTKEY("Category Code","Source Sub Type");
            Template.SETRANGE("Category Code","Document Category Code");
            Template.SETRANGE("Source Sub Type",Template."Source Sub Type"::Identification);
            IF NOT Template.FINDFIRST THEN
              EXIT;

            Field.SETRANGE("Template No.",Template."No.");
            IF NOT Field.FINDFIRST THEN
              EXIT;

            DocCat.GET("Document Category Code");

            // *********************************************************************************************************************************
            // CAPTURE THE VAT REG. NO FROM THE DOCUMENT VALUES
            // *********************************************************************************************************************************
            //**4PS.sn
            Field.SETRANGE(Code, 'VATREGNO');
            IF Field.FINDFIRST THEN
            //**4PS.en
              VATRegNo := COPYSTR(CaptureEngine.CaptureField(Rec,0,Field,FALSE),1,MAXSTRLEN(Vendor."VAT Registration No."));

            // *********************************************************************************************************************************
            // IF REGISTRATION NO. WAS FOUND THEN TRY TO FIND A VENDOR WITH THE NO.
            // *********************************************************************************************************************************
            VATRegNo := RecIDMgt.FormatFilterValue(VATRegNo,MAXSTRLEN(VATRegNo));
            IF VATRegNo <> '' THEN BEGIN
              Vendor.SETCURRENTKEY("VAT Registration No.");
              Vendor.SETRANGE("VAT Registration No.",VATRegNo);
              IF Vendor.FINDSET THEN
                REPEAT
                  RecIDTreeID := RecIDMgt.GetRecIDTreeID2(
                    DocCat."Source Table No.",Vendor.FIELDNO("No."),DocCat."Document Category GUID",Vendor."No.");
                  Found := NOT SourceExcl.GET("Document Category Code",RecIDTreeID);
                UNTIL Found OR (Vendor.NEXT = 0);

              IF NOT Found THEN BEGIN
                VATRegNo := RemoveLeadingLetters(VATRegNo);
                IF (STRLEN(VATRegNo) > 6) THEN BEGIN
                  Vendor.SETRANGE("VAT Registration No.",VATRegNo);

                  IF Vendor.FINDSET THEN
                    REPEAT
                      RecIDTreeID := RecIDMgt.GetRecIDTreeID2(
                        DocCat."Source Table No.",Vendor.FIELDNO("No."),DocCat."Document Category GUID",Vendor."No.");
                      Found := NOT SourceExcl.GET("Document Category Code",RecIDTreeID);
                    UNTIL Found OR (Vendor.NEXT = 0);

                END;
              END;

            //**4PS.sn
              IF (NOT Found) AND (STRLEN(VATRegNo) > 6) THEN BEGIN
                Vendor.SETFILTER("VAT Registration No.",'%1','*' + VATRegNo + '*');
                IF Vendor.FINDSET THEN
                  REPEAT
                    RecIDTreeID := RecIDMgt.GetRecIDTreeID2(
                          DocCat."Source Table No.",Vendor.FIELDNO("No."),DocCat."Document Category GUID",Vendor."No.");
                    Found := NOT SourceExcl.GET("Document Category Code",RecIDTreeID);
                  UNTIL Found OR (Vendor.NEXT = 0);
              END;
            //**4PS.en

            END;

            //**4PS.sn
            // *********************************************************************************************************************************
            // Check on CoC Registration No.
            // *********************************************************************************************************************************
            IF NOT Found THEN BEGIN
              Field.SETRANGE(Code, 'COCREGNO');
              IF Field.FINDFIRST THEN
                CoCRegNo := COPYSTR(CaptureEngine.CaptureField(Rec,0,Field,FALSE), 1, MAXSTRLEN(Vendor."COC Registration No."));

              CoCRegNo := RecIDMgt.FormatFilterValue(CoCRegNo,MAXSTRLEN(CoCRegNo));

              IF CoCRegNo <> '' THEN BEGIN
                //Vendor.SETCURRENTKEY("COC Registration No");
                Vendor.SETRANGE("COC Registration No.",CoCRegNo);
                IF Vendor.FINDSET THEN
                  REPEAT
                    RecIDTreeID := RecIDMgt.GetRecIDTreeID2(
                      DocCat."Source Table No.",Vendor.FIELDNO("No."),DocCat."Document Category GUID",Vendor."No.");
                    Found := NOT SourceExcl.GET("Document Category Code",RecIDTreeID);
                  UNTIL Found OR (Vendor.NEXT = 0);

            //**4PS.en
                IF NOT Found THEN BEGIN
                  Vendor.SETFILTER("COC Registration No.",'%1','*' + CoCRegNo + '*');
                  IF Vendor.FINDSET THEN
                    REPEAT
                      RecIDTreeID := RecIDMgt.GetRecIDTreeID2(
                        DocCat."Source Table No.",Vendor.FIELDNO("No."),DocCat."Document Category GUID",Vendor."No.");
                      Found := NOT SourceExcl.GET("Document Category Code",RecIDTreeID);
                    UNTIL Found OR (Vendor.NEXT = 0);
                END;
              END;
            END;

            IF NOT Found THEN
              EXIT;

            RecRef.GETTABLE(Vendor);

            VALIDATE("Source Record ID Tree ID",RecIDMgt.GetRecIDTreeID(RecRef,TRUE));
            MODIFY(TRUE);
          END;

  }
  CODE
  {

    PROCEDURE CaptureVATNo@161024012(VAR CaptureFieldVal@161024012 : Record 6085597);
    VAR
      CompInfo@161024013 : Record 79;
    BEGIN
      // *********************************************************************************************************************************
      // THIS FUNCTION IS CALLED DURING IDENTIFICATION. IF THE SYSTEM FINDS OUR OWN VAT REG. NO, IT WILL CONTINUE SEARCHING THE DOCUMENT
      // FOR THE VENDOR VAT NO.
      // *********************************************************************************************************************************
      CompInfo.GET;
      WITH CaptureFieldVal DO BEGIN
        // WE ONLY WAN'T TO VALIDATE THE VALUE IF THE VALUE ALREADY CONFORMS TO THE SPECIFIED REGEX-RULES
        IF "File Rule Entry No." = 0 THEN
          EXIT;

        // REMOVE ALL LETTERS FROM THE VAT NO. AND COMPARE ONLY THE NUMBER-SEQUENCE
        "Is Valid" := RemoveLeadingLetters(Value) <> RemoveLeadingLetters(CompInfo."VAT Registration No.")
      END;
    END;

    PROCEDURE RemoveLeadingLetters@1000000000(Text@1000000000 : Text[1024]) : Text[1024];
    BEGIN
      WHILE Text <> '' DO BEGIN
        IF (COPYSTR(Text,1,1) >= 'A') AND (COPYSTR(Text,1,1) <= 'Z') THEN
          Text := COPYSTR(Text,2)
        ELSE
          EXIT(Text);
      END;
      EXIT(Text);
    END;

    BEGIN
    END.
  }
}

