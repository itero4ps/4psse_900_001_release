OBJECT Codeunit 80 Sales-Post
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVW19.00.00.45480,4PS9.00;
  }
  PROPERTIES
  {
    TableNo=36;
    Permissions=TableData 37=imd,
                TableData 38=m,
                TableData 39=m,
                TableData 49=imd,
                TableData 110=imd,
                TableData 111=imd,
                TableData 112=imd,
                TableData 113=imd,
                TableData 114=imd,
                TableData 115=imd,
                TableData 120=imd,
                TableData 121=imd,
                TableData 223=imd,
                TableData 252=imd,
                TableData 914=i,
                TableData 6507=ri,
                TableData 6508=rid,
                TableData 6660=imd,
                TableData 6661=imd,
                TableData 11020500=r,
                TableData 11072005=rm,
                TableData 2000000068=rimd;
    OnRun=VAR
            ItemEntryRelation@1010 : Record 6507;
            TempInvoicingSpecification@1011 : TEMPORARY Record 336;
            DummyTrackingSpecification@1003 : Record 336;
            PurchSetup@1019 : Record 312;
            PurchCommentLine@1018 : Record 43;
            TempAsmHeader@1000 : TEMPORARY Record 900;
            TempItemLedgEntryNotInvoiced@1006 : TEMPORARY Record 32;
            TempPostedATOLink@1001 : TEMPORARY Record 914;
            CustLedgEntry@1013 : Record 21;
            TempCombinedSalesLine@1022 : TEMPORARY Record 37;
            SalesCommentLine@1025 : Record 44;
            SalesLineBackup@1017 : Record 37;
            GLAcc@1026 : Record 15;
            FA@1028 : Record 5600;
            DeprBook@1027 : Record 5611;
            TempServiceItem1@1041 : TEMPORARY Record 5940;
            TempServiceItem2@1040 : TEMPORARY Record 5940;
            TempServiceItemComp1@1039 : TEMPORARY Record 5941;
            TempServiceItemComp2@1038 : TEMPORARY Record 5941;
            TempVATAmountLine@1043 : TEMPORARY Record 290;
            TempVATAmountLineRemainder@1042 : TEMPORARY Record 290;
            SalesInvLine@1045 : Record 113;
            SalesCrMemoLine@1046 : Record 115;
            SalesShptLine@1047 : Record 111;
            ReturnRcptLine@1048 : Record 6661;
            WhseRcptLine@1049 : Record 7317;
            WhseShptLine@1050 : Record 7321;
            UpdateAnalysisView@1002 : Codeunit 410;
            UpdateItemAnalysisView@1014 : Codeunit 7150;
            ICInOutBoxMgt@1008 : Codeunit 427;
            NoSeriesMgt@1044 : Codeunit 396;
            GenJnlCheckLine@1036 : Codeunit 11;
            RecordLinkManagement@1015 : Codeunit 447;
            CRMIntegrationManagement@1016 : Codeunit 5330;
            CostBaseAmount@1004 : Decimal;
            TrackingSpecificationExists@1007 : Boolean;
            HasATOShippedNotInvoiced@1012 : Boolean;
            EndLoop@1009 : Boolean;
            TempInvoice@1031 : Boolean;
            TempShpt@1030 : Boolean;
            TempReturn@1029 : Boolean;
            ModifyHeader@1033 : Boolean;
            EverythingInvoiced@1034 : Boolean;
            GLEntryNo@1005 : Integer;
            BiggestLineNo@1020 : Integer;
            TransactionLogEntryNo@1024 : Integer;
            ICGenJnlLineNo@1032 : Integer;
            LineCount@1035 : Integer;
            WhseReference@1051 : Integer;
            RemQtyToInvoiceCurrLine@1052 : Decimal;
            RemQtyToInvoiceCurrLineBase@1053 : Decimal;
            SavedStatus@1054 : Option;
            lvOldDocumentDate@1210190000 : Date;
            CrRestrictionAmt@1100485000 : Decimal;
            CrRestrictionVATAmt@1100485001 : Decimal;
            SourceLink@1100525000 : RecordRef;
            TargetLink@1100525001 : RecordRef;
            DocumentLinkManagement@1100525002 : Codeunit 11012401;
            ReplaceDocLink@1210190001 : Boolean;
            SalesHeaderExtension@1100528700 : Record 11071868;
            CustPostingGr@1100525003 : Record 92;
            SalesOfferAmount@1100525004 : Record 11012786;
          BEGIN
            OnBeforePostSalesDoc(Rec);

            lvOldDocumentDate := "Document Date"; //**4PS.n

            IF PostingDateExists AND (ReplacePostingDate OR ("Posting Date" = 0D)) THEN BEGIN
              "Posting Date" := PostingDate;
              VALIDATE("Currency Code");
            END;

            IF PostingDateExists AND (ReplaceDocumentDate OR ("Document Date" = 0D)) THEN
              VALIDATE("Document Date",PostingDate);
            //**4PS.sn
            // Check restore the Doc.Date, in table 'Sales Header'(36) because in the 'On Validate' of the field 'Posting Date'
            // a validate is done on the 'Doc.Date' (filled with new posting date).
            IF PostingDateExists AND ReplacePostingDate AND (NOT (ReplaceDocumentDate OR ("Document Date" = 0D))) THEN
              VALIDATE("Document Date",lvOldDocumentDate);
            //**4PS.en

            IF PreviewMode THEN BEGIN
              CLEARALL;
              PreviewMode := TRUE;
              GenJnlPostPreview.Start;
            END ELSE
              CLEARALL;

            //**4PS.sn
            SalesSetup.GET;
            IF Invoice AND
              ((("Document Type" = "Document Type"::Order) AND
                (SalesSetup."Invoice Sales Orders" = SalesSetup."Invoice Sales Orders"::NotPosted)) OR
               (("Document Type" = "Document Type"::"Return Order") AND
                (SalesSetup."Invoice Return Orders" = SalesSetup."Invoice Return Orders"::NotPosted)))
            THEN BEGIN
              Invoice := FALSE;
              gInvoiceOrderNotPostedInvoice := TRUE;
              TmpSalesOrderLineForInv.RESET;
              TmpSalesOrderLineForInv.DELETEALL;
            END;
            //**4PS.en

            SalesHeader := Rec;
            TempServiceItem2.DELETEALL;
            TempServiceItemComp2.DELETEALL;
            WITH SalesHeader DO BEGIN
              CheckMandatoryHeaderFields(Rec);
              IF GenJnlCheckLine.DateNotAllowed("Posting Date") THEN
                FIELDERROR("Posting Date",Text045);

              SetShipInvoiceReceiveFlags(SalesHeader);

              IF NOT (Ship OR Invoice OR Receive) THEN
               IF ("Document Type" <> "Document Type"::"Invoice Proposal") AND (NOT gInvoiceOrderNotPostedInvoice) THEN  //**4PS.n
                ERROR(
                  Text020,
                  FIELDCAPTION(Ship),FIELDCAPTION(Invoice),FIELDCAPTION(Receive));

              WhseReference := "Posting from Whse. Ref.";
              "Posting from Whse. Ref." := 0;

              IF Invoice THEN
                CreatePrepaymentLines(SalesHeader,TempPrepaymentSalesLine,TRUE);

              CheckDim;

              SalesSetup.GET;

              CheckPostRestrictions(SalesHeader);

              //**4PS.sn
              IF ("Document Type" = "Document Type"::"Credit Memo") AND
                 SalesSetup."Credit Reason Code Obligatory" THEN
                TESTFIELD("Reason Code");
              TmpGenJnlRateCompBufferRec.RESET;
              TmpGenJnlRateCompBufferRec.DELETEALL;
              NextLineNoGLRateCompBuf := 1;
              SetRentalUnitInvoice := FALSE;
              JobSetUp.GET;
              IF JobSetUp."Rental Units active" AND ("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) THEN
                CheckManualRentalUnitInvoice();

              IF "Project Invoice" OR "Rental Unit Invoice" THEN BEGIN
                IF NOT ChargeJobOrderToPlant THEN BEGIN
                  CustPostingGr.GET(SalesHeader."Customer Posting Group");
                  CustPostingGr.TESTFIELD("Receivables Account");
                END;
              END;

              IF "Document Type" = "Document Type"::"Invoice Proposal" THEN BEGIN
                Status := Status::Open;
                MODIFY;
                PostInvoiceProposal;
                Rec := SalesHeader;
                EXIT;
              END;

              IF ("Document Type" = "Document Type"::Order) AND
                 (("Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated") OR
                  ("Sales Document Type" = "Sales Document Type"::RentalContract))
              THEN BEGIN
                Rec := SalesHeader;
                EXIT;
              END;
              IF gInvoiceOrderNotPostedInvoice THEN
                CheckQtyToInvoicePresent();
              //**4PS.en

              IF Invoice THEN BEGIN
                SalesLine.RESET;
                SalesLine.SETRANGE("Document Type","Document Type");
                SalesLine.SETRANGE("Document No.","No.");
                SalesLine.SETFILTER(Quantity,'<>0');
                IF "Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"] THEN
                  SalesLine.SETFILTER("Qty. to Invoice",'<>0');
                Invoice := NOT SalesLine.ISEMPTY;
                IF Invoice AND (NOT Ship) AND ("Document Type" = "Document Type"::Order) THEN BEGIN
                  SalesLine.FINDSET;
                  Invoice := FALSE;
                  REPEAT
                    Invoice := SalesLine."Quantity Shipped" - SalesLine."Quantity Invoiced" <> 0;
                  UNTIL Invoice OR (SalesLine.NEXT = 0);
                END ELSE
                  IF Invoice AND (NOT Receive) AND ("Document Type" = "Document Type"::"Return Order") THEN BEGIN
                    SalesLine.FINDSET;
                    Invoice := FALSE;
                    REPEAT
                      Invoice := SalesLine."Return Qty. Received" - SalesLine."Quantity Invoiced" <> 0;
                    UNTIL Invoice OR (SalesLine.NEXT = 0);
                  END;
              END;
              IF Invoice THEN BEGIN
                CopyAndCheckItemCharge(SalesHeader);
                CheckDeferralPosting(SalesHeader);
              END;

              IF Invoice AND NOT ("Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]) THEN
                //**4PS.sn
                IF (NOT ChargePlantToProject) AND (NOT ChargeJobOrderToPlant) AND (NOT ChargePlantToServOrder) AND
                   (NOT ChargeSOToJobPlantLoc) THEN  //**4PS.n DP00195
                //**4PS.en
                  TESTFIELD("Due Date");

              //**4PS.sn, Call 28952
              IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
                SalesLine.RESET;
                SalesLine.SETRANGE("Document Type","Document Type");
                SalesLine.SETRANGE("Document No.","No.");
                SalesLine.SETFILTER("Item No.",'<>%1', '');
                SalesLine.SETFILTER(Quantity,'<>0');
                IF SalesLine.FINDSET THEN
                  REPEAT
                    Item.GET(SalesLine."Item No.");
                    IF Item."Logistics on Component Level" THEN
                      ERROR(Text11012004,SalesLine."Item No.");
                  UNTIL SalesLine.NEXT = 0;
              END;
              //**4PS.en

              IF Ship THEN
                CheckTrackingAndWarehouseForShip("Document Type","No.",WhseReference,Ship);

              IF Receive THEN
                CheckTrackingAndWarehouseForReceive("Document Type","No.",WhseReference,Receive);

              IF NOT (Ship OR Invoice OR Receive) THEN
               IF NOT gInvoiceOrderNotPostedInvoice THEN  //**4PS.n
                IF NOT OnlyAssgntPosting THEN
                  ERROR(Text001);

              IF ("Shipping Advice" = "Shipping Advice"::Complete) AND Ship THEN
                CheckShippingAdvice;

              InitProgressWindow(SalesHeader);

              JobSetUp.GET;  //**4PS.n
              GetGLSetup;
              GetCurrency;

              IF "Posting No." = FakeDocNoTxt THEN
                "Posting No." := '';

              IF Ship AND ("Shipping No." = '') THEN
                IF ("Document Type" = "Document Type"::Order) OR
                   (("Document Type" = "Document Type"::Invoice) AND SalesSetup."Shipment on Invoice")
                THEN BEGIN
                  TESTFIELD("Shipping No. Series");
                  "Shipping No." := NoSeriesMgt.GetNextNo("Shipping No. Series","Posting Date",TRUE);
                  ModifyHeader := TRUE;
                END;

              IF Receive AND ("Return Receipt No." = '') THEN
                IF ("Document Type" = "Document Type"::"Return Order") OR
                   (("Document Type" = "Document Type"::"Credit Memo") AND SalesSetup."Return Receipt on Credit Memo")
                THEN BEGIN
                  TESTFIELD("Return Receipt No. Series");
                  "Return Receipt No." := NoSeriesMgt.GetNextNo("Return Receipt No. Series","Posting Date",TRUE);
                  ModifyHeader := TRUE;
                END;

              IF Invoice AND ("Posting No." = '') THEN BEGIN
                IF ("No. Series" <> '') OR
                   ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
                THEN
                  TESTFIELD("Posting No. Series");
                IF ("No. Series" <> "Posting No. Series") OR
                   ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
                THEN BEGIN
                  IF NOT PreviewMode THEN BEGIN
                    "Posting No." := NoSeriesMgt.GetNextNo("Posting No. Series","Posting Date",TRUE);
                    ModifyHeader := TRUE;
                  END ELSE
                    "Posting No." := FakeDocNoTxt;
                END;
              END;

              IF NOT ItemChargeAssgntOnly THEN BEGIN
                SalesLine.RESET;
                SalesLine.SETRANGE("Document Type","Document Type");
                SalesLine.SETRANGE("Document No.","No.");
                SalesLine.SETFILTER("Purch. Order Line No.",'<>0');
                IF NOT SalesLine.ISEMPTY THEN BEGIN
                  DropShipOrder := TRUE;
                  IF Ship THEN BEGIN
                    SalesLine.FINDSET;
                    REPEAT
                      IF PurchOrderHeader."No." <> SalesLine."Purchase Order No." THEN BEGIN
                        PurchOrderHeader.GET(
                          PurchOrderHeader."Document Type"::Order,
                          SalesLine."Purchase Order No.");
                        PurchOrderHeader.TESTFIELD("Pay-to Vendor No.");
                        PurchOrderHeader.Receive := TRUE;
                        CODEUNIT.RUN(CODEUNIT::"Release Purchase Document",PurchOrderHeader);
                        IF PurchOrderHeader."Receiving No." = '' THEN BEGIN
                          PurchOrderHeader.TESTFIELD("Receiving No. Series");
                          PurchOrderHeader."Receiving No." :=
                            NoSeriesMgt.GetNextNo(PurchOrderHeader."Receiving No. Series","Posting Date",TRUE);
                          PurchOrderHeader.MODIFY;
                          ModifyHeader := TRUE;
                        END;
                      END;
                    UNTIL SalesLine.NEXT = 0;
                  END;
                END;
              END;
              OnBeforePostCommitSalesDoc(Rec,GenJnlPostLine,PreviewMode,ModifyHeader);
              IF NOT PreviewMode AND ModifyHeader THEN BEGIN
                MODIFY;
                COMMIT;
              END;

              IF SalesSetup."Calc. Inv. Discount" AND
                 (Status <> Status::Open) AND
                 NOT ItemChargeAssgntOnly
              THEN BEGIN
                SalesLine.RESET;
                SalesLine.SETRANGE("Document Type","Document Type");
                SalesLine.SETRANGE("Document No.","No.");
                SalesLine.FINDFIRST;
                TempInvoice := Invoice;
                TempShpt := Ship;
                TempReturn := Receive;
                CODEUNIT.RUN(CODEUNIT::"Sales-Calc. Discount",SalesLine);
                GET("Document Type","No.");
                Invoice := TempInvoice;
                Ship := TempShpt;
                Receive := TempReturn;
                IF NOT PreviewMode THEN
                  COMMIT;
              END;

              IF (Status = Status::Open) OR (Status = Status::"Pending Prepayment") THEN BEGIN
                TempInvoice := Invoice;
                TempShpt := Ship;
                TempReturn := Receive;
                SavedStatus := Status;
                GetOpenLinkedATOs(TempAsmHeader);
                CODEUNIT.RUN(CODEUNIT::"Release Sales Document",SalesHeader);
                TESTFIELD(Status,Status::Released);
                Status := SavedStatus;
                Invoice := TempInvoice;
                Ship := TempShpt;
                Receive := TempReturn;
                ReopenAsmOrders(TempAsmHeader);
                IF PreviewMode AND ("Posting No." = '') THEN
                  "Posting No." := FakeDocNoTxt;
                IF NOT PreviewMode THEN BEGIN
                  MODIFY;
                  COMMIT;
                END;
                Status := Status::Released;
              END;

              TransactionLogEntryNo := AuthorizeCreditCard("Authorization Required");

              IF Ship OR Receive THEN
                ArchiveUnpostedOrder(SalesHeader);

              CheckICPartnerBlocked(SalesHeader);
              SendICDocument(SalesHeader,ModifyHeader);
              UpdateHandledICInboxTransaction(SalesHeader);

              LockTables;

              SourceCodeSetup.GET;
              SrcCode := SourceCodeSetup.Sales;
              //**4PS.sn
              IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc AND NOT ChargeSOToCustomerPlantLoc THEN //DP00195
                SrcCode := SourceCodeSetup."Plant Invoice";
              //**4PS.en

              // Insert shipment header
              IF Ship THEN BEGIN
                IF ("Document Type" = "Document Type"::Order) OR
                   (("Document Type" = "Document Type"::Invoice) AND SalesSetup."Shipment on Invoice")
                THEN BEGIN
                  IF DropShipOrder THEN BEGIN
                    PurchRcptHeader.LOCKTABLE;
                    PurchRcptLine.LOCKTABLE;
                    SalesShptHeader.LOCKTABLE;
                    SalesShptLine.LOCKTABLE;
                  END;
                  InsertShipmentHeader(SalesHeader,SalesShptHeader);
                END;

                { //**4PS.so No Support for Service Item Management
                ServItemMgt.CopyReservationEntry(SalesHeader);
                IF ("Document Type" = "Document Type"::Invoice) AND
                   (NOT SalesSetup."Shipment on Invoice")
                THEN
                  ServItemMgt.CreateServItemOnSalesInvoice(SalesHeader);
                } //**4PS.eo
              END;

              ServItemMgt.DeleteServItemOnSaleCreditMemo(SalesHeader);

              // Insert return receipt header
              IF Receive THEN
                IF ("Document Type" = "Document Type"::"Return Order") OR
                   (("Document Type" = "Document Type"::"Credit Memo") AND SalesSetup."Return Receipt on Credit Memo")
                THEN
                  InsertReturnReceiptHeader(SalesHeader,ReturnRcptHeader);

              // Insert invoice header or credit memo header
              IF gInvoiceOrderNotPostedInvoice THEN InsertNotPostedSalesInvoice();  //**4PS.n
              IF Invoice THEN
                IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
                  InsertInvoiceHeader(SalesHeader,SalesInvHeader);
                  ReplaceDocLink := TRUE; //**4PS.n
                  GenJnlLineDocType := GenJnlLine."Document Type"::Invoice;
                  GenJnlLineDocNo := SalesInvHeader."No.";
                  GenJnlLineExtDocNo := SalesInvHeader."External Document No.";
                END ELSE BEGIN // Credit Memo
                  InsertCrMemoHeader(SalesHeader,SalesCrMemoHeader);
                  ReplaceDocLink := TRUE; //**4PS.n
                  GenJnlLineDocType := GenJnlLine."Document Type"::"Credit Memo";
                  GenJnlLineDocNo := SalesCrMemoHeader."No.";
                  GenJnlLineExtDocNo := SalesCrMemoHeader."External Document No.";
                END;

              UpdateIncomingDocument("Incoming Document Entry No.","Posting Date",GenJnlLineDocNo);

              // Lines
              TempDeferralHeader.DELETEALL;
              TempDeferralLine.DELETEALL;
              InvPostingBuffer[1].DELETEALL;
              DropShipPostBuffer.DELETEALL;
              SurchargePostingBuffer[1].DELETEALL;    //**4PS.n
              RequisitionPostingBuffer[1].DELETEALL;  //**4PS.n
              ComplWIPPostingBuffer[1].DELETEALL;  //**4PS.n
              PlantTransportInternalCust := FALSE;  //**4PS.n
              EverythingInvoiced := TRUE;

              SalesLine.RESET;
              SalesLine.SETRANGE("Document Type","Document Type");
              SalesLine.SETRANGE("Document No.","No.");
              LineCount := 0;
              RoundingLineInserted := FALSE;
              MergeSaleslines(SalesHeader,SalesLine,TempPrepaymentSalesLine,TempCombinedSalesLine);
              AdjustFinalInvWith100PctPrepmt(TempCombinedSalesLine);

              TempVATAmountLineRemainder.DELETEALL;
              SalesLine.CalcVATAmountLines(1,SalesHeader,TempCombinedSalesLine,TempVATAmountLine);

              SalesLinesProcessed := FALSE;
              IF SalesLine.FINDSET THEN
                REPEAT
                  SaveOrgSalesLineRec := SalesLine;  //**4PS.n

                  IF SalesLine.Type = SalesLine.Type::Item THEN
                    DummyTrackingSpecification.CheckItemTrackingQuantity(
                      DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.",
                      SalesLine."Qty. to Ship (Base)",SalesLine."Qty. to Invoice (Base)",Ship,Invoice);
                  ItemJnlRollRndg := FALSE;
                  LineCount := LineCount + 1;
                  Window.UPDATE(2,LineCount);
                  IF SalesLine.Type = SalesLine.Type::"Charge (Item)" THEN BEGIN
                    SalesLine.TESTFIELD(Amount);
                    SalesLine.TESTFIELD("Job No.",'');
                    SalesLine.TESTFIELD("Job Contract Entry No.",0);
                  END;
                  IF SalesLine.Type = SalesLine.Type::Item THEN
                    CostBaseAmount := SalesLine."Line Amount";
                  IF SalesLine."Qty. per Unit of Measure" = 0 THEN
                    SalesLine."Qty. per Unit of Measure" := 1;
                  CASE "Document Type" OF
                    "Document Type"::Order:
                      SalesLine.TESTFIELD("Return Qty. to Receive",0);
                    "Document Type"::Invoice:
                      BEGIN
                        //**4PS.sn
                        IF NOT ("Sales Document Type" IN
                          ["Sales Document Type"::"Sales Logistics Separated","Sales Document Type"::RentalContract]) THEN
                        BEGIN
                        //**4PS.en
                          IF SalesLine."Shipment No." = '' THEN
                            SalesLine.TESTFIELD("Qty. to Ship",SalesLine.Quantity);
                          SalesLine.TESTFIELD("Return Qty. to Receive",0);
                          SalesLine.TESTFIELD("Qty. to Invoice",SalesLine.Quantity);
                        END; //**4PS.n
                      END;
                    "Document Type"::"Return Order":
                      SalesLine.TESTFIELD("Qty. to Ship",0);
                    "Document Type"::"Credit Memo":
                      BEGIN
                        { //**4PS.so
                        IF SalesLine."Return Receipt No." = '' THEN
                          SalesLine.TESTFIELD("Return Qty. to Receive",SalesLine.Quantity);
                        SalesLine.TESTFIELD("Qty. to Ship",0);
                        } //**4PS.eo
                        SalesLine.TESTFIELD("Qty. to Invoice",SalesLine.Quantity);
                      END;
                  END;

                  TempPostedATOLink.RESET;
                  TempPostedATOLink.DELETEALL;
                  IF Ship THEN
                    PostATO(SalesLine,TempPostedATOLink);

                  IF NOT (Ship OR RoundingLineInserted) THEN BEGIN
                    SalesLine."Qty. to Ship" := 0;
                    SalesLine."Qty. to Ship (Base)" := 0;
                  END;
                  IF NOT (Receive OR RoundingLineInserted) THEN BEGIN
                    SalesLine."Return Qty. to Receive" := 0;
                    SalesLine."Return Qty. to Receive (Base)" := 0;
                  END;

                  JobContractLine := FALSE;
                  IF (SalesLine.Type = SalesLine.Type::Item) OR
                     (SalesLine.Type = SalesLine.Type::"G/L Account") OR
                     (SalesLine.Type = SalesLine.Type::" ")
                  THEN
                    IF SalesLine."Job Contract Entry No." > 0 THEN
                      PostJobContractLine(SalesLine);
                  IF SalesLine.Type = SalesLine.Type::Resource THEN
                    JobTaskSalesLine := SalesLine;

                  IF SalesLine.Type = SalesLine.Type::"Fixed Asset" THEN BEGIN
                    SalesLine.TESTFIELD("Job No.",'');
                    SalesLine.TESTFIELD("Depreciation Book Code");
                    DeprBook.GET(SalesLine."Depreciation Book Code");
                    DeprBook.TESTFIELD("G/L Integration - Disposal",TRUE);
                    FA.GET(SalesLine."No.");
                    FA.TESTFIELD("Budgeted Asset",FALSE);
                  END ELSE BEGIN
                    SalesLine.TESTFIELD("Depreciation Book Code",'');
                    SalesLine.TESTFIELD("Depr. until FA Posting Date",FALSE);
                    SalesLine.TESTFIELD("FA Posting Date",0D);
                    SalesLine.TESTFIELD("Duplicate in Depreciation Book",'');
                    SalesLine.TESTFIELD("Use Duplication List",FALSE);
                  END;

                  IF ("Document Type" = "Document Type"::Invoice) AND (SalesLine."Shipment No." <> '') THEN BEGIN
                    SalesLine."Quantity Shipped" := SalesLine.Quantity;
                    SalesLine."Qty. Shipped (Base)" := SalesLine."Quantity (Base)";
                    SalesLine."Qty. to Ship" := 0;
                    SalesLine."Qty. to Ship (Base)" := 0;
                  END;

                  IF ("Document Type" = "Document Type"::"Credit Memo") AND (SalesLine."Return Receipt No." <> '') THEN BEGIN
                    SalesLine."Return Qty. Received" := SalesLine.Quantity;
                    SalesLine."Return Qty. Received (Base)" := SalesLine."Quantity (Base)";
                    SalesLine."Return Qty. to Receive" := 0;
                    SalesLine."Return Qty. to Receive (Base)" := 0;
                  END;

                  IF Invoice THEN BEGIN
                   IF SalesLine."Document Type" <> SalesLine."Document Type"::"Credit Memo" THEN //**4PS.n
                    IF ABS(SalesLine."Qty. to Invoice") > ABS(SalesLine.MaxQtyToInvoice) THEN
                      SalesLine.InitQtyToInvoice;
                  END ELSE BEGIN
                    SalesLine."Qty. to Invoice" := 0;
                    SalesLine."Qty. to Invoice (Base)" := 0;
                  END;

                  IF (SalesLine.Type = SalesLine.Type::Item) AND (SalesLine."No." <> '') THEN BEGIN
                    GetItem(SalesLine);
                    IF (Item."Costing Method" = Item."Costing Method"::Standard) AND NOT SalesLine.IsShipment THEN
                      SalesLine.GetUnitCost;
                  END;

                  IF SalesLine."Qty. to Invoice" + SalesLine."Quantity Invoiced" <> SalesLine.Quantity THEN
                    EverythingInvoiced := FALSE;

                  IF SalesLine.Quantity = 0 THEN
                    SalesLine.TESTFIELD(Amount,0)
                  ELSE BEGIN
                    SalesLine.TESTFIELD("No.");
                    SalesLine.TESTFIELD(Type);
                    //**4PS.sn
                    IF NOT SalesLine."Project Invoice" AND NOT SalesLine."Service Invoice" AND
                       NOT "Plant Invoice" AND NOT "Rental Unit Invoice" AND
                       (SalesLine."Job No." = '') AND (SalesLine."Service Order No." = '') THEN
                    BEGIN
                    //**4PS.en
                      SalesLine.TESTFIELD("Gen. Bus. Posting Group");
                      SalesLine.TESTFIELD("Gen. Prod. Posting Group");
                    END;  //**4PS.n

                    DivideAmount(1,SalesLine."Qty. to Invoice",TempVATAmountLine,TempVATAmountLineRemainder);
                  END;

                  IF SalesLine."Drop Shipment" THEN BEGIN
                    IF SalesLine.Type <> SalesLine.Type::Item THEN
                      SalesLine.TESTFIELD("Drop Shipment",FALSE);
                    IF (SalesLine."Qty. to Ship" <> 0) AND (SalesLine."Purch. Order Line No." = 0) THEN
                      ERROR(
                        Text009 +
                        Text010,
                        SalesLine."Line No.");
                  END;

                  CheckItemReservDisruption;
                  RoundAmount(SalesLine."Qty. to Invoice");

                  IF NOT SalesLine.IsCreditDocType THEN BEGIN
                    ReverseAmount(SalesLine);
                    ReverseAmount(SalesLineACY);
                  END;

                  RemQtyToBeInvoiced := SalesLine."Qty. to Invoice";
                  RemQtyToBeInvoicedBase := SalesLine."Qty. to Invoice (Base)";

                  // Item Tracking:
                  IF NOT SalesLine."Prepayment Line" THEN BEGIN
                    IF Invoice THEN
                      IF SalesLine."Qty. to Invoice" = 0 THEN
                        TrackingSpecificationExists := FALSE
                      ELSE
                        TrackingSpecificationExists :=
                          ReserveSalesLine.RetrieveInvoiceSpecification(SalesLine,TempInvoicingSpecification);
                    EndLoop := FALSE;

                    IF SalesLine.IsCreditDocType THEN BEGIN
                      IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Return Qty. to Receive") THEN BEGIN
                        ReturnRcptLine.RESET;
                        CASE "Document Type" OF
                          "Document Type"::"Return Order":
                            BEGIN
                              ReturnRcptLine.SETCURRENTKEY("Return Order No.","Return Order Line No.");
                              ReturnRcptLine.SETRANGE("Return Order No.",SalesLine."Document No.");
                              ReturnRcptLine.SETRANGE("Return Order Line No.",SalesLine."Line No.");
                            END;
                          "Document Type"::"Credit Memo":
                            BEGIN
                              ReturnRcptLine.SETRANGE("Document No.",SalesLine."Return Receipt No.");
                              ReturnRcptLine.SETRANGE("Line No.",SalesLine."Return Receipt Line No.");
                            END;
                        END;
                        ReturnRcptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'<>0');
                        IF ReturnRcptLine.FIND('-') THEN BEGIN
                          ItemJnlRollRndg := TRUE;
                          REPEAT
                            IF TrackingSpecificationExists THEN BEGIN  // Item Tracking
                              ItemEntryRelation.GET(TempInvoicingSpecification."Item Ledger Entry No.");
                              ReturnRcptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
                            END ELSE
                              ItemEntryRelation."Item Entry No." := ReturnRcptLine."Item Rcpt. Entry No.";
                            ReturnRcptLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");
                            ReturnRcptLine.TESTFIELD(Type,SalesLine.Type);
                            ReturnRcptLine.TESTFIELD("No.",SalesLine."No.");
                            ReturnRcptLine.TESTFIELD("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                            ReturnRcptLine.TESTFIELD("Gen. Prod. Posting Group",SalesLine."Gen. Prod. Posting Group");
                            ReturnRcptLine.TESTFIELD("Job No.",SalesLine."Job No.");
                            ReturnRcptLine.TESTFIELD("Unit of Measure Code",SalesLine."Unit of Measure Code");
                            ReturnRcptLine.TESTFIELD("Variant Code",SalesLine."Variant Code");
                            IF SalesLine."Qty. to Invoice" * ReturnRcptLine.Quantity < 0 THEN
                              SalesLine.FIELDERROR("Qty. to Invoice",Text024);
                            IF TrackingSpecificationExists THEN BEGIN  // Item Tracking
                              QtyToBeInvoiced := TempInvoicingSpecification."Qty. to Invoice";
                              QtyToBeInvoicedBase := TempInvoicingSpecification."Qty. to Invoice (Base)";
                            END ELSE BEGIN
                              QtyToBeInvoiced := RemQtyToBeInvoiced - SalesLine."Return Qty. to Receive";
                              QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Return Qty. to Receive (Base)";
                            END;
                            IF ABS(QtyToBeInvoiced) >
                               ABS(ReturnRcptLine.Quantity - ReturnRcptLine."Quantity Invoiced")
                            THEN BEGIN
                              QtyToBeInvoiced := ReturnRcptLine.Quantity - ReturnRcptLine."Quantity Invoiced";
                              QtyToBeInvoicedBase := ReturnRcptLine."Quantity (Base)" - ReturnRcptLine."Qty. Invoiced (Base)";
                            END;

                            IF TrackingSpecificationExists THEN
                              ItemTrackingMgt.AdjustQuantityRounding(
                                RemQtyToBeInvoiced,QtyToBeInvoiced,
                                RemQtyToBeInvoicedBase,QtyToBeInvoicedBase);

                            RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
                            RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
                            ReturnRcptLine."Quantity Invoiced" :=
                              ReturnRcptLine."Quantity Invoiced" + QtyToBeInvoiced;
                            ReturnRcptLine."Qty. Invoiced (Base)" :=
                              ReturnRcptLine."Qty. Invoiced (Base)" + QtyToBeInvoicedBase;
                            ReturnRcptLine."Return Qty. Rcd. Not Invd." :=
                              ReturnRcptLine.Quantity - ReturnRcptLine."Quantity Invoiced";
                            ReturnRcptLine.MODIFY;
                            IF SalesLine.Type = SalesLine.Type::Item THEN
                              PostItemJnlLine(
                                SalesLine,
                                0,0,
                                QtyToBeInvoiced,
                                QtyToBeInvoicedBase,
                                // ReturnRcptLine."Item Rcpt. Entry No."
                                ItemEntryRelation."Item Entry No.",'',TempInvoicingSpecification,FALSE);
                            IF TrackingSpecificationExists THEN
                              EndLoop := (TempInvoicingSpecification.NEXT = 0)
                            ELSE
                              EndLoop :=
                                (ReturnRcptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Return Qty. to Receive"));
                          UNTIL EndLoop;
                        { //**4PS.so
                        END ELSE
                          ERROR(
                            Text025,
                            SalesLine."Return Receipt Line No.",SalesLine."Return Receipt No.");
                        } //**4PS.eo
                        END; //**4PS.n
                      END;

                      IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Return Qty. to Receive") THEN BEGIN
                        { //**4PS.so
                        IF "Document Type" = "Document Type"::"Credit Memo" THEN
                          ERROR(
                            Text038,
                            ReturnRcptLine."Document No.");
                        } //**4PS.eo
                        IF "Document Type" <> "Document Type"::"Credit Memo" THEN//**4PS.n
                          ERROR(Text037);
                      END;
                    END ELSE BEGIN
                      IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Qty. to Ship") THEN BEGIN
                        SalesShptLine.RESET;
                        CASE "Document Type" OF
                          "Document Type"::Order:
                            BEGIN
                              SalesShptLine.SETCURRENTKEY("Order No.","Order Line No.");
                              SalesShptLine.SETRANGE("Order No.",SalesLine."Document No.");
                              SalesShptLine.SETRANGE("Order Line No.",SalesLine."Line No.");
                            END;
                          "Document Type"::Invoice:
                            BEGIN
                              SalesShptLine.SETRANGE("Document No.",SalesLine."Shipment No.");
                              SalesShptLine.SETRANGE("Line No.",SalesLine."Shipment Line No.");
                            END;
                        END;

                        IF NOT TrackingSpecificationExists THEN
                          HasATOShippedNotInvoiced := GetATOItemLedgEntriesNotInvoiced(SalesLine,TempItemLedgEntryNotInvoiced);

                        SalesShptLine.SETFILTER("Qty. Shipped Not Invoiced",'<>0');
                        IF SalesShptLine.FINDFIRST THEN BEGIN
                          ItemJnlRollRndg := TRUE;
                          REPEAT
                            SetItemEntryRelation(
                              ItemEntryRelation,SalesShptLine,
                              TempInvoicingSpecification,TempItemLedgEntryNotInvoiced,
                              TrackingSpecificationExists,HasATOShippedNotInvoiced);

                            UpdateRemainingQtyToBeInvoiced(SalesShptLine,RemQtyToInvoiceCurrLine,RemQtyToInvoiceCurrLineBase);

                            SalesShptLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");
                            SalesShptLine.TESTFIELD(Type,SalesLine.Type);
                            SalesShptLine.TESTFIELD("No.",SalesLine."No.");
                            SalesShptLine.TESTFIELD("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
                            SalesShptLine.TESTFIELD("Gen. Prod. Posting Group",SalesLine."Gen. Prod. Posting Group");
                            SalesShptLine.TESTFIELD("Job No.",SalesLine."Job No.");
                            SalesShptLine.TESTFIELD("Unit of Measure Code",SalesLine."Unit of Measure Code");
                            SalesShptLine.TESTFIELD("Variant Code",SalesLine."Variant Code");
                            IF -SalesLine."Qty. to Invoice" * SalesShptLine.Quantity < 0 THEN
                              SalesLine.FIELDERROR("Qty. to Invoice",Text011);

                            UpdateQtyToBeInvoiced(
                              QtyToBeInvoiced,QtyToBeInvoicedBase,
                              TrackingSpecificationExists,HasATOShippedNotInvoiced,
                              SalesLine,SalesShptLine,
                              TempInvoicingSpecification,TempItemLedgEntryNotInvoiced);

                            IF TrackingSpecificationExists OR HasATOShippedNotInvoiced THEN
                              ItemTrackingMgt.AdjustQuantityRounding(
                                RemQtyToInvoiceCurrLine,QtyToBeInvoiced,
                                RemQtyToInvoiceCurrLineBase,QtyToBeInvoicedBase);

                            RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
                            RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
                            UpdateInvoicedQtyOnShipmentLine(SalesShptLine,QtyToBeInvoiced,QtyToBeInvoicedBase);
                            IF SalesLine.Type = SalesLine.Type::Item THEN
                              PostItemJnlLine(
                                SalesLine,
                                0,0,
                                QtyToBeInvoiced,
                                QtyToBeInvoicedBase,
                                // SalesShptLine."Item Shpt. Entry No."
                                ItemEntryRelation."Item Entry No.",'',TempInvoicingSpecification,FALSE);
                          UNTIL IsEndLoopForShippedNotInvoiced(
                                  RemQtyToBeInvoiced,TrackingSpecificationExists,HasATOShippedNotInvoiced,
                                  SalesShptLine,TempInvoicingSpecification,TempItemLedgEntryNotInvoiced,SalesLine);
                        END ELSE
                          ERROR(
                            Text026,
                            SalesLine."Shipment Line No.",SalesLine."Shipment No.");
                      END;

                      IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Qty. to Ship") THEN BEGIN
                        IF "Document Type" = "Document Type"::Invoice THEN
                          ERROR(
                            Text027,
                            SalesShptLine."Document No.");
                        ERROR(Text013);
                      END;
                    END;

                    IF TrackingSpecificationExists THEN
                      SaveInvoiceSpecification(TempInvoicingSpecification);
                  END;

                  CASE SalesLine.Type OF
                    SalesLine.Type::"G/L Account":
                      IF (SalesLine."No." <> '') AND NOT SalesLine."System-Created Entry" THEN BEGIN
                        GLAcc.GET(SalesLine."No.");
                        GLAcc.TESTFIELD("Direct Posting",TRUE);
                        IF (SalesLine."IC Partner Code" <> '') AND Invoice THEN
                          InsertICGenJnlLine(TempSalesLine,ICGenJnlLineNo);
                      END;
                    SalesLine.Type::Item:
                      BEGIN
                        IF (SalesLine."Qty. to Ship" <> 0) AND (SalesLine."Purch. Order Line No." <> 0) THEN BEGIN
                          DropShipPostBuffer."Order No." := SalesLine."Purchase Order No.";
                          DropShipPostBuffer."Order Line No." := SalesLine."Purch. Order Line No.";
                          DropShipPostBuffer.Quantity := -SalesLine."Qty. to Ship";
                          DropShipPostBuffer."Quantity (Base)" := -SalesLine."Qty. to Ship (Base)";
                          DropShipPostBuffer."Item Shpt. Entry No." :=
                            PostAssocItemJnlLine(DropShipPostBuffer.Quantity,DropShipPostBuffer."Quantity (Base)");
                          DropShipPostBuffer.INSERT;
                          SalesLine."Appl.-to Item Entry" := DropShipPostBuffer."Item Shpt. Entry No.";
                        END;

                        CLEAR(TempPostedATOLink);
                        TempPostedATOLink.SETRANGE("Order No.",SalesLine."Document No.");
                        TempPostedATOLink.SETRANGE("Order Line No.",SalesLine."Line No.");
                        IF TempPostedATOLink.FINDFIRST THEN
                          PostATOAssocItemJnlLine(SalesLine,TempPostedATOLink,RemQtyToBeInvoiced,RemQtyToBeInvoicedBase);

                        IF RemQtyToBeInvoiced <> 0 THEN
                          ItemLedgShptEntryNo :=
                            PostItemJnlLine(
                              SalesLine,
                              RemQtyToBeInvoiced,RemQtyToBeInvoicedBase,
                              RemQtyToBeInvoiced,RemQtyToBeInvoicedBase,
                              0,'',DummyTrackingSpecification,FALSE);

                        IF SalesLine.IsCreditDocType THEN BEGIN
                          IF ABS(SalesLine."Return Qty. to Receive") > ABS(RemQtyToBeInvoiced) THEN
                            ItemLedgShptEntryNo :=
                              PostItemJnlLine(
                                SalesLine,
                                SalesLine."Return Qty. to Receive" - RemQtyToBeInvoiced,
                                SalesLine."Return Qty. to Receive (Base)" - RemQtyToBeInvoicedBase,
                                0,0,0,'',DummyTrackingSpecification,FALSE);
                        END ELSE BEGIN
                          IF ABS(SalesLine."Qty. to Ship") > ABS(RemQtyToBeInvoiced) + ABS(TempPostedATOLink."Assembled Quantity") THEN
                            ItemLedgShptEntryNo :=
                              PostItemJnlLine(
                                SalesLine,
                                SalesLine."Qty. to Ship" - TempPostedATOLink."Assembled Quantity" - RemQtyToBeInvoiced,
                                SalesLine."Qty. to Ship (Base)" - TempPostedATOLink."Assembled Quantity (Base)" - RemQtyToBeInvoicedBase,
                                0,0,0,'',DummyTrackingSpecification,FALSE);
                        END;
                      END;
                    SalesLine.Type::Resource:
                      IF SalesLine."Qty. to Invoice" <> 0 THEN
                        PostResJnlLine(SalesHeader,SalesLine,JobTaskSalesLine);
                    SalesLine.Type::"Charge (Item)":
                      IF (Invoice AND (SalesLine."Qty. to Invoice" <> 0)) OR ItemChargeAssgntOnly THEN BEGIN
                        ItemJnlRollRndg := TRUE;
                        SalesLineBackup.COPY(SalesLine);
                        IF FindTempItemChargeAssgntSales(SalesLineBackup."Line No.") THEN
                          REPEAT
                            IF ItemChargeAssgntOnly AND (GenJnlLineDocNo = '') THEN
                              GenJnlLineDocNo := TempItemChargeAssgntSales."Applies-to Doc. No.";
                            CASE TempItemChargeAssgntSales."Applies-to Doc. Type" OF
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::Shipment:
                                BEGIN
                                  PostItemChargePerShpt(SalesLineBackup);
                                  TempItemChargeAssgntSales.MARK(TRUE);
                                END;
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::"Return Receipt":
                                BEGIN
                                  PostItemChargePerRetRcpt(SalesLineBackup);
                                  TempItemChargeAssgntSales.MARK(TRUE);
                                END;
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::Order,
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::Invoice,
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::"Return Order",
                              TempItemChargeAssgntSales."Applies-to Doc. Type"::"Credit Memo":
                                CheckItemCharge(TempItemChargeAssgntSales);
                            END;
                          UNTIL TempItemChargeAssgntSales.NEXT = 0;
                      END;
                  END;

                  IF (SalesLine.Type >= SalesLine.Type::"G/L Account") AND (SalesLine."Qty. to Invoice" <> 0) THEN BEGIN
                    AdjustPrepmtAmountLCY(SalesLine);
                    // Copy sales to buffer
                    FillInvPostingBuffer(SalesLine,SalesLineACY);
                    InsertPrepmtAdjInvPostingBuf(SalesLine);
                  END;

                  //IF NOT ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN  //**4PS.o (db, 03-09-03)
                  IF NOT ("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN  //**4PS.n
                    SalesLine.TESTFIELD("Job No.",'');

                  PostingJobServicePlant();  //**4PS.n

                  IF (SalesShptHeader."No." <> '') AND (SalesLine."Shipment No." = '') AND
                     NOT RoundingLineInserted AND NOT TempSalesLine."Prepayment Line"
                     AND AdditionalCheckOnQtyOk(TempSalesLine, TRUE) //**4PS.n C015652
                  THEN BEGIN
                    // Insert shipment line
                    SalesShptLine.InitFromSalesLine(SalesShptHeader,TempSalesLine);
                    IF (SalesLine.Type = SalesLine.Type::Item) AND (TempSalesLine."Qty. to Ship" <> 0) THEN BEGIN
                      IF WhseShip THEN BEGIN
                        WhseShptLine.GetWhseShptLine(
                          WhseShptLine,WhseShptHeader."No.",DATABASE::"Sales Line",
                          SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                        PostWhseShptLines(WhseShptLine,SalesShptLine,SalesLine);
                      END;
                      IF WhseReceive THEN BEGIN
                        WhseRcptLine.GetWhseRcptLine(
                          WhseRcptLine,WhseRcptHeader."No.",DATABASE::"Sales Line",
                          SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                        WhseRcptLine.TESTFIELD("Qty. to Receive",-SalesShptLine.Quantity);
                        SaveTempWhseSplitSpec(SalesLine);
                        WhsePostRcpt.CreatePostedRcptLine(
                          WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
                      END;

                      SalesShptLine."Item Shpt. Entry No." :=
                        InsertShptEntryRelation(SalesShptLine); // ItemLedgShptEntryNo
                      SalesShptLine."Item Charge Base Amount" :=
                        ROUND(CostBaseAmount / SalesLine.Quantity * SalesShptLine.Quantity);
                    END;
                    SalesShptLine."Authorized for Credit Card" := IsAuthorized(TransactionLogEntryNo);
                    SalesShptLine.INSERT;

                    CheckCertificateOfSupplyStatus(SalesShptHeader,SalesShptLine);

                    { //**4PS.so No Support for Service Item Management
                    ServItemMgt.CreateServItemOnSalesLineShpt(Rec,TempSalesLine,SalesShptLine);
                    } //**4PS.eo

                    IF SalesLine."BOM Item No." <> '' THEN BEGIN
                      ServItemMgt.ReturnServItemComp(TempServiceItem1,TempServiceItemComp1);
                      IF TempServiceItem1.FINDSET THEN
                        REPEAT
                          TempServiceItem2 := TempServiceItem1;
                          IF TempServiceItem2.INSERT THEN;
                        UNTIL TempServiceItem1.NEXT = 0;
                      IF TempServiceItemComp1.FINDSET THEN
                        REPEAT
                          TempServiceItemComp2 := TempServiceItemComp1;
                          IF TempServiceItemComp2.INSERT THEN;
                        UNTIL TempServiceItemComp1.NEXT = 0;
                    END;

                    //DP00121
                    IF TempSalesLine."Qty. to Ship" <> 0 THEN
                      PostNSItemTracking(SalesShptLine);
                    //
                  END;

                  IF (ReturnRcptHeader."No." <> '') AND (SalesLine."Return Receipt No." = '') AND
                     NOT RoundingLineInserted
                  THEN BEGIN
                    // Insert return receipt line
                    ReturnRcptLine.InitFromSalesLine(ReturnRcptHeader,TempSalesLine);
                    IF (SalesLine.Type = SalesLine.Type::Item) AND (TempSalesLine."Return Qty. to Receive" <> 0) THEN BEGIN
                      IF WhseReceive THEN BEGIN
                        WhseRcptLine.GetWhseRcptLine(
                          WhseRcptLine,WhseRcptHeader."No.",DATABASE::"Sales Line",
                          SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                        WhseRcptLine.TESTFIELD("Qty. to Receive",ReturnRcptLine.Quantity);
                        SaveTempWhseSplitSpec(SalesLine);
                        WhsePostRcpt.CreatePostedRcptLine(
                          WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
                      END;
                      IF WhseShip THEN BEGIN
                        WhseShptLine.GetWhseShptLine(
                          WhseShptLine,WhseShptHeader."No.",DATABASE::"Sales Line",
                          SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
                        WhseShptLine.TESTFIELD("Qty. to Ship",-ReturnRcptLine.Quantity);
                        SaveTempWhseSplitSpec(SalesLine);
                        WhsePostShpt.SetWhseJnlRegisterCU(WhseJnlPostLine);
                        WhsePostShpt.CreatePostedShptLine(
                          WhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
                      END;

                      ReturnRcptLine."Item Rcpt. Entry No." :=
                        InsertReturnEntryRelation(ReturnRcptLine); // ItemLedgShptEntryNo;
                      ReturnRcptLine."Item Charge Base Amount" :=
                        ROUND(CostBaseAmount / SalesLine.Quantity * ReturnRcptLine.Quantity);
                    END;
                    ReturnRcptLine.INSERT;
                  END;

                  //**4PS.sn
                  IF gInvoiceOrderNotPostedInvoice THEN
                    DelayInsertNotPostedSaleInvLin;
                  //**4PS.en

                  IF Invoice THEN
                  BEGIN //**4PS.n
                    // Insert invoice line or credit memo line
                    IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
                      SalesInvLine.InitFromSalesLine(SalesInvHeader,TempSalesLine);
                      SalesInvLine.INSERT;
                      ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,SalesInvLine.RowID1);
                      InsertNSItemTrackingRelation(TempSalesLine,SalesInvLine.RowID1); //**4PS.n DP00121
                      CreatePostedDeferralScheduleFromSalesDoc(TempSalesLine,SalesInvLine.GetDocumentType,
                        SalesInvHeader."No.",SalesInvLine."Line No.",SalesInvHeader."Posting Date");
                    END ELSE BEGIN // Credit Memo
                      SalesCrMemoLine.InitFromSalesLine(SalesCrMemoHeader,TempSalesLine);
                      SalesCrMemoLine.INSERT;
                      ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,SalesCrMemoLine.RowID1);
                      InsertNSItemTrackingRelation(TempSalesLine,SalesCrMemoLine.RowID1); //**4PS.n DP00121
                      CreatePostedDeferralScheduleFromSalesDoc(TempSalesLine,SalesCrMemoLine.GetDocumentType,
                        SalesCrMemoHeader."No.",SalesCrMemoLine."Line No.",SalesCrMemoHeader."Posting Date");
                    END;
                  //**4PS.sn
                    SetLedgerEntryProcessed(TempSalesLine);  //**4PS03.n
                  END;
                  //**4PS.en

                  IF RoundingLineInserted THEN
                    LastLineRetrieved := TRUE
                  ELSE BEGIN
                    BiggestLineNo := MAX(BiggestLineNo,SalesLine."Line No.");
                    LastLineRetrieved := GetNextSalesline(SalesLine);
                    IF LastLineRetrieved AND SalesSetup."Invoice Rounding" THEN
                      InvoiceRounding(FALSE,BiggestLineNo);
                  END;
                UNTIL LastLineRetrieved;

              IF NOT ("Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]) THEN BEGIN
                ReverseAmount(TotalSalesLine);
                ReverseAmount(TotalSalesLineLCY);
                TotalSalesLineLCY."Unit Cost (LCY)" := -TotalSalesLineLCY."Unit Cost (LCY)";
              END;

              // Post drop shipment of purchase order
              PurchSetup.GET;
              IF DropShipPostBuffer.FIND('-') THEN
                REPEAT
                  PurchOrderHeader.GET(
                    PurchOrderHeader."Document Type"::Order,
                    DropShipPostBuffer."Order No.");
                  PurchPost.ArchiveUnpostedOrder(PurchOrderHeader);
                  PurchRcptHeader.INIT;
                  PurchRcptHeader.TRANSFERFIELDS(PurchOrderHeader);
                  PurchRcptHeader."No." := PurchOrderHeader."Receiving No.";
                  PurchRcptHeader."Order No." := PurchOrderHeader."No.";
                  PurchRcptHeader."Posting Date" := "Posting Date";
                  PurchRcptHeader."Document Date" := "Document Date";
                  PurchRcptHeader."No. Printed" := 0;
                  PurchRcptHeader.INSERT;

                  ApprovalsMgmt.PostApprovalEntries(RECORDID,PurchRcptHeader.RECORDID,PurchRcptHeader."No.");

                  IF PurchSetup."Copy Comments Order to Receipt" THEN BEGIN
                    CopyPurchCommentLines(
                      PurchOrderHeader."Document Type",PurchCommentLine."Document Type"::Receipt,
                      PurchOrderHeader."No.",PurchRcptHeader."No.");
                    RecordLinkManagement.CopyLinks(Rec,PurchRcptHeader);
                  END;
                  DropShipPostBuffer.SETRANGE("Order No.",DropShipPostBuffer."Order No.");
                  REPEAT
                    PurchOrderLine.GET(
                      PurchOrderLine."Document Type"::Order,
                      DropShipPostBuffer."Order No.",DropShipPostBuffer."Order Line No.");
                    PurchRcptLine.INIT;
                    PurchRcptLine.TRANSFERFIELDS(PurchOrderLine);
                    PurchRcptLine."Posting Date" := PurchRcptHeader."Posting Date";
                    PurchRcptLine."Document No." := PurchRcptHeader."No.";
                    PurchRcptLine.Quantity := DropShipPostBuffer.Quantity;
                    PurchRcptLine."Quantity (Base)" := DropShipPostBuffer."Quantity (Base)";
                    PurchRcptLine."Quantity Invoiced" := 0;
                    PurchRcptLine."Qty. Invoiced (Base)" := 0;
                    PurchRcptLine."Order No." := PurchOrderLine."Document No.";
                    PurchRcptLine."Order Line No." := PurchOrderLine."Line No.";
                    PurchRcptLine."Qty. Rcd. Not Invoiced" :=
                      PurchRcptLine.Quantity - PurchRcptLine."Quantity Invoiced";

                    IF PurchRcptLine.Quantity <> 0 THEN BEGIN
                      PurchRcptLine."Item Rcpt. Entry No." := DropShipPostBuffer."Item Shpt. Entry No.";
                      PurchRcptLine."Item Charge Base Amount" := PurchOrderLine."Line Amount"
                    END;
                    PurchRcptLine.INSERT;
                    PurchOrderLine.CreatePurchOrderControl(FALSE); //**4PS.n
                    PurchOrderLine."Qty. to Receive" := DropShipPostBuffer.Quantity;
                    PurchOrderLine."Qty. to Receive (Base)" := DropShipPostBuffer."Quantity (Base)";
                    PurchPost.UpdateBlanketOrderLine(PurchOrderLine,TRUE,FALSE,FALSE);
                  UNTIL DropShipPostBuffer.NEXT = 0;
                  DropShipPostBuffer.SETRANGE("Order No.");
                UNTIL DropShipPostBuffer.NEXT = 0;

              IF Invoice THEN BEGIN
                // Post sales and VAT to G/L entries from posting buffer
                LineCount := 0;
                IF InvPostingBuffer[1].FIND('+') THEN
                  REPEAT
                    LineCount := LineCount + 1;
                    Window.UPDATE(3,LineCount);

                    GenJnlLine.INIT;
                    GenJnlLine."Posting Date" := "Posting Date";
                    GenJnlLine."Document Date" := "Document Date";
                    //GenJnlLine.Description := "Posting Description";          //**4PS.o
                    GenJnlLine.Description := InvPostingBuffer[1].Description;  //**4PS.n
                    GenJnlLine."Description 2" := InvPostingBuffer[1]."Description 2";  //**4PS01.n
                    GenJnlLine."Reason Code" := "Reason Code";
                    GenJnlLine."Document Type" := GenJnlLineDocType;
                    GenJnlLine."Document No." := GenJnlLineDocNo;
                    GenJnlLine."External Document No." := GenJnlLineExtDocNo;
                    GenJnlLine."Account No." := InvPostingBuffer[1]."G/L Account";
                    GenJnlLine."System-Created Entry" := InvPostingBuffer[1]."System-Created Entry";
                    GenJnlLine.Amount := InvPostingBuffer[1].Amount;
                    GenJnlLine."Source Currency Code" := "Currency Code";
                    GenJnlLine."Source Currency Amount" := InvPostingBuffer[1]."Amount (ACY)";
                    GenJnlLine.Correction := Correction;
                    IF InvPostingBuffer[1].Type <> InvPostingBuffer[1].Type::"Prepmt. Exch. Rate Difference" THEN
                      GenJnlLine."Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Sale;
                    GenJnlLine."Gen. Bus. Posting Group" := InvPostingBuffer[1]."Gen. Bus. Posting Group";
                    GenJnlLine."Gen. Prod. Posting Group" := InvPostingBuffer[1]."Gen. Prod. Posting Group";
                    GenJnlLine."VAT Bus. Posting Group" := InvPostingBuffer[1]."VAT Bus. Posting Group";
                    GenJnlLine."VAT Prod. Posting Group" := InvPostingBuffer[1]."VAT Prod. Posting Group";
                    GenJnlLine."Tax Area Code" := InvPostingBuffer[1]."Tax Area Code";
                    GenJnlLine."Tax Liable" := InvPostingBuffer[1]."Tax Liable";
                    GenJnlLine."Tax Group Code" := InvPostingBuffer[1]."Tax Group Code";
                    GenJnlLine."Use Tax" := InvPostingBuffer[1]."Use Tax";
                    GenJnlLine.Quantity := InvPostingBuffer[1].Quantity;
                    GenJnlLine."VAT Calculation Type" := InvPostingBuffer[1]."VAT Calculation Type";
                    GenJnlLine."VAT Base Amount" := InvPostingBuffer[1]."VAT Base Amount";
                    GenJnlLine."VAT Base Discount %" := "VAT Base Discount %";
                    GenJnlLine."Source Curr. VAT Base Amount" := InvPostingBuffer[1]."VAT Base Amount (ACY)";
                    GenJnlLine."VAT Amount" := InvPostingBuffer[1]."VAT Amount";
                    GenJnlLine."Source Curr. VAT Amount" := InvPostingBuffer[1]."VAT Amount (ACY)";
                    GenJnlLine."VAT Difference" := InvPostingBuffer[1]."VAT Difference";
                    GenJnlLine."VAT Posting" := GenJnlLine."VAT Posting"::"Manual VAT Entry";
                    GenJnlLine."Job No." := InvPostingBuffer[1]."Job No.";
                    GenJnlLine."Shortcut Dimension 1 Code" := InvPostingBuffer[1]."Global Dimension 1 Code";
                    GenJnlLine."Shortcut Dimension 2 Code" := InvPostingBuffer[1]."Global Dimension 2 Code";
                    GenJnlLine."Dimension Set ID" := InvPostingBuffer[1]."Dimension Set ID";
                    GenJnlLine."Source Code" := SrcCode;
                    GenJnlLine."EU 3-Party Trade" := "EU 3-Party Trade";
                    GenJnlLine."Sell-to/Buy-from No." := "Sell-to Customer No.";
                    GenJnlLine."Bill-to/Pay-to No." := "Bill-to Customer No.";
                    GenJnlLine."Country/Region Code" := "VAT Country/Region Code";
                    GenJnlLine."VAT Registration No." := "VAT Registration No.";
                    GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
                    GenJnlLine."Source No." := "Bill-to Customer No.";
                    GenJnlLine."Posting No. Series" := "Posting No. Series";
                    GenJnlLine."Ship-to/Order Address Code" := "Ship-to Code";
                    IF InvPostingBuffer[1].Type = InvPostingBuffer[1].Type::"Fixed Asset" THEN BEGIN
                      GenJnlLine."Account Type" := GenJnlLine."Account Type"::"Fixed Asset";
                      GenJnlLine."FA Posting Type" := GenJnlLine."FA Posting Type"::Disposal;
                      GenJnlLine."FA Posting Date" := InvPostingBuffer[1]."FA Posting Date";
                      GenJnlLine."Depreciation Book Code" := InvPostingBuffer[1]."Depreciation Book Code";
                      GenJnlLine."Depr. until FA Posting Date" := InvPostingBuffer[1]."Depr. until FA Posting Date";
                      GenJnlLine."Duplicate in Depreciation Book" := InvPostingBuffer[1]."Duplicate in Depreciation Book";
                      GenJnlLine."Use Duplication List" := InvPostingBuffer[1]."Use Duplication List";
                    END;
                    GenJnlLine."Deferral Code" := InvPostingBuffer[1]."Deferral Code";
                    GenJnlLine."Deferral Line No." := InvPostingBuffer[1]."Deferral Line No.";
                    GenJnlLine."IC Partner Code" := "Sell-to IC Partner Code";

                    //**4PS.sn
                    GenJnlLine."Cost Component" := InvPostingBuffer[1]."Cost Component"; // jth 9-11-06
                    GenJnlLine.Element := InvPostingBuffer[1].Element;
                    //*29-11-2011 Sales Line fields can/may not be used, not in Repeat-Until loop of SalesLine here
                    GenJnlLine."Extension Contract" := InvPostingBuffer[1]."Extension Contract";  //*29-11-2011.n
                    GenJnlLine."Plant Invoice" := InvPostingBuffer[1]."Plant Invoice";  //*29-11-2011.n
                    GenJnlLine."Rental Unit" := InvPostingBuffer[1]."Rental Unit";  //*29-11-2011.n
                    GenJnlLine."Rental Unit Line Type" := InvPostingBuffer[1]."Rental Unit Line Type"; //*C017909
                    GenJnlLine."Service Order No." := InvPostingBuffer[1]."Service Order No.";
                    GenJnlLine."Service Contract No." := InvPostingBuffer[1]."Service Contract No.";
                    GenJnlLine."Service Location No." := InvPostingBuffer[1]."Service Location No.";  //*29-11-2011.n
                    GenJnlLine."Origin Type" := InvPostingBuffer[1]."Origin Type";
                    GenJnlLine."Interest Date" := "Interest Date";
                    GenJnlLine."Alternative Bill-to Address" := "Alternative Bill-to Address";
                    GenJnlLine."Cost Type Cost Plus Line" := InvPostingBuffer[1]."Cost Type Cost Plus Line";  //*29-11-2011.n
                    IF InvPostingBuffer[1]."Buy-Back Item (Plant Order)" THEN
                      CheckBuyBackGenPostTypPurchase(GenJnlLine);
                    GenJnlLine."Credit Restriction" := "Credit Restriction";
                    GenJnlLine.VALIDATE("Credit Restriction %", "Credit Restriction %");
                    GenJnlLine."Credit Restriction Date" := "Credit Restriction Date";
                    CrRestrictionAmt += -GenJnlLine."Credit Restriction Amount";
                    CrRestrictionVATAmt += -GenJnlLine."Credit Restriction VAT Amount";
                    //**4PS.en

                    GLEntryNo := RunGenJnlPostLine(GenJnlLine);
                    GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
                    GenJnlLine.VALIDATE("FA Posting Type",GenJnlLine."FA Posting Type"::" ");
                    IF (InvPostingBuffer[1]."Job No." <> '') AND (InvPostingBuffer[1].Type = InvPostingBuffer[1].Type::"G/L Account") THEN
                      JobPostLine.SetGLEntryNoOnJobLedgerEntry(InvPostingBuffer[1],"Posting Date",GenJnlLineDocNo,GLEntryNo);

                  UNTIL InvPostingBuffer[1].NEXT(-1) = 0;

                InvPostingBuffer[1].DELETEALL;

                //**4PS.sn
                IF (ChargePlantToOwnProj OR ChargeJobOrderToOwnPlant OR ChargePlantToOwnServOrder OR ChargeSOToJobPlantLoc OR
                    InternalChargePlantOnLoc('') OR  //DP00815
                    ChargeSOToPlantItem ) AND
                   (NOT ChargeSOToCustomerPlantLoc)  //DP00195
                THEN BEGIN
                  IF ChargePlantToOwnProj THEN BEGIN
                    TempJobJnlLine.RESET;
                    IF TempJobJnlLine.FIND('-') THEN
                      REPEAT
                        JobJnlPostLine.RUN(TempJobJnlLine);
                        TempJobJnlLine.DELETE;
                      UNTIL TempJobJnlLine.NEXT = 0;
                  END;
                END ELSE BEGIN
                //**4PS.en
                // Post customer entry
                  Window.UPDATE(4,1);

                  //**4PS.sn C016276
                  IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
                    CalcBAmount(SalesInvHeader);
                    SalesInvHeader.MODIFY;
                  END ELSE BEGIN
                    CalcBAmountCrMemo(SalesCrMemoHeader);
                    SalesCrMemoHeader.MODIFY;
                  END;
                  //**4PS.en

                  PostCustomerEntry(
                    SalesHeader,TotalSalesLine,TotalSalesLineLCY,
                    GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,
                    CrRestrictionAmt,CrRestrictionVATAmt); //**4PS.n C016276

                  IF NOT PlantTransportInternalCust THEN  //**4PS.n  C021883
                    UpdateSalesHeader(CustLedgEntry);
                  // Balancing account
                  IF "Bal. Account No." <> '' THEN BEGIN
                    Window.UPDATE(5,1);
                    IF NOT IsOnlinePayment(SalesHeader) THEN
                      PostBalanceEntry(
                        0,SalesHeader,TotalSalesLine,TotalSalesLineLCY,
                        GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode);
                  END;
                END;  //**4PS.n
              END;

              //**4PS.sn
              PostingMgt.PostSurchargesFromSalesLine(FALSE,SrcCode,GenJnlLineDocType,GenJnlLineDocNo,SalesLine,SalesHeader,GenJnlPostLine,SurchargePostingBuffer);

              PostPlantRateComponentBuffer();

              IF RequisitionPostingBuffer[1].FIND('-') THEN
                REPEAT
                  GenJnlLine1.INIT;
                  GenJnlLine1."Source Code" := SrcCode;
                  GenJnlLine1."Reason Code":= "Reason Code";
                  GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
                  GenJnlLine1."Account No." := RequisitionPostingBuffer[1]."G/L Account";
                  GenJnlLine1."Posting Date" := "Posting Date";
                  GenJnlLine1."Document Type" := GenJnlLineDocType;
                  GenJnlLine1."Document No." := GenJnlLineDocNo;
                  GenJnlLine1."System-Created Entry" := TRUE;
                  GenJnlLine1."Document Date" := "Document Date";
                  GenJnlLine1.Description := RequisitionPostingBuffer[1].Description;
                  GenJnlLine1."Description 2" := RequisitionPostingBuffer[1]."Description 2";  //**4PS01.n
                  GenJnlLine1."Bal. Account No." := RequisitionPostingBuffer[1]."Bal. Account No.";
                  GenJnlLine1.Amount := RequisitionPostingBuffer[1].Amount;
                  GenJnlLine1.VALIDATE(Amount);
                  GenJnlLine1."Shortcut Dimension 1 Code" := RequisitionPostingBuffer[1]."Global Dimension 1 Code";
                  GenJnlLine1."Shortcut Dimension 2 Code" := RequisitionPostingBuffer[1]."Global Dimension 2 Code";
                  GenJnlLine1."Dimension Set ID" := RequisitionPostingBuffer[1]."Dimension Set ID";
                  GenJnlLine1."Job No." := RequisitionPostingBuffer[1]."Job No.";
                  GenJnlLine1."Service Order No." := RequisitionPostingBuffer[1]."Service Order No.";
                  GenJnlLine1."Service Contract No." := RequisitionPostingBuffer[1]."Service Contract No.";
                  GenJnlLine1."Origin Type" := RequisitionPostingBuffer[1]."Origin Type";
                  RunGenJnlPostLine(GenJnlLine1);
                UNTIL RequisitionPostingBuffer[1].NEXT = 0;
              RequisitionPostingBuffer[1].DELETEALL;

              PostingMgt.PostSurchargesFromSalesLine(TRUE,SrcCode,GenJnlLineDocType,GenJnlLineDocNo,SalesLine,SalesHeader,GenJnlPostLine,ComplWIPPostingBuffer);
              //**4PS.en

              IF ICGenJnlLineNo > 0 THEN
                PostICGenJnl;

              IF PreviewMode THEN BEGIN
                Window.CLOSE;
                GenJnlPostPreview.Finish;
                ERROR(GenJnlPostPreview.GetPreviewModeErrMessage);
              END;

              MakeInventoryAdjustment;

              IF Ship THEN BEGIN
                "Last Shipping No." := "Shipping No.";
                "Shipping No." := '';
              END;
              IF Invoice THEN BEGIN
                "Last Posting No." := "Posting No.";
                "Posting No." := '';
              END;
              IF Receive THEN BEGIN
                "Last Return Receipt No." := "Return Receipt No.";
                "Return Receipt No." := '';
              END;

              IF ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"]) AND
                 //(NOT EverythingInvoiced)  //**4PS.o
                 ((NOT EverythingInvoiced) OR (EverythingInvoiced AND StandardSalesOrder(SalesHeader) ))  //**4PS.n
              THEN BEGIN
                //**4PS.sn
                IF EverythingInvoiced AND StandardSalesOrder(SalesHeader) THEN
                  Status := Status::Closed;
                //**4PS.en
                MODIFY;
                // Insert T336 records
                InsertTrackingSpecification;

                IF SalesLine.FINDSET THEN
                  REPEAT
                    IF SalesLine.Quantity <> 0 THEN BEGIN
                      IF Ship THEN BEGIN
                        SalesLine."Quantity Shipped" :=
                          SalesLine."Quantity Shipped" +
                          SalesLine."Qty. to Ship";
                        SalesLine."Qty. Shipped (Base)" :=
                          SalesLine."Qty. Shipped (Base)" +
                          SalesLine."Qty. to Ship (Base)";
                      END;
                      IF Receive THEN BEGIN
                        SalesLine."Return Qty. Received" :=
                          SalesLine."Return Qty. Received" + SalesLine."Return Qty. to Receive";
                        SalesLine."Return Qty. Received (Base)" :=
                          SalesLine."Return Qty. Received (Base)" +
                          SalesLine."Return Qty. to Receive (Base)";
                      END;
                      IF Invoice THEN BEGIN
                        IF "Document Type" = "Document Type"::Order THEN BEGIN
                          IF ABS(SalesLine."Quantity Invoiced" + SalesLine."Qty. to Invoice") >
                             ABS(SalesLine."Quantity Shipped")
                          THEN BEGIN
                            SalesLine.VALIDATE("Qty. to Invoice",
                              SalesLine."Quantity Shipped" - SalesLine."Quantity Invoiced");
                            SalesLine."Qty. to Invoice (Base)" :=
                              SalesLine."Qty. Shipped (Base)" - SalesLine."Qty. Invoiced (Base)";
                          END;
                        END ELSE
                          IF ABS(SalesLine."Quantity Invoiced" + SalesLine."Qty. to Invoice") >
                             ABS(SalesLine."Return Qty. Received")
                          THEN BEGIN
                            SalesLine.VALIDATE("Qty. to Invoice",
                              SalesLine."Return Qty. Received" - SalesLine."Quantity Invoiced");
                            SalesLine."Qty. to Invoice (Base)" :=
                              SalesLine."Return Qty. Received (Base)" - SalesLine."Qty. Invoiced (Base)";
                          END;

                        SalesLine."Quantity Invoiced" := SalesLine."Quantity Invoiced" + SalesLine."Qty. to Invoice";
                        SalesLine."Qty. Invoiced (Base)" := SalesLine."Qty. Invoiced (Base)" + SalesLine."Qty. to Invoice (Base)";
                        IF SalesLine."Qty. to Invoice" <> 0 THEN BEGIN
                          SalesLine."Prepmt Amt Deducted" :=
                            SalesLine."Prepmt Amt Deducted" + SalesLine."Prepmt Amt to Deduct";
                          SalesLine."Prepmt VAT Diff. Deducted" :=
                            SalesLine."Prepmt VAT Diff. Deducted" + SalesLine."Prepmt VAT Diff. to Deduct";
                          DecrementPrepmtAmtInvLCY(
                            SalesLine,SalesLine."Prepmt. Amount Inv. (LCY)",SalesLine."Prepmt. VAT Amount Inv. (LCY)");
                          SalesLine."Prepmt Amt to Deduct" :=
                            SalesLine."Prepmt. Amt. Inv." - SalesLine."Prepmt Amt Deducted";
                          SalesLine."Prepmt VAT Diff. to Deduct" := 0;
                        END;
                      END;

                      UpdateBlanketOrderLine(SalesLine,Ship,Receive,Invoice);
                      SalesLine.InitOutstanding;
                      CheckATOLink(SalesLine);
                      IF WhseHandlingRequired OR (SalesSetup."Default Quantity to Ship" = SalesSetup."Default Quantity to Ship"::Blank)
                      THEN BEGIN
                        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
                          SalesLine."Return Qty. to Receive" := 0;
                          SalesLine."Return Qty. to Receive (Base)" := 0;
                        END ELSE BEGIN
                          SalesLine."Qty. to Ship" := 0;
                          SalesLine."Qty. to Ship (Base)" := 0;
                        END;
                        SalesLine.InitQtyToInvoice;
                      END ELSE BEGIN
                        IF "Document Type" = "Document Type"::"Return Order" THEN
                          SalesLine.InitQtyToReceive
                        ELSE
                          SalesLine.InitQtyToShip2;
                      END;

                      IF (SalesLine."Purch. Order Line No." <> 0) AND
                         (SalesLine.Quantity = SalesLine."Quantity Invoiced")
                      THEN
                        UpdateAssocLines(SalesLine);
                      SalesLine.SetDefaultQuantity;
                      SalesLine.MODIFY;
                    END;
                  UNTIL SalesLine.NEXT = 0;

                UpdateAssocOrder;

                IF WhseReceive THEN BEGIN
                  WhsePostRcpt.PostUpdateWhseDocuments(WhseRcptHeader);
                  TempWhseRcptHeader.DELETE;
                END;
                IF WhseShip THEN BEGIN
                  WhsePostShpt.PostUpdateWhseDocuments(WhseShptHeader);
                  TempWhseShptHeader.DELETE;
                END;

                WhseSalesRelease.Release(SalesHeader);
                UpdateItemChargeAssgnt;
              END ELSE BEGIN
                CASE "Document Type" OF
                  "Document Type"::Invoice:
                    BEGIN
                      SalesLine.SETFILTER("Shipment No.",'<>%1','');
                      IF SalesLine.FINDSET THEN
                        REPEAT
                          IF SalesLine.Type <> SalesLine.Type::" " THEN BEGIN
                            SalesShptLine.GET(SalesLine."Shipment No.",SalesLine."Shipment Line No.");
                            TempSalesLine.GET(
                              TempSalesLine."Document Type"::Order,
                              SalesShptLine."Order No.",SalesShptLine."Order Line No.");
                            IF SalesLine.Type = SalesLine.Type::"Charge (Item)" THEN
                              UpdateSalesOrderChargeAssgnt(SalesLine,TempSalesLine);
                            TempSalesLine."Quantity Invoiced" :=
                              TempSalesLine."Quantity Invoiced" + SalesLine."Qty. to Invoice";
                            TempSalesLine."Qty. Invoiced (Base)" :=
                              TempSalesLine."Qty. Invoiced (Base)" + SalesLine."Qty. to Invoice (Base)";
                            IF ABS(TempSalesLine."Quantity Invoiced") > ABS(TempSalesLine."Quantity Shipped") THEN
                              ERROR(
                                Text014,
                                TempSalesLine."Document No.");
                            TempSalesLine.InitQtyToInvoice;
                            IF TempSalesLine."Prepayment %" <> 0 THEN BEGIN
                              TempSalesLine."Prepmt Amt Deducted" := TempSalesLine."Prepmt Amt Deducted" + SalesLine."Prepmt Amt to Deduct";
                              TempSalesLine."Prepmt VAT Diff. Deducted" :=
                                TempSalesLine."Prepmt VAT Diff. Deducted" + SalesLine."Prepmt VAT Diff. to Deduct";
                              DecrementPrepmtAmtInvLCY(
                                SalesLine,TempSalesLine."Prepmt. Amount Inv. (LCY)",TempSalesLine."Prepmt. VAT Amount Inv. (LCY)");
                              TempSalesLine."Prepmt Amt to Deduct" :=
                                TempSalesLine."Prepmt. Amt. Inv." - TempSalesLine."Prepmt Amt Deducted";
                              TempSalesLine."Prepmt VAT Diff. to Deduct" := 0;
                            END;
                            TempSalesLine.InitOutstanding;
                            IF (TempSalesLine."Purch. Order Line No." <> 0) AND
                               (TempSalesLine.Quantity = TempSalesLine."Quantity Invoiced")
                            THEN
                              UpdateAssocLines(TempSalesLine);
                            TempSalesLine.MODIFY;
                            CloseStandardSalesOrder(TempSalesLine);  //**4PS.n
                          END;
                        UNTIL SalesLine.NEXT = 0;
                      InsertTrackingSpecification;

                      SalesLine.SETRANGE("Shipment No.");
                    END;
                  "Document Type"::"Credit Memo":
                    BEGIN
                      SalesLine.SETFILTER("Return Receipt No.",'<>%1','');
                      IF SalesLine.FINDSET THEN
                        REPEAT
                          IF SalesLine.Type <> SalesLine.Type::" " THEN BEGIN
                            ReturnRcptLine.GET(SalesLine."Return Receipt No.",SalesLine."Return Receipt Line No.");
                            TempSalesLine.GET(
                              TempSalesLine."Document Type"::"Return Order",
                              ReturnRcptLine."Return Order No.",ReturnRcptLine."Return Order Line No.");
                            IF SalesLine.Type = SalesLine.Type::"Charge (Item)" THEN
                              UpdateSalesOrderChargeAssgnt(SalesLine,TempSalesLine);
                            TempSalesLine."Quantity Invoiced" :=
                              TempSalesLine."Quantity Invoiced" + SalesLine."Qty. to Invoice";
                            TempSalesLine."Qty. Invoiced (Base)" :=
                              TempSalesLine."Qty. Invoiced (Base)" + SalesLine."Qty. to Invoice (Base)";
                            IF ABS(TempSalesLine."Quantity Invoiced") > ABS(TempSalesLine."Return Qty. Received") THEN
                              ERROR(
                                Text036,
                                TempSalesLine."Document No.");
                            TempSalesLine.InitQtyToInvoice;
                            TempSalesLine.InitOutstanding;
                            TempSalesLine.MODIFY;
                            CloseStandardSalesOrder(TempSalesLine);  //**4PS.n
                          END;
                        UNTIL SalesLine.NEXT = 0;
                      InsertTrackingSpecification;

                      SalesLine.SETRANGE("Return Receipt No.");
                    END;
                  ELSE BEGIN
                    UpdateAssocOrder;
                    IF DropShipOrder THEN
                      InsertTrackingSpecification;
                    IF SalesLine.FINDSET THEN
                      REPEAT
                        IF SalesLine."Purch. Order Line No." <> 0 THEN
                          UpdateAssocLines(SalesLine);
                        IF SalesLine."Prepayment %" <> 0 THEN
                          DecrementPrepmtAmtInvLCY(
                            SalesLine,SalesLine."Prepmt. Amount Inv. (LCY)",SalesLine."Prepmt. VAT Amount Inv. (LCY)");
                      UNTIL SalesLine.NEXT = 0;
                  END;
                END;

                SalesLine.SETFILTER("Qty. to Assemble to Order",'<>0');
                IF SalesLine.FINDSET THEN
                  REPEAT
                    FinalizePostATO(SalesLine);
                  UNTIL SalesLine.NEXT = 0;
                SalesLine.SETRANGE("Qty. to Assemble to Order");

                SalesLine.SETFILTER("Blanket Order Line No.",'<>0');
                IF SalesLine.FINDSET THEN
                  REPEAT
                    UpdateBlanketOrderLine(SalesLine,Ship,Receive,Invoice);
                  UNTIL SalesLine.NEXT = 0;
                SalesLine.SETRANGE("Blanket Order Line No.");

                IF WhseReceive THEN BEGIN
                  WhsePostRcpt.PostUpdateWhseDocuments(WhseRcptHeader);
                  TempWhseRcptHeader.DELETE;
                END;
                IF WhseShip THEN BEGIN
                  WhsePostShpt.PostUpdateWhseDocuments(WhseShptHeader);
                  TempWhseShptHeader.DELETE;
                END;

                //**4PS.sn
                IF ("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) AND
                   ("Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated")
                THEN
                  IF SalesOfferAmount.GET("Document Type", "No.", 0) THEN
                    SalesOfferAmount.DELETE;
                //**4PS.en

                ApprovalsMgmt.DeleteApprovalEntry(DATABASE::"Sales Header","Document Type","No.");

                IF HASLINKS THEN
                  DELETELINKS;
                DELETE;

                //**4PS.sn
                SalesHeaderExtension.RESET;
                SalesHeaderExtension.SETRANGE("Document Type", "Document Type");
                SalesHeaderExtension.SETRANGE("Document No.", "No.");
                SalesHeaderExtension.DELETEALL;
                //**4PS.en

                ReserveSalesLine.DeleteInvoiceSpecFromHeader(SalesHeader);
                DeleteATOLinks(SalesHeader);
                IF SalesLine.FINDFIRST THEN
                  REPEAT
                    IF SalesLine."Deferral Code" <> '' THEN
                      DeferralUtilities.RemoveOrSetDeferralSchedule(
                        '',DeferralUtilities.GetSalesDeferralDocType,'','',
                        SalesLine."Document Type",
                        SalesLine."Document No.",
                        SalesLine."Line No.",0,0D,
                        SalesLine.Description,
                        '',
                        TRUE);
                    IF SalesLine.HASLINKS THEN
                      SalesLine.DELETELINKS;
                  UNTIL SalesLine.NEXT = 0;
                SalesLine.DELETEALL;
                DeleteItemChargeAssgnt;
                SalesCommentLine.SETRANGE("Document Type","Document Type");
                SalesCommentLine.SETRANGE("No.","No.");
                IF NOT SalesCommentLine.ISEMPTY THEN
                  SalesCommentLine.DELETEALL;
                DeleteWhseRqst(SalesHeader);
              END;

              IF gInvoiceOrderNotPostedInvoice THEN ProcInsertNotPostSalesInvLines;  //**4PS.n (24767)

              InsertValueEntryRelation;
              IF NOT InvtPickPutaway THEN
                COMMIT;
              ClearPostBuffers;
              Window.CLOSE;
              IF Invoice AND ("Bill-to IC Partner Code" <> '') THEN
                IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN
                  ICInOutBoxMgt.CreateOutboxSalesInvTrans(SalesInvHeader)
                ELSE
                  ICInOutBoxMgt.CreateOutboxSalesCrMemoTrans(SalesCrMemoHeader);
            END;

            //mg.sn, 12-07-11: M27801
            IF ReplaceDocLink THEN BEGIN
              SourceLink.GETTABLE(SalesHeader);
              IF "Document Type" IN ["Document Type"::Order, "Document Type"::Invoice] THEN
                TargetLink.GETTABLE(SalesInvHeader)
              ELSE
                TargetLink.GETTABLE(SalesCrMemoHeader);
              DocumentLinkManagement.ReplaceDocLink(SourceLink,TargetLink);
              DocumentLinkManagement.ReplaceDocRelation(SourceLink, TargetLink); //mvos
            END;
            //mg.en, 12-07-11: M27801

            TransactionLogEntryNo := CaptureOrRefundCreditCardPmnt(CustLedgEntry);

            Rec := SalesHeader;
            SynchBOMSerialNo(TempServiceItem2,TempServiceItemComp2);
            IF NOT InvtPickPutaway THEN BEGIN
              COMMIT;
              UpdateAnalysisView.UpdateAll(0,TRUE);
              UpdateItemAnalysisView.UpdateAll(0,TRUE);
            END;

            // Balancing account - online payment
            IF ("Bal. Account No." <> '') AND IsOnlinePayment(SalesHeader) AND Invoice THEN
              PostBalanceEntry(
                TransactionLogEntryNo,SalesHeader,TotalSalesLine,TotalSalesLineLCY,
                GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode);

            CRMIntegrationManagement.AddPostedSalesDocumentToCRMAccountWall(SalesHeader);
            CRMIntegrationManagement.SetCRMSalesOrderStatusToInvoiced(SalesHeader);

            OnAfterPostSalesDoc(Rec,GenJnlPostLine,SalesShptHeader."No.",ReturnRcptHeader."No.",SalesInvHeader."No.",
              SalesCrMemoHeader."No.");
          END;

  }
  CODE
  {
    VAR
      Text001@1000 : TextConst 'ENU=There is nothing to post.';
      Text002@1001 : TextConst 'ENU=Posting lines              #2######\';
      Text003@1002 : TextConst 'ENU=Posting sales and VAT      #3######\';
      Text004@1003 : TextConst 'ENU=Posting to customers       #4######\';
      Text005@1004 : TextConst 'ENU=Posting to bal. account    #5######';
      Text006@1005 : TextConst 'ENU=Posting lines              #2######';
      Text007@1006 : TextConst 'ENU=%1 %2 -> Invoice %3';
      Text008@1007 : TextConst 'ENU=%1 %2 -> Credit Memo %3';
      Text009@1008 : TextConst 'ENU="You cannot ship sales order line %1. "';
      Text010@1009 : TextConst 'ENU=The line is marked as a drop shipment and is not yet associated with a purchase order.';
      Text011@1010 : TextConst 'ENU=must have the same sign as the shipment';
      Text013@1011 : TextConst 'ENU=The shipment lines have been deleted.';
      Text014@1012 : TextConst 'ENU=You cannot invoice more than you have shipped for order %1.';
      Text016@1013 : TextConst 'ENU=VAT Amount';
      Text017@1014 : TextConst 'ENU=%1% VAT';
      Text018@1015 : TextConst 'ENU=in the associated blanket order must not be greater than %1';
      Text019@1016 : TextConst 'ENU=in the associated blanket order must not be reduced.';
      Text020@1017 : TextConst 'ENU=Please enter "Yes" in %1 and/or %2 and/or %3.';
      Text021@1018 : TextConst 'ENU="Warehouse handling is required for %1 = %2, %3 = %4, %5 = %6."';
      Text024@1021 : TextConst 'ENU=must have the same sign as the return receipt';
      Text025@1022 : TextConst 'ENU=Line %1 of the return receipt %2, which you are attempting to invoice, has already been invoiced.';
      Text026@1023 : TextConst 'ENU=Line %1 of the shipment %2, which you are attempting to invoice, has already been invoiced.';
      Text027@1024 : TextConst 'ENU=The quantity you are attempting to invoice is greater than the quantity in shipment %1.';
      Text028@1025 : TextConst 'ENU=The combination of dimensions used in %1 %2 is blocked. %3';
      Text029@1026 : TextConst 'ENU=The combination of dimensions used in %1 %2, line no. %3 is blocked. %4';
      Text030@1027 : TextConst 'ENU=The dimensions used in %1 %2 are invalid. %3';
      Text031@1028 : TextConst 'ENU=The dimensions used in %1 %2, line no. %3 are invalid. %4';
      Text032@1029 : TextConst 'ENU="You cannot assign more than %1 units in %2 = %3, %4 = %5,%6 = %7."';
      Text033@1030 : TextConst 'ENU=You must assign all item charges, if you invoice everything.';
      Item@1164 : Record 27;
      SalesSetup@1032 : Record 311;
      GLSetup@1033 : Record 98;
      GLEntry@1034 : Record 17;
      SalesHeader@1035 : Record 36;
      SalesLine@1036 : Record 37;
      TempSalesLine@1038 : Record 37;
      SalesLineACY@1039 : Record 37;
      TotalSalesLine@1040 : Record 37;
      TotalSalesLineLCY@1041 : Record 37;
      TempPrepaymentSalesLine@1170 : TEMPORARY Record 37;
      SalesShptHeader@1043 : Record 110;
      SalesInvHeader@1045 : Record 112;
      SalesCrMemoHeader@1047 : Record 114;
      ReturnRcptHeader@1049 : Record 6660;
      PurchOrderHeader@1051 : Record 38;
      PurchOrderLine@1052 : Record 39;
      PurchRcptHeader@1053 : Record 120;
      PurchRcptLine@1054 : Record 121;
      ItemChargeAssgntSales@1042 : Record 5809;
      TempItemChargeAssgntSales@1037 : TEMPORARY Record 5809;
      GenJnlLine@1056 : Record 81;
      ItemJnlLine@1057 : Record 83;
      DimValRec@11012017 : Record 349;
      ProjRec@11012018 : Record 11072003;
      SurchargeRec@11012019 : Record 11020208;
      ProjTypeRec@11012020 : Record 11012009;
      JobSetUp@11012021 : Record 315;
      GenJnlLine1@11012027 : Record 81;
      SurchargePostingBuffer@11012044 : ARRAY [2] OF TEMPORARY Record 49;
      PlantSetupRec@1100485030 : Record 11012550;
      PlantLedgerEntry@11012001 : Record 11012572;
      PlantLocRec@11012000 : Record 11012554;
      PlantInventoryRec@11012002 : Record 11012555;
      PlantOrderRec@11012004 : Record 11012556;
      ExitOrderRec@11012003 : Record 11012559;
      AdjRec@11012006 : Record 11012565;
      CompanyData@11012009 : Record 11020674;
      SalesLine2@11012007 : Record 37;
      SalesHeader2@11012005 : Record 36;
      PlantHourLineRec@1210190002 : Record 11012574;
      TempJobJnlLine@11012008 : TEMPORARY Record 11072008;
      SourceCodeSetup@1061 : Record 242;
      SourceCode@1062 : Record 230;
      Currency@1068 : Record 4;
      InvPostingBuffer@1069 : ARRAY [2] OF TEMPORARY Record 49;
      DropShipPostBuffer@1070 : TEMPORARY Record 223;
      WhseRcptHeader@1019 : Record 7316;
      TempWhseRcptHeader@1145 : TEMPORARY Record 7316;
      WhseShptHeader@1148 : Record 7320;
      TempWhseShptHeader@1149 : TEMPORARY Record 7320;
      PostedWhseRcptHeader@1142 : Record 7318;
      PostedWhseRcptLine@1146 : Record 7319;
      PostedWhseShptHeader@1150 : Record 7322;
      PostedWhseShptLine@1151 : Record 7323;
      Location@1080 : Record 14;
      TempHandlingSpecification@1088 : TEMPORARY Record 336;
      TempTrackingSpecification@1139 : TEMPORARY Record 336;
      TempTrackingSpecificationInv@1160 : TEMPORARY Record 336;
      TempWhseSplitSpecification@1190 : TEMPORARY Record 336;
      TempValueEntryRelation@1140 : TEMPORARY Record 6508;
      ComplWIPPostingBuffer@1100485006 : ARRAY [2] OF TEMPORARY Record 49;
      JobTaskSalesLine@1167 : Record 37;
      TempICGenJnlLine@2165 : TEMPORARY Record 81;
      TempPrepmtDeductLCYSalesLine@1134 : TEMPORARY Record 37;
      TempSKU@1175 : TEMPORARY Record 5700;
      TotalDeferralHeader@1063 : Record 1701;
      DeferralPostBuffer@1046 : ARRAY [2] OF Record 1703;
      TempDeferralHeader@1209 : TEMPORARY Record 1701;
      TempDeferralLine@1235 : TEMPORARY Record 1702;
      GenJnlPostLine@1082 : Codeunit 12;
      ResJnlPostLine@1083 : Codeunit 212;
      ItemJnlPostLine@1085 : Codeunit 22;
      ReserveSalesLine@1086 : Codeunit 99000832;
      ApprovalsMgmt@1165 : Codeunit 1535;
      WhseSalesRelease@1093 : Codeunit 5771;
      ItemTrackingMgt@1196 : Codeunit 6500;
      WMSMgmt@1144 : Codeunit 7302;
      WhseJnlPostLine@1141 : Codeunit 7301;
      WhsePostRcpt@1152 : Codeunit 5760;
      WhsePostShpt@1153 : Codeunit 5763;
      PurchPost@1159 : Codeunit 90;
      CostCalcMgt@1163 : Codeunit 5836;
      JobPostLine@1166 : Codeunit 11072006;
      ServItemMgt@1055 : Codeunit 5920;
      AsmPost@1067 : Codeunit 900;
      GenJnlPostPreview@1044 : Codeunit 19;
      DeferralUtilities@1048 : Codeunit 1720;
      Window@1097 : Dialog;
      PostingDate@1098 : Date;
      UseDate@1099 : Date;
      GenJnlLineDocNo@1101 : Code[20];
      GenJnlLineExtDocNo@1102 : Code[35];
      SrcCode@1103 : Code[10];
      GenJnlLineDocType@1104 : Integer;
      ItemLedgShptEntryNo@1106 : Integer;
      FALineNo@1108 : Integer;
      RoundingLineNo@1109 : Integer;
      DeferralLineNo@1050 : Integer;
      InvDefLineNo@1058 : Integer;
      RemQtyToBeInvoiced@1111 : Decimal;
      RemQtyToBeInvoicedBase@1112 : Decimal;
      QtyToBeInvoiced@1113 : Decimal;
      QtyToBeInvoicedBase@1114 : Decimal;
      RemAmt@1136 : Decimal;
      RemDiscAmt@1137 : Decimal;
      LastLineRetrieved@1116 : Boolean;
      RoundingLineInserted@1117 : Boolean;
      DropShipOrder@1119 : Boolean;
      PostingDateExists@1120 : Boolean;
      ReplacePostingDate@1121 : Boolean;
      ReplaceDocumentDate@1122 : Boolean;
      Text034@1127 : TextConst 'ENU="You cannot assign item charges to the %1 %2 = %3,%4 = %5, %6 = %7, because it has been invoiced."';
      Text036@1094 : TextConst 'ENU=You cannot invoice more than you have received for return order %1.';
      Text037@1095 : TextConst 'ENU=The return receipt lines have been deleted.';
      Text038@1130 : TextConst 'ENU=The quantity you are attempting to invoice is greater than the quantity in return receipt %1.';
      ItemChargeAssgntOnly@1138 : Boolean;
      ItemJnlRollRndg@1135 : Boolean;
      Text040@1129 : TextConst 'ENU=Related item ledger entries cannot be found.';
      Text043@1147 : TextConst 'ENU=Item Tracking is signed wrongly.';
      Text044@1143 : TextConst 'ENU=Item Tracking does not match.';
      WhseShip@1110 : Boolean;
      WhseReceive@1154 : Boolean;
      InvtPickPutaway@1155 : Boolean;
      Text045@1157 : TextConst 'ENU=is not within your range of allowed posting dates.';
      Text046@1066 : TextConst 'ENU=The %1 does not match the quantity defined in item tracking for item %2.';
      Text047@1084 : TextConst 'ENU=cannot be more than %1.';
      Text048@1105 : TextConst 'ENU=must be at least %1.';
      JobContractLine@1172 : Boolean;
      GLSetupRead@1133 : Boolean;
      ItemTrkgAlreadyOverruled@1059 : Boolean;
      Text050@1076 : TextConst 'ENU=The total %1 cannot be more than %2.';
      Text051@1091 : TextConst 'ENU=The total %1 must be at least %2.';
      Text052@1102601000 : TextConst 'ENU=You must assign item charge %1 if you want to invoice it.';
      Text053@1102601001 : TextConst 'ENU=You can not invoice item charge %1 because there is no item ledger entry to assign it to.';
      SalesLinesProcessed@1072 : Boolean;
      Text055@1073 : TextConst 'ENU=#1#################################\\Checking Assembly #2###########';
      Text056@1090 : TextConst 'ENU=#1#################################\\Posting Assembly #2###########';
      Text057@1168 : TextConst 'ENU=#1#################################\\Finalizing Assembly #2###########';
      Text059@1173 : TextConst '@@@="%1 = SalesLine.""Document Type"". %2 = SalesLine.""Document No."". %3 = SalesLine.FIELDCAPTION(""Line No.""). %4 = SalesLine.""Line No."". This is used in a progress window.";ENU=%1 %2 %3 %4';
      Text060@1174 : TextConst '@@@="%1 = ""Document Type"". %2 = AsmHeader.""No."". Used in a progress window.";ENU=%1 %2';
      Text061Err@1171 : TextConst 'ENU=The order line that the item charge was originally assigned to has been fully posted. You must reassign the item charge to the posted receipt or shipment.';
      Text062Qst@1132 : TextConst '@@@="One or more reservation entries exist for the item with No. = 1000, Location Code = SILVER, Variant Code = NEW which may be disrupted if you post this negative adjustment. Do you want to continue?";ENU="One or more reservation entries exist for the item with %1 = %2, %3 = %4, %5 = %6 which may be disrupted if you post this negative adjustment. Do you want to continue?"';
      NotSupportedDocumentTypeErr@1020 : TextConst 'ENU=Document type %1 is not supported.';
      PreviewMode@1031 : Boolean;
      NoDeferralScheduleErr@1064 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=You must create a deferral schedule because you have specified the deferral code %2 in line %1.';
      ZeroDeferralAmtErr@1060 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=Deferral amounts cannot be 0. Line: %1, Deferral Template: %2.';
      FakeDocNoTxt@1071 : TextConst 'ENU=***';
      CannotPostDiscountDeferralErr@1074 : TextConst '@@@=@1 - Line No., %2 - Line/Inv. Discount Amount field name.;ENU=You cannot post line %1 because it contains a deferral code and a %2.';
      Text11012001@1210190000 : TextConst 'ENU=Plant %1 %2';
      IcRelRec@1210190003 : Record 11012057;
      IcEntryRec@1210190004 : Record 11012058;
      DimVal@1210190008 : Record 349;
      SurchDimValRec@1210190019 : Record 349;
      GLSetupRec@1210190007 : Record 98;
      JobJnlLine@1100525007 : Record 11072008;
      JobJnlLine2@1210190020 : Record 11072008;
      ServOrderRec@1210190018 : Record 11012823;
      ServContrRec@1210190021 : Record 11012812;
      ServTypeRec@1100525009 : Record 11012814;
      ServJnlLine@1210190016 : Record 11012820;
      ServJnlLine2@1210190017 : Record 11012820;
      TmpGenJnlRateCompBufferRec@1100485001 : TEMPORARY Record 81;
      RequisitionPostingBuffer@1100485003 : ARRAY [2] OF TEMPORARY Record 49;
      SaveOrgSalesLineRec@1100525003 : Record 37;
      SalesHeadInvFromOrderRec@1100525001 : Record 36;
      TmpSalesOrderLineForInv@1100525010 : TEMPORARY Record 37;
      DimMgt@1100525011 : Codeunit 408;
      PostingMgt@1100409000 : Codeunit 11012360;
      JobJnlPostLine@1100525006 : Codeunit 11072003;
      ServJnlPostLine@1210190015 : Codeunit 11012802;
      PostPlantEntry@11012087 : Codeunit 11012569;
      PostPlantRateCompEntry@1100485000 : Codeunit 11020500;
      NSItemTrackingEntriesApply@1100528601 : Codeunit 11012352;
      CreditMemoBln@1210190006 : Boolean;
      gInvoiceOrderNotPostedInvoice@1100525000 : Boolean;
      gCreateNotPostedCredMemo@1100525004 : Boolean;
      SetRentalUnitInvoice@1210190012 : Boolean;
      PlantTransportInternalCust@1100525008 : Boolean;
      NextLineNoGLRateCompBuf@1100485002 : Integer;
      RentalUnitProjectNo@1210190013 : Code[20];
      NoSeriesCde@1210190005 : Code[10];
      Text11012002@1100525002 : TextConst 'ENU=not (completely) found in table ''%1'' (%2 of %3)';
      Text11012003@1100525005 : TextConst 'ENU=Create invoice not possible, of order line %1-%2 still %3 present on not posted %4 %5-%6.';
      Text11012004@1210190001 : TextConst 'ENU=BOM Item %1 has to be exploded';
      JobLedgEntryNo@1100528506 : Integer;
      ServLedgEntryNo@1100528507 : Integer;

    PROCEDURE SetPostingDate@1(NewReplacePostingDate@1000 : Boolean;NewReplaceDocumentDate@1001 : Boolean;NewPostingDate@1002 : Date);
    BEGIN
      PostingDateExists := TRUE;
      ReplacePostingDate := NewReplacePostingDate;
      ReplaceDocumentDate := NewReplaceDocumentDate;
      PostingDate := NewPostingDate;
    END;

    LOCAL PROCEDURE PostItemJnlLine@2(SalesLine@1000 : Record 37;QtyToBeShipped@1001 : Decimal;QtyToBeShippedBase@1002 : Decimal;QtyToBeInvoiced@1003 : Decimal;QtyToBeInvoicedBase@1004 : Decimal;ItemLedgShptEntryNo@1005 : Integer;ItemChargeNo@1006 : Code[20];TrackingSpecification@1009 : Record 336;IsATO@1007 : Boolean) : Integer;
    VAR
      ItemChargeSalesLine@1008 : Record 37;
      TempWhseJnlLine@1012 : TEMPORARY Record 7311;
      TempWhseJnlLine2@1010 : TEMPORARY Record 7311;
      OriginalItemJnlLine@1013 : Record 83;
      TempWhseTrackingSpecification@1016 : TEMPORARY Record 336;
      CurrExchRate@1015 : Record 330;
      PostWhseJnlLine@1011 : Boolean;
      CheckApplFromItemEntry@1014 : Boolean;
    BEGIN
      IF NOT ItemJnlRollRndg THEN BEGIN
        RemAmt := 0;
        RemDiscAmt := 0;
      END;
      WITH SalesLine DO BEGIN
        ItemJnlLine.INIT;
        ItemJnlLine."Posting Date" := SalesHeader."Posting Date";
        ItemJnlLine."Document Date" := SalesHeader."Document Date";
        ItemJnlLine."Source Posting Group" := SalesHeader."Customer Posting Group";
        ItemJnlLine."Salespers./Purch. Code" := SalesHeader."Salesperson Code";
        ItemJnlLine."Country/Region Code" := GetCountryCode(SalesLine,SalesHeader);
        ItemJnlLine."Reason Code" := SalesHeader."Reason Code";
        ItemJnlLine."Item No." := "No.";
        ItemJnlLine.Description := Description;
        ItemJnlLine."Description 2" := "Description 2";  //**4PS01.n
        ItemJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        ItemJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        ItemJnlLine."Dimension Set ID" := "Dimension Set ID";
        ItemJnlLine."Cost Component" := "Cost Component";  //**4PS.n
        ItemJnlLine."Location Code" := "Location Code";
        ItemJnlLine."Bin Code" := "Bin Code";
        ItemJnlLine."Variant Code" := "Variant Code";
        ItemJnlLine."Inventory Posting Group" := "Posting Group";
        ItemJnlLine."Gen. Bus. Posting Group" := "Gen. Bus. Posting Group";
        ItemJnlLine."Gen. Prod. Posting Group" := "Gen. Prod. Posting Group";
        IF IsATO THEN
          ItemJnlLine."Applies-to Entry" := FindOpenATOEntry('','')
        ELSE
          ItemJnlLine."Applies-to Entry" := "Appl.-to Item Entry";
        ItemJnlLine."Transaction Type" := "Transaction Type";
        ItemJnlLine."Transport Method" := "Transport Method";
        ItemJnlLine."Entry/Exit Point" := "Exit Point";
        ItemJnlLine.Area := Area;
        ItemJnlLine."Transaction Specification" := "Transaction Specification";
        ItemJnlLine."Drop Shipment" := "Drop Shipment";
        ItemJnlLine."Assemble to Order" := IsATO;
        ItemJnlLine."Entry Type" := ItemJnlLine."Entry Type"::Sale;
        ItemJnlLine."Unit of Measure Code" := "Unit of Measure Code";
        ItemJnlLine."Qty. per Unit of Measure" := "Qty. per Unit of Measure";
        ItemJnlLine."Derived from Blanket Order" := "Blanket Order No." <> '';
        ItemJnlLine."Cross-Reference No." := "Cross-Reference No.";
        ItemJnlLine."Originally Ordered No." := "Originally Ordered No.";
        ItemJnlLine."Originally Ordered Var. Code" := "Originally Ordered Var. Code";
        ItemJnlLine."Out-of-Stock Substitution" := "Out-of-Stock Substitution";
        ItemJnlLine."Item Category Code" := "Item Category Code";
        ItemJnlLine.Nonstock := Nonstock;
        ItemJnlLine."Purchasing Code" := "Purchasing Code";
        ItemJnlLine."Product Group Code" := "Product Group Code";
        ItemJnlLine."Return Reason Code" := "Return Reason Code";

        ItemJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin"; //hs, 30-10-2007

        ItemJnlLine."Planned Delivery Date" := "Planned Delivery Date";
        ItemJnlLine."Order Date" := SalesHeader."Order Date";

        ItemJnlLine."Serial No." := TrackingSpecification."Serial No.";
        ItemJnlLine."Lot No." := TrackingSpecification."Lot No.";

        IF QtyToBeShipped = 0 THEN BEGIN
          IF IsCreditDocType THEN
            ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Credit Memo"
          ELSE
            ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Invoice";
          ItemJnlLine."Document No." := GenJnlLineDocNo;
          ItemJnlLine."External Document No." := GenJnlLineExtDocNo;
          ItemJnlLine."Posting No. Series" := SalesHeader."Posting No. Series";
          IF QtyToBeInvoiced <> 0 THEN
            ItemJnlLine."Invoice No." := GenJnlLineDocNo;
        END ELSE BEGIN
          IF IsCreditDocType THEN BEGIN
            ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Return Receipt";
            ItemJnlLine."Document No." := ReturnRcptHeader."No.";
            ItemJnlLine."External Document No." := ReturnRcptHeader."External Document No.";
            ItemJnlLine."Posting No. Series" := ReturnRcptHeader."No. Series";
          END ELSE BEGIN
            ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Shipment";
            ItemJnlLine."Document No." := SalesShptHeader."No.";
            ItemJnlLine."External Document No." := SalesShptHeader."External Document No.";
            ItemJnlLine."Posting No. Series" := SalesShptHeader."No. Series";
          END;
          IF QtyToBeInvoiced <> 0 THEN BEGIN
            ItemJnlLine."Invoice No." := GenJnlLineDocNo;
            ItemJnlLine."External Document No." := GenJnlLineExtDocNo;
            IF ItemJnlLine."Document No." = '' THEN BEGIN
              IF "Document Type" = "Document Type"::"Credit Memo" THEN
                ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Credit Memo"
              ELSE
                ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Sales Invoice";
              ItemJnlLine."Document No." := GenJnlLineDocNo;
            END;
            ItemJnlLine."Posting No. Series" := SalesHeader."Posting No. Series";
          END;
        END;

        ItemJnlLine."Document Line No." := "Line No.";
        ItemJnlLine.Quantity := -QtyToBeShipped;
        ItemJnlLine."Quantity (Base)" := -QtyToBeShippedBase;
        ItemJnlLine."Invoiced Quantity" := -QtyToBeInvoiced;
        ItemJnlLine."Invoiced Qty. (Base)" := -QtyToBeInvoicedBase;
        ItemJnlLine."Unit Cost" := "Unit Cost (LCY)";
        ItemJnlLine."Source Currency Code" := SalesHeader."Currency Code";
        ItemJnlLine."Unit Cost (ACY)" := "Unit Cost";
        ItemJnlLine."Value Entry Type" := ItemJnlLine."Value Entry Type"::"Direct Cost";

        IF ItemChargeNo <> '' THEN BEGIN
          ItemJnlLine."Item Charge No." := ItemChargeNo;
          "Qty. to Invoice" := QtyToBeInvoiced;
        END ELSE
          ItemJnlLine."Applies-from Entry" := "Appl.-from Item Entry";

        IF QtyToBeInvoiced <> 0 THEN BEGIN
          ItemJnlLine.Amount := -(Amount * (QtyToBeInvoiced / "Qty. to Invoice") - RemAmt);
          IF SalesHeader."Prices Including VAT" THEN
            ItemJnlLine."Discount Amount" :=
              -(("Line Discount Amount" + "Inv. Discount Amount") / (1 + "VAT %" / 100) *
                (QtyToBeInvoiced / "Qty. to Invoice") - RemDiscAmt)
          ELSE
            ItemJnlLine."Discount Amount" :=
              -(("Line Discount Amount" + "Inv. Discount Amount") * (QtyToBeInvoiced / "Qty. to Invoice") - RemDiscAmt);
          RemAmt := ItemJnlLine.Amount - ROUND(ItemJnlLine.Amount);
          RemDiscAmt := ItemJnlLine."Discount Amount" - ROUND(ItemJnlLine."Discount Amount");
          ItemJnlLine.Amount := ROUND(ItemJnlLine.Amount);
          ItemJnlLine."Discount Amount" := ROUND(ItemJnlLine."Discount Amount");
        END ELSE BEGIN
          IF SalesHeader."Prices Including VAT" THEN
            ItemJnlLine.Amount :=
              -((QtyToBeShipped * "Unit Price" * (1 - "Line Discount %" / 100) / (1 + "VAT %" / 100)) - RemAmt)
          ELSE
            ItemJnlLine.Amount :=
              -((QtyToBeShipped * "Unit Price" * (1 - "Line Discount %" / 100)) - RemAmt);
          RemAmt := ItemJnlLine.Amount - ROUND(ItemJnlLine.Amount);
          IF SalesHeader."Currency Code" <> '' THEN
            ItemJnlLine.Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  0, '', //**4PS.n
                  SalesHeader."Posting Date",SalesHeader."Currency Code",
      //          ItemJnlLine.Amount,SalesHeader."Currency Factor")) //**4PS.o
                  ItemJnlLine.Amount,SalesHeader."Currency Factor",TRUE)) //**4PS.n
          ELSE
            ItemJnlLine.Amount := ROUND(ItemJnlLine.Amount);
        END;

        ItemJnlLine."Source Type" := ItemJnlLine."Source Type"::Customer;
        ItemJnlLine."Source No." := "Sell-to Customer No.";
        ItemJnlLine."Invoice-to Source No." := "Bill-to Customer No.";
        ItemJnlLine."Source Code" := SrcCode;
        ItemJnlLine."Item Shpt. Entry No." := ItemLedgShptEntryNo;

        IF NOT JobContractLine THEN BEGIN
          IF SalesSetup."Exact Cost Reversing Mandatory" AND (Type = Type::Item) THEN
            IF IsCreditDocType THEN
              CheckApplFromItemEntry := Quantity > 0
            ELSE
              CheckApplFromItemEntry := Quantity < 0;

          IF ("Location Code" <> '') AND (Type = Type::Item) AND (ItemJnlLine.Quantity <> 0) THEN
            IF ShouldPostWhseJnlLine(SalesLine) THEN BEGIN
              CreateWhseJnlLine(ItemJnlLine,SalesLine,TempWhseJnlLine);
              PostWhseJnlLine := TRUE;
            END;

          IF QtyToBeShippedBase <> 0 THEN BEGIN
            IF IsCreditDocType THEN
              ReserveSalesLine.TransferSalesLineToItemJnlLine(SalesLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
            ELSE
              TransferReservToItemJnlLine(
                SalesLine,ItemJnlLine,-QtyToBeShippedBase,TempTrackingSpecification,CheckApplFromItemEntry);

            IF CheckApplFromItemEntry AND (NOT IsServiceItem) THEN
              TESTFIELD("Appl.-from Item Entry");
          END;

          OriginalItemJnlLine := ItemJnlLine;
          ItemJnlPostLine.RunWithCheck(ItemJnlLine);
          IF ItemJnlPostLine.CollectTrackingSpecification(TempHandlingSpecification) THEN
            IF TempHandlingSpecification.FINDSET THEN
              REPEAT
                TempTrackingSpecification := TempHandlingSpecification;
                TempTrackingSpecification."Source Type" := DATABASE::"Sales Line";
                TempTrackingSpecification."Source Subtype" := "Document Type";
                TempTrackingSpecification."Source ID" := "Document No.";
                TempTrackingSpecification."Source Batch Name" := '';
                TempTrackingSpecification."Source Prod. Order Line" := 0;
                TempTrackingSpecification."Source Ref. No." := "Line No.";
                IF TempTrackingSpecification.INSERT THEN;
                IF QtyToBeInvoiced <> 0 THEN BEGIN
                  TempTrackingSpecificationInv := TempTrackingSpecification;
                  IF TempTrackingSpecificationInv.INSERT THEN;
                END;
                IF PostWhseJnlLine THEN BEGIN
                  TempWhseTrackingSpecification := TempTrackingSpecification;
                  IF TempWhseTrackingSpecification.INSERT THEN;
                END;
              UNTIL TempHandlingSpecification.NEXT = 0;
          IF PostWhseJnlLine THEN BEGIN
            ItemTrackingMgt.SplitWhseJnlLine(TempWhseJnlLine,TempWhseJnlLine2,TempWhseTrackingSpecification,FALSE);
            IF TempWhseJnlLine2.FINDSET THEN
              REPEAT
                WhseJnlPostLine.RUN(TempWhseJnlLine2);
              UNTIL TempWhseJnlLine2.NEXT = 0;
            TempWhseTrackingSpecification.DELETEALL;
          END;

          IF (Type = Type::Item) AND SalesHeader.Invoice THEN BEGIN
            ClearItemChargeAssgntFilter;
            TempItemChargeAssgntSales.SETCURRENTKEY(
              "Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
            TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type","Document Type");
            TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.","Document No.");
            TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.","Line No.");
            IF TempItemChargeAssgntSales.FINDSET THEN
              REPEAT
                TESTFIELD("Allow Item Charge Assignment");
                GetItemChargeLine(ItemChargeSalesLine);
                ItemChargeSalesLine.CALCFIELDS("Qty. Assigned");
                IF (ItemChargeSalesLine."Qty. to Invoice" <> 0) OR
                   (ABS(ItemChargeSalesLine."Qty. Assigned") < ABS(ItemChargeSalesLine."Quantity Invoiced"))
                THEN BEGIN
                  OriginalItemJnlLine."Item Shpt. Entry No." := ItemJnlLine."Item Shpt. Entry No.";
                  PostItemChargePerOrder(OriginalItemJnlLine,ItemChargeSalesLine);
                  TempItemChargeAssgntSales.MARK(TRUE);
                END;
              UNTIL TempItemChargeAssgntSales.NEXT = 0;
          END;
        END;
      END;

      EXIT(ItemJnlLine."Item Shpt. Entry No.");
    END;

    LOCAL PROCEDURE ShouldPostWhseJnlLine@73(SalesLine@1000 : Record 37) : Boolean;
    BEGIN
      WITH SalesLine DO BEGIN
        GetLocation("Location Code");
        IF (("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) AND
            Location."Directed Put-away and Pick") OR
           (Location."Bin Mandatory" AND NOT (WhseShip OR WhseReceive OR InvtPickPutaway OR "Drop Shipment"))
        THEN
          EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE PostItemChargePerOrder@5801(ItemJnlLine2@1001 : Record 83;ItemChargeSalesLine@1002 : Record 37);
    VAR
      NonDistrItemJnlLine@1000 : Record 83;
      CurrExchRate@1003 : Record 330;
      QtyToInvoice@1004 : Decimal;
      Factor@1005 : Decimal;
      OriginalAmt@1007 : Decimal;
      OriginalDiscountAmt@1009 : Decimal;
      OriginalQty@1010 : Decimal;
      SignFactor@1006 : Integer;
      TotalChargeAmt2@1008 : Decimal;
      TotalChargeAmtLCY2@1011 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntSales DO BEGIN
        SalesLine.TESTFIELD("Job No.",'');
        SalesLine.TESTFIELD("Allow Item Charge Assignment",TRUE);
        ItemJnlLine2."Document No." := GenJnlLineDocNo;
        ItemJnlLine2."External Document No." := GenJnlLineExtDocNo;
        ItemJnlLine2."Item Charge No." := "Item Charge No.";
        ItemJnlLine2.Description := ItemChargeSalesLine.Description;
        ItemJnlLine2."Description 2" := ItemChargeSalesLine."Description 2";  //**4PS01.n
        ItemJnlLine2."Unit of Measure Code" := '';
        ItemJnlLine2."Qty. per Unit of Measure" := 1;
        ItemJnlLine2."Applies-from Entry" := 0;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          QtyToInvoice :=
            CalcQtyToInvoice(SalesLine."Return Qty. to Receive (Base)",SalesLine."Qty. to Invoice (Base)")
        ELSE
          QtyToInvoice :=
            CalcQtyToInvoice(SalesLine."Qty. to Ship (Base)",SalesLine."Qty. to Invoice (Base)");
        IF ItemJnlLine2."Invoiced Quantity" = 0 THEN BEGIN
          ItemJnlLine2."Invoiced Quantity" := ItemJnlLine2.Quantity;
          ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
        END;
        ItemJnlLine2."Document Line No." := ItemChargeSalesLine."Line No.";

        ItemJnlLine2.Amount := "Amount to Assign" * ItemJnlLine2."Invoiced Qty. (Base)" / QtyToInvoice;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          ItemJnlLine2.Amount := -ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost (ACY)" :=
          ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
            Currency."Unit-Amount Rounding Precision");

        TotalChargeAmt2 := TotalChargeAmt2 + ItemJnlLine2.Amount;
        IF SalesHeader."Currency Code" <> '' THEN BEGIN
          ItemJnlLine2.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
              UseDate,SalesHeader."Currency Code",
      //      TotalChargeAmt2 + TotalSalesLine.Amount,SalesHeader."Currency Factor") - //**4PS.o
              TotalChargeAmt2 + TotalSalesLine.Amount,SalesHeader."Currency Factor",TRUE) - //**4PS.n
            TotalChargeAmtLCY2 - TotalSalesLineLCY.Amount;
        END ELSE
          ItemJnlLine2.Amount := TotalChargeAmt2 - TotalChargeAmtLCY2;

        ItemJnlLine2.Amount := ROUND(ItemJnlLine2.Amount);
        TotalChargeAmtLCY2 := TotalChargeAmtLCY2 + ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost" := ROUND(
            ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",GLSetup."Unit-Amount Rounding Precision");
        ItemJnlLine2."Applies-to Entry" := ItemJnlLine2."Item Shpt. Entry No.";

        IF SalesHeader."Currency Code" <> '' THEN
          ItemJnlLine2."Discount Amount" := ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                UseDate,SalesHeader."Currency Code", //**4PS.o
                ItemChargeSalesLine."Inv. Discount Amount" * ItemJnlLine2."Invoiced Qty. (Base)" /
                ItemChargeSalesLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              //SalesHeader."Currency Factor"),GLSetup."Amount Rounding Precision") //**4PS.o
                SalesHeader."Currency Factor",TRUE),GLSetup."Amount Rounding Precision") //**4PS.n
        ELSE
          ItemJnlLine2."Discount Amount" := ROUND(
              ItemChargeSalesLine."Inv. Discount Amount" * ItemJnlLine2."Invoiced Qty. (Base)" /
              ItemChargeSalesLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              GLSetup."Amount Rounding Precision");

        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          ItemJnlLine2."Discount Amount" := -ItemJnlLine2."Discount Amount";
        ItemJnlLine2."Shortcut Dimension 1 Code" := ItemChargeSalesLine."Shortcut Dimension 1 Code";
        ItemJnlLine2."Shortcut Dimension 2 Code" := ItemChargeSalesLine."Shortcut Dimension 2 Code";
        ItemJnlLine2."Dimension Set ID" := ItemChargeSalesLine."Dimension Set ID";
        ItemJnlLine2."Cost Component" := ItemChargeSalesLine."Cost Component";  //**4PS.n
        ItemJnlLine2."Gen. Prod. Posting Group" := ItemChargeSalesLine."Gen. Prod. Posting Group";
      END;

      WITH TempTrackingSpecificationInv DO BEGIN
        RESET;
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source ID",TempItemChargeAssgntSales."Applies-to Doc. No.");
        SETRANGE("Source Ref. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.");
        IF ISEMPTY THEN
          ItemJnlPostLine.RunWithCheck(ItemJnlLine2)
        ELSE BEGIN
          FINDSET;
          NonDistrItemJnlLine := ItemJnlLine2;
          OriginalAmt := NonDistrItemJnlLine.Amount;
          OriginalDiscountAmt := NonDistrItemJnlLine."Discount Amount";
          OriginalQty := NonDistrItemJnlLine."Quantity (Base)";
          IF ("Quantity (Base)" / OriginalQty) > 0 THEN
            SignFactor := 1
          ELSE
            SignFactor := -1;
          REPEAT
            Factor := "Quantity (Base)" / OriginalQty * SignFactor;
            IF ABS("Quantity (Base)") < ABS(NonDistrItemJnlLine."Quantity (Base)") THEN BEGIN
              ItemJnlLine2."Quantity (Base)" := -"Quantity (Base)";
              ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
              ItemJnlLine2.Amount :=
                ROUND(OriginalAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Unit Cost" :=
                ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision") * SignFactor;
              ItemJnlLine2."Discount Amount" :=
                ROUND(OriginalDiscountAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Item Shpt. Entry No." := "Item Ledger Entry No.";
              ItemJnlLine2."Applies-to Entry" := "Item Ledger Entry No.";
              ItemJnlLine2."Lot No." := "Lot No.";
              ItemJnlLine2."Serial No." := "Serial No.";
              ItemJnlPostLine.RunWithCheck(ItemJnlLine2);
              ItemJnlLine2."Location Code" := NonDistrItemJnlLine."Location Code";
              NonDistrItemJnlLine."Quantity (Base)" -= ItemJnlLine2."Quantity (Base)";
              NonDistrItemJnlLine.Amount -= ItemJnlLine2.Amount;
              NonDistrItemJnlLine."Discount Amount" -= ItemJnlLine2."Discount Amount";
            END ELSE BEGIN // the last time
              NonDistrItemJnlLine."Quantity (Base)" := -"Quantity (Base)";
              NonDistrItemJnlLine."Invoiced Qty. (Base)" := -"Quantity (Base)";
              NonDistrItemJnlLine."Unit Cost" :=
                ROUND(NonDistrItemJnlLine.Amount / NonDistrItemJnlLine."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision");
              NonDistrItemJnlLine."Item Shpt. Entry No." := "Item Ledger Entry No.";
              NonDistrItemJnlLine."Applies-to Entry" := "Item Ledger Entry No.";
              NonDistrItemJnlLine."Lot No." := "Lot No.";
              NonDistrItemJnlLine."Serial No." := "Serial No.";
              ItemJnlPostLine.RunWithCheck(NonDistrItemJnlLine);
              NonDistrItemJnlLine."Location Code" := ItemJnlLine2."Location Code";
            END;
          UNTIL NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemChargePerShpt@5807(VAR SalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1003 : Record 111;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      Factor@1008 : Decimal;
      NonDistrQuantity@1007 : Decimal;
      NonDistrQtyToAssign@1006 : Decimal;
      NonDistrAmountToAssign@1005 : Decimal;
      QtyToAssign@1004 : Decimal;
      AmountToAssign@1002 : Decimal;
      DistributeCharge@1011 : Boolean;
    BEGIN
      IF NOT SalesShptLine.GET(
           TempItemChargeAssgntSales."Applies-to Doc. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.")
      THEN
        ERROR(Text013);
      SalesShptLine.TESTFIELD("Job No.",'');

      IF SalesShptLine."Item Shpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,-SalesShptLine."Quantity (Base)",SalesShptLine."Item Shpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        IF NOT ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
             DATABASE::"Sales Shipment Line",0,SalesShptLine."Document No.",
             '',0,SalesShptLine."Line No.",-SalesShptLine."Quantity (Base)")
        THEN
          ERROR(Text040);
      END;

      IF DistributeCharge THEN BEGIN
        TempItemLedgEntry.FINDSET;
        NonDistrQuantity := SalesShptLine."Quantity (Base)";
        NonDistrQtyToAssign := TempItemChargeAssgntSales."Qty. to Assign";
        NonDistrAmountToAssign := TempItemChargeAssgntSales."Amount to Assign";
        REPEAT
          Factor := ABS(TempItemLedgEntry.Quantity) / NonDistrQuantity;
          QtyToAssign := NonDistrQtyToAssign * Factor;
          AmountToAssign := ROUND(NonDistrAmountToAssign * Factor,GLSetup."Amount Rounding Precision");
          IF Factor < 1 THEN BEGIN
            PostItemCharge(SalesLine,
              TempItemLedgEntry."Entry No.",ABS(TempItemLedgEntry.Quantity),
              AmountToAssign,QtyToAssign);
            NonDistrQuantity := NonDistrQuantity - ABS(TempItemLedgEntry.Quantity);
            NonDistrQtyToAssign := NonDistrQtyToAssign - QtyToAssign;
            NonDistrAmountToAssign := NonDistrAmountToAssign - AmountToAssign;
          END ELSE // the last time
            PostItemCharge(SalesLine,
              TempItemLedgEntry."Entry No.",ABS(TempItemLedgEntry.Quantity),
              NonDistrAmountToAssign,NonDistrQtyToAssign);
        UNTIL TempItemLedgEntry.NEXT = 0;
      END ELSE
        PostItemCharge(SalesLine,
          SalesShptLine."Item Shpt. Entry No.",SalesShptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Amount to Assign",
          TempItemChargeAssgntSales."Qty. to Assign");
    END;

    LOCAL PROCEDURE PostItemChargePerRetRcpt@5810(VAR SalesLine@1000 : Record 37);
    VAR
      ReturnRcptLine@1002 : Record 6661;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      Factor@1008 : Decimal;
      NonDistrQuantity@1007 : Decimal;
      NonDistrQtyToAssign@1006 : Decimal;
      NonDistrAmountToAssign@1005 : Decimal;
      QtyToAssign@1004 : Decimal;
      AmountToAssign@1003 : Decimal;
      DistributeCharge@1011 : Boolean;
    BEGIN
      IF NOT ReturnRcptLine.GET(
           TempItemChargeAssgntSales."Applies-to Doc. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.")
      THEN
        ERROR(Text013);
      ReturnRcptLine.TESTFIELD("Job No.",'');

      IF ReturnRcptLine."Item Rcpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,ReturnRcptLine."Quantity (Base)",ReturnRcptLine."Item Rcpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        IF NOT ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
             DATABASE::"Return Receipt Line",0,ReturnRcptLine."Document No.",
             '',0,ReturnRcptLine."Line No.",ReturnRcptLine."Quantity (Base)")
        THEN
          ERROR(Text040);
      END;

      IF DistributeCharge THEN BEGIN
        TempItemLedgEntry.FINDSET;
        NonDistrQuantity := ReturnRcptLine."Quantity (Base)";
        NonDistrQtyToAssign := TempItemChargeAssgntSales."Qty. to Assign";
        NonDistrAmountToAssign := TempItemChargeAssgntSales."Amount to Assign";
        REPEAT
          Factor := ABS(TempItemLedgEntry.Quantity) / NonDistrQuantity;
          QtyToAssign := NonDistrQtyToAssign * Factor;
          AmountToAssign := ROUND(NonDistrAmountToAssign * Factor,GLSetup."Amount Rounding Precision");
          IF Factor < 1 THEN BEGIN
            PostItemCharge(SalesLine,
              TempItemLedgEntry."Entry No.",ABS(TempItemLedgEntry.Quantity),
              AmountToAssign,QtyToAssign);
            NonDistrQuantity := NonDistrQuantity - ABS(TempItemLedgEntry.Quantity);
            NonDistrQtyToAssign := NonDistrQtyToAssign - QtyToAssign;
            NonDistrAmountToAssign := NonDistrAmountToAssign - AmountToAssign;
          END ELSE // the last time
            PostItemCharge(SalesLine,
              TempItemLedgEntry."Entry No.",ABS(TempItemLedgEntry.Quantity),
              NonDistrAmountToAssign,NonDistrQtyToAssign);
        UNTIL TempItemLedgEntry.NEXT = 0;
      END ELSE
        PostItemCharge(SalesLine,
          ReturnRcptLine."Item Rcpt. Entry No.",ReturnRcptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Amount to Assign",
          TempItemChargeAssgntSales."Qty. to Assign")
    END;

    LOCAL PROCEDURE PostAssocItemJnlLine@3(QtyToBeShipped@1000 : Decimal;QtyToBeShippedBase@1001 : Decimal) : Integer;
    VAR
      TempHandlingSpecification2@1005 : TEMPORARY Record 336;
      ItemEntryRelation@1004 : Record 6507;
    BEGIN
      PurchOrderHeader.GET(
        PurchOrderHeader."Document Type"::Order,
        SalesLine."Purchase Order No.");
      PurchOrderLine.GET(
        PurchOrderLine."Document Type"::Order,
        SalesLine."Purchase Order No.",SalesLine."Purch. Order Line No.");

      ItemJnlLine.INIT;
      ItemJnlLine."Source Posting Group" := PurchOrderHeader."Vendor Posting Group";
      ItemJnlLine."Salespers./Purch. Code" := PurchOrderHeader."Purchaser Code";
      ItemJnlLine."Country/Region Code" := PurchOrderHeader."VAT Country/Region Code";
      ItemJnlLine."Reason Code" := PurchOrderHeader."Reason Code";
      ItemJnlLine."Posting No. Series" := PurchOrderHeader."Posting No. Series";
      ItemJnlLine."Item No." := PurchOrderLine."No.";
      ItemJnlLine.Description := PurchOrderLine.Description;
      ItemJnlLine."Description 2" := PurchOrderLine."Description 2";  //**4PS01.n
      ItemJnlLine."Shortcut Dimension 1 Code" := PurchOrderLine."Shortcut Dimension 1 Code";
      ItemJnlLine."Shortcut Dimension 2 Code" := PurchOrderLine."Shortcut Dimension 2 Code";
      ItemJnlLine."Dimension Set ID" := PurchOrderLine."Dimension Set ID";
      ItemJnlLine."Cost Component" := PurchOrderLine."Cost Component";  //**4PS.n
      ItemJnlLine."Location Code" := PurchOrderLine."Location Code";
      ItemJnlLine."Inventory Posting Group" := PurchOrderLine."Posting Group";
      ItemJnlLine."Gen. Bus. Posting Group" := PurchOrderLine."Gen. Bus. Posting Group";
      ItemJnlLine."Gen. Prod. Posting Group" := PurchOrderLine."Gen. Prod. Posting Group";
      ItemJnlLine."Applies-to Entry" := PurchOrderLine."Appl.-to Item Entry";
      ItemJnlLine."Transaction Type" := PurchOrderLine."Transaction Type";
      ItemJnlLine."Transport Method" := PurchOrderLine."Transport Method";
      ItemJnlLine."Entry/Exit Point" := PurchOrderLine."Entry Point";
      ItemJnlLine.Area := PurchOrderLine.Area;
      ItemJnlLine."Transaction Specification" := PurchOrderLine."Transaction Specification";
      ItemJnlLine."Drop Shipment" := PurchOrderLine."Drop Shipment";
      ItemJnlLine."Posting Date" := SalesHeader."Posting Date";
      ItemJnlLine."Document Date" := SalesHeader."Document Date";
      ItemJnlLine."Entry Type" := ItemJnlLine."Entry Type"::Purchase;
      ItemJnlLine."Document No." := PurchOrderHeader."Receiving No.";
      ItemJnlLine."External Document No." := PurchOrderHeader."No.";
      ItemJnlLine."Document Type" := ItemJnlLine."Document Type"::"Purchase Receipt";
      ItemJnlLine."Document Line No." := PurchOrderLine."Line No.";
      ItemJnlLine.Quantity := QtyToBeShipped;
      ItemJnlLine."Quantity (Base)" := QtyToBeShippedBase;
      ItemJnlLine."Invoiced Quantity" := 0;
      ItemJnlLine."Invoiced Qty. (Base)" := 0;
      ItemJnlLine."Unit Cost" := PurchOrderLine."Unit Cost (LCY)";
      ItemJnlLine."Source Currency Code" := SalesHeader."Currency Code";
      ItemJnlLine."Unit Cost (ACY)" := PurchOrderLine."Unit Cost";
      ItemJnlLine.Amount := ROUND(PurchOrderLine.Amount * QtyToBeShipped / PurchOrderLine.Quantity);
      ItemJnlLine."Discount Amount" := PurchOrderLine."Line Discount Amount";
      ItemJnlLine."Source Type" := ItemJnlLine."Source Type"::Vendor;
      ItemJnlLine."Source No." := PurchOrderLine."Buy-from Vendor No.";
      ItemJnlLine."Invoice-to Source No." := PurchOrderLine."Pay-to Vendor No.";
      ItemJnlLine."Source Code" := SrcCode;
      ItemJnlLine."Variant Code" := PurchOrderLine."Variant Code";
      ItemJnlLine."Item Category Code" := PurchOrderLine."Item Category Code";
      ItemJnlLine."Product Group Code" := PurchOrderLine."Product Group Code";
      ItemJnlLine."Bin Code" := PurchOrderLine."Bin Code";
      ItemJnlLine."Purchasing Code" := PurchOrderLine."Purchasing Code";
      IF PurchOrderLine."Prod. Order No." <> '' THEN BEGIN
        ItemJnlLine."Order Type" := ItemJnlLine."Order Type"::Production;
        ItemJnlLine."Order No." := PurchOrderLine."Prod. Order No.";
        ItemJnlLine."Order Line No." := PurchOrderLine."Prod. Order Line No.";
      END;
      ItemJnlLine."Unit of Measure Code" := PurchOrderLine."Unit of Measure Code";
      ItemJnlLine."Qty. per Unit of Measure" := PurchOrderLine."Qty. per Unit of Measure";
      ItemJnlLine."Applies-to Entry" := 0;

      IF PurchOrderLine."Job No." = '' THEN BEGIN
        TransferReservFromPurchLine(PurchOrderLine,ItemJnlLine,QtyToBeShippedBase);
        ItemJnlPostLine.RunWithCheck(ItemJnlLine);

        // Handle Item Tracking
        IF ItemJnlPostLine.CollectTrackingSpecification(TempHandlingSpecification2) THEN BEGIN
          IF TempHandlingSpecification2.FINDSET THEN
            REPEAT
              TempTrackingSpecification := TempHandlingSpecification2;
              TempTrackingSpecification."Source Type" := DATABASE::"Purchase Line";
              TempTrackingSpecification."Source Subtype" := PurchOrderLine."Document Type";
              TempTrackingSpecification."Source ID" := PurchOrderLine."Document No.";
              TempTrackingSpecification."Source Batch Name" := '';
              TempTrackingSpecification."Source Prod. Order Line" := 0;
              TempTrackingSpecification."Source Ref. No." := PurchOrderLine."Line No.";
              IF TempTrackingSpecification.INSERT THEN;
              ItemEntryRelation.INIT;
              ItemEntryRelation."Item Entry No." := TempHandlingSpecification2."Entry No.";
              ItemEntryRelation."Serial No." := TempHandlingSpecification2."Serial No.";
              ItemEntryRelation."Lot No." := TempHandlingSpecification2."Lot No.";
              ItemEntryRelation."Source Type" := DATABASE::"Purch. Rcpt. Line";
              ItemEntryRelation."Source ID" := PurchOrderHeader."Receiving No.";
              ItemEntryRelation."Source Ref. No." := PurchOrderLine."Line No.";
              ItemEntryRelation."Order No." := PurchOrderLine."Document No.";
              ItemEntryRelation."Order Line No." := PurchOrderLine."Line No.";
              ItemEntryRelation.INSERT;
            UNTIL TempHandlingSpecification2.NEXT = 0;
          EXIT(0);
        END;
      END;

      EXIT(ItemJnlLine."Item Shpt. Entry No.");
    END;

    LOCAL PROCEDURE UpdateAssocOrder@4();
    VAR
      ReservePurchLine@1000 : Codeunit 99000834;
    BEGIN
      DropShipPostBuffer.RESET;
      IF DropShipPostBuffer.ISEMPTY THEN
        EXIT;
      CLEAR(PurchOrderHeader);
      DropShipPostBuffer.FINDSET;
      REPEAT
        IF PurchOrderHeader."No." <> DropShipPostBuffer."Order No." THEN BEGIN
          PurchOrderHeader.GET(
            PurchOrderHeader."Document Type"::Order,
            DropShipPostBuffer."Order No.");
          PurchOrderHeader."Last Receiving No." := PurchOrderHeader."Receiving No.";
          PurchOrderHeader."Receiving No." := '';
          PurchOrderHeader.MODIFY;
          ReservePurchLine.UpdateItemTrackingAfterPosting(PurchOrderHeader);
        END;
        PurchOrderLine.GET(
          PurchOrderLine."Document Type"::Order,
          DropShipPostBuffer."Order No.",DropShipPostBuffer."Order Line No.");
        PurchOrderLine."Quantity Received" := PurchOrderLine."Quantity Received" + DropShipPostBuffer.Quantity;
        PurchOrderLine."Qty. Received (Base)" := PurchOrderLine."Qty. Received (Base)" + DropShipPostBuffer."Quantity (Base)";
        PurchOrderLine.InitOutstanding;
        PurchOrderLine.ClearQtyIfBlank;
        PurchOrderLine.InitQtyToReceive;
        //**4PS.sn
        PurchOrderLine."Modified by" := USERID; //DP00469
        PurchOrderLine."Last Date Modified" := TODAY;//DP00469
        //**4PS.en
        PurchOrderLine.MODIFY;
      UNTIL DropShipPostBuffer.NEXT = 0;
      DropShipPostBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE UpdateAssocLines@5(VAR SalesOrderLine@1000 : Record 37);
    BEGIN
      PurchOrderLine.GET(
        PurchOrderLine."Document Type"::Order,
        SalesOrderLine."Purchase Order No.",SalesOrderLine."Purch. Order Line No.");
      PurchOrderLine."Sales Order No." := '';
      PurchOrderLine."Sales Order Line No." := 0;
      //**4PS.sn
      PurchOrderLine."Modified by" := USERID; //DP00469
      PurchOrderLine."Last Date Modified" := TODAY;//DP00469
      //**4PS.en
      PurchOrderLine.MODIFY;
      SalesOrderLine."Purchase Order No." := '';
      SalesOrderLine."Purch. Order Line No." := 0;
    END;

    LOCAL PROCEDURE FillInvPostingBuffer@5804(SalesLine@1000 : Record 37;SalesLineACY@1001 : Record 37);
    VAR
      GenPostingSetup@1006 : Record 252;
      TotalVAT@1005 : Decimal;
      TotalVATACY@1004 : Decimal;
      TotalAmount@1003 : Decimal;
      TotalAmountACY@1002 : Decimal;
      AmtToDefer@1007 : Decimal;
      AmtToDeferACY@1008 : Decimal;
      DeferralAccount@1009 : Code[20];
      SalesAccount@1010 : Code[20];
    BEGIN
      //GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group"); //**4PS.o
      IF GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group") THEN; //**4PS.n

      InvPostingBuffer[1].PrepareSales(SalesLine);

      //**4PS.sn
      WITH SalesLine DO BEGIN
        InvPostingBuffer[1]."Cost Component" := "Cost Component";
        InvPostingBuffer[1].Element := Element;
        InvPostingBuffer[1]."Service Order No." := "Service Order No.";
        InvPostingBuffer[1]."Service Contract No." := "Service Contract No.";
        InvPostingBuffer[1].Description := SalesLineACY.Description;
        InvPostingBuffer[1]."Description 2" := SalesLineACY."Description 2";
        IF InvPostingBuffer[1]."Service Contract No." <> '' THEN
          InvPostingBuffer[1]."Origin Type" := InvPostingBuffer[1]."Origin Type"::Service
        ELSE
          IF InvPostingBuffer[1]."Job No." <> '' THEN
            InvPostingBuffer[1]."Origin Type" := InvPostingBuffer[1]."Origin Type"::Project;
        IF CheckSalesLineBuyBackItemPO(SalesLine) THEN
          InvPostingBuffer[1]."Buy-Back Item (Plant Order)" := TRUE;

        InvPostingBuffer[1]."Extension Contract" := "Extension Contract";
        InvPostingBuffer[1]."Plant Invoice" := "Plant Invoice";
        InvPostingBuffer[1]."Rental Unit" := "Rental Unit";
        InvPostingBuffer[1]."Rental Unit Line Type" := "Rental Unit Line Type";
        InvPostingBuffer[1]."Service Location No." := "Service Location No.";
        InvPostingBuffer[1]."Cost Type Cost Plus Line" := "Cost Type Cost Plus Line";
      END;
      //**4PS.en

      TotalVAT := SalesLine."Amount Including VAT" - SalesLine.Amount;
      TotalVATACY := SalesLineACY."Amount Including VAT" - SalesLineACY.Amount;
      TotalAmount := SalesLine.Amount;
      TotalAmountACY := SalesLineACY.Amount;

      IF SalesLine."Deferral Code" <> '' THEN
        GetAmountsForDeferral(SalesLine,AmtToDefer,AmtToDeferACY,DeferralAccount)
      ELSE BEGIN
        AmtToDefer := 0;
        AmtToDeferACY := 0;
        DeferralAccount := '';
      END;

      IF SalesSetup."Discount Posting" IN
         [SalesSetup."Discount Posting"::"Invoice Discounts",SalesSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        IF SalesLine."VAT Calculation Type" = SalesLine."VAT Calculation Type"::"Reverse Charge VAT" THEN
          InvPostingBuffer[1].CalcDiscountNoVAT(
            -SalesLine."Inv. Discount Amount",
            -SalesLineACY."Inv. Discount Amount")
        ELSE
          InvPostingBuffer[1].CalcDiscount(
            SalesHeader."Prices Including VAT",
            -SalesLine."Inv. Discount Amount",
            -SalesLineACY."Inv. Discount Amount");
        IF (InvPostingBuffer[1].Amount <> 0) OR
           (InvPostingBuffer[1]."Amount (ACY)" <> 0)
        THEN BEGIN
          GenPostingSetup.TESTFIELD("Sales Inv. Disc. Account");
          InvPostingBuffer[1].SetAccount(
            GenPostingSetup."Sales Inv. Disc. Account",
            TotalVAT,
            TotalVATACY,
            TotalAmount,
            TotalAmountACY);
          UpdInvPostingBuffer(TRUE);
        END;
      END;

      IF SalesSetup."Discount Posting" IN
         [SalesSetup."Discount Posting"::"Line Discounts",SalesSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        IF SalesLine."VAT Calculation Type" = SalesLine."VAT Calculation Type"::"Reverse Charge VAT" THEN
          InvPostingBuffer[1].CalcDiscountNoVAT(
            -SalesLine."Line Discount Amount",
            -SalesLineACY."Line Discount Amount")
        ELSE
          InvPostingBuffer[1].CalcDiscount(
            SalesHeader."Prices Including VAT",
            -SalesLine."Line Discount Amount",
            -SalesLineACY."Line Discount Amount");
        IF (InvPostingBuffer[1].Amount <> 0) OR
           (InvPostingBuffer[1]."Amount (ACY)" <> 0)
        THEN BEGIN
          GenPostingSetup.TESTFIELD("Sales Line Disc. Account");
          InvPostingBuffer[1].SetAccount(
            GenPostingSetup."Sales Line Disc. Account",
            TotalVAT,
            TotalVATACY,
            TotalAmount,
            TotalAmountACY);
          UpdInvPostingBuffer(TRUE);
        END;
      END;

      IF SalesLine."Deferral Code" <> '' THEN
        IF (AmtToDefer = TotalAmount) AND (AmtToDeferACY = TotalAmountACY) THEN BEGIN
          AmtToDefer := 0;
          AmtToDeferACY := 0;
        END ELSE BEGIN
          TotalAmount := TotalAmount - AmtToDefer;
          TotalAmountACY := TotalAmountACY - AmtToDeferACY;
        END;

      InvPostingBuffer[1].SetAmounts(
        TotalVAT,
        TotalVATACY,
        TotalAmount,
        TotalAmountACY,
        SalesLine."VAT Difference");

      IF (SalesLine.Type = SalesLine.Type::"G/L Account") OR (SalesLine.Type = SalesLine.Type::"Fixed Asset") THEN BEGIN
        SalesAccount := SalesLine."No.";
        InvPostingBuffer[1].SetAccount(
          DefaultGLAccount(SalesLine."Deferral Code",AmtToDefer,SalesAccount,DeferralAccount),
          TotalVAT,
          TotalVATACY,
          TotalAmount,
          TotalAmountACY)
      END ELSE
        IF SalesLine."Document Type" IN [SalesLine."Document Type"::"Return Order",SalesLine."Document Type"::"Credit Memo"] THEN BEGIN
          GenPostingSetup.TESTFIELD("Sales Credit Memo Account");
          SalesAccount := GenPostingSetup."Sales Credit Memo Account";
          InvPostingBuffer[1].SetAccount(
            DefaultGLAccount(SalesLine."Deferral Code",AmtToDefer,SalesAccount,DeferralAccount),
            TotalVAT,
            TotalVATACY,
            TotalAmount,
            TotalAmountACY);
        END ELSE BEGIN
          GenPostingSetup.TESTFIELD("Sales Account");
          SalesAccount := GenPostingSetup."Sales Account";
          InvPostingBuffer[1].SetAccount(
            DefaultGLAccount(SalesLine."Deferral Code",AmtToDefer,SalesAccount,DeferralAccount),
            TotalVAT,
            TotalVATACY,
            TotalAmount,
            TotalAmountACY);
        END;

      //**4PS.sn
      IF ChargeJobOrderToPlant OR ChargeSOToJobPlantLoc OR ChargeSOToPlantItem THEN BEGIN //DP00195
        InvPostingBuffer[1].Amount := -InvPostingBuffer[1].Amount;
        InvPostingBuffer[1]."VAT Base Amount" := -InvPostingBuffer[1]."VAT Base Amount";
        InvPostingBuffer[1]."VAT Amount" := -InvPostingBuffer[1]."VAT Amount";
        InvPostingBuffer[1]."Amount (ACY)" := -InvPostingBuffer[1]."Amount (ACY)";
      END;
      //**4PS.en

      UpdInvPostingBuffer(FALSE);
      IF SalesLine."Deferral Code" <> '' THEN
        FillDeferralPostingBuffer(SalesLine,AmtToDefer,AmtToDeferACY,DeferralAccount,SalesAccount);
    END;

    LOCAL PROCEDURE UpdInvPostingBuffer@6(ForceGLAccountType@1000 : Boolean);
    VAR
      DimMgt@1001 : Codeunit 408;
      RestoreFAType@1002 : Boolean;
    BEGIN
      InvPostingBuffer[1]."Dimension Set ID" := SalesLine."Dimension Set ID";

      DimMgt.UpdateGlobalDimFromDimSetID(InvPostingBuffer[1]."Dimension Set ID",
        InvPostingBuffer[1]."Global Dimension 1 Code",InvPostingBuffer[1]."Global Dimension 2 Code");

      IF InvPostingBuffer[1].Type = InvPostingBuffer[1].Type::"Fixed Asset" THEN BEGIN
        FALineNo := FALineNo + 1;
        InvPostingBuffer[1]."Fixed Asset Line No." := FALineNo;
        IF ForceGLAccountType THEN BEGIN
          RestoreFAType := TRUE;
          InvPostingBuffer[1].Type := InvPostingBuffer[1].Type::"G/L Account";
        END;
      END;

      InvPostingBuffer[2] := InvPostingBuffer[1];
      //*29-11-2011.sn
      InvPostingBuffer[2].SETRANGE("Extension Contract", InvPostingBuffer[1]."Extension Contract");
      InvPostingBuffer[2].SETRANGE("Plant Invoice", InvPostingBuffer[1]."Plant Invoice");
      InvPostingBuffer[2].SETRANGE("Rental Unit", InvPostingBuffer[1]."Rental Unit");
      InvPostingBuffer[2].SETRANGE("Rental Unit Line Type", InvPostingBuffer[1]."Rental Unit Line Type");  //*C017909
      InvPostingBuffer[2].SETRANGE("Service Location No.", InvPostingBuffer[1]."Service Location No.");
      InvPostingBuffer[2].SETRANGE("Cost Type Cost Plus Line", InvPostingBuffer[1]."Cost Type Cost Plus Line");
      //*29-11-2011.en
      IF InvPostingBuffer[2].FIND THEN BEGIN
        InvPostingBuffer[2].Amount := InvPostingBuffer[2].Amount + InvPostingBuffer[1].Amount;
        InvPostingBuffer[2]."VAT Amount" :=
          InvPostingBuffer[2]."VAT Amount" + InvPostingBuffer[1]."VAT Amount";
        InvPostingBuffer[2]."VAT Base Amount" :=
          InvPostingBuffer[2]."VAT Base Amount" + InvPostingBuffer[1]."VAT Base Amount";
        InvPostingBuffer[2]."Amount (ACY)" :=
          InvPostingBuffer[2]."Amount (ACY)" + InvPostingBuffer[1]."Amount (ACY)";
        InvPostingBuffer[2]."VAT Amount (ACY)" :=
          InvPostingBuffer[2]."VAT Amount (ACY)" + InvPostingBuffer[1]."VAT Amount (ACY)";
        InvPostingBuffer[2]."VAT Difference" :=
          InvPostingBuffer[2]."VAT Difference" + InvPostingBuffer[1]."VAT Difference";
        InvPostingBuffer[2]."VAT Base Amount (ACY)" :=
          InvPostingBuffer[2]."VAT Base Amount (ACY)" +
          InvPostingBuffer[1]."VAT Base Amount (ACY)";
        InvPostingBuffer[2].Quantity :=
          InvPostingBuffer[2].Quantity + InvPostingBuffer[1].Quantity;
        IF NOT InvPostingBuffer[1]."System-Created Entry" THEN
          InvPostingBuffer[2]."System-Created Entry" := FALSE;
        InvPostingBuffer[2].MODIFY;
        InvDefLineNo := InvPostingBuffer[2]."Deferral Line No.";
      END ELSE BEGIN
        IF InvPostingBuffer[1]."Deferral Code" <> '' THEN BEGIN
          DeferralLineNo := DeferralLineNo + 1;
          InvPostingBuffer[1]."Deferral Line No." := DeferralLineNo;
          InvDefLineNo := InvPostingBuffer[1]."Deferral Line No.";
        END;
      //InvPostingBuffer[1].INSERT; //**4PS.o
      //**4PS.sn
        InvPostingBuffer[1]."Buffer Line No." := 1;
        WHILE NOT InvPostingBuffer[1].INSERT DO
          InvPostingBuffer[1]."Buffer Line No." := InvPostingBuffer[1]."Buffer Line No." + 1;
      //**4PS.en
      END;
      IF RestoreFAType THEN
        InvPostingBuffer[1].Type := InvPostingBuffer[1].Type::"Fixed Asset";
    END;

    LOCAL PROCEDURE InsertPrepmtAdjInvPostingBuf@80(PrepmtSalesLine@1000 : Record 37);
    VAR
      SalesPostPrepayments@1002 : Codeunit 442;
      AdjAmount@1001 : Decimal;
    BEGIN
      WITH PrepmtSalesLine DO
        IF "Prepayment Line" THEN
          IF "Prepmt. Amount Inv. (LCY)" <> 0 THEN BEGIN
            AdjAmount := -"Prepmt. Amount Inv. (LCY)";
            FillPrepmtAdjInvPostingBuffer("No.",AdjAmount,SalesHeader."Currency Code" = '');
            FillPrepmtAdjInvPostingBuffer(
              SalesPostPrepayments.GetCorrBalAccNo(SalesHeader,AdjAmount > 0),
              -AdjAmount,
              SalesHeader."Currency Code" = '');
          END ELSE
            IF ("Prepayment %" = 100) AND ("Prepmt. VAT Amount Inv. (LCY)" <> 0) THEN
              FillPrepmtAdjInvPostingBuffer(
                SalesPostPrepayments.GetInvRoundingAccNo(SalesHeader."Customer Posting Group"),
                "Prepmt. VAT Amount Inv. (LCY)",SalesHeader."Currency Code" = '');
    END;

    LOCAL PROCEDURE FillPrepmtAdjInvPostingBuffer@81(GLAccountNo@1001 : Code[20];AdjAmount@1003 : Decimal;RoundingEntry@1004 : Boolean);
    VAR
      PrepmtAdjInvPostBuffer@1002 : Record 49;
    BEGIN
      WITH PrepmtAdjInvPostBuffer DO BEGIN
        INIT;
        Type := Type::"Prepmt. Exch. Rate Difference";
        "G/L Account" := GLAccountNo;
        Amount := AdjAmount;
        IF RoundingEntry THEN
          "Amount (ACY)" := AdjAmount
        ELSE
          "Amount (ACY)" := 0;
        "Dimension Set ID" := InvPostingBuffer[1]."Dimension Set ID";
        "Global Dimension 1 Code" := InvPostingBuffer[1]."Global Dimension 1 Code";
        "Global Dimension 2 Code" := InvPostingBuffer[1]."Global Dimension 2 Code";
        "System-Created Entry" := TRUE;
        InvPostingBuffer[1] := PrepmtAdjInvPostBuffer;

        InvPostingBuffer[2] := InvPostingBuffer[1];
        IF InvPostingBuffer[2].FIND THEN BEGIN
          InvPostingBuffer[2].Amount := InvPostingBuffer[2].Amount + InvPostingBuffer[1].Amount;
          InvPostingBuffer[2]."Amount (ACY)" :=
            InvPostingBuffer[2]."Amount (ACY)" + InvPostingBuffer[1]."Amount (ACY)";
          InvPostingBuffer[2].MODIFY;
        END ELSE
          InvPostingBuffer[1].INSERT;
      END;
    END;

    LOCAL PROCEDURE GetCurrency@17();
    BEGIN
      WITH SalesHeader DO
        IF "Currency Code" = '' THEN
          Currency.InitRoundingPrecision
        ELSE BEGIN
          Currency.GET("Currency Code");
          Currency.TESTFIELD("Amount Rounding Precision");
        END;
    END;

    LOCAL PROCEDURE DivideAmount@8(QtyType@1000 : 'General,Invoicing,Shipping';SalesLineQty@1001 : Decimal;VAR TempVATAmountLine@1002 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1003 : TEMPORARY Record 290);
    VAR
      OriginalDeferralAmount@1006 : Decimal;
    BEGIN
      IF RoundingLineInserted AND (RoundingLineNo = SalesLine."Line No.") THEN
        EXIT;
      WITH SalesLine DO
        //IF (SalesLineQty = 0) OR ("Unit Price" = 0) THEN BEGIN //**4PS.o
        //**4PS.sn
        IF (SalesLineQty = 0) OR ("Unit Price" = 0) OR
           ((SalesHeader."Document Type" = SalesHeader."Document Type"::Quote) AND
            (SalesHeader."Sales Document Type" = SalesHeader."Sales Document Type"::"Sales Logistics Separated") AND
            (SalesLine."Alternative No." <> SalesHeader."Elected Alternative No.")) THEN
        BEGIN
         //**4PS.en
          "Line Amount" := 0;
          "Line Discount Amount" := 0;
          "Inv. Discount Amount" := 0;
          "VAT Base Amount" := 0;
          Amount := 0;
          "Amount Including VAT" := 0;
        END ELSE BEGIN
          OriginalDeferralAmount := GetDeferralAmount;
          //TempVATAmountLine.GET("VAT Identifier","VAT Calculation Type","Tax Group Code",FALSE,"Line Amount" >= 0); //**4PS.o
          TempVATAmountLine.GET("VAT Identifier","VAT Calculation Type","Tax Group Code",FALSE,FALSE); //**4PS.n
          IF "VAT Calculation Type" = "VAT Calculation Type"::"Sales Tax" THEN
            "VAT %" := TempVATAmountLine."VAT %";
          TempVATAmountLineRemainder := TempVATAmountLine;
          IF NOT TempVATAmountLineRemainder.FIND THEN BEGIN
            TempVATAmountLineRemainder.INIT;
            TempVATAmountLineRemainder.INSERT;
          END;
          //**4PS.sn
          IF ((SalesHeader."Document Type" = SalesHeader."Document Type"::Quote) AND
              (SalesHeader."Sales Document Type" = SalesHeader."Sales Document Type"::"Sales Logistics Separated") AND
              (SalesLine."Alternative No." <> SalesHeader."Elected Alternative No.") OR SalesLine.Optional)
          THEN
            "Line Amount" := 0
          ELSE
          //**4PS.en
            "Line Amount" := GetLineAmountToHandle(SalesLineQty) + GetPrepmtDiffToLineAmount(SalesLine);
          IF SalesLineQty <> Quantity THEN
            "Line Discount Amount" :=
              ROUND("Line Discount Amount" * SalesLineQty / Quantity,Currency."Amount Rounding Precision");

          IF "Allow Invoice Disc." AND (TempVATAmountLine."Inv. Disc. Base Amount" <> 0) THEN
            IF QtyType = QtyType::Invoicing THEN
              "Inv. Discount Amount" := "Inv. Disc. Amount to Invoice"
            ELSE BEGIN
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" +
                TempVATAmountLine."Invoice Discount Amount" * "Line Amount" /
                TempVATAmountLine."Inv. Disc. Base Amount";
              "Inv. Discount Amount" :=
                ROUND(
                  TempVATAmountLineRemainder."Invoice Discount Amount",Currency."Amount Rounding Precision");
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" - "Inv. Discount Amount";
            END;

          IF SalesHeader."Prices Including VAT" THEN BEGIN
            IF NOT "Manually VAT Posting" THEN BEGIN//**4PS.n
              IF (TempVATAmountLine."Line Amount" - TempVATAmountLine."Invoice Discount Amount" = 0) OR
                 ("Line Amount" = 0)
              THEN BEGIN
                TempVATAmountLineRemainder."VAT Amount" := 0;
                TempVATAmountLineRemainder."Amount Including VAT" := 0;
              END ELSE BEGIN
                TempVATAmountLineRemainder."VAT Amount" :=
                  TempVATAmountLineRemainder."VAT Amount" +
                  TempVATAmountLine."VAT Amount" *
                  ("Line Amount" - "Inv. Discount Amount") /
                  (TempVATAmountLine."Line Amount" - TempVATAmountLine."Invoice Discount Amount");
                TempVATAmountLineRemainder."Amount Including VAT" :=
                  TempVATAmountLineRemainder."Amount Including VAT" +
                  TempVATAmountLine."Amount Including VAT" *
                  ("Line Amount" - "Inv. Discount Amount") /
                  (TempVATAmountLine."Line Amount" - TempVATAmountLine."Invoice Discount Amount");
              END;
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" :=
                  ROUND(TempVATAmountLineRemainder."Amount Including VAT",Currency."Amount Rounding Precision")
              ELSE
                "Amount Including VAT" := 0;
            END; //**4PS.n
            Amount :=
              ROUND("Amount Including VAT",Currency."Amount Rounding Precision") -
              ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision");
            "VAT Base Amount" :=
              ROUND(
                Amount * (1 - SalesHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
            TempVATAmountLineRemainder."Amount Including VAT" :=
              TempVATAmountLineRemainder."Amount Including VAT" - "Amount Including VAT";
            TempVATAmountLineRemainder."VAT Amount" :=
              TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
          END ELSE
            IF "VAT Calculation Type" = "VAT Calculation Type"::"Full VAT" THEN BEGIN
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" := "Line Amount" - "Inv. Discount Amount"
              ELSE
                "Amount Including VAT" := 0;
              Amount := 0;
              "VAT Base Amount" := 0;
            END ELSE BEGIN
              Amount := "Line Amount" - "Inv. Discount Amount";
              "VAT Base Amount" :=
                ROUND(
                  Amount * (1 - SalesHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
              IF NOT "Manually VAT Posting" THEN BEGIN //**4PS.n
                IF TempVATAmountLine."VAT Base" = 0 THEN
                  TempVATAmountLineRemainder."VAT Amount" := 0
                ELSE
                  TempVATAmountLineRemainder."VAT Amount" :=
                    TempVATAmountLineRemainder."VAT Amount" +
                    TempVATAmountLine."VAT Amount" *
                    ("Line Amount" - "Inv. Discount Amount") /
                    (TempVATAmountLine."Line Amount" - TempVATAmountLine."Invoice Discount Amount");
                IF "Line Discount %" <> 100 THEN
                  "Amount Including VAT" :=
                    Amount + ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision")
                ELSE
                  "Amount Including VAT" := 0;
                TempVATAmountLineRemainder."VAT Amount" :=
                  TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
              END; //**4PS.n
            END;

          TempVATAmountLineRemainder.MODIFY;
          IF "Deferral Code" <> '' THEN
            CalcDeferralAmounts(SalesHeader,SalesLine,OriginalDeferralAmount);
        END;
    END;

    LOCAL PROCEDURE RoundAmount@9(SalesLineQty@1000 : Decimal);
    VAR
      CurrExchRate@1002 : Record 330;
      NoVAT@1001 : Boolean;
      lvProjectNo@1100528200 : Code[20];
    BEGIN
      WITH SalesLine DO BEGIN
        IncrAmount(TotalSalesLine);
        Increment(TotalSalesLine."Net Weight",ROUND(SalesLineQty * "Net Weight",0.00001));
        Increment(TotalSalesLine."Gross Weight",ROUND(SalesLineQty * "Gross Weight",0.00001));
        Increment(TotalSalesLine."Unit Volume",ROUND(SalesLineQty * "Unit Volume",0.00001));
        Increment(TotalSalesLine.Quantity,SalesLineQty);
        IF "Units per Parcel" > 0 THEN
          Increment(
            TotalSalesLine."Units per Parcel",
            ROUND(SalesLineQty / "Units per Parcel",1,'>'));

        TempSalesLine := SalesLine;
        SalesLineACY := SalesLine;

        IF SalesHeader."Currency Code" <> '' THEN BEGIN
          IF SalesHeader."Posting Date" = 0D THEN
            UseDate := WORKDATE
          ELSE
            UseDate := SalesHeader."Posting Date";

          NoVAT := Amount = "Amount Including VAT";

      //RFC 305 Project MC
          IF (SalesLine."Currency Code" <> '') AND
             (SalesLine."Job No." <> '') AND
             (SalesLine."Installment Invoice") THEN
            lvProjectNo := SalesLine."Job No."
          ELSE
            lvProjectNo:= '';

          "Amount Including VAT" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, lvProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Amount Including VAT",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Amount Including VAT",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Amount Including VAT";
          IF NoVAT THEN
            Amount := "Amount Including VAT"
          ELSE
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1, lvProjectNo, //**4PS.n
                  UseDate,SalesHeader."Currency Code",
      //          TotalSalesLine.Amount,SalesHeader."Currency Factor")) - //**4PS.o
                  TotalSalesLine.Amount,SalesHeader."Currency Factor",TRUE)) - //**4PS.n
              TotalSalesLineLCY.Amount;
          "Line Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, lvProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Line Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Line Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Line Amount";
          "Line Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, lvProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Line Discount Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Line Discount Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Line Discount Amount";
          "Inv. Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, lvProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Inv. Discount Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Inv. Discount Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Inv. Discount Amount";
          "VAT Difference" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, lvProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."VAT Difference",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."VAT Difference",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."VAT Difference";
        END;
        IncrAmount(TotalSalesLineLCY);
        Increment(TotalSalesLineLCY."Unit Cost (LCY)",ROUND(SalesLineQty * "Unit Cost (LCY)"));
      END;
    END;

    LOCAL PROCEDURE ReverseAmount@10(VAR SalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        "Qty. to Ship" := -"Qty. to Ship";
        "Qty. to Ship (Base)" := -"Qty. to Ship (Base)";
        "Return Qty. to Receive" := -"Return Qty. to Receive";
        "Return Qty. to Receive (Base)" := -"Return Qty. to Receive (Base)";
        "Qty. to Invoice" := -"Qty. to Invoice";
        "Qty. to Invoice (Base)" := -"Qty. to Invoice (Base)";
        "Line Amount" := -"Line Amount";
        Amount := -Amount;
        "Amount (LCY)" := - "Amount (LCY)"; //**4PS.n
        "VAT Base Amount" := -"VAT Base Amount";
        "VAT Difference" := -"VAT Difference";
        "Amount Including VAT" := -"Amount Including VAT";
        "Line Discount Amount" := -"Line Discount Amount";
        "Inv. Discount Amount" := -"Inv. Discount Amount";
      END;
    END;

    LOCAL PROCEDURE InvoiceRounding@12(UseTempData@1000 : Boolean;BiggestLineNo@1004 : Integer);
    VAR
      CustPostingGr@1002 : Record 92;
      TempSalesLineForCalc@1003 : TEMPORARY Record 37;
      InvoiceRoundingAmount@1001 : Decimal;
    BEGIN
      Currency.TESTFIELD("Invoice Rounding Precision");
      InvoiceRoundingAmount :=
        -ROUND(
          TotalSalesLine."Amount Including VAT" -
          ROUND(
            TotalSalesLine."Amount Including VAT",
            Currency."Invoice Rounding Precision",
            Currency.InvoiceRoundingDirection),
          Currency."Amount Rounding Precision");
      IF InvoiceRoundingAmount <> 0 THEN BEGIN
        CustPostingGr.GET(SalesHeader."Customer Posting Group");
        CustPostingGr.TESTFIELD("Invoice Rounding Account");
        WITH SalesLine DO BEGIN
          INIT;
          BiggestLineNo := BiggestLineNo + 10000;
          "System-Created Entry" := TRUE;
          IF UseTempData THEN BEGIN
            "Line No." := 0;
            Type := Type::"G/L Account";
            TempSalesLineForCalc := SalesLine;
            TempSalesLineForCalc.VALIDATE("No.",CustPostingGr."Invoice Rounding Account");
            SalesLine := TempSalesLineForCalc;
          END ELSE BEGIN
            "Line No." := BiggestLineNo;
            VALIDATE(Type,Type::"G/L Account");
            VALIDATE("No.",CustPostingGr."Invoice Rounding Account");
          END;
          VALIDATE(Quantity,1);
          IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
            VALIDATE("Return Qty. to Receive",Quantity)
          ELSE
            VALIDATE("Qty. to Ship",Quantity);
          IF SalesHeader."Prices Including VAT" THEN
            VALIDATE("Unit Price",InvoiceRoundingAmount)
          ELSE
            VALIDATE(
              "Unit Price",
              ROUND(
                InvoiceRoundingAmount /
                (1 + (1 - SalesHeader."VAT Base Discount %" / 100) * "VAT %" / 100),
                Currency."Amount Rounding Precision"));
          VALIDATE("Amount Including VAT",InvoiceRoundingAmount);
          "Line No." := BiggestLineNo;
          IF NOT UseTempData THEN
            ;
          LastLineRetrieved := FALSE;
          RoundingLineInserted := TRUE;
          RoundingLineNo := "Line No.";
        END;
      END;
    END;

    LOCAL PROCEDURE IncrAmount@13(VAR TotalSalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        IF SalesHeader."Prices Including VAT" OR
           ("VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT")
        THEN
          Increment(TotalSalesLine."Line Amount","Line Amount");
        Increment(TotalSalesLine.Amount,Amount);
        Increment(TotalSalesLine."VAT Base Amount","VAT Base Amount");
        Increment(TotalSalesLine."VAT Difference","VAT Difference");
        Increment(TotalSalesLine."Amount Including VAT","Amount Including VAT");
        Increment(TotalSalesLine."Line Discount Amount","Line Discount Amount");
        Increment(TotalSalesLine."Inv. Discount Amount","Inv. Discount Amount");
        Increment(TotalSalesLine."Inv. Disc. Amount to Invoice","Inv. Disc. Amount to Invoice");
        Increment(TotalSalesLine."Prepmt. Line Amount","Prepmt. Line Amount");
        Increment(TotalSalesLine."Prepmt. Amt. Inv.","Prepmt. Amt. Inv.");
        Increment(TotalSalesLine."Prepmt Amt to Deduct","Prepmt Amt to Deduct");
        Increment(TotalSalesLine."Prepmt Amt Deducted","Prepmt Amt Deducted");
        Increment(TotalSalesLine."Prepayment VAT Difference","Prepayment VAT Difference");
        Increment(TotalSalesLine."Prepmt VAT Diff. to Deduct","Prepmt VAT Diff. to Deduct");
        Increment(TotalSalesLine."Prepmt VAT Diff. Deducted","Prepmt VAT Diff. Deducted");
      END;
    END;

    LOCAL PROCEDURE Increment@14(VAR Number@1000 : Decimal;Number2@1001 : Decimal);
    BEGIN
      Number := Number + Number2;
    END;

    PROCEDURE GetSalesLines@16(VAR NewSalesHeader@1000 : Record 36;VAR NewSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping');
    VAR
      OldSalesLine@1003 : Record 37;
      MergedSalesLines@1006 : TEMPORARY Record 37;
      TotalAdjCostLCY@1005 : Decimal;
    BEGIN
      SalesHeader := NewSalesHeader;
      IF QtyType = QtyType::Invoicing THEN BEGIN
        CreatePrepaymentLines(SalesHeader,TempPrepaymentSalesLine,FALSE);
        MergeSaleslines(SalesHeader,OldSalesLine,TempPrepaymentSalesLine,MergedSalesLines);
        SumSalesLines2(NewSalesLine,MergedSalesLines,QtyType,TRUE,FALSE,TotalAdjCostLCY);
      END ELSE
        SumSalesLines2(NewSalesLine,OldSalesLine,QtyType,TRUE,FALSE,TotalAdjCostLCY);
    END;

    PROCEDURE GetSalesLinesTemp@33(VAR NewSalesHeader@1000 : Record 36;VAR NewSalesLine@1001 : Record 37;VAR OldSalesLine@1002 : Record 37;QtyType@1003 : 'General,Invoicing,Shipping');
    VAR
      TotalAdjCostLCY@1005 : Decimal;
    BEGIN
      SalesHeader := NewSalesHeader;
      OldSalesLine.SetSalesHeader(NewSalesHeader);
      SumSalesLines2(NewSalesLine,OldSalesLine,QtyType,TRUE,FALSE,TotalAdjCostLCY);
    END;

    PROCEDURE SumSalesLines@15(VAR NewSalesHeader@1000 : Record 36;QtyType@1001 : 'General,Invoicing,Shipping';VAR NewTotalSalesLine@1002 : Record 37;VAR NewTotalSalesLineLCY@1003 : Record 37;VAR VATAmount@1004 : Decimal;VAR VATAmountText@1005 : Text[30];VAR ProfitLCY@1006 : Decimal;VAR ProfitPct@1007 : Decimal;VAR TotalAdjCostLCY@1010 : Decimal);
    VAR
      OldSalesLine@1008 : Record 37;
    BEGIN
      SumSalesLinesTemp(
        NewSalesHeader,OldSalesLine,QtyType,NewTotalSalesLine,NewTotalSalesLineLCY,
        VATAmount,VATAmountText,ProfitLCY,ProfitPct,TotalAdjCostLCY);
    END;

    PROCEDURE SumSalesLinesTemp@25(VAR NewSalesHeader@1000 : Record 36;VAR OldSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';VAR NewTotalSalesLine@1003 : Record 37;VAR NewTotalSalesLineLCY@1004 : Record 37;VAR VATAmount@1005 : Decimal;VAR VATAmountText@1006 : Text[30];VAR ProfitLCY@1007 : Decimal;VAR ProfitPct@1008 : Decimal;VAR TotalAdjCostLCY@1011 : Decimal);
    VAR
      SalesLine@1009 : Record 37;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesHeader := NewSalesHeader;
        SumSalesLines2(SalesLine,OldSalesLine,QtyType,FALSE,TRUE,TotalAdjCostLCY);
        ProfitLCY := TotalSalesLineLCY.Amount - TotalSalesLineLCY."Unit Cost (LCY)";
        IF TotalSalesLineLCY.Amount = 0 THEN
          ProfitPct := 0
        ELSE
          ProfitPct := ROUND(ProfitLCY / TotalSalesLineLCY.Amount * 100,0.1);
        VATAmount := TotalSalesLine."Amount Including VAT" - TotalSalesLine.Amount;
        IF TotalSalesLine."VAT %" = 0 THEN
          VATAmountText := Text016
        ELSE
          VATAmountText := STRSUBSTNO(Text017,TotalSalesLine."VAT %");
        NewTotalSalesLine := TotalSalesLine;
        NewTotalSalesLineLCY := TotalSalesLineLCY;
      END;
    END;

    LOCAL PROCEDURE SumSalesLines2@11(VAR NewSalesLine@1000 : Record 37;VAR OldSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';InsertSalesLine@1003 : Boolean;CalcAdCostLCY@1008 : Boolean;VAR TotalAdjCostLCY@1006 : Decimal);
    VAR
      TempVATAmountLine@1010 : TEMPORARY Record 290;
      TempVATAmountLineRemainder@1009 : TEMPORARY Record 290;
      SalesLineQty@1004 : Decimal;
      AdjCostLCY@1007 : Decimal;
      BiggestLineNo@1005 : Integer;
    BEGIN
      TotalAdjCostLCY := 0;
      TempVATAmountLineRemainder.DELETEALL;
      OldSalesLine.CalcVATAmountLines(QtyType,SalesHeader,OldSalesLine,TempVATAmountLine);
      WITH SalesHeader DO BEGIN
        GetGLSetup;
        SalesSetup.GET;
        GetCurrency;
        OldSalesLine.SETRANGE("Document Type","Document Type");
        OldSalesLine.SETRANGE("Document No.","No.");
        RoundingLineInserted := FALSE;
        IF OldSalesLine.FINDSET THEN
          REPEAT
            IF NOT RoundingLineInserted THEN
              SalesLine := OldSalesLine;
            CASE QtyType OF
              QtyType::General:
                SalesLineQty := SalesLine.Quantity;
              QtyType::Invoicing:
                SalesLineQty := SalesLine."Qty. to Invoice";
              QtyType::Shipping:
                BEGIN
                  IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
                    SalesLineQty := SalesLine."Return Qty. to Receive"
                  ELSE
                    SalesLineQty := SalesLine."Qty. to Ship";
                END;
            END;
            DivideAmount(QtyType,SalesLineQty,TempVATAmountLine,TempVATAmountLineRemainder);
            SalesLine.Quantity := SalesLineQty;
            IF SalesLineQty <> 0 THEN BEGIN
              IF (SalesLine.Amount <> 0) AND NOT RoundingLineInserted THEN
                IF TotalSalesLine.Amount = 0 THEN
                  TotalSalesLine."VAT %" := SalesLine."VAT %"
                ELSE
                  IF TotalSalesLine."VAT %" <> SalesLine."VAT %" THEN
                    TotalSalesLine."VAT %" := 0;
              RoundAmount(SalesLineQty);

              IF (QtyType IN [QtyType::General,QtyType::Invoicing]) AND
                 NOT InsertSalesLine AND CalcAdCostLCY
              THEN BEGIN
                AdjCostLCY := CostCalcMgt.CalcSalesLineCostLCY(SalesLine,QtyType);
                TotalAdjCostLCY := TotalAdjCostLCY + GetSalesLineAdjCostLCY(SalesLine,QtyType,AdjCostLCY);
              END;

              SalesLine := TempSalesLine;
            END;
            IF InsertSalesLine THEN BEGIN
              NewSalesLine := SalesLine;
              NewSalesLine.INSERT;
            END;
            IF RoundingLineInserted THEN
              LastLineRetrieved := TRUE
            ELSE BEGIN
              BiggestLineNo := MAX(BiggestLineNo,OldSalesLine."Line No.");
              LastLineRetrieved := OldSalesLine.NEXT = 0;
              IF LastLineRetrieved AND SalesSetup."Invoice Rounding" THEN
                InvoiceRounding(TRUE,BiggestLineNo);
            END;
          UNTIL LastLineRetrieved;
      END;
    END;

    LOCAL PROCEDURE GetSalesLineAdjCostLCY@48(SalesLine2@1000 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';AdjCostLCY@1001 : Decimal) : Decimal;
    BEGIN
      WITH SalesLine2 DO BEGIN
        IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN
          AdjCostLCY := -AdjCostLCY;

        CASE TRUE OF
          "Shipment No." <> '',"Return Receipt No." <> '':
            EXIT(AdjCostLCY);
          QtyType = QtyType::General:
            EXIT(ROUND("Outstanding Quantity" * "Unit Cost (LCY)") + AdjCostLCY);
          "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice]:
            BEGIN
              IF "Qty. to Invoice" > "Qty. to Ship" THEN
                EXIT(ROUND("Qty. to Ship" * "Unit Cost (LCY)") + AdjCostLCY);
              EXIT(ROUND("Qty. to Invoice" * "Unit Cost (LCY)"));
            END;
          "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]:
            BEGIN
              IF "Qty. to Invoice" > "Return Qty. to Receive" THEN
                EXIT(ROUND("Return Qty. to Receive" * "Unit Cost (LCY)") + AdjCostLCY);
              EXIT(ROUND("Qty. to Invoice" * "Unit Cost (LCY)"));
            END;
        END;
      END;
    END;

    PROCEDURE TestDeleteHeader@19(SalesHeader@1000 : Record 36;VAR SalesShptHeader@1001 : Record 110;VAR SalesInvHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnRcptHeader@1004 : Record 6660;VAR SalesInvHeaderPrePmt@1006 : Record 112;VAR SalesCrMemoHeaderPrePmt@1005 : Record 114);
    BEGIN
      WITH SalesHeader DO BEGIN
        CLEAR(SalesShptHeader);
        CLEAR(SalesInvHeader);
        CLEAR(SalesCrMemoHeader);
        CLEAR(ReturnRcptHeader);
        SalesSetup.GET;

        SourceCodeSetup.GET;
        SourceCodeSetup.TESTFIELD("Deleted Document");
        SourceCode.GET(SourceCodeSetup."Deleted Document");

        IF ("Shipping No. Series" <> '') AND ("Shipping No." <> '') THEN BEGIN
          SalesShptHeader.TRANSFERFIELDS(SalesHeader);
          SalesShptHeader."No." := "Shipping No.";
          SalesShptHeader."Posting Date" := TODAY;
          SalesShptHeader."User ID" := USERID;
          SalesShptHeader."Source Code" := SourceCode.Code;
        END;

        IF ("Return Receipt No. Series" <> '') AND ("Return Receipt No." <> '') THEN BEGIN
          ReturnRcptHeader.TRANSFERFIELDS(SalesHeader);
          ReturnRcptHeader."No." := "Return Receipt No.";
          ReturnRcptHeader."Posting Date" := TODAY;
          ReturnRcptHeader."User ID" := USERID;
          ReturnRcptHeader."Source Code" := SourceCode.Code;
        END;

        IF ("Posting No. Series" <> '') AND
           (("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice]) AND
            ("Posting No." <> '') OR
            ("Document Type" = "Document Type"::Invoice) AND
            ("No. Series" = "Posting No. Series"))
        THEN BEGIN
          SalesInvHeader.TRANSFERFIELDS(SalesHeader);
          IF "Posting No." <> '' THEN
            SalesInvHeader."No." := "Posting No.";
          IF "Document Type" = "Document Type"::Invoice THEN BEGIN
            SalesInvHeader."Pre-Assigned No. Series" := "No. Series";
            SalesInvHeader."Pre-Assigned No." := "No.";
          END ELSE BEGIN
            SalesInvHeader."Pre-Assigned No. Series" := '';
            SalesInvHeader."Pre-Assigned No." := '';
            SalesInvHeader."Order No. Series" := "No. Series";
            SalesInvHeader."Order No." := "No.";
          END;
          SalesInvHeader."Posting Date" := TODAY;
          SalesInvHeader."User ID" := USERID;
          SalesInvHeader."Source Code" := SourceCode.Code;
        END;

        IF ("Posting No. Series" <> '') AND
           (("Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]) AND
            ("Posting No." <> '') OR
            ("Document Type" = "Document Type"::"Credit Memo") AND
            ("No. Series" = "Posting No. Series"))
        THEN BEGIN
          SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
          IF "Posting No." <> '' THEN
            SalesCrMemoHeader."No." := "Posting No.";
          SalesCrMemoHeader."Pre-Assigned No. Series" := "No. Series";
          SalesCrMemoHeader."Pre-Assigned No." := "No.";
          SalesCrMemoHeader."Posting Date" := TODAY;
          SalesCrMemoHeader."User ID" := USERID;
          SalesCrMemoHeader."Source Code" := SourceCode.Code;
        END;
        IF ("Prepayment No. Series" <> '') AND ("Prepayment No." <> '') THEN BEGIN
          TESTFIELD("Document Type","Document Type"::Order);
          SalesInvHeaderPrePmt.TRANSFERFIELDS(SalesHeader);
          SalesInvHeaderPrePmt."No." := "Prepayment No.";
          SalesInvHeaderPrePmt."Order No. Series" := "No. Series";
          SalesInvHeaderPrePmt."Prepayment Order No." := "No.";
          SalesInvHeaderPrePmt."Posting Date" := TODAY;
          SalesInvHeaderPrePmt."Pre-Assigned No. Series" := '';
          SalesInvHeaderPrePmt."Pre-Assigned No." := '';
          SalesInvHeaderPrePmt."User ID" := USERID;
          SalesInvHeaderPrePmt."Source Code" := SourceCode.Code;
          SalesInvHeaderPrePmt."Prepayment Invoice" := TRUE;
        END;

        IF ("Prepmt. Cr. Memo No. Series" <> '') AND ("Prepmt. Cr. Memo No." <> '') THEN BEGIN
          TESTFIELD("Document Type","Document Type"::Order);
          SalesCrMemoHeaderPrePmt.TRANSFERFIELDS(SalesHeader);
          SalesCrMemoHeaderPrePmt."No." := "Prepmt. Cr. Memo No.";
          SalesCrMemoHeaderPrePmt."Prepayment Order No." := "No.";
          SalesCrMemoHeaderPrePmt."Posting Date" := TODAY;
          SalesCrMemoHeaderPrePmt."Pre-Assigned No. Series" := '';
          SalesCrMemoHeaderPrePmt."Pre-Assigned No." := '';
          SalesCrMemoHeaderPrePmt."User ID" := USERID;
          SalesCrMemoHeaderPrePmt."Source Code" := SourceCode.Code;
          SalesCrMemoHeaderPrePmt."Prepayment Credit Memo" := TRUE;
        END;
      END;
    END;

    PROCEDURE DeleteHeader@18(SalesHeader@1000 : Record 36;VAR SalesShptHeader@1001 : Record 110;VAR SalesInvHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnRcptHeader@1004 : Record 6660;VAR SalesInvHeaderPrePmt@1006 : Record 112;VAR SalesCrMemoHeaderPrePmt@1005 : Record 114);
    VAR
      SalesInvLine@1007 : Record 113;
      SalesCrMemoLine@1008 : Record 115;
      SalesShptLine@1009 : Record 111;
      ReturnRcptLine@1010 : Record 6661;
    BEGIN
      WITH SalesHeader DO BEGIN
        TestDeleteHeader(
          SalesHeader,SalesShptHeader,SalesInvHeader,SalesCrMemoHeader,
          ReturnRcptHeader,SalesInvHeaderPrePmt,SalesCrMemoHeaderPrePmt);
        IF SalesShptHeader."No." <> '' THEN BEGIN
          SalesShptHeader.INSERT;
          SalesShptLine.INIT;
          SalesShptLine."Document No." := SalesShptHeader."No.";
          SalesShptLine."Line No." := 10000;
          SalesShptLine.Description := SourceCode.Description;
          SalesShptLine.INSERT;
        END;

        IF ReturnRcptHeader."No." <> '' THEN BEGIN
          ReturnRcptHeader.INSERT;
          ReturnRcptLine.INIT;
          ReturnRcptLine."Document No." := ReturnRcptHeader."No.";
          ReturnRcptLine."Line No." := 10000;
          ReturnRcptLine.Description := SourceCode.Description;
          ReturnRcptLine.INSERT;
        END;

        IF SalesInvHeader."No." <> '' THEN BEGIN
          SalesInvHeader.INSERT;
          SalesInvLine.INIT;
          SalesInvLine."Document No." := SalesInvHeader."No.";
          SalesInvLine."Line No." := 10000;
          SalesInvLine.Description := SourceCode.Description;
          SalesInvLine.INSERT;
        END;

        IF SalesCrMemoHeader."No." <> '' THEN BEGIN
          SalesCrMemoHeader.INSERT;
          SalesCrMemoLine.INIT;
          SalesCrMemoLine."Document No." := SalesCrMemoHeader."No.";
          SalesCrMemoLine."Line No." := 10000;
          SalesCrMemoLine.Description := SourceCode.Description;
          SalesCrMemoLine.INSERT;
        END;

        IF SalesInvHeaderPrePmt."No." <> '' THEN BEGIN
          SalesInvHeaderPrePmt.INSERT;
          SalesInvLine."Document No." := SalesInvHeaderPrePmt."No.";
          SalesInvLine."Line No." := 10000;
          SalesInvLine.Description := SourceCode.Description;
          SalesInvLine.INSERT;
        END;

        IF SalesCrMemoHeaderPrePmt."No." <> '' THEN BEGIN
          SalesCrMemoHeaderPrePmt.INSERT;
          SalesCrMemoLine.INIT;
          SalesCrMemoLine."Document No." := SalesCrMemoHeaderPrePmt."No.";
          SalesCrMemoLine."Line No." := 10000;
          SalesCrMemoLine.Description := SourceCode.Description;
          SalesCrMemoLine.INSERT;
        END;
      END;
    END;

    PROCEDURE UpdateBlanketOrderLine@21(SalesLine@1000 : Record 37;Ship@1001 : Boolean;Receive@1006 : Boolean;Invoice@1002 : Boolean);
    VAR
      BlanketOrderSalesLine@1003 : Record 37;
      xBlanketOrderSalesLine@1007 : Record 37;
      ModifyLine@1004 : Boolean;
      Sign@1005 : Decimal;
    BEGIN
      IF (SalesLine."Blanket Order No." <> '') AND (SalesLine."Blanket Order Line No." <> 0) AND
         ((Ship AND (SalesLine."Qty. to Ship" <> 0)) OR
          (Receive AND (SalesLine."Return Qty. to Receive" <> 0)) OR
          (Invoice AND (SalesLine."Qty. to Invoice" <> 0)))
      THEN
        IF BlanketOrderSalesLine.GET(
             BlanketOrderSalesLine."Document Type"::"Blanket Order",SalesLine."Blanket Order No.",
             SalesLine."Blanket Order Line No.")
        THEN BEGIN
          BlanketOrderSalesLine.TESTFIELD(Type,SalesLine.Type);
          BlanketOrderSalesLine.TESTFIELD("No.",SalesLine."No.");
          BlanketOrderSalesLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");

          ModifyLine := FALSE;
          CASE SalesLine."Document Type" OF
            SalesLine."Document Type"::Order,
            SalesLine."Document Type"::Invoice:
              Sign := 1;
            SalesLine."Document Type"::"Return Order",
            SalesLine."Document Type"::"Credit Memo":
              Sign := -1;
          END;
          IF Ship AND (SalesLine."Shipment No." = '') THEN BEGIN
            xBlanketOrderSalesLine := BlanketOrderSalesLine;

            IF BlanketOrderSalesLine."Qty. per Unit of Measure" =
               SalesLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderSalesLine."Quantity Shipped" :=
                BlanketOrderSalesLine."Quantity Shipped" + Sign * SalesLine."Qty. to Ship"
            ELSE
              BlanketOrderSalesLine."Quantity Shipped" :=
                BlanketOrderSalesLine."Quantity Shipped" +
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") *
                  SalesLine."Qty. to Ship",0.00001);
            BlanketOrderSalesLine."Qty. Shipped (Base)" :=
              BlanketOrderSalesLine."Qty. Shipped (Base)" + Sign * SalesLine."Qty. to Ship (Base)";
            ModifyLine := TRUE;

            AsmPost.UpdateBlanketATO(xBlanketOrderSalesLine,BlanketOrderSalesLine);
          END;
          IF Receive AND (SalesLine."Return Receipt No." = '') THEN BEGIN
            IF BlanketOrderSalesLine."Qty. per Unit of Measure" =
               SalesLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderSalesLine."Quantity Shipped" :=
                BlanketOrderSalesLine."Quantity Shipped" + Sign * SalesLine."Return Qty. to Receive"
            ELSE
              BlanketOrderSalesLine."Quantity Shipped" :=
                BlanketOrderSalesLine."Quantity Shipped" +
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") *
                  SalesLine."Return Qty. to Receive",0.00001);
            BlanketOrderSalesLine."Qty. Shipped (Base)" :=
              BlanketOrderSalesLine."Qty. Shipped (Base)" + Sign * SalesLine."Return Qty. to Receive (Base)";
            ModifyLine := TRUE;
          END;
          IF Invoice THEN BEGIN
            IF BlanketOrderSalesLine."Qty. per Unit of Measure" =
               SalesLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderSalesLine."Quantity Invoiced" :=
                BlanketOrderSalesLine."Quantity Invoiced" + Sign * SalesLine."Qty. to Invoice"
            ELSE
              BlanketOrderSalesLine."Quantity Invoiced" :=
                BlanketOrderSalesLine."Quantity Invoiced" +
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") *
                  SalesLine."Qty. to Invoice",0.00001);
            BlanketOrderSalesLine."Qty. Invoiced (Base)" :=
              BlanketOrderSalesLine."Qty. Invoiced (Base)" + Sign * SalesLine."Qty. to Invoice (Base)";
            ModifyLine := TRUE;
          END;

          IF ModifyLine THEN BEGIN
            BlanketOrderSalesLine.InitOutstanding;
            IF (BlanketOrderSalesLine.Quantity * BlanketOrderSalesLine."Quantity Shipped" < 0) OR
               (ABS(BlanketOrderSalesLine.Quantity) < ABS(BlanketOrderSalesLine."Quantity Shipped"))
            THEN
              BlanketOrderSalesLine.FIELDERROR(
                "Quantity Shipped",STRSUBSTNO(
                  Text018,
                  BlanketOrderSalesLine.FIELDCAPTION(Quantity)));

            IF (BlanketOrderSalesLine."Quantity (Base)" *
                BlanketOrderSalesLine."Qty. Shipped (Base)" < 0) OR
               (ABS(BlanketOrderSalesLine."Quantity (Base)") <
                ABS(BlanketOrderSalesLine."Qty. Shipped (Base)"))
            THEN
              BlanketOrderSalesLine.FIELDERROR(
                "Qty. Shipped (Base)",
                STRSUBSTNO(
                  Text018,
                  BlanketOrderSalesLine.FIELDCAPTION("Quantity (Base)")));

            BlanketOrderSalesLine.CALCFIELDS("Reserved Qty. (Base)");
            IF ABS(BlanketOrderSalesLine."Outstanding Qty. (Base)") <
               ABS(BlanketOrderSalesLine."Reserved Qty. (Base)")
            THEN
              BlanketOrderSalesLine.FIELDERROR(
                "Reserved Qty. (Base)",
                Text019);

            BlanketOrderSalesLine."Qty. to Invoice" :=
              BlanketOrderSalesLine.Quantity - BlanketOrderSalesLine."Quantity Invoiced";
            BlanketOrderSalesLine."Qty. to Ship" :=
              BlanketOrderSalesLine.Quantity - BlanketOrderSalesLine."Quantity Shipped";
            BlanketOrderSalesLine."Qty. to Invoice (Base)" :=
              BlanketOrderSalesLine."Quantity (Base)" - BlanketOrderSalesLine."Qty. Invoiced (Base)";
            BlanketOrderSalesLine."Qty. to Ship (Base)" :=
              BlanketOrderSalesLine."Quantity (Base)" - BlanketOrderSalesLine."Qty. Shipped (Base)";

            BlanketOrderSalesLine.MODIFY;
          END;
        END;
    END;

    LOCAL PROCEDURE CopyCommentLines@22(FromDocumentType@1000 : Integer;ToDocumentType@1001 : Integer;FromNumber@1002 : Code[20];ToNumber@1003 : Code[20]);
    VAR
      SalesCommentLine@1004 : Record 44;
      SalesCommentLine2@1005 : Record 44;
    BEGIN
      SalesCommentLine.SETRANGE("Document Type",FromDocumentType);
      SalesCommentLine.SETRANGE("No.",FromNumber);
      IF SalesCommentLine.FINDSET THEN
        REPEAT
          SalesCommentLine2 := SalesCommentLine;
          SalesCommentLine2."Document Type" := ToDocumentType;
          SalesCommentLine2."No." := ToNumber;
          SalesCommentLine2.INSERT;
        UNTIL SalesCommentLine.NEXT = 0;
    END;

    LOCAL PROCEDURE RunGenJnlPostLine@23(VAR GenJnlLine@1000 : Record 81) : Integer;
    BEGIN
      EXIT(GenJnlPostLine.RunWithCheck(GenJnlLine));
    END;

    LOCAL PROCEDURE CheckDim@34();
    VAR
      SalesLine2@1001 : Record 37;
    BEGIN
      SalesLine2."Line No." := 0;
      CheckDimValuePosting(SalesLine2);
      CheckDimComb(SalesLine2);

      SalesLine2.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine2.SETFILTER(Type,'<>%1',SalesLine2.Type::" ");
      IF SalesLine2.FINDSET THEN
        REPEAT
          IF (SalesHeader.Invoice AND (SalesLine2."Qty. to Invoice" <> 0)) OR
             (SalesHeader.Ship AND (SalesLine2."Qty. to Ship" <> 0)) OR
             (SalesHeader.Receive AND (SalesLine2."Return Qty. to Receive" <> 0))
          THEN BEGIN
            CheckDimComb(SalesLine2);
            CheckDimValuePosting(SalesLine2);
          END
        UNTIL SalesLine2.NEXT = 0;
    END;

    LOCAL PROCEDURE CheckDimComb@30(SalesLine@1000 : Record 37);
    VAR
      DimMgt@1001 : Codeunit 408;
    BEGIN
      IF SalesLine."Line No." = 0 THEN
        IF NOT DimMgt.CheckDimIDComb(SalesHeader."Dimension Set ID") THEN
          ERROR(
            Text028,
            SalesHeader."Document Type",SalesHeader."No.",DimMgt.GetDimCombErr);

      IF SalesLine."Line No." <> 0 THEN
        IF NOT DimMgt.CheckDimIDComb(SalesLine."Dimension Set ID") THEN
          ERROR(
            Text029,
            SalesHeader."Document Type",SalesHeader."No.",SalesLine."Line No.",DimMgt.GetDimCombErr);
    END;

    LOCAL PROCEDURE CheckDimValuePosting@28(VAR SalesLine2@1000 : Record 37);
    VAR
      DimMgt@1001 : Codeunit 408;
      TableIDArr@1002 : ARRAY [10] OF Integer;
      NumberArr@1003 : ARRAY [10] OF Code[20];
    BEGIN
      IF SalesLine2."Line No." = 0 THEN BEGIN
        TableIDArr[1] := DATABASE::Customer;
        NumberArr[1] := SalesHeader."Bill-to Customer No.";
        TableIDArr[2] := DATABASE::"Salesperson/Purchaser";
        NumberArr[2] := SalesHeader."Salesperson Code";
        TableIDArr[3] := DATABASE::Campaign;
        NumberArr[3] := SalesHeader."Campaign No.";
        TableIDArr[4] := DATABASE::"Responsibility Center";
        NumberArr[4] := SalesHeader."Responsibility Center";
        IF NOT DimMgt.CheckDimValuePosting(TableIDArr,NumberArr,SalesHeader."Dimension Set ID") THEN
          ERROR(
            Text030,
            SalesHeader."Document Type",SalesHeader."No.",DimMgt.GetDimValuePostingErr);
      END ELSE BEGIN
        TableIDArr[1] := DimMgt.TypeToTableID3(SalesLine2.Type);
        NumberArr[1] := SalesLine2."No.";
        IF NOT (SalesHeader."Plant Invoice" AND (SalesLine2."Job No." <> '')) THEN BEGIN  //**4PS.n
          TableIDArr[2] := DATABASE::Job;
          NumberArr[2] := SalesLine2."Job No.";
        END;  //**4PS.n
        IF NOT DimMgt.CheckDimValuePosting(TableIDArr,NumberArr,SalesLine2."Dimension Set ID") THEN
          ERROR(
            Text031,
            SalesHeader."Document Type",SalesHeader."No.",SalesLine2."Line No.",DimMgt.GetDimValuePostingErr);
      END;
    END;

    LOCAL PROCEDURE DeleteItemChargeAssgnt@5803();
    VAR
      ItemChargeAssgntSales@1000 : Record 5809;
    BEGIN
      ItemChargeAssgntSales.SETRANGE("Document Type",SalesLine."Document Type");
      ItemChargeAssgntSales.SETRANGE("Document No.",SalesLine."Document No.");
      IF NOT ItemChargeAssgntSales.ISEMPTY THEN
        ItemChargeAssgntSales.DELETEALL;
    END;

    LOCAL PROCEDURE UpdateItemChargeAssgnt@5808();
    VAR
      ItemChargeAssgntSales@1000 : Record 5809;
    BEGIN
      WITH TempItemChargeAssgntSales DO BEGIN
        ClearItemChargeAssgntFilter;
        MARKEDONLY(TRUE);
        IF FINDSET THEN
          REPEAT
            ItemChargeAssgntSales.GET("Document Type","Document No.","Document Line No.","Line No.");
            ItemChargeAssgntSales."Qty. Assigned" :=
              ItemChargeAssgntSales."Qty. Assigned" + "Qty. to Assign";
            ItemChargeAssgntSales."Qty. to Assign" := 0;
            ItemChargeAssgntSales."Amount to Assign" := 0;
            ItemChargeAssgntSales.MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdateSalesOrderChargeAssgnt@5814(SalesOrderInvLine@1000 : Record 37;SalesOrderLine@1001 : Record 37);
    VAR
      SalesOrderLine2@1002 : Record 37;
      SalesOrderInvLine2@1003 : Record 37;
      SalesShptLine@1004 : Record 111;
      ReturnRcptLine@1005 : Record 6661;
    BEGIN
      WITH SalesOrderInvLine DO BEGIN
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntSales.SETRANGE("Document Type","Document Type");
        TempItemChargeAssgntSales.SETRANGE("Document No.","Document No.");
        TempItemChargeAssgntSales.SETRANGE("Document Line No.","Line No.");
        TempItemChargeAssgntSales.MARKEDONLY(TRUE);
        IF TempItemChargeAssgntSales.FINDSET THEN
          REPEAT
            IF TempItemChargeAssgntSales."Applies-to Doc. Type" = "Document Type" THEN BEGIN
              SalesOrderInvLine2.GET(
                TempItemChargeAssgntSales."Applies-to Doc. Type",
                TempItemChargeAssgntSales."Applies-to Doc. No.",
                TempItemChargeAssgntSales."Applies-to Doc. Line No.");
              IF ((SalesOrderLine."Document Type" = SalesOrderLine."Document Type"::Order) AND
                  (SalesOrderInvLine2."Shipment No." = "Shipment No.")) OR
                 ((SalesOrderLine."Document Type" = SalesOrderLine."Document Type"::"Return Order") AND
                  (SalesOrderInvLine2."Return Receipt No." = "Return Receipt No."))
              THEN BEGIN
                IF SalesOrderLine."Document Type" = SalesOrderLine."Document Type"::Order THEN BEGIN
                  IF NOT
                     SalesShptLine.GET(SalesOrderInvLine2."Shipment No.",SalesOrderInvLine2."Shipment Line No.")
                  THEN
                    ERROR(Text013);
                  SalesOrderLine2.GET(
                    SalesOrderLine2."Document Type"::Order,
                    SalesShptLine."Order No.",SalesShptLine."Order Line No.");
                END ELSE BEGIN
                  IF NOT
                     ReturnRcptLine.GET(SalesOrderInvLine2."Return Receipt No.",SalesOrderInvLine2."Return Receipt Line No.")
                  THEN
                    ERROR(Text037);
                  SalesOrderLine2.GET(
                    SalesOrderLine2."Document Type"::"Return Order",
                    ReturnRcptLine."Return Order No.",ReturnRcptLine."Return Order Line No.");
                END;
                UpdateSalesChargeAssgntLines(
                  SalesOrderLine,
                  SalesOrderLine2."Document Type",
                  SalesOrderLine2."Document No.",
                  SalesOrderLine2."Line No.",
                  TempItemChargeAssgntSales."Qty. to Assign");
              END;
            END ELSE
              UpdateSalesChargeAssgntLines(
                SalesOrderLine,
                TempItemChargeAssgntSales."Applies-to Doc. Type",
                TempItemChargeAssgntSales."Applies-to Doc. No.",
                TempItemChargeAssgntSales."Applies-to Doc. Line No.",
                TempItemChargeAssgntSales."Qty. to Assign");
          UNTIL TempItemChargeAssgntSales.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdateSalesChargeAssgntLines@5813(SalesOrderLine@1000 : Record 37;ApplToDocType@1001 : Option;ApplToDocNo@1002 : Code[20];ApplToDocLineNo@1003 : Integer;QtyToAssign@1004 : Decimal);
    VAR
      ItemChargeAssgntSales@1005 : Record 5809;
      TempItemChargeAssgntSales2@1007 : Record 5809;
      LastLineNo@1006 : Integer;
      TotalToAssign@1008 : Decimal;
    BEGIN
      ItemChargeAssgntSales.SETRANGE("Document Type",SalesOrderLine."Document Type");
      ItemChargeAssgntSales.SETRANGE("Document No.",SalesOrderLine."Document No.");
      ItemChargeAssgntSales.SETRANGE("Document Line No.",SalesOrderLine."Line No.");
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type",ApplToDocType);
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.",ApplToDocNo);
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.",ApplToDocLineNo);
      IF ItemChargeAssgntSales.FINDFIRST THEN BEGIN
        ItemChargeAssgntSales."Qty. Assigned" := ItemChargeAssgntSales."Qty. Assigned" + QtyToAssign;
        ItemChargeAssgntSales."Qty. to Assign" := 0;
        ItemChargeAssgntSales."Amount to Assign" := 0;
        ItemChargeAssgntSales.MODIFY;
      END ELSE BEGIN
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type");
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.");
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.");
        ItemChargeAssgntSales.CALCSUMS("Qty. to Assign");

        // calculate total qty. to assign of the invoice charge line
        TempItemChargeAssgntSales2.SETRANGE("Document Type",TempItemChargeAssgntSales."Document Type");
        TempItemChargeAssgntSales2.SETRANGE("Document No.",TempItemChargeAssgntSales."Document No.");
        TempItemChargeAssgntSales2.SETRANGE("Document Line No.",TempItemChargeAssgntSales."Document Line No.");
        TempItemChargeAssgntSales2.CALCSUMS("Qty. to Assign");

        TotalToAssign := ItemChargeAssgntSales."Qty. to Assign" +
          TempItemChargeAssgntSales2."Qty. to Assign";

        IF ItemChargeAssgntSales.FINDLAST THEN
          LastLineNo := ItemChargeAssgntSales."Line No.";

        IF SalesOrderLine.Quantity < TotalToAssign THEN
          REPEAT
            TotalToAssign := TotalToAssign - ItemChargeAssgntSales."Qty. to Assign";
            ItemChargeAssgntSales."Qty. to Assign" := 0;
            ItemChargeAssgntSales."Amount to Assign" := 0;
            ItemChargeAssgntSales.MODIFY;
          UNTIL (ItemChargeAssgntSales.NEXT(-1) = 0) OR
                (TotalToAssign = SalesOrderLine.Quantity);

        InsertAssocOrderCharge(
          SalesOrderLine,
          ApplToDocType,
          ApplToDocNo,
          ApplToDocLineNo,
          LastLineNo,
          TempItemChargeAssgntSales."Applies-to Doc. Line Amount");
      END;
    END;

    LOCAL PROCEDURE InsertAssocOrderCharge@45(SalesOrderLine@1000 : Record 37;ApplToDocType@1001 : Option;ApplToDocNo@1002 : Code[20];ApplToDocLineNo@1003 : Integer;LastLineNo@1004 : Integer;ApplToDocLineAmt@1005 : Decimal);
    VAR
      NewItemChargeAssgntSales@1006 : Record 5809;
    BEGIN
      WITH NewItemChargeAssgntSales DO BEGIN
        INIT;
        "Document Type" := SalesOrderLine."Document Type";
        "Document No." := SalesOrderLine."Document No.";
        "Document Line No." := SalesOrderLine."Line No.";
        "Line No." := LastLineNo + 10000;
        "Item Charge No." := TempItemChargeAssgntSales."Item Charge No.";
        "Item No." := TempItemChargeAssgntSales."Item No.";
        "Qty. Assigned" := TempItemChargeAssgntSales."Qty. to Assign";
        "Qty. to Assign" := 0;
        "Amount to Assign" := 0;
        Description := TempItemChargeAssgntSales.Description;
        "Unit Cost" := TempItemChargeAssgntSales."Unit Cost";
        "Applies-to Doc. Type" := ApplToDocType;
        "Applies-to Doc. No." := ApplToDocNo;
        "Applies-to Doc. Line No." := ApplToDocLineNo;
        "Applies-to Doc. Line Amount" := ApplToDocLineAmt;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE CopyAndCheckItemCharge@5806(SalesHeader@1000 : Record 36);
    VAR
      SalesLine2@1001 : Record 37;
      SalesLine3@1002 : Record 37;
      InvoiceEverything@1004 : Boolean;
      AssignError@1005 : Boolean;
      QtyNeeded@1003 : Decimal;
    BEGIN
      TempItemChargeAssgntSales.RESET;
      TempItemChargeAssgntSales.DELETEALL;

      // Check for max qty posting
      SalesLine2.RESET;
      SalesLine2.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine2.SETRANGE(Type,SalesLine2.Type::"Charge (Item)");
      IF SalesLine2.ISEMPTY THEN
        EXIT;

      SalesLine2.FINDSET;
      REPEAT
        ItemChargeAssgntSales.RESET;
        ItemChargeAssgntSales.SETRANGE("Document Type",SalesLine2."Document Type");
        ItemChargeAssgntSales.SETRANGE("Document No.",SalesLine2."Document No.");
        ItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLine2."Line No.");
        ItemChargeAssgntSales.SETFILTER("Qty. to Assign",'<>0');
        IF ItemChargeAssgntSales.FINDSET THEN
          REPEAT
            TempItemChargeAssgntSales.INIT;
            TempItemChargeAssgntSales := ItemChargeAssgntSales;
            TempItemChargeAssgntSales.INSERT;
          UNTIL ItemChargeAssgntSales.NEXT = 0;

        IF SalesLine2."Qty. to Invoice" <> 0 THEN BEGIN
          SalesLine2.TESTFIELD("Job No.",'');
          SalesLine2.TESTFIELD("Job Contract Entry No.",0);
          IF (SalesLine2."Qty. to Ship" + SalesLine2."Return Qty. to Receive" <> 0) AND
             ((SalesHeader.Ship OR SalesHeader.Receive) OR
              (ABS(SalesLine2."Qty. to Invoice") >
               ABS(SalesLine2."Qty. Shipped Not Invoiced" + SalesLine2."Qty. to Ship") +
               ABS(SalesLine2."Ret. Qty. Rcd. Not Invd.(Base)" + SalesLine2."Return Qty. to Receive")))
          THEN
            SalesLine2.TESTFIELD("Line Amount");

          IF NOT SalesHeader.Ship THEN
            SalesLine2."Qty. to Ship" := 0;
          IF NOT SalesHeader.Receive THEN
            SalesLine2."Return Qty. to Receive" := 0;
          IF ABS(SalesLine2."Qty. to Invoice") >
             ABS(SalesLine2."Quantity Shipped" + SalesLine2."Qty. to Ship" +
               SalesLine2."Return Qty. Received" + SalesLine2."Return Qty. to Receive" -
               SalesLine2."Quantity Invoiced")
          THEN
            SalesLine2."Qty. to Invoice" :=
              SalesLine2."Quantity Shipped" + SalesLine2."Qty. to Ship" +
              SalesLine2."Return Qty. Received" + SalesLine2."Return Qty. to Receive" -
              SalesLine2."Quantity Invoiced";

          SalesLine2.CALCFIELDS("Qty. to Assign","Qty. Assigned");
          IF ABS(SalesLine2."Qty. to Assign" + SalesLine2."Qty. Assigned") >
             ABS(SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced")
          THEN
            ERROR(Text032,
              SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced" -
              SalesLine2."Qty. Assigned",SalesLine2.FIELDCAPTION("Document Type"),
              SalesLine2."Document Type",SalesLine2.FIELDCAPTION("Document No."),
              SalesLine2."Document No.",SalesLine2.FIELDCAPTION("Line No."),
              SalesLine2."Line No.");
          IF SalesLine2.Quantity =
             SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced"
          THEN BEGIN
            IF SalesLine2."Qty. to Assign" <> 0 THEN
              IF SalesLine2.Quantity = SalesLine2."Quantity Invoiced" THEN BEGIN
                TempItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLine2."Line No.");
                TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type",SalesLine2."Document Type");
                IF TempItemChargeAssgntSales.FINDSET THEN
                  REPEAT
                    SalesLine3.GET(
                      TempItemChargeAssgntSales."Applies-to Doc. Type",
                      TempItemChargeAssgntSales."Applies-to Doc. No.",
                      TempItemChargeAssgntSales."Applies-to Doc. Line No.");
                    IF SalesLine3.Quantity = SalesLine3."Quantity Invoiced" THEN
                      ERROR(Text034,SalesLine3.TABLECAPTION,
                        SalesLine3.FIELDCAPTION("Document Type"),SalesLine3."Document Type",
                        SalesLine3.FIELDCAPTION("Document No."),SalesLine3."Document No.",
                        SalesLine3.FIELDCAPTION("Line No."),SalesLine3."Line No.");
                  UNTIL TempItemChargeAssgntSales.NEXT = 0;
              END;
            IF SalesLine2.Quantity <> SalesLine2."Qty. to Assign" + SalesLine2."Qty. Assigned" THEN
              AssignError := TRUE;
          END;

          IF (SalesLine2."Qty. to Assign" + SalesLine2."Qty. Assigned") <
             (SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced")
          THEN
            ERROR(Text052,SalesLine2."No.");

          // check if all ILEs exist
          QtyNeeded := SalesLine2."Qty. to Assign";
          TempItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLine2."Line No.");
          IF TempItemChargeAssgntSales.FINDSET THEN
            REPEAT
              IF (TempItemChargeAssgntSales."Applies-to Doc. Type" <> SalesLine2."Document Type") OR
                 (TempItemChargeAssgntSales."Applies-to Doc. No." <> SalesLine2."Document No.")
              THEN
                QtyNeeded := QtyNeeded - TempItemChargeAssgntSales."Qty. to Assign"
              ELSE BEGIN
                SalesLine3.GET(
                  TempItemChargeAssgntSales."Applies-to Doc. Type",
                  TempItemChargeAssgntSales."Applies-to Doc. No.",
                  TempItemChargeAssgntSales."Applies-to Doc. Line No.");
                IF ItemLedgerEntryExist(SalesLine3) THEN
                  QtyNeeded := QtyNeeded - TempItemChargeAssgntSales."Qty. to Assign";
              END;
            UNTIL TempItemChargeAssgntSales.NEXT = 0;

          IF QtyNeeded > 0 THEN
            ERROR(Text053,SalesLine2."No.");
        END;
      UNTIL SalesLine2.NEXT = 0;

      // Check saleslines
      IF AssignError THEN
        IF SalesHeader."Document Type" IN
           [SalesHeader."Document Type"::Invoice,SalesHeader."Document Type"::"Credit Memo"]
        THEN
          InvoiceEverything := TRUE
        ELSE BEGIN
          SalesLine2.RESET;
          SalesLine2.SETRANGE("Document Type",SalesHeader."Document Type");
          SalesLine2.SETRANGE("Document No.",SalesHeader."No.");
          SalesLine2.SETFILTER(Type,'%1|%2',SalesLine2.Type::Item,SalesLine2.Type::"Charge (Item)");
          IF SalesLine2.FINDSET THEN
            REPEAT
              IF SalesHeader.Ship OR SalesHeader.Receive THEN
                InvoiceEverything :=
                  SalesLine2.Quantity = SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced"
              ELSE
                InvoiceEverything :=
                  (SalesLine2.Quantity = SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced") AND
                  (SalesLine2."Qty. to Invoice" =
                   SalesLine2."Qty. Shipped Not Invoiced" + SalesLine2."Ret. Qty. Rcd. Not Invd.(Base)");
            UNTIL (SalesLine2.NEXT = 0) OR (NOT InvoiceEverything);
        END;

      IF InvoiceEverything AND AssignError THEN
        ERROR(Text033);
    END;

    LOCAL PROCEDURE ClearItemChargeAssgntFilter@27();
    BEGIN
      TempItemChargeAssgntSales.SETRANGE("Document Line No.");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.");
      TempItemChargeAssgntSales.MARKEDONLY(FALSE);
    END;

    LOCAL PROCEDURE GetItemChargeLine@5809(VAR ItemChargeSalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1001 : Record 111;
      ReturnReceiptLine@1003 : Record 6661;
      QtyShippedNotInvd@1002 : Decimal;
      QtyReceivedNotInvd@1004 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntSales DO
        IF (ItemChargeSalesLine."Document Type" <> "Document Type") OR
           (ItemChargeSalesLine."Document No." <> "Document No.") OR
           (ItemChargeSalesLine."Line No." <> "Document Line No.")
        THEN BEGIN
          ItemChargeSalesLine.GET("Document Type","Document No.","Document Line No.");
          IF NOT SalesHeader.Ship THEN
            ItemChargeSalesLine."Qty. to Ship" := 0;
          IF NOT SalesHeader.Receive THEN
            ItemChargeSalesLine."Return Qty. to Receive" := 0;
          IF ItemChargeSalesLine."Shipment No." <> '' THEN BEGIN
            SalesShptLine.GET(ItemChargeSalesLine."Shipment No.",ItemChargeSalesLine."Shipment Line No.");
            QtyShippedNotInvd := "Qty. to Assign" - "Qty. Assigned";
          END ELSE
            QtyShippedNotInvd := ItemChargeSalesLine."Quantity Shipped";
          IF ItemChargeSalesLine."Return Receipt No." <> '' THEN BEGIN
            ReturnReceiptLine.GET(ItemChargeSalesLine."Return Receipt No.",ItemChargeSalesLine."Return Receipt Line No.");
            QtyReceivedNotInvd := "Qty. to Assign" - "Qty. Assigned";
          END ELSE
            QtyReceivedNotInvd := ItemChargeSalesLine."Return Qty. Received";
          IF ABS(ItemChargeSalesLine."Qty. to Invoice") >
             ABS(QtyShippedNotInvd + ItemChargeSalesLine."Qty. to Ship" +
               QtyReceivedNotInvd + ItemChargeSalesLine."Return Qty. to Receive" -
               ItemChargeSalesLine."Quantity Invoiced")
          THEN
            ItemChargeSalesLine."Qty. to Invoice" :=
              QtyShippedNotInvd + ItemChargeSalesLine."Qty. to Ship" +
              QtyReceivedNotInvd + ItemChargeSalesLine."Return Qty. to Receive" -
              ItemChargeSalesLine."Quantity Invoiced";
        END;
    END;

    LOCAL PROCEDURE OnlyAssgntPosting@36() : Boolean;
    VAR
      SalesLine@1000 : Record 37;
      QtyLeftToAssign@1002 : Boolean;
    BEGIN
      WITH SalesHeader DO BEGIN
        ItemChargeAssgntOnly := FALSE;
        QtyLeftToAssign := FALSE;
        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        SalesLine.SETRANGE(Type,SalesLine.Type::"Charge (Item)");
        IF SalesLine.FINDSET THEN
          REPEAT
            SalesLine.CALCFIELDS("Qty. Assigned");
            IF SalesLine."Quantity Invoiced" > SalesLine."Qty. Assigned" THEN
              QtyLeftToAssign := TRUE;
          UNTIL SalesLine.NEXT = 0;

        IF QtyLeftToAssign THEN
          CopyAndCheckItemCharge(SalesHeader);
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntSales.SETCURRENTKEY("Applies-to Doc. Type");
        TempItemChargeAssgntSales.SETFILTER("Applies-to Doc. Type",'<>%1',"Document Type");
        SalesLine.SETRANGE(Type);
        SalesLine.SETRANGE("Quantity Invoiced");
        SalesLine.SETFILTER("Qty. to Assign",'<>0');
        IF SalesLine.FINDSET THEN
          REPEAT
            TempItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLine."Line No.");
            ItemChargeAssgntOnly := NOT TempItemChargeAssgntSales.ISEMPTY;
          UNTIL (SalesLine.NEXT = 0) OR ItemChargeAssgntOnly
        ELSE
          ItemChargeAssgntOnly := FALSE;
      END;
      EXIT(ItemChargeAssgntOnly);
    END;

    LOCAL PROCEDURE CalcQtyToInvoice@24(QtyToHandle@1000 : Decimal;QtyToInvoice@1001 : Decimal) : Decimal;
    BEGIN
      IF ABS(QtyToHandle) > ABS(QtyToInvoice) THEN
        EXIT(-QtyToHandle);

      EXIT(-QtyToInvoice);
    END;

    LOCAL PROCEDURE CheckWarehouse@7301(VAR SalesLine@1000 : Record 37);
    VAR
      SalesLine2@1001 : Record 37;
      WhseValidateSourceLine@1003 : Codeunit 5777;
      ShowError@1002 : Boolean;
    BEGIN
      SalesLine2.COPY(SalesLine);
      SalesLine2.SETRANGE(Type,SalesLine2.Type::Item);
      SalesLine2.SETRANGE("Drop Shipment",FALSE);
      IF SalesLine2.FINDSET THEN
        REPEAT
          GetLocation(SalesLine2."Location Code");
          CASE SalesLine2."Document Type" OF
            SalesLine2."Document Type"::Order:
              IF ((Location."Require Receive" OR Location."Require Put-away") AND
                  (SalesLine2.Quantity < 0)) OR
                 ((Location."Require Shipment" OR Location."Require Pick") AND
                  (SalesLine2.Quantity >= 0))
              THEN BEGIN
                IF Location."Directed Put-away and Pick" THEN
                  ShowError := TRUE
                ELSE
                  IF WhseValidateSourceLine.WhseLinesExist(
                       DATABASE::"Sales Line",
                       SalesLine2."Document Type",
                       SalesLine2."Document No.",
                       SalesLine2."Line No.",
                       0,
                       SalesLine2.Quantity)
                  THEN
                    ShowError := TRUE;
              END;
            SalesLine2."Document Type"::"Return Order":
              IF ((Location."Require Receive" OR Location."Require Put-away") AND
                  (SalesLine2.Quantity >= 0)) OR
                 ((Location."Require Shipment" OR Location."Require Pick") AND
                  (SalesLine2.Quantity < 0))
              THEN BEGIN
                IF Location."Directed Put-away and Pick" THEN
                  ShowError := TRUE
                ELSE
                  IF WhseValidateSourceLine.WhseLinesExist(
                       DATABASE::"Sales Line",
                       SalesLine2."Document Type",
                       SalesLine2."Document No.",
                       SalesLine2."Line No.",
                       0,
                       SalesLine2.Quantity)
                  THEN
                    ShowError := TRUE;
              END;
            SalesLine2."Document Type"::Invoice,SalesLine2."Document Type"::"Credit Memo":
              IF Location."Directed Put-away and Pick" THEN
                Location.TESTFIELD("Adjustment Bin Code");
          END;
          IF ShowError THEN
            ERROR(
              Text021,
              SalesLine2.FIELDCAPTION("Document Type"),
              SalesLine2."Document Type",
              SalesLine2.FIELDCAPTION("Document No."),
              SalesLine2."Document No.",
              SalesLine2.FIELDCAPTION("Line No."),
              SalesLine2."Line No.");
        UNTIL SalesLine2.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateWhseJnlLine@7302(ItemJnlLine@1000 : Record 83;SalesLine@1001 : Record 37;VAR TempWhseJnlLine@1002 : TEMPORARY Record 7311);
    VAR
      WhseMgt@1003 : Codeunit 5775;
    BEGIN
      WITH SalesLine DO BEGIN
        WMSMgmt.CheckAdjmtBin(Location,ItemJnlLine.Quantity,TRUE);
        WMSMgmt.CreateWhseJnlLine(ItemJnlLine,0,TempWhseJnlLine,FALSE);
        TempWhseJnlLine."Source Type" := DATABASE::"Sales Line";
        TempWhseJnlLine."Source Subtype" := "Document Type";
        TempWhseJnlLine."Source Code" := SrcCode;
        TempWhseJnlLine."Source Document" := WhseMgt.GetSourceDocument(TempWhseJnlLine."Source Type",TempWhseJnlLine."Source Subtype");
        TempWhseJnlLine."Source No." := "Document No.";
        TempWhseJnlLine."Source Line No." := "Line No.";
        CASE "Document Type" OF
          "Document Type"::Order:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Shipment";
          "Document Type"::Invoice:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted S. Inv.";
          "Document Type"::"Credit Memo":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted S. Cr. Memo";
          "Document Type"::"Return Order":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Rtrn. Shipment";
        END;
        TempWhseJnlLine."Reference No." := ItemJnlLine."Document No.";
      END;
    END;

    LOCAL PROCEDURE WhseHandlingRequired@7307() : Boolean;
    VAR
      WhseSetup@1000 : Record 5769;
    BEGIN
      IF (SalesLine.Type = SalesLine.Type::Item) AND
         (NOT SalesLine."Drop Shipment")
      THEN BEGIN
        IF SalesLine."Location Code" = '' THEN BEGIN
          WhseSetup.GET;
          IF SalesLine."Document Type" = SalesLine."Document Type"::"Return Order" THEN
            EXIT(WhseSetup."Require Receive");

          EXIT(WhseSetup."Require Shipment");
        END;

        GetLocation(SalesLine."Location Code");
        IF SalesLine."Document Type" = SalesLine."Document Type"::"Return Order" THEN
          EXIT(Location."Require Receive");

        EXIT(Location."Require Shipment");
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE GetLocation@7300(LocationCode@1000 : Code[10]);
    BEGIN
      IF LocationCode = '' THEN
        Location.GetLocationSetup(LocationCode,Location)
      ELSE
        IF Location.Code <> LocationCode THEN
          Location.GET(LocationCode);
    END;

    LOCAL PROCEDURE InsertShptEntryRelation@38(VAR SalesShptLine@1002 : Record 111) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempTrackingSpecificationInv.RESET;
      IF TempTrackingSpecificationInv.FINDSET THEN BEGIN
        REPEAT
          TempHandlingSpecification := TempTrackingSpecificationInv;
          IF TempHandlingSpecification.INSERT THEN;
        UNTIL TempTrackingSpecificationInv.NEXT = 0;
        TempTrackingSpecificationInv.DELETEALL;
      END;

      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.INIT;
          ItemEntryRelation."Item Entry No." := TempHandlingSpecification."Entry No.";
          ItemEntryRelation."Serial No." := TempHandlingSpecification."Serial No.";
          ItemEntryRelation."Lot No." := TempHandlingSpecification."Lot No.";
          ItemEntryRelation.TransferFieldsSalesShptLine(SalesShptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE InsertReturnEntryRelation@39(VAR ReturnRcptLine@1002 : Record 6661) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempTrackingSpecificationInv.RESET;
      IF TempTrackingSpecificationInv.FINDSET THEN BEGIN
        REPEAT
          TempHandlingSpecification := TempTrackingSpecificationInv;
          IF TempHandlingSpecification.INSERT THEN;
        UNTIL TempTrackingSpecificationInv.NEXT = 0;
        TempTrackingSpecificationInv.DELETEALL;
      END;

      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.INIT;
          ItemEntryRelation."Item Entry No." := TempHandlingSpecification."Entry No.";
          ItemEntryRelation."Serial No." := TempHandlingSpecification."Serial No.";
          ItemEntryRelation."Lot No." := TempHandlingSpecification."Lot No.";
          ItemEntryRelation.TransferFieldsReturnRcptLine(ReturnRcptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE CheckTrackingSpecification@46(VAR SalesLine@1019 : Record 37);
    VAR
      SalesLineToCheck@1000 : Record 37;
      ReservationEntry@1001 : Record 337;
      ItemTrackingCode@1009 : Record 6502;
      CreateReservEntry@1004 : Codeunit 99000830;
      ItemTrackingManagement@1015 : Codeunit 6500;
      ErrorFieldCaption@1018 : Text[250];
      SignFactor@1005 : Integer;
      SalesLineQtyToHandle@1023 : Decimal;
      TrackingQtyToHandle@1003 : Decimal;
      Inbound@1010 : Boolean;
      SNRequired@1011 : Boolean;
      LotRequired@1012 : Boolean;
      SNInfoRequired@1013 : Boolean;
      LotInfoRequired@1014 : Boolean;
      CheckSalesLine@1008 : Boolean;
    BEGIN
      // if a SalesLine is posted with ItemTracking then tracked quantity must be equal
      // to posted quantity

      IF SalesHeader."Document Type" IN
         [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::"Return Order"] = FALSE
      THEN
        EXIT;

      TrackingQtyToHandle := 0;

      SalesLineToCheck.COPY(SalesLine);
      SalesLineToCheck.SETRANGE(Type,SalesLineToCheck.Type::Item);
      IF SalesHeader.Ship THEN BEGIN
        SalesLineToCheck.SETFILTER("Quantity Shipped",'<>%1',0);
        ErrorFieldCaption := SalesLineToCheck.FIELDCAPTION("Qty. to Ship");
      END ELSE BEGIN
        SalesLineToCheck.SETFILTER("Return Qty. Received",'<>%1',0);
        ErrorFieldCaption := SalesLineToCheck.FIELDCAPTION("Return Qty. to Receive");
      END;

      IF SalesLineToCheck.FINDSET THEN BEGIN
        ReservationEntry."Source Type" := DATABASE::"Sales Line";
        ReservationEntry."Source Subtype" := SalesHeader."Document Type";
        SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
        REPEAT
          // Only Item where no SerialNo or LotNo is required
          GetItem(SalesLineToCheck);
          IF Item."Item Tracking Code" <> '' THEN BEGIN
            Inbound := (SalesLineToCheck.Quantity * SignFactor) > 0;
            ItemTrackingCode.Code := Item."Item Tracking Code";
            ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
              ItemJnlLine."Entry Type"::Sale,
              Inbound,
              SNRequired,
              LotRequired,
              SNInfoRequired,
              LotInfoRequired);
            CheckSalesLine := (SNRequired = FALSE) AND (LotRequired = FALSE);
            IF CheckSalesLine THEN
              CheckSalesLine := GetTrackingQuantities(SalesLineToCheck,0,TrackingQtyToHandle);
          END ELSE
            CheckSalesLine := FALSE;

          TrackingQtyToHandle := 0;

          IF CheckSalesLine THEN BEGIN
            GetTrackingQuantities(SalesLineToCheck,1,TrackingQtyToHandle);
            TrackingQtyToHandle := TrackingQtyToHandle * SignFactor;
            IF SalesHeader.Ship THEN
              SalesLineQtyToHandle := SalesLineToCheck."Qty. to Ship (Base)"
            ELSE
              SalesLineQtyToHandle := SalesLineToCheck."Return Qty. to Receive (Base)";
            IF TrackingQtyToHandle <> SalesLineQtyToHandle THEN
              //ERROR(STRSUBSTNO(Text046,ErrorFieldCaption)); //**4PS.o DP00121
              ERROR(STRSUBSTNO(Text046,ErrorFieldCaption,SalesLineToCheck."No.")); //**4PS.n DP00121
          END;
        UNTIL SalesLineToCheck.NEXT = 0;
      END;

      //**4PS.sn DP00121
      SalesLineToCheck.COPY(SalesLine);
      SalesLineToCheck.SETRANGE(Type,SalesLineToCheck.Type::"G/L Account");
      SalesLineToCheck.SETFILTER("Item No.", '<>%1', '');
      IF SalesHeader.Ship THEN
        ErrorFieldCaption := SalesLineToCheck.FIELDCAPTION("Qty. to Ship")
      ELSE
        ErrorFieldCaption := SalesLineToCheck.FIELDCAPTION("Return Qty. to Receive");

      IF SalesLineToCheck.FINDSET THEN BEGIN
        ReservationEntry."Source Type" := DATABASE::"Sales Line";
        ReservationEntry."Source Subtype" := SalesHeader."Document Type";
        SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
        REPEAT
          // Only Item where no SerialNo or LotNo is required
          Item.GET(SalesLineToCheck."Item No.");
          IF Item."Item Tracking Code" <> '' THEN BEGIN
            Inbound := (SalesLineToCheck.Quantity * SignFactor) > 0;
            ItemTrackingCode.Code := Item."Item Tracking Code";
            ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
              ItemJnlLine."Entry Type"::Sale,
              Inbound,
              SNRequired,
              LotRequired,
              SNInfoRequired,
              LotInfoRequired);
            IF CheckSalesLine THEN
              CheckSalesLine := GetTrackingQuantities(SalesLineToCheck,0,TrackingQtyToHandle);
          END ELSE
            CheckSalesLine := FALSE;

          TrackingQtyToHandle := 0;

          IF CheckSalesLine THEN BEGIN
            GetTrackingQuantities(SalesLineToCheck,1,TrackingQtyToHandle);
            TrackingQtyToHandle := TrackingQtyToHandle * SignFactor;
            IF SalesHeader.Ship THEN
              SalesLineQtyToHandle := SalesLineToCheck."Qty. to Ship (Base)"
            ELSE
              SalesLineQtyToHandle := SalesLineToCheck."Return Qty. to Receive (Base)";

            IF TrackingQtyToHandle <> SalesLineQtyToHandle THEN
              ERROR(STRSUBSTNO(Text046,ErrorFieldCaption,SalesLineToCheck."Item No."));
          END;
        UNTIL SalesLineToCheck.NEXT = 0;
      END;
      //**4PS.en
    END;

    LOCAL PROCEDURE GetTrackingQuantities@47(SalesLine@1000 : Record 37;FunctionType@1002 : 'CheckTrackingExists,GetQty';VAR TrackingQtyToHandle@1003 : Decimal) : Boolean;
    VAR
      TrackingSpecification@1004 : Record 336;
      ReservEntry@1001 : Record 337;
      NSTrackingSpecification@1100528601 : Record 11071901;
      NSReservEntry@1100528600 : Record 11071900;
    BEGIN
      WITH TrackingSpecification DO BEGIN
        SETCURRENTKEY("Source ID","Source Type","Source Subtype","Source Batch Name",
          "Source Prod. Order Line","Source Ref. No.");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source ID",SalesLine."Document No.");
        SETRANGE("Source Batch Name",'');
        SETRANGE("Source Prod. Order Line",0);
        SETRANGE("Source Ref. No.",SalesLine."Line No.");
      END;
      WITH ReservEntry DO BEGIN
        SETCURRENTKEY(
          "Source ID","Source Ref. No.","Source Type","Source Subtype",
          "Source Batch Name","Source Prod. Order Line");
        SETRANGE("Source ID",SalesLine."Document No.");
        SETRANGE("Source Ref. No.",SalesLine."Line No.");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source Batch Name",'');
        SETRANGE("Source Prod. Order Line",0);
      END;

      //**4PS.sn DP00121
      WITH NSTrackingSpecification DO BEGIN
        SETCURRENTKEY("Source ID","Source Type","Source Subtype","Source Batch Name",
          "Source Prod. Order Line","Source Ref. No.");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source ID",SalesLine."Document No.");
        SETRANGE("Source Batch Name",'');
        SETRANGE("Source Prod. Order Line",0);
        SETRANGE("Source Ref. No.",SalesLine."Line No.");
      END;
      WITH NSReservEntry DO BEGIN
        SETCURRENTKEY(
          "Source ID","Source Ref. No.","Source Type","Source Subtype",
          "Source Batch Name","Source Prod. Order Line");
        SETRANGE("Source ID",SalesLine."Document No.");
        SETRANGE("Source Ref. No.",SalesLine."Line No.");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source Batch Name",'');
        SETRANGE("Source Prod. Order Line",0);
      END;
      //**4PS.en

      CASE FunctionType OF
        FunctionType::CheckTrackingExists:
          BEGIN
            TrackingSpecification.SETRANGE(Correction,FALSE);
            IF NOT TrackingSpecification.ISEMPTY THEN
              EXIT(TRUE);
            ReservEntry.SETFILTER("Serial No.",'<>%1','');
            IF NOT ReservEntry.ISEMPTY THEN
              EXIT(TRUE);
            ReservEntry.SETRANGE("Serial No.");
            ReservEntry.SETFILTER("Lot No.",'<>%1','');
            IF NOT ReservEntry.ISEMPTY THEN
              EXIT(TRUE);
            //**4PS.sn DP00121
            NSTrackingSpecification.SETRANGE(Correction,FALSE);
            IF NOT NSTrackingSpecification.ISEMPTY THEN
              EXIT(TRUE);
            NSReservEntry.SETFILTER("Serial No.",'<>%1','');
            IF NOT NSReservEntry.ISEMPTY THEN
              EXIT(TRUE);
            NSReservEntry.SETRANGE("Serial No.");
            NSReservEntry.SETFILTER("Lot No.",'<>%1','');
            IF NOT NSReservEntry.ISEMPTY THEN
              EXIT(TRUE);
            //**4PS.en
          END;
        FunctionType::GetQty:
          BEGIN
            IF ReservEntry.FINDSET THEN
              REPEAT
                IF (ReservEntry."Lot No." <> '') OR (ReservEntry."Serial No." <> '') THEN
                  TrackingQtyToHandle := TrackingQtyToHandle + ReservEntry."Qty. to Handle (Base)";
              UNTIL ReservEntry.NEXT = 0;
            //**4PS.sn DP00121
            IF NSReservEntry.FINDSET THEN
              REPEAT
                IF (NSReservEntry."Lot No." <> '') OR (NSReservEntry."Serial No." <> '') THEN
                  TrackingQtyToHandle := TrackingQtyToHandle + NSReservEntry."Qty. to Handle (Base)";
              UNTIL NSReservEntry.NEXT = 0;
            //**4PS.en
          END;
      END;
    END;

    LOCAL PROCEDURE SaveInvoiceSpecification@37(VAR TempInvoicingSpecification@1000 : TEMPORARY Record 336);
    BEGIN
      TempInvoicingSpecification.RESET;
      IF TempInvoicingSpecification.FINDSET THEN BEGIN
        REPEAT
          TempInvoicingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
          TempTrackingSpecification := TempInvoicingSpecification;
          TempTrackingSpecification."Buffer Status" := TempTrackingSpecification."Buffer Status"::MODIFY;
          IF NOT TempTrackingSpecification.INSERT THEN BEGIN
            TempTrackingSpecification.GET(TempInvoicingSpecification."Entry No.");
            TempTrackingSpecification."Qty. to Invoice (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            IF TempInvoicingSpecification."Qty. to Invoice (Base)" = TempInvoicingSpecification."Quantity Invoiced (Base)" THEN
              TempTrackingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Quantity Invoiced (Base)"
            ELSE
              TempTrackingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            TempTrackingSpecification."Qty. to Invoice" += TempInvoicingSpecification."Qty. to Invoice";
            TempTrackingSpecification.MODIFY;
          END;
        UNTIL TempInvoicingSpecification.NEXT = 0;
        TempInvoicingSpecification.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE InsertTrackingSpecification@35();
    VAR
      TrackingSpecification@1000 : Record 336;
    BEGIN
      TempTrackingSpecification.RESET;
      IF TempTrackingSpecification.FINDSET THEN BEGIN
        REPEAT
          TrackingSpecification := TempTrackingSpecification;
          TrackingSpecification."Buffer Status" := 0;
          TrackingSpecification.Correction := FALSE;
          TrackingSpecification.InitQtyToShip;
          TrackingSpecification."Quantity actual Handled (Base)" := 0;
          IF TempTrackingSpecification."Buffer Status" = TempTrackingSpecification."Buffer Status"::MODIFY THEN
            TrackingSpecification.MODIFY
          ELSE
            TrackingSpecification.INSERT;
        UNTIL TempTrackingSpecification.NEXT = 0;
        TempTrackingSpecification.DELETEALL;
      END;

      ReserveSalesLine.UpdateItemTrackingAfterPosting(SalesHeader);
    END;

    LOCAL PROCEDURE InsertValueEntryRelation@40();
    VAR
      ValueEntryRelation@1000 : Record 6508;
    BEGIN
      TempValueEntryRelation.RESET;
      IF TempValueEntryRelation.FINDSET THEN BEGIN
        REPEAT
          ValueEntryRelation := TempValueEntryRelation;
          ValueEntryRelation.INSERT;
        UNTIL TempValueEntryRelation.NEXT = 0;
        TempValueEntryRelation.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE PostItemCharge@42(VAR SalesLine@1005 : Record 37;ItemEntryNo@1004 : Integer;QuantityBase@1003 : Decimal;AmountToAssign@1002 : Decimal;QtyToAssign@1001 : Decimal);
    VAR
      DummyTrackingSpecification@1000 : Record 336;
      SalesLineToPost@1006 : Record 37;
      CurrExchRate@1007 : Record 330;
      TotalChargeAmt@1008 : Decimal;
      TotalChargeAmtLCY@1009 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntSales DO BEGIN
        SalesLineToPost := SalesLine;
        SalesLineToPost."No." := "Item No.";
        SalesLineToPost."Appl.-to Item Entry" := ItemEntryNo;
        IF NOT ("Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]) THEN
          SalesLineToPost.Amount := -AmountToAssign
        ELSE
          SalesLineToPost.Amount := AmountToAssign;

        IF SalesLineToPost."Currency Code" <> '' THEN
          SalesLineToPost."Unit Cost" := ROUND(
              -SalesLineToPost.Amount / QuantityBase,Currency."Unit-Amount Rounding Precision")
        ELSE
          SalesLineToPost."Unit Cost" := ROUND(
              -SalesLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");
        TotalChargeAmt := TotalChargeAmt + SalesLineToPost.Amount;

        IF SalesHeader."Currency Code" <> '' THEN
          SalesLineToPost.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
              UseDate,SalesHeader."Currency Code",
      //      TotalChargeAmt,SalesHeader."Currency Factor"); //**4PS.o
              TotalChargeAmt,SalesHeader."Currency Factor",TRUE); //**4PS.n
        SalesLineToPost."Inv. Discount Amount" := ROUND(
            SalesLine."Inv. Discount Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLineToPost."Line Discount Amount" := ROUND(
            SalesLine."Line Discount Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLineToPost."Line Amount" := ROUND(
            SalesLine."Line Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLine."Inv. Discount Amount" := SalesLine."Inv. Discount Amount" - SalesLineToPost."Inv. Discount Amount";
        SalesLine."Line Discount Amount" := SalesLine."Line Discount Amount" - SalesLineToPost."Line Discount Amount";
        SalesLine."Line Amount" := SalesLine."Line Amount" - SalesLineToPost."Line Amount";
        SalesLine.Quantity := SalesLine.Quantity - QtyToAssign;
        SalesLineToPost.Amount := ROUND(SalesLineToPost.Amount,GLSetup."Amount Rounding Precision") - TotalChargeAmtLCY;
        IF SalesHeader."Currency Code" <> '' THEN
          TotalChargeAmtLCY := TotalChargeAmtLCY + SalesLineToPost.Amount;
        SalesLineToPost."Unit Cost (LCY)" := ROUND(
            SalesLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");
        UpdateSalesLineDimSetIDFromAppliedEntry(SalesLineToPost,SalesLine);
        SalesLineToPost."Line No." := "Document Line No.";
        PostItemJnlLine(
          SalesLineToPost,
          0,0,-QuantityBase,-QuantityBase,
          SalesLineToPost."Appl.-to Item Entry",
          "Item Charge No.",DummyTrackingSpecification,FALSE);
      END;
    END;

    LOCAL PROCEDURE SaveTempWhseSplitSpec@31(VAR SalesLine3@1000 : Record 37);
    BEGIN
      TempWhseSplitSpecification.RESET;
      TempWhseSplitSpecification.DELETEALL;
      IF TempHandlingSpecification.FINDSET THEN
        REPEAT
          TempWhseSplitSpecification := TempHandlingSpecification;
          TempWhseSplitSpecification."Source Type" := DATABASE::"Sales Line";
          TempWhseSplitSpecification."Source Subtype" := SalesLine3."Document Type";
          TempWhseSplitSpecification."Source ID" := SalesLine3."Document No.";
          TempWhseSplitSpecification."Source Ref. No." := SalesLine3."Line No.";
          TempWhseSplitSpecification.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
    END;

    LOCAL PROCEDURE TransferReservToItemJnlLine@32(VAR SalesOrderLine@1000 : Record 37;VAR ItemJnlLine@1001 : Record 83;QtyToBeShippedBase@1002 : Decimal;VAR TempTrackingSpecification2@1003 : TEMPORARY Record 336;VAR CheckApplFromItemEntry@1004 : Boolean);
    BEGIN
      // Handle Item Tracking and reservations, also on drop shipment
      IF QtyToBeShippedBase = 0 THEN
        EXIT;

      CLEAR(ReserveSalesLine);
      IF NOT SalesOrderLine."Drop Shipment" THEN
        IF NOT HasSpecificTracking(SalesOrderLine."No.") AND HasInvtPickLine(SalesOrderLine) THEN
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,TRUE)
        ELSE
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
      ELSE BEGIN
        TempTrackingSpecification2.RESET;
        TempTrackingSpecification2.SETRANGE("Source Type",DATABASE::"Purchase Line");
        TempTrackingSpecification2.SETRANGE("Source Subtype",1);
        TempTrackingSpecification2.SETRANGE("Source ID",SalesOrderLine."Purchase Order No.");
        TempTrackingSpecification2.SETRANGE("Source Batch Name",'');
        TempTrackingSpecification2.SETRANGE("Source Prod. Order Line",0);
        TempTrackingSpecification2.SETRANGE("Source Ref. No.",SalesOrderLine."Purch. Order Line No.");
        IF TempTrackingSpecification2.ISEMPTY THEN
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
        ELSE BEGIN
          ReserveSalesLine.SetApplySpecificItemTracking(TRUE);
          ReserveSalesLine.SetOverruleItemTracking(TRUE);
          ReserveSalesLine.SetItemTrkgAlreadyOverruled(ItemTrkgAlreadyOverruled);
          TempTrackingSpecification2.FINDSET;
          IF TempTrackingSpecification2."Quantity (Base)" / QtyToBeShippedBase < 0 THEN
            ERROR(Text043);
          REPEAT
            ItemJnlLine."Serial No." := TempTrackingSpecification2."Serial No.";
            ItemJnlLine."Lot No." := TempTrackingSpecification2."Lot No.";
            ItemJnlLine."Applies-to Entry" := TempTrackingSpecification2."Item Ledger Entry No.";
            ReserveSalesLine.TransferSalesLineToItemJnlLine(SalesOrderLine,ItemJnlLine,
              TempTrackingSpecification2."Quantity (Base)",CheckApplFromItemEntry,FALSE);
          UNTIL TempTrackingSpecification2.NEXT = 0;
          ItemJnlLine."Serial No." := '';
          ItemJnlLine."Lot No." := '';
          ItemJnlLine."Applies-to Entry" := 0;
        END;
      END;
    END;

    LOCAL PROCEDURE TransferReservFromPurchLine@41(VAR PurchOrderLine@1000 : Record 39;VAR ItemJnlLine@1001 : Record 83;QtyToBeShippedBase@1002 : Decimal);
    VAR
      ReservEntry@1004 : Record 337;
      TempTrackingSpecification2@1005 : TEMPORARY Record 336;
      ReservePurchLine@1003 : Codeunit 99000834;
      RemainingQuantity@1006 : Decimal;
      CheckApplToItemEntry@1007 : Boolean;
    BEGIN
      // Handle Item Tracking on Drop Shipment
      ItemTrkgAlreadyOverruled := FALSE;
      IF QtyToBeShippedBase = 0 THEN
        EXIT;

      ReservEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype",
        "Source Batch Name","Source Prod. Order Line");
      ReservEntry.SETRANGE("Source ID",SalesLine."Document No.");
      ReservEntry.SETRANGE("Source Ref. No.",SalesLine."Line No.");
      ReservEntry.SETRANGE("Source Type",DATABASE::"Sales Line");
      ReservEntry.SETRANGE("Source Subtype",SalesLine."Document Type");
      ReservEntry.SETRANGE("Source Batch Name",'');
      ReservEntry.SETRANGE("Source Prod. Order Line",0);
      ReservEntry.SETFILTER("Qty. to Handle (Base)",'<>0');
      IF NOT ReservEntry.ISEMPTY THEN
        ItemTrackingMgt.SumUpItemTracking(ReservEntry,TempTrackingSpecification2,FALSE,TRUE);
      TempTrackingSpecification2.SETFILTER("Qty. to Handle (Base)",'<>0');
      IF TempTrackingSpecification2.ISEMPTY THEN
        ReservePurchLine.TransferPurchLineToItemJnlLine(
          PurchOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplToItemEntry)
      ELSE BEGIN
        ReservePurchLine.SetOverruleItemTracking(TRUE);
        ItemTrkgAlreadyOverruled := TRUE;
        TempTrackingSpecification2.FINDSET;
        IF -TempTrackingSpecification2."Quantity (Base)" / QtyToBeShippedBase < 0 THEN
          ERROR(Text043);
        REPEAT
          ItemJnlLine."Serial No." := TempTrackingSpecification2."Serial No.";
          ItemJnlLine."Lot No." := TempTrackingSpecification2."Lot No.";
          RemainingQuantity :=
            ReservePurchLine.TransferPurchLineToItemJnlLine(
              PurchOrderLine,ItemJnlLine,
              -TempTrackingSpecification2."Qty. to Handle (Base)",CheckApplToItemEntry);
          IF RemainingQuantity <> 0 THEN
            ERROR(Text044);
        UNTIL TempTrackingSpecification2.NEXT = 0;
        ItemJnlLine."Serial No." := '';
        ItemJnlLine."Lot No." := '';
        ItemJnlLine."Applies-to Entry" := 0;
      END;
    END;

    PROCEDURE SetWhseRcptHeader@43(VAR WhseRcptHeader2@1000 : Record 7316);
    BEGIN
      WhseRcptHeader := WhseRcptHeader2;
      TempWhseRcptHeader := WhseRcptHeader;
      TempWhseRcptHeader.INSERT;
    END;

    PROCEDURE SetWhseShptHeader@44(VAR WhseShptHeader2@1000 : Record 7320);
    BEGIN
      WhseShptHeader := WhseShptHeader2;
      TempWhseShptHeader := WhseShptHeader;
      TempWhseShptHeader.INSERT;
    END;

    LOCAL PROCEDURE CopyPurchCommentLines@148(FromDocumentType@1000 : Integer;ToDocumentType@1001 : Integer;FromNumber@1002 : Code[20];ToNumber@1003 : Code[20]);
    VAR
      PurchCommentLine@1004 : Record 43;
      PurchCommentLine2@1005 : Record 43;
    BEGIN
      PurchCommentLine.SETRANGE("Document Type",FromDocumentType);
      PurchCommentLine.SETRANGE("No.",FromNumber);
      IF PurchCommentLine.FINDSET THEN
        REPEAT
          PurchCommentLine2 := PurchCommentLine;
          PurchCommentLine2."Document Type" := ToDocumentType;
          PurchCommentLine2."No." := ToNumber;
          PurchCommentLine2.INSERT;
        UNTIL PurchCommentLine.NEXT = 0;
    END;

    LOCAL PROCEDURE GetItem@49(SalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        TESTFIELD(Type,Type::Item);
        TESTFIELD("No.");
        IF "No." <> Item."No." THEN
          Item.GET("No.");
      END;
    END;

    LOCAL PROCEDURE GetNextSalesline@50(VAR SalesLine@1000 : Record 37) : Boolean;
    BEGIN
      IF NOT SalesLinesProcessed THEN
        IF SalesLine.NEXT = 1 THEN
          EXIT(FALSE);
      SalesLinesProcessed := TRUE;
      IF TempPrepaymentSalesLine.FIND('-') THEN BEGIN
        SalesLine := TempPrepaymentSalesLine;
        TempPrepaymentSalesLine.DELETE;
        EXIT(FALSE);
      END;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE CreatePrepaymentLines@51(SalesHeader@1003 : Record 36;VAR TempPrepmtSalesLine@1004 : Record 37;CompleteFunctionality@1009 : Boolean);
    VAR
      GLAcc@1002 : Record 15;
      SalesLine@1000 : Record 37;
      TempExtTextLine@1012 : TEMPORARY Record 280;
      GenPostingSetup@1005 : Record 252;
      TransferExtText@1011 : Codeunit 378;
      NextLineNo@1001 : Integer;
      Fraction@1008 : Decimal;
      VATDifference@1015 : Decimal;
      TempLineFound@1010 : Boolean;
      PrePmtTestRun@1014 : Boolean;
      PrepmtAmtToDeduct@1016 : Decimal;
    BEGIN
      GetGLSetup;
      WITH SalesLine DO BEGIN
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        IF NOT FIND('+') THEN
          EXIT;
        NextLineNo := "Line No." + 10000;
        SETFILTER(Quantity,'>0');
        SETFILTER("Qty. to Invoice",'>0');
        TempPrepmtSalesLine.SetHasBeenShown;
        IF FIND('-') THEN
          REPEAT
            IF CompleteFunctionality THEN
              IF SalesHeader."Document Type" <> SalesHeader."Document Type"::Invoice THEN BEGIN
                IF NOT SalesHeader.Ship AND ("Qty. to Invoice" = Quantity - "Quantity Invoiced") THEN
                  IF "Qty. Shipped Not Invoiced" < "Qty. to Invoice" THEN
                    VALIDATE("Qty. to Invoice","Qty. Shipped Not Invoiced");
                Fraction := ("Qty. to Invoice" + "Quantity Invoiced") / Quantity;

                IF "Prepayment %" <> 100 THEN
                  CASE TRUE OF
                    ("Prepmt Amt to Deduct" <> 0) AND
                    ("Prepmt Amt to Deduct" > ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision")):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(Text047,
                          ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision")));
                    ("Prepmt. Amt. Inv." <> 0) AND
                    (ROUND((1 - Fraction) * "Line Amount",Currency."Amount Rounding Precision") <
                     ROUND(
                       ROUND(
                         ROUND("Unit Price" * (Quantity - "Quantity Invoiced" - "Qty. to Invoice"),Currency."Amount Rounding Precision") *
                         (1 - ("Line Discount %" / 100)),Currency."Amount Rounding Precision") *
                       "Prepayment %" / 100,Currency."Amount Rounding Precision")):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(Text048,
                          ROUND(
                            "Prepmt. Amt. Inv." - "Prepmt Amt Deducted" - (1 - Fraction) * "Line Amount",
                            Currency."Amount Rounding Precision")));
                  END;
              END ELSE
                IF NOT PrePmtTestRun THEN BEGIN
                  TestGetShipmentPPmtAmtToDeduct(SalesHeader);
                  PrePmtTestRun := TRUE;
                END;
            IF "Prepmt Amt to Deduct" <> 0 THEN BEGIN
              IF ("Gen. Bus. Posting Group" <> GenPostingSetup."Gen. Bus. Posting Group") OR
                 ("Gen. Prod. Posting Group" <> GenPostingSetup."Gen. Prod. Posting Group")
              THEN BEGIN
                GenPostingSetup.GET("Gen. Bus. Posting Group","Gen. Prod. Posting Group");
                GenPostingSetup.TESTFIELD("Sales Prepayments Account");
              END;
              GLAcc.GET(GenPostingSetup."Sales Prepayments Account");
              TempLineFound := FALSE;
              IF SalesHeader."Compress Prepayment" THEN BEGIN
                TempPrepmtSalesLine.SETRANGE("No.",GLAcc."No.");
                TempPrepmtSalesLine.SETRANGE("Dimension Set ID","Dimension Set ID");
                TempLineFound := TempPrepmtSalesLine.FINDFIRST;
              END;
              IF TempLineFound THEN BEGIN
                PrepmtAmtToDeduct :=
                  TempPrepmtSalesLine."Prepmt Amt to Deduct" +
                  InsertedPrepmtVATBaseToDeduct(SalesLine,TempPrepmtSalesLine."Line No.",TempPrepmtSalesLine."Unit Price");
                VATDifference := TempPrepmtSalesLine."VAT Difference";
                TempPrepmtSalesLine.VALIDATE(
                  "Unit Price",TempPrepmtSalesLine."Unit Price" + "Prepmt Amt to Deduct");
                TempPrepmtSalesLine.VALIDATE("VAT Difference",VATDifference - "Prepmt VAT Diff. to Deduct");
                TempPrepmtSalesLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                IF "Prepayment %" < TempPrepmtSalesLine."Prepayment %" THEN
                  TempPrepmtSalesLine."Prepayment %" := "Prepayment %";
                TempPrepmtSalesLine.MODIFY;
              END ELSE BEGIN
                TempPrepmtSalesLine.INIT;
                TempPrepmtSalesLine."Document Type" := SalesHeader."Document Type";
                TempPrepmtSalesLine."Document No." := SalesHeader."No.";
                TempPrepmtSalesLine."Line No." := 0;
                TempPrepmtSalesLine."System-Created Entry" := TRUE;
                IF CompleteFunctionality THEN
                  TempPrepmtSalesLine.VALIDATE(Type,TempPrepmtSalesLine.Type::"G/L Account")
                ELSE
                  TempPrepmtSalesLine.Type := TempPrepmtSalesLine.Type::"G/L Account";
                TempPrepmtSalesLine.VALIDATE("No.",GenPostingSetup."Sales Prepayments Account");
                TempPrepmtSalesLine.VALIDATE(Quantity,-1);
                TempPrepmtSalesLine."Qty. to Ship" := TempPrepmtSalesLine.Quantity;
                TempPrepmtSalesLine."Qty. to Invoice" := TempPrepmtSalesLine.Quantity;
                PrepmtAmtToDeduct := InsertedPrepmtVATBaseToDeduct(SalesLine,NextLineNo,0);
                TempPrepmtSalesLine.VALIDATE("Unit Price","Prepmt Amt to Deduct");
                TempPrepmtSalesLine.VALIDATE("VAT Difference",-"Prepmt VAT Diff. to Deduct");
                TempPrepmtSalesLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                TempPrepmtSalesLine."Prepayment %" := "Prepayment %";
                TempPrepmtSalesLine."Prepayment Line" := TRUE;
                TempPrepmtSalesLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                TempPrepmtSalesLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                TempPrepmtSalesLine."Dimension Set ID" := "Dimension Set ID";
                TempPrepmtSalesLine."Line No." := NextLineNo;
                NextLineNo := NextLineNo + 10000;
                TempPrepmtSalesLine.INSERT;

                TransferExtText.PrepmtGetAnyExtText(
                  TempPrepmtSalesLine."No.",DATABASE::"Sales Invoice Line",
                  SalesHeader."Document Date",SalesHeader."Language Code",TempExtTextLine);
                IF TempExtTextLine.FIND('-') THEN
                  REPEAT
                    TempPrepmtSalesLine.INIT;
                    TempPrepmtSalesLine.Description := TempExtTextLine.Text;
                    TempPrepmtSalesLine."System-Created Entry" := TRUE;
                    TempPrepmtSalesLine."Prepayment Line" := TRUE;
                    TempPrepmtSalesLine."Line No." := NextLineNo;
                    NextLineNo := NextLineNo + 10000;
                    TempPrepmtSalesLine.INSERT;
                  UNTIL TempExtTextLine.NEXT = 0;
              END;
            END;
          UNTIL NEXT = 0
      END;
      DividePrepmtAmountLCY(TempPrepmtSalesLine,SalesHeader);
    END;

    LOCAL PROCEDURE InsertedPrepmtVATBaseToDeduct@82(SalesLine@1000 : Record 37;PrepmtLineNo@1001 : Integer;TotalPrepmtAmtToDeduct@1002 : Decimal) : Decimal;
    VAR
      PrepmtVATBaseToDeduct@1003 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        IF SalesHeader."Prices Including VAT" THEN
          PrepmtVATBaseToDeduct :=
            ROUND(
              (TotalPrepmtAmtToDeduct + "Prepmt Amt to Deduct") / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision") -
            ROUND(
              TotalPrepmtAmtToDeduct / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision")
        ELSE
          PrepmtVATBaseToDeduct := "Prepmt Amt to Deduct";
      END;
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        TempPrepmtDeductLCYSalesLine := SalesLine;
        IF "Document Type" = "Document Type"::Order THEN
          "Qty. to Invoice" := GetQtyToInvoice(SalesLine)
        ELSE
          GetLineDataFromOrder(TempPrepmtDeductLCYSalesLine);
        CalcPrepaymentToDeduct;
        "Line Amount" := GetLineAmountToHandle("Qty. to Invoice");
        "Attached to Line No." := PrepmtLineNo;
        "VAT Base Amount" := PrepmtVATBaseToDeduct;
        INSERT;
      END;
      EXIT(PrepmtVATBaseToDeduct);
    END;

    LOCAL PROCEDURE DividePrepmtAmountLCY@83(VAR PrepmtSalesLine@1000 : Record 37;SalesHeader@1006 : Record 36);
    VAR
      CurrExchRate@1001 : Record 330;
      ActualCurrencyFactor@1002 : Decimal;
    BEGIN
      WITH PrepmtSalesLine DO BEGIN
        RESET;
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            IF SalesHeader."Currency Code" <> '' THEN
              ActualCurrencyFactor :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                    0, '', //**4PS.n
                    SalesHeader."Posting Date",
                    SalesHeader."Currency Code",
                    "Prepmt Amt to Deduct",
                    //SalesHeader."Currency Factor")) / //**4PS.o
                    SalesHeader."Currency Factor",TRUE)) /  //**4PS.n
                "Prepmt Amt to Deduct"
            ELSE
              ActualCurrencyFactor := 1;

            UpdatePrepmtAmountInvBuf("Line No.",ActualCurrencyFactor);
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtAmountInvBuf@92(PrepmtSalesLineNo@1000 : Integer;CurrencyFactor@1004 : Decimal);
    VAR
      PrepmtAmtRemainder@1002 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        RESET;
        SETRANGE("Attached to Line No.",PrepmtSalesLineNo);
        IF FINDSET(TRUE) THEN
          REPEAT
            "Prepmt. Amount Inv. (LCY)" :=
              CalcRoundedAmount(CurrencyFactor * "VAT Base Amount",PrepmtAmtRemainder);
            MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE AdjustPrepmtAmountLCY@84(VAR PrepmtSalesLine@1000 : Record 37);
    VAR
      SalesLine@1005 : Record 37;
      SalesInvoiceLine@1013 : Record 37;
      DeductionFactor@1001 : Decimal;
      PrepmtVATPart@1009 : Decimal;
      PrepmtVATAmtRemainder@1010 : Decimal;
      TotalRoundingAmount@1011 : ARRAY [2] OF Decimal;
      TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;
      FinalInvoice@1003 : Boolean;
      PricesInclVATRoundingAmount@1004 : ARRAY [2] OF Decimal;
    BEGIN
      IF PrepmtSalesLine."Prepayment Line" THEN BEGIN
        PrepmtVATPart :=
          (PrepmtSalesLine."Amount Including VAT" - PrepmtSalesLine.Amount) / PrepmtSalesLine."Unit Price";

        WITH TempPrepmtDeductLCYSalesLine DO BEGIN
          RESET;
          SETRANGE("Attached to Line No.",PrepmtSalesLine."Line No.");
          IF FINDSET(TRUE) THEN BEGIN
            FinalInvoice := IsFinalInvoice;
            REPEAT
              SalesLine := TempPrepmtDeductLCYSalesLine;
              SalesLine.FIND;
              IF "Document Type" = "Document Type"::Invoice THEN BEGIN
                SalesInvoiceLine := SalesLine;
                GetSalesOrderLine(SalesLine,SalesInvoiceLine);
                SalesLine."Qty. to Invoice" := SalesInvoiceLine."Qty. to Invoice";
              END;
              IF SalesLine."Qty. to Invoice" <> "Qty. to Invoice" THEN
                SalesLine."Prepmt Amt to Deduct" := CalcPrepmtAmtToDeduct(SalesLine);
              DeductionFactor :=
                SalesLine."Prepmt Amt to Deduct" /
                (SalesLine."Prepmt. Amt. Inv." - SalesLine."Prepmt Amt Deducted");

              "Prepmt. VAT Amount Inv. (LCY)" :=
                CalcRoundedAmount(SalesLine."Prepmt Amt to Deduct" * PrepmtVATPart,PrepmtVATAmtRemainder);
              IF ("Prepayment %" <> 100) OR IsFinalInvoice THEN
                CalcPrepmtRoundingAmounts(TempPrepmtDeductLCYSalesLine,SalesLine,DeductionFactor,TotalRoundingAmount);
              MODIFY;

              IF SalesHeader."Prices Including VAT" THEN
                IF (("Prepayment %" <> 100) OR IsFinalInvoice) AND (DeductionFactor = 1) THEN BEGIN
                  PricesInclVATRoundingAmount[1] := TotalRoundingAmount[1];
                  PricesInclVATRoundingAmount[2] := TotalRoundingAmount[2];
                END;

              IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN
                TotalPrepmtAmount[1] += "Prepmt. Amount Inv. (LCY)";
              TotalPrepmtAmount[2] += "Prepmt. VAT Amount Inv. (LCY)";
              FinalInvoice := FinalInvoice AND IsFinalInvoice;
            UNTIL NEXT = 0;
          END;
        END;

        UpdatePrepmtSalesLineWithRounding(
          PrepmtSalesLine,TotalRoundingAmount,TotalPrepmtAmount,
          FinalInvoice,PricesInclVATRoundingAmount);
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtAmtToDeduct@93(SalesLine@1000 : Record 37) : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        "Qty. to Invoice" := GetQtyToInvoice(SalesLine);
        CalcPrepaymentToDeduct;
        EXIT("Prepmt Amt to Deduct");
      END;
    END;

    LOCAL PROCEDURE GetQtyToInvoice@100(SalesLine@1000 : Record 37) : Decimal;
    VAR
      AllowedQtyToInvoice@1001 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        AllowedQtyToInvoice := "Qty. Shipped Not Invoiced";
        IF SalesHeader.Ship THEN
          AllowedQtyToInvoice := AllowedQtyToInvoice + "Qty. to Ship";
        IF "Qty. to Invoice" > AllowedQtyToInvoice THEN
          EXIT(AllowedQtyToInvoice);
        EXIT("Qty. to Invoice");
      END;
    END;

    LOCAL PROCEDURE GetLineDataFromOrder@94(VAR SalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1001 : Record 111;
      SalesOrderLine@1002 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        SalesShptLine.GET("Shipment No.","Shipment Line No.");
        SalesOrderLine.GET("Document Type"::Order,SalesShptLine."Order No.",SalesShptLine."Order Line No.");

        Quantity := SalesOrderLine.Quantity;
        "Qty. Shipped Not Invoiced" := SalesOrderLine."Qty. Shipped Not Invoiced";
        "Quantity Invoiced" := SalesOrderLine."Quantity Invoiced";
        "Prepmt Amt Deducted" := SalesOrderLine."Prepmt Amt Deducted";
        "Prepmt. Amt. Inv." := SalesOrderLine."Prepmt. Amt. Inv.";
        "Line Discount Amount" := SalesOrderLine."Line Discount Amount";
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtRoundingAmounts@79(VAR PrepmtSalesLineBuf@1000 : Record 37;SalesLine@1003 : Record 37;DeductionFactor@1001 : Decimal;VAR TotalRoundingAmount@1002 : ARRAY [2] OF Decimal);
    VAR
      RoundingAmount@1004 : ARRAY [2] OF Decimal;
    BEGIN
      WITH PrepmtSalesLineBuf DO BEGIN
        IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN BEGIN
          RoundingAmount[1] :=
            "Prepmt. Amount Inv. (LCY)" - ROUND(DeductionFactor * SalesLine."Prepmt. Amount Inv. (LCY)");
          "Prepmt. Amount Inv. (LCY)" := "Prepmt. Amount Inv. (LCY)" - RoundingAmount[1];
          TotalRoundingAmount[1] += RoundingAmount[1];
        END;
        RoundingAmount[2] :=
          "Prepmt. VAT Amount Inv. (LCY)" - ROUND(DeductionFactor * SalesLine."Prepmt. VAT Amount Inv. (LCY)");
        "Prepmt. VAT Amount Inv. (LCY)" := "Prepmt. VAT Amount Inv. (LCY)" - RoundingAmount[2];
        TotalRoundingAmount[2] += RoundingAmount[2];
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtSalesLineWithRounding@89(VAR PrepmtSalesLine@1002 : Record 37;TotalRoundingAmount@1001 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1000 : ARRAY [2] OF Decimal;FinalInvoice@1005 : Boolean;PricesInclVATRoundingAmount@1006 : ARRAY [2] OF Decimal);
    VAR
      NewAmountIncludingVAT@1003 : Decimal;
      Prepmt100PctVATRoundingAmt@1004 : Decimal;
    BEGIN
      WITH PrepmtSalesLine DO BEGIN
        NewAmountIncludingVAT := TotalPrepmtAmount[1] + TotalPrepmtAmount[2] + TotalRoundingAmount[1] + TotalRoundingAmount[2];
        IF "Prepayment %" = 100 THEN
          TotalRoundingAmount[1] += "Amount Including VAT" - NewAmountIncludingVAT;

        IF ABS(TotalRoundingAmount[1]) <= GLSetup."Amount Rounding Precision" THEN BEGIN
          IF "Prepayment %" = 100 THEN
            Prepmt100PctVATRoundingAmt := TotalRoundingAmount[1];
          TotalRoundingAmount[1] := 0;
        END;
        "Prepmt. Amount Inv. (LCY)" := TotalRoundingAmount[1];
        Amount := TotalPrepmtAmount[1] + TotalRoundingAmount[1];

        IF (PricesInclVATRoundingAmount[1] <> 0) AND (TotalRoundingAmount[1] = 0) THEN BEGIN
          IF ("Prepayment %" = 100) AND FinalInvoice AND
             (Amount + TotalPrepmtAmount[2] = "Amount Including VAT")
          THEN
            Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[1] := 0;
        END;

        IF ((ABS(TotalRoundingAmount[2]) <= GLSetup."Amount Rounding Precision") OR
            FinalInvoice) AND (TotalRoundingAmount[1] = 0)
        THEN BEGIN
          IF ("Prepayment %" = 100) AND ("Prepmt. Amount Inv. (LCY)" = 0) THEN
            Prepmt100PctVATRoundingAmt += TotalRoundingAmount[2];
          TotalRoundingAmount[2] := 0;
        END;

        IF (PricesInclVATRoundingAmount[2] <> 0) AND (TotalRoundingAmount[2] = 0) THEN BEGIN
          Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[2] := 0;
        END;

        "Prepmt. VAT Amount Inv. (LCY)" := TotalRoundingAmount[2] + Prepmt100PctVATRoundingAmt;
        NewAmountIncludingVAT := Amount + TotalPrepmtAmount[2] + TotalRoundingAmount[2];
        IF (PricesInclVATRoundingAmount[1] = 0) AND (PricesInclVATRoundingAmount[2] = 0) OR
           ("Currency Code" <> '') AND FinalInvoice
        THEN
          Increment(
            TotalSalesLineLCY."Amount Including VAT",
            "Amount Including VAT" - NewAmountIncludingVAT - Prepmt100PctVATRoundingAmt);
        IF "Currency Code" = '' THEN
          TotalSalesLine."Amount Including VAT" := TotalSalesLineLCY."Amount Including VAT";
        "Amount Including VAT" := NewAmountIncludingVAT;

        IF FinalInvoice AND (TotalSalesLine.Amount = 0) AND (TotalSalesLine."Amount Including VAT" <> 0) AND
           (ABS(TotalSalesLine."Amount Including VAT") <= Currency."Amount Rounding Precision")
        THEN BEGIN
          "Amount Including VAT" += TotalSalesLineLCY."Amount Including VAT";
          TotalSalesLine."Amount Including VAT" := 0;
          TotalSalesLineLCY."Amount Including VAT" := 0;
        END;
      END;
    END;

    LOCAL PROCEDURE CalcRoundedAmount@91(Amount@1000 : Decimal;VAR Remainder@1001 : Decimal) : Decimal;
    VAR
      AmountRnded@1002 : Decimal;
    BEGIN
      Amount := Amount + Remainder;
      AmountRnded := ROUND(Amount,GLSetup."Amount Rounding Precision");
      Remainder := Amount - AmountRnded;
      EXIT(AmountRnded);
    END;

    LOCAL PROCEDURE GetSalesOrderLine@85(VAR SalesOrderLine@1000 : Record 37;SalesLine@1001 : Record 37);
    VAR
      SalesShptLine@1002 : Record 111;
    BEGIN
      SalesShptLine.GET(SalesLine."Shipment No.",SalesLine."Shipment Line No.");
      SalesOrderLine.GET(
        SalesOrderLine."Document Type"::Order,
        SalesShptLine."Order No.",SalesShptLine."Order Line No.");
      SalesOrderLine."Prepmt Amt to Deduct" := SalesLine."Prepmt Amt to Deduct";
    END;

    LOCAL PROCEDURE DecrementPrepmtAmtInvLCY@86(SalesLine@1000 : Record 37;VAR PrepmtAmountInvLCY@1001 : Decimal;VAR PrepmtVATAmountInvLCY@1002 : Decimal);
    BEGIN
      TempPrepmtDeductLCYSalesLine.RESET;
      TempPrepmtDeductLCYSalesLine := SalesLine;
      IF TempPrepmtDeductLCYSalesLine.FIND THEN BEGIN
        PrepmtAmountInvLCY := PrepmtAmountInvLCY - TempPrepmtDeductLCYSalesLine."Prepmt. Amount Inv. (LCY)";
        PrepmtVATAmountInvLCY := PrepmtVATAmountInvLCY - TempPrepmtDeductLCYSalesLine."Prepmt. VAT Amount Inv. (LCY)";
      END;
    END;

    LOCAL PROCEDURE AdjustFinalInvWith100PctPrepmt@97(VAR TempSalesLine@1000 : TEMPORARY Record 37);
    VAR
      DiffToLineDiscAmt@1001 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        RESET;
        SETRANGE("Prepayment %",100);
        IF FINDSET(TRUE) THEN
          REPEAT
            IF IsFinalInvoice THEN BEGIN
              DiffToLineDiscAmt := "Prepmt Amt to Deduct" - "Line Amount";
              IF "Document Type" = "Document Type"::Order THEN
                DiffToLineDiscAmt := DiffToLineDiscAmt * Quantity / "Qty. to Invoice";
              IF DiffToLineDiscAmt <> 0 THEN BEGIN
                TempSalesLine.GET("Document Type","Document No.","Line No.");
                TempSalesLine."Line Discount Amount" -= DiffToLineDiscAmt;
                TempSalesLine.MODIFY;

                "Line Discount Amount" := TempSalesLine."Line Discount Amount";
                MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE GetPrepmtDiffToLineAmount@98(SalesLine@1000 : Record 37) : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO
        IF SalesLine."Prepayment %" = 100 THEN
          IF GET(SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.") THEN
            EXIT("Prepmt Amt to Deduct" - "Line Amount");
      EXIT(0);
    END;

    LOCAL PROCEDURE MergeSaleslines@52(SalesHeader@1000000004 : Record 36;VAR Salesline@1000 : Record 37;VAR Salesline2@1000000002 : Record 37;VAR MergedSalesline@1000000003 : Record 37);
    BEGIN
      WITH Salesline DO BEGIN
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        IF FIND('-') THEN
          REPEAT
            MergedSalesline := Salesline;
            MergedSalesline.INSERT;
          UNTIL NEXT = 0;
      END;
      WITH Salesline2 DO BEGIN
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        IF FIND('-') THEN
          REPEAT
            MergedSalesline := Salesline2;
            MergedSalesline.INSERT;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostJobContractLine@54(SalesLine@1000 : Record 37) : Integer;
    BEGIN
      IF SalesLine."Job Contract Entry No." = 0 THEN
        EXIT;
      IF (SalesHeader."Document Type" <> SalesHeader."Document Type"::Invoice) AND
         (SalesHeader."Document Type" <> SalesHeader."Document Type"::"Credit Memo")
      THEN
        SalesLine.TESTFIELD("Job Contract Entry No.",0);

      SalesLine.TESTFIELD("Job No.");
      SalesLine.TESTFIELD("Job Task No.");

      IF SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice THEN
        SalesLine."Document No." := SalesInvHeader."No.";
      IF SalesHeader."Document Type" = SalesHeader."Document Type"::"Credit Memo" THEN
        SalesLine."Document No." := SalesCrMemoHeader."No.";
      JobContractLine := TRUE;
      EXIT(JobPostLine.PostInvoiceContractLine(SalesHeader,SalesLine));
    END;

    LOCAL PROCEDURE InsertICGenJnlLine@150(SalesLine@1000 : Record 37;VAR ICGenJnlLineNo@1006 : Integer);
    VAR
      ICGLAccount@1001 : Record 410;
      Vend@1002 : Record 23;
      ICPartner@1003 : Record 413;
      CurrExchRate@1004 : Record 330;
    BEGIN
      SalesHeader.TESTFIELD("Sell-to IC Partner Code",'');
      SalesHeader.TESTFIELD("Bill-to IC Partner Code",'');
      SalesLine.TESTFIELD("IC Partner Ref. Type",SalesLine."IC Partner Ref. Type"::"G/L Account");
      ICGLAccount.GET(SalesLine."IC Partner Reference");
      ICGenJnlLineNo := ICGenJnlLineNo + 1;
      TempICGenJnlLine.INIT;
      TempICGenJnlLine."Line No." := ICGenJnlLineNo;
      TempICGenJnlLine.VALIDATE("Posting Date",SalesHeader."Posting Date");
      TempICGenJnlLine."Document Date" := SalesHeader."Document Date";
      TempICGenJnlLine.Description := SalesHeader."Posting Description";
      TempICGenJnlLine."Reason Code" := SalesHeader."Reason Code";
      TempICGenJnlLine."Document Type" := GenJnlLineDocType;
      TempICGenJnlLine."Document No." := GenJnlLineDocNo;
      TempICGenJnlLine."External Document No." := GenJnlLineExtDocNo;
      TempICGenJnlLine.VALIDATE("Account Type",TempICGenJnlLine."Account Type"::"IC Partner");
      TempICGenJnlLine.VALIDATE("Account No.",SalesLine."IC Partner Code");
      TempICGenJnlLine."Source Currency Code" := SalesHeader."Currency Code";
      TempICGenJnlLine."Source Currency Amount" := TempICGenJnlLine.Amount;
      TempICGenJnlLine.Correction := SalesHeader.Correction;
      TempICGenJnlLine."Source Code" := SrcCode;
      TempICGenJnlLine."Country/Region Code" := SalesHeader."VAT Country/Region Code";
      TempICGenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
      TempICGenJnlLine."Source No." := SalesHeader."Bill-to Customer No.";
      TempICGenJnlLine."Source Line No." := SalesLine."Line No.";
      TempICGenJnlLine."Posting No. Series" := SalesHeader."Posting No. Series";
      TempICGenJnlLine.VALIDATE("Bal. Account Type",TempICGenJnlLine."Bal. Account Type"::"G/L Account");
      TempICGenJnlLine.VALIDATE("Bal. Account No.",SalesLine."No.");
      TempICGenJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
      TempICGenJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
      TempICGenJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
      Vend.SETRANGE("IC Partner Code",SalesLine."IC Partner Code");
      IF Vend.FINDFIRST THEN BEGIN
        TempICGenJnlLine.VALIDATE("Bal. Gen. Bus. Posting Group",Vend."Gen. Bus. Posting Group");
        TempICGenJnlLine.VALIDATE("Bal. VAT Bus. Posting Group",Vend."VAT Bus. Posting Group");
      END;
      TempICGenJnlLine.VALIDATE("Bal. VAT Prod. Posting Group",SalesLine."VAT Prod. Posting Group");
      TempICGenJnlLine."IC Partner Code" := SalesLine."IC Partner Code";
      TempICGenJnlLine."IC Partner G/L Acc. No." := SalesLine."IC Partner Reference";
      TempICGenJnlLine."IC Direction" := TempICGenJnlLine."IC Direction"::Outgoing;
      ICPartner.GET(SalesLine."IC Partner Code");
      IF ICPartner."Cost Distribution in LCY" AND (SalesLine."Currency Code" <> '') THEN BEGIN
        TempICGenJnlLine."Currency Code" := '';
        TempICGenJnlLine."Currency Factor" := 0;
        Currency.GET(SalesLine."Currency Code");
        IF SalesHeader."Document Type" IN
           [SalesHeader."Document Type"::"Return Order",SalesHeader."Document Type"::"Credit Memo"]
        THEN
          TempICGenJnlLine.Amount :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                SalesHeader."Posting Date",SalesLine."Currency Code",
      //        SalesLine.Amount,SalesHeader."Currency Factor")) //**4PS.o
                SalesLine.Amount,SalesHeader."Currency Factor",TRUE)) //**4PS.n
        ELSE
          TempICGenJnlLine.Amount :=
            -ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                SalesHeader."Posting Date",SalesLine."Currency Code",
      //        SalesLine.Amount,SalesHeader."Currency Factor")); //**4PS.o
                SalesLine.Amount,SalesHeader."Currency Factor",TRUE)); //**4PS.n
      END ELSE BEGIN
        Currency.InitRoundingPrecision;
        TempICGenJnlLine."Currency Code" := SalesHeader."Currency Code";
        TempICGenJnlLine."Currency Factor" := SalesHeader."Currency Factor";
        IF SalesHeader."Document Type" IN [SalesHeader."Document Type"::"Return Order",SalesHeader."Document Type"::"Credit Memo"] THEN
          TempICGenJnlLine.Amount := SalesLine.Amount
        ELSE
          TempICGenJnlLine.Amount := -SalesLine.Amount;
      END;
      IF TempICGenJnlLine."Bal. VAT %" <> 0 THEN
        TempICGenJnlLine.Amount := ROUND(TempICGenJnlLine.Amount * (1 + TempICGenJnlLine."Bal. VAT %" / 100),
            Currency."Amount Rounding Precision");
      TempICGenJnlLine.VALIDATE(Amount);
      TempICGenJnlLine.INSERT;
    END;

    LOCAL PROCEDURE PostICGenJnl@151();
    VAR
      ICInOutBoxMgt@1001 : Codeunit 427;
      ICTransactionNo@1000 : Integer;
    BEGIN
      TempICGenJnlLine.RESET;
      TempICGenJnlLine.SETFILTER(Amount,'<>%1',0);
      IF TempICGenJnlLine.FIND('-') THEN
        REPEAT
          ICTransactionNo := ICInOutBoxMgt.CreateOutboxJnlTransaction(TempICGenJnlLine,FALSE);
          ICInOutBoxMgt.CreateOutboxJnlLine(ICTransactionNo,1,TempICGenJnlLine);
          GenJnlPostLine.RunWithCheck(TempICGenJnlLine);
        UNTIL TempICGenJnlLine.NEXT = 0;
    END;

    LOCAL PROCEDURE TestGetShipmentPPmtAmtToDeduct@29(VAR SalesHeader@1005 : Record 36);
    VAR
      SalesLine2@1000 : Record 37;
      TempSalesLine3@1003 : TEMPORARY Record 37;
      TempTotalSalesLine@1007 : TEMPORARY Record 37;
      TempSalesShptLine@1009 : TEMPORARY Record 111;
      SalesShptLine@1002 : Record 111;
      MaxAmtToDeduct@1001 : Decimal;
    BEGIN
      SalesLine2.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine2.SETFILTER(Quantity,'>0');
      SalesLine2.SETFILTER("Qty. to Invoice",'>0');
      SalesLine2.SETFILTER("Shipment No.",'<>%1','');
      SalesLine2.SETFILTER("Prepmt Amt to Deduct",'<>0');
      IF SalesLine2.ISEMPTY THEN
        EXIT;
      SalesLine2.SETRANGE("Prepmt Amt to Deduct");

      IF SalesLine2.FINDSET THEN
        REPEAT
          IF SalesShptLine.GET(SalesLine2."Shipment No.",SalesLine2."Shipment Line No.") THEN BEGIN
            TempSalesLine3 := SalesLine2;
            TempSalesLine3.INSERT;
            TempSalesShptLine := SalesShptLine;
            IF TempSalesShptLine.INSERT THEN;

            IF NOT TempTotalSalesLine.GET(SalesLine2."Document Type"::Order,SalesShptLine."Order No.",SalesShptLine."Order Line No.") THEN BEGIN
              TempTotalSalesLine.INIT;
              TempTotalSalesLine."Document Type" := SalesLine2."Document Type"::Order;
              TempTotalSalesLine."Document No." := SalesShptLine."Order No.";
              TempTotalSalesLine."Line No." := SalesShptLine."Order Line No.";
              TempTotalSalesLine.INSERT;
            END;
            TempTotalSalesLine."Qty. to Invoice" := TempTotalSalesLine."Qty. to Invoice" + SalesLine2."Qty. to Invoice";
            TempTotalSalesLine."Prepmt Amt to Deduct" := TempTotalSalesLine."Prepmt Amt to Deduct" + SalesLine2."Prepmt Amt to Deduct";
            AdjustInvLineWith100PctPrepmt(SalesLine2,TempTotalSalesLine);
            TempTotalSalesLine.MODIFY;
          END;
        UNTIL SalesLine2.NEXT = 0;

      IF TempSalesLine3.FINDSET THEN
        REPEAT
          IF TempSalesShptLine.GET(TempSalesLine3."Shipment No.",TempSalesLine3."Shipment Line No.") THEN
            IF SalesLine2.GET(TempSalesLine3."Document Type"::Order,TempSalesShptLine."Order No.",TempSalesShptLine."Order Line No.") THEN
              IF TempTotalSalesLine.GET(
                   TempSalesLine3."Document Type"::Order,TempSalesShptLine."Order No.",TempSalesShptLine."Order Line No.")
              THEN BEGIN
                MaxAmtToDeduct := SalesLine2."Prepmt. Amt. Inv." - SalesLine2."Prepmt Amt Deducted";

                IF TempTotalSalesLine."Prepmt Amt to Deduct" > MaxAmtToDeduct THEN
                  ERROR(STRSUBSTNO(Text050,SalesLine2.FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct));

                IF (TempTotalSalesLine."Qty. to Invoice" = SalesLine2.Quantity - SalesLine2."Quantity Invoiced") AND
                   (TempTotalSalesLine."Prepmt Amt to Deduct" <> MaxAmtToDeduct)
                THEN
                  ERROR(STRSUBSTNO(Text051,SalesLine2.FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct));
              END;
        UNTIL TempSalesLine3.NEXT = 0;
    END;

    LOCAL PROCEDURE AdjustInvLineWith100PctPrepmt@99(VAR SalesInvoiceLine@1000 : Record 37;VAR TempTotalSalesLine@1001 : TEMPORARY Record 37);
    VAR
      SalesOrderLine@1003 : Record 37;
      DiffAmtToDeduct@1002 : Decimal;
    BEGIN
      IF SalesInvoiceLine."Prepayment %" = 100 THEN BEGIN
        SalesOrderLine := TempTotalSalesLine;
        SalesOrderLine.FIND;
        IF TempTotalSalesLine."Qty. to Invoice" = SalesOrderLine.Quantity - SalesOrderLine."Quantity Invoiced" THEN BEGIN
          DiffAmtToDeduct :=
            SalesOrderLine."Prepmt. Amt. Inv." - SalesOrderLine."Prepmt Amt Deducted" - TempTotalSalesLine."Prepmt Amt to Deduct";
          IF DiffAmtToDeduct <> 0 THEN BEGIN
            SalesInvoiceLine."Prepmt Amt to Deduct" := SalesInvoiceLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
            SalesInvoiceLine."Line Amount" := SalesInvoiceLine."Prepmt Amt to Deduct";
            SalesInvoiceLine."Line Discount Amount" := SalesInvoiceLine."Line Discount Amount" - DiffAmtToDeduct;
            SalesInvoiceLine.MODIFY;
            TempTotalSalesLine."Prepmt Amt to Deduct" := TempTotalSalesLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
          END;
        END;
      END;
    END;

    PROCEDURE ArchiveUnpostedOrder@56(SalesHeader@1001 : Record 36);
    VAR
      ArchiveManagement@1000 : Codeunit 5063;
    BEGIN
      SalesSetup.GET;
      IF NOT SalesSetup."Archive Quotes and Orders" THEN
        EXIT;
      IF NOT (SalesHeader."Document Type" IN [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::"Return Order"]) THEN
        EXIT;
      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETFILTER(Quantity,'<>0');
      IF SalesHeader."Document Type" = SalesHeader."Document Type"::Order THEN
        SalesLine.SETFILTER("Qty. to Ship",'<>0')
      ELSE
        SalesLine.SETFILTER("Return Qty. to Receive",'<>0');
      IF NOT SalesLine.ISEMPTY AND NOT PreviewMode THEN BEGIN
        RoundDeferralsForArchive(SalesHeader,SalesLine);
        ArchiveManagement.ArchSalesDocumentNoConfirm(SalesHeader);
      END;
    END;

    LOCAL PROCEDURE SynchBOMSerialNo@1204(VAR ServItemTmp3@1200 : TEMPORARY Record 5940;VAR ServItemTmpCmp3@1201 : TEMPORARY Record 5941);
    VAR
      ItemLedgEntry@1000 : Record 32;
      ItemLedgEntry2@1001 : Record 32;
      TempSalesShipMntLine@1002 : TEMPORARY Record 111;
      ServItemTmpCmp4@1003 : TEMPORARY Record 5941;
      ServItemCompLocal@1004 : Record 5941;
      TempItemLedgEntry2@1008 : TEMPORARY Record 32;
      ChildCount@1005 : Integer;
      EndLoop@1006 : Boolean;
    BEGIN
      IF NOT ServItemTmpCmp3.FIND('-') THEN
        EXIT;

      IF NOT ServItemTmp3.FIND('-') THEN
        EXIT;

      TempSalesShipMntLine.DELETEALL;
      REPEAT
        CLEAR(TempSalesShipMntLine);
        TempSalesShipMntLine."Document No." := ServItemTmp3."Sales/Serv. Shpt. Document No.";
        TempSalesShipMntLine."Line No." := ServItemTmp3."Sales/Serv. Shpt. Line No.";
        IF TempSalesShipMntLine.INSERT THEN;
      UNTIL ServItemTmp3.NEXT = 0;

      IF NOT TempSalesShipMntLine.FIND('-') THEN
        EXIT;

      ServItemTmp3.SETCURRENTKEY("Sales/Serv. Shpt. Document No.","Sales/Serv. Shpt. Line No.");
      CLEAR(ItemLedgEntry);
      ItemLedgEntry.SETCURRENTKEY("Document No.","Document Type","Document Line No.");

      REPEAT
        ChildCount := 0;
        ServItemTmpCmp4.DELETEALL;
        ServItemTmp3.SETRANGE("Sales/Serv. Shpt. Document No.",TempSalesShipMntLine."Document No.");
        ServItemTmp3.SETRANGE("Sales/Serv. Shpt. Line No.",TempSalesShipMntLine."Line No.");
        IF ServItemTmp3.FIND('-') THEN
          REPEAT
            ServItemTmpCmp3.SETRANGE(Active,TRUE);
            ServItemTmpCmp3.SETRANGE("Parent Service Item No.",ServItemTmp3."No.");
            IF ServItemTmpCmp3.FIND('-') THEN
              REPEAT
                ChildCount += 1;
                ServItemTmpCmp4 := ServItemTmpCmp3;
                ServItemTmpCmp4.INSERT;
              UNTIL ServItemTmpCmp3.NEXT = 0;
          UNTIL ServItemTmp3.NEXT = 0;
        ItemLedgEntry.SETRANGE("Document No.",TempSalesShipMntLine."Document No.");
        ItemLedgEntry.SETRANGE("Document Type",ItemLedgEntry."Document Type"::"Sales Shipment");
        ItemLedgEntry.SETRANGE("Document Line No.",TempSalesShipMntLine."Line No.");
        IF ItemLedgEntry.FINDFIRST AND ServItemTmpCmp4.FIND('-') THEN BEGIN
          CLEAR(ItemLedgEntry2);
          ItemLedgEntry2.GET(ItemLedgEntry."Entry No.");
          EndLoop := FALSE;
          REPEAT
            IF ItemLedgEntry2."Item No." = ServItemTmpCmp4."No." THEN
              EndLoop := TRUE
            ELSE
              IF ItemLedgEntry2.NEXT = 0 THEN
                EndLoop := TRUE;
          UNTIL EndLoop;
          ItemLedgEntry2.SETRANGE("Entry No.",ItemLedgEntry2."Entry No.",ItemLedgEntry2."Entry No." + ChildCount - 1);
          IF ItemLedgEntry2.FINDSET THEN
            REPEAT
              TempItemLedgEntry2 := ItemLedgEntry2;
              TempItemLedgEntry2.INSERT;
            UNTIL ItemLedgEntry2.NEXT = 0;
          REPEAT
            IF ServItemCompLocal.GET(
                 ServItemTmpCmp4.Active,
                 ServItemTmpCmp4."Parent Service Item No.",
                 ServItemTmpCmp4."Line No.")
            THEN BEGIN
              TempItemLedgEntry2.SETRANGE("Item No.",ServItemCompLocal."No.");
              IF TempItemLedgEntry2.FINDFIRST THEN BEGIN
                ServItemCompLocal."Serial No." := TempItemLedgEntry2."Serial No.";
                ServItemCompLocal.MODIFY;
                TempItemLedgEntry2.DELETE;
              END;
            END;
          UNTIL ServItemTmpCmp4.NEXT = 0;
        END;
      UNTIL TempSalesShipMntLine.NEXT = 0;
    END;

    LOCAL PROCEDURE GetGLSetup@60();
    BEGIN
      IF NOT GLSetupRead THEN
        GLSetup.GET;
      GLSetupRead := TRUE;
    END;

    LOCAL PROCEDURE LockTables@58();
    BEGIN
      SalesLine.LOCKTABLE;
      ItemChargeAssgntSales.LOCKTABLE;
      PurchOrderLine.LOCKTABLE;
      PurchOrderHeader.LOCKTABLE;
      GetGLSetup;
      IF NOT GLSetup.OptimGLEntLockForMultiuserEnv THEN BEGIN
        GLEntry.LOCKTABLE;
        IF GLEntry.FINDLAST THEN;
      END;
    END;

    LOCAL PROCEDURE PostCustomerEntry@101(SalesHeader2@1000 : Record 36;TotalSalesLine2@1005 : Record 37;TotalSalesLineLCY2@1006 : Record 37;DocType@1002 : Option;DocNo@1003 : Code[20];ExtDocNo@1004 : Code[35];SourceCode@1007 : Code[10];CrRestrictionAmt@1100525000 : Decimal;CrRestrictionVATAmt@1100525001 : Decimal);
    VAR
      GenJnlLine2@1001 : Record 81;
    BEGIN
      WITH SalesHeader2 DO BEGIN
        GenJnlLine2.INIT;
        GenJnlLine2."Posting Date" := "Posting Date";
        GenJnlLine2."Document Date" := "Document Date";
        GenJnlLine2.Description := "Posting Description";
        GenJnlLine2."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        GenJnlLine2."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine2."Dimension Set ID" := "Dimension Set ID";
        GenJnlLine2."Reason Code" := "Reason Code";
        GenJnlLine2."Account Type" := GenJnlLine2."Account Type"::Customer;
        GenJnlLine2."Account No." := "Bill-to Customer No.";
        //**4PS.sn
        IF PlantTransportInternalCust THEN BEGIN
          GenJnlLine2."Account Type" := GenJnlLine2."Account Type"::"G/L Account";
          GenJnlLine2."Account No." := PlantSetupRec."Internal Bal. Account Cost";
        END;
        //**4PS.en
        GenJnlLine2."Document Type" := DocType;
        GenJnlLine2."Document No." := DocNo;
        GenJnlLine2."External Document No." := ExtDocNo;
        GenJnlLine2."Currency Code" := "Currency Code";
        GenJnlLine2.Amount := -TotalSalesLine2."Amount Including VAT";
        GenJnlLine2."Source Currency Code" := "Currency Code";
        GenJnlLine2."Source Currency Amount" := -TotalSalesLine2."Amount Including VAT";
        GenJnlLine2."Amount (LCY)" := -TotalSalesLineLCY2."Amount Including VAT";
        IF "Currency Code" = '' THEN
          GenJnlLine2."Currency Factor" := 1
        ELSE
          GenJnlLine2."Currency Factor" := "Currency Factor";
        GenJnlLine2.Correction := Correction;
        GenJnlLine2."Sales/Purch. (LCY)" := -TotalSalesLineLCY2.Amount;
        GenJnlLine2."Profit (LCY)" := -(TotalSalesLineLCY2.Amount - TotalSalesLineLCY2."Unit Cost (LCY)");
        GenJnlLine2."Inv. Discount (LCY)" := -TotalSalesLineLCY2."Inv. Discount Amount";
        GenJnlLine2."Sell-to/Buy-from No." := "Sell-to Customer No.";
        GenJnlLine2."Bill-to/Pay-to No." := "Bill-to Customer No.";
        GenJnlLine2."Salespers./Purch. Code" := "Salesperson Code";
        GenJnlLine2."System-Created Entry" := TRUE;
        GenJnlLine2."On Hold" := "On Hold";
        GenJnlLine2."Applies-to Doc. Type" := "Applies-to Doc. Type";
        GenJnlLine2."Applies-to Doc. No." := "Applies-to Doc. No.";
        GenJnlLine2."Applies-to ID" := "Applies-to ID";
        GenJnlLine2."Allow Application" := "Bal. Account No." = '';
        GenJnlLine2."Due Date" := "Due Date";
        GenJnlLine2."Direct Debit Mandate ID" := "Direct Debit Mandate ID";
        GenJnlLine2."Payment Terms Code" := "Payment Terms Code";
        GenJnlLine2."Payment Method Code" := "Payment Method Code";
        //**4PS.so
        //GenJnlLine2."Pmt. Discount Date" := "Pmt. Discount Date";
        //GenJnlLine2."Payment Discount %" := "Payment Discount %";
        //**4PS.eo
        //**4PS.sn
        IF NOT PlantTransportInternalCust THEN BEGIN
          GenJnlLine2."Pmt. Discount Date" := "Pmt. Discount Date";
          GenJnlLine2."Payment Discount %" := "Payment Discount %";
          GenJnlLine2."Pmt. Discount Date 2" := "Pmt. Discount Date 2";
          GenJnlLine2."Payment Discount % 2" := "Payment Discount % 2";
          GenJnlLine2."Pmt. Discount Date 3" := "Pmt. Discount Date 3";
          GenJnlLine2."Payment Discount % 3" := "Payment Discount % 3";
        END;
        //**4PS.en

        GenJnlLine2."Source Type" := GenJnlLine2."Source Type"::Customer;
        GenJnlLine2."Source No." := "Bill-to Customer No.";
        GenJnlLine2."Source Code" := SourceCode;
        GenJnlLine2."Posting No. Series" := "Posting No. Series";
        GenJnlLine2."IC Partner Code" := "Sell-to IC Partner Code";

        //**4PS.sn
        GenJnlLine2."Interest Date" := "Interest Date";
        GenJnlLine2."Alternative Bill-to Address" := "Alternative Bill-to Address";
        IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
          GenJnlLine2."Labor Amount (Subcontracting)" := SalesInvHeader."Labor Amount (Subcontracting)";
          GenJnlLine2."Blocked Amount (Subcontracting" := SalesInvHeader."Blocked Amount (Subcontracting";
        END ELSE BEGIN
          GenJnlLine2."Labor Amount (Subcontracting)" := SalesCrMemoHeader."Labor Amount (Subcontracting)";
          GenJnlLine2."Blocked Amount (Subcontracting" := SalesCrMemoHeader."Blocked Amount (Subcontracting";
        END;
        GenJnlLine2."Credit Restriction" := "Credit Restriction";
        GenJnlLine2.VALIDATE("Credit Restriction %", "Credit Restriction %");
        GenJnlLine2."Credit Restriction Date" := "Credit Restriction Date";
        GenJnlLine2.VALIDATE("Credit Restriction Amount", CrRestrictionAmt);
        GenJnlLine2.VALIDATE("Credit Restriction VAT Amount", CrRestrictionVATAmt);
        GenJnlLine2."Your Reference" := "Your Reference"; //20060706-JE
        GenJnlLine2."Batch Seq. No." := "Batch Seq. No.";
        //**4PS.en

        GenJnlPostLine.SetCustLegEntryProjectNo("Job No.");  //**4PS.n C-019159  Note: Fill "Job No." in GenJnlLine not allowed
        GenJnlPostLine.RunWithCheck(GenJnlLine2);
        GenJnlPostLine.SetCustLegEntryProjectNo('');  //**4PS.n C-019159
      END;
    END;

    LOCAL PROCEDURE UpdateSalesHeader@102(VAR CustLedgerEntry@1000 : Record 21);
    BEGIN
      CASE GenJnlLineDocType OF
        GenJnlLine."Document Type"::Invoice:
          BEGIN
            FindCustLedgEntry(GenJnlLineDocType,GenJnlLineDocNo,CustLedgerEntry);
            SalesInvHeader."Cust. Ledger Entry No." := CustLedgerEntry."Entry No.";
            SalesInvHeader.MODIFY;
          END;
        GenJnlLine."Document Type"::"Credit Memo":
          BEGIN
            FindCustLedgEntry(GenJnlLineDocType,GenJnlLineDocNo,CustLedgerEntry);
            SalesCrMemoHeader."Cust. Ledger Entry No." := CustLedgerEntry."Entry No.";
            SalesCrMemoHeader.MODIFY;
          END;
      END;
    END;

    LOCAL PROCEDURE CaptureOrRefundCreditCardPmnt@70(CustLedgEntry@1000 : Record 21) : Integer;
    VAR
      DOPaymentMgt@1001 : Codeunit 825;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF NOT IsOnlinePayment(SalesHeader) THEN
          EXIT(0);

        IF NOT Invoice THEN
          EXIT(0);

        IF "Document Type" = "Document Type"::"Credit Memo" THEN
          EXIT(DOPaymentMgt.RefundSalesDoc(SalesHeader,CustLedgEntry."Entry No."));

        EXIT(DOPaymentMgt.CaptureSalesDoc(SalesHeader,CustLedgEntry."Entry No."));
      END;
    END;

    LOCAL PROCEDURE AuthorizeCreditCard@62(AuthorizationRequired@1000 : Boolean) : Integer;
    VAR
      DOPaymentMgt@1001 : Codeunit 825;
    BEGIN
      WITH SalesHeader DO
        IF ("Document Type" = "Document Type"::Order) AND Ship OR
           ("Document Type" = "Document Type"::Invoice) AND Invoice
        THEN
          IF DOPaymentMgt.IsValidPaymentMethod("Payment Method Code") THEN BEGIN
            IF DOPaymentMgt.IsAuthorizationRequired OR AuthorizationRequired THEN
              EXIT(DOPaymentMgt.AuthorizeSalesDoc(SalesHeader,0,TRUE));
            TESTFIELD("Credit Card No.");
          END;
      EXIT(0);
    END;

    LOCAL PROCEDURE MAX@55(number1@1000 : Integer;number2@1001 : Integer) : Integer;
    BEGIN
      IF number1 > number2 THEN
        EXIT(number1);
      EXIT(number2);
    END;

    LOCAL PROCEDURE PostBalanceEntry@63(TransactionLogEntryNo@1000 : Integer;SalesHeader2@1014 : Record 36;TotalSalesLine2@1013 : Record 37;TotalSalesLineLCY2@1011 : Record 37;DocType@1009 : Option;DocNo@1008 : Code[20];ExtDocNo@1007 : Code[35];SourceCode@1006 : Code[10]);
    VAR
      CustLedgEntry@1002 : Record 21;
      DOPaymentMgt@1010 : Codeunit 825;
      CrCardDocumentType@1012 : 'Payment,Refund';
    BEGIN
      WITH SalesHeader2 DO BEGIN
        FindCustLedgEntry(DocType,DocNo,CustLedgEntry);

        GenJnlLine.INIT;
        GenJnlLine."Posting Date" := "Posting Date";
        GenJnlLine."Document Date" := "Document Date";
        GenJnlLine.Description := "Posting Description";
        GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        GenJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine."Dimension Set ID" := "Dimension Set ID";
        GenJnlLine."Reason Code" := "Reason Code";
        GenJnlLine."Account Type" := GenJnlLine."Account Type"::Customer;
        GenJnlLine."Account No." := "Bill-to Customer No.";
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          GenJnlLine."Document Type" := GenJnlLine."Document Type"::Refund
        ELSE
          GenJnlLine."Document Type" := GenJnlLine."Document Type"::Payment;
        GenJnlLine."Document No." := DocNo;
        GenJnlLine."External Document No." := ExtDocNo;
        IF "Bal. Account Type" = "Bal. Account Type"::"Bank Account" THEN
          GenJnlLine."Bal. Account Type" := GenJnlLine."Bal. Account Type"::"Bank Account";
        GenJnlLine."Bal. Account No." := "Bal. Account No.";
        GenJnlLine."Currency Code" := "Currency Code";
        GenJnlLine.Amount :=
          TotalSalesLine2."Amount Including VAT" + CustLedgEntry."Remaining Pmt. Disc. Possible";
        GenJnlLine."Source Currency Code" := "Currency Code";
        GenJnlLine."Source Currency Amount" := GenJnlLine.Amount;
        GenJnlLine.Correction := Correction;
        CustLedgEntry.CALCFIELDS(Amount);
        IF CustLedgEntry.Amount = 0 THEN
          GenJnlLine."Amount (LCY)" := TotalSalesLineLCY2."Amount Including VAT"
        ELSE
          GenJnlLine."Amount (LCY)" :=
            TotalSalesLineLCY2."Amount Including VAT" +
            ROUND(
              CustLedgEntry."Remaining Pmt. Disc. Possible" /
              CustLedgEntry."Adjusted Currency Factor");
        IF "Currency Code" = '' THEN
          GenJnlLine."Currency Factor" := 1
        ELSE
          GenJnlLine."Currency Factor" := "Currency Factor";
        GenJnlLine."Applies-to Doc. Type" := DocType;
        GenJnlLine."Applies-to Doc. No." := DocNo;
        GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
        GenJnlLine."Source No." := "Bill-to Customer No.";
        GenJnlLine."Source Code" := SourceCode;
        GenJnlLine."Posting No. Series" := "Posting No. Series";
        GenJnlLine."IC Partner Code" := "Sell-to IC Partner Code";
        GenJnlLine."Salespers./Purch. Code" := "Salesperson Code";
        GenJnlLine."Allow Zero-Amount Posting" := TRUE;
        //** 4PS.sn
        GenJnlLine."Interest Date" := "Interest Date";
        GenJnlLine."Alternative Bill-to Address" := "Alternative Bill-to Address";
        //**4PS.en
        GenJnlPostLine.RunWithCheck(GenJnlLine);

        IF TransactionLogEntryNo <> 0 THEN BEGIN
          CASE "Document Type" OF
            GenJnlLine."Document Type"::Payment:
              CrCardDocumentType := CrCardDocumentType::Payment;
            "Document Type"::"Credit Memo":
              CrCardDocumentType := CrCardDocumentType::Refund;
          END;
          DOPaymentMgt.UpdateTransactEntryAfterPost(TransactionLogEntryNo,CustLedgEntry."Entry No.",CrCardDocumentType);
        END;
      END;
    END;

    LOCAL PROCEDURE FindCustLedgEntry@71(DocType@1003 : Option;DocNo@1002 : Code[20];VAR CustLedgEntry@1000 : Record 21);
    BEGIN
      CustLedgEntry.SETRANGE("Document Type",DocType);
      CustLedgEntry.SETRANGE("Document No.",DocNo);
      CustLedgEntry.FINDLAST;
    END;

    LOCAL PROCEDURE IsOnlinePayment@64(VAR SalesHeader@1000 : Record 36) : Boolean;
    VAR
      DOPaymentMgt@1001 : Codeunit 825;
    BEGIN
      IF DOPaymentMgt.IsValidPaymentMethod(SalesHeader."Payment Method Code") THEN
        EXIT(TRUE);
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE IsAuthorized@65(TransactionLogEntryNo@1000 : Integer) : Boolean;
    BEGIN
      EXIT(TransactionLogEntryNo <> 0);
    END;

    LOCAL PROCEDURE ItemLedgerEntryExist@7(SalesLine2@1000 : Record 37) : Boolean;
    VAR
      HasItemLedgerEntry@1001 : Boolean;
    BEGIN
      IF SalesHeader.Ship OR SalesHeader.Receive THEN
        // item ledger entry will be created during posting in this transaction
        HasItemLedgerEntry :=
          ((SalesLine2."Qty. to Ship" + SalesLine2."Quantity Shipped") <> 0) OR
          ((SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced") <> 0) OR
          ((SalesLine2."Return Qty. to Receive" + SalesLine2."Return Qty. Received") <> 0)
      ELSE
        // item ledger entry must already exist
        HasItemLedgerEntry :=
          (SalesLine2."Quantity Shipped" <> 0) OR
          (SalesLine2."Return Qty. Received" <> 0);

      EXIT(HasItemLedgerEntry);
    END;

    LOCAL PROCEDURE CheckPostRestrictions@115(SalesHeader@1000 : Record 36);
    BEGIN
      SalesHeader.OnCheckSalesPostRestrictions;
      CheckCustBlockage(SalesHeader."Sell-to Customer No.",TRUE);

      IF SalesHeader."Bill-to Customer No." <> SalesHeader."Sell-to Customer No." THEN
        CheckCustBlockage(SalesHeader."Bill-to Customer No.",FALSE);
    END;

    LOCAL PROCEDURE CheckCustBlockage@1029(CustCode@1011 : Code[20];ExecuteDocCheck@1012 : Boolean);
    VAR
      Cust@1039 : Record 18;
    BEGIN
      //**4PS.sn
      IF ChargePlantToProject OR ChargeJobOrderToPlant OR ChargePlantToServOrder THEN
        EXIT; //No customer involved
      IF InternalChargePlantOnLoc('') THEN  //DP00815
        EXIT; //No customer involved
      //**4PS.en
      Cust.GET(CustCode);
      IF SalesHeader.Receive THEN
        Cust.CheckBlockedCustOnDocs(Cust,SalesHeader."Document Type",FALSE,TRUE)
      ELSE BEGIN
        IF SalesHeader.Ship AND CheckDocumentType(ExecuteDocCheck) THEN BEGIN
          SalesLine.RESET;
          SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
          SalesLine.SETRANGE("Document No.",SalesHeader."No.");
          SalesLine.SETFILTER("Qty. to Ship",'<>0');
          SalesLine.SETRANGE("Shipment No.",'');
          IF NOT SalesLine.ISEMPTY THEN
            Cust.CheckBlockedCustOnDocs(Cust,SalesHeader."Document Type",TRUE,TRUE);
        END ELSE
          Cust.CheckBlockedCustOnDocs(Cust,SalesHeader."Document Type",FALSE,TRUE);
      END;
    END;

    LOCAL PROCEDURE CheckDocumentType@1030(ExecuteDocCheck@1031 : Boolean) : Boolean;
    BEGIN
      IF ExecuteDocCheck THEN BEGIN
        IF (SalesHeader."Document Type" = SalesHeader."Document Type"::Order) OR
           ((SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice) AND
            SalesSetup."Shipment on Invoice")
        THEN
          EXIT(TRUE);
      END;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE UpdateWonOpportunities@66(VAR SalesHeader@1000 : Record 36);
    VAR
      Opp@1001 : Record 5092;
      OpportunityEntry@1002 : Record 5093;
    BEGIN
      WITH SalesHeader DO
        IF "Document Type" = "Document Type"::Order THEN BEGIN
          Opp.RESET;
          Opp.SETCURRENTKEY("Sales Document Type","Sales Document No.");
          Opp.SETRANGE("Sales Document Type",Opp."Sales Document Type"::Order);
          Opp.SETRANGE("Sales Document No.","No.");
          Opp.SETRANGE(Status,Opp.Status::Won);
          IF Opp.FINDFIRST THEN BEGIN
            Opp."Sales Document Type" := Opp."Sales Document Type"::"Posted Invoice";
            Opp."Sales Document No." := SalesInvHeader."No.";
            Opp.MODIFY;
            OpportunityEntry.RESET;
            OpportunityEntry.SETCURRENTKEY(Active,"Opportunity No.");
            OpportunityEntry.SETRANGE(Active,TRUE);
            OpportunityEntry.SETRANGE("Opportunity No.",Opp."No.");
            IF OpportunityEntry.FINDFIRST THEN BEGIN
              OpportunityEntry."Calcd. Current Value (LCY)" := OpportunityEntry.GetSalesDocValue(SalesHeader);
              OpportunityEntry.MODIFY;
            END;
          END;
        END;
    END;

    LOCAL PROCEDURE UpdateQtyToBeInvoiced@90(VAR QtyToBeInvoiced@1000 : Decimal;VAR QtyToBeInvoicedBase@1001 : Decimal;TrackingSpecificationExists@1002 : Boolean;HasATOShippedNotInvoiced@1003 : Boolean;SalesLine@1007 : Record 37;SalesShptLine@1006 : Record 111;InvoicingTrackingSpecification@1004 : Record 336;ItemLedgEntryNotInvoiced@1005 : Record 32);
    BEGIN
      IF TrackingSpecificationExists THEN BEGIN
        QtyToBeInvoiced := InvoicingTrackingSpecification."Qty. to Invoice";
        QtyToBeInvoicedBase := InvoicingTrackingSpecification."Qty. to Invoice (Base)";
      END ELSE
        IF HasATOShippedNotInvoiced THEN BEGIN
          QtyToBeInvoicedBase := ItemLedgEntryNotInvoiced.Quantity - ItemLedgEntryNotInvoiced."Invoiced Quantity";
          IF ABS(QtyToBeInvoicedBase) > ABS(RemQtyToBeInvoicedBase) THEN
            QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Qty. to Ship (Base)";
          QtyToBeInvoiced := ROUND(QtyToBeInvoicedBase / SalesShptLine."Qty. per Unit of Measure",0.00001);
        END ELSE BEGIN
          QtyToBeInvoiced := RemQtyToBeInvoiced - SalesLine."Qty. to Ship";
          QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Qty. to Ship (Base)";
        END;

      IF ABS(QtyToBeInvoiced) > ABS(SalesShptLine.Quantity - SalesShptLine."Quantity Invoiced") THEN BEGIN
        QtyToBeInvoiced := -(SalesShptLine.Quantity - SalesShptLine."Quantity Invoiced");
        QtyToBeInvoicedBase := -(SalesShptLine."Quantity (Base)" - SalesShptLine."Qty. Invoiced (Base)");
      END;
    END;

    LOCAL PROCEDURE UpdateRemainingQtyToBeInvoiced@125(SalesShptLine@1000 : Record 111;VAR RemQtyToInvoiceCurrLine@1001 : Decimal;VAR RemQtyToInvoiceCurrLineBase@1002 : Decimal);
    BEGIN
      RemQtyToInvoiceCurrLine := -SalesShptLine.Quantity + SalesShptLine."Quantity Invoiced";
      RemQtyToInvoiceCurrLineBase := -SalesShptLine."Quantity (Base)" + SalesShptLine."Qty. Invoiced (Base)";
      IF RemQtyToInvoiceCurrLine < RemQtyToBeInvoiced THEN BEGIN
        RemQtyToInvoiceCurrLine := RemQtyToBeInvoiced;
        RemQtyToInvoiceCurrLineBase := RemQtyToBeInvoicedBase;
      END;
    END;

    LOCAL PROCEDURE IsEndLoopForShippedNotInvoiced@96(RemQtyToBeInvoiced@1004 : Decimal;TrackingSpecificationExists@1001 : Boolean;VAR HasATOShippedNotInvoiced@1000 : Boolean;VAR SalesShptLine@1006 : Record 111;VAR InvoicingTrackingSpecification@1002 : Record 336;VAR ItemLedgEntryNotInvoiced@1003 : Record 32;SalesLine@1005 : Record 37) : Boolean;
    BEGIN
      IF TrackingSpecificationExists THEN
        EXIT(InvoicingTrackingSpecification.NEXT = 0);

      IF HasATOShippedNotInvoiced THEN BEGIN
        HasATOShippedNotInvoiced := ItemLedgEntryNotInvoiced.NEXT <> 0;
        IF NOT HasATOShippedNotInvoiced THEN
          EXIT(NOT SalesShptLine.FINDSET OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship")));
        EXIT(ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship"));
      END;

      EXIT((SalesShptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship")));
    END;

    PROCEDURE SetItemEntryRelation@87(VAR ItemEntryRelation@1000 : Record 6507;VAR SalesShptLine@1001 : Record 111;VAR InvoicingTrackingSpecification@1004 : Record 336;VAR ItemLedgEntryNotInvoiced@1005 : Record 32;TrackingSpecificationExists@1002 : Boolean;HasATOShippedNotInvoiced@1003 : Boolean);
    BEGIN
      IF TrackingSpecificationExists THEN BEGIN
        ItemEntryRelation.GET(InvoicingTrackingSpecification."Item Ledger Entry No.");
        SalesShptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
      END ELSE
        IF HasATOShippedNotInvoiced THEN BEGIN
          ItemEntryRelation."Item Entry No." := ItemLedgEntryNotInvoiced."Entry No.";
          SalesShptLine.GET(ItemLedgEntryNotInvoiced."Document No.",ItemLedgEntryNotInvoiced."Document Line No.");
        END ELSE
          ItemEntryRelation."Item Entry No." := SalesShptLine."Item Shpt. Entry No.";
    END;

    LOCAL PROCEDURE PostATOAssocItemJnlLine@76(SalesLine@1003 : Record 37;VAR PostedATOLink@1000 : Record 914;VAR RemQtyToBeInvoiced@1002 : Decimal;VAR RemQtyToBeInvoicedBase@1001 : Decimal);
    VAR
      DummyTrackingSpecification@1005 : Record 336;
    BEGIN
      WITH PostedATOLink DO BEGIN
        DummyTrackingSpecification.INIT;
        IF SalesLine."Document Type" = SalesLine."Document Type"::Order THEN BEGIN
          "Assembled Quantity" := -"Assembled Quantity";
          "Assembled Quantity (Base)" := -"Assembled Quantity (Base)";
          IF ABS(RemQtyToBeInvoiced) >= ABS("Assembled Quantity") THEN BEGIN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesLine,
                "Assembled Quantity","Assembled Quantity (Base)",
                "Assembled Quantity","Assembled Quantity (Base)",
                0,'',DummyTrackingSpecification,TRUE);
            RemQtyToBeInvoiced -= "Assembled Quantity";
            RemQtyToBeInvoicedBase -= "Assembled Quantity (Base)";
          END ELSE BEGIN
            IF RemQtyToBeInvoiced <> 0 THEN
              ItemLedgShptEntryNo :=
                PostItemJnlLine(
                  SalesLine,
                  RemQtyToBeInvoiced,
                  RemQtyToBeInvoicedBase,
                  RemQtyToBeInvoiced,
                  RemQtyToBeInvoicedBase,
                  0,'',DummyTrackingSpecification,TRUE);

            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesLine,
                "Assembled Quantity" - RemQtyToBeInvoiced,
                "Assembled Quantity (Base)" - RemQtyToBeInvoicedBase,
                0,0,
                0,'',DummyTrackingSpecification,TRUE);

            RemQtyToBeInvoiced := 0;
            RemQtyToBeInvoicedBase := 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE GetOpenLinkedATOs@72(VAR TempAsmHeader@1000 : TEMPORARY Record 900);
    VAR
      SalesLine2@1002 : Record 37;
      AsmHeader@1001 : Record 900;
    BEGIN
      SalesLine2.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.",SalesHeader."No.");
      IF SalesLine2.FIND('-') THEN
        REPEAT
          IF SalesLine2.AsmToOrderExists(AsmHeader) THEN
            IF AsmHeader.Status = AsmHeader.Status::Open THEN BEGIN
              TempAsmHeader.TRANSFERFIELDS(AsmHeader);
              TempAsmHeader.INSERT;
            END;
        UNTIL SalesLine2.NEXT = 0;
    END;

    LOCAL PROCEDURE ReopenAsmOrders@69(VAR TempAsmHeader@1002 : TEMPORARY Record 900);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      IF TempAsmHeader.FIND('-') THEN
        REPEAT
          AsmHeader.GET(TempAsmHeader."Document Type",TempAsmHeader."No.");
          AsmHeader.Status := AsmHeader.Status::Open;
          AsmHeader.MODIFY;
        UNTIL TempAsmHeader.NEXT = 0;
    END;

    LOCAL PROCEDURE InitPostATO@53(VAR SalesLine@1000 : Record 37);
    VAR
      AsmHeader@1001 : Record 900;
      Window@1003 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        Window.OPEN(Text055);
        Window.UPDATE(1,
          STRSUBSTNO(Text059,
            SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
        Window.UPDATE(2,STRSUBSTNO(Text060,AsmHeader."Document Type",AsmHeader."No."));

        SalesLine.CheckAsmToOrder(AsmHeader);
        IF NOT HasQtyToAsm(SalesLine,AsmHeader) THEN
          EXIT;

        AsmPost.SetPostingDate(TRUE,SalesHeader."Posting Date");
        AsmPost.InitPostATO(AsmHeader);

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE PostATO@59(VAR SalesLine@1000 : Record 37;VAR TempPostedATOLink@1004 : TEMPORARY Record 914);
    VAR
      AsmHeader@1001 : Record 900;
      PostedATOLink@1002 : Record 914;
      Window@1003 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        Window.OPEN(Text056);
        Window.UPDATE(1,
          STRSUBSTNO(Text059,
            SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
        Window.UPDATE(2,STRSUBSTNO(Text060,AsmHeader."Document Type",AsmHeader."No."));

        SalesLine.CheckAsmToOrder(AsmHeader);
        IF NOT HasQtyToAsm(SalesLine,AsmHeader) THEN
          EXIT;
        IF AsmHeader."Remaining Quantity (Base)" = 0 THEN
          EXIT;

        PostedATOLink.INIT;
        PostedATOLink."Assembly Document Type" := PostedATOLink."Assembly Document Type"::Assembly;
        PostedATOLink."Assembly Document No." := AsmHeader."Posting No.";
        PostedATOLink."Document Type" := PostedATOLink."Document Type"::"Sales Shipment";
        PostedATOLink."Document No." := SalesHeader."Shipping No.";
        PostedATOLink."Document Line No." := SalesLine."Line No.";

        PostedATOLink."Assembly Order No." := AsmHeader."No.";
        PostedATOLink."Order No." := SalesLine."Document No.";
        PostedATOLink."Order Line No." := SalesLine."Line No.";

        PostedATOLink."Assembled Quantity" := AsmHeader."Quantity to Assemble";
        PostedATOLink."Assembled Quantity (Base)" := AsmHeader."Quantity to Assemble (Base)";
        PostedATOLink.INSERT;

        TempPostedATOLink := PostedATOLink;
        TempPostedATOLink.INSERT;

        AsmPost.PostATO(AsmHeader,ItemJnlPostLine,ResJnlPostLine,WhseJnlPostLine);

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE FinalizePostATO@61(VAR SalesLine@1000 : Record 37);
    VAR
      ATOLink@1002 : Record 904;
      AsmHeader@1003 : Record 900;
      Window@1001 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        Window.OPEN(Text057);
        Window.UPDATE(1,
          STRSUBSTNO(Text059,
            SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
        Window.UPDATE(2,STRSUBSTNO(Text060,AsmHeader."Document Type",AsmHeader."No."));

        SalesLine.CheckAsmToOrder(AsmHeader);
        AsmHeader.TESTFIELD("Remaining Quantity (Base)",0);
        AsmPost.FinalizePostATO(AsmHeader);
        ATOLink.GET(AsmHeader."Document Type",AsmHeader."No.");
        ATOLink.DELETE;

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE CheckATOLink@78(SalesLine@1000 : Record 37);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      IF SalesLine."Qty. to Asm. to Order (Base)" = 0 THEN
        EXIT;
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN
        SalesLine.CheckAsmToOrder(AsmHeader);
    END;

    LOCAL PROCEDURE DeleteATOLinks@67(SalesHeader@1000 : Record 36);
    VAR
      ATOLink@1001 : Record 904;
    BEGIN
      WITH ATOLink DO BEGIN
        SETCURRENTKEY(Type,"Document Type","Document No.");
        SETRANGE(Type,Type::Sale);
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        IF NOT ISEMPTY THEN
          DELETEALL;
      END;
    END;

    LOCAL PROCEDURE HasQtyToAsm@68(SalesLine@1000 : Record 37;AsmHeader@1001 : Record 900) : Boolean;
    BEGIN
      IF SalesLine."Qty. to Asm. to Order (Base)" = 0 THEN
        EXIT(FALSE);
      IF SalesLine."Qty. to Ship (Base)" = 0 THEN
        EXIT(FALSE);
      IF AsmHeader."Quantity to Assemble (Base)" = 0 THEN
        EXIT(FALSE);
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE GetATOItemLedgEntriesNotInvoiced@77(SalesLine@1000 : Record 37;VAR ItemLedgEntryNotInvoiced@1001 : Record 32) : Boolean;
    VAR
      PostedATOLink@1002 : Record 914;
      ItemLedgEntry@1003 : Record 32;
    BEGIN
      ItemLedgEntryNotInvoiced.RESET;
      ItemLedgEntryNotInvoiced.DELETEALL;
      IF PostedATOLink.FindLinksFromSalesLine(SalesLine) THEN
        REPEAT
          ItemLedgEntry.SETCURRENTKEY("Document No.","Document Type","Document Line No.");
          ItemLedgEntry.SETRANGE("Document Type",ItemLedgEntry."Document Type"::"Sales Shipment");
          ItemLedgEntry.SETRANGE("Document No.",PostedATOLink."Document No.");
          ItemLedgEntry.SETRANGE("Document Line No.",PostedATOLink."Document Line No.");
          ItemLedgEntry.SETRANGE("Assemble to Order",TRUE);
          ItemLedgEntry.SETRANGE("Completely Invoiced",FALSE);
          IF ItemLedgEntry.FINDSET THEN
            REPEAT
              IF ItemLedgEntry.Quantity <> ItemLedgEntry."Invoiced Quantity" THEN BEGIN
                ItemLedgEntryNotInvoiced := ItemLedgEntry;
                ItemLedgEntryNotInvoiced.INSERT;
              END;
            UNTIL ItemLedgEntry.NEXT = 0;
        UNTIL PostedATOLink.NEXT = 0;

      EXIT(ItemLedgEntryNotInvoiced.FINDSET);
    END;

    PROCEDURE SetWhseJnlRegisterCU@26(VAR WhseJnlRegisterLine@1000 : Codeunit 7301);
    BEGIN
      WhseJnlPostLine := WhseJnlRegisterLine;
    END;

    LOCAL PROCEDURE PostWhseShptLines@74(VAR WhseShptLine2@1000 : Record 7321;SalesShptLine2@1004 : Record 111;VAR SalesLine2@1007 : Record 37);
    VAR
      ATOWhseShptLine@1002 : Record 7321;
      NonATOWhseShptLine@1001 : Record 7321;
      ATOLineFound@1005 : Boolean;
      NonATOLineFound@1003 : Boolean;
      TotalSalesShptLineQty@1006 : Decimal;
    BEGIN
      WhseShptLine2.GetATOAndNonATOLines(ATOWhseShptLine,NonATOWhseShptLine,ATOLineFound,NonATOLineFound);
      IF ATOLineFound THEN
        TotalSalesShptLineQty += ATOWhseShptLine."Qty. to Ship";
      IF NonATOLineFound THEN
        TotalSalesShptLineQty += NonATOWhseShptLine."Qty. to Ship";
      SalesShptLine2.TESTFIELD(Quantity,TotalSalesShptLineQty);

      SaveTempWhseSplitSpec(SalesLine2);

      WhsePostShpt.SetWhseJnlRegisterCU(WhseJnlPostLine);
      IF ATOLineFound AND (ATOWhseShptLine."Qty. to Ship (Base)" > 0) THEN
        WhsePostShpt.CreatePostedShptLine(
          ATOWhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
      IF NonATOLineFound AND (NonATOWhseShptLine."Qty. to Ship (Base)" > 0) THEN
        WhsePostShpt.CreatePostedShptLine(
          NonATOWhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
    END;

    LOCAL PROCEDURE GetCountryCode@75(SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36) : Code[10];
    VAR
      SalesShipmentHeader@1003 : Record 110;
    BEGIN
      IF SalesLine."Shipment No." <> '' THEN BEGIN
        SalesShipmentHeader.GET(SalesLine."Shipment No.");
        EXIT(
          GetCountryRegionCode(
            SalesLine."Sell-to Customer No.",
            SalesShipmentHeader."Ship-to Code",
            SalesShipmentHeader."Sell-to Country/Region Code"));
      END;
      EXIT(
        GetCountryRegionCode(
          SalesLine."Sell-to Customer No.",
          SalesHeader."Ship-to Code",
          SalesHeader."Sell-to Country/Region Code"));
    END;

    LOCAL PROCEDURE GetCountryRegionCode@103(CustNo@1001 : Code[20];ShipToCode@1002 : Code[10];SellToCountryRegionCode@1003 : Code[10]) : Code[10];
    VAR
      ShipToAddress@1000 : Record 222;
    BEGIN
      IF ShipToCode <> '' THEN BEGIN
        ShipToAddress.GET(CustNo,ShipToCode);
        EXIT(ShipToAddress."Country/Region Code");
      END;
      EXIT(SellToCountryRegionCode);
    END;

    LOCAL PROCEDURE UpdateIncomingDocument@95(IncomingDocNo@1000 : Integer;PostingDate@1002 : Date;GenJnlLineDocNo@1003 : Code[20]);
    VAR
      IncomingDocument@1001 : Record 130;
    BEGIN
      IncomingDocument.UpdateIncomingDocumentFromPosting(IncomingDocNo,PostingDate,GenJnlLineDocNo);
    END;

    LOCAL PROCEDURE CheckItemCharge@88(ItemChargeAssgntSales@1000 : Record 5809);
    VAR
      SalesLineForCharge@1001 : Record 37;
    BEGIN
      WITH ItemChargeAssgntSales DO
        CASE "Applies-to Doc. Type" OF
          "Applies-to Doc. Type"::Order,
          "Applies-to Doc. Type"::Invoice:
            IF SalesLineForCharge.GET(
                 "Applies-to Doc. Type",
                 "Applies-to Doc. No.",
                 "Applies-to Doc. Line No.")
            THEN
              IF (SalesLineForCharge."Quantity (Base)" = SalesLineForCharge."Qty. Shipped (Base)") AND
                 (SalesLineForCharge."Qty. Shipped Not Invd. (Base)" = 0)
              THEN
                ERROR(Text061Err);
          "Applies-to Doc. Type"::"Return Order",
          "Applies-to Doc. Type"::"Credit Memo":
            IF SalesLineForCharge.GET(
                 "Applies-to Doc. Type",
                 "Applies-to Doc. No.",
                 "Applies-to Doc. Line No.")
            THEN
              IF (SalesLineForCharge."Quantity (Base)" = SalesLineForCharge."Return Qty. Received (Base)") AND
                 (SalesLineForCharge."Ret. Qty. Rcd. Not Invd.(Base)" = 0)
              THEN
                ERROR(Text061Err);
        END;
    END;

    LOCAL PROCEDURE CheckItemReservDisruption@104();
    VAR
      AvailableQty@1000 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        IF NOT ("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice]) OR
           (Type <> Type::Item) OR
           NOT ("Qty. to Ship (Base)" > 0)
        THEN
          EXIT;
        IF ("Job Contract Entry No." <> 0) OR
           Nonstock OR
           "Special Order" OR
           "Drop Shipment" OR
           IsServiceItem OR
           FullQtyIsForAsmToOrder OR
           TempSKU.GET("Location Code","No.","Variant Code") // Warn against item
        THEN
          EXIT;

        Item.SETFILTER("Location Filter","Location Code");
        Item.SETFILTER("Variant Filter","Variant Code");
        Item.CALCFIELDS("Reserved Qty. on Inventory","Net Change");
        CALCFIELDS("Reserved Qty. (Base)");
        AvailableQty := Item."Net Change" - (Item."Reserved Qty. on Inventory" - "Reserved Qty. (Base)");

        IF (Item."Reserved Qty. on Inventory" > 0) AND
           (AvailableQty < "Qty. to Ship (Base)") AND
           (Item."Reserved Qty. on Inventory" > "Reserved Qty. (Base)")
        THEN BEGIN
          InsertTempSKU("Location Code","No.","Variant Code");
          IF NOT CONFIRM(
               Text062Qst,FALSE,FIELDCAPTION("No."),Item."No.",FIELDCAPTION("Location Code"),
               "Location Code",FIELDCAPTION("Variant Code"),"Variant Code")
          THEN
            ERROR('');
        END;
      END;
    END;

    LOCAL PROCEDURE InsertTempSKU@106(LocationCode@1000 : Code[10];ItemNo@1001 : Code[20];VariantCode@1002 : Code[10]);
    BEGIN
      WITH TempSKU DO BEGIN
        INIT;
        "Location Code" := LocationCode;
        "Item No." := ItemNo;
        "Variant Code" := VariantCode;
        INSERT;
      END;
    END;

    PROCEDURE InitProgressWindow@105(SalesHeader@1000 : Record 36);
    BEGIN
      IF SalesHeader.Invoice THEN
        Window.OPEN(
          '#1#################################\\' +
          Text002 +
          Text003 +
          Text004 +
          Text005)
      ELSE
        Window.OPEN(
          '#1#################################\\' +
          Text006);

      Window.UPDATE(1,STRSUBSTNO('%1 %2',SalesHeader."Document Type",SalesHeader."No."));
    END;

    LOCAL PROCEDURE CheckCertificateOfSupplyStatus@188(SalesShptHeader@1001 : Record 110;SalesShptLine@1000 : Record 111);
    VAR
      CertificateOfSupply@1002 : Record 780;
      VATPostingSetup@1003 : Record 325;
    BEGIN
      IF SalesShptLine.Quantity <> 0 THEN
        IF VATPostingSetup.GET(SalesShptHeader."VAT Bus. Posting Group",SalesShptLine."VAT Prod. Posting Group") AND
           VATPostingSetup."Certificate of Supply Required"
        THEN BEGIN
          CertificateOfSupply.InitFromSales(SalesShptHeader);
          CertificateOfSupply.SetRequired(SalesShptHeader."No.");
        END;
    END;

    LOCAL PROCEDURE HasSpecificTracking@107(ItemNo@1000 : Code[20]) : Boolean;
    VAR
      Item@1001 : Record 27;
      ItemTrackingCode@1002 : Record 6502;
    BEGIN
      Item.GET(ItemNo);
      IF Item."Item Tracking Code" <> '' THEN BEGIN
        ItemTrackingCode.GET(Item."Item Tracking Code");
        EXIT(ItemTrackingCode."SN Specific Tracking" OR ItemTrackingCode."Lot Specific Tracking");
      END;
    END;

    LOCAL PROCEDURE HasInvtPickLine@108(SalesLine@1000 : Record 37) : Boolean;
    VAR
      WhseActivityLine@1001 : Record 5767;
    BEGIN
      WITH WhseActivityLine DO BEGIN
        SETRANGE("Activity Type","Activity Type"::"Invt. Pick");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source No.",SalesLine."Document No.");
        SETRANGE("Source Line No.",SalesLine."Line No.");
        EXIT(NOT ISEMPTY);
      END;
    END;

    LOCAL PROCEDURE InsertShipmentHeader@110(SalesHeader@1000 : Record 36;VAR SalesShptHeader@1001 : Record 110);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SalesHeaderExtension@1100525000 : Record 11071868;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesShptHeader.INIT;
        SalesShptHeader.TRANSFERFIELDS(SalesHeader);

        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesShptHeader."E-Mail (Shipments)" := SalesHeaderExtension."E-Mail (Shipments)";
        SalesShptHeader."Shipment per E-Mail" := SalesHeaderExtension."Shipment per E-Mail";
        //**4PS.en

        SalesShptHeader."No." := "Shipping No.";
        IF "Document Type" = "Document Type"::Order THEN BEGIN
          SalesShptHeader."Order No. Series" := "No. Series";
          SalesShptHeader."Order No." := "No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
        END;
        SalesShptHeader."Source Code" := SrcCode;
        SalesShptHeader."User ID" := USERID;
        SalesShptHeader."No. Printed" := 0;
        SalesShptHeader.INSERT;

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesShptHeader.RECORDID,SalesShptHeader."No.");

        IF SalesSetup."Copy Comments Order to Shpt." THEN BEGIN
          CopyCommentLines(
            "Document Type",SalesCommentLine."Document Type"::Shipment,
            "No.",SalesShptHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesShptHeader);
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          WhsePostShpt.CreatePostedShptHeader(
            PostedWhseShptHeader,WhseShptHeader,"Shipping No.","Posting Date");
        END;
        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          WhsePostRcpt.CreatePostedRcptHeader(
            PostedWhseRcptHeader,WhseRcptHeader,"Shipping No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertReturnReceiptHeader@113(SalesHeader@1000 : Record 36;VAR ReturnRcptHeader@1001 : Record 6660);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
    BEGIN
      WITH SalesHeader DO BEGIN
        ReturnRcptHeader.INIT;
        ReturnRcptHeader.TRANSFERFIELDS(SalesHeader);
        ReturnRcptHeader."No." := "Return Receipt No.";
        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
          ReturnRcptHeader."Return Order No. Series" := "No. Series";
          ReturnRcptHeader."Return Order No." := "No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
        END;
        ReturnRcptHeader."No. Series" := "Return Receipt No. Series";
        ReturnRcptHeader."Source Code" := SrcCode;
        ReturnRcptHeader."User ID" := USERID;
        ReturnRcptHeader."No. Printed" := 0;
        ReturnRcptHeader.INSERT(TRUE);

        ApprovalsMgmt.PostApprovalEntries(RECORDID,ReturnRcptHeader.RECORDID,ReturnRcptHeader."No.");

        IF SalesSetup."Copy Cmts Ret.Ord. to Ret.Rcpt" THEN BEGIN
          CopyCommentLines(
            "Document Type",SalesCommentLine."Document Type"::"Posted Return Receipt",
            "No.",ReturnRcptHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,ReturnRcptHeader);
        END;
        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          WhsePostRcpt.CreatePostedRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,"Return Receipt No.","Posting Date");
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          WhsePostShpt.CreatePostedShptHeader(PostedWhseShptHeader,WhseShptHeader,"Return Receipt No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertInvoiceHeader@116(SalesHeader@1000 : Record 36;VAR SalesInvHeader@1001 : Record 112);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SalesOfferAmount@1100485003 : Record 11012786;
      SalesHeaderExtension@1100525000 : Record 11071868;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesInvHeader.INIT;
        SalesInvHeader.TRANSFERFIELDS(SalesHeader);

        IF "Document Type" = "Document Type"::Order THEN BEGIN
          IF PreviewMode THEN
            SalesInvHeader."No." := FakeDocNoTxt
          ELSE
            SalesInvHeader."No." := "Posting No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
          SalesInvHeader."Pre-Assigned No. Series" := '';
          SalesInvHeader."Order No. Series" := "No. Series";
          SalesInvHeader."Order No." := "No.";
          Window.UPDATE(1,STRSUBSTNO(Text007,"Document Type","No.",SalesInvHeader."No."));
        END ELSE BEGIN
          SalesInvHeader."Pre-Assigned No. Series" := "No. Series";
          SalesInvHeader."Pre-Assigned No." := "No.";
          //**4PS.sn
          SalesInvHeader."Order No." := "Related Sales Order No.";
          IF SetRentalUnitInvoice THEN BEGIN
            SalesInvHeader."Rental Unit Invoice" := TRUE;
            SalesInvHeader."Job No." := RentalUnitProjectNo;
          END;
          //**4PS.en
          IF "Posting No." <> '' THEN BEGIN
            SalesInvHeader."No." := "Posting No.";
            Window.UPDATE(1,STRSUBSTNO(Text007,"Document Type","No.",SalesInvHeader."No."));
          END;
        END;

        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesInvHeader."E-Mail (Invoices)" := SalesHeaderExtension."E-Mail (Invoices)";
        SalesInvHeader."Electronic Invoicing" := SalesHeaderExtension."Electronic Invoicing";
        SalesInvHeader."Combine E-Mail Attachments" := SalesHeaderExtension."Combine E-Mail Attachments";
        //**4PS.en

        SalesInvHeader."Source Code" := SrcCode;
        SalesInvHeader."User ID" := USERID;
        SalesInvHeader."No. Printed" := 0;
        SalesInvHeader.INSERT;

        UpdateWonOpportunities(SalesHeader);

        //**4PS.sn
        IF "Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated" THEN
          IF SalesOfferAmount.GET("Document Type", "No.", 0) THEN BEGIN
            SalesOfferAmount."Document Type" := SalesOfferAmount."Document Type"::"Posted Invoice";
            SalesOfferAmount."Document No." := SalesInvHeader."No.";
            SalesOfferAmount.INSERT;
          END;
        //**4PS.en

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesInvHeader.RECORDID,SalesInvHeader."No.");

        IF SalesSetup."Copy Comments Order to Invoice" THEN BEGIN
          CopyCommentLines(
            "Document Type",SalesCommentLine."Document Type"::"Posted Invoice",
            "No.",SalesInvHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesInvHeader);
        END;
      END;
    END;

    LOCAL PROCEDURE InsertCrMemoHeader@118(SalesHeader@1000 : Record 36;VAR SalesCrMemoHeader@1001 : Record 114);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SalesHeaderExtension@1100525000 : Record 11071868;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesCrMemoHeader.INIT;
        SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
        SalesCrMemoHeader."Inserted By" := SalesHeader."Inserted By"; //**4PS.n
        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
          SalesCrMemoHeader."No." := "Posting No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
          SalesCrMemoHeader."Pre-Assigned No. Series" := '';
          SalesCrMemoHeader."Return Order No. Series" := "No. Series";
          SalesCrMemoHeader."Return Order No." := "No.";
          Window.UPDATE(1,STRSUBSTNO(Text008,"Document Type","No.",SalesCrMemoHeader."No."));
        END ELSE BEGIN
          SalesCrMemoHeader."Pre-Assigned No. Series" := "No. Series";
          SalesCrMemoHeader."Pre-Assigned No." := "No.";

          //**4PS.sn
          FillSalesCrMemoHeadReturnOrder(SalesCrMemoHeader, SalesHeader); //C016332
          IF SetRentalUnitInvoice THEN BEGIN
            SalesCrMemoHeader."Rental Unit Invoice" := TRUE;
            SalesCrMemoHeader."Job No." := RentalUnitProjectNo;
          END;
          //**4PS.sn

          IF "Posting No." <> '' THEN BEGIN
            SalesCrMemoHeader."No." := "Posting No.";
            Window.UPDATE(1,STRSUBSTNO(Text008,"Document Type","No.",SalesCrMemoHeader."No."));
          END;
        END;

        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesCrMemoHeader."E-Mail (Invoices)" := SalesHeaderExtension."E-Mail (Invoices)";
        SalesCrMemoHeader."Electronic Invoicing" := SalesHeaderExtension."Electronic Invoicing";
        SalesCrMemoHeader."Combine E-Mail Attachments" := SalesHeaderExtension."Combine E-Mail Attachments";
        //**4PS.en

        SalesCrMemoHeader."Source Code" := SrcCode;
        SalesCrMemoHeader."User ID" := USERID;
        SalesCrMemoHeader."No. Printed" := 0;
        SalesCrMemoHeader.INSERT;

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesCrMemoHeader.RECORDID,SalesCrMemoHeader."No.");

        IF SalesSetup."Copy Cmts Ret.Ord. to Cr. Memo" THEN BEGIN
          CopyCommentLines(
            "Document Type",SalesCommentLine."Document Type"::"Posted Credit Memo",
            "No.",SalesCrMemoHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesCrMemoHeader);
        END;
      END;
    END;

    LOCAL PROCEDURE CheckICPartnerBlocked@20(SalesHeader@1000 : Record 36);
    VAR
      ICPartner@1001 : Record 413;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF ("Sell-to IC Partner Code" <> '') AND ICPartner.GET("Sell-to IC Partner Code") THEN
          ICPartner.TESTFIELD(Blocked,FALSE);
        IF ("Bill-to IC Partner Code" <> '') AND ICPartner.GET("Bill-to IC Partner Code") THEN
          ICPartner.TESTFIELD(Blocked,FALSE);
      END;
    END;

    LOCAL PROCEDURE SendICDocument@109(VAR SalesHeader@1000 : Record 36;VAR ModifyHeader@1001 : Boolean);
    VAR
      ICInboxOutboxMgt@1002 : Codeunit 427;
    BEGIN
      WITH SalesHeader DO
        IF "Send IC Document" AND ("IC Status" = "IC Status"::New) AND ("IC Direction" = "IC Direction"::Outgoing) AND
           ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
        THEN BEGIN
          ICInboxOutboxMgt.SendSalesDoc(SalesHeader,TRUE);
          "IC Status" := "IC Status"::Pending;
          ModifyHeader := TRUE;
        END;
    END;

    LOCAL PROCEDURE UpdateHandledICInboxTransaction@111(SalesHeader@1000 : Record 36);
    VAR
      HandledICInboxTrans@1001 : Record 420;
      Customer@1002 : Record 18;
    BEGIN
      WITH SalesHeader DO
        IF "IC Direction" = "IC Direction"::Incoming THEN BEGIN
          HandledICInboxTrans.SETRANGE("Document No.","External Document No.");
          Customer.GET("Sell-to Customer No.");
          HandledICInboxTrans.SETRANGE("IC Partner Code",Customer."IC Partner Code");
          HandledICInboxTrans.LOCKTABLE;
          IF HandledICInboxTrans.FINDFIRST THEN BEGIN
            HandledICInboxTrans.Status := HandledICInboxTrans.Status::Posted;
            HandledICInboxTrans.MODIFY;
          END;
        END;
    END;

    PROCEDURE GetPostedDocumentRecord@222(SalesHeader@1000 : Record 36;VAR PostedSalesDocumentVariant@1001 : Variant);
    VAR
      SalesInvHeader@1007 : Record 112;
      SalesCrMemoHeader@1006 : Record 114;
    BEGIN
      WITH SalesHeader DO
        CASE "Document Type" OF
          "Document Type"::Order:
            IF Invoice THEN BEGIN
              SalesInvHeader.GET("Last Posting No.");
              SalesInvHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesInvHeader;
            END;
          "Document Type"::Invoice:
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesInvHeader.GET("No.")
              ELSE
                SalesInvHeader.GET("Last Posting No.");

              SalesInvHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesInvHeader;
            END;
          "Document Type"::"Credit Memo":
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesCrMemoHeader.GET("No.")
              ELSE
                SalesCrMemoHeader.GET("Last Posting No.");
              SalesCrMemoHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesCrMemoHeader;
            END;
          ELSE
            ERROR(STRSUBSTNO(NotSupportedDocumentTypeErr,"Document Type"));
        END;
    END;

    LOCAL PROCEDURE MakeInventoryAdjustment@112();
    VAR
      InvtSetup@1000 : Record 313;
      InvtAdjmt@1001 : Codeunit 5895;
    BEGIN
      InvtSetup.GET;
      IF InvtSetup."Automatic Cost Adjustment" <>
         InvtSetup."Automatic Cost Adjustment"::Never
      THEN BEGIN
        InvtAdjmt.SetProperties(TRUE,InvtSetup."Automatic Cost Posting");
        InvtAdjmt.SetJobUpdateProperties(TRUE);
        InvtAdjmt.MakeMultiLevelAdjmt;
      END;
    END;

    PROCEDURE CheckTrackingAndWarehouseForShip@114(DocumentType@1000 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order';No@1001 : Code[20];WhseReference@1002 : Integer;VAR Ship@1003 : Boolean);
    BEGIN
      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",DocumentType);
      SalesLine.SETRANGE("Document No.",No);
      SalesLine.SETFILTER(Quantity,'<>0');
      IF DocumentType = DocumentType::Order THEN
        SalesLine.SETFILTER("Qty. to Ship",'<>0');
      SalesLine.SETRANGE("Shipment No.",'');

      SalesLine.SETFILTER("Qty. to Assemble to Order",'<>0');
      IF SalesLine.FINDSET THEN
        REPEAT
          InitPostATO(SalesLine);
        UNTIL SalesLine.NEXT = 0;
      SalesLine.SETRANGE("Qty. to Assemble to Order");

      Ship := SalesLine.FINDFIRST;
      WhseShip := TempWhseShptHeader.FINDFIRST;
      WhseReceive := TempWhseRcptHeader.FINDFIRST;
      InvtPickPutaway := WhseReference <> 0;
      IF Ship THEN
        CheckTrackingSpecification(SalesLine);
      IF Ship AND NOT (WhseShip OR WhseReceive OR InvtPickPutaway) THEN
        CheckWarehouse(SalesLine);
    END;

    PROCEDURE CheckTrackingAndWarehouseForReceive@117(DocumentType@1000 : 'Quote,Order,Invoice,Credit Memo,Blanket Order,Return Order';No@1001 : Code[20];WhseReference@1002 : Integer;VAR Receive@1003 : Boolean);
    BEGIN
      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",DocumentType);
      SalesLine.SETRANGE("Document No.",No);
      SalesLine.SETFILTER(Quantity,'<>0');
      SalesLine.SETFILTER("Return Qty. to Receive",'<>0');
      SalesLine.SETRANGE("Return Receipt No.",'');
      Receive := SalesLine.FINDFIRST;
      WhseShip := TempWhseShptHeader.FINDFIRST;
      WhseReceive := TempWhseRcptHeader.FINDFIRST;
      InvtPickPutaway := WhseReference <> 0;
      IF Receive THEN
        CheckTrackingSpecification(SalesLine);
      IF Receive AND NOT (WhseReceive OR WhseShip OR InvtPickPutaway) THEN
        CheckWarehouse(SalesLine);
    END;

    LOCAL PROCEDURE FindTempItemChargeAssgntSales@119(SalesLineNo@1000 : Integer) : Boolean;
    BEGIN
      ClearItemChargeAssgntFilter;
      TempItemChargeAssgntSales.SETCURRENTKEY("Applies-to Doc. Type");
      TempItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLineNo);
      EXIT(TempItemChargeAssgntSales.FINDSET);
    END;

    LOCAL PROCEDURE UpdateInvoicedQtyOnShipmentLine@120(VAR SalesShptLine@1000 : Record 111;QtyToBeInvoiced@1001 : Decimal;QtyToBeInvoicedBase@1002 : Decimal);
    BEGIN
      WITH SalesShptLine DO BEGIN
        "Quantity Invoiced" := "Quantity Invoiced" - QtyToBeInvoiced;
        "Qty. Invoiced (Base)" := "Qty. Invoiced (Base)" - QtyToBeInvoicedBase;
        "Qty. Shipped Not Invoiced" := Quantity - "Quantity Invoiced";
        MODIFY;
      END;
    END;

    PROCEDURE SetPreviewMode@121(NewPreviewMode@1000 : Boolean);
    BEGIN
      PreviewMode := NewPreviewMode;
    END;

    LOCAL PROCEDURE FillDeferralPostingBuffer@123(SalesLine@1000 : Record 37;RemainAmtToDefer@1001 : Decimal;RemainAmtToDeferACY@1002 : Decimal;DeferralAccount@1003 : Code[20];SalesAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1007 : Record 1700;
    BEGIN
      DeferralTemplate.GET(SalesLine."Deferral Code");

      IF TempDeferralHeader.GET(DeferralUtilities.GetSalesDeferralDocType,'','',
           SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        IF TempDeferralHeader."Amount to Defer" <> 0 THEN BEGIN
          TempDeferralLine.SETRANGE("Deferral Doc. Type",DeferralUtilities.GetSalesDeferralDocType);
          TempDeferralLine.SETRANGE("Gen. Jnl. Template Name",'');
          TempDeferralLine.SETRANGE("Gen. Jnl. Batch Name",'');
          TempDeferralLine.SETRANGE("Document Type",SalesLine."Document Type");
          TempDeferralLine.SETRANGE("Document No.",SalesLine."Document No.");
          TempDeferralLine.SETRANGE("Line No.",SalesLine."Line No.");

          // The remaining amounts only need to be adjusted into the deferral account and are always reversed
          IF (RemainAmtToDefer <> 0) OR (RemainAmtToDeferACY <> 0) THEN BEGIN
            DeferralPostBuffer[1].PrepareSales(SalesLine,GenJnlLineDocNo);
            DeferralPostBuffer[1]."Amount (LCY)" := RemainAmtToDefer;
            DeferralPostBuffer[1].Amount := RemainAmtToDeferACY;
            DeferralPostBuffer[1]."Sales/Purch Amount (LCY)" := 0;
            DeferralPostBuffer[1]."Sales/Purch Amount" := 0;
            DeferralPostBuffer[1].ReverseAmounts;
            DeferralPostBuffer[1]."G/L Account" := SalesAccount;
            DeferralPostBuffer[1]."Deferral Account" := DeferralAccount;
            // Remainder always goes to the Posting Date
            DeferralPostBuffer[1]."Posting Date" := SalesHeader."Posting Date";
            DeferralPostBuffer[1].Description := DeferralTemplate.Description;
            DeferralPostBuffer[1]."Period Description" := DeferralTemplate."Period Description";
            DeferralPostBuffer[1]."Deferral Line No." := InvDefLineNo;
            UpdDeferralPostBuffer;
          END;

          // Add the deferral lines for each period to the deferral posting buffer merging when they are the same
          IF TempDeferralLine.FINDSET THEN
            REPEAT
              IF (TempDeferralLine."Amount (LCY)" <> 0) OR (TempDeferralLine.Amount <> 0) THEN BEGIN
                DeferralPostBuffer[1].PrepareSales(SalesLine,GenJnlLineDocNo);
                DeferralPostBuffer[1]."Amount (LCY)" := TempDeferralLine."Amount (LCY)";
                DeferralPostBuffer[1].Amount := TempDeferralLine.Amount;
                DeferralPostBuffer[1]."Sales/Purch Amount (LCY)" := TempDeferralLine."Amount (LCY)";
                DeferralPostBuffer[1]."Sales/Purch Amount" := TempDeferralLine.Amount;
                IF NOT SalesLine.IsCreditDocType THEN
                  DeferralPostBuffer[1].ReverseAmounts;
                DeferralPostBuffer[1]."G/L Account" := SalesAccount;
                DeferralPostBuffer[1]."Deferral Account" := DeferralAccount;
                DeferralPostBuffer[1]."Posting Date" := TempDeferralLine."Posting Date";
                DeferralPostBuffer[1].Description := TempDeferralLine.Description;
                DeferralPostBuffer[1]."Period Description" := DeferralTemplate."Period Description";
                DeferralPostBuffer[1]."Deferral Line No." := InvDefLineNo;
                UpdDeferralPostBuffer;
              END ELSE
                ERROR(ZeroDeferralAmtErr,SalesLine."No.",SalesLine."Deferral Code");

            UNTIL TempDeferralLine.NEXT = 0

          ELSE
            ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code");
        END ELSE
          ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code")
      END ELSE
        ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code");
    END;

    LOCAL PROCEDURE UpdDeferralPostBuffer@124();
    BEGIN
      DeferralPostBuffer[1]."Dimension Set ID" := InvPostingBuffer[1]."Dimension Set ID";
      DeferralPostBuffer[1]."Global Dimension 1 Code" := InvPostingBuffer[1]."Global Dimension 1 Code";
      DeferralPostBuffer[1]."Global Dimension 2 Code" := InvPostingBuffer[1]."Global Dimension 2 Code";

      DeferralPostBuffer[2] := DeferralPostBuffer[1];
      IF DeferralPostBuffer[2].FIND THEN BEGIN
        DeferralPostBuffer[2].Amount += DeferralPostBuffer[1].Amount;
        DeferralPostBuffer[2]."Amount (LCY)" += DeferralPostBuffer[1]."Amount (LCY)";
        DeferralPostBuffer[2]."Sales/Purch Amount" += DeferralPostBuffer[1]."Sales/Purch Amount";
        DeferralPostBuffer[2]."Sales/Purch Amount (LCY)" += DeferralPostBuffer[1]."Sales/Purch Amount (LCY)";

        IF NOT DeferralPostBuffer[1]."System-Created Entry" THEN
          DeferralPostBuffer[2]."System-Created Entry" := FALSE;
        IF IsCombinedDeferralZero THEN
          DeferralPostBuffer[2].DELETE
        ELSE
          DeferralPostBuffer[2].MODIFY;
      END ELSE
        DeferralPostBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE RoundDeferralsForArchive@126(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37);
    VAR
      DeferralHeader@1004 : Record 1701;
      AmtToDefer@1002 : Decimal;
      AmtToDeferACY@1003 : Decimal;
    BEGIN
      SalesLine.SETFILTER("Deferral Code",'<>%1','');
      IF SalesLine.FINDSET THEN
        REPEAT
          IF DeferralHeader.GET(DeferralUtilities.GetSalesDeferralDocType,'','',
               SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
          THEN
            DeferralUtilities.RoundDeferralAmount(
              DeferralHeader,SalesHeader."Currency Code",
              SalesHeader."Currency Factor",SalesHeader."Posting Date",
              AmtToDeferACY,AmtToDefer);

        UNTIL SalesLine.NEXT = 0;
    END;

    LOCAL PROCEDURE GetAmountsForDeferral@127(SalesLine@1001 : Record 37;VAR AmtToDefer@1002 : Decimal;VAR AmtToDeferACY@1003 : Decimal;VAR DeferralAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1005 : Record 1700;
    BEGIN
      DeferralTemplate.GET(SalesLine."Deferral Code");
      DeferralTemplate.TESTFIELD("Deferral Account");
      DeferralAccount := DeferralTemplate."Deferral Account";

      IF TempDeferralHeader.GET(DeferralUtilities.GetSalesDeferralDocType,'','',
           SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        AmtToDeferACY := TempDeferralHeader."Amount to Defer";
        AmtToDefer := TempDeferralHeader."Amount to Defer (LCY)";
      END;

      IF NOT SalesLine.IsCreditDocType THEN BEGIN
        AmtToDefer := -AmtToDefer;
        AmtToDeferACY := -AmtToDeferACY;
      END;
    END;

    LOCAL PROCEDURE CheckMandatoryHeaderFields@128(SalesHeader@1000 : Record 36);
    BEGIN
      SalesHeader.TESTFIELD("Document Type");
      //**4PS.sn
      IF ChargePlantToProject OR ChargeJobOrderToPlant THEN BEGIN
        ProjRec.CHANGECOMPANY(SalesHeader."Company Name");
        ProjRec.GET(SalesHeader."Job No.");
      END ELSE BEGIN
        IF ChargePlantToServOrder OR ChargeSOToJobPlantLoc THEN BEGIN
          ServOrderRec.CHANGECOMPANY(SalesHeader."Company Name");
          ServOrderRec.GET(SalesHeader."Service Order No.");
        END ELSE BEGIN
          IF NOT InternalChargePlantOnLoc('') THEN BEGIN
      //**4PS.en
            SalesHeader.TESTFIELD("Sell-to Customer No.");
            SalesHeader.TESTFIELD("Bill-to Customer No.");
      //**4PS.sn
          END;
        END;
      END;
      IF SalesHeader.Status = SalesHeader.Status::Closed THEN
        SalesHeader.FIELDERROR(Status);
      //**4PS.en
      SalesHeader.TESTFIELD("Posting Date");
      SalesHeader.TESTFIELD("Document Date");
    END;

    LOCAL PROCEDURE DefaultGLAccount@129(DeferralCode@1000 : Code[10];AmtToDefer@1001 : Decimal;GLAccNo@1002 : Code[20];DeferralAccNo@1003 : Code[20]) : Code[20];
    BEGIN
      IF (DeferralCode <> '') AND (AmtToDefer = 0) THEN
        EXIT(DeferralAccNo);

      EXIT(GLAccNo);
    END;

    LOCAL PROCEDURE IsCombinedDeferralZero@130() : Boolean;
    BEGIN
      IF (DeferralPostBuffer[2].Amount = 0) AND (DeferralPostBuffer[2]."Amount (LCY)" = 0) AND
         (DeferralPostBuffer[2]."Sales/Purch Amount" = 0) AND (DeferralPostBuffer[2]."Sales/Purch Amount (LCY)" = 0)
      THEN
        EXIT(TRUE);

      EXIT(FALSE);
    END;

    LOCAL PROCEDURE ClearPostBuffers@132();
    BEGIN
      CLEAR(PostPlantEntry);  //**4PS.n
      CLEAR(WhsePostRcpt);
      CLEAR(WhsePostShpt);
      CLEAR(GenJnlPostLine);
      CLEAR(ResJnlPostLine);
      CLEAR(JobPostLine);
      CLEAR(ItemJnlPostLine);
      CLEAR(WhseJnlPostLine);
    END;

    LOCAL PROCEDURE SetShipInvoiceReceiveFlags@138(VAR SalesHeader@1000 : Record 36);
    BEGIN
      CASE SalesHeader."Document Type" OF
        SalesHeader."Document Type"::Order:
          SalesHeader.Receive := FALSE;
        SalesHeader."Document Type"::Invoice:
          BEGIN
            SalesHeader.Ship := TRUE;
            SalesHeader.Invoice := TRUE;
            SalesHeader.Receive := FALSE;
          END;
        SalesHeader."Document Type"::"Return Order":
          SalesHeader.Ship := FALSE;
        SalesHeader."Document Type"::"Credit Memo":
          BEGIN
            SalesHeader.Ship := FALSE;
            SalesHeader.Invoice := TRUE;
            SalesHeader.Receive := TRUE;
          END;
      END;
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostSalesDoc@133(VAR SalesHeader@1000 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostCommitSalesDoc@134(VAR SalesHeader@1000 : Record 36;VAR GenJnlPostLine@1003 : Codeunit 12;PreviewMode@1001 : Boolean;ModifyHeader@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostSalesDoc@135(VAR SalesHeader@1001 : Record 36;VAR GenJnlPostLine@1000 : Codeunit 12;SalesShptHdrNo@1002 : Code[20];RetRcpHdrNo@1003 : Code[20];SalesInvHdrNo@1004 : Code[20];SalesCrMemoHdrNo@1005 : Code[20]);
    BEGIN
    END;

    LOCAL PROCEDURE PostResJnlLine@136(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1002 : Record 37;VAR JobTaskSalesLine@1003 : Record 37);
    VAR
      ResJnlLine@1001 : Record 207;
    BEGIN
      IF SalesLine."Qty. to Invoice" <> 0 THEN BEGIN
        ResJnlLine.INIT;
        ResJnlLine."Posting Date" := SalesHeader."Posting Date";
        ResJnlLine."Document Date" := SalesHeader."Document Date";
        ResJnlLine."Reason Code" := SalesHeader."Reason Code";
        ResJnlLine."Resource No." := SalesLine."No.";
        ResJnlLine.Description := SalesLine.Description;
        ResJnlLine."Source Type" := ResJnlLine."Source Type"::Customer;
        ResJnlLine."Source No." := SalesLine."Sell-to Customer No.";
        ResJnlLine."Work Type Code" := SalesLine."Work Type Code";
        ResJnlLine."Job No." := SalesLine."Job No.";
        ResJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";
        ResJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        ResJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        ResJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
        ResJnlLine."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        ResJnlLine."Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
        ResJnlLine."Entry Type" := ResJnlLine."Entry Type"::Sale;
        ResJnlLine."Document No." := GenJnlLineDocNo;
        ResJnlLine."External Document No." := GenJnlLineExtDocNo;
        ResJnlLine.Quantity := -SalesLine."Qty. to Invoice";
        ResJnlLine."Unit Cost" := SalesLine."Unit Cost (LCY)";
        ResJnlLine."Total Cost" := SalesLine."Unit Cost (LCY)" * ResJnlLine.Quantity;
        ResJnlLine."Unit Price" := -SalesLine.Amount / SalesLine.Quantity;
        ResJnlLine."Total Price" := -SalesLine.Amount;
        ResJnlLine."Source Code" := SrcCode;
        ResJnlLine."Posting No. Series" := SalesHeader."Posting No. Series";
        ResJnlLine."Qty. per Unit of Measure" := SalesLine."Qty. per Unit of Measure";
        ResJnlPostLine.RunWithCheck(ResJnlLine);
        IF JobTaskSalesLine."Job Contract Entry No." > 0 THEN
          PostJobContractLine(JobTaskSalesLine);
      END;
    END;

    LOCAL PROCEDURE UpdateSalesLineDimSetIDFromAppliedEntry@137(VAR SalesLineToPost@1000 : Record 37;SalesLine@1001 : Record 37);
    VAR
      ItemLedgEntry@1002 : Record 32;
      DimensionMgt@1003 : Codeunit 408;
      DimSetID@1004 : ARRAY [10] OF Integer;
    BEGIN
      DimSetID[1] := SalesLine."Dimension Set ID";
      WITH SalesLineToPost DO BEGIN
        IF "Appl.-to Item Entry" <> 0 THEN BEGIN
          ItemLedgEntry.GET("Appl.-to Item Entry");
          DimSetID[2] := ItemLedgEntry."Dimension Set ID";
        END;
        "Dimension Set ID" :=
          DimensionMgt.GetCombinedDimensionSetID(DimSetID,"Shortcut Dimension 1 Code","Shortcut Dimension 2 Code");
      END;
    END;

    LOCAL PROCEDURE CheckDeferralPosting@157(SalesHeader@1000 : Record 36);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETFILTER("Qty. to Invoice",'<>%1',0);
      SalesLine.SETFILTER("Deferral Code",'<>%1','');
      IF SalesLine.FINDSET THEN
        REPEAT
          IF SalesLine."Line Discount Amount" <> 0 THEN
            ERROR(
              STRSUBSTNO(
                CannotPostDiscountDeferralErr,
                SalesLine."Line No.",SalesLine.FIELDCAPTION("Line Discount Amount")));
          IF SalesLine."Inv. Discount Amount" <> 0 THEN
            ERROR(
              STRSUBSTNO(
                CannotPostDiscountDeferralErr,
                SalesLine."Line No.",SalesLine.FIELDCAPTION("Inv. Discount Amount")));
        UNTIL SalesLine.NEXT = 0;
    END;

    LOCAL PROCEDURE CalcDeferralAmounts@164(SalesHeader@1000 : Record 36;SalesLine@1003 : Record 37;OriginalDeferralAmount@1002 : Decimal);
    VAR
      DeferralHeader@1004 : Record 1701;
      DeferralLine@1005 : Record 1702;
      CurrExchRate@1006 : Record 330;
      TotalAmountLCY@1009 : Decimal;
      TotalAmount@1010 : Decimal;
      TotalDeferralCount@1007 : Integer;
      DeferralCount@1008 : Integer;
      UseDate@1001 : Date;
    BEGIN
      // Populate temp and calculate the LCY amounts for posting
      IF SalesHeader."Posting Date" = 0D THEN
        UseDate := WORKDATE
      ELSE
        UseDate := SalesHeader."Posting Date";

      IF DeferralHeader.GET(
           DeferralUtilities.GetSalesDeferralDocType,'','',SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        TempDeferralHeader := DeferralHeader;
        IF SalesLine.Quantity <> SalesLine."Qty. to Invoice" THEN
          TempDeferralHeader."Amount to Defer" :=
            ROUND(TempDeferralHeader."Amount to Defer" *
              SalesLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");
        Increment(TotalDeferralHeader."Amount to Defer",TempDeferralHeader."Amount to Defer");
        TempDeferralHeader."Amount to Defer (LCY)" :=
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
              UseDate,SalesHeader."Currency Code",
      //      TotalDeferralHeader."Amount to Defer",SalesHeader."Currency Factor")) - //**4PS.o
              TotalDeferralHeader."Amount to Defer",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
          TotalDeferralHeader."Amount to Defer (LCY)";
        TempDeferralHeader.INSERT;

        WITH DeferralLine DO BEGIN
          SETRANGE("Deferral Doc. Type",DeferralHeader."Deferral Doc. Type");
          SETRANGE("Gen. Jnl. Template Name",DeferralHeader."Gen. Jnl. Template Name");
          SETRANGE("Gen. Jnl. Batch Name",DeferralHeader."Gen. Jnl. Batch Name");
          SETRANGE("Document Type",DeferralHeader."Document Type");
          SETRANGE("Document No.",DeferralHeader."Document No.");
          SETRANGE("Line No.",DeferralHeader."Line No.");
          IF FINDSET THEN BEGIN
            TotalDeferralCount := COUNT;
            REPEAT
              DeferralCount := DeferralCount + 1;
              TempDeferralLine.INIT;
              TempDeferralLine := DeferralLine;

              IF DeferralCount = TotalDeferralCount THEN BEGIN
                TempDeferralLine.Amount := TempDeferralHeader."Amount to Defer" - TotalAmount;
                TempDeferralLine."Amount (LCY)" := TempDeferralHeader."Amount to Defer (LCY)" - TotalAmountLCY;
              END ELSE BEGIN
                IF SalesLine.Quantity <> SalesLine."Qty. to Invoice" THEN
                  TempDeferralLine.Amount :=
                    ROUND(TempDeferralLine.Amount *
                      SalesLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");

                TempDeferralLine."Amount (LCY)" :=
                  ROUND(
                    CurrExchRate.ExchangeAmtFCYToLCY(
                      0, '', //**4PS.n
                      UseDate,SalesHeader."Currency Code",
      //              TempDeferralLine.Amount,SalesHeader."Currency Factor")); //**4PS.o
                      TempDeferralLine.Amount,SalesHeader."Currency Factor",TRUE)); //**4PS.n
                TotalAmount := TotalAmount + TempDeferralLine.Amount;
                TotalAmountLCY := TotalAmountLCY + TempDeferralLine."Amount (LCY)";
              END;
              TempDeferralLine.INSERT;
            UNTIL NEXT = 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE CreatePostedDeferralScheduleFromSalesDoc@165(SalesLine@1008 : Record 37;NewDocumentType@1007 : Integer;NewDocumentNo@1003 : Code[20];NewLineNo@1002 : Integer;PostingDate@1000 : Date);
    VAR
      PostedDeferralHeader@1006 : Record 1704;
      PostedDeferralLine@1005 : Record 1705;
      DeferralTemplate@1004 : Record 1700;
      DeferralAccount@1001 : Code[20];
    BEGIN
      IF DeferralTemplate.GET(SalesLine."Deferral Code") THEN
        DeferralAccount := DeferralTemplate."Deferral Account";

      IF TempDeferralHeader.GET(
           DeferralUtilities.GetSalesDeferralDocType,'','',SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        PostedDeferralHeader.InitFromDeferralHeader(TempDeferralHeader,'','',
          NewDocumentType,NewDocumentNo,NewLineNo,DeferralAccount,SalesLine."Sell-to Customer No.",PostingDate);
        WITH TempDeferralLine DO BEGIN
          SETRANGE("Deferral Doc. Type",DeferralUtilities.GetSalesDeferralDocType);
          SETRANGE("Gen. Jnl. Template Name",'');
          SETRANGE("Gen. Jnl. Batch Name",'');
          SETRANGE("Document Type",SalesLine."Document Type");
          SETRANGE("Document No.",SalesLine."Document No.");
          SETRANGE("Line No.",SalesLine."Line No.");
          IF FINDSET THEN BEGIN
            REPEAT
              PostedDeferralLine.InitFromDeferralLine(
                TempDeferralLine,'','',NewDocumentType,NewDocumentNo,NewLineNo,DeferralAccount);
            UNTIL NEXT = 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE DeleteWhseRqst@122(SalesHeader@1001 : Record 36);
    VAR
      WarehouseRequest@1000 : Record 5765;
    BEGIN
      WarehouseRequest.SETCURRENTKEY("Source Type","Source Subtype","Source No.");
      WarehouseRequest.SETRANGE("Source Type",DATABASE::"Sales Line");
      WarehouseRequest.SETRANGE("Source Subtype",SalesHeader."Document Type");
      WarehouseRequest.SETRANGE("Source No.",SalesHeader."No.");
      IF NOT WarehouseRequest.ISEMPTY THEN
        WarehouseRequest.DELETEALL;
    END;

    PROCEDURE PostingJobServicePlant@1100525025();
    VAR
      PlantPosted@1100409000 : Boolean;
      CustPostingGr@1100525001 : Record 92;
    BEGIN
      //**4PS
      JobLedgEntryNo := 0; //DP00121
      ServLedgEntryNo := 0; //DP00121
      WITH SalesHeader DO BEGIN
        IF ((NOT "Plant Invoice") AND (NOT SalesLine.IsPlantService))
           //OR (("Plant Invoice") AND (SalesLine."Job No." <> '')) //C020546.o
           OR ChargePlantToOwnProj
           OR ChargeJobOrderToOwnPlant
           OR ChargeSOToJobPlantLoc
        THEN BEGIN //DP00195

          IF (SalesLine."Job No." <> '') AND (SalesLine."Qty. to Invoice" <> 0) THEN BEGIN
            // Post job entry
            JobJnlLine.INIT;
            JobJnlLine."Posting Date" := "Posting Date";
            JobJnlLine."Document Date" := "Document Date";
            JobJnlLine."Country/Region Code" := "VAT Country/Region Code";
            JobJnlLine."Reason Code" := "Reason Code";
            JobJnlLine."Job No." := SalesLine."Job No.";
            JobJnlLine."No." := SalesLine."No.";
            JobJnlLine."Variant Code" := SalesLine."Variant Code";
            ProjRec.GET(SalesLine."Job No.");
            //IF JobSetUp."Posting Element Mandatory" THEN    //**4PS02.o
            IF ProjRec."Posting Element Mandatory" THEN       //**4PS02.n
              SalesLine.TESTFIELD(Element);
            SalesLine.TESTFIELD("Shortcut Dimension 2 Code");
            //IF "Plant Invoice" THEN BEGIN
            IF ChargePlantToOwnProj() OR ChargeJobOrderToOwnPlant() OR ChargeSOToJobPlantLoc THEN BEGIN //DP00195
              JobSetUp.GET;
              DimMgt.GetDimValueRec(2,SalesLine."Shortcut Dimension 2 Code",DimValRec,TRUE,SalesLine."Job No.");
              JobJnlLine."No." := ProjTypeRec.GetWipAcc(ProjRec."Project Type",
                                                        DimValRec."Cost Type",
                                                        ProjRec."Project Status",
                                                        JobSetUp."Provisions at Closure",
                                                        COMPANYNAME,
                                                        DimValRec."Cost Type",'');
            END;
            JobJnlLine.Element := SalesLine.Element;
            JobJnlLine."Extension Contract" := SalesLine."Extension Contract";
            JobJnlLine."Employee No." := SalesLine."Employee No.";
            JobJnlLine.Description := SalesLine.Description;
            JobJnlLine."Description 2" := SalesLine."Description 2";  //**4PS01.n
            JobJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";
            JobJnlLine."Location Code" := SalesLine."Location Code";
            JobJnlLine."Posting Group" := SalesLine."Posting Group";
            JobJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
            IF (NOT "Plant Invoice") OR ChargeSOToJobPlantLoc THEN BEGIN  //DP00195
              JobJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
              DimMgt.ValidateShortcutDimValues(1,JobJnlLine."Shortcut Dimension 1 Code",JobJnlLine."Dimension Set ID");
            END;
            JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
            JobJnlLine."Work Type Code" := SalesLine."Work Type Code";
            JobJnlLine."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
            JobJnlLine."Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
            JobJnlLine."Transaction Type" := SalesLine."Transaction Type";
            JobJnlLine."Transport Method" := SalesLine."Transport Method";
            JobJnlLine."Entry/Exit Point" := SalesLine."Exit Point";
            JobJnlLine.Area := SalesLine.Area;
            JobJnlLine."Transaction Specification" := SalesLine."Transaction Specification";
            JobJnlLine."Document No." := GenJnlLineDocNo;
            JobJnlLine."Document Line No." := SalesLine."Line No.";  //*32988.n
            JobJnlLine."External Document No." := GenJnlLineExtDocNo;
            JobJnlLine.Type := 3 - SalesLine.Type;

            IF "Plant Invoice" THEN BEGIN
              JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Usage;
              IF SalesLine."Number of Time Units" = 0 THEN BEGIN
                JobJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice");
                JobJnlLine."Quantity (Base)" := ROUND(SalesLine."Qty. to Invoice (Base)");
              END ELSE BEGIN
                JobJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice" * SalesLine."Number of Time Units");
                JobJnlLine."Quantity (Base)" := ROUND(SalesLine."Qty. to Invoice (Base)" * SalesLine."Number of Time Units");
              END;
              IF ChargeSOToJobPlantLoc THEN BEGIN //DP00195 sn.
                JobJnlLine.Quantity := JobJnlLine.Quantity;
                JobJnlLine."Total Cost (LCY)" := SalesLine."Amount (LCY)";
                JobJnlLine.Quantity := ABS(JobJnlLine.Quantity);
              END ELSE BEGIN //DP00195 en.
                JobJnlLine.Quantity := -JobJnlLine.Quantity;
                JobJnlLine."Total Cost (LCY)" := -SalesLine."Amount (LCY)";
                JobJnlLine.Quantity := ABS(JobJnlLine.Quantity);
              END;
              IF JobJnlLine."Total Cost (LCY)" < 0 THEN
                JobJnlLine.Quantity := -JobJnlLine.Quantity;
              JobJnlLine."Rental Period" := SalesLine."Rental Period";
            END ELSE BEGIN
              JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Sale;
              JobJnlLine.Quantity := -SalesLine."Qty. to Invoice";
              JobJnlLine."Quantity (Base)" := -SalesLine."Qty. to Invoice (Base)";
              IF SalesLine."Currency Code" <> '' THEN BEGIN
                JobJnlLine."Total Price (LCY)" := -SalesLine."Amount (LCY)";
                JobJnlLine."Total Price" := -SalesLineACY.Amount; //RFC 305
              END ELSE BEGIN
                JobJnlLine."Total Price (LCY)" := -SalesLine.Amount;
              END;
            END;

            JobJnlLine."Source Code" := SrcCode;
            JobJnlLine."Posting No. Series" := "Posting No. Series";
            JobJnlLine."Source Currency Code" := "Currency Code";
            JobJnlLine."Qty. per Unit of Measure" := SalesLine."Qty. per Unit of Measure";
            JobJnlLine."Plant Invoice" := SalesLine."Plant Invoice";
            IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc THEN //DP00195
              JobJnlLine."Source Currency Total Cost" := -SalesLineACY."Amount (LCY)"
            ELSE
              JobJnlLine."Source Currency Total Price" := -SalesLineACY.Amount;

            JobJnlLine."Project Invoice" := SalesLine."Project Invoice";
            JobJnlLine."Installment Invoice" := SalesLine."Installment Invoice";
            JobJnlLine.Principal := SalesLine."Sell-to Customer No.";
            JobJnlLine."Installment No." := SalesLine."Installment No.";
            JobJnlLine."Installment Motivation" := SalesLine."Installment Motivation";
            JobJnlLine."Plot No." := SalesLine."Plot No.";
            JobJnlLine."Failure No." := SalesLine."Failure No.";
            JobJnlLine."Commision No." := SalesLine."Commission No.";
            JobJnlLine."Settl.Sheet No." := SalesLine."Settl.Sheet No.";
            JobJnlLine."Cost Plus Line No." := SalesLine."Cost Plus Line No.";
            CustPostingGr.GET(SalesHeader."Customer Posting Group");
            JobJnlLine."WIP Balance Account" := CustPostingGr."Receivables Account";
            JobJnlLine.Chargeable := FALSE;
            JobJnlLine."Service Order No." := SalesLine."Service Order No.";
            JobJnlLine."Service Contract No." := SalesLine."Service Contract No.";
            JobJnlLine."Service Location No." := SalesLine."Service Location No.";
            JobJnlLine."Item No." := SalesLine."Item No.";
            JobJnlLine."Basic Item" := SalesLine."Basic Item";
            JobJnlLine."Trade Item" := SalesLine."Trade Item";
            JobJnlLine."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
            JobJnlLine.Manufacturer := SalesLine.Manufacturer;
            JobJnlLine."Rental Unit" := SalesLine."Rental Unit";
            JobJnlLine."Rental Period" := SalesLine."Rental Period";
            JobJnlLine."Cost Entry No. Project Ledger":= SalesLine."Cost Entry No. Project Ledger";
            JobJnlLine."Cost Component" := SalesLine."Cost Component";
            JobJnlLine."Removal Contribution" := SalesLine."Removal Contribution";  //db, 18-09-06
            JobJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin"; //hs, 16-10-07
            JobJnlLine."Tariff No." := SalesLine."Tariff No."; //**4PS05.n
            JobJnlLine."Net Weight" := SalesLine."Net Weight"; //**4PS05.n
            JobJnlLine."Original Cost Type" := JobJnlLine."Original Cost Type"::" ";
            IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
              JobJnlLine."Original Cost Type" := SalesLine."Cost Type Cost Plus Line" + 1;

            IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc THEN BEGIN   //DP00195
              //Plant dimensions are posted, now retrieve project dimensions
              //JobJnlLine.VALIDATE("Job No."); //this activates function CreateDim which fills tempdimbuffer2
              //* Note: Not anymore validate job, there Total Cost become zero, direct here CreateDim
              JobJnlLine.CreateDim(
                DATABASE::Job,JobJnlLine."Job No.",
                DimMgt.TypeToTableID2(JobJnlLine.Type),JobJnlLine."No.",
                DATABASE::"Service Order",JobJnlLine."Service Order No.",  //** 4PS 10-06-2010
                DATABASE::"Resource Group",JobJnlLine."Resource Group No.",
                DATABASE::Location,"Location Code");
              JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code"; //*27409.n Repair, modified in CreateDim
              DimMgt.ValidateShortcutDimValues(2,JobJnlLine."Shortcut Dimension 2 Code",JobJnlLine."Dimension Set ID");
            END;

            IF NOT CompressPlantEntries(JobJnlLine,TRUE) THEN BEGIN
              JobJnlPostLine.RunWithCheck(JobJnlLine);
              JobLedgEntryNo := JobJnlPostLine.GetJobLedgEntryNo; //DP00121
            END;

            //DP00195 sn.
            IF ChargeSOToJobPlantLoc THEN  BEGIN
                  JobJnlLine."Total Price (LCY)" := -JobJnlLine."Total Cost (LCY)";
                  JobJnlLine."Total Cost (LCY)" :=0;
            END;
            //DP00195 en.

            PostWipJobOrderPlant;
            PostWipProjectPlant;
            PostComplWipProjectPlant;
            PostComplRevenueFixedPriceProj;
            PostSurcharge(0);
          END;
        END;

        PlantPosted := FALSE;  //*C003125.n
      //DP00195 sn.
        IF  ((SalesLine.IsPlantService) AND (SalesLine."Qty. to Invoice" <> 0))
            AND NOT (ChargeSOToCustomerPlantLoc OR ChargeSOToJobPlantLoc) THEN BEGIN
          ServOrderRec.GET("Service Order No.");
          IF ServOrderRec.IsPlantServiceOrder THEN BEGIN
            ServOrderRec.TESTFIELD("Plant Type");
            ServOrderRec.TESTFIELD("Cost Component Plant");
            PlantSetupRec.GET;
            IF (ServOrderRec."Cost Component Plant" = PlantSetupRec."Cost Component Acquisition") OR
               (ServOrderRec."Cost Component Plant" = PlantSetupRec."Cost Component Rent")
            THEN
              ServOrderRec.FIELDERROR("Cost Component Plant");
            IF ChargeSOToCustomerPlantLoc OR ChargeSOToPlantItem THEN BEGIN
              ServJnlLine.INIT;
              ServJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
              ServJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
              ServJnlLine."Service Order No." := SalesLine."Service Order No.";
              ServJnlLine.VALIDATE("Total Cost (LCY)", -SalesLine.Amount);
              PostWipServicePlant;
            END;
            PostPlant(TRUE,FALSE);
            PlantPosted := TRUE;
          END;
        END ELSE BEGIN
      //DP00195 en.
          IF ("Project Invoice") AND (SalesLine."Job No." <> '') THEN BEGIN
            ProjRec.GET(SalesLine."Job No.");
            IF ProjRec."Small Project" AND (ProjRec."Plant Job Order") THEN BEGIN
              ProjRec.TESTFIELD("Plant Type");
              ProjRec.TESTFIELD("Cost Component Plant");
              PlantSetupRec.GET;
              IF (ProjRec."Cost Component Plant" = PlantSetupRec."Cost Component Acquisition") OR
                 (ProjRec."Cost Component Plant" = PlantSetupRec."Cost Component Rent")
              THEN
                ProjRec.FIELDERROR("Cost Component Plant");
              PostPlant(TRUE,FALSE);
              PlantPosted := TRUE;  //*C003125.n
            END;
          END;
        END;

        IF "Plant Invoice" AND (NOT PlantTransportInternalCust) AND
           (SalesLine."Job No." = '') AND (SalesLine."Plant Location" = '') AND
           (SalesLine."Plant Invoice Origin" = SalesLine."Plant Invoice Origin"::"Transport Order") AND
           (SalesLine."Relate to" IN [SalesLine."Relate to"::Transport, SalesLine."Relate to"::"Load/Unload"])
        THEN BEGIN
          PlantTransportInternalCust := TRUE;
          PlantSetupRec.GET;
          PlantSetupRec.TESTFIELD("Internal Bal. Account Cost");
        END;

        IF "Plant Invoice" AND (SalesLine.Type = SalesLine.Type::"G/L Account") AND (NOT SalesLine.IsPlantService) THEN BEGIN //DP00195
        //*C003125.sn
        //IF ("Plant Invoice" OR
        //    ((SalesLine."Plant Type" <> '') AND (NOT PlantPosted))) AND
        //   (SalesLine.Type = SalesLine.Type::"G/L Account")
        //THEN
        //*C003125.en
          PostPlant(FALSE,FALSE);
          PostInternalChargePlantOnLoc();  //DP00815
        END;
        IF ((SalesLine."Service Order No." <> '') OR
            (SalesLine."Service Contract No." <> '')) AND
            (SalesLine."Qty. to Invoice" <> 0)  //db, 17-01-11: M24989
        THEN BEGIN
            IF ((NOT "Plant Invoice") OR ChargePlantToOwnServOrder OR ChargeSOToCustomerPlantLoc) THEN BEGIN //DP00195
            PostService;
            PostWipServicePlant;
            PostComplWipServicePlant;
            PostComplRevenueFixedPriceServ;
            PostSurcharge(1);
          END;
        END;

        //IF "Sales Document Type" IN ["Sales Document Type"::"Sales Logistics Separated","Sales Document Type"::RentalContract] THEN //DP00617.o
        IF "Rental Unit Invoice" OR   //DP00617.n
           ("Sales Document Type" IN ["Sales Document Type"::"Sales Logistics Separated","Sales Document Type"::RentalContract])
        THEN
          UpdateInvoiceNosSource(TRUE,GenJnlLineDocNo);
      END;
      //CopyAndCheckDocDimToTempDocDim; //call 26359 call 28266
    END;

    LOCAL PROCEDURE ChargeJobOrderToPlant@1100485021() : Boolean;
    VAR
      lvProjRec@1100485000 : Record 11072003;
    BEGIN
      //**4PS
      IF (SalesHeader."Job No." <> '') THEN BEGIN
        IF SalesHeader."Project Invoice" THEN BEGIN
          IF lvProjRec.GET(SalesHeader."Job No.") THEN BEGIN
            IF (lvProjRec."Small Project" AND lvProjRec."Plant Job Order") THEN
              EXIT(TRUE);
          END;
        END;
      END;

      EXIT(FALSE);
    END;

    LOCAL PROCEDURE ChargeJobOrderToOwnPlant@1100485022() : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargeJobOrderToPlant AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)));
    END;

    LOCAL PROCEDURE ChargePlantToProject@5817() : Boolean;
    BEGIN
      //**4PS
      EXIT(SalesHeader."Plant Invoice" AND (SalesHeader."Job No." <> ''));
    END;

    LOCAL PROCEDURE ChargePlantToOwnProj@5821() : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargePlantToProject AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)) AND
        NOT ChargeSOToPlantItem); //DP00195
    END;

    LOCAL PROCEDURE ChargePlantToServOrder@1100525009() : Boolean;
    BEGIN
      //**4PS
      EXIT(SalesHeader."Plant Invoice" AND (SalesHeader."Service Order No." <> '') AND NOT ChargeSOToCustomerPlantLoc);//DP00195
    END;

    LOCAL PROCEDURE ChargePlantToOwnServOrder@1100525007() : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargePlantToServOrder AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)));
    END;

    PROCEDURE ChargeSOToPlantItem@1100529900() : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
        IF ServiceOrder.IsPlantServiceOrder AND (NOT SalesHeader."Plant Invoice") THEN
          EXIT(TRUE);
      EXIT(FALSE);
    END;

    PROCEDURE ChargeSOToJobPlantLoc@1100529901() : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
        IF (ServiceOrder.IsPlantServiceOrder AND SalesHeader."Plant Invoice" AND (SalesLine."Job No." <> '')) THEN
          IF PlantInvoiceIsCreateByService() THEN  //C022679
            EXIT(TRUE);
      EXIT(FALSE);
    END;

    PROCEDURE ChargeSOToCustomerPlantLoc@1100529902() : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
        IF ServiceOrder.IsPlantServiceOrder AND SalesHeader."Plant Invoice" AND (SalesLine."Job No." = '') THEN
          IF PlantInvoiceIsCreateByService() THEN  //C022679
            EXIT(TRUE);
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE InternalChargePlantOnLoc@1100529000(PlantLoc@1100529002 : Code[20]) : Boolean;
    VAR
      SalesLine@1100529000 : Record 37;
      PlantLocation@1100529001 : Record 11012554;
    BEGIN
      //**4PS DP00815
      IF SalesHeader."Plant Invoice" AND (SalesHeader."Sell-to Customer No." = '') AND
        (SalesHeader."Job No." = '') AND (SalesHeader."Service Order No." = '') AND
        ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME))
      THEN BEGIN
        IF PlantLoc = '' THEN BEGIN
          SalesLine.SETRANGE("Document Type", SalesHeader."Document Type");
          SalesLine.SETRANGE("Document No.", SalesHeader."No.");
          SalesLine.SETFILTER("Plant Location", '<>%1', '');
          IF SalesLine.FINDFIRST THEN
            PlantLoc := SalesLine."Plant Location";
        END;
        IF PlantLoc <> '' THEN BEGIN
          IF PlantLocation.GET(PlantLoc) THEN
            EXIT(PlantLocation."Plant Type" <> '');
        END;
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE PlantInvoiceIsCreateByService@1100525014() : Boolean;
    VAR
      SalesLine2@1100525000 : Record 37;
    BEGIN
      //C022679
      IF NOT SalesHeader."Plant Invoice" THEN
        EXIT(FALSE);
      SalesLine2.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.", SalesHeader."No.");
      SalesLine2.SETRANGE(IsPlantService, TRUE);
      EXIT(NOT SalesLine2.ISEMPTY);
    END;

    LOCAL PROCEDURE CompressPlantEntries@5819(IJobJnlLineRec@1100485000 : Record 11072008;IPostMode@1100485001 : Boolean) : Boolean;
    VAR
      LineNo@11012000 : Integer;
    BEGIN
      //**4PS
      //* If 'PostMode' then add record to tmp-table, otherwise only check if compress is applicable.
      //* Necessary because this function is called twice at surcharges, with the result that
      //* double job entries of surcharges were in tmp-table.

      IF NOT ChargePlantToOwnProj THEN
        EXIT(FALSE);

      IF CompanyData.GET(COMPANYNAME) THEN;
      IF NOT CompanyData."Compr. Proj.Ledg. Plant Entr." THEN
        EXIT(FALSE);

      IF IPostMode THEN BEGIN
        TempJobJnlLine.SETRANGE("No.",IJobJnlLineRec."No.");
        TempJobJnlLine.SETRANGE("Posting Group",IJobJnlLineRec."Posting Group");
        TempJobJnlLine.SETRANGE("Gen. Prod. Posting Group",IJobJnlLineRec."Gen. Prod. Posting Group");
        TempJobJnlLine.SETRANGE("Gen. Bus. Posting Group",IJobJnlLineRec."Gen. Bus. Posting Group");
        TempJobJnlLine.SETRANGE("Dimension Set ID",IJobJnlLineRec."Dimension Set ID");
        IF TempJobJnlLine.FIND('-') THEN BEGIN
          TempJobJnlLine."Total Cost (LCY)" += IJobJnlLineRec."Total Cost (LCY)";
          TempJobJnlLine."Source Currency Total Cost" += IJobJnlLineRec."Source Currency Total Cost";
          TempJobJnlLine.MODIFY;
        END ELSE BEGIN
          TempJobJnlLine.RESET;
          IF TempJobJnlLine.FIND('+') THEN
            LineNo := TempJobJnlLine."Line No." + 1
          ELSE
            LineNo := 1;
          TempJobJnlLine.TRANSFERFIELDS(IJobJnlLineRec);
          TempJobJnlLine."Line No." := LineNo;
          TempJobJnlLine.Description := STRSUBSTNO(Text11012001,
            SalesHeader.FIELDCAPTION("Rental Periode to Date"), SalesHeader."Rental Periode to Date");
          TempJobJnlLine.Quantity := 0;
          TempJobJnlLine."Unit of Measure Code" := '';
          TempJobJnlLine.INSERT;
        END;
      END;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE PostWipJobOrderPlant@1100485023();
    VAR
      GLAcc@1100525001 : Record 15;
    BEGIN
      //**4PS
      IF NOT (ChargeJobOrderToOwnPlant OR ChargeSOToJobPlantLoc) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'
      CLEAR(SurchargePostingBuffer[1]);
      DimMgt.GetDimValueRec(2,JobJnlLine."Shortcut Dimension 2 Code",DimValRec,TRUE,JobJnlLine."Job No.");
      JobSetUp.GET;
      ProjRec.GET(JobJnlLine."Job No.");
      SurchargePostingBuffer[1]."G/L Account" := ProjTypeRec.GetWipAcc(ProjRec."Project Type",
                                                                       DimValRec."Cost Type",
                                                                       ProjRec."Project Status",
                                                                       JobSetUp."Provisions at Closure",
                                                                       COMPANYNAME,
                                                                       DimValRec."Cost Type",'');
      SurchargePostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      SurchargePostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      SurchargePostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      SurchargePostingBuffer[1]."Job No." := JobJnlLine."Job No.";
      SurchargePostingBuffer[1].Element := JobJnlLine.Element;
      SurchargePostingBuffer[1]."Bal. Account No." := SurchargePostingBuffer[1].Element; // Because element not in key
      SurchargePostingBuffer[1]."Service Order No." := JobJnlLine."Service Order No.";
      SurchargePostingBuffer[1]."Service Contract No." := JobJnlLine."Service Contract No.";
      GLAcc.GET(SurchargePostingBuffer[1]."G/L Account");
      SurchargePostingBuffer[1].Description := GLAcc.Name;
      SurchargePostingBuffer[1].Amount := -JobJnlLine."Total Price (LCY)";
      SurchargePostingBuffer[1]."Cost Component" := JobJnlLine."Cost Component";  //** 03-06-2010 call 19568


      SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Project;

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostWipProjectPlant@1210190010();
    VAR
      GLAcc@1100525001 : Record 15;
    BEGIN
      //**4PS
      IF NOT (ChargePlantToOwnProj OR ChargeSOToJobPlantLoc) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'
      CLEAR(SurchargePostingBuffer[1]);
      DimMgt.GetDimValueRec(2,JobJnlLine."Shortcut Dimension 2 Code",DimValRec,TRUE,JobJnlLine."Job No.");
      JobSetUp.GET;
      ProjRec.GET(JobJnlLine."Job No.");
      SurchargePostingBuffer[1]."G/L Account" := ProjTypeRec.GetWipAcc(ProjRec."Project Type",
                                                                       DimValRec."Cost Type",
                                                                       ProjRec."Project Status",
                                                                       JobSetUp."Provisions at Closure",
                                                                       COMPANYNAME,
                                                                       DimValRec."Cost Type",'');
      SurchargePostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      SurchargePostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      SurchargePostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      SurchargePostingBuffer[1]."Job No." := JobJnlLine."Job No.";
      SurchargePostingBuffer[1].Element := JobJnlLine.Element;
      SurchargePostingBuffer[1]."Bal. Account No." := SurchargePostingBuffer[1].Element; // because element not in key
      SurchargePostingBuffer[1]."Service Order No." := JobJnlLine."Service Order No.";
      SurchargePostingBuffer[1]."Service Contract No." := JobJnlLine."Service Contract No.";
      GLAcc.GET(SurchargePostingBuffer[1]."G/L Account");
      SurchargePostingBuffer[1].Description := GLAcc.Name;
      SurchargePostingBuffer[1].Amount := JobJnlLine."Total Cost (LCY)";
      SurchargePostingBuffer[1]."Cost Component" := JobJnlLine."Cost Component";  //** 03-06-2010 call 19568

      SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Project;

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostWipServicePlant@1100525010();
    VAR
      GLAcc@1100525001 : Record 15;
    BEGIN
      //**4PS
      IF NOT (ChargePlantToOwnServOrder OR ChargeSOToPlantItem) OR (ServJnlLine."Total Cost (LCY)" = 0) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'
      CLEAR(SurchargePostingBuffer[1]);
      DimMgt.GetDimValueRec(2,ServJnlLine."Shortcut Dimension 2 Code",DimValRec,TRUE,'');
      ServOrderRec.GET(ServJnlLine."Service Order No.");
      IF SalesLine."Additional Cost (Service)" THEN
        ServTypeRec.Code := ServOrderRec."Service Type (Other)"
      ELSE
        ServTypeRec.Code := ServOrderRec."Service Type";
      ServTypeRec.GET(ServTypeRec.Code);
      SurchargePostingBuffer[1]."G/L Account" := ServTypeRec.GetWipAcc(ServTypeRec.Code,
                                                                       DimValRec."Cost Type",
                                                                       COMPANYNAME,
                                                                       DimValRec."Cost Type",
                                                                       '');
      SurchargePostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      SurchargePostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      SurchargePostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";
      SurchargePostingBuffer[1]."Job No." := ServJnlLine."Project No.";
      SurchargePostingBuffer[1]."Service Order No." := ServJnlLine."Service Order No.";
      SurchargePostingBuffer[1]."Service Contract No." := ServJnlLine."Service Contract No.";
      GLAcc.GET(SurchargePostingBuffer[1]."G/L Account");
      SurchargePostingBuffer[1].Description := GLAcc.Name;
      //DP00195 sn.
      IF ChargeSOToPlantItem OR ChargeSOToCustomerPlantLoc  THEN
        SurchargePostingBuffer[1].Amount := -ServJnlLine."Total Cost (LCY)"
      ELSE //DP00195 en.
        SurchargePostingBuffer[1].Amount := ServJnlLine."Total Cost (LCY)";

      SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Service;

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostInternalChargePlantOnLoc@1100529001();
    VAR
      PlantLocation@1100529001 : Record 11012554;
      PlantType@1100529003 : Record 11012551;
      PlantNumber@1100529005 : Record 11012552;
      PlantCostCompPostingSetup@1100529004 : Record 11012570;
      SaveSalesLine@1100529002 : Record 37;
      GLAcc@1100525002 : Record 15;
      ExternalPlant@1100529006 : Boolean;
    BEGIN
      //**4PS DP00815
      IF NOT InternalChargePlantOnLoc(SalesLine."Plant Location") THEN
        EXIT;

      PlantSetupRec.GET;
      PlantSetupRec.TESTFIELD("Cost Component Internal Charge");
      PlantLocation.GET(SalesLine."Plant Location");
      PlantType.GET(PlantLocation."Plant Type");
      ExternalPlant := PlantType.External;
      IF PlantLocation."Plant No." <> '' THEN BEGIN
        PlantNumber.GET(PlantLocation."Plant Type", PlantLocation."Plant No.");
        ExternalPlant := PlantNumber.External;
      END;
      IF ExternalPlant THEN
        PlantCostCompPostingSetup.GET(PlantType."Posting Group External", '', PlantSetupRec."Cost Component Internal Charge")
      ELSE
        PlantCostCompPostingSetup.GET(PlantType."Posting Group Internal", '', PlantSetupRec."Cost Component Internal Charge");
      PlantCostCompPostingSetup.TESTFIELD("Plant Cost Account");

      SaveSalesLine := SalesLine;
      SalesLine."No." := PlantCostCompPostingSetup."Plant Cost Account";
      SalesLine."Plant Type" := PlantLocation."Plant Type";
      SalesLine."Plant No." := PlantLocation."Plant No.";
      SalesLine."Qty. to Invoice" := -1; //Then in Plant Ledger the quantity will be 1
      SalesLine."Number of Time Units" := 0;  //May not have influence on the occupation
      IF PlantLocation."Internal Charge Plant Entry as" = PlantLocation."Internal Charge Plant Entry as"::NegRevenue THEN
        PostPlant(FALSE,TRUE)
      ELSE
        PostPlant(TRUE,TRUE);
      SalesLine := SaveSalesLine;

      //Note: Table(Rec) Name is 'Surcharge', here used for 'Internal Charge'
      CLEAR(SurchargePostingBuffer[1]);
      SurchargePostingBuffer[1]."G/L Account" := PlantCostCompPostingSetup."Plant Cost Account";
      SurchargePostingBuffer[1]."Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
      SurchargePostingBuffer[1]."Global Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
      SurchargePostingBuffer[1]."Dimension Set ID" := SalesLine."Dimension Set ID";
      GLAcc.GET(SurchargePostingBuffer[1]."G/L Account");
      SurchargePostingBuffer[1].Description := GLAcc.Name;
      SurchargePostingBuffer[1].Amount := -SalesLine.Amount;
      SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Plant;
      UpdateSurchargeBuffer();
    END;

    LOCAL PROCEDURE PostInvoiceProposal@5820();
    VAR
      SalesHeaderExtension@1100528600 : Record 11071868;
      TempClientFolderName@1100528400 : Text;
      FullPDFFileName@1100528401 : Text;
      DocumentDescription@1100528402 : Text[50];
    BEGIN
      //**4PS
      SalesHeaderExtension.GetSalesHeadExtension(SalesHeader."Document Type", SalesHeader."No.");
      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN BEGIN
        TempClientFolderName := SalesHeader.CreateTempClientFolderForPDF;
        SalesHeader.SaveInvoiceProposalAsPDF(TempClientFolderName, DocumentDescription, FullPDFFileName);
      END;

      SalesLine.LOCKTABLE;
      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      IF NOT SalesLine.FINDFIRST THEN
        ERROR(Text001);

      SalesHeader.CALCFIELDS("Amount Including VAT");
      SalesHeader2 := SalesHeader;
      IF SalesHeader."Amount Including VAT" < 0 THEN BEGIN
        SalesHeader2."Document Type" := SalesHeader2."Document Type"::"Credit Memo";
        SalesHeader2."Due Date" := 0D;
        SalesHeader2."Pmt. Discount Date" := 0D;
        SalesHeader2."Payment Discount %" := 0;
        // **4PS.sn
        SalesHeader2."Pmt. Discount Date 2" := 0D;
        SalesHeader2."Payment Discount % 2" := 0;
        SalesHeader2."Pmt. Discount Date 3" := 0D;
        SalesHeader2."Payment Discount % 3" := 0;
        // **4PS.en
      END ELSE
        SalesHeader2."Document Type" := SalesHeader2."Document Type"::Invoice;
      SalesHeader2."No." := '';
      SalesHeader2.VALIDATE("No.");
      SalesHeader2.INSERT(TRUE);
      SalesHeader2.VALIDATE("Location Code",SalesHeader."Location Code"); //hs, 12-11-2007 (Location Code reset during insert)
      SalesHeader2."Shortcut Dimension 1 Code" := SalesHeader."Shortcut Dimension 1 Code";  // Can be modified during insert
      SalesHeader2."Shortcut Dimension 2 Code" := SalesHeader."Shortcut Dimension 2 Code";  // Can be modified during insert
      SalesHeader2."Dimension Set ID" := SalesHeader."Dimension Set ID";
      SalesHeader2."Calculate B Amounts based on" := SalesHeader."Calculate B Amounts based on"; // Can be modified during insert //MG
      IF SalesHeader."Document Date" <> 0D THEN
        SalesHeader2.VALIDATE("Document Date", SalesHeader."Document Date"); // Can be modified during insert
      SalesHeader2.MODIFY;
      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN BEGIN
        SalesHeader2.AddProposalPDFToInvoice(DocumentDescription, FullPDFFileName);
        SalesHeader2.DeleteTempClientFolderForPDF(TempClientFolderName);
      END;

      REPEAT
        SalesLine2 := SalesLine;
        SalesLine2."Document Type" := SalesHeader2."Document Type";
        SalesLine2."Document No." := SalesHeader2."No.";
        IF (SalesHeader2."Document Type" = SalesHeader2."Document Type"::"Credit Memo") AND
           (SalesLine2.Type <> SalesLine2.Type::" ")
        THEN BEGIN
          IF SalesLine2."Number of Time Units" < 0 THEN BEGIN
            SalesLine2."Number of Time Units" := -SalesLine2."Number of Time Units";
            IF (SalesLine2."Line Amount" <> 0) OR ((SalesLine2."Line Discount %" <> 0) AND (SalesLine2."Unit Price" <> 0)) THEN  //C020103.c
              SalesLine2.VALIDATE("Line Amount", -SalesLine2."Line Amount");
          END ELSE BEGIN
            IF SalesLine2.Quantity < 0 THEN BEGIN
              IF (SalesLine2."Line Amount" <> 0) OR (SalesLine2."Line Discount %" <> 0) THEN  //C020103.c
                SalesLine2.VALIDATE(Quantity, -SalesLine2.Quantity)
              ELSE
                SalesLine2.Quantity := SalesLine2.Quantity;
            END ELSE BEGIN
              IF (SalesLine2."Unit Price" <> 0) THEN
                SalesLine2.VALIDATE("Unit Price", -SalesLine2."Unit Price");
            END;
          END;
          SalesLine2."Qty. to Ship" := 0;
          SalesLine2."Return Qty. to Receive" := SalesLine2.Quantity;
          SalesLine2."Return Qty. to Receive (Base)" := SalesLine2.Quantity;
        END;
        IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN
          SalesLine2.AddToCompressedLines(SalesHeader)
        ELSE
          SalesLine2.INSERT;
        UpdateInvoiceNosSource(FALSE,SalesHeader2."No.");
        SalesLine.DELETE;
      UNTIL SalesLine.NEXT = 0;

      SalesHeaderExtension.CopySalesHeadExtension(
        SalesHeader."Document Type", SalesHeader."No.", SalesHeader2."Document Type", SalesHeader2."No.");

      SalesHeaderExtension.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesHeaderExtension.SETRANGE("Document No.", SalesHeader."No.");
      SalesHeaderExtension.DELETEALL;
      SalesHeader.DELETE;

      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN
        SalesHeader2.SendToPosting(CODEUNIT::"Sales-Post");

      COMMIT;
    END;

    LOCAL PROCEDURE UpdateInvoiceNosSource@5818(Posted@11012000 : Boolean;NewInvNo@11012001 : Code[20]);
    VAR
      NewInvStatus@11012002 : ',Proposal,Temporary,Posted';
      OldInvStatus@11012003 : ',Proposal,Temporary,Posted';
      PlantInventoryRec2@1100485000 : Record 11012555;
      PlantOrderRec2@1100485003 : Record 11012556;
      ExitOrderRec2@1100485002 : Record 11012559;
      ReturnLossOrderRec@1100525000 : Record 11012655;
      ReturnLossOrderRec2@1100525001 : Record 11012655;
      AdjRec2@1100485001 : Record 11012565;
      PlantHourLineRec2@1100485004 : Record 11012574;
      lvTransOrderRec@1100485005 : Record 11020507;
      lvTransOrderRec2@1100485006 : Record 11020507;
      lvSalesRentalInvoiceLine@1100485007 : Record 11012788;
      lvSalesRentalInvoiceLine2@1100485008 : Record 11012788;
      lvSalesContractRec@1100485009 : Record 36;
      RentalPackage@1100529000 : Record 11012941;
      RentalPackage2@1100529002 : Record 11012941;
      RentalRateLine@1100529001 : Record 11012942;
      HistRentalPackage@1100529003 : Record 11229848;
    BEGIN
      //**4PS
      IF Posted THEN BEGIN
        OldInvStatus := OldInvStatus::"Temporary";
        NewInvStatus := NewInvStatus::Posted;
      END ELSE BEGIN
        OldInvStatus := OldInvStatus::Proposal;
        NewInvStatus := NewInvStatus::"Temporary";
      END;

      WITH SalesHeader DO BEGIN
        IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc THEN BEGIN //DP00195
          CASE SalesLine."Plant Invoice Origin" OF
            SalesLine."Plant Invoice Origin"::"Plant Inventory":
              BEGIN
                PlantInventoryRec.RESET;
                PlantInventoryRec.SETCURRENTKEY("Invoice Status","Last Invoice No.","Last Invoice Line No.");
                PlantInventoryRec.SETRANGE("Last Invoice No.","No.");
                PlantInventoryRec.SETRANGE("Last Invoice Line No.",SalesLine."Line No.");
                PlantInventoryRec.SETRANGE("Invoice Status",OldInvStatus);
                IF PlantInventoryRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantInventoryRec2 := PlantInventoryRec;
                    PlantInventoryRec2."Last Invoice No." := NewInvNo;
                    PlantInventoryRec2."Invoice Status" := NewInvStatus;
                    PlantInventoryRec2.MODIFY;
                  UNTIL PlantInventoryRec.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Plant Order":
              BEGIN
                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("From Location Invoice Status","From Location Invoice No.");
                PlantOrderRec.SETRANGE("From Location Invoice No.","No.");
                PlantOrderRec.SETRANGE("From Location Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."From Location Invoice No." := NewInvNo;
                    PlantOrderRec2."From Location Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("To Location Invoice Status","To Location Invoice No.");
                PlantOrderRec.SETRANGE("To Location Invoice No.","No.");
                PlantOrderRec.SETRANGE("To Location Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."To Location Invoice No." := NewInvNo;
                    PlantOrderRec2."To Location Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("Order Cost Invoice Status","Order Cost Invoice No.");
                PlantOrderRec.SETRANGE("Order Cost Invoice No.","No.");
                PlantOrderRec.SETRANGE("Order Cost Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."Order Cost Invoice No." := NewInvNo;
                    PlantOrderRec2."Order Cost Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Exit Order":
              BEGIN
                ExitOrderRec.RESET;
                ExitOrderRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                ExitOrderRec.SETRANGE("Invoice No.","No.");
                ExitOrderRec.SETRANGE("Invoice Status",OldInvStatus);
                IF ExitOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    ExitOrderRec2 := ExitOrderRec;
                    ExitOrderRec2."Invoice No." := NewInvNo;
                    ExitOrderRec2."Invoice Status" := NewInvStatus;
                    ExitOrderRec2.MODIFY;
                  UNTIL ExitOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Returned Loss":
              BEGIN
                ReturnLossOrderRec.RESET;
                ReturnLossOrderRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                ReturnLossOrderRec.SETRANGE("Invoice No.","No.");
                ReturnLossOrderRec.SETRANGE("Invoice Status",OldInvStatus);
                IF ReturnLossOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    ReturnLossOrderRec2 := ReturnLossOrderRec;
                    ReturnLossOrderRec2."Invoice No." := NewInvNo;
                    ReturnLossOrderRec2."Invoice Status" := NewInvStatus;
                    ReturnLossOrderRec2.MODIFY;
                  UNTIL ReturnLossOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Rental Correction":
              BEGIN
                AdjRec.RESET;
                AdjRec.SETCURRENTKEY("Invoice Status Debit Location","Invoice No. Debit Location");
                AdjRec.SETRANGE("Invoice No. Debit Location","No.");
                AdjRec.SETRANGE("Invoice Status Debit Location",OldInvStatus);
                IF AdjRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    AdjRec2 := AdjRec;
                    AdjRec2."Invoice No. Debit Location" := NewInvNo;
                    AdjRec2."Invoice Status Debit Location" := NewInvStatus;
                    AdjRec2.MODIFY;
                  UNTIL AdjRec.NEXT = 0;

                AdjRec.RESET;
                AdjRec.SETCURRENTKEY("Invoice Status Credit Location","Invoice.No.Credit Location");
                AdjRec.SETRANGE("Invoice.No.Credit Location","No.");
                AdjRec.SETRANGE("Invoice Status Credit Location",OldInvStatus);
                IF AdjRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    AdjRec2 := AdjRec;
                    AdjRec2."Invoice.No.Credit Location" := NewInvNo;
                    AdjRec2."Invoice Status Credit Location" := NewInvStatus;
                    AdjRec2.MODIFY;
                  UNTIL AdjRec.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Plant Hours":
              BEGIN
                PlantHourLineRec.RESET;
                PlantHourLineRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                PlantHourLineRec.SETRANGE("Invoice No.","No.");
                PlantHourLineRec.SETRANGE("Invoice Status",OldInvStatus);
                IF PlantHourLineRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantHourLineRec2 := PlantHourLineRec;
                    PlantHourLineRec2."Invoice No." := NewInvNo;
                    PlantHourLineRec2."Invoice Status" := NewInvStatus;
                    PlantHourLineRec2.MODIFY;
                  UNTIL PlantHourLineRec.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Transport Order":
              BEGIN
                lvTransOrderRec.RESET;
                lvTransOrderRec.SETCURRENTKEY("From Location Invoice Status","From Location Invoice No.");
                lvTransOrderRec.SETRANGE("From Location Invoice No.","No.");
                lvTransOrderRec.SETRANGE("From Location Invoice Status",OldInvStatus);
                IF lvTransOrderRec.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    lvTransOrderRec2 := lvTransOrderRec;
                    lvTransOrderRec2."From Location Invoice No." := NewInvNo;
                    lvTransOrderRec2."From Location Invoice Status" := NewInvStatus;
                    lvTransOrderRec2.FillStatusInvoiced(TRUE);
                    lvTransOrderRec2.MODIFY;
                  UNTIL lvTransOrderRec.NEXT = 0;
                END;
                lvTransOrderRec.RESET;
                lvTransOrderRec.SETCURRENTKEY("To Location Invoice Status","To Location Invoice No.");
                lvTransOrderRec.SETRANGE("To Location Invoice No.","No.");
                lvTransOrderRec.SETRANGE("To Location Invoice Status",OldInvStatus);
                IF lvTransOrderRec.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    lvTransOrderRec2 := lvTransOrderRec;
                    lvTransOrderRec2."To Location Invoice No." := NewInvNo;
                    lvTransOrderRec2."To Location Invoice Status" := NewInvStatus;
                    lvTransOrderRec2.FillStatusInvoiced(TRUE);
                    lvTransOrderRec2.MODIFY;
                  UNTIL lvTransOrderRec.NEXT = 0;
                END;
                lvTransOrderRec.RESET;
                lvTransOrderRec.SETCURRENTKEY("Internal Invoice Status","Internal Invoice No.");
                lvTransOrderRec.SETRANGE("Internal Invoice No.","No.");
                lvTransOrderRec.SETRANGE("Internal Invoice Status",OldInvStatus);
                IF lvTransOrderRec.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    lvTransOrderRec2 := lvTransOrderRec;
                    lvTransOrderRec2."Internal Invoice No." := NewInvNo;
                    lvTransOrderRec2."Internal Invoice Status" := NewInvStatus;
                    lvTransOrderRec2.FillStatusInvoiced(TRUE);
                    lvTransOrderRec2.MODIFY;
                  UNTIL lvTransOrderRec.NEXT = 0;
                END;
                lvTransOrderRec.RESET;
                lvTransOrderRec.SETCURRENTKEY("Project Invoice Status","Project Invoice No.");
                lvTransOrderRec.SETRANGE("Project Invoice No.","No.");
                lvTransOrderRec.SETRANGE("Project Invoice Status",OldInvStatus);
                IF lvTransOrderRec.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    lvTransOrderRec2 := lvTransOrderRec;
                    lvTransOrderRec2."Project Invoice No." := NewInvNo;
                    lvTransOrderRec2."Project Invoice Status" := NewInvStatus;
                    lvTransOrderRec2.FillStatusInvoiced(TRUE);
                    lvTransOrderRec2.MODIFY;
                  UNTIL lvTransOrderRec.NEXT = 0;
                END;
              END;
          END;
        END;

        IF "Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated" THEN BEGIN
          lvSalesRentalInvoiceLine.RESET;
          lvSalesRentalInvoiceLine.SETCURRENTKEY("Invoice Status","Last Invoice No.","Last Invoice Line No.");
          lvSalesRentalInvoiceLine.SETRANGE("Last Invoice No.","No.");
          lvSalesRentalInvoiceLine.SETRANGE("Last Invoice Line No.",SalesLine."Line No.");
          lvSalesRentalInvoiceLine.SETRANGE("Invoice Status",OldInvStatus);
          IF lvSalesRentalInvoiceLine.FINDSET(TRUE, TRUE) THEN
            REPEAT
              lvSalesRentalInvoiceLine2 := lvSalesRentalInvoiceLine;
              lvSalesRentalInvoiceLine2."Last Invoice No." := NewInvNo;
              lvSalesRentalInvoiceLine2."Invoice Status" := NewInvStatus;
              lvSalesRentalInvoiceLine2.MODIFY;
            UNTIL lvSalesRentalInvoiceLine.NEXT = 0;
        END;

        IF "Sales Document Type" = "Sales Document Type"::RentalContract THEN BEGIN
          IF ("Related Sales Order No." <> '') AND
             (lvSalesContractRec.GET("Document Type"::Order, "Related Sales Order No.")) AND
             (lvSalesContractRec."Rental Contract Invoice Status" = lvSalesContractRec."Rental Contract Invoice Status"::"Temporary")
          THEN BEGIN
            lvSalesContractRec."Rental Contract Invoice Status" := lvSalesContractRec."Rental Contract Invoice Status"::Invoiced;
            lvSalesContractRec.MODIFY;
          END;
        END;

        IF "Rental Unit Invoice" THEN BEGIN  //DP00617
          RentalPackage.SETCURRENTKEY("Invoice Status", "Last Invoice No.");
          RentalPackage.SETRANGE("Invoice Status", RentalPackage."Invoice Status"::"Temporary");
          RentalPackage.SETRANGE("Last Invoice No.", "No.");
          IF RentalPackage.FINDSET(TRUE, TRUE) THEN BEGIN
            REPEAT
              RentalPackage2 := RentalPackage;
              RentalPackage2."Last Invoice No." := NewInvNo;
              RentalPackage2."Invoice Status" := RentalPackage2."Invoice Status"::Posted;
              RentalPackage2.MODIFY;
              //
              RentalRateLine.SETRANGE("Project No.", RentalPackage."Project No.");
              RentalRateLine.SETRANGE("Rental Unit", RentalPackage."Rental Unit");
              RentalRateLine.SETRANGE("Starting Date Package", RentalPackage."Starting Date");
              RentalRateLine.SETRANGE("Last Invoice No.", "No.");
              RentalRateLine.SETRANGE("Invoice Status", RentalRateLine."Invoice Status"::"Temporary");
              IF RentalRateLine.FINDSET(TRUE, FALSE) THEN BEGIN
                REPEAT
                  RentalRateLine."Last Invoice No." := NewInvNo;
                  RentalRateLine."Invoice Status" := RentalRateLine."Invoice Status"::Posted;
                  RentalRateLine.MODIFY;
                UNTIL RentalRateLine.NEXT = 0;
              END;
              //
              HistRentalPackage.SETRANGE("Project No.", RentalPackage."Project No.");
              HistRentalPackage.SETRANGE("Rental Unit", RentalPackage."Rental Unit");
              HistRentalPackage.SETRANGE("Starting Date", RentalPackage."Starting Date");
              HistRentalPackage.SETRANGE("Invoice Status", HistRentalPackage."Invoice Status"::"Temporary");
              HistRentalPackage.SETRANGE("Invoice No.", "No.");
              IF HistRentalPackage.FINDSET(TRUE, FALSE) THEN BEGIN
                REPEAT
                  HistRentalPackage."Invoice No." := NewInvNo;
                  HistRentalPackage."Invoice Status" := HistRentalPackage."Invoice Status"::Posted;
                  HistRentalPackage.MODIFY;
                UNTIL HistRentalPackage.NEXT = 0;
              END;
            UNTIL RentalPackage.NEXT = 0;
          END;
        END;

      END;
    END;

    PROCEDURE UpdateSurchargeBuffer@5815();
    BEGIN
      //**4PS
      SurchargePostingBuffer[2] := SurchargePostingBuffer[1];
      IF SurchargePostingBuffer[2].FIND THEN BEGIN
        SurchargePostingBuffer[2].Amount :=
          SurchargePostingBuffer[2].Amount + SurchargePostingBuffer[1].Amount;
        SurchargePostingBuffer[2].MODIFY;
      END ELSE
        SurchargePostingBuffer[1].INSERT;
    END;

    PROCEDURE PostSurcharge@1210190012(Origin@1210190001 : 'Project,Service');
    BEGIN
      //**4PS
      PostingMgt.SetPostingFromSalesLine(Origin,SalesLine,SalesHeader,JobJnlLine,ServJnlLine,GenJnlLine,GenJnlLineDocNo);
      PostingMgt.BufferSurcharges(
        Origin,GenJnlLine,JobJnlLine,ServJnlLine,JobJnlPostLine,ServJnlPostLine,SurchargePostingBuffer,ComplWIPPostingBuffer);
    END;

    PROCEDURE PostService@1210190001();
    VAR
      ServiceContractCtrlPeriod@1100528603 : Record 11071746;
      ServiceContractCtrlPeriod2@1100528611 : Record 11071746;
      ContractInstallment@1100528604 : Record 11071707;
      ContractObject@1100528608 : Record 11071702;
      Currency@1100528612 : Record 4;
      MaintenanceInvoiceMgt@1100528613 : Codeunit 11012828;
      OriginalTotalRevenue@1100528600 : Decimal;
      NewRevenue@1100528601 : Decimal;
      NewTotalRevenue@1100528602 : Decimal;
      InstallmentStartingDate@1100528606 : Date;
      InstallmentEndingDate@1100528605 : Date;
      NegativeInvoiceInterval@1100528607 : DateFormula;
      InstallmentNoOfDays@1100528609 : Integer;
      Date@1100528610 : Record 2000000007;
    BEGIN
      //**4PS
      ServJnlLine.INIT;
      ServJnlLine."Service Contract No." := SalesLine."Service Contract No.";
      ServJnlLine."Installment No." := SalesLine."Installment No.";
      ServJnlLine."Installment Line No." := SalesLine."Installment Line No.";
      ServJnlLine."Customer No." := SalesLine."Bill-to Customer No.";
      ServJnlLine."Service Order No." := SalesLine."Service Order No.";
      ServJnlLine."Service Location No." := SalesLine."Service Location No.";
      IF SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo" THEN
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Credit Memo"
      ELSE
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Invoice";
      IF SalesHeader."Plant Invoice" THEN        //* Must be empty, otherwise the cost plus can not be create from the
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::" ";  //service entry (so it can not be invoiced).
      ServJnlLine."Document No." := GenJnlLineDocNo;  //db, 23-09-03
      ServJnlLine."G/L Account" := SalesLine."No.";
      ServJnlLine."Posting Date" := SalesHeader."Posting Date";
      ServJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
      ServJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
      ServJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
      ServJnlLine."Cost Component" := SalesLine."Cost Component";
      ServJnlLine."Currency Code" := SalesLine."Currency Code"; // dp00116.n
      IF (ChargePlantToOwnServOrder OR ChargeSOToPlantItem) AND NOT ChargeSOToJobPlantLoc THEN BEGIN //DP00195
        ServOrderRec.GET(ServJnlLine."Service Order No.");
        IF SalesLine."Additional Cost (Service)" THEN BEGIN
          ServTypeRec.Code := ServOrderRec."Service Type (Other)";
          ServJnlLine."Shortcut Dimension 1 Code" := ServOrderRec."Department Code (Other)"; //**4PS.mg, 06-02-13: C005640
        END ELSE BEGIN
          ServTypeRec.Code := ServOrderRec."Service Type";
          ServJnlLine."Shortcut Dimension 1 Code" := ServOrderRec."Global Dimension 1 Code"; //**4PS.mg, 06-02-13: C005640
        END;
        ServTypeRec.GET(ServTypeRec.Code);
        DimMgt.GetDimValueRec(2,SalesLine."Shortcut Dimension 2 Code",DimValRec,TRUE,'');
        SurchargePostingBuffer[1]."G/L Account" := ServTypeRec.GetWipAcc(ServTypeRec.Code,
                                                                         DimValRec."Cost Type",
                                                                         COMPANYNAME,
                                                                         DimValRec."Cost Type",
                                                                         '');
      END;

      ServJnlLine.Description := SalesLine.Description;
      ServJnlLine."Description 2" := SalesLine."Description 2";  //**4PS01.n
      ServJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";

      IF (NOT SalesHeader."Plant Invoice") OR ChargeSOToCustomerPlantLoc OR ChargeSOToJobPlantLoc THEN BEGIN //DP00195
        ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Sale; //C022170
        //db.sn, 01-07-09
        ServJnlLine.Quantity := -SalesLine."Qty. to Invoice";
        ServJnlLine.VALIDATE("Total Revenue (LCY)", -SalesLine.Amount); //mg.c, 02-08-13: C008886
        IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN BEGIN
          ServJnlLine.Quantity := SalesLine."Qty. to Invoice";
          ServJnlLine.VALIDATE("Total Revenue (LCY)", SalesLine.Amount);
        END;
        IF ServJnlLine.Quantity = 0 THEN
          ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)")
        ELSE
          ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
        //db.en, 01-07-09
      END ELSE BEGIN
        ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Usage; //C022170
        IF SalesLine."Number of Time Units" = 0 THEN BEGIN
          ServJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice");
        END ELSE BEGIN
          ServJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice" * SalesLine."Number of Time Units");
        END;
        ServJnlLine.Quantity := -ServJnlLine.Quantity;
        ServJnlLine.VALIDATE("Total Cost (LCY)", -SalesLine.Amount); //mg.c, 02-08-13: C008886
        ServJnlLine.Quantity := ABS(ServJnlLine.Quantity);
        IF ServJnlLine."Total Cost (LCY)" < 0 THEN
          ServJnlLine.Quantity := -ServJnlLine.Quantity;
        IF ServJnlLine.Quantity <> 0 THEN
          ServJnlLine.VALIDATE("Unit Cost (LCY)", ServJnlLine."Total Cost (LCY)" / ServJnlLine.Quantity)
        ELSE
          ServJnlLine.VALIDATE("Unit Cost (LCY)", ServJnlLine."Total Cost (LCY)");
        ServJnlLine."Plant Invoice" := SalesLine."Plant Invoice";
        ServJnlLine."Rental Period" := SalesLine."Rental Period";
      END;
      ServJnlLine."Reason Code" := SalesHeader."Reason Code";
      ServJnlLine."Source Code" := SrcCode;
      ServJnlLine."Service Invoice" := SalesLine."Service Invoice";
      ServJnlLine."Item No." := SalesLine."Item No.";
      ServJnlLine."Basic Item" := SalesLine."Basic Item";
      ServJnlLine."Trade Item" := SalesLine."Trade Item";
      ServJnlLine."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
      ServJnlLine.Manufacturer := SalesLine.Manufacturer;
      ServJnlLine."Project No." := SalesLine."Job No.";
      ServJnlLine."Cost Plus Line No." := SalesLine."Cost Plus Line No.";
      ServJnlLine."Additional Cost" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
      ServJnlLine."Removal Contribution" := SalesLine."Removal Contribution";  //db, 18-09-06
      ServJnlLine."Original Cost Type" := ServJnlLine."Original Cost Type"::" ";
      IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
        ServJnlLine."Original Cost Type" := SalesLine."Cost Type Cost Plus Line" + 1;  //db, 06-10-06
      ServJnlLine."Cost Entry No. Service Ledger":= SalesLine."Cost Entry No. Service Ledger";
      ServJnlLine."Country/Region Code" := SalesHeader."VAT Country/Region Code";                   //**4PS05.sn
      ServJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin";
      ServJnlLine."Net Weight" := SalesLine."Net Weight";
      ServJnlLine."Tariff No." := SalesLine."Tariff No.";
      ServJnlLine."Transaction Type" := SalesLine."Transaction Type";
      ServJnlLine."Transport Method" := SalesLine."Transport Method";
      ServJnlLine."Entry/Exit Point" := SalesLine."Exit Point";
      ServJnlLine.Area := SalesLine.Area;                                             //**4PS05.en
      ServJnlLine."Collective List No." := SalesLine."Collective List No.";
      ServJnlLine."Coll.-List SC Inv. Line No." := SalesLine."Coll.-List SC Inv. Line No.";
      ServJnlLine."Service Control Period Date" := SalesLine."Service Control Period Date";
      IF (ServJnlLine."Service Contract No." <> '') AND (ServJnlLine."Service Order No." = '') AND (ServJnlLine."Service Control Period Date" = 0D) THEN
        ServJnlLine."Service Control Period Date" := ServJnlLine."Posting Date";

      //Split installment revenue into control periods to ease out revenue
      IF (ServJnlLine."Service Contract No." <> '') AND (ServJnlLine."Installment Line No." <> 0) AND HasToSplitContractRevenue(ServJnlLine) THEN BEGIN
        OriginalTotalRevenue := ServJnlLine."Total Revenue (LCY)";
        ContractInstallment.GET(ServJnlLine."Service Contract No.", ServJnlLine."Installment Line No.");
        InstallmentEndingDate := ServJnlLine."Service Control Period Date";
        ContractObject.NegateDateFormula(ContractInstallment."Invoice Interval", NegativeInvoiceInterval);
        InstallmentStartingDate := CALCDATE(NegativeInvoiceInterval, InstallmentEndingDate) +1;

        Date.SETRANGE("Period Type", Date."Period Type"::Date);
        Date.SETRANGE("Period Start", InstallmentStartingDate, InstallmentEndingDate);
        InstallmentNoOfDays := Date.COUNT;
        Date.FILTERGROUP(2);

        Currency.InitRoundingPrecision;

        ServiceContractCtrlPeriod.UpdateControlPeriodsUntil(ServJnlLine."Service Contract No.", InstallmentEndingDate);
        ServiceContractCtrlPeriod.SETRANGE("Service Contract No.", ServJnlLine."Service Contract No.");
        ServiceContractCtrlPeriod.SETFILTER("Starting Date", '<=%1', InstallmentEndingDate);
        ServiceContractCtrlPeriod.SETFILTER("Ending Date", '>=%1', InstallmentStartingDate);
        IF ServiceContractCtrlPeriod.FINDSET THEN BEGIN
          REPEAT
            Date.SETRANGE("Period Start", ServiceContractCtrlPeriod."Starting Date", ServiceContractCtrlPeriod."Ending Date");
            NewRevenue := ROUND(OriginalTotalRevenue * Date.COUNT / InstallmentNoOfDays, Currency."Amount Rounding Precision");
            NewTotalRevenue += NewRevenue;
            ServiceContractCtrlPeriod2.COPY(ServiceContractCtrlPeriod);
            IF ServiceContractCtrlPeriod2.NEXT = 0 THEN
              IF OriginalTotalRevenue - NewTotalRevenue <> 0 THEN
                NewRevenue += OriginalTotalRevenue - NewTotalRevenue;
            IF NewRevenue <> 0 THEN BEGIN
              ServJnlLine.VALIDATE("Total Revenue (LCY)", NewRevenue);
              ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
              ServJnlLine."Service Control Period Date" :=
                MaintenanceInvoiceMgt.GetServiceControlPeriodDate(ServJnlLine."Service Contract No.", ServiceContractCtrlPeriod."Ending Date");
              ServJnlPostLine.RunWithCheck(ServJnlLine);
            END;
          UNTIL ServiceContractCtrlPeriod.NEXT = 0;
        END ELSE
          ServJnlPostLine.RunWithCheck(ServJnlLine);
      END ELSE
        ServJnlPostLine.RunWithCheck(ServJnlLine);
      ServLedgEntryNo := ServJnlPostLine.GetServLedgEntryNo; //DP00121
    END;

    PROCEDURE PostPlant@11012001(PostAsPlantCost@1100485000 : Boolean;InternalChargePlant@1100529000 : Boolean);
    VAR
      PlantTypeRec@1210190000 : Record 11012551;
      PlantServiceOrder@1100525000 : Boolean;
    BEGIN
      //**4PS
      IF (SalesLine."Plant Location" = '') OR (NOT PlantLocRec.GET(SalesLine."Plant Location")) THEN
        PlantLocRec.INIT;

      PlantLedgerEntry.INIT;
      IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '')  THEN
        PlantLedgerEntry."Company Name" := SalesHeader."Company Name";
      IF SalesLine."Job No." <> '' THEN BEGIN
        PlantLedgerEntry."Project No." := SalesLine."Job No.";
        IF SalesLine.Element <> '' THEN
          PlantLedgerEntry.Element := SalesLine.Element;
      END;
      IF SalesLine."Service Order No." <> '' THEN
        PlantLedgerEntry."Service Order No." := SalesLine."Service Order No.";
      PlantLedgerEntry."Customer No." := SalesHeader."Sell-to Customer No.";
      PlantLedgerEntry."Document No." := GenJnlLineDocNo;
      PlantLedgerEntry."Posting Date" := SalesHeader."Posting Date";
      PlantLedgerEntry."Document Date" := SalesHeader."Document Date";
      PlantLedgerEntry."Account No." := SalesLine."No.";
      PlantLedgerEntry.Quantity := -SalesLine."Qty. to Invoice";
      PlantLedgerEntry."Number of Time Units" := SalesLine."Number of Time Units";  //C009123.n
      IF (NOT PostAsPlantCost) THEN BEGIN
        IF InternalChargePlant THEN BEGIN  //DP00815
          PlantLedgerEntry."Total Price" := SalesLine.Amount;
          PlantLedgerEntry."Unit Amount" := PlantLedgerEntry."Total Price";
        END ELSE BEGIN
          PlantLedgerEntry."Unit Amount" := SalesLine."Unit Price";
          PlantLedgerEntry."Total Price" := -SalesLine.Amount;
        END;
        PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
        PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
        PlantLedgerEntry."Plant Location" := SalesLine."Plant Location";
        PlantLedgerEntry."Relate to" := SalesLine."Relate to";
        //IF ServOrderRec.FINDFIRST THEN //T004489.o
        //IF ServOrderRec.GET(SalesLine."Service Order No.") THEN //T004489.n /.o Cost Component not allowed for revenues!
        //  IF ServOrderRec.IsPlantServiceOrder THEN
        //    PlantLedgerEntry."Cost Component" := ServOrderRec."Cost Component Plant";
        //C009123.sn
        IF (SalesLine."Relate to" = SalesLine."Relate to"::Rental) THEN BEGIN
          IF (SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo") AND
             (PlantLedgerEntry.Quantity < 0) AND (PlantLedgerEntry."Number of Time Units" > 0)
          THEN BEGIN  //Only Time Units for Rental/Rental Correction
            PlantLedgerEntry.Quantity := -PlantLedgerEntry.Quantity;
            IF PlantLedgerEntry."Unit Amount" < 0 THEN
              PlantLedgerEntry."Unit Amount" := -PlantLedgerEntry."Unit Amount"
            ELSE
              PlantLedgerEntry."Number of Time Units" := -PlantLedgerEntry."Number of Time Units";
          END;
        END ELSE BEGIN
          //C022785
          IF (PlantLedgerEntry."Number of Time Units" = 0) AND
             (((PlantLedgerEntry.Quantity < 0) AND (PlantLedgerEntry."Unit Amount" < 0) AND (PlantLedgerEntry."Total Price" > 0)) OR
              ((PlantLedgerEntry.Quantity > 0) AND (PlantLedgerEntry."Unit Amount" < 0) AND (PlantLedgerEntry."Total Price" < 0)))
          THEN BEGIN
            PlantLedgerEntry.Quantity := -PlantLedgerEntry.Quantity;
            PlantLedgerEntry."Unit Amount" := -PlantLedgerEntry."Unit Amount";
          END;
        END;
        //C009123.en
        //IF (NOT SalesHeader."Plant Invoice") AND (PlantLedgerEntry."Relate to" = 0) THEN  //*C003125.n (T001118)
        //  PlantLedgerEntry."Relate to" := PlantLedgerEntry."Relate to"::"Sundry Costs";
        PlantLedgerEntry."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
      END ELSE BEGIN
        IF InternalChargePlant THEN BEGIN  //DP00815
          PlantLedgerEntry."Total Cost" := -SalesLine.Amount;
          PlantLedgerEntry."Direct Unit Cost" := PlantLedgerEntry."Total Cost";
          PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
          PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
          PlantLedgerEntry."Cost Component" := PlantSetupRec."Cost Component Internal Charge";
          PlantLedgerEntry."Relate to" := 0;
        END ELSE BEGIN
          PlantLedgerEntry."Direct Unit Cost" := SalesLine."Unit Price";
          PlantLedgerEntry."Total Cost" := -SalesLine.Amount;
        END;
        PlantLedgerEntry."Unit Cost" := PlantLedgerEntry."Direct Unit Cost";
        IF NOT InternalChargePlant THEN BEGIN  //DP00815.n
          //DP00195.sn
          PlantServiceOrder := FALSE;
          //IF ServOrderRec.FINDFIRST THEN T004489.o
          IF ServOrderRec.GET(SalesLine."Service Order No.") THEN //T004489.n
            IF ServOrderRec.IsPlantServiceOrder AND (SalesLine."Service Order No." <> '') THEN
              PlantServiceOrder := TRUE;
          IF PlantServiceOrder THEN BEGIN
            PlantLedgerEntry."Cost Component" := ServOrderRec."Cost Component Plant";
            PlantLedgerEntry."Plant Location" := SalesLine."Plant Location";
            PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
            PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
          END ELSE BEGIN
            PlantLedgerEntry."Plant Type" := ProjRec."Plant Type";
            PlantLedgerEntry."Plant No." := ProjRec."Plant No.";
            PlantLedgerEntry."Cost Component" := ProjRec."Cost Component Plant";
            PlantLedgerEntry."Plant Location" := ProjRec."Plant Location";
          END;
          //DP00195.en
          PlantLedgerEntry."Relate to" := PlantLedgerEntry."Relate to"::"Job Order";
        END;
      END;
      PlantLedgerEntry."Plant Invoice Origin" := SalesLine."Plant Invoice Origin";
      PlantLedgerEntry.Description := SalesLine.Description;
      PlantLedgerEntry."Description 2" := SalesLine."Description 2";  //**4PS01.n
      PlantLedgerEntry."Employee No." := SalesLine."Employee No.";
      PlantLedgerEntry."Unit of Measure Code" := SalesLine."Unit of Measure Code";
      PlantLedgerEntry."Department Code" := SalesLine."Shortcut Dimension 1 Code";
      PlantLedgerEntry."Cost Object" := SalesLine."Shortcut Dimension 2 Code";
      PlantLedgerEntry."Dimension Set ID" := SalesLine."Dimension Set ID";
      PlantLedgerEntry."Source Code" := SrcCode;
      PlantLedgerEntry."Reason Code" := SalesHeader."Reason Code";
      PlantLedgerEntry."Country/Region Code" := SalesHeader."VAT Country/Region Code";
      PlantLedgerEntry."Territory Code" := PlantLocRec."Territory Code";
      //PlantLedgerEntry."Plant Posting Group" := SalesLine."Posting Group";  //*27818.o
      PlantLedgerEntry."No. Series" := SalesHeader."No. Series";
      PlantLedgerEntry."Rate Code" := SalesLine."Plant Rate Code";
      //PlantLedgerEntry."Number of Time Units" := SalesLine."Number of Time Units";  //C009123.o
      PlantLedgerEntry."Rate Type" := SalesLine."Rate Type";
      IF SalesLine."Arrival Order Type" <> SalesLine."Arrival Order Type"::"Transport Order" THEN BEGIN
        PlantLedgerEntry."Arrival Order Type" := SalesLine."Arrival Order Type";
        PlantLedgerEntry."Arrival Order" := SalesLine."Arrival Order";
      END ELSE BEGIN
        PlantLedgerEntry."Transport Order No." := SalesLine."Arrival Order";
      END;
      IF SalesLine."Removal Order Type" <> SalesLine."Removal Order Type"::"Transport Order" THEN BEGIN
        PlantLedgerEntry."Removal Order Type" := SalesLine."Removal Order Type";
        PlantLedgerEntry."Removal Order" := SalesLine."Removal Order";
      END ELSE BEGIN
        PlantLedgerEntry."Transport Order No." := SalesLine."Removal Order";
      END;
      PlantLedgerEntry."Rental Period" := SalesLine."Rental Period";
      //*27818.sn
      IF PlantLedgerEntry."Plant Type" <> '' THEN BEGIN
        IF PlantTypeRec.GET(PlantLedgerEntry."Plant Type") THEN
          PlantLedgerEntry."Plant Posting Group" := PlantTypeRec.PlantPostingGrp(PlantLedgerEntry."Plant No.", '', '');
      END;
      //*27818.en

      PostPlantEntry.RUN(PlantLedgerEntry);

      IF NOT InternalChargePlant THEN BEGIN  //DP00815.n
        IF NOT PostAsPlantCost THEN
          PostPlantRentalRateComponents();
        IF SalesHeader."Plant Invoice" THEN
          UpdateInvoiceNosSource(TRUE,GenJnlLineDocNo);
      END;
    END;

    LOCAL PROCEDURE PostPlantRentalRateComponents@1100485000();
    VAR
      lvRateCompPostingRec@1100485007 : Record 11020500;
      lvRateCompEntryRec@1100485008 : Record 11020501;
      lvRateRec@1100485000 : Record 11012567;
      lvRateCodeRec@1100485009 : Record 11020502;
      lvTmpRateCompRec@1100485006 : TEMPORARY Record 11012584;
      lvSearchRateCU@1100485001 : Codeunit 11012567;
      lvRefDate@1100485004 : Date;
      lvRentalType@1100485002 : Option;
      lvPos@1100485005 : Integer;
      lvAmount@1100485003 : Decimal;
      lvSalesLineAmount@1100485010 : Decimal;
    BEGIN
      //**4PS.n
      // It is only allowed to create 'G/L Entries' and 'Plant Rate Component Entries', so be sure that no other entries
      // (VAT, Customer, Plant, Project, etc.) created. Because this extra entries should not be counted twice.

      WITH SalesLine DO BEGIN
        IF ("Plant Type" = '') THEN
          EXIT;
        CASE "Relate to" OF
          "Relate to"::Rental:
            BEGIN
              IF NOT ("Plant Invoice Origin" IN
                      ["Plant Invoice Origin"::"Plant Inventory", "Plant Invoice Origin"::"Rental Correction"]) THEN
                EXIT;
              lvRentalType := lvRateRec."Rental Type"::Rental;
            END;
          "Relate to"::"Plant Hours":
            BEGIN
              IF NOT ("Plant Invoice Origin" = "Plant Invoice Origin"::"Plant Hours") THEN
                EXIT;
              IF ("Plant Rate Code" <> '') THEN BEGIN
                IF lvRateCodeRec.ReadPlantRateCode("Plant Location", "Plant Rate Code", '') THEN BEGIN
                  IF (lvRateCodeRec."Hour Rate from" = lvRateCodeRec."Hour Rate from"::Employee) THEN
                    EXIT;
                END;
              END;
              lvRentalType := lvRateRec."Rental Type"::"Plant Hours";
            END;
          ELSE
            EXIT;
        END;

        PlantSetupRec.GET;
        IF (NOT PlantSetupRec."Post Rent by Rate Component") THEN
          EXIT;

        lvSalesLineAmount := -SalesLine.Amount;  //* 'Sales line amount' is negative, for that reason * -1

        lvRateCompPostingRec.SETCURRENTKEY("Plant Posting Group Code", "Gen. Bus. Posting Group", "Rate Component");
        //lvRateCompPostingRec.SETRANGE("Plant Posting Group Code", "Posting Group");  //*27818.o
        lvRateCompPostingRec.SETRANGE("Plant Posting Group Code", PlantLedgerEntry."Plant Posting Group");  //*27818.n
        lvRateCompPostingRec.SETRANGE("Gen. Bus. Posting Group", PlantLocRec."Gen. Bus. Posting Group");  //* Is read in PostPlant
        IF lvRateCompPostingRec.FINDSET THEN BEGIN
          lvRefDate := SalesHeader."Posting Date";
          lvPos := STRPOS("Rental Period", '..');
          IF (lvPos > 0) AND (STRLEN("Rental Period") > (lvPos+2)) THEN BEGIN
            IF NOT EVALUATE(lvRefDate, COPYSTR("Rental Period", (lvPos+2))) THEN
              lvRefDate := SalesHeader."Posting Date";
          END;
          IF lvSearchRateCU.FindRentalRateRateComponents(
            "Plant Location","Plant Type","Plant No.",lvRefDate,lvRentalType,lvSalesLineAmount,SalesLine,TRUE,lvTmpRateCompRec)
          THEN BEGIN
            REPEAT
              IF lvTmpRateCompRec.GET(lvRateCompPostingRec."Rate Component") THEN BEGIN
                IF (PlantSetupRec."Type Division of Rate Comp." <> PlantSetupRec."Type Division of Rate Comp."::DiffOnResult) THEN
                  lvAmount := lvSalesLineAmount * (lvTmpRateCompRec.Percentage / 100)
                ELSE
                  lvAmount := lvTmpRateCompRec.Percentage;  //*For this method, this is the amount
                IF lvAmount <> 0 THEN BEGIN
                  lvRateCompPostingRec.TESTFIELD("Account No.");
                  lvRateCompPostingRec.TESTFIELD("Bal. Account No.");

                  TmpGenJnlRateCompBufferRec.RESET;
                  TmpGenJnlRateCompBufferRec.SETRANGE("Journal Template Name", lvRateCompPostingRec."Rate Component");
                  TmpGenJnlRateCompBufferRec.SETRANGE("Journal Batch Name", '');
                  TmpGenJnlRateCompBufferRec.SETRANGE("Account No.", lvRateCompPostingRec."Account No.");
                  TmpGenJnlRateCompBufferRec.SETRANGE("Bal. Account No.", lvRateCompPostingRec."Bal. Account No.");
                  TmpGenJnlRateCompBufferRec.SETRANGE("Shortcut Dimension 1 Code", "Shortcut Dimension 1 Code");
                  IF TmpGenJnlRateCompBufferRec.FIND('-') THEN BEGIN
                    TmpGenJnlRateCompBufferRec.Amount := TmpGenJnlRateCompBufferRec.Amount + lvAmount;
                    TmpGenJnlRateCompBufferRec.MODIFY;
                  END ELSE BEGIN
                    TmpGenJnlRateCompBufferRec.INIT;
                    TmpGenJnlRateCompBufferRec."Journal Template Name" := lvRateCompPostingRec."Rate Component";
                    TmpGenJnlRateCompBufferRec."Journal Batch Name" := '';
                    TmpGenJnlRateCompBufferRec."Line No." := NextLineNoGLRateCompBuf;
                    TmpGenJnlRateCompBufferRec."Account No." := lvRateCompPostingRec."Account No.";
                    TmpGenJnlRateCompBufferRec."Bal. Account No." := lvRateCompPostingRec."Bal. Account No.";
                    TmpGenJnlRateCompBufferRec."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                    //* "Shortcut Dimension 2 Code" leave empty, this limits the number of entries
                    TmpGenJnlRateCompBufferRec.Description := lvTmpRateCompRec.Description;
                    TmpGenJnlRateCompBufferRec.Amount := lvAmount;
                    TmpGenJnlRateCompBufferRec.INSERT;
                    NextLineNoGLRateCompBuf := NextLineNoGLRateCompBuf + 1;
                  END;

                  lvRateCompEntryRec.INIT;
                  lvRateCompEntryRec."Document No." := GenJnlLineDocNo;
                  lvRateCompEntryRec."Document Date" := SalesHeader."Document Date";
                  lvRateCompEntryRec."Posting Date" := SalesHeader."Posting Date";
                  lvRateCompEntryRec."Rate Component" := lvRateCompPostingRec."Rate Component";
                  lvRateCompEntryRec."Plant Type" := "Plant Type";
                  lvRateCompEntryRec."Plant No." := "Plant No.";
                  lvRateCompEntryRec."Rate Code" := "Plant Rate Code";
                  lvRateCompEntryRec.Description := PlantLedgerEntry.Description;
                  lvRateCompEntryRec.Amount := lvAmount;
                  lvRateCompEntryRec."Department Code" := "Shortcut Dimension 1 Code";
                  lvRateCompEntryRec."Cost Object" := "Shortcut Dimension 2 Code";
                  lvRateCompEntryRec."Dimension Set ID" := "Dimension Set ID";
                  lvRateCompEntryRec."Gen. Bus. Posting Group" := "Gen. Bus. Posting Group";
                  //lvRateCompEntryRec."Plant Posting Group" := "Posting Group";  //*27818.o
                  lvRateCompEntryRec."Plant Posting Group" := PlantLedgerEntry."Plant Posting Group";  //*27818.n
                  lvRateCompEntryRec."Relate to" := "Relate to";
                  lvRateCompEntryRec."Plant Invoice Origin" := "Plant Invoice Origin";
                  lvRateCompEntryRec."Plant Ledger Entry No." := PlantLedgerEntry."Entry No.";
                  PostPlantRateCompEntry.RUN(lvRateCompEntryRec);
                END;
              END;
            UNTIL lvRateCompPostingRec.NEXT = 0;
          END;
        END;
      END;
    END;

    PROCEDURE PostPlantRateComponentBuffer@1100485012();
    VAR
      lvGLAccRec@1100485003 : Record 15;
      lvTmpBufferRec@1100485001 : TEMPORARY Record 81;
      lvI@1100485000 : Integer;
      lvNextLineNo@1100485002 : Integer;
    BEGIN
      //**4PS.n
      lvNextLineNo := 1;
      lvTmpBufferRec.RESET;
      lvTmpBufferRec.DELETEALL;

      WITH TmpGenJnlRateCompBufferRec DO BEGIN
        FOR lvI := 1 TO 2 DO BEGIN
          IF lvI = 2 THEN BEGIN
            lvTmpBufferRec.RESET;
            IF lvTmpBufferRec.FIND('-') THEN BEGIN
              REPEAT
                INIT;
                "Journal Template Name" := lvTmpBufferRec."Journal Template Name";
                "Journal Batch Name" := lvTmpBufferRec."Journal Batch Name";
                "Line No." := lvTmpBufferRec."Line No.";
                "Account No." := lvTmpBufferRec."Account No.";
                Description := lvTmpBufferRec.Description;
                "Shortcut Dimension 1 Code" := lvTmpBufferRec."Shortcut Dimension 1 Code";
                Amount := -lvTmpBufferRec.Amount;
                INSERT;
              UNTIL lvTmpBufferRec.NEXT = 0;
            END;
          END;

          RESET;
          IF FIND('-') THEN BEGIN
            REPEAT
              GenJnlLine1.INIT;
              GenJnlLine1."Document Type" := GenJnlLineDocType;
              GenJnlLine1."Document No." := GenJnlLineDocNo;
              GenJnlLine1."Document Date" := SalesHeader."Document Date";
              GenJnlLine1."Posting Date" := SalesHeader."Posting Date";
              GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
              GenJnlLine1."Account No." := "Account No.";
              GenJnlLine1."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
              DimMgt.ValidateShortcutDimValues(1,"Shortcut Dimension 1 Code",GenJnlLine1."Dimension Set ID");
              GenJnlLine1.Description := Description;
              GenJnlLine1.Amount := Amount;
              GenJnlLine1.VALIDATE(Amount);
              GenJnlLine1."Origin Type" := GenJnlLine1."Origin Type"::Plant;
              GenJnlLine1."Source Code" := SrcCode;
              GenJnlLine1."Reason Code":= SalesHeader."Reason Code";
              GenJnlLine1."System-Created Entry" := TRUE;
              GenJnlPostLine.RunWithCheck(GenJnlLine1);

              IF lvI = 1 THEN BEGIN
                lvTmpBufferRec.RESET;
                lvTmpBufferRec.SETRANGE("Journal Template Name", '');
                lvTmpBufferRec.SETRANGE("Journal Batch Name", '');
                lvTmpBufferRec.SETRANGE("Account No.", "Bal. Account No.");
                lvTmpBufferRec.SETRANGE("Shortcut Dimension 1 Code", "Shortcut Dimension 1 Code");
                IF lvTmpBufferRec.FIND('-') THEN BEGIN
                  lvTmpBufferRec.Amount := lvTmpBufferRec.Amount + GenJnlLine1.Amount;
                  lvTmpBufferRec.MODIFY;
                END ELSE BEGIN
                  lvTmpBufferRec.INIT;
                  lvTmpBufferRec."Journal Template Name" := '';
                  lvTmpBufferRec."Journal Batch Name" := '';
                  lvTmpBufferRec."Line No." := lvNextLineNo;
                  lvTmpBufferRec."Account No." := "Bal. Account No.";
                  IF lvGLAccRec.GET(lvTmpBufferRec."Account No.") THEN
                    lvTmpBufferRec.Description := lvGLAccRec.Name;
                  lvTmpBufferRec."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                  lvTmpBufferRec.Amount := GenJnlLine1.Amount;
                  lvTmpBufferRec.INSERT;
                  lvNextLineNo := lvNextLineNo + 1;
                END;
              END;
            UNTIL NEXT = 0;
            DELETEALL;
          END;
        END;
      END;
    END;

    PROCEDURE PostInvoiceProposalviaIC@1210190002(lSalesHeadRec@1210190000 : Record 36) Posted@1210190001 : Boolean;
    VAR
      NoSeriesMgt@1100525001 : Codeunit 396;
      NewLineNo@1100525000 : Integer;
    BEGIN
      //**4PS.n
      //* Plant Invoice Proposal via IC only possible for propasals with a project or service order. Plant location with
      //* company filled only if linked to project or /serviceorder (or employee but then 'empl-loc' that is not invoiced).
      SalesHeader.COPY(lSalesHeadRec);
      IcRelRec.GET(COMPANYNAME,SalesHeader."Company Name");

      GLSetup.GET;
      SourceCodeSetup.GET;
      SrcCode := SourceCodeSetup."Plant Invoice";

      SalesSetup.GET;
      SalesSetup.TESTFIELD("Posted Internal Plant Invoices");
      SalesSetup.TESTFIELD("Posted Int. Plant Credit Memos");

      SalesHeader.CALCFIELDS("Amount Including VAT");
      IF SalesHeader."Amount Including VAT" >= 0 THEN BEGIN
        NoSeriesMgt.InitSeries(SalesSetup."Posted Internal Plant Invoices",' ',TODAY,GenJnlLineDocNo,NoSeriesCde);
        InsertSalesInvoiceHeaderFromIC;
        CreditMemoBln := FALSE;
      END ELSE BEGIN
        NoSeriesMgt.InitSeries(SalesSetup."Posted Int. Plant Credit Memos",' ',TODAY,GenJnlLineDocNo,NoSeriesCde);
        InsertSalesCrMemHeaderFromIC;
        CreditMemoBln := TRUE;
      END;

      SalesLine.SETRANGE("Document Type",SalesLine."Document Type"::"Invoice Proposal");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");

      IF SalesLine.FINDSET THEN BEGIN
        SurchargePostingBuffer[1].DELETEALL;
        ComplWIPPostingBuffer[1].DELETEALL;
        IF IcEntryRec.FINDLAST THEN
          NewLineNo := IcEntryRec."Line No." + 1
        ELSE
          NewLineNo := 1;
        REPEAT
          PostICEntry(NewLineNo);
          PostGLEntry;
          PostSurchargeICPlant;
          IF NOT CreditMemoBln THEN
            InsertSalesInvoiceLinesFromIC
          ELSE
            InsertSalesCrMemLinesFromIC;

          UpdateInvoiceNosSource(FALSE,GenJnlLineDocNo);

          IF SurchargePostingBuffer[1].FIND('+') THEN
            REPEAT
              GenJnlLine1.INIT;
              GenJnlLine1."Source Code" := SrcCode;
              GenJnlLine1."Reason Code":= GenJnlLine."Reason Code";
              GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";

              IF SurchargePostingBuffer[1]."Job No." <> '' THEN
                GenJnlLine1."Account No." := IcRelRec.GetICAccountOfCurrentCompany
              ELSE
                GenJnlLine1."Account No." := SurchargePostingBuffer[1]."G/L Account";

              GenJnlLine1."Posting Date" := GenJnlLine."Posting Date";
              GenJnlLine1."Document Type" := GenJnlLineDocType;
              GenJnlLine1."Document No." := GenJnlLineDocNo;
              GenJnlLine1."System-Created Entry" := TRUE;
              GenJnlLine1."Document Date" := GenJnlLine."Document Date";
              GenJnlLine1.Description := SurchargePostingBuffer[1].Description;
              GenJnlLine1."Description 2" := SurchargePostingBuffer[1]."Description 2";  //**4PS01.n
              //* Field SurchargePostingBuffer[1]."Bal. Account No." never filled. Field is now used for Element
              //* because element not in key. So do not fill "Bal. Account No." here.
              //GenJnlLine1."Bal. Account No." := SurchargePostingBuffer[1]."Bal. Account No.";
              GenJnlLine1.Amount := SurchargePostingBuffer[1].Amount;
              GenJnlLine1.VALIDATE(Amount);
              GenJnlLine1."Shortcut Dimension 1 Code" := SurchargePostingBuffer[1]."Global Dimension 1 Code";
              GenJnlLine1."Shortcut Dimension 2 Code" := SurchargePostingBuffer[1]."Global Dimension 2 Code";
              GenJnlLine1."Dimension Set ID" := SurchargePostingBuffer[1]."Dimension Set ID";
              GenJnlLine1."Cost Component" := SurchargePostingBuffer[1]."Cost Component";
              //GenJnlLine1."Job No." := SurchargePostingBuffer[1]."Job No.";
              //GenJnlLine1.Element := SurchargePostingBuffer[1].Element;
              //GenJnlLine1."Extension Contract" := SalesLine."Extension Contract";
              //GenJnlLine1."Service Order No." := SurchargePostingBuffer[1]."Service Order No.";
              //GenJnlLine1."Service Contract No." := SurchargePostingBuffer[1]."Service Contract No.";
              //GenJnlLine1."Service Location No." := SalesLine."Service Location No.";
              //GenJnlLine1."Service Installation" := SalesLine."Service Installation";
              //GenJnlLine1."Service Installation Part" := SalesLine."Service Installation Part";
              GenJnlLine1."Origin Type" := SurchargePostingBuffer[1]."Origin Type";
              GenJnlLine1."Interest Date" := GenJnlLine."Interest Date";
              GenJnlLine1."Alternative Bill-to Address" := GenJnlLine."Alternative Bill-to Address";

              //Call C006064 n  FIELD "Buy-Back Item (Plant Order)" USED FOR OTHER PURPOSE
              GenJnlLine1."Skip WIP Check" := SurchargePostingBuffer[1]."Buy-Back Item (Plant Order)";

              RunGenJnlPostLine(GenJnlLine1);

              IF (SurchargePostingBuffer[1]."Job No." <> '') OR (SurchargePostingBuffer[1]."Service Order No." <> '') THEN
                PostICEntrySurcharge(NewLineNo);

            UNTIL SurchargePostingBuffer[1].NEXT(-1) = 0;

          SurchargePostingBuffer[1].DELETEALL;

          IF ComplWIPPostingBuffer[1].FIND('-') THEN BEGIN
            REPEAT
              GenJnlLine1.INIT;
              GenJnlLine1."Source Code" := SrcCode;
              GenJnlLine1."Reason Code":= GenJnlLine."Reason Code";
              GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
              GenJnlLine1."Account No." := ComplWIPPostingBuffer[1]."G/L Account";
              GenJnlLine1."Posting Date" := GenJnlLine."Posting Date";
              GenJnlLine1."Document Type" := GenJnlLineDocType;
              GenJnlLine1."Document No." := GenJnlLineDocNo;
              GenJnlLine1."System-Created Entry" := TRUE;
              GenJnlLine1."Document Date" := GenJnlLine."Document Date";
              GenJnlLine1.Description := ComplWIPPostingBuffer[1].Description;
              GenJnlLine1."Description 2" := ComplWIPPostingBuffer[1]."Description 2";  //**4PS01.n
              IF ComplWIPPostingBuffer[1].Element = '' THEN //**4PS.n C024228
                GenJnlLine1."Bal. Account No." := ComplWIPPostingBuffer[1]."Bal. Account No.";
              GenJnlLine1.Amount := ComplWIPPostingBuffer[1].Amount;
              GenJnlLine1.VALIDATE(Amount);
              GenJnlLine1."Shortcut Dimension 1 Code" := ComplWIPPostingBuffer[1]."Global Dimension 1 Code";
              GenJnlLine1."Shortcut Dimension 2 Code" := ComplWIPPostingBuffer[1]."Global Dimension 2 Code";
              GenJnlLine1."Dimension Set ID" := ComplWIPPostingBuffer[1]."Dimension Set ID";
              //GenJnlLine1."Closed Project No." := ComplWIPPostingBuffer[1]."Job No.";
              //GenJnlLine1."Closed Service Order No." := ComplWIPPostingBuffer[1]."Service Order No.";
              //GenJnlLine1."Closed Service Contract No." := ComplWIPPostingBuffer[1]."Service Contract No.";
              GenJnlLine1."Origin Type" := ComplWIPPostingBuffer[1]."Origin Type";
              RunGenJnlPostLine(GenJnlLine1);

            UNTIL ComplWIPPostingBuffer[1].NEXT = 0;
            ComplWIPPostingBuffer[1].DELETEALL;
          END;
        //**4PS.en

        UNTIL SalesLine.NEXT = 0;
      END;

      SalesHeader2.COPY(SalesHeader);

      SalesHeader."No." := GenJnlLineDocNo;
      IF SalesLine.FINDSET THEN BEGIN
        REPEAT
          //IF (SalesLine.Type <> SalesLine.Type::" ") THEN BEGIN  //DP00847.o
          IF (SalesLine.Type <> SalesLine.Type::" ") AND (NOT (SalesLine."Plant Invoice" AND SalesLine.IsPlantService)) THEN BEGIN  //DP00847.n
            SalesLine."Qty. to Invoice" := -SalesLine."Qty. to Invoice";  // Necessary because this is done again in 'PostPlant'.
            SalesLine.Amount := -SalesLine.Amount;                        // Original amount is needed for invoice proposal!
            PostPlant(FALSE,FALSE);
          END;
        UNTIL SalesLine.NEXT = 0;
      END;

      PostPlantRateComponentBuffer();

      SalesHeader2.DELETE;
      SalesLine.DELETEALL;

      EXIT(TRUE);
    END;

    PROCEDURE PostICEntry@1210190005(VAR NewLineNo@1100525005 : Integer);
    VAR
      ICJobSetUp@1210190001 : Record 315;
      lvGenJnlLineRec@1100485000 : Record 81;
      lvPostingSetup@1100525001 : Record 11020565;
      CostObjectRelation@1100529001 : Record 11020243;
      lvVendorPostingGroup@1100525000 : Code[20];
      ICRec@1100525002 : Record 11012057;
      lvICHoursPosting@1100525003 : 'NotApplicable,ReceiverSide,Supplierside';
      DepartmentIC@1100525004 : Code[20];
      CostObject@1100529000 : Code[20];
    BEGIN
      //**4PS.n
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      IcEntryRec.INIT;
      IcEntryRec."Line No." := NewLineNo;
      NewLineNo := NewLineNo + 1;

      //DP00847.sn
      CostObject := SalesLine."Shortcut Dimension 2 Code";
      IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN BEGIN
        // If Plant invoice Proposal is created in Service (Addidional Cost SO)
        IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
          CostObject := SalesLine."Cost Object Cost Plus Line";
        JobSetUp.GET;
        IF JobSetUp."Use C.Obj. Rel. S-P Int.Charge" THEN
          CostObject := CostObjectRelation.ConvertCostObject(CostObject, SalesHeader."Company Name");
      END;
      //DP00847.en

      GLSetupRec.CHANGECOMPANY(SalesHeader."Company Name");
      GLSetupRec.GET;
      DimVal.CHANGECOMPANY(SalesHeader."Company Name");
      //DimVal.GET(GLSetupRec."Global Dimension 2 Code",SalesLine."Shortcut Dimension 2 Code");  //DP00847.o
      DimVal.GET(GLSetupRec."Global Dimension 2 Code", CostObject);  //DP00847.n

      IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '') THEN
      BEGIN
        IF lvPostingSetup.GET(SrcCode, COMPANYNAME, SalesHeader."Company Name") THEN
        BEGIN;
          IF (lvPostingSetup."Prod. Account Credit" <> '') AND
             (lvPostingSetup."Prod. Account Debit" <> '') THEN
          BEGIN
            ICRec.GET(COMPANYNAME, SalesHeader."Company Name");
            lvVendorPostingGroup := ICRec."Vendor Posting Group";
            IcEntryRec."Use IC Vendor Posting Group" := TRUE;
          END;
        END;
      END;

      DepartmentIC := SalesLine."Shortcut Dimension 1 Code";  //* C-026090.n
      IF SalesLine."Job No." <> '' THEN BEGIN
        ICJobSetUp.CHANGECOMPANY(SalesHeader."Company Name");
        ProjRec.CHANGECOMPANY(SalesHeader."Company Name");
        ProjTypeRec.CHANGECOMPANY(SalesHeader."Company Name");
        ICJobSetUp.GET;
        ProjRec.GET(SalesLine."Job No.");
        ProjTypeRec.GET(ProjRec."Project Type");
        DepartmentIC := ProjRec."Global Dimension 1 Code";  //* C-026090.n
        //
        IcEntryRec."Bal. Account No." :=
          ProjTypeRec.GetWipAccByVendorPostingGrp(
            ProjRec."Project Type",
            DimVal."Cost Type",
            ProjRec."Project Status",
            ICJobSetUp."Provisions at Closure",
            SalesHeader."Company Name",
            DimVal."Cost Type",
            '',
            lvICHoursPosting::ReceiverSide,
            lvVendorPostingGroup);
      END ELSE BEGIN
        IF SalesLine."Service Order No." <> '' THEN BEGIN
          ServOrderRec.CHANGECOMPANY(SalesHeader."Company Name");
          ServTypeRec.CHANGECOMPANY(SalesHeader."Company Name");
          ServOrderRec.GET(SalesLine."Service Order No.");
          IF SalesLine."Additional Cost (Service)" THEN
            ServTypeRec.Code := ServOrderRec."Service Type (Other)"
          ELSE
            ServTypeRec.Code := ServOrderRec."Service Type";
          ServTypeRec.GET(ServTypeRec.Code);
          DepartmentIC := ServOrderRec."Global Dimension 1 Code";  //* C-026090.n
          //
          IcEntryRec."Bal. Account No." :=
            ServTypeRec.GetWipAccByVendorPostingGrp(
              ServTypeRec.Code,
              DimVal."Cost Type",
              SalesHeader."Company Name",
              DimVal."Cost Type",
              '',
              lvICHoursPosting::ReceiverSide,
              lvVendorPostingGroup);
        END;
      END;

      IcEntryRec."Post in Company" := SalesHeader."Company Name";
      IcEntryRec."Supplying Company" := COMPANYNAME;
      IcEntryRec."Receiving Company" := SalesHeader."Company Name";
      IcEntryRec."Origin Salary Application" := FALSE;
      IcEntryRec."Account No." := IcRelRec."Receiving Company IC Account";
      IcEntryRec.Description := SalesLine.Description;
      IcEntryRec."Description 2" := SalesLine."Description 2";  //**4PS01.n
      IcEntryRec."Project No." := SalesLine."Job No.";
      IcEntryRec.Element := SalesLine.Element;
      IcEntryRec."Extension Contract" := SalesLine."Extension Contract";
      IF NOT (SalesLine."Plant Invoice" AND SalesLine.IsPlantService) THEN BEGIN  //DP00847.n
        //If Plant invoice Proposal created in Service (Add. Cost SO) SO of salesline in Orig-SO in current/suppl. company
        IcEntryRec."Service Order No." := SalesLine."Service Order No.";
        IcEntryRec."Service Contract No." := SalesLine."Service Contract No.";
        IcEntryRec."Service Location No." := SalesLine."Service Location No.";
        IcEntryRec."Additional Cost (Service)" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
      END;
      IcEntryRec."Employee No." := SalesLine."Employee No.";
      //IcEntryRec."Cost Object" := SalesLine."Shortcut Dimension 2 Code";  //DP00847.o
      IcEntryRec."Cost Object" := CostObject;  //DP00847.n
      IcEntryRec."Cost Component" := SalesLine."Cost Component";
      //IcEntryRec."Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";  //* C-026090.o
      IcEntryRec."Global Dimension 1 Code" := DepartmentIC;   //* C-026090.n
      IcEntryRec.Quantity := SalesLine.Quantity;
      IcEntryRec."Unit of Measure Code"  := SalesLine."Unit of Measure Code";
      IF SalesLine.Quantity <> 0 THEN
        IcEntryRec.Price :=  SalesLine."Amount Including VAT" / SalesLine.Quantity
      ELSE
        IcEntryRec.Price :=  SalesLine."Amount Including VAT";
      IcEntryRec.Amount := SalesLine."Amount Including VAT";
      IcEntryRec."Document No." := GenJnlLineDocNo;
      IcEntryRec."Posting Date" := SalesHeader."Posting Date";
      IcEntryRec."Interest Date" := SalesHeader."Interest Date";
      IF IcEntryRec."Interest Date" = 0D THEN
        IcEntryRec."Interest Date" := IcEntryRec."Posting Date";
      //Type must be Purchase, because receiving company so exactly the opposite.
      IcEntryRec."Gen. Posting Type" := IcEntryRec."Gen. Posting Type"::Purchase;
      IF CheckSalesLineBuyBackItemPO(SalesLine) THEN BEGIN
        lvGenJnlLineRec."Account No." := SalesLine."No.";
        lvGenJnlLineRec."Gen. Posting Type" := lvGenJnlLineRec."Gen. Posting Type"::Sale;
        CheckBuyBackGenPostTypPurchase(lvGenJnlLineRec);
        IF lvGenJnlLineRec."Gen. Posting Type" = lvGenJnlLineRec."Gen. Posting Type"::Purchase THEN
          IcEntryRec."Gen. Posting Type" := IcEntryRec."Gen. Posting Type"::Sale;
      END;
      IcEntryRec."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
      IcEntryRec."Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
      IcEntryRec."VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
      IcEntryRec."VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
      IcEntryRec."Rental Period" := SalesLine."Rental Period";
      IcEntryRec."Plant Invoice" := SalesHeader."Plant Invoice";
      IcEntryRec."Rental Periode to Date" := SalesHeader."Rental Periode to Date";
      //sn 18-06-09 call 13248
      IcEntryRec."Item No." := SalesLine."Item No.";
      IcEntryRec."Basic Item" := SalesLine."Basic Item";
      IcEntryRec."Trade Item" := SalesLine."Trade Item";
      IcEntryRec.Manufacturer := SalesLine.Manufacturer;
      IcEntryRec."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
      //en 18-06-09

      IcEntryRec.TESTFIELD("Account No.");
      IcEntryRec.TESTFIELD("Bal. Account No.");
      IF (IcEntryRec."Project No." <> '') OR (IcEntryRec."Service Order No." <> '') THEN
        IcEntryRec.TESTFIELD("Cost Object");

      IF IcEntryRec."Project No." <> '' THEN BEGIN
        IcEntryRec.CheckProjStatusReceivingComp();
        IcEntryRec.CheckProjElemBlockedRecComp(); //Call 6564
      END;
      IF IcEntryRec."Service Order No." <> '' THEN
        IcEntryRec.CheckServOrderStatusReceivComp();

      IcEntryRec.INSERT(TRUE);

      //*33636.sn
      IF IcEntryRec."Global Dimension 1 Code" <> '' THEN
        IcEntryRec.VALIDATE("Global Dimension 1 Code" ); //** DP00387 new

      //T004178.sn
      IF IcEntryRec."Cost Object" <> '' THEN
        IcEntryRec.VALIDATE("Cost Object");
      IcEntryRec.MODIFY;
      //T004178.en
    END;

    PROCEDURE PostGLEntry@1210190004();
    BEGIN
      //**4PS
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      WITH GenJnlLine DO BEGIN
        INIT;
        "Document No." := GenJnlLineDocNo;
        "Reason Code" := SalesHeader."Reason Code";
        "Source Code" := SrcCode;
        "Account Type" := "Account Type"::"G/L Account";
        "System-Created Entry" := TRUE;

        "Posting Date" := SalesHeader."Posting Date";
        "Interest Date" := SalesHeader."Interest Date";
        //DP00847.sn
        IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN BEGIN
          // If Plant invoice Proposal created in Service (Add. Cost SO) SO of salesline is Orig-SO in current/suppl company.
          // Service Order Number needed if WIP-acc
          "Service Order No." := SalesLine."Service Order No.";
          "Service Contract No." := SalesLine."Service Contract No.";
          "Service Location No." := SalesLine."Service Location No.";
          "Additional Cost (Service)" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
        END;
        //DP00847.en
        "Account No." := SalesLine."No.";
         VALIDATE("Account No.");
        "Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
        "Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        "VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
        "VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
        "VAT Calculation Type" := SalesLine."VAT Calculation Type";
        "Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Sale;
        IF CheckSalesLineBuyBackItemPO(SalesLine) THEN
          CheckBuyBackGenPostTypPurchase(GenJnlLine);
        "Bal. Account Type" :=  "Bal. Account Type"::"G/L Account";
        "Bal. Account No." := IcRelRec.GetICAccountOfCurrentCompany;
        VALIDATE("Bal. Account No.");
        "Bal. Gen. Prod. Posting Group" := '';
        "Bal. Gen. Bus. Posting Group" := '';
        "Bal. VAT Prod. Posting Group" := '';
        "Bal. VAT Bus. Posting Group" := '';
        "Bal. Gen. Posting Type" := 0;
        Description := SalesLine.Description;
        "Description 2" := SalesLine."Description 2";  //**4PS01.n
        Amount := SalesLine."Amount Including VAT" * -1;
        "Posting No. Series" := NoSeriesCde;
        VALIDATE(Amount);
        "Alternative Bill-to Address" := SalesHeader."Alternative Bill-to Address";
        "Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        "Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := SalesLine."Dimension Set ID";

        GenJnlPostLine.RunWithCheck(GenJnlLine);

        IF (SalesHeader."Company Name" <> COMPANYNAME) AND
           (SalesHeader."Company Name" <> '')
        THEN
          PostComplWipProjectServPlantIC;
      END;

      IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN  //DP00847
        PostService();
    END;

    PROCEDURE PostSurchargeICPlant@1100525000();
    VAR
      ICRec@1100525000 : Record 11012057;
      lvPostingSetup@1100525003 : Record 11020565;
      lvType@1210190008 : Code[20];
      lvOrigDim1@1210190007 : Code[20];
      lvOrigDim2@1210190006 : Code[20];
      lvDim1@1210190005 : Code[20];
      lvDim2@1210190004 : Code[20];
      lvAccount@1210190003 : Code[20];
      lvDesc@1210190002 : Text[50];
      lvCostTotal@1210190001 : Decimal;
      lvcostComp@1100485001 : Code[20];
      lvTotSurchAmount@1100485002 : Decimal;
      Origin@1100525001 : 'Project,Service,Indirect,InterCompany';
      lvSourceType@1100525002 : 'Fixed,EmplOrFixed';
      DimSetID@1100409000 : Integer;
    BEGIN
      //For IC postings the surcharges at supplying company should also be calculated and an IC posting created.
      //The surcharges will be posted as definied in the chart of accounts.
      IF (SalesLine.Type = SalesLine.Type::" ") THEN //call 31919
        EXIT;                                        //call 31919

      IF IcEntryRec."Project No." <> '' THEN
        Origin := Origin::Project
      ELSE BEGIN
        IF (IcEntryRec."Service Order No." <> '') THEN
          Origin := Origin::Service
        ELSE
          EXIT;
      END;

      GLSetup.GET;

      ICRec.GET(COMPANYNAME, IcEntryRec."Receiving Company");

      CASE Origin OF
        Origin::Project:
          BEGIN
            ProjRec.GET(IcEntryRec."Project No.");
            lvType := ProjRec."Project Type";
            lvOrigDim1 := ProjRec."Global Dimension 1 Code";
          END;
        Origin::Service:
          BEGIN
            ServOrderRec.GET(IcEntryRec."Service Order No.");
            IF IcEntryRec."Additional Cost (Service)" THEN
              lvType := ServOrderRec."Service Type (Other)"
            ELSE
              lvType := ServOrderRec."Service Type";
            lvOrigDim1 := ServOrderRec."Global Dimension 1 Code";
          END;
      END;

      lvOrigDim2 := IcEntryRec."Cost Object";
      //DimMgt.GetDimValueRec(2, lvOrigDim2, DimValRec, TRUE, '');
      DimVal.CHANGECOMPANY(SalesHeader."Company Name");
      DimVal.GET(GLSetupRec."Global Dimension 2 Code", lvOrigDim2);

      IF SurchargeRec.GetSurchargesIC(
        Origin::InterCompany, lvType, IcEntryRec."Project No.",
        FALSE, DimValRec."Cost Type", DimValRec.Code, '',
        lvOrigDim1, '', IcEntryRec."Cost Component",
        IcEntryRec."Posting Date",
        SurchargeRec, COMPANYNAME, lvSourceType::Fixed) THEN
      BEGIN
        REPEAT
          SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);
          SurchargeRec.TESTFIELD("Coverage Account");

          CASE Origin OF
            Origin::Project:
              BEGIN
                JobJnlLine2."Job No." := IcEntryRec."Project No.";
                JobJnlLine2."Total Cost (LCY)" := IcEntryRec.Amount;
                JobJnlLine2.Quantity := IcEntryRec.Quantity;

                JobJnlLine2.InitSurchargeIC(
                  JobJnlLine2, DimValRec, SurchDimValRec, SurchargeRec, lvOrigDim1, lvType,
                  lvTotSurchAmount, IcEntryRec."Receiving Company");

                lvcostComp := JobJnlLine2."Cost Component";
                lvDesc := JobJnlLine2.Description;
                lvCostTotal := JobJnlLine2."Total Cost (LCY)";
                lvAccount:= JobJnlLine2."No.";

                lvDim1 := JobJnlLine2."Shortcut Dimension 1 Code";
                lvDim2 := JobJnlLine2."Shortcut Dimension 2 Code";
                JobJnlLine2."Dimension Set ID" := SalesLine."Dimension Set ID";
                DimMgt.ValidateShortcutDimValues(1,lvDim1,JobJnlLine2."Dimension Set ID");
                DimMgt.ValidateShortcutDimValues(2,lvDim2,JobJnlLine2."Dimension Set ID");
                DimSetID := JobJnlLine2."Dimension Set ID";

              END;
            Origin::Service:
              BEGIN
                ServJnlLine2."Service Order No." := IcEntryRec."Service Order No.";
                ServJnlLine2."Total Cost (LCY)" := IcEntryRec.Amount;
                ServJnlLine2.Quantity := IcEntryRec.Quantity;

                ServJnlLine2.InitSurchargeIC(
                  ServJnlLine2, DimValRec, SurchDimValRec, SurchargeRec, lvOrigDim1,
                  lvType, lvTotSurchAmount, IcEntryRec."Receiving Company");

                lvcostComp := ServJnlLine2."Cost Component";
                lvDesc := ServJnlLine2.Description;
                lvCostTotal := ServJnlLine2."Total Cost (LCY)";
                lvAccount:= ServJnlLine2."G/L Account";

                lvDim1 := ServJnlLine2."Shortcut Dimension 1 Code";
                lvDim2 := ServJnlLine2."Shortcut Dimension 2 Code";
                ServJnlLine2."Dimension Set ID" := SalesLine."Dimension Set ID";
                DimMgt.ValidateShortcutDimValues(1,lvDim1,ServJnlLine2."Dimension Set ID");
                DimMgt.ValidateShortcutDimValues(2,lvDim2,ServJnlLine2."Dimension Set ID");
                DimSetID := ServJnlLine2."Dimension Set ID";

              END;
          END;

          CLEAR(SurchargePostingBuffer[1]);

          //Post Debit Line
          SurchargePostingBuffer[1]."Receiving Company" := IcEntryRec."Receiving Company";
          SurchargePostingBuffer[1]."G/L Account" := lvAccount;
          SurchargePostingBuffer[1]."Global Dimension 1 Code" := lvDim1;
          SurchargePostingBuffer[1]."Global Dimension 2 Code" := lvDim2;
          SurchargePostingBuffer[1]."Dimension Set ID" := DimSetID;

          SurchargePostingBuffer[1]."Cost Component" := lvcostComp;
          SurchargePostingBuffer[1]."Job No." := IcEntryRec."Project No.";
          IF (IcEntryRec."Project No." <> '') AND (SurchargeRec."Element Surcharge" <> '') THEN
            SurchargePostingBuffer[1].Element := SurchargeRec."Element Surcharge"
          ELSE
            SurchargePostingBuffer[1].Element := IcEntryRec.Element;
          SurchargePostingBuffer[1]."Bal. Account No." := SurchargePostingBuffer[1].Element; // Because element not in key
          SurchargePostingBuffer[1]."Service Order No." := IcEntryRec."Service Order No.";
          SurchargePostingBuffer[1]."Service Contract No." := IcEntryRec."Service Contract No.";
          SurchargePostingBuffer[1]."Service Order No." := IcEntryRec."Service Order No.";
          SurchargePostingBuffer[1].Description := lvDesc;
          SurchargePostingBuffer[1].Amount := lvCostTotal;
          CASE Origin OF
            Origin::Project:
              SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Project;
            Origin::Service:
              SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::Service;
          END;
          SurchargePostingBuffer[1]."Tax Area Code" := IcEntryRec."Document No.";  //ps
          UpdateSurchargeBuffer;

         IF lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, IcEntryRec."Receiving Company") THEN BEGIN
            lvPostingSetup.TESTFIELD("Prod. Account Credit");
            lvPostingSetup.TESTFIELD("Prod. Account Debit");
            PostComplWIPSurchargeIC(lvPostingSetup."Prod. Account Credit", lvPostingSetup."Prod. Account Debit");
          END;

          //Post Credit Line
          SurchargePostingBuffer[1]."G/L Account" := SurchargeRec."Coverage Account";
          SurchargePostingBuffer[1]."Global Dimension 1 Code" := '';
          CASE SurchargeRec."Source Type Department" OF
            SurchargeRec."Source Type Department"::Employee:;
              //Impossible
            SurchargeRec."Source Type Department"::Job:
              SurchargePostingBuffer[1]."Global Dimension 1 Code" := lvDim1;
            SurchargeRec."Source Type Department"::Fixed:
              SurchargePostingBuffer[1]."Global Dimension 1 Code" := SurchargeRec."Coverage Department"
          END;
          SurchargePostingBuffer[1]."Global Dimension 2 Code" := lvDim2;
          SurchargePostingBuffer[1]."Dimension Set ID" := DimSetID;
          DimMgt.ValidateShortcutDimValues(1,SurchargePostingBuffer[1]."Global Dimension 1 Code",SurchargePostingBuffer[1]."Dimension Set ID");


          IF SurchargeRec."Compress Coverage Posting" THEN BEGIN  //Call C006064 n
            SurchargePostingBuffer[1]."Cost Component" := ''; //jth 9-11-06
            SurchargePostingBuffer[1]."Job No." := '';
            SurchargePostingBuffer[1].Element := '';
            //SurchargePostingBuffer[1]."Bal. Account No." := SurchargePostingBuffer[1].Element; // Because element not in key
            SurchargePostingBuffer[1]."Service Order No." := '';
            SurchargePostingBuffer[1]."Service Contract No." := '';
          END ELSE BEGIN                                        //Call C006064 sn
            SurchargePostingBuffer[1]."Buy-Back Item (Plant Order)" := TRUE;   // FIELD USED FOR OTHER PURPOSE
          END;                                                  //Call C006064 en

          SurchargePostingBuffer[1].Amount := lvCostTotal * -1;
          SurchargePostingBuffer[1]."Origin Type" := SurchargePostingBuffer[1]."Origin Type"::" ";
          UpdateSurchargeBuffer;

        UNTIL SurchargeRec.NEXT = 0;
      END;
    END;

    PROCEDURE PostICEntrySurcharge@1100525006(VAR NewLineNo@1100525004 : Integer);
    VAR
      ICJobSetUp@1210190001 : Record 315;
      lvGenJnlLineRec@1100485000 : Record 81;
      lvVendorPostingGroup@1100525002 : Code[20];
      ICRec@1100525001 : Record 11012057;
      lvICHoursPosting@1100525000 : 'NotApplicable,ReceiverSide,Supplierside';
      lvPostingSetup@1100525003 : Record 11020565;
    BEGIN
      //**4PS.n
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      IcEntryRec.INIT;
      IcEntryRec."Line No." := NewLineNo;
      NewLineNo := NewLineNo + 1;

      GLSetupRec.CHANGECOMPANY(SalesHeader."Company Name");
      GLSetupRec.GET;
      DimVal.CHANGECOMPANY(SalesHeader."Company Name");
      DimVal.GET(GLSetupRec."Global Dimension 2 Code",SalesLine."Shortcut Dimension 2 Code");

      IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '')
      THEN BEGIN
        IF lvPostingSetup.GET(SrcCode, COMPANYNAME, SalesHeader."Company Name") THEN BEGIN
          IF (lvPostingSetup."Prod. Account Credit" <> '') AND
             (lvPostingSetup."Prod. Account Debit" <> '')
          THEN BEGIN
            ICRec.GET(COMPANYNAME, SalesHeader."Company Name");
            lvVendorPostingGroup := ICRec."Vendor Posting Group";
            IcEntryRec."Use IC Vendor Posting Group" := TRUE;
          END;
        END;
      END;

      IF SurchargePostingBuffer[1]."Job No." <> '' THEN BEGIN
        ICJobSetUp.CHANGECOMPANY(SalesHeader."Company Name");
        ProjRec.CHANGECOMPANY(SalesHeader."Company Name");
        ProjTypeRec.CHANGECOMPANY(SalesHeader."Company Name");
        ICJobSetUp.GET;
        ProjRec.GET(SalesLine."Job No.");
        ProjTypeRec.GET(ProjRec."Project Type");
        //
        IcEntryRec."Bal. Account No." :=
          ProjTypeRec.GetWipAccByVendorPostingGrp(
            ProjRec."Project Type",
            DimVal."Cost Type",
            ProjRec."Project Status",
            ICJobSetUp."Provisions at Closure",
            SalesHeader."Company Name",
            DimVal."Cost Type",
            '',
            lvICHoursPosting::ReceiverSide,
            lvVendorPostingGroup);
      END ELSE BEGIN
        IF SurchargePostingBuffer[1]."Service Order No." <> '' THEN BEGIN
          ServOrderRec.CHANGECOMPANY(SalesHeader."Company Name");
          ServTypeRec.CHANGECOMPANY(SalesHeader."Company Name");
          ServOrderRec.GET(SalesLine."Service Order No.");
          IF SalesLine."Additional Cost (Service)" THEN
            ServTypeRec.Code := ServOrderRec."Service Type (Other)"
          ELSE
            ServTypeRec.Code := ServOrderRec."Service Type";
          ServTypeRec.GET(ServTypeRec.Code);
          //
          IcEntryRec."Bal. Account No." :=
            ServTypeRec.GetWipAccByVendorPostingGrp(
              ServTypeRec.Code,
              DimVal."Cost Type",
              SalesHeader."Company Name",
              DimVal."Cost Type",
              '',
              lvICHoursPosting::ReceiverSide,
              lvVendorPostingGroup);
        END;
      END;

      IcEntryRec."Account No." := IcRelRec."Receiving Company IC Account";
      IcEntryRec."Post in Company" := SalesHeader."Company Name";
      IcEntryRec."Supplying Company" := COMPANYNAME;
      IcEntryRec."Receiving Company" := SalesHeader."Company Name";
      IcEntryRec."Origin Salary Application" := FALSE;

      IcEntryRec.Description := SurchargePostingBuffer[1].Description;
      IcEntryRec."Description 2" := SurchargePostingBuffer[1]."Description 2";  //**4PS01.n
      IcEntryRec."Project No." := SalesLine."Job No.";
      IcEntryRec.Element := SalesLine.Element;
      IcEntryRec."Extension Contract" := SalesLine."Extension Contract";
      IcEntryRec."Service Order No." := SalesLine."Service Order No.";
      IcEntryRec."Service Contract No." := SalesLine."Service Contract No.";
      IcEntryRec."Service Location No." := SalesLine."Service Location No.";
      IcEntryRec."Additional Cost (Service)" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
      IcEntryRec."Employee No." := SalesLine."Employee No.";
      IcEntryRec."Cost Object" := SurchargePostingBuffer[1]."Global Dimension 2 Code";
      IcEntryRec."Cost Component" := SurchargePostingBuffer[1]."Cost Component";
      IcEntryRec."Global Dimension 1 Code" := SurchargePostingBuffer[1]."Global Dimension 1 Code";
      IcEntryRec."Dimension Set ID" := SalesLine."Dimension Set ID";    //DP00387 new

      IcEntryRec.Quantity := SurchargePostingBuffer[1].Quantity;
      IcEntryRec."Unit of Measure Code"  := SalesLine."Unit of Measure Code";
      IF SalesLine.Quantity <> 0 THEN
        IcEntryRec.Price :=  SurchargePostingBuffer[1].Amount / SalesLine.Quantity
      ELSE
        IcEntryRec.Price :=  SurchargePostingBuffer[1].Amount;
      IcEntryRec.Amount := SurchargePostingBuffer[1].Amount;
      IcEntryRec."Document No." := GenJnlLineDocNo;
      IcEntryRec."Posting Date" := SalesHeader."Posting Date";
      IcEntryRec."Interest Date" := SalesHeader."Interest Date";
      //Type must be Purchase, because receiving company so exactly the opposite.
      IcEntryRec."Gen. Posting Type" := IcEntryRec."Gen. Posting Type"::Purchase;
      IF CheckSalesLineBuyBackItemPO(SalesLine) THEN BEGIN
        lvGenJnlLineRec."Account No." := SalesLine."No.";
        lvGenJnlLineRec."Gen. Posting Type" := lvGenJnlLineRec."Gen. Posting Type"::Sale;
        CheckBuyBackGenPostTypPurchase(lvGenJnlLineRec);
        IF lvGenJnlLineRec."Gen. Posting Type" = lvGenJnlLineRec."Gen. Posting Type"::Purchase THEN
          IcEntryRec."Gen. Posting Type" := IcEntryRec."Gen. Posting Type"::Sale;
      END;
      IcEntryRec."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
      IcEntryRec."Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
      IcEntryRec."VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
      IcEntryRec."VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
      IcEntryRec."Rental Period" := SalesLine."Rental Period";
      IcEntryRec."Plant Invoice" := SalesHeader."Plant Invoice";
      IcEntryRec."Rental Periode to Date" := SalesHeader."Rental Periode to Date";
      //sn 18-06-09 call 13248
      IcEntryRec."Item No." := SalesLine."Item No.";
      IcEntryRec."Basic Item" := SalesLine."Basic Item";
      IcEntryRec."Trade Item" := SalesLine."Trade Item";
      IcEntryRec.Manufacturer := SalesLine.Manufacturer;
      IcEntryRec."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
      //en 18-06-09

      IcEntryRec.TESTFIELD("Account No.");
      IcEntryRec.TESTFIELD("Bal. Account No.");
      IF (IcEntryRec."Project No." <> '') OR (IcEntryRec."Service Order No." <> '') THEN
        IcEntryRec.TESTFIELD("Cost Object");

      IF IcEntryRec."Project No." <> '' THEN BEGIN
        IcEntryRec.CheckProjStatusReceivingComp();
        IcEntryRec.CheckProjElemBlockedRecComp(); //Call 6564
      END;
      IF IcEntryRec."Service Order No." <> '' THEN
        IcEntryRec.CheckServOrderStatusReceivComp();

      IcEntryRec.Surcharge := TRUE;

      IcEntryRec.UpdateDimension(1); //** DP00387 new
      IcEntryRec.UpdateDimension(2); //** DP00387 new

      IcEntryRec.INSERT(TRUE);

      //*C000522.sn (33636)
      //* If Cost Center on Invoice Proposal Line is empty, then not in DocDim. So then not copied above.
      //IF IcEntryRec."Global Dimension 1 Code" <> '' THEN BEGIN
        //IF NOT ICDimRec.GET(IcEntryRec."Line No.", GLSetup."Global Dimension 1 Code") THEN BEGIN  DP00387 so
        //  ICDimRec.INIT;
        //  ICDimRec."Line No." := IcEntryRec."Line No.";
        //  ICDimRec."Dimension Code" := GLSetup."Global Dimension 1 Code";
        //  ICDimRec."Dimension Value Code" := IcEntryRec."Global Dimension 1 Code";
        //  ICDimRec.INSERT;
        //END;
      //END;                                                                                        DP00387 eo
      //*C000522.en (33636)
    END;

    PROCEDURE PostComplWipProjectServPlantIC@1100525004();
    VAR
      lvPostingSetup@1100525002 : Record 11020565;
    BEGIN
      //**4PS
      //* For plant locations with a project or a serviceorder
      IF (SalesLine."Job No." = '') AND (SalesLine."Service Order No." = '') THEN
        EXIT;
      IF GenJnlLine.Amount = 0 THEN
        EXIT;

      IF (SalesLine."Job No." <> '') THEN BEGIN
        IF NOT ProjTypeRec."Post Complementary Costs" THEN
          EXIT;
      END ELSE BEGIN
        IF (SalesLine."Service Order No." <> '') THEN BEGIN
          IF NOT ServTypeRec."Post Complementary Costs" THEN
            EXIT;
        END;
      END;
      IF NOT lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, SalesHeader."Company Name") THEN
        EXIT;

      CLEAR(ComplWIPPostingBuffer[1]);

      IF lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, SalesHeader."Company Name") THEN BEGIN
        lvPostingSetup.TESTFIELD("Prod. Account Debit");
        ComplWIPPostingBuffer[1]."G/L Account" := lvPostingSetup."Prod. Account Debit";

        lvPostingSetup.TESTFIELD("Prod. Account Credit");
        ComplWIPPostingBuffer[1]."Bal. Account No." := lvPostingSetup."Prod. Account Credit";
      END;

      ComplWIPPostingBuffer[1].Amount := GenJnlLine.Amount;
      ComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      ComplWIPPostingBuffer[1]."Job No." :=  SalesLine."Job No.";
      ComplWIPPostingBuffer[1]."Service Order No." :=  SalesLine."Service Order No.";
      ComplWIPPostingBuffer[1]."Service Contract No." :=  SalesLine."Service Contract No.";
      ComplWIPPostingBuffer[1]."Global Dimension 1 Code" := GenJnlLine."Shortcut Dimension 1 Code";
      ComplWIPPostingBuffer[1]."Global Dimension 2 Code" := GenJnlLine."Shortcut Dimension 2 Code";
      ComplWIPPostingBuffer[1]."Dimension Set ID" := GenJnlLine."Dimension Set ID";

      UpdateComplWIPPostingBuffer;
    END;

    PROCEDURE InsertSalesInvoiceHeaderFromIC@1210190008();
    BEGIN
      //**4PS.n
      SalesInvHeader.INIT;
      SalesInvHeader.TRANSFERFIELDS(SalesHeader);
      SalesInvHeader."No." := GenJnlLineDocNo;
      SalesInvHeader."No. Series" := NoSeriesCde;
      SalesInvHeader."Source Code" := SrcCode;
      SalesInvHeader."User ID" := USERID;
      SalesInvHeader."No. Printed" := 0;
      IF SalesInvHeader."Pre-Assigned No. Series" <> '' THEN
        SalesInvHeader."Pre-Assigned No." := SalesHeader."No.";
      SalesInvHeader.INSERT;
    END;

    PROCEDURE InsertSalesCrMemHeaderFromIC@1210190009();
    BEGIN
      //**4PS
      SalesCrMemoHeader.INIT;
      SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
      SalesCrMemoHeader."Inserted By" := SalesHeader."Inserted By";
      SalesCrMemoHeader."No." := GenJnlLineDocNo;
      SalesCrMemoHeader."No. Series" := NoSeriesCde;
      SalesCrMemoHeader."Source Code" := SrcCode;
      SalesCrMemoHeader."User ID" := USERID;
      SalesCrMemoHeader."No. Printed" := 0;
      IF SalesCrMemoHeader."Pre-Assigned No. Series" <> '' THEN
        SalesCrMemoHeader."Pre-Assigned No." := SalesHeader."No.";
      SalesCrMemoHeader.INSERT;
    END;

    PROCEDURE InsertSalesInvoiceLinesFromIC@1210190006();
    VAR
      SalesInvLine@1100525000 : Record 113;
    BEGIN
      //**4PS
      SalesInvLine.INIT;
      SalesInvLine.TRANSFERFIELDS(SalesLine);
      SalesInvLine."Document No." := SalesInvHeader."No.";
      SalesInvLine.INSERT;
    END;

    PROCEDURE InsertSalesCrMemLinesFromIC@1210190003();
    VAR
      SalesCrMemoLine@1100525000 : Record 115;
    BEGIN
      //**4PS.n
      IF (SalesLine.Type <> SalesLine.Type::" ") THEN BEGIN
        IF SalesLine."Number of Time Units" < 0 THEN BEGIN
          SalesLine."Number of Time Units" := -SalesLine."Number of Time Units";
          IF (SalesLine."Unit Price" <> 0) THEN  //*C-026092
            SalesLine.VALIDATE("Line Amount", -SalesLine."Line Amount");
        END ELSE BEGIN
          IF SalesLine.Quantity < 0 THEN
            SalesLine.VALIDATE(Quantity, -SalesLine.Quantity)
          ELSE
            SalesLine.VALIDATE("Unit Price", -SalesLine."Unit Price");
        END;
      END;

      SalesCrMemoLine.INIT;
      SalesCrMemoLine.TRANSFERFIELDS(SalesLine);
      SalesCrMemoLine."Document No." := SalesCrMemoHeader."No.";
      SalesCrMemoLine.INSERT;
    END;

    PROCEDURE CheckManualRentalUnitInvoice@1210190007();
    VAR
      lvSalesLineRec@1210190000 : Record 37;
      lvRentalUnitRec@1210190001 : Record 11012940;
      lvText001@1210190002 : TextConst 'ENU=is not present';
    BEGIN
      //**4PS.n
      // All or none Rental Unit lines on a manual invoice (for a generated Rental Unit Invoice checks not needed).

      IF SalesHeader."Rental Unit Invoice" THEN
        EXIT;

      lvSalesLineRec.SETRANGE("Document Type", SalesHeader."Document Type");
      lvSalesLineRec.SETRANGE("Document No.", SalesHeader."No.");
      lvSalesLineRec.SETRANGE("Rental Unit Invoice", TRUE);
      IF NOT lvSalesLineRec.FINDFIRST THEN
        EXIT;

      SetRentalUnitInvoice := TRUE;
      RentalUnitProjectNo := lvSalesLineRec."Job No.";

      lvSalesLineRec.RESET;
      lvSalesLineRec.SETRANGE("Document Type", SalesHeader."Document Type");
      lvSalesLineRec.SETRANGE("Document No.", SalesHeader."No.");
      lvSalesLineRec.SETFILTER(Type, '<>%1', lvSalesLineRec.Type::" ");
      IF lvSalesLineRec.FINDSET THEN BEGIN
        REPEAT
          lvSalesLineRec.TESTFIELD("Rental Unit");
          lvRentalUnitRec.SETRANGE("Project No.", lvSalesLineRec."Job No.");
          lvRentalUnitRec.SETRANGE("Rental Unit", lvSalesLineRec."Rental Unit");
          IF NOT lvRentalUnitRec.FINDFIRST THEN
            lvSalesLineRec.FIELDERROR("Rental Unit",lvText001);
          lvSalesLineRec.TESTFIELD("Job No.", RentalUnitProjectNo);  // All Rental Unit invoice lines must have the same project
        UNTIL lvSalesLineRec.NEXT = 0;
      END;

      SalesHeader."Rental Unit Invoice" := TRUE;
    END;

    PROCEDURE CalcBAmount@1210190013(VAR lSalesInvHeader@1210190011 : Record 112);
    VAR
      lSalesInvLine@1210190000 : Record 113;
      lDimValRec@1210190010 : Record 349;
      lInvAmntPerc@1210190009 : Decimal;
      lInvAmntLabor@1210190008 : Decimal;
    BEGIN
      //**4PS
      WITH lSalesInvHeader DO BEGIN
        "Labor Amount (Subcontracting)" := 0;
        "Blocked Amount (Subcontracting" := 0;
        IF ("Plant Invoice" AND NOT ChargeSOToJobPlantLoc) AND NOT ChargeSOToCustomerPlantLoc THEN  //DP00195
          EXIT;

        lSalesInvLine.SETRANGE("Document No.", "No.");
        lSalesInvLine.SETFILTER(Type,'<>%1',lSalesInvLine.Type::" ");
        lSalesInvLine.SETRANGE("VAT Calculation Type", lSalesInvLine."VAT Calculation Type"::"Reverse Charge VAT");
        IF lSalesInvLine.FINDSET THEN
          REPEAT
            //Determine Amounts
            lInvAmntPerc := 0;
            lInvAmntLabor := 0;
            IF "Installment Invoice" OR
               (NOT "Installment Invoice" AND
               ("Calculate B Amounts based on" = "Calculate B Amounts based on"::"Invoice Amount"))
            THEN
              lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT"
            ELSE
              IF (lSalesInvLine."Cost Plus Line No." <> 0) THEN BEGIN
                IF (lSalesInvLine."Cost Type Cost Plus Line" = lSalesInvLine."Cost Type Cost Plus Line"::Labor) THEN BEGIN
                  lInvAmntLabor := lInvAmntLabor + lSalesInvLine."Amount Including VAT";
                END ELSE BEGIN
                  IF (lSalesInvLine."Cost Type Cost Plus Line" = lSalesInvLine."Cost Type Cost Plus Line"::Revenue) THEN
                    lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END;
              END ELSE BEGIN
                IF lSalesInvLine."Shortcut Dimension 2 Code" <> '' THEN BEGIN
                  DimMgt.GetDimValueRec(2, lSalesInvLine."Shortcut Dimension 2 Code", lDimValRec, FALSE,'');
                  IF (lDimValRec."Cost Type" = lDimValRec."Cost Type"::Labor) THEN
                    lInvAmntLabor := lInvAmntLabor + lSalesInvLine."Amount Including VAT"
                  ELSE
                    IF (lDimValRec."Cost Type" = lDimValRec."Cost Type"::Revenue) THEN
                      lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END ELSE BEGIN
                  lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END;

              END;

            "Labor Amount (Subcontracting)" :=
              "Labor Amount (Subcontracting)" + (lInvAmntLabor + lInvAmntPerc * ("% Labor"/100));
            "Blocked Amount (Subcontracting" :=
              "Blocked Amount (Subcontracting" + ((lInvAmntLabor + lInvAmntPerc * ("% Labor"/100)) * "% to B Account"/100);

          UNTIL lSalesInvLine.NEXT = 0;

        "Labor Amount (Subcontracting)" := ROUND("Labor Amount (Subcontracting)");
        "Blocked Amount (Subcontracting" := ROUND("Blocked Amount (Subcontracting");
      END;
    END;

    PROCEDURE CalcBAmountCrMemo@1100485001(VAR lSalesCrMemoHeader@1210190011 : Record 114);
    VAR
      lCrMemoLine@1210190000 : Record 115;
      lDimValRec@1210190010 : Record 349;
      lInvAmntPerc@1210190009 : Decimal;
      lInvAmntLabor@1210190008 : Decimal;
    BEGIN
      //**4PS
      WITH lSalesCrMemoHeader DO BEGIN
        "Labor Amount (Subcontracting)" := 0;
        "Blocked Amount (Subcontracting" := 0;

        IF "Plant Credit Memo" THEN
          EXIT;

        lCrMemoLine.SETRANGE("Document No.", "No.");
        lCrMemoLine.SETFILTER(Type,'<>%1',lCrMemoLine.Type::" ");
        lCrMemoLine.SETRANGE("VAT Calculation Type", lCrMemoLine."VAT Calculation Type"::"Reverse Charge VAT");
        IF lCrMemoLine.FINDSET THEN
          REPEAT
            //Determine Amounts
            lInvAmntPerc := 0;
            lInvAmntLabor := 0;
            IF "Installment Credit Memo" OR
               (NOT "Installment Credit Memo" AND
               ("Calculate B Amounts based on" = "Calculate B Amounts based on"::"Invoice Amount"))
            THEN
              lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT"
            ELSE
              IF (lCrMemoLine."Cost Plus Line No." <> 0) THEN BEGIN
                IF (lCrMemoLine."Cost Type Cost Plus Line" = lCrMemoLine."Cost Type Cost Plus Line"::Labor) THEN BEGIN
                  lInvAmntLabor := lInvAmntLabor + lCrMemoLine."Amount Including VAT";
                END ELSE BEGIN
                  IF (lCrMemoLine."Cost Type Cost Plus Line" = lCrMemoLine."Cost Type Cost Plus Line"::Revenue) THEN
                    lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT";
                END;
              END ELSE BEGIN
                IF lCrMemoLine."Shortcut Dimension 2 Code" <> '' THEN BEGIN
                  DimMgt.GetDimValueRec(2, lCrMemoLine."Shortcut Dimension 2 Code", lDimValRec, FALSE,'');
                  IF (lDimValRec."Cost Type" = lDimValRec."Cost Type"::Labor) THEN
                    lInvAmntLabor := lInvAmntLabor + lCrMemoLine."Amount Including VAT"
                  ELSE
                    IF (lDimValRec."Cost Type" = lDimValRec."Cost Type"::Revenue) THEN
                      lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT";
                END;
              END;

            "Labor Amount (Subcontracting)" :=
              "Labor Amount (Subcontracting)" + (lInvAmntLabor + lInvAmntPerc * ("% Labor"/100));
            "Blocked Amount (Subcontracting" :=
              "Blocked Amount (Subcontracting" + ((lInvAmntLabor + lInvAmntPerc * ("% Labor"/100)) * "% to B Account"/100);

          UNTIL lCrMemoLine.NEXT = 0;

        "Labor Amount (Subcontracting)" := ROUND("Labor Amount (Subcontracting)");
        "Blocked Amount (Subcontracting" := ROUND("Blocked Amount (Subcontracting");
      END;
    END;

    PROCEDURE PostComplRevenueFixedPriceProj@1100485002();
    BEGIN
      //**4PS
      IF JobJnlLine."Total Price (LCY)" = 0 THEN
        EXIT;

      ProjRec.GET(SalesLine."Job No.");
      //IF ProjRec."Settlement Method" <> ProjRec."Settlement Method"::"Fixed Price" THEN EXIT;  //db, 05-08-09: M14213

      ProjRec.TESTFIELD("Project Type");
      ProjTypeRec.GET(ProjRec."Project Type");
      IF NOT ProjTypeRec."Post Complementary Revenues" THEN
        EXIT;

      ProjTypeRec.TESTFIELD("Bal. Account Compl. Revenues");
      ProjTypeRec.TESTFIELD("Compl. Revenues Account");

      //Post Debit Line
      CLEAR(RequisitionPostingBuffer[1]);
      RequisitionPostingBuffer[1]."G/L Account" := ProjTypeRec."Bal. Account Compl. Revenues";
      RequisitionPostingBuffer[1].Amount := JobJnlLine."Total Price (LCY)";
      RequisitionPostingBuffer[1].Description := SalesHeader."Posting Description";
      RequisitionPostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      RequisitionPostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      RequisitionPostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      UpdateRequisitionPostingBuffer;

      //Post Credit Line
      RequisitionPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. Revenues Account";
      RequisitionPostingBuffer[1].Amount := -JobJnlLine."Total Price (LCY)";
      UpdateRequisitionPostingBuffer;
    END;

    PROCEDURE PostComplRevenueFixedPriceServ@1100485008();
    VAR
      ServiceTypeRec@1100485002 : Record 11012814;
      FixedPriceRevAcc@1100525001 : Code[20];
      lvServType@1100525000 : Code[20];
    BEGIN
      //**4PS
      IF ServJnlLine."Total Revenue (LCY)" = 0 THEN
        EXIT;

      //db.sn, 10-07-09: M14213
      IF SalesLine."Service Order No." <> '' THEN BEGIN
        ServOrderRec.GET(SalesLine."Service Order No.");
      //IF ServOrderRec."Settlement Method" <> ServOrderRec."Settlement Method"::"Fixed Price" THEN EXIT;  //db, 05-08-09: M14213
        ServOrderRec.TESTFIELD("Service Type");
        lvServType := ServOrderRec."Service Type";
      END ELSE BEGIN
        ServContrRec.GET(SalesLine."Service Contract No.");
        ServContrRec.TESTFIELD("Service Type");
        lvServType := ServContrRec."Service Type";
        ServOrderRec."Source Type" := ServOrderRec."Source Type"::Contract;  //db, 05-08-09: M14213
      END;
      //db.en, 10-07-09: M14213

      ServiceTypeRec.GET(lvServType);
      IF NOT ServiceTypeRec."Post Complementary Revenues" THEN
        EXIT;

      ServiceTypeRec.TESTFIELD("Bal. Account Compl. Revenues");
      CASE ServOrderRec."Source Type" OF
        ServOrderRec."Source Type"::Call:
          BEGIN
            ServiceTypeRec.TESTFIELD("Compl. Revenues Acc. Call");
            FixedPriceRevAcc := ServiceTypeRec."Compl. Revenues Acc. Call";
          END;
        ServOrderRec."Source Type"::Contract:
          BEGIN
            ServiceTypeRec.TESTFIELD("Compl. Revenues Acc. Contract");
            FixedPriceRevAcc := ServiceTypeRec."Compl. Revenues Acc. Contract";
          END;
        ServOrderRec."Source Type"::Estimate:
          BEGIN
            ServiceTypeRec.TESTFIELD("Compl. Revenues Acc. Estimate");
            FixedPriceRevAcc := ServiceTypeRec."Compl. Revenues Acc. Estimate";
          END;
        ServOrderRec."Source Type"::Direct:
          BEGIN
            ServiceTypeRec.TESTFIELD("Compl. Revenues Acc. Other");
            FixedPriceRevAcc := ServiceTypeRec."Compl. Revenues Acc. Other";
          END;
      END;

      //Dimensions
      //Post Debit Line
      CLEAR(RequisitionPostingBuffer[1]);
      RequisitionPostingBuffer[1]."G/L Account" := ServiceTypeRec."Bal. Account Compl. Revenues";
      RequisitionPostingBuffer[1].Amount := ServJnlLine."Total Revenue (LCY)";
      RequisitionPostingBuffer[1].Description := SalesHeader."Posting Description";
      RequisitionPostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      RequisitionPostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      RequisitionPostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";
      UpdateRequisitionPostingBuffer;

      //Post Credit Line
      RequisitionPostingBuffer[1]."G/L Account" := FixedPriceRevAcc;
      RequisitionPostingBuffer[1].Amount := -ServJnlLine."Total Revenue (LCY)";
      UpdateRequisitionPostingBuffer;
    END;

    PROCEDURE PostComplWipProjectPlant@1100485006();
    BEGIN
      //**4PS
      IF JobJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      ProjRec.GET(SalesLine."Job No.");
      ProjRec.TESTFIELD("Project Type");
      ProjTypeRec.GET(ProjRec."Project Type");
      IF NOT ProjTypeRec."Post Complementary Costs" THEN
        EXIT;

      DimMgt.GetDimValueRec(2, SalesLine."Shortcut Dimension 2 Code", DimValRec, TRUE, SalesLine."Job No.");

      //Post Debit Line
      CLEAR(ComplWIPPostingBuffer[1]);
      CASE DimValRec."Cost Type" OF
        DimValRec."Cost Type"::Labor:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Cover Acc. Labor");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ProjTypeRec."Compl. WIP Cover Acc. Labor";
          END;
        DimValRec."Cost Type"::Material:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Cover Acc. Material");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ProjTypeRec."Compl. WIP Cover Acc. Material";
          END;
        DimValRec."Cost Type"::Subcontracting:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Cover Acc. Subc.");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ProjTypeRec."Compl. WIP Cover Acc. Subc.";
          END;
        DimValRec."Cost Type"::Plant:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Cover Acc. Plant");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ProjTypeRec."Compl. WIP Cover Acc. Plant";
          END;
        DimValRec."Cost Type"::Sundry:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Cover Acc. Sundry");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ProjTypeRec."Compl. WIP Cover Acc. Sundry";
          END
      END;
      ComplWIPPostingBuffer[1].Amount := JobJnlLine."Total Cost (LCY)";
      ComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      ComplWIPPostingBuffer[1]."Job No." :=  SalesLine."Job No.";
      ComplWIPPostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      ComplWIPPostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      ComplWIPPostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";

      //Post Credit Line
      CASE DimValRec."Cost Type" OF
        DimValRec."Cost Type"::Labor:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Acc. Labor");
            ComplWIPPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. WIP Acc. Labor";
          END;
        DimValRec."Cost Type"::Material:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Acc. Material");
            ComplWIPPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. WIP Acc. Material";
          END;
        DimValRec."Cost Type"::Subcontracting:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Acc. Subc.");
            ComplWIPPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. WIP Acc. Subc.";
          END;
        DimValRec."Cost Type"::Plant:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Acc. Plant");
            ComplWIPPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. WIP Acc. Plant";
          END;
        DimValRec."Cost Type"::Sundry:
          BEGIN
            ProjTypeRec.TESTFIELD("Compl. WIP Acc. Sundry");
            ComplWIPPostingBuffer[1]."G/L Account" := ProjTypeRec."Compl. WIP Acc. Sundry";
          END

      END;
      UpdateComplWIPPostingBuffer;
    END;

    PROCEDURE PostComplWipServicePlant@1100525011();
    BEGIN
      //**4PS
      IF ServJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      ServOrderRec.GET(SalesLine."Service Order No.");
      IF SalesLine."Additional Cost (Service)" THEN BEGIN
        ServOrderRec.TESTFIELD("Service Type (Other)");
        ServTypeRec.Code := ServOrderRec."Service Type (Other)";
      END ELSE BEGIN
        ServOrderRec.TESTFIELD("Service Type");
        ServTypeRec.Code := ServOrderRec."Service Type";
      END;
      ServTypeRec.GET(ServTypeRec.Code);
      IF NOT ServTypeRec."Post Complementary Costs" THEN
        EXIT;

      DimMgt.GetDimValueRec(2, SalesLine."Shortcut Dimension 2 Code", DimValRec, TRUE, SalesLine."Job No.");

      //Post Debit Line
      CLEAR(ComplWIPPostingBuffer[1]);
      CASE DimValRec."Cost Type" OF
        DimValRec."Cost Type"::Labor:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Cover Acc. Labor");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ServTypeRec."Compl. WIP Cover Acc. Labor";
          END;
        DimValRec."Cost Type"::Material:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Cover Acc. Material");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ServTypeRec."Compl. WIP Cover Acc. Material";
          END;
        DimValRec."Cost Type"::Subcontracting:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Cover Acc. Subc.");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ServTypeRec."Compl. WIP Cover Acc. Subc.";
          END;
        DimValRec."Cost Type"::Plant:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Cover Acc. Plant");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ServTypeRec."Compl. WIP Cover Acc. Plant";
          END;
        DimValRec."Cost Type"::Sundry:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Cover Acc. Sundry");
            ComplWIPPostingBuffer[1]."Bal. Account No." := ServTypeRec."Compl. WIP Cover Acc. Sundry";
          END
      END;
      ComplWIPPostingBuffer[1].Amount := ServJnlLine."Total Cost (LCY)";
      ComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      ComplWIPPostingBuffer[1]."Service Order No." :=  SalesLine."Service Order No.";
      ComplWIPPostingBuffer[1]."Service Contract No." :=  SalesLine."Service Contract No.";
      ComplWIPPostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      ComplWIPPostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      ComplWIPPostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";

      //Post Credit Line
      CASE DimValRec."Cost Type" OF
        DimValRec."Cost Type"::Labor:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Acc. Labor");
            ComplWIPPostingBuffer[1]."G/L Account" := ServTypeRec."Compl. WIP Acc. Labor";
          END;
        DimValRec."Cost Type"::Material:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Acc. Material");
            ComplWIPPostingBuffer[1]."G/L Account" := ServTypeRec."Compl. WIP Acc. Material";
          END;
        DimValRec."Cost Type"::Subcontracting:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Acc. Subc.");
            ComplWIPPostingBuffer[1]."G/L Account" := ServTypeRec."Compl. WIP Acc. Subc.";
          END;
        DimValRec."Cost Type"::Plant:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Acc. Plant");
            ComplWIPPostingBuffer[1]."G/L Account" := ServTypeRec."Compl. WIP Acc. Plant";
          END;
        DimValRec."Cost Type"::Sundry:
          BEGIN
            ServTypeRec.TESTFIELD("Compl. WIP Acc. Sundry");
            ComplWIPPostingBuffer[1]."G/L Account" := ServTypeRec."Compl. WIP Acc. Sundry";
          END

      END;
      UpdateComplWIPPostingBuffer;
    END;

    PROCEDURE PostComplWIPSurchargeIC@1100525008(lvAccount@1100485001 : Code[20];lvBalanceAccount@1100525000 : Code[20]);
    BEGIN
      //**4PS
      //Starting point is 'normal surcharge' record

      IF SurchargePostingBuffer[1].Amount = 0 THEN
        EXIT;

      CLEAR(ComplWIPPostingBuffer[1]);
      ComplWIPPostingBuffer[1]."G/L Account" := lvAccount;
      ComplWIPPostingBuffer[1]."Bal. Account No." := lvBalanceAccount;
      ComplWIPPostingBuffer[1].Amount := SurchargePostingBuffer[1].Amount;
      ComplWIPPostingBuffer[1].Description := SurchargePostingBuffer[1].Description;
      ComplWIPPostingBuffer[1]."Job No." :=  SurchargePostingBuffer[1]."Job No.";
      ComplWIPPostingBuffer[1]."Service Order No." := SurchargePostingBuffer[1]."Service Order No.";
      ComplWIPPostingBuffer[1]."Service Contract No." := SurchargePostingBuffer[1]."Service Contract No.";
      ComplWIPPostingBuffer[1]."Global Dimension 1 Code" := SurchargePostingBuffer[1]."Global Dimension 1 Code";
      ComplWIPPostingBuffer[1]."Global Dimension 2 Code" := SurchargePostingBuffer[1]."Global Dimension 2 Code";
      ComplWIPPostingBuffer[1]."Dimension Set ID" := SurchargePostingBuffer[1]."Dimension Set ID";

      UpdateComplWIPPostingBuffer;
    END;

    PROCEDURE UpdateComplWIPPostingBuffer@1100485011();
    BEGIN
      //**4PS
      ComplWIPPostingBuffer[2] := ComplWIPPostingBuffer[1];
      IF ComplWIPPostingBuffer[2].FIND THEN BEGIN
        ComplWIPPostingBuffer[2].Amount :=
          ComplWIPPostingBuffer[2].Amount + ComplWIPPostingBuffer[1].Amount;    //**4PS-12385
        ComplWIPPostingBuffer[2].MODIFY;
      END ELSE
        ComplWIPPostingBuffer[1].INSERT;
    END;

    PROCEDURE UpdateRequisitionPostingBuffer@1100485007();
    BEGIN
      //**4PS
      RequisitionPostingBuffer[2] := RequisitionPostingBuffer[1];
      IF RequisitionPostingBuffer[2].FIND THEN BEGIN
        RequisitionPostingBuffer[2].Amount :=
          RequisitionPostingBuffer[2].Amount + RequisitionPostingBuffer[1].Amount;
        RequisitionPostingBuffer[2].MODIFY;
      END ELSE
        RequisitionPostingBuffer[1].INSERT;
    END;

    PROCEDURE SetLedgerEntryProcessed@1100485004(VAR iSalesLineRec@1100485000 : Record 37);
    VAR
      lvProjLedgEntRec@1100485001 : Record 11072005;
      lvHourLineRec@1100485002 : Record 11012085;
      lvProjCPRec@1100485003 : Record 11012019;
    BEGIN
      //**4PS03.n
      IF lvProjCPRec.GET(iSalesLineRec."Job No.", iSalesLineRec."Sell-to Customer No.",
                          iSalesLineRec."Commission No.", iSalesLineRec."Settl.Sheet No." ,
                          iSalesLineRec."Cost Plus Line No.") THEN BEGIN
        IF lvProjCPRec.Processed THEN BEGIN
          IF lvProjCPRec."Entry No. Project Ledger" <> 0 THEN BEGIN
            IF lvProjLedgEntRec.GET(lvProjCPRec."Entry No. Project Ledger") THEN BEGIN
              lvProjLedgEntRec.Processed := lvProjCPRec.Processed;
              lvProjLedgEntRec.MODIFY;
            END;
          END ELSE BEGIN
            IF lvHourLineRec.GET(lvProjCPRec."Posted Hour Year", lvProjCPRec."Posted Hour Week", lvProjCPRec."Employee No.",
              lvProjCPRec."Posted Hour Line No.") THEN BEGIN
              lvHourLineRec.Processed := lvProjCPRec.Processed;
              lvHourLineRec.MODIFY;
            END;
          END;
        END;
      END;
    END;

    PROCEDURE CheckSalesLineBuyBackItemPO@1100485003(VAR ISalesLineRec@1100485000 : Record 37) : Boolean;
    BEGIN
      //**4PS
      WITH ISalesLineRec DO BEGIN
        IF "Plant Invoice" AND
           ("Plant Invoice Origin" = "Plant Invoice Origin"::"Plant Order") AND
           ("Relate to" = "Relate to"::ItemBuyBack)
        THEN
          EXIT(TRUE);

        EXIT(FALSE);
      END;
    END;

    PROCEDURE CheckBuyBackGenPostTypPurchase@1100485005(VAR VarGenJnlLineRec@1100485002 : Record 81);
    VAR
      lvAccRec@1100485001 : Record 15;
    BEGIN
      //**4PS
      //* It is only allowed to call this function if "Account No." and "Gen. Posting Type" of GenJnlLine are filled.
      IF lvAccRec.GET(VarGenJnlLineRec."Account No.") THEN BEGIN
        IF lvAccRec."Gen. Posting Type" <> lvAccRec."Gen. Posting Type"::Sale THEN   //* Empty or Purchase
          VarGenJnlLineRec."Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Purchase;
      END;
    END;

    PROCEDURE CheckQtyToInvoicePresent@1100525001();
    VAR
      lvSalesLineRec@1100525000 : Record 37;
    BEGIN
      //**4PS  (call 12607)
      gCreateNotPostedCredMemo := FALSE;

      lvSalesLineRec.SETRANGE("Document Type", SalesHeader."Document Type");
      lvSalesLineRec.SETRANGE("Document No.", SalesHeader."No.");
      lvSalesLineRec.SETFILTER("Qty. to Invoice", '<>0');
      IF NOT lvSalesLineRec.FINDSET THEN
        gInvoiceOrderNotPostedInvoice := FALSE;
    END;

    PROCEDURE InsertNotPostedSalesInvoice@1100525003();
    BEGIN
      //**4PS  (call 12607)
      SalesHeadInvFromOrderRec.INIT;
      IF SalesHeader."Document Type" <> SalesHeader."Document Type"::"Return Order" THEN  //*27074
        SalesHeadInvFromOrderRec."Document Type" := SalesHeadInvFromOrderRec."Document Type"::Invoice
      ELSE
        SalesHeadInvFromOrderRec."Document Type" := SalesHeadInvFromOrderRec."Document Type"::"Credit Memo";
      SalesHeadInvFromOrderRec."No." := '';
      SalesHeadInvFromOrderRec.INSERT(TRUE);
      SalesHeadInvFromOrderRec.TESTFIELD("No.");
      SalesHeadInvFromOrderRec.VALIDATE("Sell-to Customer No.",  SalesHeader."Sell-to Customer No.");
      IF SalesHeader."Bill-to Customer No." <> '' THEN
        SalesHeadInvFromOrderRec.VALIDATE("Bill-to Customer No.", SalesHeader."Bill-to Customer No.");
      IF SalesHeader."Document Type" <> SalesHeader."Document Type"::"Return Order" THEN  //*27074
        SalesHeadInvFromOrderRec.VALIDATE("Related Sales Order No.", SalesHeader."No.");
      IF SalesHeadInvFromOrderRec."Currency Code" <> SalesHeader."Currency Code" THEN
        SalesHeadInvFromOrderRec.VALIDATE("Currency Code", SalesHeader."Currency Code");

      SalesHeadInvFromOrderRec."Sell-to Contact No." := SalesHeader."Sell-to Contact No.";
      SalesHeadInvFromOrderRec."Sell-to Customer Name" := SalesHeader."Sell-to Customer Name";
      SalesHeadInvFromOrderRec."Sell-to Customer Name 2" := SalesHeader."Sell-to Customer Name 2";
      SalesHeadInvFromOrderRec."Sell-to Address" := SalesHeader."Sell-to Address";
      SalesHeadInvFromOrderRec."Sell-to Address 2" := SalesHeader."Sell-to Address 2";
      SalesHeadInvFromOrderRec."Sell-to Post Code" := SalesHeader."Sell-to Post Code";
      SalesHeadInvFromOrderRec."Sell-to City" := SalesHeader."Sell-to City";
      SalesHeadInvFromOrderRec."Sell-to County" := SalesHeader."Sell-to County";
      SalesHeadInvFromOrderRec."Sell-to Country/Region Code" := SalesHeader."Sell-to Country/Region Code";
      SalesHeadInvFromOrderRec."Sell-to Contact" := SalesHeader."Sell-to Contact";
      SalesHeadInvFromOrderRec."Your Reference" := SalesHeader."Your Reference";
      SalesHeadInvFromOrderRec."Alternative Bill-to Address" := SalesHeader."Alternative Bill-to Address";
      SalesHeadInvFromOrderRec."Bill-to Contact No." := SalesHeader."Bill-to Contact No.";
      SalesHeadInvFromOrderRec."Bill-to Name" := SalesHeader."Bill-to Name";
      SalesHeadInvFromOrderRec."Bill-to Name 2" := SalesHeader."Bill-to Name 2";
      SalesHeadInvFromOrderRec."Bill-to Address" := SalesHeader."Bill-to Address";
      SalesHeadInvFromOrderRec."Bill-to Address 2" := SalesHeader."Bill-to Address 2";
      SalesHeadInvFromOrderRec."Bill-to Post Code" := SalesHeader."Bill-to Post Code";
      SalesHeadInvFromOrderRec."Bill-to City" := SalesHeader."Bill-to City";
      SalesHeadInvFromOrderRec."Bill-to County" := SalesHeader."Bill-to County";
      SalesHeadInvFromOrderRec."Bill-to Country/Region Code" := SalesHeader."Bill-to Country/Region Code";
      SalesHeadInvFromOrderRec."Bill-to Contact" := SalesHeader."Bill-to Contact";
      SalesHeadInvFromOrderRec."Ship-to Code" := SalesHeader."Ship-to Code";
      SalesHeadInvFromOrderRec."Ship-to Name" := SalesHeader."Ship-to Name";
      SalesHeadInvFromOrderRec."Ship-to Name 2" := SalesHeader."Ship-to Name 2";
      SalesHeadInvFromOrderRec."Ship-to Address" := SalesHeader."Ship-to Address";
      SalesHeadInvFromOrderRec."Ship-to Address 2" := SalesHeader."Ship-to Address 2";
      SalesHeadInvFromOrderRec."Ship-to Post Code" := SalesHeader."Ship-to Post Code";
      SalesHeadInvFromOrderRec."Ship-to City" := SalesHeader."Ship-to City";
      SalesHeadInvFromOrderRec."Ship-to County" := SalesHeader."Ship-to County";
      SalesHeadInvFromOrderRec."Ship-to Country/Region Code" := SalesHeader."Ship-to Country/Region Code";
      SalesHeadInvFromOrderRec."Ship-to Contact" := SalesHeader."Ship-to Contact";

      //*28799.sn
      SalesHeadInvFromOrderRec."Salesperson Code" := SalesHeader."Salesperson Code";
      SalesHeadInvFromOrderRec."Shipment Method Code" := SalesHeader."Shipment Method Code";
      SalesHeadInvFromOrderRec."Shipping Agent Code" := SalesHeader."Shipping Agent Code";
      SalesHeadInvFromOrderRec."Invoice Disc. Code" := SalesHeader."Invoice Disc. Code";
      SalesHeadInvFromOrderRec."Shortcut Dimension 1 Code" := SalesHeader."Shortcut Dimension 1 Code";
      SalesHeadInvFromOrderRec."Shortcut Dimension 2 Code" := SalesHeader."Shortcut Dimension 2 Code";
      SalesHeadInvFromOrderRec."Dimension Set ID" := SalesHeader."Dimension Set ID";

      SalesHeadInvFromOrderRec.MODIFY(TRUE);

      //M28272 so
      //  IF SalesSetup."Copy Comments Order to Invoice" THEN BEGIN
      //    CopyCommentLines(
      //      SalesHeader."Document Type", SalesHeadInvFromOrderRec."Document Type",
      //      SalesHeader."No.",SalesHeadInvFromOrderRec."No.");
      //  END;
      //28272 eo
    END;

    PROCEDURE DelayInsertNotPostedSaleInvLin@1100525015();
    BEGIN
      //**4PS  24767

      //C015652.sn
      IF NOT AdditionalCheckOnQtyOk(SaveOrgSalesLineRec, FALSE) THEN
        EXIT;
      //C015652.en

      TmpSalesOrderLineForInv := SaveOrgSalesLineRec;
      TmpSalesOrderLineForInv.INSERT;
    END;

    PROCEDURE ProcInsertNotPostSalesInvLines@1100525016();
    BEGIN
      //**4PS  24767
      IF TmpSalesOrderLineForInv.FINDSET THEN BEGIN
        REPEAT
          SaveOrgSalesLineRec := TmpSalesOrderLineForInv;
          InsertNotPostedSalesInvLine();
        UNTIL TmpSalesOrderLineForInv.NEXT = 0;
      END;
    END;

    PROCEDURE InsertNotPostedSalesInvLine@1100525005();
    VAR
      lvSalesLineInvRec@1100525000 : Record 37;
      lvSalesLineRec2@1100525002 : Record 37;
      lvSalesShptLineRec@1100525001 : Record 111;
      lvSalesShptLineRec2@1100525003 : Record 111;
      lvReturnReceiptLine@1210190000 : Record 6661;
      lvReturnReceiptLine2@1210190001 : Record 6661;
      lvNextLineNo@1100525008 : Integer;
      lvQtyToInvoice@1100525006 : Decimal;
      lvRestQtyToInvoice@1100525007 : Decimal;
    BEGIN
      //**4PS  (call 12607)
      IF SaveOrgSalesLineRec.Type = SaveOrgSalesLineRec.Type::" " THEN BEGIN  //* Copy all text lines (14662)
        lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrderRec."Document Type");
        lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrderRec."No.");
        IF lvSalesLineInvRec.FINDLAST THEN
          lvNextLineNo := lvSalesLineInvRec."Line No.";
        lvNextLineNo := lvNextLineNo + 10000;
        //
        lvSalesLineInvRec.TRANSFERFIELDS(SaveOrgSalesLineRec);
        lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrderRec."Document Type";
        lvSalesLineInvRec."Document No." := SalesHeadInvFromOrderRec."No.";
        lvSalesLineInvRec."Line No." := lvNextLineNo;
        lvSalesLineInvRec.INSERT;
        //
        //M28272 sn
        IF SalesSetup."Copy Comments Order to Invoice" THEN BEGIN
          CopySingleCommentLines(
            SalesHeader."Document Type", SalesHeadInvFromOrderRec."Document Type",
            SalesHeader."No.",SalesHeadInvFromOrderRec."No.",
            SaveOrgSalesLineRec."Line No.", lvSalesLineInvRec."Line No.");
        END;
        //M28272 en
        EXIT;
      END;

      lvRestQtyToInvoice := SaveOrgSalesLineRec."Qty. to Invoice";
      IF lvRestQtyToInvoice = 0 THEN
        EXIT;

      IF SaveOrgSalesLineRec."Document Type" <> SaveOrgSalesLineRec."Document Type"::"Return Order" THEN BEGIN  //*27074.n
        lvSalesShptLineRec.SETCURRENTKEY("Order No.", "Order Line No.");
        lvSalesShptLineRec.SETRANGE("Order No.", SaveOrgSalesLineRec."Document No.");
        lvSalesShptLineRec.SETRANGE("Order Line No.", SaveOrgSalesLineRec."Line No.");
        lvSalesShptLineRec.SETRANGE("Bill-to Customer No.",SalesHeader."Bill-to Customer No.");
        IF lvRestQtyToInvoice >= 0 THEN
          lvSalesShptLineRec.SETFILTER("Qty. Shipped Not Invoiced",'>0')
        ELSE
          lvSalesShptLineRec.SETFILTER("Qty. Shipped Not Invoiced",'<0');
        lvSalesShptLineRec.SETRANGE("Currency Code",SalesHeader."Currency Code");
        IF lvSalesShptLineRec.FINDSET(TRUE,FALSE) THEN BEGIN
          lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrderRec."Document Type");
          lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrderRec."No.");
          lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrderRec."Document Type";
          lvSalesLineInvRec."Document No." := SalesHeadInvFromOrderRec."No.";
          //
          lvSalesLineRec2.SETCURRENTKEY("Document Type", "Shipment No.", "Shipment Line No.");
          lvSalesLineRec2.SETFILTER("Document Type", '%1|%2',
            lvSalesLineRec2."Document Type"::Invoice, lvSalesLineRec2."Document Type"::"Credit Memo");
          lvSalesLineRec2.SETFILTER("Document No.", '<>%1', SalesHeadInvFromOrderRec."No.");
          REPEAT
            lvSalesLineRec2.SETRANGE("Shipment No.", lvSalesShptLineRec."Document No.");
            lvSalesLineRec2.SETRANGE("Shipment Line No.", lvSalesShptLineRec."Line No.");
            IF lvSalesLineRec2.FINDFIRST THEN
              ERROR(Text11012003, lvSalesShptLineRec."Order No.", lvSalesShptLineRec."Order Line No.",
               LOWERCASE(lvSalesShptLineRec.TABLECAPTION),
               lvSalesLineRec2."Document Type", lvSalesLineRec2."Document No.", lvSalesLineRec2."Line No.");

            lvSalesShptLineRec2 := lvSalesShptLineRec;
            IF ABS(lvRestQtyToInvoice) > ABS(lvSalesShptLineRec2."Qty. Shipped Not Invoiced") THEN BEGIN
              lvQtyToInvoice := lvSalesShptLineRec2."Qty. Shipped Not Invoiced";
              lvRestQtyToInvoice := lvRestQtyToInvoice - lvSalesShptLineRec2."Qty. Shipped Not Invoiced"
            END ELSE BEGIN
              lvQtyToInvoice := lvRestQtyToInvoice;
              lvRestQtyToInvoice := 0;
            END;
            IF (lvQtyToInvoice <> 0) AND (lvSalesLineInvRec."Document Type" = lvSalesLineInvRec."Document Type"::"Credit Memo") THEN
              lvQtyToInvoice := -lvQtyToInvoice;
            lvSalesShptLineRec2.SetCreateNotPostedInvFromOrder(lvQtyToInvoice);
            lvSalesShptLineRec2.InsertInvLineFromShptLine(lvSalesLineInvRec, TRUE); //M28272 changed
          UNTIL (lvSalesShptLineRec.NEXT = 0) OR (lvRestQtyToInvoice = 0);
          IF lvRestQtyToInvoice <> 0 THEN
            SaveOrgSalesLineRec.FIELDERROR("Qty. to Invoice",
              STRSUBSTNO(Text11012002, lvSalesShptLineRec.TABLECAPTION,
              SaveOrgSalesLineRec."Qty. to Invoice"-lvRestQtyToInvoice, SaveOrgSalesLineRec."Qty. to Invoice"));
        END;
      //*27074.sn
      END ELSE BEGIN
        lvReturnReceiptLine.SETCURRENTKEY("Return Order No.", "Return Order Line No.");
        lvReturnReceiptLine.SETRANGE("Return Order No.", SaveOrgSalesLineRec."Document No.");
        lvReturnReceiptLine.SETRANGE("Return Order Line No.", SaveOrgSalesLineRec."Line No.");
        lvReturnReceiptLine.SETRANGE("Bill-to Customer No.",SalesHeader."Bill-to Customer No.");
        IF lvRestQtyToInvoice >= 0 THEN
          lvReturnReceiptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'>0')
        ELSE
          lvReturnReceiptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'<0');
        lvReturnReceiptLine.SETRANGE("Currency Code",SalesHeader."Currency Code");
        IF lvReturnReceiptLine.FINDSET(TRUE,FALSE) THEN BEGIN
          lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrderRec."Document Type");
          lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrderRec."No.");
          lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrderRec."Document Type";
          lvSalesLineInvRec."Document No." := SalesHeadInvFromOrderRec."No.";
          //
          lvSalesLineRec2.SETFILTER("Document Type", '%1|%2',
            lvSalesLineRec2."Document Type"::Invoice, lvSalesLineRec2."Document Type"::"Credit Memo");
          lvSalesLineRec2.SETFILTER("Document No.", '<>%1', SalesHeadInvFromOrderRec."No.");
          REPEAT
            lvSalesLineRec2.SETRANGE("Return Receipt No.", lvReturnReceiptLine."Document No.");
            lvSalesLineRec2.SETRANGE("Return Receipt Line No.", lvReturnReceiptLine."Line No.");
            IF lvSalesLineRec2.FINDFIRST THEN
              ERROR(Text11012003, lvReturnReceiptLine."Return Order No.", lvReturnReceiptLine."Return Order Line No.",
               LOWERCASE(lvReturnReceiptLine.TABLECAPTION),
               lvSalesLineRec2."Document Type", lvSalesLineRec2."Document No.", lvSalesLineRec2."Line No.");

            lvReturnReceiptLine2 := lvReturnReceiptLine;
            IF ABS(lvRestQtyToInvoice) > ABS(lvReturnReceiptLine2."Return Qty. Rcd. Not Invd.") THEN BEGIN
              lvQtyToInvoice := lvReturnReceiptLine2."Return Qty. Rcd. Not Invd.";
              lvRestQtyToInvoice := lvRestQtyToInvoice - lvReturnReceiptLine2."Return Qty. Rcd. Not Invd."
            END ELSE BEGIN
              lvQtyToInvoice := lvRestQtyToInvoice;
              lvRestQtyToInvoice := 0;
            END;
            IF (lvQtyToInvoice <> 0) AND (lvSalesLineInvRec."Document Type" = lvSalesLineInvRec."Document Type"::Invoice) THEN
              lvQtyToInvoice := -lvQtyToInvoice;
            lvReturnReceiptLine2.SetCreateNotPostedInvFromOrder(lvQtyToInvoice);
            lvReturnReceiptLine2.InsertInvLineFromRetRcptLine(lvSalesLineInvRec, TRUE); //M28272 changed
          UNTIL (lvReturnReceiptLine.NEXT = 0) OR (lvRestQtyToInvoice = 0);
          IF lvRestQtyToInvoice <> 0 THEN
            SaveOrgSalesLineRec.FIELDERROR("Qty. to Invoice",
              STRSUBSTNO(Text11012002, lvReturnReceiptLine.TABLECAPTION,
              SaveOrgSalesLineRec."Qty. to Invoice"-lvRestQtyToInvoice, SaveOrgSalesLineRec."Qty. to Invoice"));
        END;
      END;
      //*27074.en
    END;

    PROCEDURE StandardSalesOrder@1100525013(SalesHeadRec@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      WITH SalesHeadRec DO BEGIN
        IF ("Document Type" IN ["Document Type"::Order, "Document Type"::"Return Order"]) AND
           ("Sales Document Type" = "Sales Document Type"::Standard)
        THEN
          EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    PROCEDURE CloseStandardSalesOrder@1100525012(SalesLineRec@1210190000 : Record 37);
    VAR
      SalesHeadRec@1210190001 : Record 36;
    BEGIN
      //**4PS
      IF NOT SalesHeadRec.GET(SalesLineRec."Document Type", SalesLineRec."Document No.") THEN
        EXIT;
      IF SalesHeadRec.Status = SalesHeadRec.Status::Closed THEN
        EXIT;
      IF NOT StandardSalesOrder(SalesHeadRec) THEN
        EXIT;

      SalesLineRec.RESET;
      SalesLineRec.SETRANGE("Document Type", SalesHeadRec."Document Type");
      SalesLineRec.SETRANGE("Document No.", SalesHeadRec."No.");
      IF SalesLineRec.FINDSET THEN BEGIN
        REPEAT
          IF NOT SalesLineRec.OrderLineCompletelyShippedAndInvoiced THEN
            EXIT;
        UNTIL SalesLineRec.NEXT = 0;
      END;

      SalesHeadRec.Status := SalesHeadRec.Status::Closed;
      SalesHeadRec.MODIFY;
    END;

    PROCEDURE CopySingleCommentLines@1210190000(FromDocumentType@1000 : Integer;ToDocumentType@1001 : Integer;FromNumber@1002 : Code[20];ToNumber@1003 : Code[20];FromLineNo@1210190000 : Integer;ToLineNo@1210190001 : Integer);
    VAR
      SalesCommentLine@1100525000 : Record 44;
      SalesCommentLine2@1100525001 : Record 44;
    BEGIN
      //**4PS M28272 new
      SalesCommentLine.SETRANGE("Document Type",FromDocumentType);
      SalesCommentLine.SETRANGE("No.",FromNumber);
      SalesCommentLine.SETRANGE("Document Line No.",FromLineNo);

      IF SalesCommentLine.FINDSET THEN
        REPEAT
          SalesCommentLine2 := SalesCommentLine;
          SalesCommentLine2."Document Type" := ToDocumentType;
          SalesCommentLine2."No." := ToNumber;
          SalesCommentLine2."Document Line No." := ToLineNo;
          IF SalesCommentLine2.INSERT THEN;
        UNTIL SalesCommentLine.NEXT = 0;
    END;

    PROCEDURE PostNSItemTracking@1100528601(VAR SalesShptLine@1100525000 : Record 111);
    VAR
      NSReservationEntry@1100528604 : Record 11071900;
      NSItemTrackingCheck@1100528600 : Codeunit 11012353;
      QuantityProcessed@1100528501 : Decimal;
      IsFirstReservLine@1100528500 : Boolean;
      ErrorFieldCaption@1100409000 : Text[250];
    BEGIN
      //**4PS DP00121
      IF (TempSalesLine."Item No." = '') OR (SalesShptLine.Type <> SalesShptLine.Type::"G/L Account") THEN
        EXIT;

      IF NOT Item.GET(TempSalesLine."Item No.") THEN
        EXIT;

      IF Item."Item Tracking Code" = '' THEN
        EXIT;

      IF SalesHeader.Receive THEN
        ErrorFieldCaption := SalesLine.FIELDCAPTION("Qty. to Ship")
      ELSE
        ErrorFieldCaption := SalesLine.FIELDCAPTION("Return Qty. to Receive");

      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      IF SalesShptLine."Order No." <> '' THEN BEGIN
        NSReservationEntry.SETRANGE("Source ID", SalesShptLine."Order No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", SalesShptLine."Order Line No.");
      END ELSE BEGIN
        NSReservationEntry.SETRANGE("Source ID", SalesHeader."No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", SalesLine."Line No.");
      END;
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Sales Line");
      NSReservationEntry.SETRANGE("Source Subtype", SalesHeader."Document Type"); //T003526

      //T003526
      IF TempSalesLine."Cost Plus Line No." <> 0 THEN BEGIN
        NSReservationEntry.DELETEALL;
        EXIT;
      END;
      //

      IF NSReservationEntry.FINDSET(TRUE) THEN BEGIN
        IsFirstReservLine := TRUE;
        REPEAT
          IF (NSReservationEntry."Qty. to Handle (Base)" <> 0) AND
             ((NSReservationEntry."Serial No." <> '') OR (NSReservationEntry."Lot No." <> '')) THEN
          BEGIN
            NSItemTrackingCheck.CheckLine(
              NSReservationEntry, 0, SalesHeader."Document Date",
              -SalesShptLine."Quantity (Base)",IsFirstReservLine,
              ErrorFieldCaption);
            PostNSItemTrackingEntry(NSReservationEntry,SalesShptLine);
            QuantityProcessed += NSReservationEntry."Qty. to Handle (Base)";
            IsFirstReservLine := FALSE;
            //T000815
            IF SalesHeader.Invoice THEN
              NSReservationEntry.MODIFY
            ELSE
            //
              NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
      END;

      IF ABS(QuantityProcessed) <> ABS(SalesShptLine."Quantity (Base)") THEN
        ERROR(STRSUBSTNO(Text046,SalesShptLine.FIELDCAPTION("Quantity (Base)"),TempSalesLine."Item No."));
    END;

    PROCEDURE PostNSItemTrackingEntry@1100528603(VAR NSReservationEntry@1100528600 : Record 11071900;VAR SalesShptLine@1100525000 : Record 111);
    VAR
      NSTrackingSpecification@1100528601 : Record 11071901;
      NSItemTrackingEntry@1100528604 : Record 11071902;
      NSItemTrackingEntryRelation@1100528603 : Record 11071903;
      NSItemApplnEntry@1100528606 : Record 11071904;
      EntryNo@1100528602 : Integer;
    BEGIN
      //**4PS DP00121
      WITH NSItemTrackingEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "Item No." := TempSalesLine."Item No.";
        "Posting Date" := SalesHeader."Posting Date";
        "Entry Type" := "Entry Type"::Sale;
        "Location Code" := SalesShptLine."Location Code";
        "Document Type" := "Document Type"::"Sales Shipment";
        "Document No." := SalesShptLine."Document No.";
        "Document Line No." := SalesShptLine."Line No.";
        "Variant Code" := SalesShptLine."Variant Code";
        Open := TRUE;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        "Warranty Date Vendor" := NSReservationEntry."Warranty Date Vendor";
        "Warranty Code Vendor" := NSReservationEntry."Warranty Code Vendor";
        "Warranty Start Date Vendor" := NSReservationEntry."Warranty Start Date Vendor";
        "Warranty Period Vendor" := NSReservationEntry."Warranty Period Vendor";
        "Warranty Code Customer" := NSReservationEntry."Warranty Code Customer";
        "Warranty Start Date Customer" := NSReservationEntry."Warranty Start Date Customer";
        "Warranty Period Customer" := NSReservationEntry."Warranty Period Customer";
        "Warranty Date Customer" := NSReservationEntry."Warranty Date Customer";
        "Good Customs":= NSReservationEntry."Good Customs";
        "Shipment with T1" := NSReservationEntry."Shipment with T1";
        "Customs Destination Code" := NSReservationEntry."Customs Destination Code";
        "Expiration Date" := NSReservationEntry."Expiration Date";
        Quantity := NSReservationEntry."Qty. to Handle (Base)";
        "Remaining Quantity" := Quantity;
        Positive := ("Remaining Quantity" > 0);
        "Item Tracking":= ItemTrackingMgt.ItemTrackingOption(
          NSReservationEntry."Lot No.", NSReservationEntry."Serial No.");
        "Source Type":= "Source Type"::Customer;
        "Source No.":= SalesHeader."Sell-to Customer No.";
        "Project No." := SalesShptLine."Job No.";
        "Service Order No." := TempSalesLine."Service Order No.";

        //apply before insert cause applying data is added to NSItemTrackingEntry
        NSItemTrackingEntriesApply.ApplyNSItemTrackingEntry(NSItemTrackingEntry, Item."Item Tracking Code");
        INSERT;
      END;

      WITH NSTrackingSpecification DO BEGIN
        INIT;
        TRANSFERFIELDS(NSReservationEntry);
        "Entry No." := EntryNo;
        "Quantity Handled (Base)" := NSReservationEntry."Qty. to Handle (Base)";
        "Qty. to Handle (Base)" := 0;
        INSERT;
      END;

      WITH NSItemTrackingEntryRelation DO BEGIN
        INIT;
        "Item Tracking Entry No." := EntryNo;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        TransferFieldsSalesShptLine(SalesShptLine);
        INSERT;
      END;

      IF SalesHeader.Invoice AND (NSReservationEntry."Item Ledger Entry No." = 0) THEN
        NSReservationEntry."Item Ledger Entry No." := EntryNo; //T000815

      //Application
      IF NSItemTrackingEntry.Positive THEN
        EXIT;

      WITH NSItemApplnEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "NS Item Tracking Entry No." := NSItemTrackingEntry."Entry No.";
        "Inbound Item Entry No." := 0;
        "Outbound Item Entry No." := NSItemTrackingEntry."Entry No.";
        Quantity := NSItemTrackingEntry.Quantity;
        "Posting Date" := NSItemTrackingEntry."Posting Date";
        "Creation Date" := CURRENTDATETIME;
        "Created By" := USERID;
        INSERT;
      END;
    END;

    PROCEDURE InsertNSItemTrackingRelation@1100528500(SalesLine@1100528501 : Record 37;RowID@1100528503 : Text[100]);
    VAR
      NSReservationEntry@1100528502 : Record 11071900;
      NSItemTrackingRelation@1100528504 : Record 11071905;
    BEGIN
      //**4PS DP00121
      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      NSReservationEntry.SETRANGE("Source ID", SalesLine."Document No.");
      NSReservationEntry.SETRANGE("Source Ref. No.", SalesLine."Line No.");
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Sales Line");
      NSReservationEntry.SETRANGE("Source Subtype", SalesLine."Document Type");
      IF NSReservationEntry.FINDSET(TRUE) THEN
        REPEAT
          IF NSReservationEntry."Item Ledger Entry No." <> 0 THEN BEGIN
            NSItemTrackingRelation."Item Tracking Entry No." := NSReservationEntry."Item Ledger Entry No.";
            NSItemTrackingRelation."Source RowId" := RowID;
            NSItemTrackingRelation."Project Ledger Entry No." := JobLedgEntryNo;
            NSItemTrackingRelation."Service Ledger Entry No." := ServLedgEntryNo;
            NSItemTrackingRelation.INSERT;
            NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
    END;

    LOCAL PROCEDURE AdditionalCheckOnQtyOk@1100409000(SalesLine2@1100528401 : Record 37;CheckQtyToShip@1100528400 : Boolean) : Boolean;
    VAR
      AttachedToSalesLine@1100409000 : Record 37;
    BEGIN
      //**4PS C015652
      IF CheckQtyToShip THEN BEGIN
        IF (SalesLine2."Qty. to Ship" <> 0) OR
           (SalesLine2."Return Qty. to Receive" <> 0) //C019971.n
        THEN
          EXIT(TRUE);
      END ELSE
        IF SalesLine2."Qty. to Invoice" <> 0 THEN
          EXIT(TRUE);

      IF SalesLine2.Type = SalesLine2.Type::" " THEN
        IF SalesLine2."Attached to Line No." > 0  THEN BEGIN
          AttachedToSalesLine.GET(SalesLine2."Document Type",SalesLine2."Document No.",SalesLine2."Attached to Line No." );
          IF AttachedToSalesLine.Type = AttachedToSalesLine.Type::" " THEN
            EXIT(TRUE);
          IF CheckQtyToShip THEN BEGIN
            IF (AttachedToSalesLine."Qty. to Ship" <> 0) OR
               (AttachedToSalesLine."Return Qty. to Receive" <> 0) //C019971.n
            THEN
              EXIT(TRUE);
          END ELSE
            IF AttachedToSalesLine."Qty. to Invoice" <> 0 THEN
              EXIT(TRUE);
        //C019732.sn
        END ELSE
          EXIT(TRUE);
        //C019732.en

      EXIT(FALSE);
    END;

    LOCAL PROCEDURE FillSalesCrMemoHeadReturnOrder@1100525018(VAR SalesCrMemoHead@1100525000 : Record 114;SalesHead@1100525001 : Record 36);
    VAR
      SalesLine@1100525002 : Record 37;
      ReturnReceiptHead@1100525003 : Record 6660;
    BEGIN
      //**4PS C016332
      IF SalesCrMemoHead."Return Order No." <> '' THEN
        EXIT;
      IF SalesHead."Document Type" <> SalesHeader."Document Type"::"Credit Memo" THEN
        EXIT;

      SalesLine.SETRANGE("Document Type", SalesHead."Document Type");
      SalesLine.SETRANGE("Document No.", SalesHead."No.");
      SalesLine.SETFILTER("Return Receipt No.", '<>%1', '');
      IF NOT SalesLine.FINDFIRST THEN
        EXIT;

      IF NOT ReturnReceiptHead.GET(SalesLine."Return Receipt No.") THEN
        EXIT;

      IF ReturnReceiptHead."Return Order No." <> '' THEN BEGIN
        SalesCrMemoHead."Return Order No." := ReturnReceiptHead."Return Order No.";
        SalesCrMemoHead."Return Order No. Series" := ReturnReceiptHead."Return Order No. Series";
      END;
    END;

    LOCAL PROCEDURE HasToSplitContractRevenue@1100528600(IServiceJournalLine@1100528600 : Record 11012820) : Boolean;
    VAR
      ServiceContract@1100528601 : Record 11012812;
      ContractInstallment@1100528602 : Record 11071707;
    BEGIN
      IF (IServiceJournalLine."Service Contract No." = '') OR (IServiceJournalLine."Installment Line No." = 0) THEN
        EXIT(FALSE);
      IF NOT ServiceContract.GET(IServiceJournalLine."Service Contract No.") THEN
        EXIT(FALSE);
      IF NOT ContractInstallment.GET(IServiceJournalLine."Service Contract No.", IServiceJournalLine."Installment Line No.") THEN
        EXIT(FALSE);
      IF FORMAT(ServiceContract."Control Period Interval") = '' THEN
        EXIT(FALSE);
      IF FORMAT(ContractInstallment."Invoice Interval") = '' THEN
        EXIT(FALSE);
      IF CALCDATE(ServiceContract."Control Period Interval", TODAY) < CALCDATE(ContractInstallment."Invoice Interval", TODAY) THEN
        EXIT(TRUE);
    END;

    BEGIN
    {
      4PS05 JD 29-10-2008, Improvements for intrastat
      4PS06 HBK 25-06-2009, Added differentation in "Fixed Price Revenues Account" (PostComplRevenueFixedPriceServ)
      4PS07 JD 25-01-2010 Documentmanagement changes
    }
    END.
  }
}

