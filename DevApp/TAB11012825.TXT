OBJECT Table 11012825 Service Order Cost Plus Entry
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS9.00,4PSSE;
  }
  PROPERTIES
  {
    Permissions=TableData 11012015=r,
                TableData 11012819=r;
    OnInsert=VAR
               CostPlusRec@1100525000 : Record 11012825;
               LastLino@1100525001 : Integer;
             BEGIN
               "Creation Date" := TODAY;
               "Last Date Modified" := 0D;
               IF "Posting Date" = 0D THEN
                 "Posting Date" := WORKDATE;  //db, 08-01-10: M17743
               "Entry No. Service Ledger" := 0;
               Invoiced := FALSE;
               "Source Document" := '';
               "Source Line" := 0;
               InitCreatedByFields();

               //mg.sn, 16-12-10: M19900, also workaround for auto-splitkey in F11012837 within F11125118
               IF ("Line No." = 0) OR CostPlusRec.GET("Service Order No.", "Line No.") THEN BEGIN
                 CostPlusRec.RESET;
                 CostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
                 IF CostPlusRec.FINDLAST THEN
                   LastLino := CostPlusRec."Line No."
                 ELSE
                   LastLino := 0;
                 "Line No." := LastLino + 10000;
               END;
               //mg.en, 16-12-10: M19900

               DetermineChargeable;
               GetServOrder(TRUE);
               VALIDATE("Cost Component");
               ServOrderRec.CheckStatus(1);
               IF "Object No." = '' THEN
                 DetermineObjectNo;

               "Collective List No." := ServOrderRec."Collective List No.";
               ReopenCollectiveList;
               MarkCollectiveListForRecalc;
             END;

    OnModify=BEGIN
               TESTFIELD(Invoiced,FALSE);
               CheckInstallmentScheme(1);
               "Last Date Modified" := TODAY;
               GetServOrder(FALSE);
               ServOrderRec.CheckStatus(1);
               ReopenCollectiveList;
               MarkCollectiveListForRecalc;
             END;

    OnDelete=BEGIN
               TESTFIELD(Invoiced,FALSE);
               CheckInstallmentScheme(2);
               CheckSourceDocument;
               CheckRemovalContribution;  //db, 22-10-09: M16544
               MarkCollectiveListForRecalc;
               ResetSUPProductionLine;
               CheckExtraCostLine(2);
             END;

    OnRename=BEGIN
               TESTFIELD(Invoiced,FALSE);
               "Last Date Modified" := TODAY;
             END;

    CaptionML=ENU=Service Order Cost Plus Entry;
    LookupPageID=Page11126293;
    DrillDownPageID=Page11126293;
  }
  FIELDS
  {
    { 10  ;   ;Service Order No.   ;Code20        ;TableRelation="Service Order";
                                                   OnValidate=BEGIN
                                                                IF "Service Order No." <> '' THEN BEGIN //mg, 31-05-11
                                                                  ServOrderRec.GET("Service Order No.");
                                                                  VALIDATE("Customer No.", ServOrderRec."Customer No.");
                                                                  VALIDATE("Bill-to Customer No.", ServOrderRec."Bill-to Customer No.");
                                                                  "Service Location No." := ServOrderRec."Service Location No.";
                                                                  "Base Service Order No." := ServOrderRec."Base Service Order No.";
                                                                END;
                                                                //GetBasicPrice; //Not here, Copy Paste will result in new basic price
                                                              END;

                                                   CaptionML=ENU=Service Order No. }
    { 20  ;   ;Customer No.        ;Code20        ;TableRelation=Customer;
                                                   OnValidate=BEGIN
                                                                //GetBasicPrice; //Not here, Copy Paste will result in new basic price
                                                              END;

                                                   CaptionML=ENU=Customer No.;
                                                   Editable=No }
    { 30  ;   ;Bill-to Customer No.;Code20        ;FieldClass=Normal;
                                                   TableRelation=Customer;
                                                   CaptionML=ENU=Bill-to Customer No.;
                                                   Editable=No }
    { 40  ;   ;Line No.            ;Integer       ;CaptionML=ENU=Line No. }
    { 50  ;   ;Cost Object         ;Code20        ;TableRelation=IF (Installment Scheme=FILTER('')) "Dimension Value".Code WHERE (Cost Type=FILTER(<>Revenue),
                                                                                                                                  Global Dimension No.=CONST(2))
                                                                                                                                  ELSE IF (Installment Scheme=FILTER(<>'')) "Dimension Value".Code WHERE (Cost Type=FILTER(Revenue),
                                                                                                                                                                                                          Global Dimension No.=CONST(2));
                                                   OnValidate=BEGIN
                                                                CALCFIELDS("Cost Type");

                                                                SkipGetCostObjectDesc := TRUE;  //*31430.n
                                                                IF TransferCostObjectData() THEN BEGIN
                                                                  SkipGetCostObjectDesc := FALSE;  //*31430.n
                                                                  GetDescription;
                                                                  "Unit of Measure" := DimValRec."Unit of Measure";
                                                                  VALIDATE("Cost Component", DimValRec."Cost Component");

                                                                  IF ("Cost Object" <> '') AND
                                                                     ("Cost Type" = "Cost Type"::Labor) AND
                                                                     (DimValRec."Wage Component" <> '') AND
                                                                     ("Wage Component" <> DimValRec."Wage Component") THEN
                                                                    VALIDATE("Wage Component", DimValRec."Wage Component");
                                                                END;

                                                                IF "Cost Type" <> "Cost Type"::Labor THEN BEGIN
                                                                  "Hour Rate Code" := '';
                                                                  "Employee No." := '';
                                                                  "Wage Component" := '';
                                                                  CALCFIELDS("Social Security No.");
                                                                  "From Date" := 0D;
                                                                  "To Date" := 0D;
                                                                END;
                                                                GetBasicPrice;
                                                                CheckAdditionalCostService;  //db, 24-02-10
                                                                "VAT Prod. Posting Group" := UpdateVatProdPostingGrp;  //RFC 547

                                                                //mg.sn, 10-05-11: M27128
                                                                IF "Cost Object" <> xRec."Cost Object" THEN
                                                                  IF "Item No." + "Basic Item" + "Trade Item" = '' THEN
                                                                    IF "Installment Scheme" = '' THEN
                                                                      GetDiscountPerc();
                                                                //mg.en, 10-05-11: M27128
                                                              END;

                                                   CaptionML=ENU=Cost Object }
    { 55  ;   ;Cost Type           ;Option        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Dimension Value"."Cost Type" WHERE (Code=FIELD(Cost Object),
                                                                                                           Global Dimension No.=CONST(2)));
                                                   CaptionML=ENU=Cost Type;
                                                   OptionCaptionML=ENU=Labor,Material,Subcontracting,Plant,Sundry,Revenue;
                                                   OptionString=Labor,Material,Subcontracting,Plant,Sundry,Revenue;
                                                   Editable=No }
    { 60  ;   ;Description         ;Text50        ;CaptionML=ENU=Description }
    { 65  ;   ;Description 2       ;Text50        ;CaptionML=ENU=Description 2 }
    { 70  ;   ;Wage Component      ;Code10        ;TableRelation="Wage Component".Code WHERE (Component Type=FILTER(Hours|Expenses));
                                                   OnValidate=BEGIN
                                                                GetBasicPrice;

                                                                IF ("Wage Component" <> xRec."Wage Component") THEN
                                                                  GetDescription;
                                                              END;

                                                   CaptionML=ENU=Wage Component }
    { 75  ;   ;Description Wage Component;Text30  ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Wage Component".Description WHERE (Code=FIELD(Wage Component)));
                                                   CaptionML=ENU=Description Wage Component;
                                                   Editable=No }
    { 80  ;   ;Quantity            ;Decimal       ;OnValidate=BEGIN
                                                                IF CheckItemLine THEN BEGIN
                                                                  ServOrderRec.GET("Service Order No.");  //db, 16-06-10: M19385
                                                                  IF NOT ServContractRec.GET("Service Contract No.") THEN ServContractRec.INIT;  //db, 16-06-10: M19385
                                                                  IF UPPERCASE(ValidateCu.GetBaseUnit("Item No.", "Basic Item", "Trade Item", Manufacturer, "Vendor (Trade Item)")) =
                                                                    "Unit of Measure" THEN  //db, 20-12-10: M23993 //mg.c, 15-03-12: M33991
                                                                    FindSalesPrice;  //db, 28-12-09: M16871
                                                                END;

                                                                GetDiscountPerc;
                                                                VALIDATE("Discount % (ServOrder)");
                                                                UpdateAttachedLine;  //C024476
                                                              END;

                                                   CaptionML=ENU=Quantity;
                                                   DecimalPlaces=0:5;
                                                   BlankZero=Yes }
    { 90  ;   ;Unit of Measure     ;Code10        ;TableRelation="Unit of Measure";
                                                   OnValidate=BEGIN
                                                                CALCFIELDS("Cost Type");
                                                                //IF CurrFieldNo = FIELDNO("Unit of Measure") THEN
                                                                //db, 24-08-04: conversion required at import service entries if calc.method based on gross price
                                                                  IF ("Cost Type" = "Cost Type"::Material) THEN
                                                                    IF "Unit of Measure" <>  xRec."Unit of Measure" THEN
                                                                      CheckItemUnitConversion(Rec, xRec);
                                                              END;

                                                   OnLookup=BEGIN
                                                              HandleLookupUnit;
                                                            END;

                                                   CaptionML=ENU=Unit of Measure }
    { 95  ;   ;Hour Rate Code      ;Code10        ;TableRelation="Hour Rate".Code WHERE (Project Filter=FILTER(''),
                                                                                         Principal Filter=FIELD(Customer No.),
                                                                                         Service Contract Filter=FIELD(Service Contract No.));
                                                   OnValidate=BEGIN
                                                                IF ("Hour Rate Code" <> xRec."Hour Rate Code") OR
                                                                   ("Service Order No." <> xRec."Service Order No.") OR
                                                                   ("Bill-to Customer No." <> xRec."Bill-to Customer No.")
                                                                THEN BEGIN
                                                                  GetDescription;
                                                                  GetBasicPrice;
                                                                END;

                                                                GetCostPrice;
                                                              END;

                                                   CaptionML=ENU=Hour Rate Code }
    { 98  ;   ;Currency Code       ;Code10        ;TableRelation=Currency;
                                                   CaptionML=ENU=Currency Code }
    { 99  ;   ;Currency Code Costs ;Code10        ;TableRelation=Currency;
                                                   CaptionML=ENU=Currency Code Costs;
                                                   Editable=No }
    { 100 ;   ;Basic Price (LCY)   ;Decimal       ;OnValidate=BEGIN
                                                                IF CurrFieldNo = FIELDNO("Basic Price (LCY)") THEN
                                                                  "Basic Price Found at" := Text009;

                                                                IF NOT CheckItemLine THEN
                                                                  IF CurrFieldNo <> FIELDNO("Gross Price (LCY)") THEN
                                                                //  IF (ROUND("Gross Price (LCY)" * (100 - "Sales Discount % (Item)")/100)) <> ROUND("Basic Price (LCY)") THEN
                                                                    IF ROUND("Gross Price (LCY)" * (100 - "Sales Discount % (Item)")/100 - "Basic Price (LCY)" ) <> 0 THEN //call C001248
                                                                      VALIDATE("Gross Price (LCY)", "Basic Price (LCY)"/((100 - "Sales Discount % (Item)")/100));

                                                                IF "Basic Price (LCY)" <> xRec."Basic Price (LCY)" THEN
                                                                  VALIDATE("Surcharge %", GetSurcharge)
                                                                ELSE
                                                                  VALIDATE("Surcharge %");

                                                                //VALIDATE("Discount % (ServOrder)");
                                                                GetDiscountPerc; //mg, 19-12-12: C003293
                                                                GetSalesDiscount;  //db, 09-07-09
                                                                CalculateBasicPriceFromLCY; // dp00116.n
                                                              END;

                                                   CaptionML=ENU=Basic Price (LCY);
                                                   BlankZero=Yes;
                                                   Description=former field Unit Cost;
                                                   AutoFormatType=2 }
    { 102 ;   ;Basic Price         ;Decimal       ;OnValidate=VAR
                                                                CurrencyDate@1100528802 : Date;
                                                                CurrencyExchangeRate@1100528801 : Record 330;
                                                                Currency2@1100528800 : Record 4;
                                                              BEGIN
                                                                // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Basic Price") THEN BEGIN
                                                                  Currency2.InitRoundingPrecision;
                                                                  IF "Currency Code" <> '' THEN BEGIN
                                                                    CurrencyDate := "Posting Date";
                                                                    "Basic Price (LCY)" :=
                                                                    ROUND(
                                                                      CurrencyExchangeRate.ExchangeAmtFCYToLCY(
                                                                        0, '', CurrencyDate, "Currency Code", "Basic Price",
                                                                         CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
                                                                         Currency2."Unit-Amount Rounding Precision");
                                                                  END ELSE BEGIN
                                                                    "Basic Price (LCY)" := ROUND("Basic Price",Currency2."Unit-Amount Rounding Precision");
                                                                  END;
                                                                  VALIDATE("Basic Price (LCY)");  //db, 30-08-12: validate surcharge/discount; calculate line amount
                                                                  "Basic Price Found at" := Text009;  //db, 30-08-12
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Basic Price;
                                                   BlankZero=Yes;
                                                   Description=former field Unit Cost;
                                                   AutoFormatType=2 }
    { 105 ;   ;Cost Price (LCY)    ;Decimal       ;OnValidate=BEGIN
                                                                GetPurchaseDiscount;  //db, 09-07-09
                                                                CalculateCostPriceFromLCY;  // dp00116.n
                                                              END;

                                                   CaptionML=ENU=Cost Price (LCY);
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=2 }
    { 107 ;   ;Cost Price          ;Decimal       ;OnValidate=VAR
                                                                CurrencyDate@1100528802 : Date;
                                                                CurrencyExchangeRate@1100528801 : Record 330;
                                                                Currency2@1100528800 : Record 4;
                                                              BEGIN
                                                                // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Cost Price") THEN BEGIN
                                                                  Currency2.InitRoundingPrecision;
                                                                  IF "Currency Code Costs" <> '' THEN BEGIN
                                                                    CurrencyDate := "Posting Date";
                                                                    "Cost Price (LCY)" :=
                                                                    ROUND(
                                                                      CurrencyExchangeRate.ExchangeAmtFCYToLCY(
                                                                        0, '', CurrencyDate, "Currency Code Costs", "Cost Price",
                                                                         CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code Costs",FALSE),FALSE),
                                                                         Currency2."Unit-Amount Rounding Precision");
                                                                  END ELSE BEGIN
                                                                    "Cost Price (LCY)" := ROUND("Cost Price",Currency2."Unit-Amount Rounding Precision");
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Cost Price;
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=2 }
    { 110 ;   ;Surcharge %         ;Decimal       ;OnValidate=BEGIN
                                                                "Sales Price (LCY)" := "Basic Price (LCY)" * (1 + "Surcharge %"/100);
                                                                "Sales Price (LCY)" := ROUND("Sales Price (LCY)", GetRoundingFactor(RoundOption::Price));  //db, 17-02-14: C012946
                                                                CalculateSalesPriceFromLCY; // dp00116.n
                                                                VALIDATE("Surcharge Amount");  //db, 08-10-08: M10359
                                                                //VALIDATE("Discount % (ServOrder)");
                                                                GetDiscountPerc; //mg, 19-12-12: C003293
                                                              END;

                                                   CaptionML=ENU=Surcharge %;
                                                   BlankZero=Yes }
    { 115 ;   ;Surcharge Amount    ;Decimal       ;OnValidate=BEGIN
                                                                //db, 08-10-08: M10359
                                                                IF CurrFieldNo = FIELDNO("Surcharge Amount") THEN BEGIN
                                                                  IF "Basic Price (LCY)" <> 0 THEN BEGIN
                                                                    "Sales Price (LCY)" := "Basic Price (LCY)" + "Surcharge Amount";
                                                                    CalculateSalesPriceFromLCY; // dp00116.n
                                                                    "Surcharge %" := ("Sales Price (LCY)"/"Basic Price (LCY)" -1) * 100;
                                                                  END ELSE BEGIN
                                                                    "Surcharge %" := 0;
                                                                  END;
                                                                END ELSE BEGIN
                                                                  "Surcharge Amount" := "Sales Price (LCY)" - "Basic Price (LCY)";
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Surcharge Amount;
                                                   BlankZero=Yes }
    { 120 ;   ;Sales Price (LCY)   ;Decimal       ;OnValidate=BEGIN
                                                                IF (CurrFieldNo = FIELDNO("Sales Price (LCY)")) OR
                                                                   (CurrFieldNo = FIELDNO("Sales Price")) THEN BEGIN //db, 21-11-12: C003981
                                                                  IF "Basic Price (LCY)" <> 0 THEN
                                                                    "Surcharge %" := ("Sales Price (LCY)"/"Basic Price (LCY)" -1) * 100
                                                                  ELSE
                                                                    "Surcharge %" := 0;
                                                                  VALIDATE("Surcharge Amount");  //db, 08-10-08: M10359
                                                                END;

                                                                VALIDATE("Discount % (ServOrder)");

                                                                IF CurrFieldNo <> FIELDNO("Sales Price") THEN  //db, 21-11-12: C003981
                                                                  CalculateSalesPriceFromLCY; // dp00116.n
                                                              END;

                                                   CaptionML=ENU=Sales Price (LCY);
                                                   BlankZero=Yes;
                                                   AutoFormatType=2 }
    { 122 ;   ;Sales Price         ;Decimal       ;OnValidate=VAR
                                                                CurrencyDate@1100528802 : Date;
                                                                CurrencyExchangeRate@1100528801 : Record 330;
                                                                Currency2@1100528800 : Record 4;
                                                              BEGIN
                                                                // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Sales Price") THEN BEGIN
                                                                  Currency2.InitRoundingPrecision;
                                                                  IF "Currency Code" <> '' THEN BEGIN
                                                                    CurrencyDate := "Posting Date";
                                                                    "Sales Price (LCY)" :=
                                                                    ROUND(
                                                                      CurrencyExchangeRate.ExchangeAmtFCYToLCY(
                                                                        0, '', CurrencyDate, "Currency Code", "Sales Price",
                                                                         CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
                                                                         Currency2."Unit-Amount Rounding Precision");
                                                                  END ELSE BEGIN
                                                                    "Sales Price (LCY)" := ROUND("Sales Price",Currency2."Unit-Amount Rounding Precision");
                                                                  END;
                                                                  VALIDATE("Sales Price (LCY)");  //db, 21-11-12: C003981
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Sales Price;
                                                   BlankZero=Yes;
                                                   AutoFormatType=2 }
    { 130 ;   ;VAT Prod. Posting Group;Code10     ;TableRelation="VAT Product Posting Group".Code;
                                                   CaptionML=ENU=VAT Prod. Posting Group }
    { 140 ;   ;Posting Date        ;Date          ;FieldClass=Normal;
                                                   OnValidate=BEGIN
                                                                IF "Installment Scheme" = '' THEN BEGIN  //db, 26-08-09: M14136
                                                                  GetBasicPrice;
                                                                  GetDiscountPerc;
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Posting Date }
    { 160 ;   ;Creation Date       ;Date          ;CaptionML=ENU=Creation Date;
                                                   Editable=No }
    { 170 ;   ;Last Date Modified  ;Date          ;CaptionML=ENU=Last Date Modified;
                                                   Editable=No }
    { 180 ;   ;Entry No. Service Ledger;Integer   ;TableRelation="Service-Ledger Entry";
                                                   CaptionML=ENU=Entry No. Service Ledger;
                                                   Editable=No }
    { 190 ;   ;Invoiced            ;Boolean       ;CaptionML=ENU=Invoiced;
                                                   Editable=No }
    { 200 ;   ;Chargeable          ;Boolean       ;OnValidate=BEGIN
                                                                UpdateAttachedLine;  //C024476
                                                              END;

                                                   CaptionML=ENU=Chargeable }
    { 210 ;   ;Invoiced Price (LCY);Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Service-Ledger Entry"."Total Revenue (LCY)" WHERE (Service Order No.=FIELD(Service Order No.),
                                                                                                                       Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Invoiced Price (LCY);
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 212 ;   ;Invoiced Price      ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Service-Ledger Entry"."Total Revenue" WHERE (Service Order No.=FIELD(Service Order No.),
                                                                                                                 Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Invoiced Price;
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 220 ;   ;Invoice in Process (LCY);Decimal   ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Sales Line"."Amount (LCY)" WHERE (Document Type=CONST(Invoice),
                                                                                                      Service Invoice=CONST(Yes),
                                                                                                      Service Order No.=FIELD(Service Order No.),
                                                                                                      Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Invoice in Process (LCY);
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 222 ;   ;Invoice in Process  ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Sales Line".Amount WHERE (Document Type=CONST(Invoice),
                                                                                              Service Invoice=CONST(Yes),
                                                                                              Service Order No.=FIELD(Service Order No.),
                                                                                              Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Invoice in Process;
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 230 ;   ;Credit Memo in Process (LCY);Decimal;
                                                   FieldClass=FlowField;
                                                   CalcFormula=-Sum("Sales Line"."Amount (LCY)" WHERE (Document Type=CONST(Credit Memo),
                                                                                                       Service Invoice=CONST(Yes),
                                                                                                       Service Order No.=FIELD(Service Order No.),
                                                                                                       Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Credit Memo in Process (LCY);
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 232 ;   ;Credit Memo in Process;Decimal     ;FieldClass=FlowField;
                                                   CalcFormula=-Sum("Sales Line".Amount WHERE (Document Type=CONST(Credit Memo),
                                                                                               Service Invoice=CONST(Yes),
                                                                                               Service Order No.=FIELD(Service Order No.),
                                                                                               Cost Plus Line No.=FIELD(Line No.)));
                                                   CaptionML=ENU=Credit Memo in Process;
                                                   BlankZero=Yes;
                                                   Editable=No;
                                                   AutoFormatType=1 }
    { 240 ;   ;Employee No.        ;Code20        ;TableRelation=Employee.No.;
                                                   OnValidate=BEGIN
                                                                GetBasicPrice;
                                                              END;

                                                   CaptionML=ENU=Employee No. }
    { 250 ;   ;Social Security No. ;Text30        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup(Employee."Social Security No." WHERE (No.=FIELD(Employee No.)));
                                                   CaptionML=ENU=Social Security No.;
                                                   Editable=No }
    { 260 ;   ;From Date           ;Date          ;OnValidate=BEGIN
                                                                VALIDATE("To Date");
                                                              END;

                                                   CaptionML=ENU=From Date }
    { 261 ;   ;From Time           ;Time          ;CaptionML=ENU=From Time }
    { 270 ;   ;To Date             ;Date          ;OnValidate=BEGIN
                                                                IF ("To Date" <> 0D) AND ("To Date" < "From Date") THEN
                                                                  FIELDERROR("To Date",STRSUBSTNO(Text000,FIELDCAPTION("From Date")));
                                                              END;

                                                   CaptionML=ENU=To Date }
    { 271 ;   ;To Time             ;Time          ;CaptionML=ENU=To Time }
    { 280 ;   ;Item No.            ;Code20        ;TableRelation=Item;
                                                   OnValidate=BEGIN
                                                                IF ("Item No." <> xRec."Item No.") AND ("Item No." <> '') THEN BEGIN
                                                                  ValidateItem(ItemTypeOpt::Item);
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Item No. }
    { 281 ;   ;Basic Item          ;Code20        ;TableRelation="Basic Item"."Product Code" WHERE (Manufacturer=FIELD(Manufacturer));
                                                   OnValidate=BEGIN
                                                                IF ("Basic Item" <> xRec."Basic Item") AND ("Basic Item" <> '') THEN BEGIN
                                                                  ValidateItem(ItemTypeOpt::"Basic Item");
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Basic Item }
    { 282 ;   ;Trade Item          ;Code20        ;TableRelation="Trade Item"."Item Code" WHERE (Vendor=FIELD("Vendor (Trade Item)"));
                                                   OnValidate=BEGIN
                                                                IF ("Trade Item" <> xRec."Trade Item") AND ("Trade Item" <> '') THEN BEGIN
                                                                  ValidateItem(ItemTypeOpt::"Trade Item");
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Trade Item }
    { 284 ;   ;Vendor (Trade Item) ;Code15        ;TableRelation="ETIM Vendor (Central Mgt)";
                                                   OnValidate=VAR
                                                                TradeItemRec@1100525000 : Record 11012317;
                                                                lvExecValidate@1100485000 : Boolean;
                                                              BEGIN
                                                                IF ("Vendor (Trade Item)" <> xRec."Vendor (Trade Item)") AND ("Vendor (Trade Item)" <> '') THEN BEGIN
                                                                  IF "Basic Item" <> '' THEN BEGIN
                                                                    "Trade Item" := '';
                                                                    lvExecValidate := TRUE;
                                                                  END;
                                                                  IF "Trade Item" <> '' THEN BEGIN
                                                                    VALIDATE("Trade Item");
                                                                    lvExecValidate := TRUE;
                                                                  END;
                                                                  //db.sn, 17-12-10: M18021
                                                                  IF lvExecValidate THEN BEGIN
                                                                    IF TradeItemRec.CheckReplaceVendor(
                                                                      xRec."Vendor (Trade Item)", xRec."Trade Item",
                                                                      "Vendor (Trade Item)", "Trade Item") THEN
                                                                      ValidateItem(ItemTypeOpt::"Trade Item")
                                                                    ELSE
                                                                      ValidateItem(ItemTypeOpt::"Trade Vendor");
                                                                  END;
                                                                  //db.en, 17-12-10: M18021
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Vendor (Trade Item) }
    { 285 ;   ;Manufacturer        ;Code15        ;TableRelation="ETIM Vendor (Central Mgt)";
                                                   CaptionML=ENU=Manufacturer }
    { 290 ;   ;Discount % (ServOrder);Decimal     ;OnValidate=BEGIN
                                                                DetermineChargeable;
                                                                "Invoice Price (LCY)" := Quantity * "Sales Price (LCY)" * (1 - "Discount % (ServOrder)"/100);
                                                                "Invoice Price (LCY)" := ROUND("Invoice Price (LCY)", GetRoundingFactor(RoundOption::Amount));  //db, 17-02-14: C012946
                                                                CalculateInvoicePriceFromLCY; // dp00116.n
                                                              END;

                                                   CaptionML=ENU=Discount % (Service Order);
                                                   MaxValue=100;
                                                   BlankZero=Yes }
    { 291 ;   ;Discount % (Warranty);Decimal      ;CaptionML=ENU=Discount % (Warranty);
                                                   MaxValue=100;
                                                   BlankZero=Yes;
                                                   Editable=No }
    { 292 ;   ;Discount % (ServContr);Decimal     ;CaptionML=ENU=Discount % (Service Contract);
                                                   MaxValue=100;
                                                   BlankZero=Yes;
                                                   Editable=No }
    { 295 ;   ;Warranty Code       ;Code10        ;TableRelation="Service Warranty Discount Term";
                                                   CaptionML=ENU=Warranty Code;
                                                   Editable=No }
    { 300 ;   ;Invoice Price (LCY) ;Decimal       ;OnValidate=BEGIN
                                                                IF "Sales Price (LCY)" <> 0 THEN BEGIN
                                                                  IF Quantity <> 0 THEN
                                                                    "Discount % (ServOrder)" := (("Sales Price (LCY)" - ("Invoice Price (LCY)"/Quantity))/"Sales Price (LCY)") * 100
                                                                  ELSE
                                                                    "Discount % (ServOrder)" := (("Sales Price (LCY)" - "Invoice Price (LCY)")/"Sales Price (LCY)") * 100;
                                                                END ELSE BEGIN
                                                                  IF "Invoice Price (LCY)" <> 0 THEN
                                                                    "Discount % (ServOrder)" := 100
                                                                  ELSE
                                                                    "Discount % (ServOrder)" := 0;
                                                                END;

                                                                CalculateInvoicePriceFromLCY; // dp00116.n
                                                              END;

                                                   CaptionML=ENU=Invoice Price (LCY);
                                                   BlankZero=Yes;
                                                   AutoFormatType=1 }
    { 302 ;   ;Invoice Price       ;Decimal       ;OnValidate=VAR
                                                                CurrencyDate@1100528802 : Date;
                                                                CurrencyExchangeRate@1100528801 : Record 330;
                                                                Currency2@1100528800 : Record 4;
                                                              BEGIN
                                                                // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Invoice Price") THEN BEGIN
                                                                  Currency2.InitRoundingPrecision;
                                                                  IF "Currency Code" <> '' THEN BEGIN
                                                                    CurrencyDate := "Posting Date";
                                                                    "Invoice Price (LCY)" :=
                                                                    ROUND(
                                                                      CurrencyExchangeRate.ExchangeAmtFCYToLCY(
                                                                        0, '', CurrencyDate, "Currency Code", "Invoice Price",
                                                                         CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
                                                                         Currency2."Amount Rounding Precision");  //db, 17-02-14: C012946
                                                                  END ELSE BEGIN
                                                                    "Invoice Price (LCY)" := ROUND("Invoice Price",Currency2."Amount Rounding Precision");  //db, 17-02-14: C012946
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Invoice Price;
                                                   BlankZero=Yes;
                                                   AutoFormatType=1 }
    { 305 ;   ;Service Location No.;Code20        ;TableRelation="Service Location".No.;
                                                   CaptionML=ENU=Service Location No.;
                                                   Editable=No }
    { 320 ;   ;Object No.          ;Code20        ;TableRelation="Standard Object".No.;
                                                   OnValidate=BEGIN
                                                                CheckObject;  //db, 16-02-09
                                                                IF "Object No." <> xRec."Object No." THEN
                                                                  IF "Item No." + "Basic Item" + "Trade Item" = '' THEN
                                                                    IF "Installment Scheme" = '' THEN
                                                                      GetDiscountPerc();
                                                              END;

                                                   OnLookup=BEGIN
                                                              HandleLookupObjectNo();
                                                            END;

                                                   ValidateTableRelation=No;
                                                   TestTableRelation=No;
                                                   CaptionML=ENU=Object No. }
    { 321 ;   ;Object Customer     ;Code20        ;CaptionML=ENU=Object Customer }
    { 325 ;   ;Service Contract No.;Code20        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Service Order"."Service Contract No." WHERE (No.=FIELD(Service Order No.)));
                                                   CaptionML=ENU=Service Contract No.;
                                                   Editable=No }
    { 330 ;   ;Text                ;Text250       ;OnValidate=BEGIN
                                                                "Text Block" := Text <> '';
                                                              END;

                                                   CaptionML=ENU=Text }
    { 331 ;   ;Text Block          ;Boolean       ;CaptionML=ENU=Text Block;
                                                   Editable=No }
    { 340 ;   ;Gross Price (LCY)   ;Decimal       ;OnValidate=BEGIN
                                                                VALIDATE("Purchase Discount % (Item)");
                                                                IF CurrFieldNo <> FIELDNO("Sales Discount % (Item)") THEN
                                                                  VALIDATE("Sales Discount % (Item)");

                                                                CalculateGrossPriceFromLCY; // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Gross Price (LCY)") THEN
                                                                  "Basic Price Found at" := Text009;  //db, 30-08-12

                                                                GetDiscountPerc; //mg, 19-12-12: C003293
                                                              END;

                                                   CaptionML=ENU=Gross Price (LCY);
                                                   BlankZero=Yes;
                                                   AutoFormatType=2 }
    { 342 ;   ;Gross Price         ;Decimal       ;OnValidate=VAR
                                                                CurrencyDate@1100528802 : Date;
                                                                CurrencyExchangeRate@1100528801 : Record 330;
                                                                Currency2@1100528800 : Record 4;
                                                              BEGIN
                                                                // dp00116.n
                                                                IF CurrFieldNo = FIELDNO("Gross Price") THEN BEGIN
                                                                  Currency2.InitRoundingPrecision;
                                                                  IF "Currency Code" <> '' THEN BEGIN
                                                                    CurrencyDate := "Posting Date";
                                                                    "Gross Price (LCY)" :=
                                                                    ROUND(
                                                                      CurrencyExchangeRate.ExchangeAmtFCYToLCY(
                                                                        0, '', CurrencyDate, "Currency Code", "Gross Price",
                                                                         CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
                                                                         Currency2."Unit-Amount Rounding Precision");
                                                                  END ELSE BEGIN
                                                                    "Gross Price (LCY)" := ROUND("Gross Price",Currency2."Unit-Amount Rounding Precision");
                                                                  END;
                                                                  VALIDATE("Gross Price (LCY)");  //db, 30-08-12: validate discount; calculate line amount
                                                                  "Basic Price Found at" := Text009;  //db, 30-08-12
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Gross Price;
                                                   BlankZero=Yes;
                                                   AutoFormatType=2 }
    { 344 ;   ;Purchase Discount % (Item);Decimal ;OnValidate=BEGIN
                                                                IF CheckItemLine OR ("Entry No. Service Ledger" = 0) THEN BEGIN //Call 18326
                                                                  VALIDATE("Cost Price (LCY)", "Gross Price (LCY)" * (100 - "Purchase Discount % (Item)")/100);
                                                                  CalculateCostPriceFromLCY; // dp00116.n
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Purchase Discount % (Item);
                                                   MaxValue=100;
                                                   BlankZero=Yes }
    { 345 ;   ;Sales Discount % (Item);Decimal    ;OnValidate=BEGIN
                                                                IF "Sales Discount % (Item)" <> xRec."Sales Discount % (Item)" THEN
                                                                  VALIDATE("Surcharge %", GetSurcharge);

                                                                VALIDATE("Basic Price (LCY)", "Gross Price (LCY)" * (100 - "Sales Discount % (Item)")/100);
                                                                CalculateBasicPriceFromLCY; // dp00116.n

                                                                //>> 160621 ITERO.AC RFC082 Added Check for Sales discount or Existing text = ''
                                                                IF CheckItemLine THEN BEGIN
                                                                  IF ("Sales Discount % (Item)" <> 0) OR ("Basic Price Found at" = '') THEN
                                                                    "Basic Price Found at" := Text010;
                                                                END ELSE BEGIN
                                                                  "Basic Price Found at" := Text009;
                                                                END;
                                                                //<< 160621 ITERO.AC RFC082
                                                              END;

                                                   CaptionML=ENU=Sales Discount % (Item);
                                                   MaxValue=100;
                                                   BlankZero=Yes }
    { 349 ;   ;Sales Condition Present;Boolean    ;CaptionML=ENU=Sales Condition Present;
                                                   Description=C015604;
                                                   Editable=No }
    { 350 ;   ;Installment Scheme  ;Code10        ;TableRelation="Installment Scheme".Code WHERE (Type=CONST(Service Order));
                                                   OnValidate=BEGIN
                                                                IF "Installment Scheme" <> '' THEN BEGIN
                                                                  ServOrderRec.GET("Service Order No.");
                                                                  TESTFIELD("Installment Scheme", ServOrderRec."Installment Scheme");
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Installment Scheme }
    { 355 ;   ;Installment No.     ;Code10        ;TableRelation=Installment."Installment No." WHERE (Scheme=FIELD(Installment Scheme));
                                                   CaptionML=ENU=Installment No.;
                                                   SQL Data Type=Integer;
                                                   NotBlank=Yes;
                                                   Numeric=Yes }
    { 360 ;   ;Source Document     ;Code20        ;CaptionML=ENU=Source Document;
                                                   Editable=No }
    { 361 ;   ;Source Line         ;Integer       ;CaptionML=ENU=Source Line;
                                                   Editable=No }
    { 370 ;   ;Additional Cost     ;Boolean       ;OnValidate=BEGIN
                                                                ValidateAdditionalCost;
                                                              END;

                                                   CaptionML=ENU=Additional Cost }
    { 375 ;   ;Extra Cost          ;Boolean       ;CaptionML=ENU=Extra Cost }
    { 380 ;   ;Cost Component      ;Code20        ;TableRelation="Cost Component".Code;
                                                   OnValidate=VAR
                                                                lvCostCompRec@1100485002 : Record 11012012;
                                                              BEGIN
                                                                ValidateCostComponent;
                                                                IF CurrFieldNo <> FIELDNO("Cost Component") THEN BEGIN
                                                                  lvCostCompRec.CheckDefaultCostComponent("Service Order No.", "Cost Component", '', "Cost Type",
                                                                    "Additional Cost");  //db, 24-02-10
                                                                END;
                                                                IF ("Cost Component" <> xRec."Cost Component") THEN
                                                                  GetDiscountPerc;  //db, 11-03-10
                                                              END;

                                                   CaptionML=ENU=Cost Component;
                                                   NotBlank=Yes }
    { 390 ;   ;Sales Surcharge Overtime %;Decimal ;CaptionML=ENU=Sales Surcharge Overtime %;
                                                   BlankZero=Yes;
                                                   AutoFormatType=2 }
    { 400 ;   ;Removal Contribution;Boolean       ;CaptionML=ENU=Removal Contribution }
    { 410 ;   ;Basic Price Found at;Text250       ;CaptionML=ENU=Basic Price Found at;
                                                   Editable=No }
    { 430 ;   ;Attached to Line No. (RC);Integer  ;TableRelation="Service Order Cost Plus Entry"."Line No." WHERE (Service Order No.=FIELD(Service Order No.));
                                                   CaptionML=ENU=Attached to Line No. (Removal Contribution);
                                                   Editable=No }
    { 440 ;   ;Base Service Order No.;Code20      ;TableRelation="Service Order".No.;
                                                   CaptionML=ENU=Base Service Order No.;
                                                   Editable=No }
    { 450 ;   ;Checked             ;Boolean       ;CaptionML=ENU=Checked }
    { 700 ;   ;Serial No.          ;Code40        ;CaptionML=ENU=Serial No.;
                                                   Description=DP00121 }
    { 710 ;   ;Lot No.             ;Code20        ;CaptionML=ENU=Lot No.;
                                                   Description=DP00121 }
    { 1200;   ;Glazing Service Call No.;Code20    ;TableRelation="Glazing Service Call";
                                                   CaptionML=ENU=Glazing Service Call No.;
                                                   Description=jhoek.050511;
                                                   Editable=No }
    { 1210;   ;Glazing Service Call Line No.;Integer;
                                                   TableRelation="Glazing Service Call Line"."Line No." WHERE (Glazing Service Call No.=FIELD(Glazing Service Call No.));
                                                   CaptionML=ENU=Glazing Service Call Line No.;
                                                   Description=jhoek.050511;
                                                   Editable=No }
    { 1220;   ;Collective List No. ;Code20        ;TableRelation="Service Collective-List";
                                                   OnValidate=BEGIN
                                                                IF CurrFieldNo <> 0 THEN
                                                                  TESTFIELD(Invoiced, FALSE);
                                                                CheckCollectiveList;
                                                              END;

                                                   OnLookup=BEGIN
                                                              HandleLookupCollectiveListNo();
                                                            END;

                                                   CaptionML=ENU=Collective List No. }
    { 1230;   ;FSA-Created Entry   ;Boolean       ;CaptionML=ENU=FSA-Created Entry;
                                                   Editable=No }
    { 1310;   ;Price Book Code     ;Code20        ;CaptionML=ENU=Price Book Code;
                                                   Editable=No }
    { 1320;   ;Unit Price Index Date;Date         ;CaptionML=ENU=Unit Price Index Date;
                                                   Editable=No }
    { 1330;   ;Unit Price Extention;Boolean       ;CaptionML=ENU=Unit Price Extention;
                                                   Editable=No }
    { 1340;   ;Production Recording Date;Date     ;CaptionML=ENU=Production Recording Date;
                                                   Editable=No }
    { 1350;   ;Unit Price Room     ;Code20        ;TableRelation="SUP Room".Code;
                                                   OnLookup=VAR
                                                              ServiceUnitPriceManagement@1100528600 : Codeunit 11012846;
                                                              ServiceLocationType@1100528601 : Code[20];
                                                            BEGIN
                                                              ServiceLocationType := ServiceUnitPriceManagement.GetServiceLocationTypeFromServiceOrder("Service Order No.");
                                                              ServiceUnitPriceManagement.LookupRoom("Customer No.", ServiceLocationType, "Unit Price Room");
                                                            END;

                                                   CaptionML=ENU=Unit Price Room;
                                                   Editable=No }
    { 1360;   ;Unit Price Line Code;Code20        ;OnValidate=VAR
                                                                ServiceUnitPriceLine@1100409000 : Record 11071769;
                                                                ServiceOrderExtension@1100409001 : Record 11071727;
                                                              BEGIN
                                                                IF ServiceOrderExtension.GET("Service Order No.") THEN BEGIN
                                                                  ServiceUnitPriceLine.GET(ServiceOrderExtension."Price Book Code", ServiceOrderExtension."Price Book Index Date", "Unit Price Line Code");
                                                                  VALIDATE("Basic Price (LCY)", ServiceUnitPriceLine."Unit Price");
                                                                  "Cost Object" := ServiceUnitPriceLine."Cost Object";
                                                                  "Unit Price Line Code" := ServiceUnitPriceLine.Code;
                                                                  "Unit Price Index Date" := ServiceUnitPriceLine."Index Date";
                                                                  Description := ServiceUnitPriceLine.Description;
                                                                  "Unit of Measure" := ServiceUnitPriceLine."Unit of Measure";  //4PSSE, DL, 140204
                                                                END;
                                                              END;

                                                   OnLookup=VAR
                                                              ServiceUnitPriceLine@1100409002 : Record 11071769;
                                                              ServiceOrderExtension@1100409003 : Record 11071727;
                                                            BEGIN
                                                              IF ServiceOrderExtension.GET("Service Order No.") THEN BEGIN
                                                                ServiceUnitPriceLine.SETRANGE("Price Book Code", ServiceOrderExtension."Price Book Code");
                                                                ServiceUnitPriceLine.SETRANGE("Index Date", ServiceOrderExtension."Price Book Index Date");
                                                                IF PAGE.RUNMODAL(0, ServiceUnitPriceLine) = ACTION::LookupOK THEN
                                                                  VALIDATE("Unit Price Line Code", ServiceUnitPriceLine.Code);
                                                              END;
                                                            END;

                                                   CaptionML=ENU=Unit Price Line Code }
    { 1370;   ;Created by Employee No.;Code20     ;TableRelation=IF (Created by Employee Company=FILTER('')) Employee;
                                                   CaptionML=ENU=Created by Employee No.;
                                                   Description=(Mobile);
                                                   Editable=No }
    { 1371;   ;Created by Employee Company;Text30 ;TableRelation=Company;
                                                   CaptionML=ENU=Created by Employee Company;
                                                   Description=Mobile;
                                                   Editable=No }
    { 1372;   ;Created by Work Order No.;Code20   ;TableRelation="Work Order";
                                                   CaptionML=ENU=Created by Work Order No.;
                                                   Description=Mobile;
                                                   Editable=No }
    { 1380;   ;Production Seq. No. ;Integer       ;TableRelation="SUP Production"."Seq. No." WHERE (Service Order No.=FIELD(Service Order No.));
                                                   CaptionML=ENU=Production Seq. No.;
                                                   Editable=No }
    { 1390;   ;Production Line No. ;Integer       ;OnValidate=VAR
                                                                SUPProductionLine@1100409000 : Record 11071774;
                                                              BEGIN
                                                                IF "Production Line No." <> 0 THEN BEGIN
                                                                  IF SUPProductionLine.GET("Service Order No.", "Production Seq. No.", "Production Line No.") THEN BEGIN
                                                                    "Price Book Code" := SUPProductionLine."Price Book Code";
                                                                    "Unit Price Index Date" := SUPProductionLine."Index Date";
                                                                    "Production Recording Date" := SUPProductionLine."Production Date";
                                                                    "Unit Price Room" := SUPProductionLine.Room;
                                                                    VALIDATE("Unit Price Line Code", SUPProductionLine."Unit Price Code");
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=ENU=Production Line No.;
                                                   Editable=No }
    { 1400;   ;Discount Term Level ;Option        ;CaptionML=ENU=Discount Term Level;
                                                   OptionCaptionML=ENU=" ,Line,Base Service Order,Period";
                                                   OptionString=[ ,Line,Base Service Order,Period];
                                                   Editable=No }
    { 1410;   ;Service Package     ;Code10        ;TableRelation="Service Package";
                                                   CaptionML=ENU=Service Package;
                                                   Editable=No }
    { 1420;   ;Discount Term Line No.;Integer     ;TableRelation="Service Contract Discount Term"."Line No." WHERE (Service Contract No.=FIELD(Service Contract No.),
                                                                                                                    Service Package=FIELD(Service Package));
                                                   CaptionML=ENU=Discount Term Line No.;
                                                   Editable=No }
    { 1430;   ;Compression Id      ;Code32        ;CaptionML=ENU=Compression Id;
                                                   Description=code on which lines are compressed;
                                                   Editable=No }
    { 1500;   ;Department Filter   ;Code20        ;FieldClass=FlowFilter;
                                                   TableRelation="Dimension Value".Code WHERE (Global Dimension No.=CONST(1));
                                                   CaptionML=ENU=Department Filter }
    { 11128270;;Price History Found;Boolean       ;CaptionML=ENU=Price History (Customer) Found;
                                                   Description=ITERO }
    { 11128271;;Price History Vendor No.;Code20   ;CaptionML=ENU=Price History (Customer) Vendor No.;
                                                   Description=ITERO }
    { 11128272;;Price History PriceList;Code20    ;CaptionML=ENU=Customer price list;
                                                   Description=ITERO }
    { 11128273;;Total Cost Price (LCY);Decimal    ;CaptionML=ENU=Total Cost Price (LCY);
                                                   Description=ITERO }
    { 11128274;;Cost Price Adjustment;Decimal     ;CaptionML=ENU=Adjustment % (Cost Price);
                                                   Description=ITERO }
  }
  KEYS
  {
    {    ;Service Order No.,Line No.              ;MaintainSIFTIndex=No;
                                                   Clustered=Yes }
    {    ;Service Order No.,Invoiced,Chargeable,Additional Cost;
                                                   MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
    {    ;Base Service Order No.,Service Order No.,Installment Scheme,Posting Date;
                                                   MaintainSIFTIndex=No }
    {    ;Service Order No.,Cost Object,Posting Date;
                                                   MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
    {    ;Entry No. Service Ledger                ;MaintainSIFTIndex=No }
    {    ;Base Service Order No.,Service Order No.,Cost Component,Invoiced,Chargeable;
                                                   MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
    {    ;Base Service Order No.                  ;MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
    {    ;Collective List No.,Base Service Order No.,Service Order No.,Line No.,Invoiced,Chargeable;
                                                   MaintainSIFTIndex=No }
    {    ;Service Order No.,Object No.,Line No.   ;MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
    {    ;Collective List No.,Base Service Order No.,Service Order No.,Created by Work Order No.,Cost Object;
                                                   MaintainSQLIndex=No;
                                                   MaintainSIFTIndex=No }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      Text000@11012009 : TextConst 'ENU=may not before %1';
      Text001@11012010 : TextConst 'ENU=Copy Cost Object Data ?';
      ServOrderRec@1210190002 : Record 11012823;
      ServLocRec@1210190008 : Record 11012801;
      ServContractRec@1210190003 : Record 11012812;
      ServWarrantyRec@1210190005 : Record 11012827;
      ServSetup@1100525003 : Record 11012800;
      GlSetupRec@1210190015 : Record 98;
      EmplRec@1210190021 : Record 5200;
      CustRec@1210190001 : Record 18;
      ItemRec@1210190014 : Record 27;
      DimValRec@1210190019 : Record 349;
      WageCompRec@1100485001 : Record 11012014;
      DimMgt@1210190004 : Codeunit 408;
      ValidateCu@11012007 : Codeunit 11012033;
      SalesPriceMgt@1100485002 : Codeunit 11012036;
      ItemTypeOpt@11012008 : 'Item,Basic Item,Trade Item,Trade Vendor';
      Text005@1210190018 : TextConst 'ENU=Total Installments  %1 differs from Order Amount %2.';
      Text006@1210190020 : TextConst 'ENU=Hours';
      Text007@1100485000 : TextConst 'ENU=Already processed Installment Terms: Invoice Amount %1';
      Text009@1100485003 : TextConst 'ENU=Manually entered Price';
      Text010@1100485004 : TextConst 'ENU=Gross Price - Discount';
      BasicPriceCalcRunning@1100525000 : Boolean;
      ValidateHourRateCode@1100525001 : Boolean;
      CostPriceACY@1100528800 : Decimal;
      CostObjectFixed@1210190007 : Boolean;
      SkipGetCostObjectDesc@1100409000 : Boolean;
      Text011@1100528600 : TextConst 'ENU=not found';
      SkipDetermineChargeable@1100525002 : Boolean;
      RoundOption@1100525004 : 'Price,Amount';
      "-- ITERO --"@1100285000 : Integer;
      UseManualPriceList@1100285001 : Code[20];
      OverruleServiceContractNo@1100528601 : Code[20];
      Text11128001@1100525005 : TextConst 'ENU=Cost Price + Surcharge Customer Price List';
      Text11128002@1100525006 : TextConst 'ENU=Cost Price + Cost Price adjustment';
      Text11128003@1100525007 : TextConst 'ENU=Vendor Gross Price';
      Text11128004@1100525008 : TextConst 'ENU=Sales Price Warehouse Item';
      Text11128005@1100525009 : TextConst 'ENU=Unit Price Warehouse Item';

    PROCEDURE GetServOrder@1210190012(lvInit@1210190000 : Boolean);
    VAR
      SaveFieldNo@1100525000 : Integer;
    BEGIN
      ServOrderRec.GET("Service Order No.");
      "Customer No." := ServOrderRec."Customer No.";
      IF ("Bill-to Customer No." = '') THEN
        "Bill-to Customer No." := ServOrderRec."Bill-to Customer No.";
      "Service Location No." := ServOrderRec."Service Location No.";
      "Currency Code" := ServOrderRec."Currency Code";  // dp00116.n
      IF lvInit = TRUE THEN BEGIN
      //  "VAT Prod. Posting Group" := ServOrderRec."VAT Prod. Posting Group";  //RFC 547 old
        "VAT Prod. Posting Group" := UpdateVatProdPostingGrp;                   //RFC 547
        SaveFieldNo := CurrFieldNo; // C022905.n
        CurrFieldNo := FIELDNO("Service Order No.");  //db, 24-02-10
        xRec."Cost Object" := '';  //db, 17-06-10: M19824 (disable default option Cost Type)
        CheckAdditionalCostService;  //db, 24-02-10
        CurrFieldNo := SaveFieldNo; // C022905.n
      END;
    END;

    PROCEDURE GetSurcharge@1100485017() lvPerc : Decimal;
    VAR
      CustSurchRec@1100485000 : Record 11020367;
      ServiceOrderExtension@1100528600 : Record 11071727;
      ProjSetup@1100525002 : Record 315;
      PriceHistRec@1100525001 : Record 11012315;
      RefDate@1100525000 : Date;
      lvCustPriceList@1100525003 : Record 11128273;
    BEGIN
      lvPerc := 0;

      CALCFIELDS("Cost Type");
      IF NOT ServOrderRec.GET("Service Order No.") THEN
        ServOrderRec.INIT;
      //>> 160621 ITERO.AC RFC082 (similar to ENH-007, 4PSSE, DL/DJ and LAHE 130117 in Project Cost Plus Entry)
      IF ("Cost Type" = "Cost Type"::Material) THEN BEGIN
        IF lvCustPriceList.GET(ServOrderRec."Price List Code") THEN
          IF lvCustPriceList."Apply Material Surcharge" THEN BEGIN
            IF NOT ServiceOrderExtension.GET("Service Order No.") THEN
              CLEAR(ServiceOrderExtension);
            EXIT(ServiceOrderExtension."Surcharge % Material");
          END;
      END;

      IF NOT ServiceOrderExtension.GET("Service Order No.") THEN
        CLEAR(ServiceOrderExtension);
      IF "Price History Found" THEN
        EXIT(0);
      IF "Trade Item" <> '' THEN
        IF NOT (ServiceOrderExtension."Item Price Cost Plus Entry" = ServiceOrderExtension."Item Price Cost Plus Entry"::CostPrice) THEN
          EXIT(0);

      //<< 160621 ITERO.AC RFC082

      //db.sn, 03-04-13: C005338
      IF "Cost Type" = "Cost Type"::Material THEN BEGIN
        ProjSetup.GET;
        IF ProjSetup."Apply Surch. MatPriceZero Only" THEN BEGIN
          //db.sn, 26-01-16: C015604
          IF "Trade Item" + "Basic Item" + "Item No." <> '' THEN BEGIN
            IF "Sales Condition Present" THEN
              EXIT(0);
          END;
          //RefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);
          //IF "Trade Item" <> '' THEN BEGIN
          //  PriceHistRec.SETRANGE(Vendor, "Vendor (Trade Item)");
          //  PriceHistRec.SETRANGE("Item Code", "Trade Item");
          //  PriceHistRec.SETRANGE("Starting Date", 0D, RefDate);
          //  IF NOT PriceHistRec.FINDLAST THEN PriceHistRec.INIT;
          //  IF PriceHistRec."Gross Price" <> 0 THEN EXIT(0);
          //END ELSE BEGIN
          //  IF "Item No." <> '' THEN EXIT(0);
          //  IF "Basic Item" <> '' THEN EXIT(0);
          //END;
          //db.en, 26-01-16: C015604
        END;
      END;
      //db.en, 03-04-13: C005338

      IF ServOrderRec."Charge Vendor (Warranty)" THEN
        EXIT;

      IF ServOrderRec."Service Contract No." <> '' THEN BEGIN
        CustSurchRec.SETRANGE("Record Type", CustSurchRec."Record Type"::ServContr);
        CustSurchRec.SETRANGE(Code, ServOrderRec."Service Contract No.");
      END ELSE BEGIN
        CustSurchRec.SETRANGE("Record Type", CustSurchRec."Record Type"::Customer);
        CustSurchRec.SETRANGE("Customer No.", ServOrderRec."Bill-to Customer No.");
      END;
      CustSurchRec.SETRANGE("Cost Type", "Cost Type");
      CustSurchRec.SETFILTER(Price, '%1..', "Basic Price (LCY)");
      IF CustSurchRec.FINDFIRST THEN BEGIN
        lvPerc := CustSurchRec."Surcharge %";
      END ELSE BEGIN
        CustSurchRec.SETFILTER(Price, '..%1', "Basic Price (LCY)");
        IF CustSurchRec.FINDLAST THEN
          lvPerc := CustSurchRec."Surcharge %";
      END;

      IF lvPerc = 0 THEN BEGIN
        IF ServiceOrderExtension.GET("Service Order No.") THEN
          CASE "Cost Type" OF
            "Cost Type"::Labor:
              lvPerc := ServiceOrderExtension."Surcharge % Labor";
            "Cost Type"::Material:
              lvPerc := ServiceOrderExtension."Surcharge % Material";
            "Cost Type"::Subcontracting:
              lvPerc := ServiceOrderExtension."Surcharge % Subcontr.";
            "Cost Type"::Plant:
              lvPerc := ServiceOrderExtension."Surcharge % Plant";
             "Cost Type"::Sundry:
              lvPerc := ServiceOrderExtension."Surcharge % Sundry";
          END;
      END;

      EXIT(lvPerc);
    END;

    PROCEDURE CalcSurcharge@1100485012(lvServOrder@1100485001 : Code[20]);
    VAR
      CostPlusRec@1100485000 : Record 11012825;
    BEGIN
      CostPlusRec.SETRANGE("Service Order No.", lvServOrder);
      CostPlusRec.SETRANGE(Invoiced, FALSE);
      IF NOT CostPlusRec.ISEMPTY THEN BEGIN
        IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
          REPEAT
            CostPlusRec.VALIDATE("Surcharge %", CostPlusRec.GetSurcharge);
            CostPlusRec.MODIFY;
          UNTIL CostPlusRec.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE CalcDiscount@1100485015(lvServOrder@1100485001 : Code[20]);
    VAR
      CostPlusRec@1100485000 : Record 11012825;
    BEGIN
      CostPlusRec.SETRANGE("Service Order No.", lvServOrder);
      CostPlusRec.SETRANGE(Invoiced, FALSE);
      IF NOT CostPlusRec.ISEMPTY THEN BEGIN
        IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
          REPEAT
            CostPlusRec.GetDiscountPerc;
            CostPlusRec.MODIFY;
          UNTIL CostPlusRec.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE GetDiscountPerc@1210190000();
    BEGIN
      "Discount % (ServOrder)" := 0;
      "Discount % (Warranty)" := 0;
      "Discount % (ServContr)" := 0;
      "Warranty Code" := '';
      CALCFIELDS("Cost Type");

      IF ServOrderRec.GET("Service Order No.") THEN
        IF (ServOrderRec."Order Amount (LCY)" <> 0) AND ("Entry No. Service Ledger" <> 0) THEN
          "Discount % (ServOrder)" := 100;

      GetWarrantyDiscount;
      GetContractDiscount;

      IF "Discount % (ServContr)" > "Discount % (ServOrder)" THEN
        "Discount % (ServOrder)" := "Discount % (ServContr)";
      IF "Discount % (Warranty)" > "Discount % (ServOrder)" THEN
        "Discount % (ServOrder)" := "Discount % (Warranty)";

      VALIDATE("Discount % (ServOrder)");
    END;

    PROCEDURE GetDescription@1210190006();
    VAR
      ServSetup@1100525000 : Record 11012800;
      ServLedgerEntryRec@1100525001 : Record 11012819;
      PostedHourHeader@1210190002 : Record 11012084;
      HourRateRec@1100409000 : Record 11012022;
      ContractHourRateRec@1100409001 : Record 11012815;
      HelpDesc@1210190001 : Text[100];
      PlantLabor@1210190000 : Boolean;
      SESetup@1100285300 : Record 11128004;
    BEGIN
      IF "Item No." + "Basic Item" + "Trade Item" <> '' THEN EXIT;

      ServSetup.GET;

      CALCFIELDS("Cost Type");
      //mg.sc, 20-09-11: M27549
      IF ("Cost Type" = "Cost Type"::Plant) AND ("Source Document" <> '') THEN BEGIN
        PostedHourHeader.SETCURRENTKEY("Document No.");
        PostedHourHeader.SETRANGE("Document No.", "Source Document");
        PlantLabor := NOT PostedHourHeader.ISEMPTY;
      END;

      IF ("Cost Type" = "Cost Type"::Labor) OR (("Cost Type" = "Cost Type"::Plant) AND PlantLabor) THEN BEGIN
      //mg.ec, 20-09-11: M27549
        CASE ServSetup."Description Cost Plus Entry" OF
          ServSetup."Description Cost Plus Entry"::Employee:
            IF ((CurrFieldNo = FIELDNO("Employee No.")) OR (CurrFieldNo = 0)) THEN
              IF EmplRec.GET("Employee No.") THEN BEGIN
                HelpDesc := Text006 + ' ' + EmplRec."Full Name";
                Description := COPYSTR(HelpDesc, 1, MAXSTRLEN(Description));
              END;
          ServSetup."Description Cost Plus Entry"::RateCode:
            IF ((CurrFieldNo = FIELDNO("Hour Rate Code")) OR (CurrFieldNo = 0)) OR
              ("Hour Rate Code" <> xRec."Hour Rate Code")
            THEN BEGIN
              ContractHourRateRec.SETRANGE("Service Contract No.","Service Contract No.");
              ContractHourRateRec.SETRANGE("Hour Rate Code","Hour Rate Code");
              ContractHourRateRec.SETRANGE("Starting Date",0D,"Posting Date");
              IF ContractHourRateRec.FINDLAST THEN BEGIN
                //Description := ContractHourRateRec.Description;
                Description := HourRateRec.RateDescription(ContractHourRateRec."Hour Rate Code",ContractHourRateRec."Starting Date",ContractHourRateRec."Ending Date");
              END ELSE BEGIN
                HourRateRec.SETRANGE(Code,"Hour Rate Code");
                HourRateRec.SETRANGE("Starting Date",0D,"Posting Date");
                IF HourRateRec.FINDLAST THEN
                  Description := HourRateRec.Description;
              END;
            END;
          ServSetup."Description Cost Plus Entry"::CostObject:
            IF NOT ((CurrFieldNo = FIELDNO("Cost Object")) AND SkipGetCostObjectDesc) THEN BEGIN  //*31430.n
              IF ((CurrFieldNo = FIELDNO("Cost Object")) OR (CurrFieldNo = 0)) THEN BEGIN
                DimMgt.GetDimValueRec(2, "Cost Object", DimValRec, FALSE, '');
                Description := DimValRec.Name;
              END;
            END;
          ServSetup."Description Cost Plus Entry"::WageComponent:
            IF ((CurrFieldNo = FIELDNO("Wage Component")) OR (CurrFieldNo = 0) OR
                ("Wage Component" <> xRec."Wage Component")) THEN
              IF WageCompRec.GET("Wage Component") THEN BEGIN
                Description := WageCompRec.Description;
                //>> 160620 ITERO.SB RAD-010 Mapping of description, wage component
                SESetup.SETRANGE(Code,WageCompRec.Code);
                SESetup.SETRANGE("Line type",SESetup."Line type"::Mapping);
                IF (SESetup.FINDFIRST) AND (SESetup."Value (txt)"<>'') THEN
                  Description := SESetup."Value (txt)";
                //<<
              END;
        END;
        IF Description <> xRec.Description THEN
          AddDateToDescription("Posting Date");
      END ELSE BEGIN
        IF NOT ((CurrFieldNo = FIELDNO("Cost Object")) AND SkipGetCostObjectDesc) THEN BEGIN  //*31430.n
          IF ("Source Document" = '') THEN BEGIN  //db, 04-06-07 (call 9216)
            DimMgt.GetDimValueRec(2, "Cost Object", DimValRec, FALSE, '');
            Description := DimValRec.Name;
          END ELSE BEGIN
            IF "Entry No. Service Ledger" <> 0 THEN BEGIN  //db, 19-06-07: M14663
              IF ServLedgerEntryRec.GET("Entry No. Service Ledger") THEN BEGIN
                IF ServLedgerEntryRec.Chargeable AND ServLedgerEntryRec.Expense THEN BEGIN
                  DimMgt.GetDimValueRec(2, "Cost Object", DimValRec, FALSE,'');
                  Description := DimValRec.Name;
                END;
              END;
            END;
          END;
        END;
      END;
    END;

    PROCEDURE GetBasicPrice@1100485002();
    VAR
      BasicPrice@1100485000 : Decimal;
      BasicPriceFoundAt@1100525000 : Text[250];
    BEGIN
      IF BasicPriceCalcRunning THEN
        EXIT;

      BasicPriceCalcRunning := TRUE;
      IF "Trade Item" <> '' THEN  //db, 17-11-08: M13384
        ItemTypeOpt := ItemTypeOpt::"Trade Item"
      ELSE
        IF "Basic Item" <> '' THEN
          ItemTypeOpt := ItemTypeOpt::"Basic Item"
        ELSE
          ItemTypeOpt := ItemTypeOpt::Item;

      GetHourRateCode;

      CALCFIELDS("Service Contract No.");
      CASE TRUE OF
        (CheckItemLine):
          ValidateItem(ItemTypeOpt);  //db, 17-11-08: M13384
        ELSE BEGIN
          BasicPrice :=
            SalesPriceMgt.GetSalesPrice(
              1,'', "Service Order No.", "Service Contract No.", "Bill-to Customer No.", "Cost Object",
              "Wage Component", '', "Employee No.", "Hour Rate Code",
              '', '', '', '', "Posting Date",
              "Cost Price (LCY)", BasicPriceFoundAt);

          IF BasicPriceFoundAt = '' THEN BEGIN
            IF (CurrFieldNo = 0) OR
               ((xRec."Basic Price Found at" <> Text009) AND
                (xRec."Basic Price Found at" <> '')) THEN BEGIN
              "Basic Price Found at" := '';
              VALIDATE("Basic Price (LCY)", 0);
            END;
          END ELSE BEGIN
            CalcOvertimeSurcharge(BasicPrice);
            VALIDATE("Basic Price (LCY)", BasicPrice);
            "Basic Price Found at" := BasicPriceFoundAt;  //db, 04-10-10: M21790
          END;
        END;
      END;

      BasicPriceCalcRunning := FALSE;
    END;

    PROCEDURE CalcOvertimeSurcharge@1100485004(VAR ioSalesPrice@1100485000 : Decimal);
    VAR
      lvOverTimeSurcharge@1100485001 : Record 11020256;
      lvWageCompRec@1100485002 : Record 11012014;
    BEGIN
      //Overtime Surcharge by Wage Component on General Level or on Customer Level
      "Sales Surcharge Overtime %" := 0;
      IF ("Wage Component" = '') OR (ioSalesPrice = 0) THEN
        EXIT;

      //**4PS (BE)
      IF lvWageCompRec.GET("Wage Component") THEN  BEGIN
        IF lvWageCompRec."Sales Surcharge %" <> 0 THEN BEGIN
          ioSalesPrice := ROUND(ioSalesPrice * lvWageCompRec."Sales Surcharge %" / 100);
        END;
      END;
      //**4PS (BE)

      lvOverTimeSurcharge.SETRANGE("Customer No.", "Bill-to Customer No.");
      lvOverTimeSurcharge.SETRANGE("Wage Component No.", "Wage Component");
      lvOverTimeSurcharge.SETFILTER("Start Date", '..%1', "Posting Date");
      IF lvOverTimeSurcharge.FINDLAST THEN BEGIN
        IF lvOverTimeSurcharge."Surcharge %" > 0 THEN BEGIN
          ioSalesPrice := ROUND(ioSalesPrice * lvOverTimeSurcharge."Surcharge %" / 100);
          "Sales Surcharge Overtime %" := lvOverTimeSurcharge."Surcharge %";
        END;
      END ELSE BEGIN
        IF lvWageCompRec.GET("Wage Component") THEN
          IF lvWageCompRec."Sales Surcharge Overtime %" > 0 THEN BEGIN
            ioSalesPrice := ROUND(ioSalesPrice * lvWageCompRec."Sales Surcharge Overtime %" / 100);
            "Sales Surcharge Overtime %" := lvWageCompRec."Sales Surcharge Overtime %";
          END;
      END;
    END;

    PROCEDURE GetRoundingFactor@1210190005(RoundOption@1100525000 : 'Price,Amount') : Decimal;
    BEGIN
      GlSetupRec.GET;
      IF RoundOption = RoundOption::Price THEN BEGIN  //db, 17-02-14: C012946
        GlSetupRec.TESTFIELD("Unit-Amount Rounding Precision");
        EXIT(GlSetupRec."Unit-Amount Rounding Precision");
      END ELSE BEGIN
        GlSetupRec.TESTFIELD("Amount Rounding Precision");
        EXIT(GlSetupRec."Amount Rounding Precision");
      END;
    END;

    PROCEDURE TransferCostObjectData@2() : Boolean;
    BEGIN
      IF ("Item No." <> '') OR ("Basic Item" <> '') OR ("Trade Item" <> '') THEN
        EXIT(FALSE);
      //IF ("Source Document" <> '') THEN  //db, 22-10-12: C002998
      //  EXIT(FALSE);  //db, 04-06-07 (call 9216)
      IF ("Cost Object" <> xRec."Cost Object") THEN BEGIN
        DimMgt.GetDimValueRec(2, "Cost Object", DimValRec, TRUE,'');
        IF xRec."Cost Object" <> '' THEN
          IF NOT CONFIRM(Text001,FALSE) THEN
            EXIT(FALSE);
        EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    PROCEDURE ValidateItem@31(LTypeArtOpt@11012000 : 'Item,Basic Item,Trade Item');
    VAR
      lvPriceHistoryFound@1100525000 : Boolean;
      lvDoSalesPriceCalulation@1100525001 : Boolean;
      lvSurchargeIfMissingArticles@1100525002 : Decimal;
      lvPriceFactor@1100525003 : Decimal;
      lvGrossPrice@1100525004 : Decimal;
      lvRefDate@1100525005 : Date;
      lvItemSalesPrice@1100525006 : Record 7002;
    BEGIN
      ServOrderRec.GET("Service Order No.");
      IF NOT ServContractRec.GET("Service Contract No.") THEN ServContractRec.INIT;

      FindCostPrice(LTypeArtOpt);  //db, 28-12-09: M16871
      lvPriceFactor := 1;          // 160621 ITERO.AC RFC082 Just to make code similar to Project Cost Plus Entry
      "Basic Price (LCY)" := "Cost Price (LCY)";
      CalculateBasicPriceFromLCY; // dp00116.n
      //>> 160621 ITERO.AC RFC082 Check for Cost Price Behaviour, Price factors and Price List Surcharges
      IF lvPriceFactor <> 1 THEN
        "Basic Price Found at" := Text11128002
      ELSE
        "Basic Price Found at" := FIELDCAPTION("Cost Price (LCY)");

      lvDoSalesPriceCalulation := TRUE;
      lvPriceHistoryFound := FALSE;
      lvGrossPrice := 0;

      lvRefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);

      IF (LTypeArtOpt = LTypeArtOpt::"Trade Item") OR (LTypeArtOpt = LTypeArtOpt::Item) THEN BEGIN  // 160816 ITERO.AC Added price calculation for NAV Items
        lvPriceHistoryFound := CheckIfPriceHistoryExists("Service Order No.", lvRefDate, "Trade Item", lvGrossPrice);

        IF CheckCostPriceBehaviour("Service Order No.", "Customer No.") THEN BEGIN
          IF lvPriceHistoryFound THEN BEGIN
            "Gross Price (LCY)" := lvGrossPrice;
            "Basic Price Found at" := Text010;
          END
          ELSE BEGIN
            "Cost Price Adjustment" := (lvPriceFactor - 1) * 100;
            "Gross Price (LCY)" := "Cost Price" * lvPriceFactor;
            "Basic Price (LCY)" := "Gross Price (LCY)";
          END;
        END
        ELSE BEGIN
          IF lvPriceHistoryFound THEN BEGIN
            "Basic Price Found at" := Text010;
          END
          ELSE BEGIN
            lvSurchargeIfMissingArticles := GetSurchargeIfMissingArticles("Service Order No.");
            IF lvSurchargeIfMissingArticles <> 1 THEN BEGIN
              "Cost Price Adjustment" := (lvSurchargeIfMissingArticles - 1) * 100;
              //VALIDATE("Gross Price", "Cost Price" * lvSurchargeIfMissingArticles);   // 160324 ITERO.AC RFC083 Do not use Validate (will lead to wrong Cost Price)
              "Gross Price (LCY)" := "Cost Price" * lvSurchargeIfMissingArticles;
              VALIDATE("Sales Discount % (Item)", 0);
              "Basic Price Found at" := Text11128001;
              lvDoSalesPriceCalulation := FALSE;
            END
            ELSE BEGIN
              "Basic Price Found at" := Text11128003;
            END;
            //>> 161012 ITERO.AC RAD043 Get Sales price if Item not found in Customer pricelist or in Vendor Price List
            // Warehouse Items with no sales price.. NOTE: We do not handle different Currencies in Sales Prices. All prices are calculated in LCY !
            IF (LTypeArtOpt = LTypeArtOpt::Item) AND ("Item No." <> '') AND ("Trade Item" = '') AND (lvPriceHistoryFound = FALSE) THEN BEGIN
              lvItemSalesPrice.SETRANGE( "Item No.", "Item No.");
              lvItemSalesPrice.SETRANGE("Starting Date", 0D, lvRefDate);
              IF lvItemSalesPrice.FINDLAST THEN BEGIN
                "Gross Price (LCY)" := CalculatePriceWithoutVAT("Item No.", lvItemSalesPrice."Price Includes VAT", lvItemSalesPrice."Unit Price");
                "Price History Found" := TRUE;
                VALIDATE("Sales Discount % (Item)", 0);
                "Basic Price Found at" := Text11128004;   // Sales Price Warehouse Item
                lvDoSalesPriceCalulation := FALSE;
              END ELSE BEGIN
                "Basic Price Found at" := Text11128005;   // Price Warehouse Item
              END;
            END;
            //<< 161012 ITERO.AC RAD043
          END;
        END;
      END;

      IF lvDoSalesPriceCalulation THEN BEGIN
        "Price History Found" := lvPriceHistoryFound;
      //<< 160621 ITERO.AC RFC082
        FindSalesPrice;  //db, 28-12-09: M16871
      END;

      VALIDATE("Surcharge %", GetSurcharge);
      GetDiscountPerc;

      IF ("Item No." <> '') AND ("Item No." <> ItemRec."No.") THEN
        IF ItemRec.GET("Item No.") THEN
          VALIDATE(Text, ItemRec.Text);

      "VAT Prod. Posting Group" := UpdateVatProdPostingGrp;   //RFC 547
    END;

    PROCEDURE FindCostPrice@1100525008(LTypeArtOpt@1100525005 : 'Item,Basic Item,Trade Item');
    VAR
      ServiceOrderCostPlusEntry@1210190000 : Record 11012825;
      lvRefDate@1100525003 : Date;
      lvDiscRef1@1100525002 : Code[20];
      lvDiscRef2@1100525001 : Code[20];
      lvRefPrio@1100525000 : Code[10];
      lvDiscType@1100525004 : 'Purchase,Sales';
      DummyDat@1100525006 : Date;
      SaveField@1100525007 : Integer;
      ProjSetup@1100285000 : Record 315;
      lvSaveCostPrice@1100285001 : Decimal;
    BEGIN
      //db, 28-12-09: M16871
      ServiceOrderCostPlusEntry := Rec; //call T000440
      ValidateCu.SetQuantity(Quantity);
      lvRefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);
      lvRefPrio := ValidateCu.GetRefPrioServContract(ServContractRec, lvDiscType::Purchase);

      //>> 150905 ITERO.AC Check project settings and keep existing cost price if any
      ProjSetup.GET;
      lvSaveCostPrice := 0;
      IF (ProjSetup."Copy Price Item from Entry") AND ("Cost Price (LCY)" <> 0) THEN BEGIN
        lvSaveCostPrice := "Cost Price (LCY)";
      END;
      //<< 150905 ITERO.AC

      ValidateCu.SetPriceListCode('');  // Itero ANCA 150807 Added Price List Code To Service Order
      ValidateCu.SetDontUseSingleGTIN(TRUE); // 160116 ITERO.AC (Same as IME420)

      ValidateCu.ValidateItem(LTypeArtOpt, "Trade Item", "Item No.", Manufacturer, "Vendor (Trade Item)",
        "Basic Item", "Cost Object", Description, "Unit of Measure", "Cost Price (LCY)", "Purchase Discount % (Item)", DummyDat,
        "Gross Price (LCY)", "Description 2", "Cost Component",
         lvDiscRef1, lvDiscRef2, lvRefDate, lvRefPrio);
      //>> 150905 ITERO.AC
      IF lvSaveCostPrice <> 0 THEN
        "Cost Price (LCY)" := lvSaveCostPrice;
      //<< 150905 ITERO.AC

      //>> 160621 ITERO.AC RFC082 If not FindSalesPrice calculation is executed or article not found in customer price list, this value will remain as an information
      "Price History Vendor No." := ValidateCu.GetPriceHistVendorNo();
      //<< 160621 ITERO.AC RFC082

      //call T000440.sn
      IF CostObjectFixed AND (ServiceOrderCostPlusEntry."Cost Object" <> '') THEN BEGIN
        "Cost Object" := ServiceOrderCostPlusEntry."Cost Object";
        "Cost Type" := ServiceOrderCostPlusEntry."Cost Type";
      END;
      //call T000440.en

      CalculateCostPriceFromLCY; // dp00116.n
      CalculateGrossPriceFromLCY; // dp00116.n

      VALIDATE("Cost Component");

      //db.sn, 17-06-10: M19824
      IF CurrFieldNo <> 0 THEN BEGIN
        SaveField := CurrFieldNo;
        CurrFieldNo := FIELDNO("Cost Object");
        CheckAdditionalCostService;
        CurrFieldNo := SaveField;
      END;
      //db.sn, 17-06-10: M19824
    END;

    PROCEDURE FindSalesPrice@1100525005();
    VAR
      lvRefDate@1100525003 : Date;
      lvDiscRef1@1100525002 : Code[20];
      lvDiscRef2@1100525001 : Code[20];
      lvRefPrio@1100525000 : Code[10];
      lvDiscType@1100525004 : 'Purchase,Sales';
      lvCustPriceListFromPrio@1100285000 : Code[20];
      lvTempPriceHistVendor@1100525005 : Code[20];
    BEGIN
      //db, 28-12-09: M16871
      IF NOT CustRec.GET("Bill-to Customer No.") THEN CustRec.INIT;   //db, 08-12-10: M23704
      //>> Itero AC 150807 Price Calulation when Customer Price List is Selected
      IF NOT UseCostPrice(CustRec) THEN BEGIN
        ValidateCu.SetQuantity(Quantity);
        lvRefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);
        ValidateCu.GetRefDiscServOrder(ServOrderRec, lvDiscRef1, lvDiscRef2, lvDiscType::Sales);
        IF lvDiscRef1 <> '' THEN BEGIN
          lvRefPrio := '01~';  // ITERO.AC: Betyder Rabattvilkorsgrupp (Kund) i Serviceorder
        END ELSE BEGIN
          lvRefPrio := ValidateCu.GetRefPrioServContract(ServContractRec, lvDiscType::Sales);
        END;
        IF UseManualPriceList = '' THEN BEGIN
          ValidateCu.SetPriceListCode(ServOrderRec."Price List Code");
        END ELSE BEGIN
          ValidateCu.SetPriceListCode(UseManualPriceList);
        END;
        ValidateCu.GetSalesDiscount(CustRec."No.", "Item No.", "Basic Item", "Trade Item",
          Manufacturer, "Vendor (Trade Item)", "Basic Price (LCY)", "Sales Discount % (Item)", "Gross Price (LCY)", lvRefDate, '',
          lvDiscRef1, lvDiscRef2, lvRefPrio);
        //>> 150905 ITERO.AC Search for alternative Customer Price List
        //>> 161010 ITERO.AC RAD043 Use new field "Sales Discount Term Percent" if entered and Curent Trade Item exists in Customer price list
        IF ValidateCu.GetPriceHistFound() THEN BEGIN
          IF ServOrderRec."Sales Discount Term Percent" <> 0 THEN BEGIN
            "Basic Price (LCY)" := "Gross Price (LCY)" - ("Gross Price (LCY)" * ServOrderRec."Sales Discount Term Percent" / 100);
            "Sales Discount % (Item)" := ServOrderRec."Sales Discount Term Percent";
          END;
        END;
        //<< 161010 ITERO.AC RAD043
        IF NOT ValidateCu.GetPriceHistFound() THEN BEGIN
          lvCustPriceListFromPrio := GetCustPriceListFromPriority("Trade Item", lvRefDate, lvDiscRef1);
          IF lvCustPriceListFromPrio <> '' THEN BEGIN
            ValidateCu.SetPriceListCode(lvCustPriceListFromPrio);
            ValidateCu.GetSalesDiscount(CustRec."No.", "Item No.", "Basic Item", "Trade Item",
              Manufacturer, "Vendor (Trade Item)", "Basic Price (LCY)", "Sales Discount % (Item)", "Gross Price (LCY)", lvRefDate, '',
              lvDiscRef1, lvDiscRef2, lvRefPrio);
              //>> 161010 ITERO.AC RAD043 Use new filed "Sales Discount Term Percent" if entered
              IF ServOrderRec."Sales Discount Term Percent" <> 0 THEN BEGIN
                "Basic Price (LCY)" := "Gross Price (LCY)" - ("Gross Price (LCY)" * ServOrderRec."Sales Discount Term Percent" / 100);
                "Sales Discount % (Item)" := ServOrderRec."Sales Discount Term Percent";
              END
              //>> 161010 ITERO.AC RAD043
          END;
        END;
        //<< 150905 ITERO.AC
        "Price History Found" := ValidateCu.GetPriceHistFound();
        //>> 160621 ITERO.AC RFC082 Do not replace "Price History Vendor No." with blank
        lvTempPriceHistVendor := ValidateCu.GetPriceHistVendorNo();
        IF lvTempPriceHistVendor <> '' THEN
          "Price History Vendor No." := lvTempPriceHistVendor;
        //"Price History Vendor No." := ValidateCu.GetPriceHistVendorNo();
        //<< 160621 ITERO.AC RFC082

        "Gross Price (LCY)" :=  ValidateCu.GetLatestCustGrossPrice();
        CalculateGrossPriceFromLCY; // 160622 ITERO.AC RFC082
        IF ("Price History Found") AND (UseManualPriceList = '')  THEN BEGIN
          IF lvCustPriceListFromPrio = '' THEN
            "Price History PriceList" := ServOrderRec."Price List Code"
          ELSE
            "Price History PriceList" := lvCustPriceListFromPrio;
        END;
        VALIDATE("Sales Discount % (Item)");
        GetSalesDiscount;
        EXIT;
      END;
      //<< ITERO.AC 150807
      IF ItemPriceCPEisGrossMin(CustRec) THEN BEGIN
        ValidateCu.SetQuantity(Quantity);
        lvRefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);
        ValidateCu.GetRefDiscServOrder(ServOrderRec, lvDiscRef1, lvDiscRef2, lvDiscType::Sales);
        lvRefPrio := ValidateCu.GetRefPrioServContract(ServContractRec, lvDiscType::Sales);
        "Sales Condition Present" := ValidateCu.GetSalesDiscount(  //db, 26-01-16: C015604
          CustRec."No.", "Item No.", "Basic Item", "Trade Item",
          Manufacturer, "Vendor (Trade Item)", "Basic Price (LCY)", "Sales Discount % (Item)", "Gross Price (LCY)", lvRefDate, '',
          lvDiscRef1, lvDiscRef2, lvRefPrio);
        CalculateBasicPriceFromLCY; // dp00116.n
        VALIDATE("Sales Discount % (Item)");
      END ELSE BEGIN
        GetSalesDiscount;  //db, 09-07-09: M10954
      END;
    END;

    PROCEDURE CheckTimerData@1210190003(QuanTime@1210190000 : Decimal);
    VAR
      ServSetup@1100525000 : Record 11012800;
      CostPlusRec@1210190002 : Record 11012825;
      UserSetup@1210190003 : Record 91;
      LastLino@1210190001 : Integer;
    BEGIN
      ServSetup.GET;
      ServSetup.TESTFIELD("Cost Object Consult");
      ServOrderRec.GET("Service Order No.");

      CostPlusRec.RESET;
      CostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
      IF CostPlusRec.FINDLAST THEN
        LastLino := CostPlusRec."Line No."
      ELSE
        LastLino := 0;

      DimMgt.GetDimValueRec(2, ServSetup."Cost Object Consult", DimValRec, TRUE,'');

      CostPlusRec.INIT;
      CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
      CostPlusRec."Line No." := LastLino + 10000;
      CostPlusRec.INSERT(TRUE);

      IF UserSetup.GET(USERID) THEN
        CostPlusRec."Employee No." := UserSetup."Employee No.";
      CostPlusRec."Cost Object" := DimValRec.Code;
      CostPlusRec.Description := DimValRec.Name;
      CostPlusRec.Quantity := QuanTime;
      CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
      CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
      //db.sn, 24-06-10: M19260
      IF DimValRec."Rate Code" <> '' THEN
        CostPlusRec.VALIDATE("Hour Rate Code", DimValRec."Rate Code")
      ELSE
        CostPlusRec.GetBasicPrice;
      //db.en, 24-06-10: M19260
      CostPlusRec.VALIDATE("Surcharge %", CostPlusRec.GetSurcharge);
      CostPlusRec.GetDiscountPerc;
      CostPlusRec.MODIFY;
    END;

    PROCEDURE CheckTravelData@1210190001();
    VAR
      ServSetup@1100525000 : Record 11012800;
      CostPlusRec@1210190000 : Record 11012825;
      LastLino@1210190001 : Integer;
    BEGIN
      ServSetup.GET;
      ServSetup.TESTFIELD("Cost Object Travel Time");
      ServSetup.TESTFIELD("Cost Object Travel Distance");
      ServSetup.TESTFIELD("Cost Object Travel Cost");

      ServOrderRec.GET("Service Order No.");
      ServLocRec.GET(ServOrderRec."Service Location No.");

      CostPlusRec.RESET;
      CostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
      IF CostPlusRec.FINDLAST THEN
        LastLino := CostPlusRec."Line No."
      ELSE
        LastLino := 0;

      CostPlusRec.SETRANGE("Cost Object", ServSetup."Cost Object Travel Time");
      IF NOT CostPlusRec.FINDFIRST THEN BEGIN
        DimMgt.GetDimValueRec(2, ServSetup."Cost Object Travel Time", DimValRec, TRUE,'');

        IF ServLocRec."Travel Time" <> 0 THEN BEGIN
          CostPlusRec.INIT;
          CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
          CostPlusRec."Line No." := LastLino + 10000;
          CostPlusRec.INSERT(TRUE);

          CostPlusRec."Cost Object" := DimValRec.Code;
          CostPlusRec.Description := DimValRec.Name;
          CostPlusRec.Quantity := ServLocRec."Travel Time";
          CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
          CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
          //db.sn, 24-06-10: M19260
          IF DimValRec."Rate Code" <> '' THEN
            CostPlusRec.VALIDATE("Hour Rate Code", DimValRec."Rate Code")
          ELSE
            CostPlusRec.GetBasicPrice;
          //db.en, 24-06-10: M19260
          CostPlusRec.VALIDATE("Surcharge %", CostPlusRec.GetSurcharge);
          CostPlusRec.GetDiscountPerc;
          CostPlusRec.MODIFY;

          LastLino := CostPlusRec."Line No.";
        END;
      END;

      CostPlusRec.SETRANGE("Cost Object", ServSetup."Cost Object Travel Distance");
      IF NOT CostPlusRec.FINDFIRST THEN BEGIN
        DimMgt.GetDimValueRec(2, ServSetup."Cost Object Travel Distance", DimValRec, TRUE,'');

        IF ServLocRec."Travel Distance" <> 0 THEN BEGIN
          CostPlusRec.INIT;
          CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
          CostPlusRec."Line No." := LastLino + 10000;
          CostPlusRec.INSERT(TRUE);

          CostPlusRec."Cost Object" := DimValRec.Code;
          CostPlusRec.Description := DimValRec.Name;
          CostPlusRec.Quantity := ServLocRec."Travel Distance";
          CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
          CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
          CostPlusRec.GetBasicPrice;  //db, 24-06-10: M19260
          CostPlusRec.VALIDATE("Surcharge %", CostPlusRec.GetSurcharge);
          CostPlusRec.GetDiscountPerc;
          CostPlusRec.MODIFY;

          LastLino := CostPlusRec."Line No.";
        END;
      END;

      CostPlusRec.SETRANGE("Cost Object", ServSetup."Cost Object Travel Cost");
      IF NOT CostPlusRec.FINDFIRST THEN BEGIN
        DimMgt.GetDimValueRec(2, ServSetup."Cost Object Travel Cost", DimValRec, TRUE,'');

        IF ServLocRec.GetTravelCostWithIndexDate(ServOrderRec."Order Date") <> 0 THEN BEGIN
          CostPlusRec.INIT;
          CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
          CostPlusRec."Line No." := LastLino + 10000;
          CostPlusRec.INSERT(TRUE);

          CostPlusRec."Cost Object" := DimValRec.Code;
          CostPlusRec.Description := DimValRec.Name;
          CostPlusRec.Quantity := 1;
          CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
          CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
          CostPlusRec."Basic Price (LCY)" := ServLocRec.GetTravelCostWithIndexDate(ServOrderRec."Order Date");
          CostPlusRec.CalculateBasicPriceFromLCY; // dp00116.n
          CostPlusRec.VALIDATE("Surcharge %", CostPlusRec.GetSurcharge);
          CostPlusRec.GetDiscountPerc;
          CostPlusRec.MODIFY;

          LastLino := CostPlusRec."Line No.";
        END;
      END;
    END;

    PROCEDURE CheckInvoiceBaseAmount@1210190008(IForceChargeable@1100525004 : Boolean);
    VAR
      AmntTotal@1100525008 : Decimal;
      AmntLabor@1100525007 : Decimal;
      AmntMaterial@1100525006 : Decimal;
      AmntSubcontracting@1100525005 : Decimal;
      AmntPlant@1100525003 : Decimal;
      AmntSundry@1100525002 : Decimal;
      InvAmnt@1100525001 : Decimal;
      InvHrs@1100525000 : Decimal;
    BEGIN
      ServOrderRec.GET("Service Order No.");
      IF ServOrderRec."Invoice Base Method" = ServOrderRec."Invoice Base Method"::" " THEN EXIT;
      IF ServOrderRec."Settlement Method" = ServOrderRec."Settlement Method"::"Fixed Price" THEN EXIT;
      IF ServOrderRec."Charge Vendor (Warranty)" THEN EXIT;  //DP01008.n

      ServSetup.GET;
      ServSetup.TESTFIELD("Cost Object Invoice Base");
      DimMgt.GetDimValueRec(2, ServSetup."Cost Object Invoice Base", DimValRec, TRUE,'');

      //DP01008.sn
      CalcSubtotalsForInvoiceBaseAmount("Service Order No.",
        AmntTotal, AmntLabor, AmntMaterial, AmntSubcontracting,AmntPlant, AmntSundry,
        InvAmnt, InvHrs);
      CheckAndCreateInvoiceBaseAmountLine("Service Order No.", IForceChargeable,
        AmntTotal, AmntLabor, AmntMaterial, AmntSubcontracting,AmntPlant, AmntSundry,
        InvAmnt, InvHrs);
      //DP01008.en
    END;

    PROCEDURE CheckInvBaseAmountBaseOrder@1100528602(IForceChargeable@1100528608 : Boolean);
    VAR
      ServiceOrder2@1100525008 : Record 11012823;
      AmntTotal@1100525007 : Decimal;
      AmntLabor@1100525006 : Decimal;
      AmntMaterial@1100525005 : Decimal;
      AmntSubcontracting@1100525004 : Decimal;
      AmntPlant@1100525003 : Decimal;
      AmntSundry@1100525002 : Decimal;
      InvAmnt@1100525001 : Decimal;
      InvHrs@1100525000 : Decimal;
    BEGIN
      ServOrderRec.GET("Service Order No.");

      IF ServOrderRec."Base Service Order No." <> ServOrderRec."No." THEN EXIT; // skip "next" order
      IF ServOrderRec."Settlement Method" = ServOrderRec."Settlement Method"::"Fixed Price" THEN EXIT;
      IF ServOrderRec."Charge Vendor (Warranty)" THEN EXIT;  //DP01008.n

      ServSetup.GET;
      ServSetup.TESTFIELD("Cost Object Invoice Base");
      DimMgt.GetDimValueRec(2, ServSetup."Cost Object Invoice Base", DimValRec, TRUE,'');

      //DP01008.sn
      ServiceOrder2.SETCURRENTKEY("Base Service Order No.");
      ServiceOrder2.SETRANGE("Base Service Order No.", ServOrderRec."No.");
      IF ServiceOrder2.FINDSET THEN BEGIN
        REPEAT
          IF ServiceOrder2."Collect Invoices By" = ServiceOrder2."Collect Invoices By"::BaseOrder THEN
            CalcSubtotalsForInvoiceBaseAmount(ServiceOrder2."No.",
              AmntTotal, AmntLabor, AmntMaterial, AmntSubcontracting,AmntPlant, AmntSundry,
              InvAmnt, InvHrs);
        UNTIL ServiceOrder2.NEXT = 0;
      END;

      CheckAndCreateInvoiceBaseAmountLine("Service Order No.", IForceChargeable,
        AmntTotal, AmntLabor, AmntMaterial, AmntSubcontracting,AmntPlant, AmntSundry,
        InvAmnt, InvHrs);
      //DP01008.en
    END;

    LOCAL PROCEDURE CalcSubtotalsForInvoiceBaseAmount@1100525012(ServiceOrderNo@1100525010 : Code[20];VAR AmntTotal@1100525009 : Decimal;VAR AmntLabor@1100525008 : Decimal;VAR AmntMaterial@1100525007 : Decimal;VAR AmntSubcontracting@1100525006 : Decimal;VAR AmntPlant@1100525005 : Decimal;VAR AmntSundry@1100525004 : Decimal;VAR InvAmnt@1100525003 : Decimal;VAR InvHrs@1100525002 : Decimal);
    VAR
      CostPlusRec@1100525000 : Record 11012825;
    BEGIN
      //DP01008
      CostPlusRec.SETRANGE("Service Order No.", ServiceOrderNo);
      IF NOT CostPlusRec.ISEMPTY THEN BEGIN
        IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
          REPEAT
            CostPlusRec.CALCFIELDS("Invoiced Price (LCY)", "Invoice in Process (LCY)", "Credit Memo in Process (LCY)");
            IF (CostPlusRec."Cost Object" = ServSetup."Cost Object Invoice Base") AND
               (CostPlusRec."Discount Term Level" = CostPlusRec."Discount Term Level"::"Base Service Order")
            THEN BEGIN
              IF (CostPlusRec."Invoiced Price (LCY)" = 0) AND
                 (CostPlusRec."Invoice in Process (LCY)" = 0) AND
                 (CostPlusRec."Credit Memo in Process (LCY)" = 0) THEN
              BEGIN
                CostPlusRec."Invoice Price (LCY)" := 0;
                CostPlusRec."Invoice Price" := 0;
                CostPlusRec.DELETE;
              END ELSE BEGIN
                InvAmnt :=
                  InvAmnt -
                  (CostPlusRec."Invoiced Price (LCY)" + CostPlusRec."Invoice in Process (LCY)" + CostPlusRec."Credit Memo in Process (LCY)");
              END;
            END ELSE BEGIN
              IF CostPlusRec.Chargeable OR
                 (CostPlusRec."Invoiced Price (LCY)" + CostPlusRec."Invoice in Process (LCY)" + CostPlusRec."Credit Memo in Process (LCY)" <> 0)
              THEN BEGIN
                CostPlusRec.CALCFIELDS("Cost Type");
                AmntTotal += CostPlusRec."Invoice Price (LCY)";
                CASE CostPlusRec."Cost Type" OF
                  CostPlusRec."Cost Type"::Labor:
                    BEGIN
                      AmntLabor += CostPlusRec."Invoice Price (LCY)";
                      InvHrs += CostPlusRec.Quantity;
                    END;
                  CostPlusRec."Cost Type"::Material:
                    AmntMaterial += CostPlusRec."Invoice Price (LCY)";
                  CostPlusRec."Cost Type"::Subcontracting:
                    AmntSubcontracting += CostPlusRec."Invoice Price (LCY)";
                  CostPlusRec."Cost Type"::Plant:
                    AmntPlant += CostPlusRec."Invoice Price (LCY)";
                  CostPlusRec."Cost Type"::Sundry:
                    AmntSundry += CostPlusRec."Invoice Price (LCY)";
                END;
              END;
            END;
          UNTIL CostPlusRec.NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE CheckAndCreateInvoiceBaseAmountLine@1100525013(ServiceOrderNo@1100525000 : Code[20];IForceChargeable@1100525011 : Boolean;AmntTotal@1100525009 : Decimal;AmntLabor@1100525008 : Decimal;AmntMaterial@1100525007 : Decimal;AmntSubcontracting@1100525006 : Decimal;AmntPlant@1100525005 : Decimal;AmntSundry@1100525004 : Decimal;InvAmnt@1100525003 : Decimal;InvHrs@1100525002 : Decimal);
    VAR
      CostPlusRec@1100525001 : Record 11012825;
      DummyCostPlusRec@1100525016 : Record 11012825;
      ServiceContractDiscountTerm@1100525015 : Record 11012828;
      LastLino@1100525010 : Integer;
      ServicePackage@1100525014 : Code[10];
      CostTypeMethod@1100525013 : 'Specific Cost Type,All Cost Types';
      InFilterGroup@1100525012 : Boolean;
    BEGIN
      //DP01008
      ServOrderRec.GET(ServiceOrderNo);
      LastLino := GetLastLino(ServOrderRec."No.");

      IF ServOrderRec."Invoice Base Method" <> ServOrderRec."Invoice Base Method"::" " THEN BEGIN // standard method
        IF ServOrderRec."Invoice Base Method" = ServOrderRec."Invoice Base Method"::"total-base" THEN BEGIN
          IF (ServOrderRec."Invoice Base Amount Labor" +
              ServOrderRec."Invoice Base Amount Material" <>
              ServOrderRec."Invoice Base Amount Total") THEN BEGIN
            IF AmntTotal > ServOrderRec."Invoice Base Amount Total" THEN
              InvAmnt := InvAmnt - ServOrderRec."Invoice Base Amount Total"
            ELSE
              InvAmnt := InvAmnt - AmntTotal;
          END ELSE BEGIN
            IF ServOrderRec."Invoice Base Amount Labor" <> 0 THEN BEGIN
             IF AmntLabor > ServOrderRec."Invoice Base Amount Labor" THEN
                InvAmnt := InvAmnt - ServOrderRec."Invoice Base Amount Labor"
              ELSE
                InvAmnt := InvAmnt - AmntLabor;
            END;
            IF ServOrderRec."Invoice Base Amount Material" <> 0 THEN BEGIN
             IF AmntMaterial > ServOrderRec."Invoice Base Amount Material" THEN
                InvAmnt := InvAmnt - ServOrderRec."Invoice Base Amount Material"
              ELSE
                InvAmnt := InvAmnt - AmntMaterial;
            END;
          END;
        END;

        IF ServOrderRec."Invoice Base Method" = ServOrderRec."Invoice Base Method"::"total>base" THEN BEGIN
          IF ServOrderRec."Invoice Base Amount Labor" >= AmntLabor THEN  //db, 09-05-08: M11378
            InvAmnt := InvAmnt - AmntLabor;
          IF ServOrderRec."Invoice Base Amount Material" >= AmntMaterial THEN
            InvAmnt := InvAmnt - AmntMaterial;
          IF ServOrderRec."Invoice Base Amount Total" >= AmntTotal THEN
            IF (ServOrderRec."Invoice Base Amount Labor" +
                ServOrderRec."Invoice Base Amount Material" <>
                ServOrderRec."Invoice Base Amount Total") THEN
              InvAmnt := InvAmnt - AmntTotal;
        END;

        IF InvAmnt = 0 THEN EXIT;

        CostPlusRec.INIT;
        CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
        CostPlusRec."Line No." := LastLino + 10000;
        CostPlusRec.INSERT(TRUE);
        CostPlusRec."Cost Object" := DimValRec.Code;
        CostPlusRec.Description := DimValRec.Name;
        CostPlusRec."Description 2" := '';
        IF InvHrs > ServOrderRec."Invoice Base Hours" THEN
          IF CostPlusRec."Description 2" = '' THEN
            CostPlusRec."Description 2" := ServOrderRec.FIELDCAPTION("Invoice Base Hours") + '=' +
              STRSUBSTNO('%1', ServOrderRec."Invoice Base Hours");
        IF AmntLabor > ServOrderRec."Invoice Base Amount Labor" THEN
          IF CostPlusRec."Description 2" = '' THEN
            CostPlusRec."Description 2" := ServOrderRec.FIELDCAPTION("Invoice Base Amount Labor") + '=' +
              STRSUBSTNO('%1', ServOrderRec."Invoice Base Amount Labor");
        IF AmntMaterial > ServOrderRec."Invoice Base Amount Material" THEN
          IF CostPlusRec."Description 2" = '' THEN
            CostPlusRec."Description 2" := ServOrderRec.FIELDCAPTION("Invoice Base Amount Material") + '=' +
              STRSUBSTNO('%1', ServOrderRec."Invoice Base Amount Material");
        IF AmntTotal > ServOrderRec."Invoice Base Amount Total" THEN
          IF CostPlusRec."Description 2" = '' THEN
            CostPlusRec."Description 2" := ServOrderRec.FIELDCAPTION("Invoice Base Amount Total") + '=' +
              STRSUBSTNO('%1', ServOrderRec."Invoice Base Amount Total");
        CostPlusRec.Quantity := 1;
        CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
        CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
        CostPlusRec.VALIDATE("Basic Price (LCY)", InvAmnt);
        CostPlusRec."Sales Price (LCY)" := CostPlusRec."Basic Price (LCY)";
        CostPlusRec."Invoice Price (LCY)" := CostPlusRec."Basic Price (LCY)";
        CostPlusRec.VALIDATE("Discount % (ServOrder)", 0);
        CostPlusRec.CalculateSalesPriceFromLCY; // dp00116.n
        CostPlusRec.CalculateInvoicePriceFromLCY; // dp00116.n
        IF IForceChargeable THEN
          CostPlusRec.Chargeable := TRUE;
        CostPlusRec.MODIFY;
      END ELSE BEGIN // Invoice Base via Service Contract Discount Terms
        IF ServOrderRec."Service Contract No." = '' THEN
          EXIT;

        ServicePackage := CostPlusRec.GetServicePackage();
        ServiceContractDiscountTerm.SETRANGE("Service Contract No.", ServOrderRec."Service Contract No.");
        ServiceContractDiscountTerm.SETRANGE("Service Package", ServicePackage);
        ServiceContractDiscountTerm.SETRANGE(Level, ServiceContractDiscountTerm.Level::"Base Service Order");
        ServiceContractDiscountTerm.SETFILTER("Invoice Base Method", '<>%1', ServiceContractDiscountTerm."Invoice Base Method"::" ");
        ServiceContractDiscountTerm.SETRANGE("Source Type", ServOrderRec."Source Type");
        FOR CostTypeMethod := CostTypeMethod::"Specific Cost Type" TO CostTypeMethod::"All Cost Types" DO BEGIN
          CASE CostTypeMethod OF
            CostTypeMethod::"Specific Cost Type":
              ServiceContractDiscountTerm.SETFILTER("Cost Type", '<>%1', ServiceContractDiscountTerm."Cost Type"::" ");
            CostTypeMethod::"All Cost Types":
              ServiceContractDiscountTerm.SETRANGE("Cost Type", ServiceContractDiscountTerm."Cost Type"::" ");
          END;
          IF ServiceContractDiscountTerm.FINDSET THEN
            REPEAT
              DummyCostPlusRec."Service Order No." := "Service Order No.";
              InFilterGroup :=
                IsInFilterGroup(Rec, ServiceContractDiscountTerm."Filter Group") AND
                IsInFilterGroup(Rec, ServiceContractDiscountTerm."Filter Group 2");
              IF ((ServiceContractDiscountTerm."Filter Groups Method" =
                    ServiceContractDiscountTerm."Filter Groups Method"::Exclude) AND
                    NOT InFilterGroup) OR
                  ((ServiceContractDiscountTerm."Filter Groups Method" =
                    ServiceContractDiscountTerm."Filter Groups Method"::Include) AND
                   InFilterGroup)
              THEN BEGIN
                InvAmnt := 0;
                CASE ServiceContractDiscountTerm."Invoice Base Method" OF
                  ServiceContractDiscountTerm."Invoice Base Method"::"total-base":
                    BEGIN
                      CASE ServiceContractDiscountTerm."Cost Type" OF
                        ServiceContractDiscountTerm."Cost Type"::" ":
                          IF AmntTotal > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntTotal;
                        ServiceContractDiscountTerm."Cost Type"::Material:
                          IF AmntMaterial > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntMaterial;
                        ServiceContractDiscountTerm."Cost Type"::Labor:
                          IF AmntLabor > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntLabor;
                        ServiceContractDiscountTerm."Cost Type"::Subcontracting:
                          IF AmntSubcontracting > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntSubcontracting;
                        ServiceContractDiscountTerm."Cost Type"::Plant:
                          IF AmntPlant > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntPlant;
                        ServiceContractDiscountTerm."Cost Type"::Sundry:
                          IF AmntSundry > ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= ServiceContractDiscountTerm."Invoice Base"
                          ELSE
                            InvAmnt -= AmntSundry;
                      END;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method"::"total>base":
                    BEGIN
                      CASE ServiceContractDiscountTerm."Cost Type" OF
                        ServiceContractDiscountTerm."Cost Type"::" ":
                          IF AmntTotal <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntTotal;
                        ServiceContractDiscountTerm."Cost Type"::Material:
                          IF AmntMaterial <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntMaterial;
                        ServiceContractDiscountTerm."Cost Type"::Labor:
                          BEGIN
                            IF AmntLabor <= ServiceContractDiscountTerm."Invoice Base" THEN
                              InvAmnt -= AmntLabor;
                            IF InvHrs <= ServiceContractDiscountTerm."Invoice Base Quantity" THEN
                              InvAmnt -= AmntLabor;
                          END;
                        ServiceContractDiscountTerm."Cost Type"::Subcontracting:
                          IF AmntSubcontracting <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSubcontracting;
                        ServiceContractDiscountTerm."Cost Type"::Plant:
                          IF AmntPlant <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntPlant;
                        ServiceContractDiscountTerm."Cost Type"::Sundry:
                          IF AmntSundry <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSundry;
                      END;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method"::"total<base":
                    BEGIN
                      CASE ServiceContractDiscountTerm."Cost Type" OF
                        ServiceContractDiscountTerm."Cost Type"::" ":
                          IF AmntTotal >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntTotal;
                        ServiceContractDiscountTerm."Cost Type"::Material:
                          IF AmntMaterial >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntMaterial;
                        ServiceContractDiscountTerm."Cost Type"::Labor:
                          BEGIN
                            IF AmntLabor >= ServiceContractDiscountTerm."Invoice Base" THEN
                              InvAmnt -= AmntLabor;
                            IF InvHrs >= ServiceContractDiscountTerm."Invoice Base Quantity" THEN
                              InvAmnt -= AmntLabor;
                          END;
                        ServiceContractDiscountTerm."Cost Type"::Subcontracting:
                          IF AmntSubcontracting >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSubcontracting;
                        ServiceContractDiscountTerm."Cost Type"::Plant:
                          IF AmntPlant >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntPlant;
                        ServiceContractDiscountTerm."Cost Type"::Sundry:
                          IF AmntSundry >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSundry;
                      END;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method"::"base when total>base":
                    BEGIN
                      CASE ServiceContractDiscountTerm."Cost Type" OF
                        ServiceContractDiscountTerm."Cost Type"::" ":
                          IF AmntTotal >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntTotal - ServiceContractDiscountTerm."Invoice Base";
                        ServiceContractDiscountTerm."Cost Type"::Material:
                          IF AmntMaterial >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntMaterial - ServiceContractDiscountTerm."Invoice Base";
                        ServiceContractDiscountTerm."Cost Type"::Labor:
                          BEGIN
                            IF (AmntLabor >= ServiceContractDiscountTerm."Invoice Base") AND (ServiceContractDiscountTerm."Invoice Base" <> 0) THEN
                              InvAmnt -= AmntLabor - ServiceContractDiscountTerm."Invoice Base";
                            IF (InvHrs >= ServiceContractDiscountTerm."Invoice Base Quantity") AND (ServiceContractDiscountTerm."Invoice Base Quantity" <> 0) THEN
                              IF InvHrs <> 0 THEN
                                InvAmnt -= (InvHrs - ServiceContractDiscountTerm."Invoice Base Quantity") * (AmntLabor / InvHrs);
                          END;
                        ServiceContractDiscountTerm."Cost Type"::Subcontracting:
                          IF AmntSubcontracting >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSubcontracting - ServiceContractDiscountTerm."Invoice Base";
                        ServiceContractDiscountTerm."Cost Type"::Plant:
                          IF AmntPlant >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntPlant - ServiceContractDiscountTerm."Invoice Base";
                        ServiceContractDiscountTerm."Cost Type"::Sundry:
                          IF AmntSundry >= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt -= AmntSundry - ServiceContractDiscountTerm."Invoice Base";
                      END;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method"::"base when total<base":
                    BEGIN
                      CASE ServiceContractDiscountTerm."Cost Type" OF
                        ServiceContractDiscountTerm."Cost Type"::" ":
                          IF AmntTotal <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntTotal;
                        ServiceContractDiscountTerm."Cost Type"::Material:
                          IF AmntMaterial <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntMaterial;
                        ServiceContractDiscountTerm."Cost Type"::Labor:
                          BEGIN
                            IF AmntLabor <= ServiceContractDiscountTerm."Invoice Base" THEN
                              InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntLabor;
                            IF InvHrs <= ServiceContractDiscountTerm."Invoice Base Quantity" THEN
                              IF InvHrs <> 0 THEN
                                InvAmnt += (ServiceContractDiscountTerm."Invoice Base Quantity" - InvHrs) * (AmntLabor / InvHrs);
                          END;
                        ServiceContractDiscountTerm."Cost Type"::Subcontracting:
                          IF AmntSubcontracting <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntSubcontracting;
                        ServiceContractDiscountTerm."Cost Type"::Plant:
                          IF AmntPlant <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntPlant;
                        ServiceContractDiscountTerm."Cost Type"::Sundry:
                          IF AmntSundry <= ServiceContractDiscountTerm."Invoice Base" THEN
                            InvAmnt += ServiceContractDiscountTerm."Invoice Base" - AmntSundry;
                      END;
                    END;
                END;
                IF CostTypeMethod = CostTypeMethod::"Specific Cost Type" THEN
                  AmntTotal += InvAmnt;
                IF InvAmnt <> 0 THEN BEGIN
                  CostPlusRec.INIT;
                  CostPlusRec.VALIDATE("Service Order No.", ServOrderRec."No.");
                  CostPlusRec."Line No." := LastLino + 10000;
                  CostPlusRec.INSERT(TRUE);
                  CostPlusRec."Cost Object" := DimValRec.Code;
                  CostPlusRec.Description := ServiceContractDiscountTerm.Description;
                  CostPlusRec."Description 2" := '';
                  CostPlusRec.Quantity := 1;
                  CostPlusRec."Unit of Measure" := DimValRec."Unit of Measure";
                  CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
                  CostPlusRec.VALIDATE("Basic Price (LCY)", InvAmnt);
                  CostPlusRec."Sales Price (LCY)" := CostPlusRec."Basic Price (LCY)";
                  CostPlusRec."Invoice Price (LCY)" := CostPlusRec."Basic Price (LCY)";
                  CostPlusRec."Discount Term Level" := ServiceContractDiscountTerm.Level +1;
                  CostPlusRec."Service Package" := ServiceContractDiscountTerm."Service Package";
                  CostPlusRec."Discount Term Line No." := ServiceContractDiscountTerm."Line No.";
                  CostPlusRec.VALIDATE("Discount % (ServOrder)", 0);
                  CostPlusRec.CalculateSalesPriceFromLCY;
                  CostPlusRec.CalculateInvoicePriceFromLCY;
                  IF IForceChargeable THEN
                    CostPlusRec.Chargeable := TRUE;
                  CostPlusRec.MODIFY;
                END;
              END;
            UNTIL ServiceContractDiscountTerm.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE CheckInstallment@1210190007(ServOrderNew@1210190003 : Record 11012823;ServOrderOld@1210190004 : Record 11012823);
    VAR
      ServSetup@1100525000 : Record 11012800;
      CostPlusRec@1210190000 : Record 11012825;
      InstallmentRec@1210190002 : Record 11012017;
      LastLino@1210190001 : Integer;
      lvInvoiced@1100485000 : Decimal;
      lvOrderAmnt@1100485001 : Decimal;
      lvLineAmnt@1100485003 : Decimal;
      lvOpenLine@1100485002 : Integer;
    BEGIN
      //function used when order amount or installment scheme changes on service order.
      //db, 06-11-07: methode revise (call 10237)

      ServSetup.GET;
      ServSetup.TESTFIELD("Cost Object Revenues");

      ServOrderNew.CheckStatus(1);

      WITH ServOrderOld DO BEGIN
        IF "Installment Scheme" <> '' THEN BEGIN
          CostPlusRec.RESET;
          CostPlusRec.SETRANGE("Service Order No.", "No.");
          CostPlusRec.SETRANGE("Installment Scheme", "Installment Scheme");
          CostPlusRec.SETFILTER("Installment No.", '<>%1', '');
          IF NOT CostPlusRec.ISEMPTY THEN BEGIN
            IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
              REPEAT
                CostPlusRec.CALCFIELDS("Invoiced Price (LCY)", "Invoice in Process (LCY)", "Credit Memo in Process (LCY)");
                lvInvoiced := lvInvoiced + CostPlusRec."Invoiced Price (LCY)" +
                  CostPlusRec."Invoice in Process (LCY)" + CostPlusRec."Credit Memo in Process (LCY)";
                //db.sn, 06-11-07
                //IF (CostPlusRec."Invoiced Price" = 0) AND
                //   (CostPlusRec."Invoice in Process" = 0) AND
                //   (CostPlusRec."Credit Memo in Process" = 0) THEN
                // CostPlusRec.DELETE;
                IF CostPlusRec."Installment No." <> '' THEN
                  lvLineAmnt := lvLineAmnt + CostPlusRec."Basic Price (LCY)";
                //db.en, 06-11-07
              UNTIL CostPlusRec.NEXT = 0;
              IF lvInvoiced = 0 THEN CostPlusRec.DELETEALL;
            END;
          END;
        END;
      END;

      WITH ServOrderNew DO BEGIN
        IF "Installment Scheme" <> '' THEN BEGIN
          CostPlusRec.RESET;
          CostPlusRec.SETRANGE("Service Order No.", "No.");
          IF CostPlusRec.FINDLAST THEN
            LastLino := CostPlusRec."Line No."
          ELSE
            LastLino := 0;

          lvOrderAmnt := "Order Amount (LCY)" - lvInvoiced;
          IF lvInvoiced <> 0 THEN BEGIN
            //db.sn, 06-11-07
            IF ServOrderNew."Installment Scheme" <> ServOrderOld."Installment Scheme" THEN
              ERROR(Text007, lvInvoiced)
            ELSE
              MESSAGE(Text007, lvInvoiced);

            CostPlusRec.RESET;
            CostPlusRec.SETRANGE("Service Order No.", "No.");
            CostPlusRec.SETRANGE("Installment Scheme", "Installment Scheme");
            CostPlusRec.SETFILTER("Installment No.", '%1', '');
            IF NOT CostPlusRec.ISEMPTY THEN BEGIN
              IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
                REPEAT
                  CostPlusRec.CALCFIELDS("Invoiced Price (LCY)", "Invoice in Process (LCY)", "Credit Memo in Process (LCY)");
                  IF (CostPlusRec."Invoiced Price (LCY)" = 0) AND
                     (CostPlusRec."Invoice in Process (LCY)" = 0) AND
                     (CostPlusRec."Credit Memo in Process (LCY)" = 0) THEN
                    lvOpenLine := CostPlusRec."Line No.";
                UNTIL (CostPlusRec.NEXT = 0) OR (lvOpenLine <> 0);
              END;
            END;

            IF lvOpenLine = 0 THEN BEGIN
              CostPlusRec.INIT;
              CostPlusRec.VALIDATE("Service Order No.", "No.");
              CostPlusRec."Line No." := LastLino + 10000;
              CostPlusRec.INSERT(TRUE);
              //db.sn, 22-10-08: M12908
              CostPlusRec."Cost Object" := ServSetup."Cost Object Revenues";
              DimMgt.GetDimValueRec(2, CostPlusRec."Cost Object", DimValRec, TRUE,'');
              CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
              CostPlusRec.Description := DimValRec.Name;
              //db.en, 22-10-08: M12908
            END ELSE BEGIN
              CostPlusRec.GET("No.", lvOpenLine);
            END;

            CostPlusRec.Quantity := 1;
            CostPlusRec."Basic Price (LCY)" := ServOrderNew."Order Amount (LCY)" - lvLineAmnt;
            CostPlusRec."Sales Price (LCY)" := CostPlusRec."Basic Price (LCY)";
            CostPlusRec."Invoice Price (LCY)" := CostPlusRec."Basic Price (LCY)";
            // dp00116.sn
            CostPlusRec.CalculateBasicPriceFromLCY;
            CostPlusRec.CalculateSalesPriceFromLCY;
            CostPlusRec.CalculateInvoicePriceFromLCY;
            // dp00116.en
            CostPlusRec."Installment Scheme" := "Installment Scheme";
            CostPlusRec."Installment No." := '';
            CostPlusRec.DetermineChargeable;
            IF ServSetup."Release CPE CntrAmnt Mandatory" = TRUE THEN
              CostPlusRec.Chargeable := FALSE;
            IF CostPlusRec."Basic Price (LCY)" = 0 THEN
              CostPlusRec.DELETE
            ELSE
              CostPlusRec.MODIFY;
            LastLino := CostPlusRec."Line No.";

            IF ServOrderNew."Installment Scheme" = ServOrderOld."Installment Scheme" THEN EXIT;
            //db.en, 06-11-07
          END;

          InstallmentRec.SETRANGE(Scheme, "Installment Scheme");
          IF InstallmentRec.FINDSET THEN BEGIN
            REPEAT
              CostPlusRec.INIT;
              CostPlusRec.VALIDATE("Service Order No.", "No.");
              CostPlusRec."Line No." := LastLino + 10000;
              CostPlusRec.INSERT(TRUE);
              //db.sn, 22-10-08: M12908
              IF InstallmentRec."Cost Object" <> '' THEN
                CostPlusRec."Cost Object" := InstallmentRec."Cost Object"
              ELSE
                CostPlusRec."Cost Object" := ServSetup."Cost Object Revenues";
              DimMgt.GetDimValueRec(2, CostPlusRec."Cost Object", DimValRec, TRUE,'');
              CostPlusRec.VALIDATE("Cost Component", DimValRec."Cost Component");
              CostPlusRec.Description := InstallmentRec.Description;
              //db.en, 22-10-08: M12908
              CostPlusRec.Quantity := 1;
              CostPlusRec."Basic Price (LCY)" := ROUND(InstallmentRec.Percentage/100 * lvOrderAmnt, 0.01);
              CostPlusRec."Sales Price (LCY)" := CostPlusRec."Basic Price (LCY)";
              CostPlusRec."Invoice Price (LCY)" := CostPlusRec."Basic Price (LCY)";
              // dp00116.sn
              CostPlusRec.CalculateBasicPriceFromLCY;
              CostPlusRec.CalculateSalesPriceFromLCY;
              CostPlusRec.CalculateInvoicePriceFromLCY;
              // dp00116.en
              CostPlusRec."Installment Scheme" := "Installment Scheme";
              CostPlusRec."Installment No." := InstallmentRec."Installment No.";
              CostPlusRec.DetermineChargeable;
              IF ServSetup."Release CPE CntrAmnt Mandatory" = TRUE THEN
                CostPlusRec.Chargeable := FALSE;
              CostPlusRec.MODIFY;

              LastLino := CostPlusRec."Line No.";
            UNTIL InstallmentRec.NEXT = 0;
          END;
        END;
      END;
    END;

    PROCEDURE CheckWarrantyDiscount@1210190009(lvCode@1210190000 : Code[10];lvStartDate@1210190001 : Date;lvEndDate@1210190002 : Date);
    BEGIN
      //db, 23-05-08: M10502
      IF ServWarrantyRec.GET(lvCode) THEN BEGIN
        IF ("Posting Date" >= lvStartDate) AND
           ("Posting Date" <= lvEndDate) THEN BEGIN
          IF (ServWarrantyRec."Cost Type" - 1 = "Cost Type") OR
             (ServWarrantyRec."Cost Type" = ServWarrantyRec."Cost Type"::" ") THEN BEGIN
            "Discount % (Warranty)" := ServWarrantyRec.Percentage;
            "Warranty Code" := ServWarrantyRec.Code;
          END;
        END;
      END;
    END;

    PROCEDURE CheckObject@1210190002();
    BEGIN
      //db, 16-02-09
    END;

    PROCEDURE CheckInstallmentScheme@1210190010(lvAction@1210190002 : Integer);
    VAR
      CostPlusRec@1210190000 : Record 11012825;
      InstAmnt@1210190001 : Decimal;
    BEGIN
      IF "Installment Scheme" = '' THEN EXIT;

      InstAmnt := 0;
      CostPlusRec.RESET;
      CostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
      CostPlusRec.SETRANGE("Installment Scheme", "Installment Scheme");
      IF CostPlusRec.FINDSET THEN BEGIN
        REPEAT
          IF lvAction = 1 THEN
            IF CostPlusRec."Line No." = "Line No." THEN
              InstAmnt := InstAmnt + "Invoice Price (LCY)"
            ELSE
              InstAmnt := InstAmnt + CostPlusRec."Invoice Price (LCY)";
          IF lvAction = 2 THEN
            IF CostPlusRec."Line No." <> "Line No." THEN
              InstAmnt := InstAmnt + CostPlusRec."Invoice Price (LCY)";
        UNTIL CostPlusRec.NEXT = 0;
      END;

      ServOrderRec.GET("Service Order No.");
      IF ServOrderRec."Order Amount (LCY)" <> InstAmnt THEN
        MESSAGE(Text005, InstAmnt, ServOrderRec."Order Amount (LCY)");
    END;

    PROCEDURE HandleLookupUnit@1210190004();
    VAR
      ItemUnitRec@1210190000 : Record 5404;
      lvUnit@1210190001 : Code[10];
    BEGIN
      lvUnit := ItemUnitRec.HandleLookupUnit("Item No.", "Basic Item", "Trade Item", Manufacturer, "Vendor (Trade Item)");
      IF (lvUnit <> '') AND (lvUnit <> "Unit of Measure") THEN BEGIN
        xRec."Unit of Measure" := "Unit of Measure";  //db, 01-07-04: standard bug
        VALIDATE("Unit of Measure", lvUnit);
      END;
    END;

    PROCEDURE CheckItemUnitConversion@1210190013(VAR MainNewRec@1210190006 : Record 11012825;MainOldRec@1210190007 : Record 11012825);
    VAR
      ItemRec@1210190004 : Record 27;
      UnitFactor@1210190005 : Decimal;
      UnitFactorOld@1210190003 : Decimal;
      UnitFactorNew@1210190002 : Decimal;
      UnitControl@1210190001 : Codeunit 5402;
    BEGIN
      WITH MainNewRec DO BEGIN
        UnitFactorOld := 1;
        UnitFactorNew := 1;
        ValidateCu.SkipErrorUnitConversion(CurrFieldNo=0);  //db, 21-03-13: C002191
        IF "Trade Item" <> '' THEN BEGIN
          ValidateCu.ValidateUnit(ItemTypeOpt::"Trade Item",
            "Item No.","Basic Item","Trade Item",Manufacturer,"Vendor (Trade Item)",
            Quantity,"Unit of Measure",UnitFactorNew);
        END ELSE BEGIN
          IF "Basic Item" <> '' THEN BEGIN
            ValidateCu.ValidateUnit(ItemTypeOpt::"Basic Item",
              "Item No.","Basic Item","Trade Item",Manufacturer,"Vendor (Trade Item)",
              Quantity,"Unit of Measure",UnitFactorNew);
          END ELSE BEGIN  //db, 07-04-08: M10070
            IF "Item No." <> '' THEN BEGIN
              ItemRec.GET("Item No.");
              UnitFactorOld := UnitControl.GetQtyPerUnitOfMeasure(ItemRec, MainOldRec."Unit of Measure");
              UnitFactorNew := UnitControl.GetQtyPerUnitOfMeasure(ItemRec, "Unit of Measure");
              UnitFactor := UnitFactorOld;
              ValidateCu.ValidateUnit(ItemTypeOpt::Item,
                "Item No.","Basic Item","Trade Item",Manufacturer,"Vendor (Trade Item)",
                Quantity,"Unit of Measure",UnitFactor);
            END;
          END;
        END;
        IF (UnitFactorNew <> 0) AND
           (UnitFactorOld <> 0) AND
           (UnitFactorNew <> UnitFactorOld) THEN BEGIN //db, 02-03-10: M18270
          GlSetupRec.GET;
          GlSetupRec.TESTFIELD("Unit-Amount Rounding Precision");
          IF "Gross Price (LCY)" <> 0 THEN BEGIN
            VALIDATE("Gross Price (LCY)", ROUND("Gross Price (LCY)" * UnitFactorNew / UnitFactorOld,
              GlSetupRec."Unit-Amount Rounding Precision"))
          END ELSE BEGIN
            VALIDATE("Basic Price (LCY)", ROUND("Basic Price (LCY)" * UnitFactorNew / UnitFactorOld,
              GlSetupRec."Unit-Amount Rounding Precision"))
          END;
        END;
      END;
    END;

    PROCEDURE AddDateToDescription@1100485000(lDate@1100485001 : Date);
    VAR
      ServSetup@1100525000 : Record 11012800;
      DateTxt@1100485000 : Text[30];
    BEGIN
      IF (lDate = 0D) OR (Description = '') THEN
        EXIT;

      ServSetup.GET;

      IF NOT ServSetup."Add Entry Posting Date to CPE" THEN
        EXIT;

      CALCFIELDS("Cost Type");
      IF "Cost Type" <> "Cost Type"::Labor THEN
        EXIT;

      DateTxt := STRSUBSTNO(' %1', lDate);

      IF STRLEN(Description + DateTxt) > MAXSTRLEN(Description) THEN
        Description := COPYSTR(Description, 1, MAXSTRLEN(Description) - STRLEN(DateTxt));

      Description := Description + DateTxt;
    END;

    PROCEDURE SetInvoiceStatus@1100485001(VAR ServCostPlus@1100525000 : Record 11012825);
    VAR
      CostPlusRec@1100485000 : Record 11012825;
    BEGIN
      CostPlusRec.COPY(ServCostPlus);
      CostPlusRec.SETRANGE(Chargeable, FALSE);
      CostPlusRec.SETRANGE(Invoiced, FALSE);
      IF NOT CostPlusRec.ISEMPTY THEN BEGIN
        IF CostPlusRec.FINDSET(TRUE, FALSE) THEN BEGIN
          REPEAT
            CostPlusRec.VALIDATE(Chargeable, TRUE);
            CostPlusRec.MODIFY;
          UNTIL CostPlusRec.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE DetermineChargeable@1100485003();
    VAR
      ServSetup@1100525000 : Record 11012800;
    BEGIN
      //T003311
      IF SkipDetermineChargeable THEN
        EXIT;
      //

      IF "Installment Scheme" = '' THEN BEGIN
        IF NOT ServOrderRec.GET("Service Order No.") THEN
          EXIT;
        IF ServOrderRec."Settlement Method" = ServOrderRec."Settlement Method"::"Fixed Price" THEN
          EXIT;
      END;

      ServSetup.GET;
      CASE ServSetup."Release CPE Mandatory" OF
        ServSetup."Release CPE Mandatory"::No:
          Chargeable := TRUE;
        ServSetup."Release CPE Mandatory"::Yes:
          Chargeable := FALSE;
        ServSetup."Release CPE Mandatory"::"At 100% Discount":
          Chargeable := "Discount % (ServOrder)" <> 100;
      END;
    END;

    PROCEDURE Navigate@1100485005();
    VAR
      NavigateForm@1000 : Page 344;
    BEGIN
      NavigateForm.SetDoc(0D,"Source Document");
      NavigateForm.RUN;
    END;

    PROCEDURE CalculateGrossPrice@1100485006(lvPrice@1100485000 : Decimal;lvDisc@1100485001 : Decimal);
    BEGIN
      //db, 05-12-07 (call 7913 + 10572)
      IF lvDisc <> 100 THEN BEGIN
        "Gross Price (LCY)" := lvPrice * 100 / (100 - lvDisc);
        CalculateGrossPriceFromLCY; // dp00116.n
      END;
    END;

    PROCEDURE DetermineRemovalContribution@1100485007(IForceChargeable@1100528600 : Boolean);
    VAR
      lvCostPlusRec@1100485007 : Record 11012825;
      lvSalesReceivablesSetup@1100525000 : Record 311;
    BEGIN
      lvCostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
      lvCostPlusRec.SETRANGE(Invoiced, FALSE);
      lvCostPlusRec.SETRANGE("Removal Contribution", TRUE);
      lvCostPlusRec.DELETEALL(TRUE);

      lvSalesReceivablesSetup.GET;                                       //CALL C025831 n
      IF NOT lvSalesReceivablesSetup."Charge Removal Contribution" THEN  //CALL C025831 n
        EXIT;                                                            //CALL C025831 n

      lvCostPlusRec.SETRANGE("Removal Contribution", FALSE);
      IF lvCostPlusRec.FINDSET(FALSE, FALSE) THEN BEGIN
        REPEAT
          DetermineRemovalContribLine(lvCostPlusRec, IForceChargeable);
        UNTIL lvCostPlusRec.NEXT = 0;
      END;
    END;

    PROCEDURE DetermineRemovalContribLine@1100525110(ServiceOrderCostPlusEntry@1100525000 : Record 11012825;IForceChargeable@1100528600 : Boolean);
    VAR
      lvCostPlusRec2@1100485008 : Record 11012825;
      lvItemRec@1100485001 : Record 27;
      lvTradeItemRec@1100485000 : Record 11012317;
      lvCostObject@1100485004 : Code[20];
      lvRemovalContribution@1100485005 : Decimal;
      lvUnitFactor@1100485002 : Decimal;
      UnitControl@1100485003 : Codeunit 5402;
    BEGIN
      lvCostObject := '';
      lvRemovalContribution := 0;

      IF ServiceOrderCostPlusEntry."Trade Item" <> '' THEN BEGIN
        IF lvTradeItemRec.GET(ServiceOrderCostPlusEntry."Vendor (Trade Item)", ServiceOrderCostPlusEntry."Trade Item") THEN BEGIN  //C024844
          lvCostObject := lvTradeItemRec."Cost Object (Removal)";
          lvRemovalContribution := lvTradeItemRec."Removal Contribution";
        END;
        IF lvRemovalContribution <> 0 THEN BEGIN
          lvTradeItemRec.TESTFIELD("Cost Object (Removal)");
          IF lvTradeItemRec."Application Unit" = ServiceOrderCostPlusEntry."Unit of Measure" THEN
            lvUnitFactor := 1
          ELSE
            lvUnitFactor := lvTradeItemRec."Qty. per Unit of Measure";
        END;
      END ELSE BEGIN
        IF ServiceOrderCostPlusEntry."Item No." <> '' THEN BEGIN
          IF lvItemRec.GET(ServiceOrderCostPlusEntry."Item No.") THEN BEGIN  //C024844
            lvCostObject := lvItemRec."Cost Object (Removal)";
            lvRemovalContribution := lvItemRec."Removal Contribution";
          END;
          IF lvRemovalContribution <> 0 THEN BEGIN
            lvItemRec.TESTFIELD("Cost Object (Removal)");
            lvUnitFactor := UnitControl.GetQtyPerUnitOfMeasure(lvItemRec, ServiceOrderCostPlusEntry."Unit of Measure");
          END;
        END;
      END;

      IF lvRemovalContribution <> 0 THEN BEGIN
        DimMgt.GetDimValueRec(2, lvCostObject, DimValRec, TRUE,'');
        lvCostPlusRec2.INIT;
        lvCostPlusRec2.VALIDATE("Service Order No.", ServiceOrderCostPlusEntry."Service Order No.");
        lvCostPlusRec2."Line No." := ServiceOrderCostPlusEntry."Line No.";
        REPEAT
          lvCostPlusRec2."Line No." := lvCostPlusRec2."Line No." + 1;
        UNTIL lvCostPlusRec2.INSERT(TRUE);

        lvCostPlusRec2."Service Location No." := ServiceOrderCostPlusEntry."Service Location No.";
        lvCostPlusRec2."Cost Object" := DimValRec.Code;
        lvCostPlusRec2.Description := DimValRec.Name;
        lvCostPlusRec2.Quantity := ServiceOrderCostPlusEntry.Quantity * lvUnitFactor;
        lvCostPlusRec2."Unit of Measure" := DimValRec."Unit of Measure";
        lvCostPlusRec2.VALIDATE("Cost Component", DimValRec."Cost Component");
        lvCostPlusRec2."Basic Price (LCY)" := lvRemovalContribution;
        lvCostPlusRec2.CalculateBasicPriceFromLCY; // dp00116.n
        lvCostPlusRec2.VALIDATE("Surcharge %", 0);  //db, 26-11-09: M17166
        lvCostPlusRec2."Sales Price (LCY)" := lvCostPlusRec2."Basic Price (LCY)" * (1 + lvCostPlusRec2."Surcharge %"/100);
        lvCostPlusRec2.CalculateSalesPriceFromLCY; // dp00116.n
        lvCostPlusRec2.GetDiscountPerc;
        lvCostPlusRec2."Posting Date" := ServiceOrderCostPlusEntry."Posting Date";
        lvCostPlusRec2."Additional Cost" := ServiceOrderCostPlusEntry."Additional Cost";
        lvCostPlusRec2."VAT Prod. Posting Group" := ServiceOrderCostPlusEntry."VAT Prod. Posting Group";
        lvCostPlusRec2."Removal Contribution" := TRUE;
        lvCostPlusRec2."Attached to Line No. (RC)" := ServiceOrderCostPlusEntry."Line No.";  //db, 22-10-09: M16544
        lvCostPlusRec2.Chargeable := ServiceOrderCostPlusEntry.Chargeable;  //C024476
        IF IForceChargeable THEN
          lvCostPlusRec2.Chargeable := TRUE;
        lvCostPlusRec2.MODIFY;
      END;
    END;

    PROCEDURE GetCostPrice@1100485008();
    VAR
      lvHourLineRec@1100485000 : Record 11012039;
    BEGIN
      IF ("Entry No. Service Ledger" = 0) AND NOT "FSA-Created Entry" THEN
        EXIT;

      IF ("Employee No." <> xRec."Employee No.") OR
         ("Service Order No." <> xRec."Service Order No.") OR
         ("Service Contract No." <> xRec."Service Contract No.") OR
         ("Hour Rate Code" <> xRec."Hour Rate Code") OR
         ("Wage Component" <> xRec."Wage Component") OR
         ("Cost Component" <> xRec."Cost Component") OR
         ("Cost Object" <> xRec."Cost Object") THEN
      BEGIN
        lvHourLineRec.INIT;
        lvHourLineRec.Type := lvHourLineRec.Type::Service;
        lvHourLineRec."Employee No." := "Employee No.";
        lvHourLineRec."Service Order No." := "Service Order No.";
        lvHourLineRec."Service Contract No." := "Service Contract No.";
        lvHourLineRec."Posting Date" := TODAY;  //instead of "Posting Date";
        //lvHourLineRec."Plant Rate Code" := "Hour Rate Code"; //* "Hour Rate Code" is not the same as "Plant Rate Code"
        lvHourLineRec."Wage Component" := "Wage Component";
        lvHourLineRec."Cost Component" := "Cost Component";
        lvHourLineRec."Cost Object" := "Cost Object";
        lvHourLineRec."Cost Type" := lvHourLineRec."Cost Type"::Labor;
        IF EmplRec.GET("Employee No.") THEN
          lvHourLineRec.External := EmplRec.External;
        lvHourLineRec.CalcRateAndAmount;
        "Cost Price (LCY)" := lvHourLineRec."Unit Cost (LCY)";
        CalculateCostPriceFromLCY; // dp00116.n
      END;
    END;

    PROCEDURE CheckSourceDocument@1100485009();
    VAR
      lvHourLineRec@1100485000 : Record 11012039;
      lvPurchLineRec@1100485001 : Record 39;
    BEGIN
      IF ("Source Document" = '') OR ("Source Line" = 0) THEN EXIT;

      CALCFIELDS("Cost Type");
      IF "Cost Type" = "Cost Type"::Labor THEN BEGIN
        lvHourLineRec.SETCURRENTKEY("Document No.", "Employee No.");
        lvHourLineRec.SETRANGE("Document No.", "Source Document");
        lvHourLineRec.SETRANGE("Line No.", "Source Line");
        lvHourLineRec.SETRANGE("Employee No.", "Employee No.");
        lvHourLineRec.MODIFYALL("Cost Plus Entry Created", FALSE);
      END ELSE BEGIN
        lvPurchLineRec.SETRANGE("Document Type", lvPurchLineRec."Document Type"::Order);
        lvPurchLineRec.SETRANGE("Document No.", "Source Document");
        lvPurchLineRec.SETRANGE("Line No.", "Source Line");
        lvPurchLineRec."Modified by" := USERID; //DP00469
        lvPurchLineRec."Last Date Modified" := TODAY;//DP00469
        lvPurchLineRec.MODIFYALL("Cost Plus Entry Created", FALSE);
      END;
    END;

    PROCEDURE GetContractDiscount@1100485014();
    VAR
      ServiceSetup@1100528607 : Record 11012800;
      ServiceOrder@1100528606 : Record 11012823;
      ServiceContractDiscountTerm@1100528605 : Record 11012828;
      ContractObject@1100528604 : Record 11071702;
      StartDate@1100528603 : Date;
      EndDate@1100528602 : Date;
      ServicePackage@1100528601 : Code[10];
      InFilterGroup@1100528600 : Boolean;
    BEGIN
      CALCFIELDS("Service Contract No.");
      IF "Service Contract No." = '' THEN
        IF OverruleServiceContractNo = '' THEN
          EXIT
        ELSE
          "Service Contract No." := OverruleServiceContractNo;
      ServContractRec.GET("Service Contract No.");
      ServContractRec.TESTFIELD("Starting Date");

      ServiceSetup.GET;
      IF NOT ServiceOrder.GET("Service Order No.") THEN
        ServiceOrder.INIT;

      IF ServiceOrder."Charge Vendor (Warranty)" THEN
        EXIT;

      ServiceContractDiscountTerm.SETRANGE("Service Contract No.", ServContractRec."No.");
      ServiceContractDiscountTerm.SETRANGE(Level, ServiceContractDiscountTerm.Level::Line);
      ServicePackage := GetServicePackage();
      IF ServicePackage = '' THEN
        EXIT;
      ServiceContractDiscountTerm.SETRANGE("Service Package", ServicePackage);

      IF ServiceSetup."Contract Discount Level" = ServiceSetup."Contract Discount Level"::SourceType THEN
        ServiceContractDiscountTerm.SETFILTER("Source Type", '%1|%2', ServiceContractDiscountTerm."Source Type"::None, ServiceOrder."Source Type");
      IF ServiceSetup."Contract Discount Level" = ServiceSetup."Contract Discount Level"::CostComponent THEN
        IF "Cost Component" <> '' THEN
          ServiceContractDiscountTerm.SETRANGE("Cost Component", "Cost Component");

      ServiceContractDiscountTerm.SETFILTER("Cost Type", '%1|%2', ServiceContractDiscountTerm."Cost Type"::" ", "Cost Type" +1);
      ServiceContractDiscountTerm.SETFILTER("Cost Object", '%1|%2', '', "Cost Object");

      IF ServiceSetup."Contract Discount Level" = ServiceSetup."Contract Discount Level"::SourceType THEN
        IF ServiceContractDiscountTerm.ISEMPTY THEN
          ServiceContractDiscountTerm.SETRANGE("Source Type", ServiceContractDiscountTerm."Source Type"::None);

      "Discount % (ServContr)" := 0;
      IF ServiceContractDiscountTerm.FINDSET THEN BEGIN
        REPEAT
          IF ServiceContractDiscountTerm."Starting Date Discount" <> 0D THEN
            StartDate := ServiceContractDiscountTerm."Starting Date Discount"
          ELSE
            IF ContractObject.GET(ServContractRec."No.", "Object No.") THEN
              StartDate := ContractObject."Starting Date"
            ELSE
              StartDate := ServContractRec."Starting Date";
          IF FORMAT(ServiceContractDiscountTerm."Discount Period") <> '' THEN
            EndDate := CALCDATE(ServiceContractDiscountTerm."Discount Period", StartDate)
          ELSE
            IF ContractObject.GET(ServContractRec."No.", "Object No.") THEN
              EndDate := ContractObject."Ending Date"
            ELSE
              EndDate := ServContractRec."Ending Date";

          IF ("Posting Date" >= StartDate) THEN
            IF ("Posting Date" <= EndDate) OR (EndDate = 0D) THEN BEGIN
              InFilterGroup :=
                IsInFilterGroup(Rec, ServiceContractDiscountTerm."Filter Group") AND
                IsInFilterGroup(Rec, ServiceContractDiscountTerm."Filter Group 2");
              IF (ServiceContractDiscountTerm.Percentage >= "Discount % (ServContr)") AND
                 (((ServiceContractDiscountTerm."Filter Groups Method" =
                    ServiceContractDiscountTerm."Filter Groups Method"::Exclude) AND
                    NOT InFilterGroup) OR
                   ((ServiceContractDiscountTerm."Filter Groups Method" =
                     ServiceContractDiscountTerm."Filter Groups Method"::Include) AND
                    InFilterGroup))
              THEN
                CASE TRUE OF
                  ServiceContractDiscountTerm."Invoice Base Method" =
                    ServiceContractDiscountTerm."Invoice Base Method"::" ":
                    BEGIN
                      "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method" =
                    ServiceContractDiscountTerm."Invoice Base Method"::"total>base":
                    BEGIN
                      IF ServiceContractDiscountTerm."Invoice Base" > 0 THEN
                        IF "Sales Price (LCY)" * Quantity <= ServiceContractDiscountTerm."Invoice Base" THEN
                          "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                      IF ServiceContractDiscountTerm."Invoice Base Quantity" > 0 THEN
                        IF Quantity <= ServiceContractDiscountTerm."Invoice Base Quantity" THEN
                          "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method" =
                    ServiceContractDiscountTerm."Invoice Base Method"::"total<base":
                    BEGIN
                      IF ServiceContractDiscountTerm."Invoice Base" > 0 THEN
                        IF "Sales Price (LCY)" * Quantity >= ServiceContractDiscountTerm."Invoice Base" THEN
                          "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                      IF ServiceContractDiscountTerm."Invoice Base Quantity" > 0 THEN
                        IF Quantity >= ServiceContractDiscountTerm."Invoice Base Quantity" THEN
                          "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                    END;
                  ServiceContractDiscountTerm."Invoice Base Method" =
                    ServiceContractDiscountTerm."Invoice Base Method"::"total-base":
                    BEGIN
                      IF (ServiceContractDiscountTerm."Invoice Base" = 0) AND
                         (ServiceContractDiscountTerm."Invoice Base Quantity" = 0) THEN
                      BEGIN
                        "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                      END ELSE BEGIN
                        CASE TRUE OF
                          (ServiceContractDiscountTerm."Invoice Base" > 0) AND
                          ("Sales Price (LCY)" * Quantity > ServiceContractDiscountTerm."Invoice Base"):
                            BEGIN
                              "Invoice Price (LCY)" := "Sales Price (LCY)" * Quantity - ServiceContractDiscountTerm."Invoice Base";
                              VALIDATE("Invoice Price (LCY)",
                                ROUND("Invoice Price (LCY)", GetRoundingFactor(RoundOption::Amount)));  //db, 17-02-14: C012946
                              "Discount % (ServContr)" := "Discount % (ServOrder)";
                            END;
                          (ServiceContractDiscountTerm."Invoice Base Quantity" > 0) AND
                          (Quantity > ServiceContractDiscountTerm."Invoice Base Quantity"):
                            BEGIN
                              "Invoice Price (LCY)" :=
                                "Sales Price (LCY)" * (Quantity - ServiceContractDiscountTerm."Invoice Base Quantity");
                              VALIDATE("Invoice Price (LCY)",
                                ROUND("Invoice Price (LCY)", GetRoundingFactor(RoundOption::Amount)));  //db, 17-02-14: C012946
                              "Discount % (ServContr)" := "Discount % (ServOrder)";
                            END
                        ELSE
                          "Discount % (ServContr)" := ServiceContractDiscountTerm.Percentage;
                        END;
                        CalculateInvoicePriceFromLCY;
                      END;

                    END;
                END;
            END;
          IF "Discount % (ServContr)" <> 0 THEN BEGIN
            "Discount Term Level" := ServiceContractDiscountTerm.Level +1;
            "Service Package" := ServiceContractDiscountTerm."Service Package";
            "Discount Term Line No." := ServiceContractDiscountTerm."Line No.";
          END;
        UNTIL ServiceContractDiscountTerm.NEXT = 0;
      END;
    END;

    PROCEDURE GetWarrantyDiscount@1100485011();
    VAR
      ServiceOrder@1100528600 : Record 11012823;
      ServiceObject@1100528601 : Record 11071691;
      ServWarrDiscountTerm@1100528602 : Record 11071811;
      BilltoVendorNo@1100525000 : Code[20];
    BEGIN
      IF NOT ServiceOrder.GET("Service Order No.") THEN
        ServiceOrder.INIT;

      "Discount % (Warranty)" := 0;
      IF ServiceObject.GET("Object No.") THEN BEGIN
        IF NOT ServiceObject.VendorWillBeCharged("Service Order No.", "Posting Date", BilltoVendorNo) THEN BEGIN
          IF (ServiceObject."Warranty Code Customer" <> '') AND (ServiceObject."Warranty Start Date Customer" <> 0D) THEN BEGIN
            ServWarrDiscountTerm.SETRANGE("Warranty Code", ServiceObject."Warranty Code Customer");
            IF ServWarrDiscountTerm.FINDSET THEN
              REPEAT
                IF ("Posting Date" >= ServiceObject."Warranty Start Date Customer") AND
                   ((FORMAT(ServWarrDiscountTerm.Period) = '') OR
                    ("Posting Date" <= CALCDATE(ServWarrDiscountTerm.Period, ServiceObject."Warranty Start Date Customer"))) AND
                   ((ServiceObject."Warranty Date Customer" = 0D) OR
                    ("Posting Date" <= ServiceObject."Warranty Date Customer")) AND
                   ((ServWarrDiscountTerm."Cost Type" = ServWarrDiscountTerm."Cost Type"::" ") OR
                    ("Cost Type" +1 = ServWarrDiscountTerm."Cost Type")) AND
                   (ServWarrDiscountTerm.Percentage > "Discount % (Warranty)")
                THEN
                  "Discount % (Warranty)" := ServWarrDiscountTerm.Percentage;
              UNTIL ServWarrDiscountTerm.NEXT = 0;
          END;
        END ELSE BEGIN
          IF (ServiceObject."Warranty Code Vendor" <> '') AND (ServiceObject."Warranty Start Date Vendor" <> 0D) THEN BEGIN
            ServWarrDiscountTerm.SETRANGE("Warranty Code", ServiceObject."Warranty Code Vendor");
            IF ServWarrDiscountTerm.FINDSET THEN
              REPEAT
                IF ("Posting Date" >= ServiceObject."Warranty Start Date Vendor") AND
                   ((FORMAT(ServWarrDiscountTerm.Period) = '') OR
                    ("Posting Date" <= CALCDATE(ServWarrDiscountTerm.Period, ServiceObject."Warranty Start Date Vendor"))) AND
                   ((ServiceObject."Warranty Date Vendor" = 0D) OR
                    ("Posting Date" <= ServiceObject."Warranty Date Vendor")) AND
                   ((ServWarrDiscountTerm."Cost Type" = ServWarrDiscountTerm."Cost Type"::" ") OR
                    ("Cost Type" +1 = ServWarrDiscountTerm."Cost Type")) AND
                   (ServWarrDiscountTerm.Percentage > "Discount % (Warranty)")
                THEN
                  "Discount % (Warranty)" := ServWarrDiscountTerm.Percentage;
              UNTIL ServWarrDiscountTerm.NEXT = 0;
            "Discount % (Warranty)" := 100 - "Discount % (Warranty)";
          END;
        END;
      END;
    END;

    PROCEDURE DrillDownDiscount@1100485010(lvAction@1100485000 : Integer);
    VAR
      lvServContrDiscRec@1100485003 : Record 11012828;
      lvFrmDiscContract@1100485001 : Page 11012836;
      ServiceObjectInfoMgt@1100528601 : Codeunit 11012840;
      WarrantyType@1100528600 : 'Customer,Vendor';
    BEGIN
      //db, 23-05-08: M10502
      ServOrderRec.GET("Service Order No.");
      IF lvAction = 0 THEN BEGIN
        IF ServOrderRec."Charge Vendor (Warranty)" THEN
          EXIT;
        lvServContrDiscRec.SETRANGE("Service Contract No.", ServOrderRec."Service Contract No.");
        lvServContrDiscRec.SETRANGE("Service Package", GetServicePackage());
        CLEAR(lvFrmDiscContract);
        lvFrmDiscContract.SETTABLEVIEW(lvServContrDiscRec);
        lvFrmDiscContract.EDITABLE(FALSE);
        lvFrmDiscContract.RUNMODAL;
      END;
      IF lvAction = 1 THEN BEGIN
        WarrantyType := WarrantyType::Customer;
        IF ServOrderRec."Charge Vendor (Warranty)" THEN
          WarrantyType := WarrantyType::Vendor;
        ServiceObjectInfoMgt.ShowActiveWarrantyDiscTerms("Object No.", "Posting Date", "Cost Type" +1, WarrantyType);
      END;
    END;

    PROCEDURE CheckItemLine@1210190015() : Boolean;
    BEGIN
      EXIT(("Item No." <> '') OR ("Basic Item" <> '') OR ("Trade Item" <> ''));
    END;

    PROCEDURE GetHourRateCode@1100485018();
    VAR
      ServSetup@1100525000 : Record 11012800;
      TradeGrpRec@1210190000 : Record 11012015;
      RateByTradeAssWageCompRec@1210190003 : Record 11012086;
      lvHourRateCode@1100485003 : Code[20];
      lvLoopCount@1100485004 : Integer;
    BEGIN
      IF (CurrFieldNo = FIELDNO("Hour Rate Code")) OR ValidateHourRateCode THEN
        EXIT;
      ValidateHourRateCode := FALSE;

      ServSetup.GET;

      CALCFIELDS("Cost Type");
      IF ("Cost Type" = "Cost Type"::Labor) THEN BEGIN
        REPEAT
          lvLoopCount := lvLoopCount + 1;
          IF ((lvLoopCount = 1) AND (ServSetup."Get Hour Rate Sequence" = ServSetup."Get Hour Rate Sequence"::TradeGroup_CostObject)) OR
             ((lvLoopCount = 2) AND (ServSetup."Get Hour Rate Sequence" = ServSetup."Get Hour Rate Sequence"::CostObject_TradeGroup))
          THEN BEGIN
            IF EmplRec.GET("Employee No.") THEN BEGIN
              GetDescription;
              IF NOT TradeGrpRec.GET(EmplRec."Trade Association") THEN
                TradeGrpRec.INIT;
              IF NOT RateByTradeAssWageCompRec.GET(EmplRec."Trade Association", "Wage Component") THEN
                RateByTradeAssWageCompRec.INIT;
              lvHourRateCode := RateByTradeAssWageCompRec."Hour Rate Code";
              IF lvHourRateCode = '' THEN
                lvHourRateCode := TradeGrpRec."Hour Rate Code (Cost Plus)";
            END;
          END;

          IF (lvHourRateCode = '') AND (lvLoopCount = 1) AND ("Cost Object" <> '')THEN BEGIN
            DimMgt.GetDimValueRec(2, "Cost Object", DimValRec, FALSE,'');
            IF DimValRec."Hour Rate Code (Cost Plus)" <> '' THEN
              lvHourRateCode := DimValRec."Hour Rate Code (Cost Plus)";
          END;
        UNTIL (lvHourRateCode <> '') OR (lvLoopCount = 2);

        IF lvHourRateCode <> "Hour Rate Code" THEN
          VALIDATE("Hour Rate Code", lvHourRateCode);
      END;
    END;

    PROCEDURE SetValidateHourRateCode@1100525000(lValidateHourRateCode@1100525000 : Boolean);
    BEGIN
      ValidateHourRateCode := lValidateHourRateCode;
    END;

    PROCEDURE GetSalesDiscount@1100525003();
    BEGIN
      //db, 09-07-09
      IF "Gross Price (LCY)" <> 0 THEN
        "Sales Discount % (Item)" := (("Gross Price (LCY)" - "Basic Price (LCY)") / "Gross Price (LCY)") * 100;
    END;

    PROCEDURE GetPurchaseDiscount@1100525004();
    BEGIN
      //db, 09-07-09
      IF "Gross Price (LCY)" <> 0 THEN
        "Purchase Discount % (Item)" := (("Gross Price (LCY)" - "Cost Price (LCY)") / "Gross Price (LCY)") * 100;
      IF NOT CheckItemLine THEN
        "Purchase Discount % (Item)" := 0;
    END;

    PROCEDURE GetExtraCostLines@1100525001();
    VAR
      ExtraCost@1100525000 : Record 11020344;
      CostPlusEntry@1100525001 : Record 11012825;
      LastLineNo@1100525002 : Integer;
    BEGIN
      ExtraCost.SETRANGE("Entity Type", ExtraCost."Entity Type"::"Service Order");
      ExtraCost.SETRANGE("Entity Code", "Service Order No.");
      IF ExtraCost.FINDSET THEN BEGIN
        CostPlusEntry.RESET;
        CostPlusEntry.SETRANGE("Service Order No.", "Service Order No.");
        IF CostPlusEntry.FINDLAST THEN
          LastLineNo := CostPlusEntry."Line No."
        ELSE
          LastLineNo := 0;

        REPEAT
          CostPlusEntry.INIT;
          CostPlusEntry.VALIDATE("Service Order No.", "Service Order No.");
          CostPlusEntry."Line No." := LastLineNo + 10000;
          LastLineNo := CostPlusEntry."Line No.";
          CostPlusEntry.VALIDATE("Cost Object", ExtraCost."Cost Object");
          CostPlusEntry.VALIDATE(Description, ExtraCost.Description);
          CostPlusEntry.VALIDATE(Quantity, ExtraCost.Quantity);
          CostPlusEntry.VALIDATE("Unit of Measure", ExtraCost."Unit of Measure");
          CostPlusEntry.VALIDATE("Basic Price (LCY)", ExtraCost.Amount);
          CostPlusEntry."Extra Cost" := TRUE;
          CostPlusEntry.INSERT(TRUE);
        UNTIL ExtraCost.NEXT = 0;
      END;
    END;

    PROCEDURE GetExtraCostLinesByContract@1100528606();
    VAR
      ExtraCost@1100525000 : Record 11020344;
      CostPlusEntry@1100525001 : Record 11012825;
      ServiceOrder@1100528600 : Record 11012823;
      LastLineNo@1100525002 : Integer;
    BEGIN
      CALCFIELDS("Service Contract No.");

      CostPlusEntry.SETRANGE("Service Order No.", "Service Order No.");
      CostPlusEntry.SETRANGE("Extra Cost", TRUE);
      IF CostPlusEntry.FINDFIRST THEN
        CostPlusEntry.DELETEALL;

      IF "Service Contract No." = '' THEN EXIT;

      ServiceOrder.GET("Service Order No.");
      ExtraCost.SETRANGE("Entity Type", ExtraCost."Entity Type"::"Service Contract");
      ExtraCost.SETRANGE("Entity Code", "Service Contract No.");
      ExtraCost.SETFILTER("Apply at Source Type", '%1|%2',
        ServiceOrder."Source Type", ExtraCost."Apply at Source Type"::"All Source Types");
      IF ExtraCost.FINDSET THEN BEGIN
        CostPlusEntry.RESET;
        CostPlusEntry.SETRANGE("Service Order No.", "Service Order No.");
        IF CostPlusEntry.FINDLAST THEN
          LastLineNo := CostPlusEntry."Line No."
        ELSE
          LastLineNo := 0;

        REPEAT
          CostPlusEntry.INIT;
          CostPlusEntry.VALIDATE("Service Order No.", "Service Order No.");
          CostPlusEntry."Line No." := LastLineNo + 10000;
          LastLineNo := CostPlusEntry."Line No.";
          CostPlusEntry.VALIDATE("Cost Object", ExtraCost."Cost Object");
          CostPlusEntry.VALIDATE(Description, ExtraCost.Description);
          CostPlusEntry.VALIDATE(Quantity, ExtraCost.Quantity);
          CostPlusEntry.VALIDATE("Unit of Measure", ExtraCost."Unit of Measure");
          CostPlusEntry.VALIDATE("Basic Price (LCY)", ExtraCost.Amount);
          CostPlusEntry."Extra Cost" := TRUE;
          CostPlusEntry.INSERT(TRUE);
        UNTIL ExtraCost.NEXT = 0;
      END;
    END;

    PROCEDURE UpdateAttachedLine@1100525011();
    VAR
      CostPlusEntry@1100525000 : Record 11012825;
    BEGIN
      //C024476
      IF "Line No." = 0 THEN EXIT;  //C028952
      CostPlusEntry.SETRANGE("Service Order No.", "Service Order No.");
      CostPlusEntry.SETRANGE("Attached to Line No. (RC)", "Line No.");
      IF CostPlusEntry.FINDSET THEN BEGIN
        REPEAT
          CostPlusEntry.VALIDATE(Quantity, Quantity);
          CostPlusEntry.Chargeable := Chargeable;
          CostPlusEntry."Posting Date" := "Posting Date";
          CostPlusEntry."Additional Cost" := "Additional Cost";
          CostPlusEntry."VAT Prod. Posting Group" := "VAT Prod. Posting Group";
          CostPlusEntry.MODIFY;
        UNTIL CostPlusEntry.NEXT = 0;
      END;
    END;

    PROCEDURE CheckRemovalContribution@1100525002();
    VAR
      lvCostPlusRec@1100525000 : Record 11012825;
    BEGIN
      //db, 22-10-09: M16544
      lvCostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
      lvCostPlusRec.SETRANGE("Attached to Line No. (RC)", "Line No.");
      lvCostPlusRec.SETRANGE("Removal Contribution", TRUE);
      lvCostPlusRec.DELETEALL;
    END;

    PROCEDURE CheckAdditionalCostService@1100525017();
    BEGIN
      //db, 24-02-10
      IF "Service Order No." = '' THEN EXIT;
      IF NOT ServOrderRec.GET("Service Order No.") THEN EXIT;

      IF (CurrFieldNo = FIELDNO("Service Order No.")) OR (CurrFieldNo = FIELDNO("Cost Object")) THEN BEGIN
        IF xRec."Cost Object" = '' THEN
          xRec."Cost Type":= -1  //db, 16-03-10: disable default option
        ELSE
          xRec.CALCFIELDS("Cost Type");
        CALCFIELDS("Cost Type");
        IF ("Service Order No." <> xRec."Service Order No.") OR
           ("Cost Type" <> xRec."Cost Type") THEN BEGIN
          "Additional Cost" :=
            ServOrderRec.GetAdditionalCostService("Service Order No.","Cost Object","Cost Type"+1,'');
        END;
        IF ("Service Order No." <> xRec."Service Order No.") OR
           ("Cost Type" <> xRec."Cost Type") THEN BEGIN
          VALIDATE("Cost Component");
        END;
      END;
    END;

    PROCEDURE ValidateAdditionalCost@1100525007();
    VAR
      CostCompRec@1100525001 : Record 11012012;
      SaveCostComp@1100525000 : Text[30];
    BEGIN
      SaveCostComp := "Cost Component";
      TESTFIELD("Service Order No.");
      VALIDATE("Service Order No.");
      IF CurrFieldNo <> FIELDNO("Additional Cost") THEN EXIT;  //db, 18-03-10: T4641

      IF CostCompRec.GET(SaveCostComp) THEN BEGIN
         "Cost Component" := SaveCostComp;
         IF ("Additional Cost" = TRUE) THEN BEGIN
           IF (CostCompRec."Cost Component (Add.Cost)" <> '') THEN
             "Cost Component" := CostCompRec."Cost Component (Add.Cost)";
         END ELSE BEGIN
           CostCompRec.SETRANGE("Cost Component (Add.Cost)", SaveCostComp);
           IF CostCompRec.FINDSET THEN BEGIN
             REPEAT
               IF (CostCompRec."Cost Component (Add.Cost)" = SaveCostComp) THEN
                 "Cost Component" := CostCompRec.Code;
             UNTIL CostCompRec.NEXT = 0;
           END;
         END;
      END;
    END;

    PROCEDURE ValidateCostComponent@1100525006();
    VAR
      CostCompRec@1100525000 : Record 11012012;
      CostCompRec2@1100525001 : Record 11012012;
    BEGIN
      IF CurrFieldNo <> FIELDNO("Cost Component") THEN EXIT;  //db, 18-03-10: T4642

      IF CostCompRec.GET("Cost Component") THEN BEGIN
        //db.sn, 06-12-10: M24263
        IF CostCompRec."Additional Cost (Service)" THEN BEGIN
          CostCompRec2.SETRANGE("Cost Component (Add.Cost)", "Cost Component");
          IF NOT CostCompRec2.FINDFIRST THEN EXIT;
        END ELSE BEGIN
          IF CostCompRec."Cost Component (Add.Cost)" = '' THEN EXIT;
        END;
        //db.en, 06-12-10: M24263
        "Additional Cost" := CostCompRec."Additional Cost (Service)";
      END;
    END;

    PROCEDURE GenerateCostPlusFromServEntry@1100530000(ServEntryRec@1100530007 : Record 11012819;ConvertUnit@1100530012 : Boolean;AutoTranslate@1100530014 : Boolean;SerialNo@1100528501 : Code[40];LotNo@1100528500 : Code[20]);
    VAR
      CostPlusRec@1100530000 : Record 11012825;
      TradeItemRec@1100530011 : Record 11012317;
      BasicItemRec@1100530010 : Record 11012316;
      ItemRec@1100530009 : Record 27;
      ProjSetup@1210190000 : Record 315;
      ItemTranslation@1210190004 : Record 30;
      ServiceLocation@1210190005 : Record 11012801;
      lvCostPrice@1100530005 : Decimal;
      lvMissUnit@1100530004 : Boolean;
      lvUnitFactor@1100530003 : Decimal;
      QtyPerUnitOfMeas@1100409000 : Decimal;
      lvItemUnknown@1100530002 : Boolean;
      lvQuantity@1100530001 : Decimal;
      LastEntryNo@1100530006 : Integer;
      HistCostPriceItem@1210190002 : Boolean;
      HistCostPriceCostObject@1210190001 : Boolean;
      UOMMgt@1210190003 : Codeunit 5402;
      lvServiceOrderExtension@1100525004 : Record 11071727;
      lvSurchargeIfMissingArticles@1100525000 : Decimal;
      lvPriceHistoryFound@1100525001 : Boolean;
      lvPriceFactor@1100525002 : Decimal;
      lvGrossPrice@1100525003 : Decimal;
      lvSkipCalcInventoryPrice@1100525005 : Boolean;
    BEGIN
      //db, 10-01-11: M22696 (removed from report 11012801)
      ServSetup.GET;  //db, 10-01-11
      //db.sn, 07-07-11: M21954
      ProjSetup.GET;
      HistCostPriceItem := ProjSetup."Copy Price Item from Entry";
      HistCostPriceCostObject := ProjSetup."Copy Price C.Object from Entry";
      //db.en, 07-07-11: M21954
      WITH ServEntryRec DO BEGIN
        CostPlusRec.SETRANGE("Service Order No.", "Service Order No.");
        CostPlusRec.SETRANGE("Line No.");
        IF CostPlusRec.FINDLAST THEN
          LastEntryNo := CostPlusRec."Line No."
        ELSE
          LastEntryNo := 0;

        CostPlusRec.INIT;
        CostPlusRec.VALIDATE("Service Order No.", "Service Order No.");
        CostPlusRec."Line No." := LastEntryNo + 10000;
        CostPlusRec.INSERT(TRUE);

        //>> 160609 ITERO.SB Set CurrFieldNo to zero when generate cost plus entries, to get correct value in GetDescription function.
        CostPlusRec.SetCurrFieldNoToZero();
        //<<

        //C024844.sn
        IF NOT TradeItemRec.GET("Vendor (Trade Item)", "Trade Item") THEN BEGIN
          "Vendor (Trade Item)" := '';
          "Trade Item" := '';
        END;
        IF NOT BasicItemRec.GET(Manufacturer, "Basic Item") THEN BEGIN
          "Basic Item" := '';
          Manufacturer := '';
        END;
        //C024844.en

        IF "Execution Date" <> 0D THEN
          CostPlusRec."Posting Date" := "Execution Date"
        ELSE
          CostPlusRec."Posting Date" := "Posting Date";
        CostPlusRec.CALCFIELDS("Service Contract No.");
        CostPlusRec."Currency Code Costs" := "Currency Code"; // dp00116.n

        //db.sn, 12-10-09: M16646
        IF Quantity = 0 THEN BEGIN
          IF "Unit Cost (LCY)" <> 0 THEN BEGIN
            lvQuantity := ROUND("Total Cost (LCY)"/ "Unit Cost (LCY)");  //expense (kilometer)
            lvCostPrice := "Unit Cost (LCY)";
            CostPriceACY := "Unit Cost";  // dp00116.n
          END ELSE BEGIN
            lvQuantity := 1;
            lvCostPrice := "Total Cost (LCY)";
            CostPriceACY := "Total Cost"; // dp00116.n
          END;
        END ELSE BEGIN
          lvQuantity := Quantity;
          lvCostPrice := "Unit Cost (LCY)";
          CostPriceACY := "Unit Cost";  // dp00116.n
        END;
        IF "Qty. per Unit of Measure" <> 0 THEN BEGIN
          lvCostPrice := lvCostPrice / "Qty. per Unit of Measure";  //db, 14-03-13: C006483  (solution for 32947)
        END ELSE BEGIN
          //*32947.sn   db, 21-09-12
          //* In the Service Entry there is no field "Qty. per Unit of Measure" (as in Project Entry, see also T11012019).
          //* So a temp solution is made to determine this field by a function. In future this field will also be added in Service entry
          QtyPerUnitOfMeas := GetUnitFactorItem("Vendor (Trade Item)", "Trade Item", "Item No.", "Unit of Measure Code");
          IF QtyPerUnitOfMeas <> 0 THEN
            lvCostPrice := lvCostPrice / QtyPerUnitOfMeas;
        //*32947.en
        END;

      //C008689 Cost Price stays original
      //IF "Document Type" = "Document Type"::"Purchase Credit Memo" THEN  //db, 15-06-07 (call 9725)
      //  lvCostPrice := -1 * lvCostPrice;
      //
        CostPlusRec.Quantity := lvQuantity;
        //db.en, 12-10-09: M16646

        CostPlusRec."Unit of Measure" := "Unit of Measure Code";
        CostPlusRec."Employee No." := "Employee No.";
        CostPlusRec."Cost Object" := "Global Dimension 2 Code";
        IF "Global Dimension 2 Code" <> '' THEN
          DimMgt.GetDimValueRec(2, "Global Dimension 2 Code", DimValRec, TRUE, '');
        CostPlusRec.VALIDATE("Cost Component", "Cost Component");
        CostPlusRec."Wage Component" := "Wage Component";
        CostPlusRec."Item No." := "Item No.";
        CostPlusRec."Serial No." := SerialNo; //DP00121
        CostPlusRec."Lot No." := LotNo; //DP00121
        CostPlusRec."Basic Item" := "Basic Item";
        CostPlusRec."Trade Item" := "Trade Item";
        CostPlusRec.Manufacturer := Manufacturer;
        CostPlusRec."Vendor (Trade Item)" := "Vendor (Trade Item)";

        //>> 160621 ITERO.AC RFC082 Price Factor for current Cost Type. Just added to make code similar to Project Cost Plus Entry::GenerateCostPlusFromProjEntry
        CostPlusRec.CALCFIELDS("Cost Type");
        lvPriceFactor := 1;   // Possible to implement function for price factor ( if new fields are added in Servide Order Extension similar to fields in Project Principal added in RFC082 )
        CostPlusRec."Cost Price Adjustment" := (lvPriceFactor - 1) * 100;
        //<< 160621 ITERO.AC RFC082

        CostPlusRec.GetBasicPrice;

        IF "Basic Item" <> '' THEN BEGIN
          CostPlusRec."Basic Item" := "Basic Item";
          CostPlusRec.Manufacturer := Manufacturer;
        END;
        IF "Trade Item" <> '' THEN BEGIN
          CostPlusRec."Trade Item" := "Trade Item";
          CostPlusRec."Vendor (Trade Item)" := "Vendor (Trade Item)";
        END;
        CostPlusRec.TESTFIELD("Bill-to Customer No."); //mg, 15-04-13: C006949
        CustRec.GET(CostPlusRec."Bill-to Customer No.");  //db, 18-07-06: check option GrossMin by customer instead common setup
        IF CostPlusRec.CheckItemLine THEN BEGIN
          //>> 160621 ITERO.AC RFC082 (Similar to changes made by LAHE 130117 and by AC in Project Cost Plus Entry)
          //IF (CostPlusRec."Basic Price (LCY)" = 0) OR (HistCostPriceItem = TRUE) THEN BEGIN  //db, 17-09-09: M14148+16524
          IF NOT CostPlusRec.UseCostPrice(CustRec) THEN BEGIN
            CostPlusRec."Cost Price (LCY)" := lvCostPrice;  //db, 08-08-11
            CostPlusRec.CalculateCostPriceFromLCY;
            CostPlusRec."Basic Price Found at" := TABLECAPTION;
          END ELSE BEGIN
            IF lvServiceOrderExtension.GET("Service Order No.") THEN BEGIN
              IF (lvServiceOrderExtension."Item Price Cost Plus Entry" = lvServiceOrderExtension."Item Price Cost Plus Entry"::CostPrice) THEN BEGIN
                IF CostPlusRec."Price History Found" THEN BEGIN
                  CostPlusRec."Cost Price Adjustment" := 0;
                END ELSE BEGIN
                  lvSkipCalcInventoryPrice := TRUE;   // 160816 ITERO.AC Added control variable to avoid inventory price calculation
                  CostPlusRec."Basic Price (LCY)" := lvCostPrice * lvPriceFactor;
                  CostPlusRec."Gross Price (LCY)" := lvCostPrice * lvPriceFactor;
                  CostPlusRec.CalculateBasicPriceFromLCY;
                  CostPlusRec.CalculateGrossPriceFromLCY;
                  IF lvPriceFactor <> 1 THEN
                    CostPlusRec."Basic Price Found at" := Text11128002
                  ELSE
                    CostPlusRec."Basic Price Found at" := TABLECAPTION;
                END;
              END ELSE BEGIN
                lvGrossPrice := 0;
                lvPriceHistoryFound := CheckIfPriceHistoryExists(CostPlusRec."Service Order No.", ServOrderRec."Reference Date (Item)", CostPlusRec."Trade Item", lvGrossPrice);
                IF NOT lvPriceHistoryFound THEN BEGIN
                  lvSurchargeIfMissingArticles := GetSurchargeIfMissingArticles(CostPlusRec."Service Order No.");
                  IF lvSurchargeIfMissingArticles <> 1 THEN BEGIN
                    CostPlusRec."Cost Price Adjustment" := (lvSurchargeIfMissingArticles - 1) * 100;
                    CostPlusRec."Basic Price (LCY)" := lvCostPrice * lvSurchargeIfMissingArticles;
                    CostPlusRec."Gross Price (LCY)" := lvCostPrice * lvSurchargeIfMissingArticles;
                    CostPlusRec.CalculateBasicPriceFromLCY;
                    CostPlusRec.CalculateGrossPriceFromLCY;
                    CostPlusRec."Sales Discount % (Item)" :=0;
                    CostPlusRec."Basic Price Found at" := Text11128001;
                  END;
                END;
              END;
            END;
            //<< 160621 ITERO.AC RFC082
            CostPlusRec."Cost Price (LCY)" := lvCostPrice;  //db, 08-08-11
            CostPlusRec.CalculateCostPriceFromLCY;  // dp00116.n
            //mg.sc, 15-03-12: M33991
            IF NOT CostPlusRec.ItemPriceCPEisGrossMin(CustRec) THEN BEGIN
              CostPlusRec."Basic Price (LCY)" := lvCostPrice;
              CostPlusRec.CalculateBasicPriceFromLCY;  // dp00116.n
              CostPlusRec."Basic Price Found at" := TABLECAPTION;
            END;
            //mg.ec, 15-03-12: M33991
          END;
        END;

        IF "Trade Item" <> '' THEN BEGIN
          TradeItemRec.GET("Vendor (Trade Item)", "Trade Item");  //C024844
          IF ConvertUnit = TRUE THEN BEGIN
            IF (UPPERCASE(TradeItemRec."Packaging Unit") = "Unit of Measure Code") AND
               (UPPERCASE(TradeItemRec."Packaging Unit") <> UPPERCASE(TradeItemRec."Application Unit")) THEN
              lvUnitFactor := TradeItemRec."Qty. per Unit of Measure";  //db, 13-06-08: M10185
          END;
          lvMissUnit := ((UPPERCASE(TradeItemRec."Application Unit") <> "Unit of Measure Code") AND
                         (UPPERCASE(TradeItemRec."Packaging Unit") <> "Unit of Measure Code"));  //db,13-06-08: M10310
          IF (lvMissUnit = FALSE) AND
             ((TradeItemRec."Removal Contribution" <> 0) OR
              //>> 160621 ITERO.AC RFC082 (same as LAHE 130117 in Project Cost Plus Entry)
              // CostPlusRec.ItemPriceCPEisGrossMin(CustRec)) THEN BEGIN
              (NOT UseCostPrice(CustRec))) THEN BEGIN
              //<< 160621 ITERO.AC RFC082
            CostPlusRec.VALIDATE("Trade Item", "Trade Item");
            lvCostPrice := CostPlusRec."Cost Price (LCY)";
            //db, 19-02-16: C028749 (disable 32761)
            //32761.sn
            //- Cost Price is already adapted to inventory unit, do not divide again with factor for order unit
            //32761.sn
            //IF HistCostPriceItem AND ("Unit of Measure Code" <> CostPlusRec."Unit of Measure") AND
            //   (TradeItemRec."Qty. per Unit of Measure" <> 0)
            //THEN
            //  lvCostPrice := lvCostPrice /  TradeItemRec."Qty. per Unit of Measure";
            //32761.en
          END ELSE BEGIN  //db, 05-12-07 (call 7913 + 10572)
            lvCostPrice := CostPlusRec."Cost Price (LCY)";  //db, 10-02-09: M13987
            //mg.sc, 15-03-12: M33991
            CostPlusRec.FindCostPrice(2);
            CostPlusRec.GetSalesDiscount;
      //      CostPlusRec."Purchase Discount % (Item)" := TradeItemRec."Discount Percentage";
      //      CostPlusRec.CalculateGrossPrice(lvCostPrice, CostPlusRec."Purchase Discount % (Item)");
            //mg.ec, 15-03-12: M33991
          END;
        END ELSE BEGIN
          IF "Basic Item" <> '' THEN BEGIN
            BasicItemRec.GET(Manufacturer, "Basic Item");  //C024844
            IF ConvertUnit = TRUE THEN BEGIN
              IF (UPPERCASE(BasicItemRec."Packaging Unit") = "Unit of Measure Code") AND
                 (UPPERCASE(BasicItemRec."Packaging Unit") <> UPPERCASE(BasicItemRec."Application Unit")) THEN
                lvUnitFactor := BasicItemRec."Qty. per Unit of Measure";  //db, 13-06-08: M10185
            END;
            lvMissUnit := ((UPPERCASE(BasicItemRec."Application Unit") <> "Unit of Measure Code") AND
                           (UPPERCASE(BasicItemRec."Packaging Unit") <> "Unit of Measure Code"));  //db,13-06-08: M10310
            IF (lvMissUnit = FALSE) AND
               ((BasicItemRec."Removal Contribution" <> 0) OR
                CostPlusRec.ItemPriceCPEisGrossMin(CustRec)) THEN BEGIN
              CostPlusRec.VALIDATE("Basic Item", "Basic Item");
              lvCostPrice := CostPlusRec."Cost Price (LCY)";
              //32761.sn
              IF HistCostPriceItem AND ("Unit of Measure Code" <> CostPlusRec."Unit of Measure") AND
                 (BasicItemRec."Qty. per Unit of Measure" <> 0)
              THEN
                lvCostPrice := lvCostPrice /  BasicItemRec."Qty. per Unit of Measure";
              //32761.en
            END ELSE BEGIN  //db, 05-12-07 (call 7913 + 10572)
              lvCostPrice := CostPlusRec."Cost Price (LCY)";  //db, 10-02-09: M13987
              //mg.sc, 15-03-12: M33991
              CostPlusRec.FindCostPrice(1);
              CostPlusRec.GetSalesDiscount;
      //        CostPlusRec."Purchase Discount % (Item)" := BasicItemRec."Discount Percentage";
      //        CostPlusRec.CalculateGrossPrice(lvCostPrice, CostPlusRec."Purchase Discount % (Item)");
              //mg.ec, 15-03-12: M33991
            END;
          END ELSE BEGIN
            IF ("Item No." <> '') AND NOT (lvSkipCalcInventoryPrice) THEN BEGIN    // 160816 ITERO.AC Added control variable to avoid Inventory price calculation
              IF ItemRec.GET("Item No.") THEN BEGIN
                //db.sn, 06-09-11: M22696
                IF ConvertUnit = TRUE THEN BEGIN
                  IF (ItemRec."Purch. Unit of Measure" = "Unit of Measure Code") AND
                     (ItemRec."Purch. Unit of Measure" <> ItemRec."Base Unit of Measure") THEN
                    lvUnitFactor := UOMMgt.GetQtyPerUnitOfMeasure(ItemRec,"Unit of Measure Code");
                END;
                //db.en, 06-09-11: M22696
                IF (ItemRec."Removal Contribution" <> 0) OR
                   CostPlusRec.ItemPriceCPEisGrossMin(CustRec) THEN BEGIN
                  CostPlusRec.VALIDATE("Item No.", "Item No.");
                  lvCostPrice := CostPlusRec."Cost Price (LCY)";
                  //32761.sn
                  IF HistCostPriceItem AND ("Unit of Measure Code" <> CostPlusRec."Unit of Measure") AND
                     (UOMMgt.GetQtyPerUnitOfMeasure(ItemRec,"Unit of Measure Code") <> 0)
                  THEN
                    lvCostPrice := lvCostPrice /  UOMMgt.GetQtyPerUnitOfMeasure(ItemRec,"Unit of Measure Code");
                  //32761.en
                END ELSE BEGIN  //db, 05-12-07 (call 7913 + 10572)
                  lvCostPrice := CostPlusRec."Cost Price (LCY)";  //db, 10-02-09: M13987
                  //mg.sc, 15-03-12: M33991
                  CostPlusRec.FindCostPrice(0);
                  CostPlusRec.GetSalesDiscount;
      //            CostPlusRec."Purchase Discount % (Item)" := ItemRec."Profit %";
      //            CostPlusRec.CalculateGrossPrice(lvCostPrice, CostPlusRec."Purchase Discount % (Item)");
                  //mg.sc, 15-03-12: M33991
                END;
              END ELSE
                lvItemUnknown := TRUE; //Item unknown, Probably intercompany posting
            END ELSE BEGIN
              //db.sn, 29-05-13: C007700
              CheckDocument("Document Type", "Document No.", "Document Line No.",
                CostPlusRec."Gross Price (LCY)", CostPlusRec."Basic Price (LCY)", CostPlusRec."Purchase Discount % (Item)",
                CostPlusRec."Basic Price Found at", HistCostPriceCostObject);
              IF CostPlusRec.ItemPriceCPEisGrossMin(CustRec) THEN
                CostPlusRec."Basic Price (LCY)" := CostPlusRec."Gross Price (LCY)";
              CostPlusRec.CalculateGrossPriceFromLCY;
              CostPlusRec.CalculateBasicPriceFromLCY;
              //db.en, 29-05-13: C007700
            END;
          END;
        END;

        IF "Global Dimension 2 Code" <> '' THEN  //db, 19-06-09: M14973
          CostPlusRec."Cost Object" := "Global Dimension 2 Code";

        // dp00116.sn
        IF lvCostPrice <> 0 THEN BEGIN
          IF lvCostPrice * lvQuantity = ServEntryRec."Total Cost (LCY)" THEN BEGIN  //db, 29-05-13: C007700
            CostPlusRec."Cost Price (LCY)" := lvCostPrice;
            CostPlusRec."Cost Price" := CostPriceACY;
          END ELSE
        // dp00116.en
            CostPlusRec.VALIDATE("Cost Price (LCY)", lvCostPrice);
        END;

        IF NOT CostPlusRec.CheckItemLine AND (CostPlusRec."Basic Price (LCY)" = 0) THEN
          CostPlusRec.GetBasicPrice;

        //>>160621 ITERO.AC RFC082 Add Customer Price List Surcharge if no "Trade Item" or "Item No."
        IF NOT CostPlusRec.CheckItemLine AND (CostPlusRec."Basic Price (LCY)" = 0) THEN BEGIN
          //CostPlusRec.GetBasicPrice;
          IF CheckCostPriceBehaviour("Service Order No.", "Customer No.") THEN BEGIN
            CostPlusRec."Gross Price (LCY)" := lvCostPrice * lvPriceFactor;
            CostPlusRec."Basic Price (LCY)" := lvCostPrice * lvPriceFactor;
            CostPlusRec.CalculateGrossPriceFromLCY;
            CostPlusRec.CalculateBasicPriceFromLCY;
          END
          ELSE BEGIN
            lvSurchargeIfMissingArticles := GetSurchargeIfMissingArticles("Service Order No.");
            IF lvSurchargeIfMissingArticles <> 1 THEN BEGIN
              IF lvCostPrice <> 0 THEN BEGIN
                CostPlusRec."Cost Price Adjustment" := (lvSurchargeIfMissingArticles - 1) * 100;
                CostPlusRec.VALIDATE("Basic Price (LCY)", lvCostPrice * lvSurchargeIfMissingArticles);
                CostPlusRec."Cost Price (LCY)" := lvCostPrice;
                CostPlusRec."Basic Price Found at" := Text11128001;
              END;
            END;
          END;
        END;

        // Alter text if Cost Price and we have got a CostPriceSurcharge from current Projcet Principal
        IF (CostPlusRec."Basic Price Found at" = CostPlusRec.FIELDCAPTION("Cost Price")) AND (lvPriceFactor <> 1) THEN
          CostPlusRec."Basic Price Found at" := Text11128002;
        //<< 160621 ITERO.AC RFC082

        //validate item-data disturbes quantity/unit: evaluate function CheckItemUnitConversion
        IF lvMissUnit = FALSE THEN  //db,13-06-08: M10310
          IF ConvertUnit = FALSE THEN  //db, 13-06-08: M10185
            CostPlusRec.VALIDATE("Unit of Measure","Unit of Measure Code");

        IF lvUnitFactor <> 0 THEN  //db, 13-06-08: M10185
          lvQuantity := lvQuantity * lvUnitFactor;   //db, 12-10-09: M16646
        CostPlusRec.VALIDATE(Quantity, lvQuantity);  //db, 12-10-09: M16646

        CostPlusRec."Surcharge %" := CostPlusRec.GetSurcharge;
        CostPlusRec."Sales Price (LCY)" := CostPlusRec."Basic Price (LCY)" * (1 + CostPlusRec."Surcharge %"/100);
        //>> 160222 ITERO.SB Calculate sales price
        CostPlusRec.CalculateSalesPriceFromLCY;
        //<< 160222 ITERO.SB
        //>> 160621 ITERO.AC RFC082 / IME477 (This value is used to calculate net price in Invoices)
        CostPlusRec."Surcharge Amount" := CostPlusRec."Sales Price" - CostPlusRec."Basic Price";
        //<< 160621 ITERO.AC
        IF "Sales Price Purch. Order" <> 0 THEN BEGIN
          CostPlusRec.VALIDATE("Sales Price (LCY)", "Sales Price Purch. Order");
          CostPlusRec."Basic Price Found at" := FIELDCAPTION("Sales Price Purch. Order");
          IF CostPlusRec."Basic Price (LCY)" <> 0 THEN
            CostPlusRec."Surcharge %" := (CostPlusRec."Sales Price (LCY)"/CostPlusRec."Basic Price (LCY)" -1) * 100
          ELSE BEGIN
            CostPlusRec."Surcharge %" := 0;
            CostPlusRec."Basic Price (LCY)" := CostPlusRec."Sales Price (LCY)";
            CostPlusRec.CalculateBasicPriceFromLCY;  // dp00116.n
            IF CostPlusRec."Gross Price (LCY)" <> 0 THEN
               CostPlusRec."Sales Discount % (Item)" :=
                 ((CostPlusRec."Gross Price (LCY)" - CostPlusRec."Basic Price (LCY)") / CostPlusRec."Gross Price (LCY)") * 100;
          END;
        END;
        CostPlusRec.CalculateSalesPriceFromLCY; //mg, 13-05-2015: C023332

        CostPlusRec."Additional Cost" := "Additional Cost";
        CostPlusRec."Cost Component" := "Cost Component";
        CostPlusRec."Entry No. Service Ledger" := "Entry No.";
        CostPlusRec.GetDiscountPerc;
      //CostPlusRec.Chargeable := (CostPlusRec."Invoice Price" <> 0);  //db, 07-07-05 (call 6191)
        CostPlusRec."Source Document" := "Document No.";
        IF "Entry No." = 0 THEN  //db, 10-01-11: fill source line for obligations only
          CostPlusRec."Source Line" := "Document Line No.";
        CostPlusRec."Removal Contribution" := "Removal Contribution";

        IF lvItemUnknown THEN
          CostPlusRec."Item No." := '';

        { //*27670.so
        //call 27239 description determination changed
        IF (CostPlusRec."Item No." <> '') THEN BEGIN
          //db, 10-01-11: disable translation executed by validate item
          IF NOT AutoTranslate THEN BEGIN
            CostPlusRec.Description := Description;
            CostPlusRec."Description 2" := "Description 2";
          END;
        END ELSE BEGIN
          IF ServSetup."Copy Entry Description to CPE" THEN BEGIN
            CostPlusRec.Description := Description;
            CostPlusRec."Description 2" := "Description 2";
          END ELSE
            CostPlusRec.GetDescription;
          CostPlusRec.AddDateToDescription("Posting Date");
        END;
        } //*27670.eo
        //*27670.sn  Tmp solution, as in hotfix-001 (R11012013). Follow-up action needed (29573)
        IF AutoTranslate THEN BEGIN
          IF  ("Item No." <> '') AND ("Service Location No." <> '') THEN BEGIN
            IF NOT ServiceLocation.GET("Service Location No.") THEN
              FIELDERROR("Service Location No.", Text011);
            IF ItemTranslation.GET("Item No.",'',ServiceLocation."Language Code") THEN BEGIN
              CostPlusRec.Description := ItemTranslation.Description;
              CostPlusRec."Description 2" := ItemTranslation."Description 2";
            END;
          END;
        END ELSE BEGIN
          CostPlusRec.Description := Description;
          CostPlusRec."Description 2" := "Description 2";
        END;

        IF ServSetup."Copy Entry Description to CPE" THEN
          CostPlusRec.AddDateToDescription(CostPlusRec."Posting Date")
        ELSE
          CostPlusRec.GetDescription;
        //*27670.en

        CostPlusRec."VAT Prod. Posting Group" := CostPlusRec.UpdateVatProdPostingGrp;  //RFC 547

        //mg.sn, 14-06-11: M26765
        IF ProjSetup."Post Hours Per Day" THEN BEGIN
          CostPlusRec."From Time" := "Time From";
          CostPlusRec."To Time" := "Time Until";
          CostPlusRec."From Date" := "Posting Date";
          CostPlusRec."To Date" := "Posting Date";
        END;
        //mg.en, 14-06-11: M26765

        CostPlusRec.VALIDATE(Text, Text);
        //Itero.PR 151111
        CostPlusRec."Total Cost Price (LCY)" := CostPlusRec.Quantity * CostPlusRec."Cost Price (LCY)";
        //Itero 151111
        CostPlusRec.MODIFY;
        CostPlusRec.DetermineRemovalContribution(FALSE);
      END;
    END;

    LOCAL PROCEDURE CheckDocument@1100530001(DocType@1210190003 : ' ,Purchase Invoice,Purchase Credit Memo,Sales Invoice,Sales Credit Memo';DocNo@1210190000 : Code[20];LineNo@1210190001 : Integer;VAR GrossPrice@1210190005 : Decimal;VAR NettPrice@1210190006 : Decimal;VAR Discount@1210190007 : Decimal;VAR PriceFoundAt@1100530001 : Text[250];HistCostPriceCostObject@1100530000 : Boolean);
    VAR
      PurchInvLine@1210190002 : Record 123;
      UseDocumentPrice@1100525000 : Boolean;
    BEGIN
      //db, 10-01-11: M22696 (removed from report 11012801)
      IF (DocType <> DocType::"Purchase Invoice") AND
         (DocType <> DocType::"Purchase Credit Memo") THEN EXIT;  //db, 10-08-09: T3746

      IF PurchInvLine.GET(DocNo, LineNo) THEN BEGIN
        //db.sn, 29-05-13: C007700
        //Discount := PurchInvLine."Line Discount %";
        IF (GrossPrice = 0) AND (NettPrice = 0) THEN
          UseDocumentPrice := TRUE;  //no price found on any level
        //db.en, 29-05-13: C007700
        IF HistCostPriceCostObject OR UseDocumentPrice THEN BEGIN  //db, 17-09-09: M14148+16524
          //db.sn, 29-05-13: C007700
          IF PurchInvLine."Line Discount %" <> 0 THEN BEGIN
            Discount := PurchInvLine."Line Discount %";
          END ELSE BEGIN
            //Item Discount used on Purchase Order
            IF PurchInvLine."Unit Price (LCY)" <> 0 THEN
              Discount := 100 * ((PurchInvLine."Unit Price (LCY)" - PurchInvLine."Unit Cost (LCY)") / PurchInvLine."Unit Price (LCY)");
          END;
          //db.en, 29-05-13: C007700
          NettPrice := PurchInvLine."Unit Cost (LCY)";  //db, 12-09-07 (off) + 12-03-08 (on)
          PriceFoundAt :=  PurchInvLine.TABLECAPTION;
        END;
        GrossPrice := NettPrice;
        IF Discount <> 100 THEN
          GrossPrice := NettPrice * 100 / (100 - Discount);
      END;
    END;

    PROCEDURE UpdateVatProdPostingGrp@1100525018() VatProdPostingGrp : Code[20];
    VAR
      ServiceSetup@1100525001 : Record 11012800;
      ItemRec@1100525002 : Record 27;
      DimValRec@1100525006 : Record 349;
      DimMgt@1100525000 : Codeunit 408;
    BEGIN
      // RFC 547
      VatProdPostingGrp := '';

      ServiceSetup.GET;
      IF ServOrderRec.GET("Service Order No.") THEN;

      IF (ServiceSetup."Source VAT Prod. Posting Group" =
          ServiceSetup."Source VAT Prod. Posting Group"::"Item/CostObject") THEN
      BEGIN
        IF NOT ItemRec.GET("Item No.") THEN
          ItemRec.INIT;

        IF (ItemRec."VAT Prod. Posting Group" <> '') THEN
          VatProdPostingGrp := ItemRec."VAT Prod. Posting Group";

        IF VatProdPostingGrp = '' THEN BEGIN
          DimMgt.GetDimValueRec(2,"Cost Object",DimValRec,FALSE,'');
          IF (DimValRec."VAT Prod. Posting Group" <> '') THEN
            VatProdPostingGrp := DimValRec."VAT Prod. Posting Group";
        END;
      END;

      IF VatProdPostingGrp = '' THEN
        VatProdPostingGrp := ServOrderRec."VAT Prod. Posting Group";
    END;

    PROCEDURE LookupHourRate@1210190011();
    VAR
      ContrHourRateRec@1210190003 : Record 11012815;
      HourRateRec@1210190002 : Record 11012022;
      TmpHourRateRec@1210190001 : TEMPORARY Record 11012022;
      Desc@1210190000 : Text[50];
      NumContrRate@1210190004 : Integer;
    BEGIN
      //db, 07-06-11: M27653
      ContrHourRateRec.SETRANGE("Service Contract No.", "Service Contract No.");
      IF ContrHourRateRec.FINDSET THEN BEGIN
        REPEAT
          HourRateRec.SETRANGE(Code, ContrHourRateRec."Hour Rate Code");
          IF HourRateRec.FINDSET THEN
            REPEAT
              //HourRateRec.MARK := TRUE;  //db.o, 07-06-11: M27653
              //db.sn, 07-06-11: M27653
              TmpHourRateRec := HourRateRec;
              TmpHourRateRec."Starting Date" := 0D;
              TmpHourRateRec."Ending Date" := 0D;
              IF TmpHourRateRec.INSERT THEN;
              TmpHourRateRec.MARK := TRUE;
              NumContrRate := NumContrRate + 1;
              //db.en, 07-06-11: M27653
            UNTIL HourRateRec.NEXT = 0;
        UNTIL ContrHourRateRec.NEXT = 0;
        //HourRateRec.MARKEDONLY(TRUE);  //db.o, 07-06-11: M27653
      END;

      //db.so, 07-06-11: M27653
      //HourRateRec.SETRANGE(Code); //remove filter;
      //HourRateRec.SETFILTER("Project Filter", '%1', '');
      //HourRateRec.SETRANGE("Principal Filter", "Bill-to Customer No.");
      //HourRateRec.SETRANGE("Service Contract Filter", "Service Contract No.");
      //HourRateRec.SETRANGE("Date Filter", 0D, "Posting Date");
      //HourRateRec.Code := "Hour Rate Code";
      //IF PAGE.RUNMODAL(0, HourRateRec) = ACTION::LookupOK THEN BEGIN
      //  Desc := Description;
      //  SetValidateHourRateCode(TRUE);
      //  VALIDATE("Hour Rate Code",HourRateRec.Code);
      //  IF ServSetup."Description Cost Plus Entry" <> ServSetup."Description Cost Plus Entry"::RateCode THEN
      //    Description := Desc;
      //END;
      //db.eo, 07-06-11: M27653

      //db.sn, 07-06-11: M27653
      HourRateRec.SETRANGE(Code); //remove filter;
      IF HourRateRec.FINDSET THEN BEGIN
        REPEAT
          TmpHourRateRec := HourRateRec;
          IF NumContrRate <> 0 THEN BEGIN
            TmpHourRateRec."Starting Date" := 0D;
            TmpHourRateRec."Ending Date" := 0D;
          END;
          IF TmpHourRateRec.INSERT THEN;
        UNTIL HourRateRec.NEXT = 0;
      END;
      IF NumContrRate <> 0 THEN
        TmpHourRateRec.MARKEDONLY(TRUE);

      TmpHourRateRec.SETFILTER("Project Filter", '%1', '');
      TmpHourRateRec.SETRANGE("Principal Filter", "Bill-to Customer No."); //mg.c, 25-06-12: M27434
      TmpHourRateRec.SETRANGE("Service Contract Filter", "Service Contract No.");
      TmpHourRateRec.SETRANGE("Date Filter", 0D, "Posting Date");
      TmpHourRateRec.Code := "Hour Rate Code";
      IF PAGE.RUNMODAL(0, TmpHourRateRec) = ACTION::LookupOK THEN BEGIN
        Desc := Description;
        SetValidateHourRateCode(TRUE);
        VALIDATE("Hour Rate Code",TmpHourRateRec.Code);
        ServSetup.GET;  //db, 02-10-12: C002119
        IF ServSetup."Description Cost Plus Entry" <> ServSetup."Description Cost Plus Entry"::RateCode THEN
          Description := Desc;
      END;
      //db.en, 07-06-11: M27653
    END;

    PROCEDURE ReopenCollectiveList@1100528600();
    VAR
      ServiceCollectiveList@1100528600 : Record 11071730;
      ServiceSetup@1100528601 : Record 11012800;
    BEGIN
      IF "Collective List No." <> '' THEN BEGIN
        ServiceSetup.GET;
        ServiceCollectiveList.GET("Collective List No.");
        IF ServiceSetup."Auto Reopen Coll.List Disabled" THEN
          ServiceCollectiveList.TESTFIELD(Status, ServiceCollectiveList.Status::Open)
        ELSE BEGIN
          IF ServiceCollectiveList.Status > ServiceCollectiveList.Status::Open THEN BEGIN
            ServiceCollectiveList.VALIDATE(Status, ServiceCollectiveList.Status::Open);
            ServiceCollectiveList.MODIFY(TRUE);
          END;
        END;
      END;
    END;

    PROCEDURE HandleLookupObjectNo@1100528601();
    VAR
      ServiceOrderObject@1100528602 : Record 11071724;
    BEGIN
      ServiceOrderObject.SETRANGE("Service Order No.", "Service Order No.");
      IF PAGE.RUNMODAL(0, ServiceOrderObject) = ACTION::LookupOK THEN
        VALIDATE("Object No.", ServiceOrderObject."Object No.");
    END;

    PROCEDURE HandleLookupCollectiveListNo@1100528603() : Boolean;
    VAR
      ServiceCollectiveList@1100528602 : Record 11071730;
      Customer@1100528603 : Record 18;
    BEGIN
      Customer.GET("Bill-to Customer No.");
      ServiceCollectiveList.SETRANGE("Bill-to Customer No.", "Bill-to Customer No.");
      ServiceCollectiveList.SETRANGE("Customer No.", "Customer No.");
      //ServiceCollectiveList.SETRANGE(Status, ServiceCollectiveList.Status::Open);
      CASE Customer."Collect SO Invoices By" OF
        Customer."Collect SO Invoices By"::"Service Contract":
          ServiceCollectiveList.SETFILTER("Service Contract No.", '%1|%2', '', "Service Contract No.");
        Customer."Collect SO Invoices By"::"Service Location":
          BEGIN
            ServiceCollectiveList.SETFILTER("Service Contract No.", '%1|%2', '', "Service Contract No.");
            ServiceCollectiveList.SETFILTER("Service Location No.", '%1|%2', '', "Service Location No.");
          END;
      END;
      ServiceCollectiveList."No." := "Collective List No.";
      IF PAGE.RUNMODAL(0, ServiceCollectiveList) = ACTION::LookupOK THEN
        VALIDATE("Collective List No.", ServiceCollectiveList."No.");
    END;

    PROCEDURE MarkCollectiveListForRecalc@1100528604();
    VAR
      ServiceCollectiveList@1100528600 : Record 11071730;
    BEGIN
      IF "Collective List No." <> '' THEN BEGIN
        ServiceCollectiveList.GET("Collective List No.");
        ServiceCollectiveList.MarkAsDirty;
      END;
    END;

    PROCEDURE CheckCollectiveList@1100528608();
    VAR
      ServiceCollectiveList@1100528600 : Record 11071730;
      Customer@1100528601 : Record 18;
    BEGIN
      IF "Collective List No." = '' THEN
        EXIT;
      TESTFIELD("Bill-to Customer No.");
      TESTFIELD("Customer No.");
      ServiceCollectiveList.GET("Collective List No.");
      ServiceCollectiveList.TESTFIELD(Status, ServiceCollectiveList.Status::Open);
      ServiceCollectiveList.TESTFIELD("Bill-to Customer No.", "Bill-to Customer No.");
      ServiceCollectiveList.TESTFIELD("Customer No.", "Customer No.");
      Customer.GET("Customer No.");

      IF ServiceCollectiveList."Service Contract No." <> '' THEN
        ServiceCollectiveList.TESTFIELD("Service Contract No.", "Service Contract No.");
      IF ServiceCollectiveList."Service Location No." <> '' THEN
      ServiceCollectiveList.TESTFIELD("Service Location No.", "Service Location No.");
    END;

    PROCEDURE ResetSUPProductionLine@1100528607();
    VAR
      SUPProductionLine@1100528600 : Record 11071774;
    BEGIN
      SUPProductionLine.SETRANGE("Service Order No.", "Service Order No.");
      SUPProductionLine.SETRANGE("Production Seq. No.", "Production Seq. No.");
      SUPProductionLine.SETRANGE("Line No.", "Production Line No.");
      //SUPProductionLine.SETRANGE("Cost Plus Line No.", "Line No.");
      SUPProductionLine.SETRANGE("Cost Plus Entries Created", TRUE);
      IF SUPProductionLine.ISEMPTY THEN
        EXIT;
      SUPProductionLine.FINDSET(TRUE);
      REPEAT
        SUPProductionLine."Cost Plus Entries Created" := FALSE;
        SUPProductionLine."Creation Date Cost Plus Entry" := 0D;
        SUPProductionLine."Cost Plus Line No." := 0;
        SUPProductionLine.MODIFY;
      UNTIL SUPProductionLine.NEXT = 0;
    END;

    PROCEDURE ItemPriceCPEisGrossMin@1100528609(ICustomer@1100528600 : Record 18) : Boolean;
    VAR
      ServiceOrder@1100528602 : Record 11012823;
      ServiceOrderExtension@1100528603 : Record 11071727;
    BEGIN
      ServiceOrder.GET("Service Order No.");
      IF ServiceOrderExtension.GET("Service Order No.") THEN
        EXIT(ServiceOrderExtension."Item Price Cost Plus Entry" = ServiceOrderExtension."Item Price Cost Plus Entry"::GrossMin);
    END;

    PROCEDURE GetServicePackage@1210190014() : Code[10];
    VAR
      ServiceOrder@1210190000 : Record 11012823;
      ContractObject@1210190002 : Record 11071702;
      ServicePackage@1210190001 : Record 11012806;
      ServiceContract@1100528601 : Record 11012812;
      ServicePackageCode@1100528600 : Code[10];
    BEGIN
      CALCFIELDS("Service Contract No.");
      IF "Service Contract No." = '' THEN
        IF OverruleServiceContractNo = '' THEN
          EXIT
        ELSE
          "Service Contract No." := OverruleServiceContractNo;
      IF ServiceContract.GET("Service Contract No.") THEN
        ServicePackageCode := ServiceContract."Service Package";

      IF ContractObject.GET(ServiceContract."No.", "Object No.") THEN
        ServicePackageCode := ContractObject."Service Package";

      IF "Service Order No." = '' THEN
        ServiceOrder."Source Type" := ServiceOrder."Source Type"::Call
      ELSE
        IF NOT ServiceOrder.GET("Service Order No.") THEN
          EXIT;

      IF NOT ServicePackage.GET(ServicePackageCode) THEN
        EXIT(ServicePackageCode);

      CASE ServiceOrder."Source Type" OF
        ServiceOrder."Source Type"::Call:
          IF ServicePackage."Service Package Call" <> '' THEN
            EXIT(ServicePackage."Service Package Call");
        ServiceOrder."Source Type"::Contract:
          IF ServicePackage."Service Package Contract" <> '' THEN
            EXIT(ServicePackage."Service Package Contract");
        ServiceOrder."Source Type"::Direct:
          IF ServicePackage."Service Package Direct" <> '' THEN
            EXIT(ServicePackage."Service Package Direct");
      END;
      EXIT(ServicePackageCode);
    END;

    PROCEDURE DetermineObjectNo@1100528610();
    VAR
      ServiceOrderObject@1100528600 : Record 11071724;
    BEGIN
      IF ServOrderRec."No." <> "Service Order No." THEN
        IF NOT ServOrderRec.GET("Service Order No.") THEN
          ServOrderRec.INIT;

      ServiceOrderObject.SETRANGE("Service Order No.", "Service Order No.");
      IF ServiceOrderObject.FINDFIRST THEN BEGIN
        ServiceOrderObject.SETFILTER("Object No.", '<>%1', ServiceOrderObject."Object No.");
        IF ServiceOrderObject.ISEMPTY THEN
          VALIDATE("Object No.", ServiceOrderObject."Object No.");
      END;
    END;

    PROCEDURE CalculateBasicPriceFromLCY@1100528800();
    VAR
      CurrencyDate@1100528802 : Date;
      CurrencyExchangeRate@1100528801 : Record 330;
      Currency2@1100528800 : Record 4;
    BEGIN
      // dp00116.n
      Currency2.InitRoundingPrecision;
      IF "Currency Code" <> '' THEN BEGIN
        CurrencyDate := "Posting Date";
        "Basic Price" :=
        ROUND(
          CurrencyExchangeRate.ExchangeAmtLCYToFCY(
            0, '', CurrencyDate, "Currency Code", "Basic Price (LCY)",
             CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
             Currency2."Unit-Amount Rounding Precision");
      END ELSE BEGIN
        "Basic Price" := ROUND("Basic Price (LCY)",Currency2."Unit-Amount Rounding Precision");
      END;
    END;

    PROCEDURE CalculateCostPriceFromLCY@1100528802();
    VAR
      CurrencyDate@1100528802 : Date;
      CurrencyExchangeRate@1100528801 : Record 330;
      Currency2@1100528800 : Record 4;
    BEGIN
      // dp00116.n
      Currency2.InitRoundingPrecision;
      IF "Currency Code Costs" <> '' THEN BEGIN
        CurrencyDate := "Posting Date";
        "Cost Price" :=
        ROUND(
          CurrencyExchangeRate.ExchangeAmtLCYToFCY(
            0, '', CurrencyDate, "Currency Code Costs", "Cost Price (LCY)",
             CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code Costs",FALSE),FALSE),
             Currency2."Unit-Amount Rounding Precision");
      END ELSE BEGIN
        "Cost Price" := ROUND("Cost Price (LCY)",Currency2."Unit-Amount Rounding Precision");
      END;
    END;

    PROCEDURE CalculateSalesPriceFromLCY@1100528803();
    VAR
      CurrencyDate@1100528802 : Date;
      CurrencyExchangeRate@1100528801 : Record 330;
      Currency2@1100528800 : Record 4;
    BEGIN
      // dp00116.n
      Currency2.InitRoundingPrecision;
      IF "Currency Code" <> '' THEN BEGIN
        CurrencyDate := "Posting Date";
        "Sales Price" :=
        ROUND(
          CurrencyExchangeRate.ExchangeAmtLCYToFCY(
            0, '', CurrencyDate, "Currency Code", "Sales Price (LCY)",
             CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
             Currency2."Unit-Amount Rounding Precision");
      END ELSE BEGIN
        "Sales Price" := ROUND("Sales Price (LCY)",Currency2."Unit-Amount Rounding Precision");
      END;
    END;

    PROCEDURE CalculateInvoicePriceFromLCY@1100528804();
    VAR
      CurrencyDate@1100528802 : Date;
      CurrencyExchangeRate@1100528801 : Record 330;
      Currency2@1100528800 : Record 4;
    BEGIN
      // dp00116.n
      Currency2.InitRoundingPrecision;
      IF "Currency Code" <> '' THEN BEGIN
        CurrencyDate := "Posting Date";
        "Invoice Price" :=
        ROUND(
          CurrencyExchangeRate.ExchangeAmtLCYToFCY(
            0, '', CurrencyDate, "Currency Code", "Invoice Price (LCY)",
             CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
             Currency2."Amount Rounding Precision");  //db, 17-02-14: C012946
      END ELSE BEGIN
        "Invoice Price" := ROUND("Invoice Price (LCY)",Currency2."Amount Rounding Precision");  //db, 17-02-14: C012946
      END;
    END;

    PROCEDURE CalculateGrossPriceFromLCY@1100528805();
    VAR
      CurrencyDate@1100528802 : Date;
      CurrencyExchangeRate@1100528801 : Record 330;
      Currency2@1100528800 : Record 4;
    BEGIN
      // dp00116.n
      Currency2.InitRoundingPrecision;
      IF "Currency Code" <> '' THEN BEGIN
        CurrencyDate := "Posting Date";
        "Gross Price" :=
        ROUND(
          CurrencyExchangeRate.ExchangeAmtLCYToFCY(
            0, '', CurrencyDate, "Currency Code", "Gross Price (LCY)",
             CurrencyExchangeRate.ExchangeRate(0, '', CurrencyDate, "Currency Code",TRUE),TRUE),
             Currency2."Unit-Amount Rounding Precision");
      END ELSE BEGIN
        "Gross Price" := ROUND("Gross Price (LCY)",Currency2."Unit-Amount Rounding Precision");
      END;
    END;

    PROCEDURE SetCostObject@1210190016();
    BEGIN
      //call T000440
      CostObjectFixed := TRUE;
    END;

    PROCEDURE GetUnitFactorItem@1100528900(VendTradeItem@1100409000 : Code[20];TradeItem@1100409001 : Code[20];ItemNo@1100409002 : Code[20];UnitOfMeas@1100409003 : Code[10]) UnitFactor : Decimal;
    VAR
      ItemRec@1100528900 : Record 27;
      TradeItemRec@1100528901 : Record 11012317;
      UnitControl@1100528902 : Codeunit 5402;
    BEGIN
      //*32947  db, 21-09-12
      UnitFactor := 1;
      IF TradeItem <> '' THEN BEGIN
        IF TradeItemRec.GET(VendTradeItem, TradeItem) THEN
          IF UPPERCASE(TradeItemRec."Packaging Unit") = UnitOfMeas THEN
            UnitFactor := TradeItemRec."Qty. per Unit of Measure";
      END ELSE BEGIN
        IF ItemNo <> '' THEN BEGIN
          IF ItemRec.GET(ItemNo) THEN
            UnitFactor := UnitControl.GetQtyPerUnitOfMeasure(ItemRec, UnitOfMeas);
        END;
      END;
      EXIT(UnitFactor);
    END;

    PROCEDURE IsInFilterGroup@1100528611(IServiceOrderCostPlusEntry@1100528600 : Record 11012825;IFilterGroup@1100528601 : Code[20]) : Boolean;
    VAR
      Item@1100528602 : Record 27;
      TradeItem@1100528603 : Record 11012317;
      BasicItem@1100528604 : Record 11012316;
      ServDiscFilterGroupLine@1100528606 : Record 11071936;
      LinkedToServDiscFilterGroupLine@1100528609 : Record 11071936;
      ServiceOrder@1100528608 : Record 11012823;
      TableRef@1100528605 : RecordRef;
      FieldRef@1100528607 : FieldRef;
    BEGIN
      IF IFilterGroup = '' THEN
        EXIT(TRUE);
      ServDiscFilterGroupLine.SETRANGE(Code, IFilterGroup);
      ServDiscFilterGroupLine.SETRANGE("Linked To Line No.", 0);
      IF ServDiscFilterGroupLine.FINDSET THEN BEGIN
        REPEAT
          CASE ServDiscFilterGroupLine."Table Type" OF
            ServDiscFilterGroupLine."Table Type"::Item:
              BEGIN
                Item.RESET;
                Item.SETRANGE("No.", IServiceOrderCostPlusEntry."Item No.");
                TableRef.GETTABLE(Item);
              END;
            ServDiscFilterGroupLine."Table Type"::"Trade Item":
              BEGIN
                TradeItem.RESET;
                TradeItem.SETRANGE(Vendor, IServiceOrderCostPlusEntry."Vendor (Trade Item)");
                TradeItem.SETRANGE("Item Code", IServiceOrderCostPlusEntry."Trade Item");
                TableRef.GETTABLE(TradeItem);
              END;
            ServDiscFilterGroupLine."Table Type"::"Basic Item":
              BEGIN
                BasicItem.RESET;
                BasicItem.SETRANGE(Manufacturer, IServiceOrderCostPlusEntry.Manufacturer);
                BasicItem.SETRANGE("Product Code", IServiceOrderCostPlusEntry."Basic Item");
                TableRef.GETTABLE(BasicItem);
              END;
            ServDiscFilterGroupLine."Table Type"::"Service Order":
              BEGIN
                ServiceOrder.RESET;
                ServiceOrder.SETRANGE("No.", IServiceOrderCostPlusEntry."Service Order No.");
                TableRef.GETTABLE(ServiceOrder);
              END;
          END;
          TableRef.FILTERGROUP(7);
          FieldRef := TableRef.FIELD(ServDiscFilterGroupLine."Field No.");
          FieldRef.SETFILTER(ServDiscFilterGroupLine."Value Filter");
          LinkedToServDiscFilterGroupLine.SETRANGE(Code, ServDiscFilterGroupLine.Code);
          LinkedToServDiscFilterGroupLine.SETRANGE("Linked To Line No.", ServDiscFilterGroupLine."Line No.");
          IF LinkedToServDiscFilterGroupLine.FINDSET THEN
            REPEAT
              FieldRef := TableRef.FIELD(LinkedToServDiscFilterGroupLine."Field No.");
              FieldRef.SETFILTER(LinkedToServDiscFilterGroupLine."Value Filter");
            UNTIL LinkedToServDiscFilterGroupLine.NEXT = 0;
          TableRef.FILTERGROUP(0);
          IF NOT TableRef.ISEMPTY THEN
            EXIT(TRUE);
        UNTIL ServDiscFilterGroupLine.NEXT = 0;
      END;
      EXIT(FALSE);
    END;

    PROCEDURE SetSkipDetermineChargeable@1100525009(SetSkipDetermChargeable@1100525000 : Boolean);
    BEGIN
      //T003311
      SkipDetermineChargeable := SetSkipDetermChargeable;
    END;

    PROCEDURE GetInvoicePriceInclVAT@1100528612() : Decimal;
    VAR
      VATPostingSetup@1100528600 : Record 325;
      ServiceOrder@1100528602 : Record 11012823;
      AmountInclVat@1100528601 : Decimal;
    BEGIN
      IF "Invoice Price (LCY)" = 0 THEN
        EXIT;

      AmountInclVat := "Invoice Price (LCY)";

      IF NOT ServiceOrder.GET("Service Order No.") THEN
        ServiceOrder.INIT;

      IF NOT VATPostingSetup.GET(ServiceOrder."VAT Bus. Posting Group", "VAT Prod. Posting Group") THEN
        VATPostingSetup.INIT;

      IF (VATPostingSetup."VAT %" = 0) OR VATPostingSetup.Manually THEN
        EXIT(AmountInclVat);

      CASE VATPostingSetup."VAT Calculation Type" OF
        VATPostingSetup."VAT Calculation Type"::"Normal VAT",
        VATPostingSetup."VAT Calculation Type"::"Reverse Charge VAT":
          AmountInclVat := "Invoice Price (LCY)" + "Invoice Price (LCY)" * VATPostingSetup."VAT %" / 100;
      END;

      EXIT(AmountInclVat);
    END;

    PROCEDURE CheckExtraCostLine@1100525010(lvAction@1100525000 : Integer);
    VAR
      ServiceExtraCost@1100525001 : Record 11020344;
    BEGIN
      IF NOT "Extra Cost" THEN
        EXIT;
      IF lvAction <> 2 THEN
        EXIT;
      ServiceExtraCost.SETRANGE("Entity Type", ServiceExtraCost."Entity Type"::"Service Order");
      ServiceExtraCost.SETRANGE("Entity Code", "Service Order No.");
      ServiceExtraCost.SETRANGE("Cost Plus Line No.", "Line No.");
      IF ServiceExtraCost.FINDFIRST THEN BEGIN
        ServiceExtraCost."Cost Plus Line No." := 0;
        ServiceExtraCost.MODIFY;
      END;
    END;

    PROCEDURE InitCreatedByFields@1100527000();
    VAR
      UserSetup@1100527000 : Record 91;
    BEGIN
      "Created by Employee No." := '';
      "Created by Employee Company" := '';
      "Created by Work Order No." := '';
      IF UserSetup.GET(USERID) THEN
        "Created by Employee No." := UserSetup."Employee No.";
    END;

    PROCEDURE AssistEditItemData@1100528300(VAR ZoomType@1210190000 : Integer);
    VAR
      "2baMgt"@1100528300 : Codeunit 11012306;
      RecRef@1100528301 : RecordRef;
    BEGIN
      IF ZoomType = 3 THEN BEGIN
        RecRef.GETTABLE(Rec);
        "2baMgt".RunModalDialogForMultipleItems("Vendor (Trade Item)", "Trade Item", RecRef);
        ZoomType := -1;
      END;
    END;

    LOCAL PROCEDURE "--- ITERO ---"@1();
    BEGIN
    END;

    PROCEDURE UseCostPrice@1100285000(_customer@1100285000 : Record 18) : Boolean;
    VAR
      lvServiceOrderExtension@1100525000 : Record 11071727;
    BEGIN
      //>> 160621 ITERO.AC RCF082 Rewrite of logic in order to make it similar to Project Cost Plus Entry
      IF NOT lvServiceOrderExtension.GET(ServOrderRec."No.") THEN BEGIN
        CLEAR(lvServiceOrderExtension);
        EXIT(FALSE);
      END;
      //IF (ServOrderRec."Price List Code" <> '' ) OR (UseManualPriceList <> '') THEN BEGIN
      //>> 161016 ITERO.AC RAD043-1 Adjustment, Do not read from Customer settings !!
      //EXIT((_customer."Item Price Cost Plus Project" = _customer."Item Price Cost Plus Project"::CostPrice)
      //  OR ((lvServiceOrderExtension."Item Price Cost Plus Entry" = lvServiceOrderExtension."Item Price Cost Plus Entry"::CostPrice) AND NOT "Price History Found"));
      EXIT(((lvServiceOrderExtension."Item Price Cost Plus Entry" = lvServiceOrderExtension."Item Price Cost Plus Entry"::CostPrice) AND NOT "Price History Found"));
      //<< 161016 ITERO.AC RAD043-1
      //END ELSE BEGIN
      //  EXIT(TRUE);
      //END;
      //<< 160621 ITERO.AC RCF082
    END;

    PROCEDURE SetManualPriceList@1100285001(_UseManualPl@1100285000 : Code[20]);
    BEGIN
      // ITERO.AC 150904 This flag is used to handle process flow in FindSalesPrice
      UseManualPriceList := _UseManualPl;
    END;

    PROCEDURE GetCustPriceListFromPriority@1100285005(lvTradeItem@1100285000 : Code[20];lvRefDate@1100285003 : Date;VAR lvDiscRef1@1100285004 : Code[20]) : Code[20];
    VAR
      lvCustPlPriority@1100285001 : Record 11128278;
      lvPriceHistRec@1100285002 : Record 11012315;
    BEGIN
      // 150905 ITERO.AC This function tries to find an alternative Trade Item Vendor by a loop through the table "Customer Price List priority"
      // and for each alternative price list: search if current article code exists in "Price History Trade Item"

      CLEAR(lvCustPlPriority);
      lvCustPlPriority.SETCURRENTKEY(Priority,"Price List Code");

      IF lvCustPlPriority.FINDSET THEN BEGIN
        REPEAT

          lvPriceHistRec.SETCURRENTKEY("Item Code", "Starting Date", "Price List Code");
          lvPriceHistRec.SETRANGE("Item Code", lvTradeItem);
          lvPriceHistRec.SETRANGE("Starting Date", 0D, lvRefDate);
          lvPriceHistRec.SETRANGE("Price List Code", lvCustPlPriority."Price List Code");

          IF lvPriceHistRec.FINDLAST THEN BEGIN
            IF lvCustPlPriority."Sales Discount Term Group 1" <> '' THEN
               lvDiscRef1 := lvCustPlPriority."Sales Discount Term Group 1";
            EXIT(lvPriceHistRec."Price List Code");
          END;

        UNTIL lvCustPlPriority.NEXT=0;
      END;

      EXIT('');
    END;

    PROCEDURE SetCurrFieldNoToZero@1100285300();
    BEGIN
      //>> 160609 ITERO.SB Set CurrFieldNo to zero when generate cost plus entries, to get correct value in GetDescription function.
      CurrFieldNo:=0;
      //<<
    END;

    PROCEDURE CheckCostPriceBehaviour@1100528011(pServiceOrderNo@1100525000 : Code[20];pCustomerNo@1100525001 : Code[20]) : Boolean;
    VAR
      lvCustomer@1100525002 : Record 18;
      lvServiceOrderExtension@1100525003 : Record 11071727;
    BEGIN
      // 160621 ITERO.AC RFC082 New function used to determine if Cost Price Behaviour should be used

      IF NOT lvCustomer.GET(pCustomerNo) THEN
        CLEAR(lvCustomer);
      IF NOT lvServiceOrderExtension.GET(pServiceOrderNo) THEN
        CLEAR(lvServiceOrderExtension);
      EXIT((lvCustomer."Item Price Cost Plus Service" = lvCustomer."Item Price Cost Plus Service"::CostPrice)
        OR (lvServiceOrderExtension."Item Price Cost Plus Entry" = lvServiceOrderExtension."Item Price Cost Plus Entry"::CostPrice));
    END;

    PROCEDURE CheckIfPriceHistoryExists@1100528013(pServiceOrderNo@1100525000 : Code[20];pReferenceDate@1100525001 : Date;pItemCode@1100525002 : Code[20];VAR pGrossPrice@1100525003 : Decimal) : Boolean;
    VAR
      lvPriceHistRec@1100525004 : Record 11012315;
      lvServiceOrderRec@1100525005 : Record 11012823;
      lvPriceListCode@1100525006 : Code[20];
      lvDiscRef@1100525007 : Code[20];
    BEGIN
      // 160621 ITERO.AC RFC082 New function used to Determine if "Price History Trade Item" exists for Current Customer PriceList And Current Trade Item Code
      IF NOT lvServiceOrderRec.GET(pServiceOrderNo) THEN CLEAR(lvServiceOrderRec);
      pGrossPrice := 0;

      IF lvServiceOrderRec."Price List Code" <> '' THEN BEGIN
        lvPriceHistRec.SETCURRENTKEY("Item Code", "Starting Date", "Price List Code");
        lvPriceHistRec.SETRANGE("Item Code", pItemCode);
        lvPriceHistRec.SETRANGE("Starting Date", 0D, pReferenceDate);
        lvPriceHistRec.SETRANGE("Price List Code", lvServiceOrderRec."Price List Code");

        IF lvPriceHistRec.FINDLAST THEN BEGIN
          pGrossPrice := lvPriceHistRec."Gross Price";
          EXIT(TRUE);
        END ELSE BEGIN
          // If Trade Item was not found, check for Customer Price List priority
          lvPriceListCode := GetCustPriceListFromPriority(pItemCode, pReferenceDate, lvDiscRef);
          IF lvPriceListCode <> '' THEN BEGIN
            lvPriceHistRec.SETRANGE("Price List Code", lvPriceListCode);
            IF lvPriceHistRec.FINDLAST THEN BEGIN
              pGrossPrice := lvPriceHistRec."Gross Price";
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      EXIT(FALSE);
    END;

    PROCEDURE GetSurchargeIfMissingArticles@1100525016(pServiceOrderNo@1100525000 : Code[20]) : Decimal;
    VAR
      lvCustPriceList@1100525001 : Record 11128273;
      lvServiceOrderRec@1100525002 : Record 11012823;
    BEGIN
      // 160621 ITERO.AC RFC082 Get new Surcharge value from current Customer Price List as a factor
      // Return 1 if there is no customer price list is selected or it doesnt exist

      IF NOT lvServiceOrderRec.GET(pServiceOrderNo) THEN CLEAR(lvServiceOrderRec);
      IF lvServiceOrderRec."Price List Code" <> '' THEN BEGIN
        IF lvCustPriceList.GET(lvServiceOrderRec."Price List Code") THEN
          EXIT(1 + (lvCustPriceList.SurchargeIfMissingArticles / 100))
        ELSE
          EXIT(1);
      END;

      EXIT(1);
    END;

    LOCAL PROCEDURE CalculatePriceWithoutVAT@1100528012(pItemCode@1100525002 : Code[10];pPriceIncludesVAT@1100525003 : Boolean;pUnitPrice@1100525001 : Integer) : Decimal;
    VAR
      lvItemRec@1100525004 : Record 27;
      lvInvetSetupRec@1100525005 : Record 313;
      lvVATPostingSetupRec@1100525007 : Record 325;
      lvVATProdPostingGroup@1100525006 : Code[10];
      lvVATBusPostingGroup@1100525008 : Code[10];
      lvRetVal@1100525009 : Decimal;
      lvVATPercent@1100525010 : Decimal;
    BEGIN
      // 161012 ITERO.AC RAD043 Calculate Item Sales Price excluding VAT amount

      lvRetVal := pUnitPrice;

      IF pPriceIncludesVAT THEN BEGIN
        IF NOT lvInvetSetupRec.GET() THEN lvInvetSetupRec.INIT;
        lvVATBusPostingGroup := lvInvetSetupRec."VAT Bus. Posting Group";

        IF NOT lvItemRec.GET(pItemCode) THEN lvItemRec.INIT;
        lvVATProdPostingGroup := lvItemRec."VAT Prod. Posting Group";

        // Key: VAT Bus. Posting Group,VAT Prod. Posting Group
        IF lvVATPostingSetupRec.GET(lvVATBusPostingGroup, lvVATProdPostingGroup) THEN BEGIN
          lvVATPercent := lvVATPostingSetupRec."VAT %";
          lvRetVal := pUnitPrice / (1 + lvVATPercent / 100);
        END;

      END;

      EXIT(lvRetVal);
    END;

    PROCEDURE DuplicateLine@1100528605();
    VAR
      ServiceOrderCostPlusEntry@1100528600 : Record 11012825;
    BEGIN
      ServiceOrderCostPlusEntry := Rec;
      ServiceOrderCostPlusEntry."Line No." := 0;
      ServiceOrderCostPlusEntry.INSERT(TRUE);
    END;

    PROCEDURE GetLastLino@1100525019(ServiceOrderNo@1100525001 : Code[20]) LastLino : Integer;
    VAR
      CostPlusRec@1100525000 : Record 11012825;
    BEGIN
      //DP01008
      CostPlusRec.SETRANGE("Service Order No.", ServiceOrderNo);
      IF CostPlusRec.FINDLAST THEN
        LastLino := CostPlusRec."Line No."
      ELSE
        LastLino := 0;
      EXIT(LastLino);
    END;

    PROCEDURE AssistEditSalesCondition@1100525027();
    VAR
      ServOrderRec@1100525000 : Record 11012823;
      lvRefDate@1100525005 : Date;
      lvDiscRef1@1100525004 : Code[20];
      lvDiscRef2@1100525003 : Code[20];
      lvRefPrio@1100525002 : Code[10];
      lvDiscType@1100525001 : 'Purchase,Sales';
      ValidateCu@1100525006 : Codeunit 11012033;
    BEGIN
      //db, 26-01-16: C015604
      ServOrderRec.GET("Service Order No.");
      lvRefDate := ValidateCu.GetRefDateServOrder(ServOrderRec);
      ValidateCu.GetRefDiscServOrder(ServOrderRec, lvDiscRef1, lvDiscRef2, lvDiscType::Sales);
      lvRefPrio := ValidateCu.GetRefPrioServContract(ServContractRec, lvDiscType::Sales);
      ValidateCu.ShowSalesCondition(
        "Bill-to Customer No.", "Item No.", "Basic Item", "Trade Item", Manufacturer, "Vendor (Trade Item)",
        "Basic Price", "Sales Discount % (Item)", "Gross Price", lvRefDate, '',
        lvDiscRef1, lvDiscRef2, lvRefPrio);
    END;

    PROCEDURE SetOverruleServiceContractNo@1100528617(IOverruleServiceContractNo@1100528600 : Code[20]);
    BEGIN
      OverruleServiceContractNo := IOverruleServiceContractNo;
    END;

    BEGIN
    {
      4PS, 15-11-13, DP00483, Performance tuning:
      - MaintainSIFTIndex disabled for all keys
      - MaintainSQLIndex disabled for keys:
          Service Order No.,Invoiced,Chargeable,Additional Cost
          Service Order No.,Cost Object,Posting Date
          Base Service Order No.,Service Order No.,Cost Component,Invoiced,Chargeable
          Base Service Order No.
          Service Order No.,Object No.,Line No.
          Collective List No.,Base Service Order No.,Service Order No.,Cost Object

      4PS, 11-12-13, C008689, In case of Credit Memo the Cost Price will not be set to negative
      130122 ITERO.SB Filter on indexdate added
      140204 4PSSE.DL take "Unit of Measure" from pricelist and "Unit Price Line Code"
      150807 ITERO.AC Added columns for PriceHistory and modified functions FindCostPrice And FindSalesPrice
      150904 ITERO.AC Added UseManualPriceList in order to flow control in FindSalesPrice
      150905 ITERO.AC Modified function FindSalesPrice and added a new function GetVendorFromCustPriceListPriority (Support for Customer Price List priority)
      151111 ITERO.PR New field: 11128273 Cost Price (LCY) Total sjlvkostnad
      160116 ITERO.AC Set variable DontUseSingleGTIN in CodeUnit ValidateItems to avoid mixup of GTIN Code in Item Relation (Same as IME420)
      160222 ITERO.SB Calculate sales price
      160609 ITERO.SB Set CurrFieldNo to zero when generate cost plus entries, to get correct value in GetDescription function.
      160620 ITERO.SB RAD-010 Mapping of description, wage component
      160621 ITERO.AC RFC082 Handle calculation for Cost Price Behaviour / Apply Material Surcharge / Bug Fixes
      160622 ITERO.AC RFC082 Bugfix
      160816 ITERO.AC RFC082 Handle price calculation for NAV Items in ValidateItem() and GenerateCostPlusFromServEntry()
      161010 ITERO.AC RAD043 New field "Sales Discount Percent" in Service Order (Use either Sales Discount Group or Sales Discount Percent or none)
      161012 ITERO.AC RAD043 Handle Sales Prices from Item Card for Items without Item Relation (No trade item)
      161016 ITERO.AC RAD043-1 Skip check in Customer table to decide CostPlusBehaviour
    }
    END.
  }
}

